<div id="Missing_Lemmas">
<div class="head">
<h1>Theory Missing_Lemmas</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Jose Divasón
                Sebastiaan Joosten
                René Thiemann
                Akihisa Yamada
    License:    BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Missing lemmas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory contains many results that are important but not specific for our development. 
      They could be moved to the stardard library and some other AFP entries.›</span></span> 

<span class="keyword1"><span class="command">theory</span></span> Missing_Lemmas
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../../berlekamp_zassenhaus/theories/#Sublist_Iteration">Berlekamp_Zassenhaus.Sublist_Iteration</a> <span class="comment1">(* for thm upt_append *)</span>
    <a href="../../berlekamp_zassenhaus/theories/#Square_Free_Int_To_Square_Free_GFp">Berlekamp_Zassenhaus.Square_Free_Int_To_Square_Free_GFp</a> <span class="comment1">(* for thm large_mod_0 *)</span>
    <a href="../../algebraic_numbers/theories/#Resultant">Algebraic_Numbers.Resultant</a>
    <a href="../../jordan_normal_form/theories/#Conjugate">Jordan_Normal_Form.Conjugate</a>
    <a href="../../jordan_normal_form/theories/#Missing_VectorSpace">Jordan_Normal_Form.Missing_VectorSpace</a>
    <a href="../../jordan_normal_form/theories/#VS_Connect">Jordan_Normal_Form.VS_Connect</a>
    <a href="../../berlekamp_zassenhaus/theories/#Finite_Field_Factorization_Record_Based">Berlekamp_Zassenhaus.Finite_Field_Factorization_Record_Based</a> <span class="comment1">(* for transfer rules for thm vec_of_list_Nil *)</span>
    <a href="../../berlekamp_zassenhaus/theories/#Berlekamp_Hensel">Berlekamp_Zassenhaus.Berlekamp_Hensel</a> <span class="comment1">(* for unique_factorization_m_factor *)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> test_bit <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">!!</span>"</span> 100<span class="main">)</span>

<span class="keyword1"><span class="command">hide_const</span></span><span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> module.smult up_ring.monom up_ring.coeff

<span class="comment1">(**** Could be merged to HOL/Rings.thy ****)</span>

<span class="keyword1"><span class="command">class</span></span> ordered_semiring_1 <span class="main">=</span> Rings.ordered_semiring_0 <span class="main">+</span> monoid_mult <span class="main">+</span> zero_less_one
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subclass</span></span> semiring_1<span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Missing_Lemmas-of_nat_ge_zero"><span class="command">lemma</span></span> of_nat_ge_zero<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_right_mono<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* Following lemmas are moved from @{class ordered_idom}. *)</span>
<span class="keyword1" id="Missing_Lemmas-zero_le_power"><span class="command">lemma</span></span> zero_le_power <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Missing_Lemmas-power_mono"><span class="command">lemma</span></span> power_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult_mono order_trans <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-one_le_power"><span class="command">lemma</span></span> one_le_power <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> power_mono <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Missing_Lemmas-power_le_one"><span class="command">lemma</span></span> power_le_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> power_mono <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Missing_Lemmas-power_gt1_lemma"><span class="command">lemma</span></span> power_gt1_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gt1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> gt1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> order_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> zero_le_one less_imp_le<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> gt1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">*</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> gt1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mult_mono <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span>›</span></span> one_le_power order_less_imp_le zero_le_one order_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-power_gt1"><span class="command">lemma</span></span> power_gt1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">^</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_gt1_lemma<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-one_less_power"><span class="command">lemma</span></span> one_less_power <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_gt1_lemma<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-power_decreasing"><span class="command">lemma</span></span> power_decreasing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">N</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">^</span> <span class="free">N</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">N</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="free">a</span><span class="main">^</span><span class="skolem">N</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> <span class="free">a</span><span class="main">^</span><span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="skolem">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_Suc_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-power_increasing"><span class="command">lemma</span></span> power_increasing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">N</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">^</span> <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">N</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="free">a</span><span class="main">^</span><span class="free">n</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">*</span> <span class="free">a</span><span class="main">^</span><span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="skolem">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> zero_le_one<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_Suc_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-power_Suc_le_self"><span class="command">lemma</span></span> power_Suc_le_self<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">^</span> Suc <span class="free">n</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> power_decreasing <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Missing_Lemmas-prod_list_nonneg"><span class="command">lemma</span></span> prod_list_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> ordered_semiring_1<span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> prod_list <span class="free">xs</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ordered_idom<span class="main">)</span> ordered_semiring_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="comment1">(**** End of lemmas that could be moved to HOL/Rings.thy ****)</span>

<span class="comment1">(* missing lemma on logarithms *)</span>
<span class="keyword1" id="Missing_Lemmas-log_prod"><span class="command">lemma</span></span> log_prod<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"log <span class="free">a</span> <span class="main">(</span>prod <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span>log <span class="free">a</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="free">X</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="free">a</span> <span class="main">(</span>prod <span class="free">f</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> log <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">*</span> prod <span class="free">f</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> log <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> log <span class="free">a</span> <span class="main">(</span>prod <span class="free">f</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> log_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> insert<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> prod_pos<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> insert<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="comment1">(* TODO: Jordan_Normal_Form/Missing_Ring.ordered_idom should be redefined *)</span>
<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ordered_idom<span class="main">)</span> zero_less_one <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">hide_fact</span></span> Missing_Ring.zero_less_one

<span class="comment1">(**** The following lemmas could be part of the standard library ****)</span>

<span class="keyword1"><span class="command">instance</span></span> real <span class="main">::</span> <span class="quoted">ordered_semiring_strict</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">instance</span></span> real <span class="main">::</span> <span class="quoted">linordered_idom</span><span class="keyword1"><span class="command">..</span></span>

<span class="comment1">(*This is a generalisation of thm less_1_mult*)</span> 
<span class="keyword1" id="Missing_Lemmas-less_1_mult'"><span class="command">lemma</span></span> less_1_mult'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linordered_semidom"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_less less_1_mult mult.right_neutral<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-upt_minus_eq_append"><span class="command">lemma</span></span> upt_minus_eq_append<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≤</span><span class="free">j</span> <span class="main">⟹</span> <span class="free">i</span><span class="main">≤</span><span class="free">j</span><span class="main">-</span><span class="free">k</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">-</span><span class="free">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">j</span><span class="main">-</span><span class="free">k</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">j</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.hyps Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> append.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> diff_Suc_less nat_less_le neq0_conv upt_append upt_rec zero_diff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Missing_Lemmas-list_trisect"><span class="command">lemma</span></span> list_trisect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> length <span class="free">lst</span> <span class="main">⟹</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">lst</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">x</span><span class="main">]</span><span class="main">@</span><span class="free">x</span><span class="main">#</span><span class="main">[</span>Suc <span class="free">x</span><span class="main">..&lt;</span>length <span class="free">lst</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">lst</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> a lst<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> length <span class="improper">lst</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-id_imp_bij_betw"><span class="command">lemma</span></span> id_imp_bij_betw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">:</span> <span class="free">A</span> <span class="main">→</span> <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">A</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bij_betwI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f f<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ff<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-range_subsetI"><span class="command">lemma</span></span> range_subsetI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"range <span class="free">f</span> <span class="main">⊆</span> range <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Missing_Lemmas-Gcd_uminus"><span class="command">lemma</span></span> Gcd_uminus<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"int set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Gcd <span class="free">A</span> <span class="main">=</span> Gcd <span class="main">(</span>uminus <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-aux_abs_int"><span class="command">lemma</span></span> aux_abs_int<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="free">x</span> <span class="main">*</span> <span class="free">c</span><span class="main">¦</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="free">x</span> <span class="main">=</span> abs <span class="free">x</span> <span class="main">*</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> abs <span class="free">x</span> <span class="main">*</span> abs <span class="free">c</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> abs_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-mod_0_abs_less_imp_0"><span class="command">lemma</span></span> mod_0_abs_less_imp_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span><span class="free">a</span><span class="main">)</span><span class="main">&lt;</span><span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">≥</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> cong_def
    <span class="keyword1"><span class="command">using</span></span> int_mod_pos_eq large_mod_0 zless_imp_add1_zle 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abs_of_nonneg le_less not_less zabs_less_one_iff zmod_trivial_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* an intro version of sum_list_0 *)</span>
<span class="keyword1" id="Missing_Lemmas-sum_list_zero"><span class="command">lemma</span></span> sum_list_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">xs</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* About @{const max} *)</span>
<span class="keyword1" id="Missing_Lemmas-max_idem"><span class="command">lemma</span></span> max_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"max <span class="free">a</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-hom_max"><span class="command">lemma</span></span> hom_max<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">f</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>max <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-le_max_self"><span class="command">lemma</span></span> le_max_self<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> preorder"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">∨</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> max <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> max <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-le_max"><span class="command">lemma</span></span> le_max<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> preorder"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">∨</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> max <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> le_max_self<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">max_list</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_list</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> False<span class="main">)</span>"</span></span> <span class="comment1">(* more convenient than "undefined" *)</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">max_list</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">max_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">max_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> max_list.simps<span class="main">(</span>1<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> max_list.simps<span class="main">(</span>2-3<span class="main">)</span><span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1" id="Missing_Lemmas-max_list_Cons"><span class="command">lemma</span></span> max_list_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"max_list <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> max <span class="free">x</span> <span class="main">(</span>max_list <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-max_list_mem"><span class="command">lemma</span></span> max_list_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> max_list <span class="free">xs</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_list_Cons max_def<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-mem_set_imp_le_max_list"><span class="command">lemma</span></span> mem_set_imp_le_max_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> preorder list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">≤</span> <span class="bound">b</span> <span class="main">∨</span> <span class="bound">b</span> <span class="main">≤</span> <span class="bound">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> max_list <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> max_list <span class="skolem">xs</span> <span class="main">∨</span> max_list <span class="skolem">xs</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> max_list_mem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> le_max_self<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="skolem">a</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> a max_list_Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> False <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> 1<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> max_list <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> max <span class="skolem">x</span> <span class="main">(</span>max_list <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> max_list_Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> False<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-le_max_list"><span class="command">lemma</span></span> le_max_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> preorder list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ord<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">≤</span> <span class="bound">b</span> <span class="main">∨</span> <span class="bound">b</span> <span class="main">≤</span> <span class="bound">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> max_list <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> ab
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> max_list <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mem_set_imp_le_max_list<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> ord<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> b<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-max_list_le"><span class="command">lemma</span></span> max_list_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> preorder list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"max_list <span class="free">xs</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> max_list_mem<span class="main">[</span><span class="operator">OF</span> xs<span class="main">]</span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Missing_Lemmas-max_list_as_Greatest"><span class="command">lemma</span></span> max_list_as_Greatest<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"max_list <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> Greatest_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_list.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> max_list <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_max_list<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"max_list <span class="free">xs</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> max_list_mem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> False<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">≤</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">x</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ex1I<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 1 2
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>max_list <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> max_list <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max_list <span class="free">xs</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> max_list <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">note</span></span> 3 <span class="main">=</span> theI_unique<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> Greatest_def Cons 3<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-hom_max_list_commute"><span class="command">lemma</span></span> hom_max_list_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">(</span>max <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">(</span>max_list <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> max_list <span class="main">(</span>map <span class="free">h</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_list_Cons max_list_mem<span class="main">)</span>


<span class="comment1">(*Efficient rev [i..&lt;j]*)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rev_upt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">[</span>_<span class="keyword1">&gt;..</span>_<span class="keyword1">]</span><span class="keyword3">)</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
rev_upt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="main">0</span><span class="main"><span class="free">&gt;..</span></span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
rev_upt_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main"><span class="free">&gt;..</span></span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main"><span class="free">&gt;..</span></span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main"><span class="free">]</span></span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Missing_Lemmas-rev_upt_rec"><span class="command">lemma</span></span> rev_upt_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">&gt;..</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span><span class="main">&gt;</span><span class="free">j</span> <span class="keyword1">then</span> <span class="main">[</span><span class="free">i</span><span class="main">&gt;..</span>Suc <span class="free">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>    

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rev_upt_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rev_upt_aux</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">js</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&gt;..</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">js</span></span></span>"</span></span>

<span class="keyword1" id="Missing_Lemmas-upt_aux_rec"><span class="command">lemma</span></span> upt_aux_rec <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rev_upt_aux <span class="free">i</span> <span class="free">j</span> <span class="free">js</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">j</span><span class="main">≥</span><span class="free">i</span> <span class="keyword1">then</span> <span class="free">js</span> <span class="keyword1">else</span> rev_upt_aux <span class="free">i</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">#</span><span class="free">js</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_upt_aux_def rev_upt_rec<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-rev_upt_code"><span class="command">lemma</span></span> rev_upt_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">&gt;..</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> rev_upt_aux <span class="free">i</span> <span class="free">j</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_upt_aux_def<span class="main">)</span>    
  
<span class="keyword1" id="Missing_Lemmas-upt_rev_upt"><span class="command">lemma</span></span> upt_rev_upt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rev <span class="main">[</span><span class="free">j</span><span class="main">&gt;..</span><span class="free">i</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    
<span class="keyword1" id="Missing_Lemmas-rev_upt_upt"><span class="command">lemma</span></span> rev_upt_upt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rev <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">j</span><span class="main">&gt;..</span><span class="free">i</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1" id="Missing_Lemmas-length_rev_upt"><span class="command">lemma</span></span> length_rev_upt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">[</span><span class="free">i</span><span class="main">&gt;..</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_diff_le<span class="main">)</span>
    
<span class="keyword1" id="Missing_Lemmas-nth_rev_upt"><span class="command">lemma</span></span> nth_rev_upt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">i</span><span class="main">&gt;..</span><span class="free">j</span><span class="main">]</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> jk_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">&gt;..</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> rev <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rev_upt_upt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> jk_i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">j</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_upt<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> jk_i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> jk_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>    
  
<span class="keyword1" id="Missing_Lemmas-nth_map_rev_upt"><span class="command">lemma</span></span> nth_map_rev_upt<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">-</span><span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="free">m</span><span class="main">&gt;..</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="free">m</span><span class="main">&gt;..</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="main">[</span><span class="free">m</span><span class="main">&gt;..</span><span class="free">n</span><span class="main">]</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_map<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> nth_rev_upt<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-coeff_mult_monom"><span class="command">lemma</span></span> coeff_mult_monom<span class="main">:</span>
 <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="free">p</span> <span class="main">*</span> monom <span class="free">a</span> <span class="free">d</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">d</span> <span class="main">≤</span> <span class="free">i</span> <span class="keyword1">then</span> <span class="free">a</span> <span class="main">*</span> coeff <span class="free">p</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">d</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> coeff_monom_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="comment1">(**** End of the lemmas which may be part of the standard library ****)</span>

<span class="comment1">(**** The following lemmas could be moved to Algebraic_Numbers/Resultant.thy ****)</span>
<span class="keyword1" id="Missing_Lemmas-vec_of_poly_0"><span class="command">lemma</span></span> vec_of_poly_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vec_of_poly <span class="main">0</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_of_poly_def<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-vec_index_vec_of_poly"><span class="command">lemma</span></span> vec_index_vec_of_poly <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> degree <span class="free">p</span> <span class="main">⟹</span> vec_of_poly <span class="free">p</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> coeff <span class="free">p</span> <span class="main">(</span>degree <span class="free">p</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_of_poly_def Let_def<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-poly_of_vec_vec"><span class="command">lemma</span></span> poly_of_vec_vec<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_of_vec <span class="main">(</span>vec <span class="free">n</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> Poly <span class="main">(</span>rev <span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="skolem">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">n</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">0</span> <span class="main">#</span> map <span class="main">(</span><span class="skolem">f</span> <span class="main">∘</span> Suc<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_upt_Suc <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Poly <span class="main">(</span>rev <span class="main">…</span><span class="main">)</span> <span class="main">=</span> Poly <span class="main">(</span>rev <span class="main">(</span>map <span class="main">(</span><span class="skolem">f</span> <span class="main">∘</span> Suc<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> monom <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Poly_snoc smult_monom<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> poly_of_vec <span class="main">(</span>vec <span class="skolem">n</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">∘</span> Suc<span class="main">)</span><span class="main">)</span> <span class="main">+</span> monom <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> Suc<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> poly_of_vec <span class="main">(</span>vec <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> poly_of_vec_def Let_def dim_vec sum.lessThan_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_diff_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-sum_list_map_dropWhile0"><span class="command">lemma</span></span> sum_list_map_dropWhile0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>dropWhile <span class="main">(</span><span class="main">(=)</span> <span class="main">0</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f0<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-coeffs_poly_of_vec"><span class="command">lemma</span></span> coeffs_poly_of_vec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"coeffs <span class="main">(</span>poly_of_vec <span class="free">v</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">(</span>dropWhile <span class="main">(</span><span class="main">(=)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>list_of_vec <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> vec <span class="skolem">n</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v poly_of_vec_vec<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-poly_of_vec_vCons"><span class="command">lemma</span></span> poly_of_vec_vCons<span class="main">:</span>
 <span class="quoted"><span class="quoted">"poly_of_vec <span class="main">(</span>vCons <span class="free">a</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> monom <span class="free">a</span> <span class="main">(</span>dim_vec <span class="free">v</span><span class="main">)</span> <span class="main">+</span> poly_of_vec <span class="free">v</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> poly_eqI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_poly_of_vec vec_index_vCons<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-poly_of_vec_as_Poly"><span class="command">lemma</span></span> poly_of_vec_as_Poly<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_of_vec <span class="free">v</span> <span class="main">=</span> Poly <span class="main">(</span>rev <span class="main">(</span>list_of_vec <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>poly_of_vec_vCons Poly_snoc <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-poly_of_vec_add"><span class="command">lemma</span></span> poly_of_vec_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">a</span> <span class="main">=</span> dim_vec <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly_of_vec <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> poly_of_vec <span class="free">a</span> <span class="main">+</span> poly_of_vec <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_eq_iff coeff_poly_of_vec<span class="main">)</span>

<span class="comment1">(*TODO: replace the one in Resultant.thy*)</span>
<span class="keyword1" id="Missing_Lemmas-degree_poly_of_vec_less"><span class="command">lemma</span></span> degree_poly_of_vec_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> dim_vec <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">v</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>poly_of_vec <span class="free">v</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> degree_poly_of_vec_less assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_le_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> vec_module<span class="main">)</span> poly_of_vec_finsum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">→</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly_of_vec <span class="main">(</span>finsum V <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> poly_of_vec <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> True assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> IH<span class="main">:</span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">X</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> 
      <span class="keyword1"><span class="command">using</span></span> x IH.prems <span class="keyword1"><span class="command">unfolding</span></span> Pi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH.prems <span class="keyword1"><span class="command">unfolding</span></span> Pi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>finsum V <span class="free">f</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_absorb IH<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>finsum V <span class="free">f</span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">X</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span>finsum V <span class="free">f</span> <span class="skolem">X</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finsum_insert IH<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly_of_vec <span class="main">...</span> <span class="main">=</span> poly_of_vec <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">+</span> poly_of_vec <span class="main">(</span>finsum V <span class="free">f</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> poly_of_vec_add<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>insert <span class="skolem">a</span> <span class="skolem">X</span><span class="main">.</span> poly_of_vec <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*This function transforms a polynomial to a vector of dimension n*)</span>  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">vec_of_poly_n</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
  vec <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* TODO: make it abbreviation? *)</span>
<span class="keyword1" id="Missing_Lemmas-vec_of_poly_as"><span class="command">lemma</span></span> vec_of_poly_as<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_of_poly_n <span class="free">p</span> <span class="main">(</span>Suc <span class="main">(</span>degree <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> vec_of_poly <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_of_poly_def vec_of_poly_n_def<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-vec_of_poly_n_0"><span class="command">lemma</span></span> vec_of_poly_n_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vec_of_poly_n <span class="free">p</span> <span class="main">0</span> <span class="main">=</span> vNil"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_of_poly_n_def<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-vec_dim_vec_of_poly_n"><span class="command">lemma</span></span> vec_dim_vec_of_poly_n <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>vec_of_poly_n <span class="free">p</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"vec_of_poly_n <span class="free">p</span> <span class="free">n</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_of_poly_n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Missing_Lemmas-dim_vec_of_poly"><span class="command">lemma</span></span> dim_vec_of_poly <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>vec_of_poly <span class="free">f</span><span class="main">)</span> <span class="main">=</span> degree <span class="free">f</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_of_poly_as<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-vec_index_of_poly_n"><span class="command">lemma</span></span> vec_index_of_poly_n<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_of_poly_n <span class="free">p</span> <span class="free">n</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span>degree <span class="free">p</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> coeff <span class="free">p</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_of_poly_n_def Let_def<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-vec_of_poly_n_pCons"><span class="command">lemma</span></span> vec_of_poly_n_pCons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_of_poly_n <span class="main">(</span>pCons <span class="free">a</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> vec_of_poly_n <span class="free">p</span> <span class="free">n</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> vec_of_list <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="var">?l</span> <span class="main">=</span> dim_vec <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_vec <span class="var">?r</span> <span class="main">⟹</span> <span class="var">?l</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_pCons less_Suc_eq_le vec_index_of_poly_n<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-vec_of_poly_pCons"><span class="command">lemma</span></span> vec_of_poly_pCons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_of_poly <span class="main">(</span>pCons <span class="free">a</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> vec_of_list <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">else</span> vec_of_poly <span class="free">p</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> vec_of_list <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_of_poly_as<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-list_of_vec_of_poly"><span class="command">lemma</span></span> list_of_vec_of_poly <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_of_vec <span class="main">(</span>vec_of_poly <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span> <span class="keyword1">else</span> rev <span class="main">(</span>coeffs <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_of_poly_pCons<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-poly_of_vec_of_poly_n"><span class="command">lemma</span></span> poly_of_vec_of_poly_n<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span><span class="main">&lt;</span><span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly_of_vec <span class="main">(</span>vec_of_poly_n <span class="free">p</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec_of_poly_n <span class="free">p</span> <span class="free">n</span> <span class="main">$</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> coeff <span class="free">p</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>    
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec_of_poly_n <span class="free">p</span> <span class="free">n</span> <span class="main">$</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span>degree <span class="free">p</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> coeff <span class="free">p</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> vec_index_of_poly_n<span class="main">[</span><span class="operator">OF</span> n<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> coeff <span class="free">p</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i n le_degree <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> coeff_eq_0<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i2 p<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> poly_eq_iff
  <span class="keyword1"><span class="command">unfolding</span></span> coeff_poly_of_vec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-vec_of_poly_n0"><span class="command">lemma</span></span> vec_of_poly_n0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vec_of_poly_n <span class="main">0</span> <span class="free">n</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> vec_of_poly_n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Missing_Lemmas-vec_of_poly_n_add"><span class="command">lemma</span></span> vec_of_poly_n_add<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_of_poly_n <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> vec_of_poly_n <span class="free">a</span> <span class="free">n</span> <span class="main">+</span> vec_of_poly_n <span class="free">b</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-vec_of_poly_n_poly_of_vec"><span class="command">lemma</span></span> vec_of_poly_n_poly_of_vec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">g</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_of_poly_n <span class="main">(</span>poly_of_vec <span class="free">g</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_of_vec_def vec_of_poly_n_def assms vec_eq_iff Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> monom <span class="main">(</span><span class="free">g</span> <span class="main">$</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> degree <span class="main">(</span>poly_of_vec <span class="free">g</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> poly_of_vec_def Let_def n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span>degree <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> monom <span class="main">(</span><span class="free">g</span> <span class="main">$</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> i3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span>degree <span class="main">(</span>poly_of_vec <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> i1 <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">g</span> <span class="main">-</span> Suc <span class="skolem">i</span> <span class="main">&gt;</span> degree <span class="main">(</span>poly_of_vec <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i1 i2 i3    
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_diff_Suc coeff_poly_of_vec diff_Suc_less 
        diff_diff_cancel leD le_degree less_imp_le_nat n neq0_conv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> monom <span class="main">(</span><span class="free">g</span> <span class="main">$</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span>    
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_diff_Suc coeff_poly_of_vec diff_diff_cancel 
        diff_less_Suc less_imp_le_nat n not_less_eq poly_of_vec_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-poly_of_vec_scalar_mult"><span class="command">lemma</span></span> poly_of_vec_scalar_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">b</span><span class="main">&lt;</span><span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly_of_vec <span class="main">(</span><span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>vec_of_poly_n <span class="free">b</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> smult <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_eq_iff coeff_poly_of_vec vec_of_poly_n_def coeff_eq_0<span class="main">)</span>

<span class="comment1">(*TODO: replace the one in Resultant.thy*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vec_of_poly_rev_shifted</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vec_of_poly_rev_shifted</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span>
   vec <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">+</span> <span class="bound">i</span> <span class="keyword1">then</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">+</span> <span class="bound">i</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Missing_Lemmas-vec_of_poly_rev_shifted_dim"><span class="command">lemma</span></span> vec_of_poly_rev_shifted_dim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>vec_of_poly_rev_shifted <span class="free">p</span> <span class="free">n</span> <span class="free">s</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_of_poly_rev_shifted_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Missing_Lemmas-col_sylvester_sub"><span class="command">lemma</span></span> col_sylvester_sub<span class="main">:</span> <span class="comment1">(* TODO: from this directly derive col_sylvester *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">+</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"col <span class="main">(</span>sylvester_mat_sub <span class="free">m</span> <span class="free">n</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span>
    vec_of_poly_rev_shifted <span class="free">p</span> <span class="free">n</span> <span class="free">m</span> <span class="free">j</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> vec_of_poly_rev_shifted <span class="free">q</span> <span class="free">m</span> <span class="free">n</span> <span class="free">j</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="var">?l</span> <span class="main">=</span> dim_vec <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_vec <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">+</span><span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vec_of_poly_rev_shifted_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> index_col<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sylvester_mat_sub_index<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command">using</span></span> i
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less not_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> coeff_eq_0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-vec_of_poly_rev_shifted_scalar_prod"><span class="command">lemma</span></span> vec_of_poly_rev_shifted_scalar_prod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">v</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≡</span> poly_of_vec <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">v</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">+</span><span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_of_poly_rev_shifted <span class="free">p</span> <span class="free">n</span> <span class="free">m</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="free">m</span><span class="main">-</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">∙</span> <span class="free">v</span> <span class="main">=</span> coeff <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="free">j</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> id1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">m</span> <span class="main">+</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span> <span class="main">-</span> Suc <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">+</span> Suc <span class="free">j</span> <span class="main">-</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">+</span> <span class="free">m</span> <span class="main">-</span> Suc <span class="free">j</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="free">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="keyword1">then</span> coeff <span class="free">p</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> Suc <span class="free">j</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span>  <span class="free">v</span> <span class="main">$</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="var">?g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span>          
        <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">j</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">j</span> <span class="main">-</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="keyword1">then</span> <span class="free">v</span> <span class="main">$</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> vec_of_poly_rev_shifted_def coeff_mult m scalar_prod_def n q_def
      coeff_poly_of_vec 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> id1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">j</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">j</span> <span class="main">-</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="keyword1">then</span> coeff <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">v</span> <span class="main">$</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{..</span><span class="free">j</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">-</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">j</span> <span class="main">-</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span> 
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> sum <span class="main">_</span> <span class="main">(</span><span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="var">?R1</span> <span class="main">+</span> sum <span class="var">?f</span> <span class="var">?R2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="var">?R2</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="var">?R1</span> <span class="main">+</span> <span class="main">0</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">v</span> <span class="main">$</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="var">?R1</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> sum <span class="var">?F</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="var">?F</span> <span class="main">(</span><span class="main">(</span><span class="var">?R1</span> <span class="main">∩</span> <span class="main">{..</span><span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?R1</span> <span class="main">-</span> <span class="main">{..</span><span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> sum <span class="main">_</span> <span class="main">(</span><span class="var">?R</span> <span class="main">∪</span> <span class="var">?R'</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="var">?F</span> <span class="var">?R</span> <span class="main">+</span> sum <span class="var">?F</span> <span class="var">?R'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?F</span> <span class="var">?R'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span> 
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="free">m</span>"</span></span> 
        <span class="keyword1"><span class="command">with</span></span> m
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> coeff_eq_0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">=</span> sum <span class="var">?F</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> sum <span class="var">?g</span> <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">+</span> <span class="free">m</span> <span class="main">-</span> Suc <span class="free">j</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="free">j</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">}</span> 
      <span class="main">∪</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">+</span> <span class="free">m</span> <span class="main">-</span> Suc <span class="free">j</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="free">j</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> 
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> sum <span class="main">_</span> <span class="main">(</span><span class="var">?L1</span> <span class="main">∪</span> <span class="var">?L2</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="var">?g</span> <span class="var">?L1</span> <span class="main">+</span> sum <span class="var">?g</span> <span class="var">?L2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?g</span> <span class="var">?L2</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?g</span> <span class="var">?L1</span> <span class="main">+</span> <span class="main">0</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> coeff <span class="free">p</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> Suc <span class="free">j</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="free">v</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="var">?L1</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> sum <span class="var">?G</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="var">?G</span> <span class="main">(</span><span class="var">?L1</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> Suc <span class="free">j</span> <span class="main">-</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">m</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?L1</span> <span class="main">-</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> Suc <span class="free">j</span> <span class="main">-</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> sum <span class="main">_</span> <span class="main">(</span><span class="var">?L</span> <span class="main">∪</span> <span class="var">?L'</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="var">?G</span> <span class="var">?L</span> <span class="main">+</span> sum <span class="var">?G</span> <span class="var">?L'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?G</span> <span class="var">?L'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> Suc <span class="free">j</span> <span class="main">-</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="free">m</span>"</span></span> 
        <span class="keyword1"><span class="command">with</span></span> m
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> coeff_eq_0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> sum <span class="var">?G</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bij</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">+</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> Suc <span class="free">j</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> 
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> Suc <span class="free">j</span> <span class="main">-</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> Suc <span class="free">j</span> <span class="main">≥</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="var">?bij</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> y_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> y_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?bij</span> <span class="main">`</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> xy <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> tedious <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> l r
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?bij</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def tedious<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-sylvester_sub_poly"><span class="command">lemma</span></span> sylvester_sub_poly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> comm_semiring_0 poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly_of_vec <span class="main">(</span><span class="main">(</span>sylvester_mat_sub <span class="free">m</span> <span class="free">n</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span>
    poly_of_vec <span class="main">(</span>vec_first <span class="free">v</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="free">p</span> <span class="main">+</span> poly_of_vec <span class="main">(</span>vec_last <span class="free">v</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="free">q</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> poly_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Tv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sylvester_mat_sub <span class="free">m</span> <span class="free">n</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> dim<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>vec_first <span class="free">v</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>vec_last <span class="free">v</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="var">?Tv</span> <span class="main">=</span> <span class="free">n</span> <span class="main">+</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> if_distrib<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="bound">y</span> <span class="main">*</span> <span class="bound">z</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coeff <span class="var">?l</span> <span class="skolem">i</span> <span class="main">=</span> coeff <span class="var">?r</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">+</span><span class="free">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> i_mn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="free">m</span><span class="main">+</span><span class="free">n</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> i_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> i_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="var">?r</span> <span class="skolem">i</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">∑</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> vec_first <span class="free">v</span> <span class="free">n</span> <span class="main">$</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> coeff <span class="free">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
            <span class="main">(</span><span class="main">∑</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">.</span> vec_last <span class="free">v</span> <span class="free">m</span> <span class="main">$</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> Suc <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> coeff <span class="free">q</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="main">_</span> <span class="main">+</span> sum <span class="var">?g</span> <span class="main">_</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> coeff_add coeff_mult Let_def 
        <span class="keyword1"><span class="command">unfolding</span></span> coeff_poly_of_vec dim if_distrib
        <span class="keyword1"><span class="command">unfolding</span></span> atMost_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> sum.inter_filter<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> sum.inter_filter<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> mem_Collect_eq
        <span class="keyword1"><span class="command">unfolding</span></span> i_n i_m
        <span class="keyword1"><span class="command">unfolding</span></span> lessThan_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">(</span><span class="skolem">i</span><span class="main">-</span><span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> coeff_eq_0<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> i_mn x m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">q</span> <span class="main">(</span><span class="skolem">i</span><span class="main">-</span><span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> coeff_eq_0<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> i_mn x n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?g</span> <span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="var">?r</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> coeff <span class="var">?l</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> coeff_poly_of_vec dim sum.distrib<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coeff <span class="var">?l</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>sylvester_mat_sub <span class="free">m</span> <span class="free">n</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> coeff_poly_of_vec dim sum.distrib<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> coeff <span class="main">(</span><span class="free">p</span> <span class="main">*</span> poly_of_vec <span class="main">(</span>vec_first <span class="free">v</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">*</span> poly_of_vec <span class="main">(</span>vec_last <span class="free">v</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> index_mult_mat_vec<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> row_transpose<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> col_sylvester_sub<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> vec_first_last_append<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">v</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span><span class="main"><span class="main">,</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> scalar_prod_append<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> carrier_vecI<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> vec_of_poly_rev_shifted_scalar_prod<span class="main"><span class="main">[</span></span><span class="operator">OF</span> m<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> vec_of_poly_rev_shifted_scalar_prod<span class="main"><span class="main">[</span></span><span class="operator">OF</span> n<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">≤</span><span class="skolem">i</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="keyword1">then</span> vec_first <span class="free">v</span> <span class="free">n</span> <span class="main">$</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> coeff <span class="free">p</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">≤</span><span class="skolem">i</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="keyword1">then</span> vec_last <span class="free">v</span> <span class="free">m</span> <span class="main">$</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> Suc <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> coeff <span class="free">q</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> coeff_poly_of_vec<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"vec_first <span class="free">v</span> <span class="free">n</span>"</span></span><span class="main">,</span><span class="operator">unfolded</span> dim_vec_first<span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> coeff_poly_of_vec<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"vec_last <span class="free">v</span> <span class="free">m</span>"</span></span><span class="main">,</span><span class="operator">unfolded</span> dim_vec_last<span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> coeff_mult<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> coeff <span class="var">?r</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> coeff_add coeff_mult Let_def
        <span class="keyword1"><span class="command">unfolding</span></span> coeff_poly_of_vec dim<span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(**** End of the lemmas which could be moved to Algebraic_Numbers/Resultant.thy ****)</span>

<span class="comment1">(**** The following lemmas could be moved to Computational_Algebra/Polynomial.thy ****)</span>

<span class="keyword1" id="Missing_Lemmas-normalize_field"><span class="command">lemma</span></span> normalize_field <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"normalize <span class="main">(</span><span class="free">a</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field<span class="main">,</span> semiring_gcd<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> unit_factor_normalize <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Missing_Lemmas-content_field"><span class="command">lemma</span></span> content_field <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"content <span class="main">(</span><span class="free">p</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field<span class="main">,</span>semiring_gcd<span class="main">}</span> poly<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> content_def<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-primitive_part_field"><span class="command">lemma</span></span> primitive_part_field <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"primitive_part <span class="main">(</span><span class="free">p</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field<span class="main">,</span>semiring_gcd<span class="main">}</span> poly<span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> primitive_part_prim<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-primitive_part_dvd"><span class="command">lemma</span></span> primitive_part_dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive_part <span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> content_times_primitive_part dvd_def dvd_refl mult_smult_right<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-degree_abs"><span class="command">lemma</span></span> degree_abs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"degree <span class="main">¦</span><span class="free">p</span><span class="main">¦</span> <span class="main">=</span> degree <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_poly_def<span class="main">)</span>

<span class="keyword1" id="Missing_Lemmas-degree_gcd1"><span class="command">lemma</span></span> degree_gcd1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a_not0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>gcd <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">≤</span> degree <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gcd <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> gcd_dvd_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_gc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="var">?g</span> <span class="main">*</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> g_not0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">≠</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a_not0 a_gc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> c0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a_not0 a_gc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="var">?g</span> <span class="main">≤</span> degree <span class="main">(</span><span class="var">?g</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_mult_right_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c0<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> degree <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a_gc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-primitive_part_neg"><span class="command">lemma</span></span> primitive_part_neg <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>factorial_ring_gcd<span class="main">,</span>factorial_semiring_multiplicative<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"primitive_part <span class="main">(</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> primitive_part <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"primitive_part <span class="main">(</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> primitive_part <span class="main">(</span>smult <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> primitive_part_smult
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_unit_unit_factor<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-content_uminus"><span class="command">lemma</span></span> content_uminus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"int poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"content <span class="main">(</span><span class="main">-</span><span class="free">f</span><span class="main">)</span> <span class="main">=</span> content <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">f</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span>smult <span class="main">1</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> smult <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> smult_minus_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"content <span class="main">(</span><span class="main">-</span><span class="free">f</span><span class="main">)</span> <span class="main">=</span> content <span class="main">(</span>smult <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> normalize <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> content <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> content_smult <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-pseudo_mod_monic"><span class="command">lemma</span></span> pseudo_mod_monic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>comm_ring_1<span class="main">,</span>semiring_1_no_zero_divisors<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≡</span> pseudo_mod <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> monic_g<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span>  <span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">q</span> <span class="main">+</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="free">r</span> <span class="main">&lt;</span> degree <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"coeff <span class="free">g</span> <span class="main">(</span>degree <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cge</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?cg</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="main">(</span>degree <span class="free">f</span><span class="main">)</span> <span class="main">-</span> degree <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="var">?cge</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> r_def<span class="main">[</span><span class="operator">unfolded</span> pseudo_mod_def<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> pdm<span class="main">:</span> <span class="quoted"><span class="quoted">"pseudo_divmod <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pseudo_divmod <span class="free">f</span> <span class="free">g</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> monic_g <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> pseudo_divmod<span class="main">[</span><span class="operator">OF</span> g pdm<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"smult <span class="skolem">a</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">+</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="free">r</span> <span class="main">&lt;</span> degree <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a_def <span class="keyword1"><span class="command">using</span></span> monic_g <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> id2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">+</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="free">r</span> <span class="main">&lt;</span> degree <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>  
  <span class="keyword1"><span class="command">from</span></span> g <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a_def<span class="main">)</span>  
  <span class="keyword1"><span class="command">with</span></span> id2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="bound">q</span> <span class="main">+</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Lemmas-monic_imp_div_mod_int_poly_degree"><span class="command">lemma</span></span> monic_imp_div_mod_int_poly_degree<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>comm_ring_1<span class="main">,</span>semiring_1_no_zero_divisors<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="bound">r</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> <span class="bound">q</span><span class="main">*</span><span class="free">u</span> <span class="main">+</span> <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="bound">r</span> <span class="main">&lt;</span> degree <span class="free">u</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> pseudo_mod_monic<span class="main">[</span><span class="operator">OF</span> m<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> mult.commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">corollary</span></span> monic_imp_div_mod_int_poly_degree2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>comm_ring_1<span class="main">,</span>semiring_1_no_zero_divisors<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> deg_u<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="bound">r</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> <span class="bound">q</span><span class="main">*</span><span class="free">u</span> <span class="main">+</span> <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span>degree <span class="bound">r</span> <span class="main">&lt;</span> degree <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="free">u</span> <span class="main">+</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="skolem">r</span> <span class="main">&lt;</span> degree <span class="free">u</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> monic_imp_div_mod_int_poly_degree<span class="main">[</span><span class="operator">OF</span> m<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">r</span> <span class="main">&lt;</span> degree <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> deg_u r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(**** End of the lemmas that could be moved to Computational_Algebra/Polynomial.thy ****)</span>


<span class="comment1">(* To be categorized *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> zero_hom<span class="main">)</span> hom_upper_triangular<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span> <span class="main">⟹</span> upper_triangular <span class="free">A</span> <span class="main">⟹</span> upper_triangular <span class="main">(</span>map_mat <span class="free">hom</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upper_triangular_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="More_IArray">
<div class="head">
<h1>Theory More_IArray</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Ralph Bottesch
                Maximilian Haslbeck
                René Thiemann
    License:    BSD
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Lemmas and Definitions for Immutable Arrays›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define some definitions on immutable arrays, and modify the simplication
  rules so that IArrays will mainly operate pointwise, and not as lists.
  To be more precise, IArray.of-fun will become the main constructor.›</span></span>
<span class="keyword1"><span class="command">theory</span></span> More_IArray
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/IArray.html">HOL-Library.IArray</a>"</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iarray_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> iarray <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> iarray"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">iarray_update</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>IArray.length <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="More_IArray-iarray_cong"><span class="command">lemma</span></span> iarray_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">m</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> IArray.of_fun <span class="free">f</span> <span class="free">n</span> <span class="main">=</span> IArray.of_fun <span class="free">g</span> <span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_IArray-iarray_cong'"><span class="command">lemma</span></span> iarray_cong'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> IArray.of_fun <span class="free">f</span> <span class="free">n</span> <span class="main">=</span> IArray.of_fun <span class="free">g</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iarray_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="More_IArray-iarray_update_length"><span class="command">lemma</span></span> iarray_update_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>iarray_update <span class="free">a</span> <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> IArray.length <span class="free">a</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> iarray_update_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="More_IArray-iarray_length_of_fun"><span class="command">lemma</span></span> iarray_length_of_fun<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"IArray.length <span class="main">(</span>IArray.of_fun <span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="More_IArray-iarray_update_of_fun"><span class="command">lemma</span></span> iarray_update_of_fun<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"iarray_update <span class="main">(</span>IArray.of_fun <span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="free">i</span> <span class="free">x</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> iarray_update_def iarray_length_of_fun
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iarray_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">iarray_append</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">iarray_append</span> <span class="main">(</span>IArray <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> IArray <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="More_IArray-iarray_append_code"><span class="command">lemma</span></span> iarray_append_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"iarray_append <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> IArray <span class="main">(</span>IArray.list_of <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="More_IArray-iarray_append_of_fun"><span class="command">lemma</span></span> iarray_append_of_fun<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"iarray_append <span class="main">(</span>IArray.of_fun <span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> iarray_append.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="More_IArray-iarray_of_fun_sub"><span class="command">lemma</span></span> iarray_of_fun_sub<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> IArray.of_fun <span class="free">f</span> <span class="free">n</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_IArray-IArray_of_fun_conv"><span class="command">lemma</span></span> IArray_of_fun_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"IArray <span class="free">xs</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> IArray.of_fun_def<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> IArray.sub_def<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> iarray_simps <span class="main">=</span> iarray_update_of_fun iarray_append_of_fun IArray_of_fun_conv iarray_of_fun_sub

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Norms">
<div class="head">
<h1>Theory Norms</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Jose Divasón
                Maximilian Haslbeck
                Sebastiaan Joosten
                René Thiemann
                Akihisa Yamada
    License:    BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Norms›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this theory we provide the basic definitions and properties of several 
  norms of vectors and polynomials.
›</span></span> 

<span class="keyword1"><span class="command">theory</span></span> Norms
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Computational_Algebra/Polynomial.html">HOL-Computational_Algebra.Polynomial</a>"</span> 
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Adhoc_Overloading.html">HOL-Library.Adhoc_Overloading</a>"</span>
    <span class="quoted">"<a href="../../jordan_normal_form/theories/#Conjugate">Jordan_Normal_Form.Conjugate</a>"</span>
    <span class="quoted">"<a href="../../algebraic_numbers/theories/#Resultant">Algebraic_Numbers.Resultant</a>"</span> <span class="comment1">(* only for poly_of_vec *)</span>
    <a href="#Missing_Lemmas">Missing_Lemmas</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹L-<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∞›</span></span></span></span> Norms›</span></span>

<span class="keyword1"><span class="command">consts</span></span> linf_norm <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">∥</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">∥<span class="hidden">⇩</span><sub>∞</sub></span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">linf_norm_vec</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">linf_norm_vec</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> max_list <span class="main">(</span>map abs <span class="main">(</span>list_of_vec <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">adhoc_overloading</span></span> linf_norm <span class="quoted">linf_norm_vec</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">linf_norm_poly</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">linf_norm_poly</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> max_list <span class="main">(</span>map abs <span class="main">(</span>coeffs <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">adhoc_overloading</span></span> linf_norm <span class="quoted">linf_norm_poly</span>

<span class="keyword1" id="Norms-linf_norm_vec"><span class="command">lemma</span></span> linf_norm_vec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>vec <span class="free">n</span> <span class="free">f</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">=</span> max_list <span class="main">(</span>map <span class="main">(</span>abs <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linf_norm_vec_def<span class="main">)</span>

<span class="keyword1" id="Norms-linf_norm_vec_vCons"><span class="command">lemma</span></span> linf_norm_vec_vCons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>vCons <span class="free">a</span> <span class="free">v</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">=</span> max <span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linf_norm_vec_def max_list_Cons<span class="main">)</span>

<span class="keyword1" id="Norms-linf_norm_vec_0"><span class="command">lemma</span></span> linf_norm_vec_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>vec <span class="main">0</span> <span class="free">f</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linf_norm_vec_def<span class="main">)</span>

<span class="keyword1" id="Norms-linf_norm_zero_vec"><span class="command">lemma</span></span> linf_norm_zero_vec <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> ordered_ab_group_add_abs vec<span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_vec_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_vec_Suc<span class="main">)</span>

<span class="keyword1" id="Norms-linf_norm_vec_ge_0"><span class="command">lemma</span></span> linf_norm_vec_ge_0 <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ordered_ab_group_add_abs vec"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>

<span class="keyword1" id="Norms-linf_norm_vec_eq_0"><span class="command">lemma</span></span> linf_norm_vec_eq_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ordered_ab_group_add_abs vec"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> carrier_vec_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_vec_Suc max_def<span class="main">)</span>

<span class="keyword1" id="Norms-linf_norm_vec_greater_0"><span class="command">lemma</span></span> linf_norm_vec_greater_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ordered_ab_group_add_abs vec"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">v</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> carrier_vec_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_vec_Suc max_def<span class="main">)</span>

<span class="keyword1" id="Norms-linf_norm_poly_0"><span class="command">lemma</span></span> linf_norm_poly_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="main">0</span><span class="main">::</span><span class="main">_</span> poly<span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linf_norm_poly_def<span class="main">)</span>

<span class="keyword1" id="Norms-linf_norm_pCons"><span class="command">lemma</span></span> linf_norm_pCons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ordered_ab_group_add_abs poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>pCons <span class="free">a</span> <span class="free">p</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">=</span> max <span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">∥</span><span class="free">p</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linf_norm_poly_def max_list_Cons<span class="main">)</span>

<span class="keyword1" id="Norms-linf_norm_poly_ge_0"><span class="command">lemma</span></span> linf_norm_poly_ge_0 <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ordered_ab_group_add_abs poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>

<span class="keyword1" id="Norms-linf_norm_poly_eq_0"><span class="command">lemma</span></span> linf_norm_poly_eq_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ordered_ab_group_add_abs poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>

<span class="keyword1" id="Norms-linf_norm_poly_greater_0"><span class="command">lemma</span></span> linf_norm_poly_greater_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ordered_ab_group_add_abs poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Square Norms›</span></span>

<span class="keyword1"><span class="command">consts</span></span> sq_norm <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">∥</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">sq_norm_conjugate</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> conjugate <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="keyword1"><span class="command">adhoc_overloading</span></span> sq_norm <span class="quoted">sq_norm_conjugate</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Square norms for vectors›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We prefer sum\_list over sum because it is not essentially dependent on commutativity,
  and easier for proving.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sq_norm_vec</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">∑</span><span class="bound">x</span> <span class="main">←</span> list_of_vec <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">.</span> <span class="main">∥</span><span class="bound">x</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">adhoc_overloading</span></span> sq_norm <span class="quoted">sq_norm_vec</span>

<span class="keyword1" id="Norms-sq_norm_vec_vCons"><span class="command">lemma</span></span> sq_norm_vec_vCons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>vCons <span class="free">a</span> <span class="free">v</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">∥</span><span class="free">a</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_def<span class="main">)</span>

<span class="keyword1" id="Norms-sq_norm_vec_0"><span class="command">lemma</span></span> sq_norm_vec_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>vec <span class="main">0</span> <span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_def<span class="main">)</span>

<span class="keyword1" id="Norms-sq_norm_vec_as_cscalar_prod"><span class="command">lemma</span></span> sq_norm_vec_as_cscalar_prod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> conjugatable_ring vec"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="free">v</span> <span class="keyword1">∙c</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_def<span class="main">)</span>

<span class="keyword1" id="Norms-sq_norm_zero_vec"><span class="command">lemma</span></span> sq_norm_zero_vec<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> conjugatable_ring vec<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> sq_norm_vec_ge_0 <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span> <span class="main">=</span> conjugate_square_ge_0_vec<span class="main">[</span><span class="operator">folded</span> sq_norm_vec_as_cscalar_prod<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> sq_norm_vec_eq_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> conjugate_square_eq_0_vec<span class="main">[</span><span class="operator">folded</span> sq_norm_vec_as_cscalar_prod<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> sq_norm_vec_greater_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> conjugate_square_greater_0_vec<span class="main">[</span><span class="operator">folded</span> sq_norm_vec_as_cscalar_prod<span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Square norm for polynomials›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sq_norm_poly</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sq_norm_poly</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">∑</span><span class="bound">a</span><span class="main">←</span>coeffs <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> <span class="main">∥</span><span class="bound">a</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>

<span class="keyword1"><span class="command">adhoc_overloading</span></span> sq_norm <span class="quoted">sq_norm_poly</span>

<span class="keyword1" id="Norms-sq_norm_poly_0"><span class="command">lemma</span></span> sq_norm_poly_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="main">0</span><span class="main">::</span><span class="main">_</span>poly<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sq_norm_poly_def<span class="main">)</span>

<span class="keyword1" id="Norms-sq_norm_poly_pCons"><span class="command">lemma</span></span> sq_norm_poly_pCons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> conjugatable_ring"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>pCons <span class="free">a</span> <span class="free">p</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">∥</span><span class="free">a</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">∥</span><span class="free">p</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sq_norm_poly_def<span class="main">)</span>

<span class="keyword1" id="Norms-sq_norm_poly_ge_0"><span class="command">lemma</span></span> sq_norm_poly_ge_0 <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> conjugatable_ordered_ring poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">p</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> sq_norm_poly_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum_list_nonneg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>conjugate_square_positive<span class="main">)</span>

<span class="keyword1" id="Norms-sq_norm_poly_eq_0"><span class="command">lemma</span></span> sq_norm_poly_eq_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>conjugatable_ordered_ring<span class="main">,</span>ring_no_zero_divisors<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">p</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> IH<span class="main">:</span> <span class="main">(</span>pCons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">a</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">∥</span><span class="skolem">p</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_pos_nonneg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Norms-sq_norm_poly_pos"><span class="command">lemma</span></span> sq_norm_poly_pos <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>conjugatable_ordered_ring<span class="main">,</span>ring_no_zero_divisors<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">p</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_le<span class="main">)</span>

<span class="keyword1" id="Norms-sq_norm_vec_of_poly"><span class="command">lemma</span></span> sq_norm_vec_of_poly <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> conjugatable_ring poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>vec_of_poly <span class="free">p</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">∥</span><span class="free">p</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> sq_norm_poly_def sq_norm_vec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> sum_mset_sum_list<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Norms-sq_norm_poly_of_vec"><span class="command">lemma</span></span> sq_norm_poly_of_vec <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> conjugatable_ring vec"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>poly_of_vec <span class="free">v</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> sq_norm_poly_def sq_norm_vec_def coeffs_poly_of_vec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> rev_map<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> sum_mset_sum_list<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> mset_rev<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> sum_mset_sum_list<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum_list_map_dropWhile0<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relating Norms›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A class where ordering around 0 is linear.›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ordered_semiring<span class="main">)</span> <span class="entity">is_real</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_real</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">class</span></span> semiring_real_line <span class="main">=</span> ordered_semiring_strict <span class="main">+</span> ordered_semiring_0 <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> add_pos_neg_is_real<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> is_real <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mult_neg_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> pos_pos_linear<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∨</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> neg_neg_linear<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∨</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Norms-add_neg_pos_is_real"><span class="command">lemma</span></span> add_neg_pos_is_real<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> is_real <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_pos_neg_is_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Norms-nonneg_linorder_cases"><span class="command">lemma</span></span> nonneg_linorder_cases <span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> less eq greater<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">thesis</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms pos_pos_linear <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_less<span class="main">)</span>

<span class="keyword1" id="Norms-nonpos_linorder_cases"><span class="command">lemma</span></span> nonpos_linorder_cases <span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> less eq greater<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">thesis</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms neg_neg_linear <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_less<span class="main">)</span>

<span class="keyword1" id="Norms-real_linear"><span class="command">lemma</span></span> real_linear<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_real <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_real <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∨</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pos_pos_linear neg_neg_linear assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_trans<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Norms-real_linorder_cases"><span class="command">lemma</span></span> real_linorder_cases <span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> less eq greater<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> real<span class="main">:</span> <span class="quoted"><span class="quoted">"is_real <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"is_real <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">thesis</span></span>
  <span class="keyword1"><span class="command">using</span></span> real_linear<span class="main">[</span><span class="operator">OF</span> real<span class="main">]</span> cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"is_real <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"is_real <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> real_add_le_cancel_left_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">+</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">+</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> real_add_less_cancel_left_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">+</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">c</span> <span class="main">+</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> real_add_le_cancel_right_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">c</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">+</span> <span class="free">c</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> real_add_less_cancel_right_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">c</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">+</span> <span class="free">c</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_strict_left_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> add_strict_left_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> add_strict_right_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> add_strict_right_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> real_linorder_cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a b<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"is_real <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"is_real <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> real_mult_le_cancel_left_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> real_mult_less_cancel_left_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">c</span> <span class="main">*</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> real_mult_le_cancel_right_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="free">c</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">*</span> <span class="free">c</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> real_mult_less_cancel_right_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="free">c</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">*</span> <span class="free">c</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mult_strict_left_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> mult_strict_left_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> c
  <span class="keyword1"><span class="command">using</span></span> mult_strict_right_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> mult_strict_right_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> c
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> real_linorder_cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a b<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"is_real <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"is_real <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> not_le_real<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">a</span> <span class="main">≥</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> not_less_real<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">a</span> <span class="main">&gt;</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> real_linorder_cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a b<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_imp_le<span class="main">)</span>

<span class="keyword1" id="Norms-real_mult_eq_0_iff"><span class="command">lemma</span></span> real_mult_eq_0_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"is_real <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"is_real <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> a b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> mult_pos_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> mult_pos_neg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> mult_neg_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> mult_neg_neg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>l<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Norms-real_pos_mult_max"><span class="command">lemma</span></span> real_pos_mult_max<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semiring_real_line"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"is_real <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"is_real <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> max <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> max <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hom_max<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_mult_le_cancel_left_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a b c<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">class</span></span> ring_abs_real_line <span class="main">=</span> ordered_ring_abs <span class="main">+</span> semiring_real_line

<span class="keyword1"><span class="command">class</span></span> semiring_1_real_line <span class="main">=</span> semiring_real_line <span class="main">+</span> monoid_mult <span class="main">+</span> zero_less_one
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subclass</span></span> ordered_semiring_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Norms-power_both_mono"><span class="command">lemma</span></span> power_both_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">^</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> power_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> power_increasing<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> zero_le_one<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Norms-power_pos"><span class="command">lemma</span></span> power_pos<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> mult_strict_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a0<span class="main"><span class="main">]</span></span> a0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Norms-power_neg"><span class="command">lemma</span></span> power_neg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"even <span class="free">n</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> a0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_pos_neg2 mult_neg_neg<span class="main">)</span>

<span class="keyword1" id="Norms-power_ge_0_iff"><span class="command">lemma</span></span> power_ge_0_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"is_real <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">⟷</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">∨</span> even <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> power_neg<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="free">n</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> power_pos<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>power_0_left<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Norms-nonneg_power_less"><span class="command">lemma</span></span> nonneg_power_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">^</span><span class="free">n</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">^</span><span class="free">n</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> a <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="skolem">a</span>›</span></span>
  <span class="keyword1"><span class="command">note</span></span> b <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="skolem">b</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> a b <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nonneg_linorder_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> less
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc.hyps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a b<span class="main"><span class="main">]</span></span> True <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>mult_strict_mono' a b zero_le_power<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> eq
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> greater
      <span class="keyword1"><span class="command">with</span></span> Suc.hyps<span class="main">[</span><span class="operator">OF</span> b a<span class="main">]</span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">a</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> mult_strict_mono'<span class="main">[</span><span class="operator">OF</span> greater this<span class="main">]</span> b greater
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Norms-power_strict_mono"><span class="command">lemma</span></span> power_strict_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nonneg_power_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Norms-nonneg_power_le"><span class="command">lemma</span></span> nonneg_power_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">^</span><span class="free">n</span> <span class="main">≤</span> <span class="free">b</span><span class="main">^</span><span class="free">n</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nonneg_linorder_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword1"><span class="command">with</span></span> power_strict_mono<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> eq
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> greater
  <span class="keyword1"><span class="command">with</span></span> power_strict_mono<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> linordered_idom<span class="main">)</span> semiring_1_real_line
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_strict_left_mono mult_strict_right_mono mult_neg_neg<span class="main">)</span>

<span class="keyword1"><span class="command">class</span></span> ring_1_abs_real_line <span class="main">=</span> ring_abs_real_line <span class="main">+</span> semiring_1_real_line
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subclass</span></span> ring_1<span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Norms-abs_cases"><span class="command">lemma</span></span> abs_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">thesis</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Norms-abs_linorder_cases"><span class="command">lemma</span></span> abs_linorder_cases<span class="main">[</span><span class="operator">case_names</span> less eq greater<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="main">¦</span><span class="free">b</span><span class="main">¦</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="free">b</span><span class="main">¦</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">b</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">thesis</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nonneg_linorder_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">¦</span></span><span class="free"><span class="free">a</span></span><span class="main"><span class="main">¦</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">¦</span></span><span class="free"><span class="free">b</span></span><span class="main"><span class="main">¦</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> not_le_abs_abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">≥</span> <span class="main">¦</span><span class="free">b</span><span class="main">¦</span> <span class="main">⟷</span> <span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="main">¦</span><span class="free">b</span><span class="main">¦</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> not_less_abs_abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">&gt;</span> <span class="main">¦</span><span class="free">b</span><span class="main">¦</span> <span class="main">⟷</span> <span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="free">b</span><span class="main">¦</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> abs_linorder_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_imp_le<span class="main">)</span>

<span class="keyword1" id="Norms-abs_power_less"><span class="command">lemma</span></span> abs_power_less <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span><span class="main">¦</span><span class="main">^</span><span class="free">n</span> <span class="main">&lt;</span> <span class="main">¦</span><span class="free">b</span><span class="main">¦</span><span class="main">^</span><span class="free">n</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="main">¦</span><span class="free">b</span><span class="main">¦</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nonneg_power_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Norms-abs_power_le"><span class="command">lemma</span></span> abs_power_le <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span><span class="main">¦</span><span class="main">^</span><span class="free">n</span> <span class="main">≤</span> <span class="main">¦</span><span class="free">b</span><span class="main">¦</span><span class="main">^</span><span class="free">n</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="free">b</span><span class="main">¦</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nonneg_power_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Norms-abs_power_pos"><span class="command">lemma</span></span> abs_power_pos <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span><span class="main">¦</span><span class="main">^</span><span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> power_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span><span class="main">¦</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Norms-abs_power_nonneg"><span class="command">lemma</span></span> abs_power_nonneg <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span><span class="main">¦</span><span class="main">^</span><span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Norms-abs_power_eq_0"><span class="command">lemma</span></span> abs_power_eq_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span><span class="main">¦</span><span class="main">^</span><span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> real_mult_eq_0_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> nat <span class="main">::</span> <span class="quoted">semiring_1_real_line</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">instance</span></span> int <span class="main">::</span> <span class="quoted">ring_1_abs_real_line</span><span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Norms-vec_index_vec_of_list"><span class="command">lemma</span></span> vec_index_vec_of_list <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vec_of_list <span class="free">xs</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_vec_def undef_vec_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> empty_nth<span class="main">)</span>

<span class="keyword1" id="Norms-vec_of_list_append"><span class="command">lemma</span></span> vec_of_list_append<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_of_list <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> vec_of_list <span class="free">xs</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> vec_of_list <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

<span class="keyword1" id="Norms-linf_norm_vec_of_list"><span class="command">lemma</span></span> linf_norm_vec_of_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∥</span>vec_of_list <span class="free">xs</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">=</span> max_list <span class="main">(</span>map abs <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linf_norm_vec_def<span class="main">)</span>

<span class="keyword1" id="Norms-linf_norm_vec_as_Greatest"><span class="command">lemma</span></span> linf_norm_vec_as_Greatest<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ring_1_abs_real_line vec"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> abs <span class="main">`</span> set <span class="main">(</span>list_of_vec <span class="free">v</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> linf_norm_vec_of_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"list_of_vec <span class="free">v</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> max_list_as_Greatest<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Norms-vec_of_poly_pCons"><span class="command">lemma</span></span> vec_of_poly_pCons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_of_poly <span class="main">(</span>pCons <span class="free">a</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> vec_of_poly <span class="free">f</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> vec_of_list <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff Suc_diff_le<span class="main">)</span>

<span class="keyword1" id="Norms-vec_of_poly_as_vec_of_list"><span class="command">lemma</span></span> vec_of_poly_as_vec_of_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_of_poly <span class="free">f</span> <span class="main">=</span> vec_of_list <span class="main">(</span>rev <span class="main">(</span>coeffs <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pCons <span class="skolem">a</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_of_list_append vec_of_poly_pCons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Norms-linf_norm_vec_of_poly"><span class="command">lemma</span></span> linf_norm_vec_of_poly <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ring_1_abs_real_line poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>vec_of_poly <span class="free">f</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">=</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> vec_of_poly_as_vec_of_list linf_norm_vec_of_list linf_norm_poly_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> max_list_as_Greatest<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Norms-linf_norm_poly_as_Greatest"><span class="command">lemma</span></span> linf_norm_poly_as_Greatest<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ring_1_abs_real_line poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> abs <span class="main">`</span> set <span class="main">(</span>coeffs <span class="free">f</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> linf_norm_vec_as_Greatest<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"vec_of_poly <span class="free">f</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Norms-vec_index_le_linf_norm"><span class="command">lemma</span></span> vec_index_le_linf_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ring_1_abs_real_line vec"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_vec <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">v</span><span class="main">$</span><span class="free">i</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> linf_norm_vec_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_max_list<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  in_set_conv_nth <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Norms-coeff_le_linf_norm"><span class="command">lemma</span></span> coeff_le_linf_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ring_1_abs_real_line poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>coeff <span class="free">f</span> <span class="free">i</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vec_index_le_linf_norm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"vec_of_poly <span class="free">f</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> degree <span class="free">f</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_eq_0<span class="main">)</span>

<span class="keyword1"><span class="command">class</span></span> conjugatable_ring_1_abs_real_line <span class="main">=</span> conjugatable_ring <span class="main">+</span> ring_1_abs_real_line <span class="main">+</span> power <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sq_norm_as_sq_abs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">a</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">¦</span><span class="free">a</span><span class="main">¦</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">subclass</span></span> conjugatable_ordered_ring <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> int <span class="main">::</span> <span class="quoted">conjugatable_ring_1_abs_real_line</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> rat <span class="main">::</span> <span class="quoted">conjugatable_ring_1_abs_real_line</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> real <span class="main">::</span> <span class="quoted">conjugatable_ring_1_abs_real_line</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> complex <span class="main">::</span> <span class="quoted">semiring_1_real_line</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complex_eq_iff mult_le_cancel_left mult_le_cancel_right mult_neg_neg<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Due to the assumption <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> abs_ge_self<span class="antiquote"><span class="antiquote">}</span></span></span></span> from Groups.thy,
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> complex<span class="antiquote"><span class="antiquote">}</span></span></span></span> cannot be <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> ring_1_abs_real_line<span class="antiquote"><span class="antiquote">}</span></span></span></span>!
›</span></span>
<span class="keyword1"><span class="command">instance</span></span> complex <span class="main">::</span> <span class="quoted">ordered_ab_group_add_abs</span> <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1" id="Norms-sq_norm_as_sq_abs"><span class="command">lemma</span></span> sq_norm_as_sq_abs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sq_norm <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> conjugatable_ring_1_abs_real_line <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> power2 <span class="main">∘</span> abs"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Norms-sq_norm_vec_le_linf_norm"><span class="command">lemma</span></span> sq_norm_vec_le_linf_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>conjugatable_ring_1_abs_real_line<span class="main">}</span> vec"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> of_nat <span class="free">n</span> <span class="main">*</span> <span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> carrier_vec_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="skolem">a</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main">!</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">¦</span><span class="skolem">a</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">∥</span><span class="skolem">v</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">⟹</span> of_nat <span class="skolem">n</span> <span class="main">*</span> <span class="main">∥</span><span class="skolem">v</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> of_nat <span class="skolem">n</span> <span class="main">*</span> <span class="main">¦</span><span class="skolem">a</span><span class="main">¦</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> real_linorder_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">¦</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">a</span></span></span><span class="main"><span class="main"><span class="main">¦</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">∥</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">v</span></span></span><span class="main"><span class="main"><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Suc<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> power_mono mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ring_distribs max_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>add_mono power_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
 
<span class="keyword1" id="Norms-sq_norm_poly_le_linf_norm"><span class="command">lemma</span></span> sq_norm_poly_le_linf_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>conjugatable_ring_1_abs_real_line<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">p</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> of_nat <span class="main">(</span>degree <span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">p</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sq_norm_vec_le_linf_norm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"vec_of_poly <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> carrier_dim_vec<span class="main">)</span>

<span class="keyword1" id="Norms-coeff_le_sq_norm"><span class="command">lemma</span></span> coeff_le_sq_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>conjugatable_ring_1_abs_real_line<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>coeff <span class="free">f</span> <span class="free">i</span><span class="main">¦</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pCons <span class="skolem">a</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> pCons<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ii</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">¦</span><span class="skolem">a</span><span class="main">¦</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">∥</span><span class="skolem">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Norms-max_norm_witness"><span class="command">lemma</span></span> max_norm_witness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ordered_ring_abs poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">=</span> <span class="main">¦</span>coeff <span class="free">f</span> <span class="bound">i</span><span class="main">¦</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Norms-max_norm_le_sq_norm"><span class="command">lemma</span></span> max_norm_le_sq_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> conjugatable_ring_1_abs_real_line poly"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> max_norm_witness<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">=</span> <span class="main">¦</span>coeff <span class="free">f</span> <span class="skolem">i</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">using</span></span> coeff_le_sq_norm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*TODO MOVE*)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> conjugatable_ring<span class="main">)</span> conjugate_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"conjugate <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> conjugate <span class="free">x</span> <span class="main">-</span> conjugate <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> diff_conv_add_uminus conjugate_dist_add conjugate_neg<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>

<span class="keyword1" id="Norms-conjugate_1"><span class="command">lemma</span></span> conjugate_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>conjugate <span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>conjugatable_ring<span class="main">,</span> ring_1<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conjugate <span class="main">1</span> <span class="main">*</span> <span class="main">1</span> <span class="main">=</span> <span class="main">(</span>conjugate <span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conjugate <span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> conjugate_dist_mul<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Norms-conjugate_of_int"><span class="command">lemma</span></span> conjugate_of_int <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>conjugate <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>conjugatable_ring<span class="main">,</span>ring_1<span class="main">}</span><span class="main">)</span> <span class="main">=</span> of_int <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>nonneg <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conjugate_dist_add<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>neg <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conjugate_minus conjugate_neg<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> conjugate_1 conjugate_dist_add one_add_one<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Norms-sq_norm_of_int"><span class="command">lemma</span></span> sq_norm_of_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>map_vec of_int <span class="free">v</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>conjugatable_ring<span class="main">,</span>ring_1<span class="main">}</span> vec<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> of_int <span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_vec_as_cscalar_prod scalar_prod_def
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">norm1</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> sum_list <span class="main">(</span>map abs <span class="main">(</span>coeffs <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Norms-norm1_ge_0"><span class="command">lemma</span></span> norm1_ge_0<span class="main">:</span> <span class="quoted"><span class="quoted">"norm1 <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>abs<span class="main">,</span>ordered_semiring_0<span class="main">,</span>ordered_ab_group_add_abs<span class="main">}</span>poly<span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> norm1_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_nonneg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Norms-norm2_norm1_main_equality"><span class="command">lemma</span></span> norm2_norm1_main_equality<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> linordered_idom"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">i</span><span class="main">¦</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>
      <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">i</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">j</span><span class="main">¦</span><span class="main">)</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> insert <span class="skolem">n</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="skolem">f</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">n</span> <span class="main">+</span> sum <span class="skolem">f</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.insert<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id power2_sum <span class="keyword1"><span class="command">unfolding</span></span> Suc
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square sum_distrib_left sum.distrib <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Norms-norm2_norm1_main_inequality"><span class="command">lemma</span></span> norm2_norm1_main_inequality<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> linordered_idom"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">i</span><span class="main">¦</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>  
  <span class="keyword1"><span class="command">unfolding</span></span> norm2_norm1_main_equality 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg<span class="main">)</span>  

<span class="keyword1" id="Norms-norm2_le_norm1_int"><span class="command">lemma</span></span> norm2_le_norm1_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">f</span> <span class="main">::</span> int poly<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">(</span>norm1 <span class="free">f</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> <span class="main">(!)</span> <span class="main">(</span>coeffs <span class="free">f</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="main">(</span>coeffs <span class="free">f</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">F</span> <span class="bound">i</span> <span class="main">*</span> <span class="skolem">F</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> norm1_def sq_norm_poly_def sum_list_sum_nth F_def n_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"norm1 <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">¦</span><span class="skolem">F</span> <span class="bound">i</span><span class="main">¦</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> norm1_def sq_norm_poly_def sum_list_sum_nth F_def n_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> norm2_norm1_main_inequality<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Norms-sq_norm_smult_vec"><span class="command">lemma</span></span> sq_norm_smult_vec<span class="main">:</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span><span class="main">(</span><span class="free">c</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>conjugatable_ring<span class="main">,</span>comm_semiring_0<span class="main">}</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> conjugate <span class="free">c</span><span class="main">)</span> <span class="main">*</span> sq_norm <span class="free">v</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_vec_as_cscalar_prod 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> scalar_prod_smult_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> conjugate_smult_vec<span class="main"><span class="keyword3">,</span></span> 
    <span class="operator">subst</span> scalar_prod_smult_right<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Norms-vec_le_sq_norm"><span class="command">lemma</span></span> vec_le_sq_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> conjugatable_ring_1_abs_real_line vec"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">v</span> <span class="main">$</span> <span class="free">i</span><span class="main">¦</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="skolem">a</span> <span class="skolem">v</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Suc
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IH IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ii</span></span><span class="main">]</span> le_add_same_cancel2 order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">class</span></span> trivial_conjugatable <span class="main">=</span>
  conjugate <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> conjugate_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"conjugate <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>

<span class="keyword1"><span class="command">class</span></span> trivial_conjugatable_ordered_field <span class="main">=</span> 
  conjugatable_ordered_field <span class="main">+</span> trivial_conjugatable

<span class="keyword1"><span class="command">class</span></span> trivial_conjugatable_linordered_field <span class="main">=</span> 
  trivial_conjugatable_ordered_field <span class="main">+</span> linordered_field
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">subclass</span></span> conjugatable_ring_1_abs_real_line
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semiring_normalization_rules<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> rat <span class="main">::</span> <span class="quoted">trivial_conjugatable_linordered_field</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> real <span class="main">::</span> <span class="quoted">trivial_conjugatable_linordered_field</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Norms-scalar_prod_ge_0"><span class="command">lemma</span></span> scalar_prod_ge_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linordered_idom vec<span class="main">)</span> <span class="main">∙</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> scalar_prod_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Norms-cscalar_prod_is_scalar_prod"><span class="command">lemma</span></span> cscalar_prod_is_scalar_prod<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> trivial_conjugatable_ordered_field vec<span class="main">)</span> <span class="keyword1">∙c</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∙</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conjugate_id
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"scalar_prod <span class="free"><span class="free"><span class="free">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="Norms-scalar_prod_Cauchy"><span class="command">lemma</span></span> scalar_prod_Cauchy<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span> <span class="free">v</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>trivial_conjugatable_linordered_field<span class="main">}</span> Matrix.vec"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">∥</span><span class="free">u</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> v_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="skolem">r</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="skolem">r</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scalar_prod_ge_0<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="skolem">r</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="skolem">r</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∙</span> <span class="free">u</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">r</span> <span class="main">*</span> <span class="skolem">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">v</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="skolem">r</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="skolem">r</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="skolem">r</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">∙</span> <span class="free">u</span> <span class="main">-</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="skolem">r</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> scalar_prod_minus_distrib<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∙</span> <span class="free">u</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">∙</span> <span class="free">u</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="skolem">r</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> minus_scalar_prod_distrib<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∙</span> <span class="free">u</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">v</span> <span class="main">∙</span> <span class="free">u</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="main">∙</span> <span class="free">v</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">v</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> minus_scalar_prod_distrib<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∙</span> <span class="free">u</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">r</span> <span class="main">*</span> <span class="skolem">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">v</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms comm_scalar_prod <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∙</span> <span class="free">u</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">r</span> <span class="main">*</span> <span class="skolem">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">v</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> sq_norm <span class="free">u</span> <span class="main">-</span> <span class="main">(</span><span class="free">u</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> sq_norm <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">v</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span>
      <span class="keyword1"><span class="command">unfolding</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod power2_eq_square<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">∥</span><span class="free">u</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">(</span><span class="free">u</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">∥</span><span class="free">u</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="main">∙</span> <span class="free">v</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">∥</span><span class="free">u</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pos_divide_le_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">v</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span><span class="main">]</span> v_0 assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Int_Rat_Operations">
<div class="head">
<h1>Theory Int_Rat_Operations</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    René Thiemann
    License:    BSD
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Optimized Code for Integer-Rational Operations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Int_Rat_Operations
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../../sqrt_babylonian/theories/#Sqrt_Babylonian_Auxiliary">Sqrt_Babylonian.Sqrt_Babylonian_Auxiliary</a>
  <a href="#Norms">Norms</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">int_times_rat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> rat <span class="main">⇒</span> rat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">int_times_rat</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> of_int <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">declare</span></span> int_times_rat_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="Int_Rat_Operations-int_times_rat_code"><span class="command">lemma</span></span> int_times_rat_code<span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="main">(</span>int_times_rat <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> quotient_of <span class="free">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span> <span class="main">⇒</span> Rat.normalize <span class="main">(</span><span class="free">i</span> <span class="main">*</span> <span class="bound">n</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">unfolding</span></span> int_times_rat_def rat_times_code <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">square_rat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> rat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">square_rat</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> 

<span class="keyword1" id="Int_Rat_Operations-quotient_of_square"><span class="command">lemma</span></span> quotient_of_square<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"quotient_of <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"quotient_of <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">a</span><span class="main">,</span> <span class="free">b</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> b0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> quotient_of_denom_pos<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="main">*</span> <span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rat_times_code assms Let_def split Rat.normalize_def fst_conv snd_conv b if_True
    <span class="keyword1"><span class="command">using</span></span> quotient_of_coprime<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> b0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Int_Rat_Operations-square_rat_code"><span class="command">lemma</span></span> square_rat_code<span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="main">(</span>square_rat <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> quotient_of <span class="free">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span><span class="bound">n</span> <span class="main">*</span> <span class="bound">n</span><span class="main">,</span> <span class="bound">d</span> <span class="main">*</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> quotient_of_square<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> square_rat_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"quotient_of <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">scalar_prod_int_rat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec <span class="main">⇒</span> rat vec <span class="main">⇒</span> rat"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∙i</span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">∙i</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∙</span> map_vec rat_of_int <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Int_Rat_Operations-scalar_prod_int_rat_code"><span class="command">lemma</span></span> scalar_prod_int_rat_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">∙i</span> <span class="free">w</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="free">v</span><span class="main">.</span> int_times_rat <span class="main">(</span><span class="free">v</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">unfolding</span></span> scalar_prod_int_rat_def Let_def scalar_prod_def int_times_rat_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Int_Rat_Operations-scalar_prod_int_rat"><span class="command">lemma</span></span> scalar_prod_int_rat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">x</span> <span class="main">=</span> dim_vec <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∙i</span> <span class="free">y</span> <span class="main">=</span> map_vec of_int <span class="free">x</span> <span class="main">∙</span> <span class="free">y</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> scalar_prod_int_rat_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> comm_scalar_prod<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"dim_vec <span class="free"><span class="free"><span class="free">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> carrier_vecI<span class="main">)</span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sq_norm_vec_rat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat vec <span class="main">⇒</span> rat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sq_norm_vec_rat</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> sq_norm_vec <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> 

<span class="keyword1" id="Int_Rat_Operations-sq_norm_vec_rat_code"><span class="command">lemma</span></span> sq_norm_vec_rat_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sq_norm_vec_rat <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span>list_of_vec <span class="free">x</span><span class="main">.</span> square_rat <span class="bound">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_vec_rat_def sq_norm_vec_def square_rat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Cost">
<div class="head">
<h1>Theory Cost</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Maximilian Haslbeck
                René Thiemann
    License:    BSD
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Representing Computation Costs as Pairs of Results and Costs›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Cost
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> cost <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> nat"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> cost <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cost</span> <span class="main">=</span> snd"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">result</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> cost <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">result</span> <span class="main">=</span> fst"</span></span> 

<span class="keyword1" id="Cost-cost_simps"><span class="command">lemma</span></span> cost_simps<span class="main">:</span> <span class="quoted"><span class="quoted">"cost <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"result <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> cost_def result_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Cost-result_costD"><span class="command">lemma</span></span> result_costD<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"result <span class="free">f_c</span> <span class="main">=</span> <span class="free">f</span>"</span></span> 
  <span class="quoted"><span class="quoted">"cost <span class="free">f_c</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f_c</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cost_simps<span class="main">)</span>

<span class="keyword1" id="Cost-result_costD'"><span class="command">lemma</span></span> result_costD'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"result <span class="free">f_c</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∧</span> cost <span class="free">f_c</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f_c</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cost_simps<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="List_Representation">
<div class="head">
<h1>Theory List_Representation</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Jose Divasón
                Sebastiaan Joosten
                René Thiemann
                Akihisa Yamada
    License:    BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹List representation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> List_Representation
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="List_Representation-rev_take_Suc"><span class="command">lemma</span></span> rev_take_Suc<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">#</span> rev <span class="main">(</span>take <span class="free">j</span> <span class="free">xs</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> j <span class="keyword1"><span class="command">have</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> take <span class="free">j</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> id_take_nth_drop<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> xs<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> rev <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> list_repr <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list"</span></span>   

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_repr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list_repr <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_repr</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ba</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> fst <span class="free"><span class="bound"><span class="entity">ba</span></span></span> <span class="main">=</span> rev <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">∧</span> snd <span class="free"><span class="bound"><span class="entity">ba</span></span></span> <span class="main">=</span> drop <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>  

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">of_list_repr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list_repr <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">of_list_repr</span> <span class="free"><span class="bound"><span class="entity">ba</span></span></span> <span class="main">=</span> <span class="main">(</span>rev <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">ba</span></span></span><span class="main">)</span> <span class="main">@</span> snd <span class="free"><span class="bound"><span class="entity">ba</span></span></span><span class="main">)</span>"</span></span> 
  
<span class="keyword1" id="List_Representation-of_list_repr"><span class="command">lemma</span></span> of_list_repr<span class="main">:</span> <span class="quoted"><span class="quoted">"list_repr <span class="free">i</span> <span class="free">ba</span> <span class="free">xs</span> <span class="main">⟹</span> of_list_repr <span class="free">ba</span> <span class="main">=</span> <span class="free">xs</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> of_list_repr_def list_repr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_nth_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list_repr <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_nth_i</span> <span class="free"><span class="bound"><span class="entity">ba</span></span></span> <span class="main">=</span> hd <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">ba</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_nth_im1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list_repr <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_nth_im1</span> <span class="free"><span class="bound"><span class="entity">ba</span></span></span> <span class="main">=</span> hd <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">ba</span></span></span><span class="main">)</span>"</span></span> 
  
<span class="keyword1" id="List_Representation-get_nth_i"><span class="command">lemma</span></span> get_nth_i<span class="main">:</span> <span class="quoted"><span class="quoted">"list_repr <span class="free">i</span> <span class="free">ba</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> get_nth_i <span class="free">ba</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> list_repr_def get_nth_i_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_drop_conv_nth<span class="main">)</span> 

<span class="keyword1" id="List_Representation-get_nth_im1"><span class="command">lemma</span></span> get_nth_im1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_repr <span class="free">i</span> <span class="free">ba</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> get_nth_im1 <span class="free">ba</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> list_repr_def get_nth_im1_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_take_Suc<span class="main">)</span> 
    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list_repr <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list_repr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_i</span> <span class="free"><span class="bound"><span class="entity">ba</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">ba</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> tl <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">ba</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 
  
<span class="keyword1" id="List_Representation-Cons_tl_drop_update"><span class="command">lemma</span></span> Cons_tl_drop_update<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">#</span> tl <span class="main">(</span>drop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> drop <span class="free">i</span> <span class="main">(</span><span class="free">xs</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="List_Representation-update_i"><span class="command">lemma</span></span> update_i<span class="main">:</span> <span class="quoted"><span class="quoted">"list_repr <span class="free">i</span> <span class="free">ba</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> list_repr <span class="free">i</span> <span class="main">(</span>update_i <span class="free">ba</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> update_i_def list_repr_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons_tl_drop_update<span class="main">)</span>
    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update_im1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list_repr <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list_repr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_im1</span> <span class="free"><span class="bound"><span class="entity">ba</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> tl <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">ba</span></span></span><span class="main">)</span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">ba</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="List_Representation-update_im1"><span class="command">lemma</span></span> update_im1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_repr <span class="free">i</span> <span class="free">ba</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> list_repr <span class="free">i</span> <span class="main">(</span>update_im1 <span class="free">ba</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">[</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> update_im1_def list_repr_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_take_Suc<span class="main">)</span>
  
<span class="keyword1" id="List_Representation-tl_drop_Suc"><span class="command">lemma</span></span> tl_drop_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>drop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0 <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inc_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list_repr <span class="main">⇒</span> <span class="tfree">'a</span> list_repr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inc_i</span> <span class="free"><span class="bound"><span class="entity">ba</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ba</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>hd <span class="bound">a</span> <span class="main">#</span> <span class="bound">b</span><span class="main">,</span> tl <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    
<span class="keyword1" id="List_Representation-inc_i"><span class="command">lemma</span></span> inc_i<span class="main">:</span> <span class="quoted"><span class="quoted">"list_repr <span class="free">i</span> <span class="free">ba</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> list_repr <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">(</span>inc_i <span class="free">ba</span><span class="main">)</span> <span class="free">xs</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> list_repr_def inc_i_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ba</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_take_Suc hd_drop_conv_nth tl_drop_Suc<span class="main">)</span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dec_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list_repr <span class="main">⇒</span> <span class="tfree">'a</span> list_repr"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dec_i</span> <span class="free"><span class="bound"><span class="entity">ba</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ba</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>tl <span class="bound">b</span><span class="main">,</span> hd <span class="bound">b</span> <span class="main">#</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    
<span class="keyword1" id="List_Representation-dec_i"><span class="command">lemma</span></span> dec_i<span class="main">:</span> <span class="quoted"><span class="quoted">"list_repr <span class="free">i</span> <span class="free">ba</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> list_repr <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>dec_i <span class="free">ba</span><span class="main">)</span> <span class="free">xs</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> list_repr_def dec_i_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ba</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_take_Suc hd_drop_conv_nth Cons_nth_drop_Suc<span class="main">)</span> 

<span class="keyword1" id="List_Representation-dec_i_Suc"><span class="command">lemma</span></span> dec_i_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"list_repr <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">ba</span> <span class="free">xs</span> <span class="main">⟹</span> list_repr <span class="free">i</span> <span class="main">(</span>dec_i <span class="free">ba</span><span class="main">)</span> <span class="free">xs</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> dec_i<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span>"</span></span> <span class="quoted"><span class="free">ba</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Gram_Schmidt_2">
<div class="head">
<h1>Theory Gram_Schmidt_2</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Ralph Bottesch
                Jose Divasón
                Maximilian Haslbeck
                Sebastiaan Joosten
                René Thiemann
                Akihisa Yamada
    License:    BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Gram-Schmidt›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Gram_Schmidt_2
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="../../jordan_normal_form/theories/#Gram_Schmidt">Jordan_Normal_Form.Gram_Schmidt</a>
    <a href="../../jordan_normal_form/theories/#Show_Matrix">Jordan_Normal_Form.Show_Matrix</a>
    <a href="../../jordan_normal_form/theories/#Matrix_Impl">Jordan_Normal_Form.Matrix_Impl</a>
    <a href="#Norms">Norms</a>
    <a href="#Int_Rat_Operations">Int_Rat_Operations</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(* TODO: Documentation and add references to computer algebra book *)</span>

<span class="keyword1"><span class="command">no_notation</span></span> Group.m_inv  <span class="main">(</span><span class="quoted">"<span class="keyword1">inv</span>ı _"</span> <span class="main">[</span>81<span class="main">]</span> 80<span class="main">)</span>

<span class="comment1">(* TODO: Is a function like this already in the library
   find_index is used to rewrite the sumlists in the lattice_of definition to finsums *)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_index</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">find_index</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="free">find_index</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_2-find_index_not_in_set"><span class="command">lemma</span></span> find_index_not_in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="main">⟷</span> find_index <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-find_index_in_set"><span class="command">lemma</span></span> find_index_in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span>find_index <span class="free">xs</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-find_index_inj"><span class="command">lemma</span></span> find_index_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>find_index <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-find_index_leq_length"><span class="command">lemma</span></span> find_index_leq_length<span class="main">:</span> <span class="quoted"><span class="quoted">"find_index <span class="free">xs</span> <span class="free">x</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(* TODO: move *)</span>

<span class="keyword1" id="Gram_Schmidt_2-rev_unsimp"><span class="command">lemma</span></span> rev_unsimp<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">r</span> <span class="main">#</span> <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">(</span><span class="free">r</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="free">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(* TODO: unify *)</span>

<span class="keyword1" id="Gram_Schmidt_2-corthogonal_is_orthogonal"><span class="command">lemma</span></span> corthogonal_is_orthogonal<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"corthogonal <span class="main">(</span><span class="free">xs</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> trivial_conjugatable_ordered_field vec list<span class="main">)</span> <span class="main">=</span> orthogonal <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> corthogonal_def orthogonal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="comment1">(* TODO: move *)</span>

<span class="keyword1"><span class="command">context</span></span> vec_module <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lattice_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec list <span class="main">⇒</span> <span class="tfree">'a</span> vec set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lattice_of</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> range <span class="main">(</span><span class="main">λ</span> <span class="bound">c</span><span class="main">.</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="bound">c</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_2-lattice_of_finsum"><span class="command">lemma</span></span> lattice_of_finsum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs</span> <span class="main">=</span> range <span class="main">(</span><span class="main">λ</span> <span class="bound">c</span><span class="main">.</span> finsum V <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="bound">c</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free">fs</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free">fs</span><span class="main">]</span><span class="main">)</span>
        <span class="main">=</span> finsum V <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free">fs</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
    <span class="keyword1"><span class="command">using</span></span>  assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_map_as_finsum<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lattice_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-in_latticeE"><span class="command">lemma</span></span> in_latticeE<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> lattice_of <span class="free">fs</span>"</span></span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="free">c</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free">fs</span><span class="main">]</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lattice_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1" id="Gram_Schmidt_2-in_latticeI"><span class="command">lemma</span></span> in_latticeI<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="free">c</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free">fs</span><span class="main">]</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> lattice_of <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lattice_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-finsum_over_indexes_to_vectors"><span class="command">lemma</span></span> finsum_over_indexes_to_vectors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">vs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> length <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">}</span><span class="main">.</span> of_int <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">vs</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="free">vs</span><span class="main">.</span> of_int <span class="main">(</span><span class="bound">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">vs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs'</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> vs'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">vs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Zero_not_Suc length_0_conv rev_exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">}</span><span class="main">.</span> of_int <span class="main">(</span><span class="free">g</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">vs'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs'</span><span class="main">.</span> of_int <span class="main">(</span><span class="bound">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc vs'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> c_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">}</span><span class="main">.</span> of_int <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">vs'</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs'</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">l</span><span class="main">}</span><span class="main">.</span> of_int <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">vs</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span> 
        <span class="main">=</span> of_int <span class="main">(</span><span class="free">g</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">vs</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">}</span><span class="main">.</span> of_int <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">vs</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> finsum_insert<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finsum_cong'<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">vs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">}</span><span class="main">.</span> of_int <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="skolem">vs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">}</span><span class="main">.</span> of_int <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">vs'</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc vs'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finsum_cong'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_mono append_Cons_nth_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> c_def
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">vs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc vs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d'</span><span class="main">.</span> of_int <span class="main">(</span><span class="free">g</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">+</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs'</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs</span><span class="main">.</span> of_int <span class="main">(</span><span class="bound">d'</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> set <span class="skolem">vs'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">vs'</span> <span class="main">=</span> insert <span class="skolem">v</span> <span class="main">(</span>set <span class="skolem">vs'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">then</span> <span class="skolem">c</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">g</span> <span class="skolem">l</span> <span class="keyword1">else</span> <span class="skolem">c</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span><span class="free">g</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">+</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs'</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>
          <span class="main">=</span> of_int <span class="main">(</span><span class="free">g</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">+</span> <span class="main">(</span>of_int <span class="main">(</span><span class="skolem">c</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">+</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc vs'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> I<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> finsum_insert<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_int <span class="main">(</span><span class="free">g</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">+</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">+</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc vs'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> a_assoc<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finsum_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span><span class="free">g</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">+</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">=</span> of_int <span class="main">(</span><span class="skolem">c'</span> <span class="skolem">v</span><span class="main">)</span>  <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> c'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_smult_distrib_vec<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c'</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc vs'_def <span class="keyword1"><span class="command">unfolding</span></span> c'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finsum_cong'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span><span class="skolem">c'</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">+</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c'</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>
               <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>insert <span class="skolem">v</span> <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c'</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc vs'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> finsum_insert<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> vs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">then</span> <span class="free">g</span> <span class="skolem">l</span> <span class="keyword1">else</span> <span class="skolem">c</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span><span class="free">g</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">+</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs'</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>
          <span class="main">=</span> of_int <span class="main">(</span><span class="skolem">c'</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">+</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs'</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> c'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs'</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs'</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c'</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> c'_def <span class="keyword1"><span class="command">using</span></span> Suc False vs'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finsum_cong'<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span><span class="skolem">c'</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">+</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs'</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c'</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>
               <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>insert <span class="skolem">v</span> <span class="main">(</span>set <span class="skolem">vs'</span><span class="main">)</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c'</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False Suc vs'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> finsum_insert<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs'</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c'</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="skolem">vs'</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> c'_def <span class="keyword1"><span class="command">using</span></span> False Suc vs'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finsum_cong'<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> vs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-lattice_of_altdef"><span class="command">lemma</span></span> lattice_of_altdef<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">vs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">vs</span> <span class="main">=</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="free">vs</span><span class="main">.</span> of_int <span class="main">(</span><span class="bound">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> lattice_of <span class="free">vs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="free">vs</span><span class="main">.</span> of_int <span class="main">(</span><span class="bound">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="free">vs</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="free">vs</span><span class="main">.</span> of_int <span class="main">(</span><span class="bound">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> find_index <span class="free">vs</span> <span class="main">(</span><span class="free">vs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span> <span class="keyword1">then</span> <span class="skolem">c</span> <span class="main">(</span><span class="free">vs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="free">vs</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c'</span> <span class="main">(</span>find_index <span class="free">vs</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">vs</span> <span class="main">!</span> <span class="main">(</span>find_index <span class="free">vs</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> v
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finsum_cong' <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c'_def find_index_in_set in_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">i</span><span class="main">∈</span>find_index <span class="free">vs</span> <span class="main">`</span> <span class="main">(</span>set <span class="free">vs</span><span class="main">)</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c'</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">vs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms find_index_in_set find_index_inj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> finsum_reindex<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">i</span><span class="main">∈</span>set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">vs</span><span class="main">]</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c'</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">vs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> find_index <span class="free">vs</span> <span class="main">`</span> set <span class="free">vs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">vs</span>"</span></span> <span class="quoted"><span class="quoted">"find_index <span class="free">vs</span> <span class="main">(</span><span class="free">vs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageI nth_mem<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> c'_def <span class="keyword1"><span class="command">using</span></span> find_index_leq_length assms 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add.finprod_mono_neutral_cong_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_mono find_index_leq_length<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c'</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">vs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">vs</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_map_as_finsum<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lattice_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="free">vs</span><span class="main">.</span> of_int <span class="main">(</span><span class="bound">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> lattice_of <span class="free">vs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">vs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">vs</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> lattice_of <span class="free">vs</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lattice_of_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">vs</span><span class="main">}</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">vs</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_map_as_finsum<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="free">vs</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">d</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finsum_over_indexes_to_vectors assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-basis_in_latticeI"><span class="command">lemma</span></span> basis_in_latticeI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> set <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> lattice_of <span class="free">fs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">f</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span><span class="main">{</span><span class="free">f</span><span class="main">}</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>set <span class="free">fs</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add.finprod_mono_neutral_cong_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms lattice_of_altdef <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-lattice_of_eq_set"><span class="command">lemma</span></span> lattice_of_eq_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">=</span> set <span class="free">gs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs</span> <span class="main">=</span> lattice_of <span class="free">gs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lattice_of_altdef <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Gram_Schmidt_2-lattice_of_swap"><span class="command">lemma</span></span> lattice_of_swap<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gs</span> <span class="main">=</span> <span class="free">fs</span><span class="main">[</span> <span class="free">i</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">,</span> <span class="free">j</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">gs</span> <span class="main">=</span> lattice_of <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms mset_swap <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lattice_of_eq_set<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-lattice_of_add"><span class="command">lemma</span></span> lattice_of_add<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gs</span> <span class="main">=</span> <span class="free">fs</span><span class="main">[</span> <span class="free">i</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> of_int <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">]</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">gs</span> <span class="main">=</span> lattice_of <span class="free">fs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">l</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec list"</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> ij<span class="main">(</span>1<span class="main">)</span> *
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span><span class="main">[</span> <span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">+</span> of_int <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?len</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Suc <span class="skolem">j</span><span class="main">..&lt;</span>length <span class="skolem">fs</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="skolem">fs</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Suc <span class="skolem">j</span> <span class="main">..&lt;</span> length <span class="skolem">fs</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_self_conv2 less_Suc_eq_le less_imp_add_positive upt_add_eq_append 
          upt_conv_Cons zero_less_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_self_conv2 less_Suc_eq_le less_imp_add_positive upt_add_eq_append 
          upt_conv_Cons zero_less_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">fs</span><span class="main">]</span> <span class="main">=</span> <span class="var">?len</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> fs <span class="keyword1"><span class="command">have</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">fs</span> <span class="main">⟹</span> <span class="skolem">fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> fs <span class="keyword1"><span class="command">have</span></span> fsd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">fs</span> <span class="main">⟹</span> dim_vec <span class="main">(</span><span class="skolem">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> fsd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> fsd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">have</span></span> fsd<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span><span class="skolem">fs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span><span class="skolem">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> lattice_of <span class="skolem">fs</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> in_latticeE<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">unfolded</span> len<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="var">?len</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sc</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sc</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">j</span> <span class="keyword1">then</span> <span class="skolem">c</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">c</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">l</span> <span class="keyword1">else</span> <span class="skolem">c</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sd</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sd</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">d</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> isc<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">is</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="skolem">fs</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">sc</span> <span class="skolem">is</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> 
        <span class="keyword1"><span class="command">unfolding</span></span> sc_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sumlist_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> isd<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">is</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="skolem">fs</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">sd</span> <span class="skolem">is</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> 
        <span class="keyword1"><span class="command">unfolding</span></span> sd_def <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sumlist_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> k<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">k</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">sc</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">sc</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">sc</span> <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">sc</span> <span class="main">[</span><span class="skolem">j</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">sc</span> <span class="main">[</span>Suc <span class="skolem">j</span> <span class="main">..&lt;</span> length <span class="skolem">fs</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">sd</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">sd</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">sd</span> <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">sd</span> <span class="main">[</span><span class="skolem">j</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?E</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">sd</span> <span class="main">[</span>Suc <span class="skolem">j</span> <span class="main">..&lt;</span> length <span class="skolem">fs</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?CC</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"carrier_vec <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">have</span></span> ae<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">∈</span> <span class="var">?CC</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">∈</span> <span class="var">?CC</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">∈</span> <span class="var">?CC</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">∈</span> <span class="var">?CC</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="main">∈</span> <span class="var">?CC</span>"</span></span>  
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> isc<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> AE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∈</span> <span class="var">?CC</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">∈</span> <span class="var">?CC</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="main">∈</span> <span class="var">?CC</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D</span> <span class="main">∈</span> <span class="var">?CC</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?E</span> <span class="main">∈</span> <span class="var">?CC</span>"</span></span>  
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> isd<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> sc_sd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">}</span> <span class="main">∩</span> set <span class="skolem">is</span> <span class="main">⊆</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="skolem">sc</span> <span class="skolem">is</span> <span class="main">=</span> <span class="skolem">sd</span> <span class="skolem">is</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> 
        <span class="keyword1"><span class="command">unfolding</span></span> sc_def sd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">sumlist</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> map_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rename_tac</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="improper">k</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="var">?a</span> <span class="main">+</span> <span class="main">(</span><span class="var">?b</span> <span class="main">+</span> <span class="main">(</span><span class="var">?c</span> <span class="main">+</span> <span class="main">(</span><span class="var">?d</span> <span class="main">+</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>         
        <span class="keyword1"><span class="command">unfolding</span></span> f map_append sc_def <span class="keyword1"><span class="command">using</span></span> fs *
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> sumlist_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?a</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="var">?b</span> <span class="main">+</span> <span class="var">?d</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="var">?c</span> <span class="main">+</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ae <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>          
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="var">?b</span> <span class="main">+</span> <span class="var">?d</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="var">?C</span> <span class="main">+</span> <span class="var">?E</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sc_sd<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">+</span> <span class="var">?d</span> <span class="main">=</span> <span class="var">?B</span> <span class="main">+</span> <span class="var">?D</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sd_def sc_def d_def sumlist_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> * fsd<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">+</span> <span class="main">(</span><span class="var">?B</span> <span class="main">+</span> <span class="main">(</span><span class="var">?C</span> <span class="main">+</span> <span class="main">(</span><span class="var">?D</span> <span class="main">+</span> <span class="var">?E</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> AE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">d</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="var">?len</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> f map_append sd_def <span class="keyword1"><span class="command">using</span></span> fs *
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> sumlist_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">d</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="var">?gs</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> len<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">d</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="var">?gs</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> in_latticeI<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> lattice_of <span class="var">?gs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="skolem">fs</span> <span class="main">⊆</span> lattice_of <span class="var">?gs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> this 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec list"</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span><span class="main">[</span> <span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">+</span> of_int <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">gs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gs</span> <span class="main">=</span> <span class="var">?gs</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> main<span class="main">[</span><span class="operator">OF</span> * fs<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">,</span> <span class="operator">folded</span> gs_def<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> one<span class="main">:</span> <span class="quoted"><span class="quoted">"lattice_of <span class="skolem">fs</span> <span class="main">⊆</span> lattice_of <span class="skolem">gs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">gs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">gs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * fs <span class="keyword1"><span class="command">unfolding</span></span> gs_def set_conv_nth
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">k</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_carrier_vec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> fs <span class="keyword1"><span class="command">have</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">fs</span> <span class="main">⟹</span> <span class="skolem">fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> fs <span class="keyword1"><span class="command">have</span></span> fsd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">fs</span> <span class="main">⟹</span> dim_vec <span class="main">(</span><span class="skolem">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> fsd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> fsd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">have</span></span> fsd<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span><span class="skolem">fs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span><span class="skolem">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> main<span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">l</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="skolem">gs</span> <span class="main">⊆</span> lattice_of <span class="main">(</span><span class="skolem">gs</span><span class="main">[</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">gs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">+</span> of_int <span class="main">(</span><span class="main">-</span> <span class="free">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">gs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gs</span><span class="main">[</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">gs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">+</span> of_int <span class="main">(</span><span class="main">-</span> <span class="free">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">gs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">fs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> * fsd<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">k</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="skolem">fs</span> <span class="main">=</span> lattice_of <span class="var">?gs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> one <span class="keyword1"><span class="command">unfolding</span></span> gs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> main<span class="main">[</span><span class="operator">OF</span> this ij<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fs<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> ij <span class="keyword1"><span class="command">have</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">hs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hs</span> <span class="main">=</span> <span class="free">fs</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">,</span> <span class="free">j</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>"</span></span> 
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ks</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ks</span> <span class="main">=</span> <span class="skolem">hs</span><span class="main">[</span><span class="free">j</span> <span class="main">:=</span> <span class="skolem">hs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">+</span> of_int <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">hs</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> ij fs <span class="keyword1"><span class="command">have</span></span> ij'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="skolem">hs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">hs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> ij''<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">ks</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="skolem">ks</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="skolem">ks</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> ji <span class="keyword1"><span class="command">unfolding</span></span> ks_def set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">k</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">k</span> <span class="main">=</span> <span class="free">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_carrier_vec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> lattice_of_swap<span class="main">[</span><span class="operator">OF</span> fs ij refl<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs</span> <span class="main">=</span> lattice_of <span class="skolem">hs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lattice_of <span class="skolem">ks</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> main<span class="main">[</span><span class="operator">OF</span> ji ij'<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ks_def <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lattice_of <span class="main">(</span><span class="skolem">ks</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">ks</span> <span class="main">!</span> <span class="free">j</span><span class="main">,</span> <span class="free">j</span> <span class="main">:=</span> <span class="skolem">ks</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> lattice_of_swap<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ij'' refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ks</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">ks</span> <span class="main">!</span> <span class="free">j</span><span class="main">,</span> <span class="free">j</span> <span class="main">:=</span> <span class="skolem">ks</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">=</span> <span class="free">gs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs ks_def hs_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ij<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> 
       <span class="operator">rename_tac</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">k</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">k</span> <span class="main">=</span> <span class="free">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">orthogonal_complement</span> <span class="free"><span class="bound"><span class="entity">W</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier_vec <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">W</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_2-orthogonal_complement_subset"><span class="command">lemma</span></span> orthogonal_complement_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orthogonal_complement <span class="free">B</span> <span class="main">⊆</span> orthogonal_complement <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> orthogonal_complement_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> vec_space
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1" id="Gram_Schmidt_2-in_orthogonal_complement_span"><span class="command">lemma</span></span> in_orthogonal_complement_span<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"orthogonal_complement <span class="main">(</span>span <span class="free">S</span><span class="main">)</span> <span class="main">=</span> orthogonal_complement <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"orthogonal_complement <span class="main">(</span>span <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> orthogonal_complement <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> orthogonal_complement_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> in_own_span<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec set"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> x <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> i0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∙</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∙</span> lincomb <span class="skolem">a</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> comm_scalar_prod<span class="main">[</span><span class="operator">OF</span> x lincomb_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">insert</span> S<span class="main"><span class="keyword3">,</span></span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span> finite_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms x <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">F</span><span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span><span class="quoted"><span class="quoted">"insert <span class="skolem">f</span> <span class="skolem">F</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> F<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> F f assms
        <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> fc<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">F</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> laf<span class="main">:</span><span class="quoted"><span class="quoted">"lincomb <span class="skolem">a</span> <span class="skolem">F</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">u</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="main">(</span><span class="skolem">a</span> <span class="bound">u</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">u</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">insert</span> laf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> lincomb_def<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> finsum_scalar_prod_sum<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> f i0 <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> comm_scalar_prod<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> lincomb_closed<span class="main">[</span><span class="operator">OF</span> subset_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i assms<span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lincomb <span class="skolem">a</span> <span class="main">(</span>insert <span class="skolem">f</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lincomb_def
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> finsum_scalar_prod_sum<span class="main"><span class="keyword3">,</span></span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span><span class="operator">force</span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> smult_scalar_prod_distrib<span class="main">[</span><span class="operator">OF</span> fc x<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"orthogonal_complement <span class="free">S</span> <span class="main">⊆</span> orthogonal_complement <span class="main">(</span>span <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_complement_def span_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> cof_vec_space
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lin_indpt_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lin_indpt_list</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">⊆</span> carrier_vec <span class="free">n</span> <span class="main">∧</span> distinct <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">∧</span> lin_indpt <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">basis_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basis_list</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">⊆</span> carrier_vec <span class="free">n</span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> carrier_vec <span class="free">n</span> <span class="main">⊆</span> span <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_2-upper_triangular_imp_lin_indpt_list"><span class="command">lemma</span></span> upper_triangular_imp_lin_indpt_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tri<span class="main">:</span> <span class="quoted"><span class="quoted">"upper_triangular <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> diag<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> set <span class="main">(</span>diag_mat <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lin_indpt_list <span class="main">(</span>rows <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> upper_triangular_imp_distinct<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> upper_triangular_imp_lin_indpt_rows<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> A
  <span class="keyword1"><span class="command">unfolding</span></span> lin_indpt_list_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rows_def<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-basis_list_basis"><span class="command">lemma</span></span> basis_list_basis<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"basis_list <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"lin_indpt <span class="main">(</span>set <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"basis <span class="main">(</span>set <span class="free">fs</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> basis_list_def<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> span<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier_vec <span class="free">n</span> <span class="main">⊆</span> span <span class="main">(</span>set <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"basis <span class="main">(</span>set <span class="free">fs</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> dim_gen_is_basis<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_set C<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="free">fs</span><span class="main">)</span> <span class="main">≤</span> dim"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dim_is_n <span class="keyword1"><span class="command">unfolding</span></span> len<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_length<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>set <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> span C <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lin_indpt <span class="main">(</span>set <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> basis_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> distinct <span class="free">fs</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="free">fs</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> antisym_conv1 card_distinct card_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dim"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> len dim_is_n <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="free">fs</span><span class="main">)</span> <span class="main">&lt;</span> dim"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span>set <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> span finite_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">fs</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">using</span></span> b basis_def gen_ge_dim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-basis_list_imp_lin_indpt_list"><span class="command">lemma</span></span> basis_list_imp_lin_indpt_list<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"basis_list <span class="free">fs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lin_indpt_list <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> basis_list_basis<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> lin_indpt_list_def basis_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-basis_det_nonzero"><span class="command">lemma</span></span> basis_det_nonzero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> db<span class="main">:</span><span class="quoted"><span class="quoted">"basis <span class="main">(</span>set <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span><span class="quoted"><span class="quoted">"length <span class="free">G</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">G</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> M_car1<span class="main">:</span><span class="quoted"><span class="quoted">"mat_of_rows <span class="free">n</span> <span class="free">G</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> M_car<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">G</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> li<span class="main">:</span><span class="quoted"><span class="quoted">"lin_indpt <span class="main">(</span>set <span class="free">G</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> inc_2<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="free">G</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> issp<span class="main">:</span><span class="quoted"><span class="quoted">"carrier_vec <span class="free">n</span> <span class="main">=</span> span <span class="main">(</span>set <span class="free">G</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> RG_in_carr<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">G</span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> basis_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"basis_list <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> basis_list_def <span class="keyword1"><span class="command">using</span></span> len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> basis_list_basis<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> di<span class="main">:</span><span class="quoted"><span class="quoted">"distinct <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="main">(</span><span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">G</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> det_0_iff_vec_prod_zero<span class="main">[</span><span class="operator">OF</span> M_car<span class="main">]</span> 
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">G</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> span <span class="main">(</span>set <span class="free">G</span><span class="main">)</span>"</span></span>
                          <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">G</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> issp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> finite_in_span<span class="main">[</span><span class="operator">OF</span> finite_set inc_2 v<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> aA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> lincomb <span class="skolem">a</span> <span class="main">(</span>set <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> v<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> issp<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> inG<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> set <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> di2<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">G</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">G</span><span class="main">]</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">l</span> <span class="main">=</span> <span class="free">G</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">then</span> <span class="skolem">v</span> <span class="main">$</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> f'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="free">G</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ia</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">G</span> <span class="main">!</span> <span class="bound">ia</span> <span class="main">=</span> <span class="free">G</span> <span class="main">!</span> <span class="skolem">i</span> <span class="keyword1">then</span> <span class="skolem">v</span> <span class="main">$</span> <span class="bound">ia</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> f_def sum.distinct_set_conv_list<span class="main">[</span><span class="operator">OF</span> di2<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> len <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mat_of_cols <span class="free">n</span> <span class="free">G</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> transpose_mat_of_rows <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> mat_of_cols_mult_as_finsum<span class="main">[</span><span class="operator">OF</span> v<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> issp len<span class="main"><span class="main">]</span></span> RG_in_carr<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span><span class="quoted"><span class="quoted">"lincomb <span class="skolem">f</span> <span class="main">(</span>set <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> len f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> list_trisect<span class="main">[</span><span class="operator">OF</span> i<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> len<span class="main"><span class="main">]</span></span><span class="main">,</span><span class="operator">unfolded</span> len<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> x <span class="main">=</span> i<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> len<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">]</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">G</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">G</span> <span class="main">!</span> <span class="skolem">i</span> <span class="keyword1">then</span> <span class="skolem">v</span> <span class="main">$</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_0<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_eq_iff_index_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> di less_trans<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ x<span class="main"><span class="main"><span class="main">]</span></span></span> x<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="main">[</span>Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">G</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">G</span> <span class="main">!</span> <span class="skolem">i</span> <span class="keyword1">then</span> <span class="skolem">v</span> <span class="main">$</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_0<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> nth_eq_iff_index_eq<span class="main">[</span><span class="operator">OF</span> di _ x<span class="main">]</span> len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> i<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="free">G</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> lin_dep_crit<span class="main">[</span><span class="operator">OF</span> finite_set subset_refl TrueI inG this f<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lin_dep <span class="main">(</span>set <span class="free">G</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> li <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> det0<span class="main">:</span><span class="quoted"><span class="quoted">"det <span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">G</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> det_transpose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M_car1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-lin_indpt_list_add_vec"><span class="command">lemma</span></span> lin_indpt_list_add_vec<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>  
      i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> indep<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_indpt_list  <span class="free">us</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lin_indpt_list <span class="main">(</span><span class="free">us</span> <span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">us</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">us</span> <span class="main">!</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"lin_indpt_list <span class="var">?V</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> indep<span class="main">[</span><span class="operator">unfolded</span> lin_indpt_list_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">us</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">us</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> indep<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_indpt <span class="main">(</span>set <span class="free">us</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?E</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="free">us</span> <span class="main">-</span> <span class="main">{</span><span class="free">us</span> <span class="main">!</span> <span class="free">i</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?us</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span><span class="free">us</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="var">?E</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">us</span> <span class="main">!</span> <span class="free">j</span>"</span></span>     
  <span class="keyword1"><span class="command">from</span></span> us i <span class="keyword1"><span class="command">have</span></span> usi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∉</span> <span class="var">?E</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> usj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> usi usj <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">us</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">us</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>set <span class="free">us</span> <span class="main">-</span> <span class="main">{</span><span class="free">us</span> <span class="main">!</span> <span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dist i <span class="keyword1"><span class="command">have</span></span> diff'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≠</span> <span class="free">us</span> <span class="main">!</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> distinct_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> subset_li_is_li<span class="main">[</span><span class="operator">OF</span> indep<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> indepE<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_indpt <span class="var">?E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Vid<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="var">?V</span> <span class="main">=</span> insert <span class="var">?v</span> <span class="var">?E</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_update_distinct<span class="main">[</span><span class="operator">OF</span> dist i<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?E</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> us <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="var">?V</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> us v <span class="keyword1"><span class="command">unfolding</span></span> Vid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dist i <span class="keyword1"><span class="command">have</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≠</span> <span class="free">us</span> <span class="main">!</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> distinct_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> vspan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">∉</span> span <span class="var">?E</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">∈</span> span <span class="var">?E</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> diff i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∈</span> <span class="var">?E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∈</span> span <span class="var">?E</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> span_mem<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">us</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∈</span> span <span class="var">?E</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> smult_in_span<span class="main">[</span><span class="operator">OF</span> E<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> span_add1<span class="main">[</span><span class="operator">OF</span> E mem this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">us</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> span <span class="var">?E</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">us</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">us</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> usi usj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> span <span class="var">?E</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> in_spanE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> lc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> lincomb <span class="skolem">a</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> set <span class="free">us</span> <span class="main">-</span> <span class="main">{</span><span class="free">us</span> <span class="main">!</span> <span class="free">i</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">(</span><span class="free">us</span> <span class="main">!</span> <span class="free">i</span> <span class="main">:=</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span><span class="free">us</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">A</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> lc<span class="main">:</span> <span class="quoted"><span class="quoted">"lincomb <span class="var">?a</span> <span class="skolem">A</span> <span class="main">=</span> <span class="free">us</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lc
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lincomb_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A us lc<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lincomb <span class="var">?a</span> <span class="var">?A</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lincomb_insert2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A us lc usi diff<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> not_lindepD<span class="main">[</span><span class="operator">OF</span> indep _ _ _ this<span class="main">]</span> A usi 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> vmem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">∉</span> <span class="var">?E</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> span_mem<span class="main">[</span><span class="operator">OF</span> E<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> lin_dep_iff_in_span<span class="main">[</span><span class="operator">OF</span> E indepE v this<span class="main">]</span> vspan 
  <span class="keyword1"><span class="command">have</span></span> indep1<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_indpt <span class="main">(</span>set <span class="var">?V</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Vid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> vmem dist <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="var">?V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct_list_update<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> indep1 V <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lin_indpt_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-scalar_prod_lincomb_orthogonal"><span class="command">lemma</span></span> scalar_prod_lincomb_orthogonal<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> ortho<span class="main">:</span> <span class="quoted"><span class="quoted">"orthogonal <span class="free">gs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">gs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">gs</span> <span class="main">⟹</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">k</span><span class="main">]</span><span class="main">)</span> <span class="main">∙</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">h</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">k</span><span class="main">]</span><span class="main">)</span>
  <span class="main">=</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">h</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∙</span> <span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">k</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ortho <span class="main">=</span> orthogonalD<span class="main">[</span><span class="operator">OF</span> ortho<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">gs</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> gs Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> gsi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> kn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="var">?m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="skolem">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">gs</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">h</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">h</span> <span class="skolem">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">gs</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">k</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?v1</span> <span class="main">+</span> <span class="var">?v2</span>"</span></span>
     <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">h</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?w1</span> <span class="main">+</span> <span class="var">?w2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> id map_append
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v1</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sumlist_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v2</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> w1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?w1</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sumlist_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> w2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?w2</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> gsk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gs</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> v12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v1</span> <span class="main">+</span> <span class="var">?v2</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v1 v2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> w12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?w1</span> <span class="main">+</span> <span class="var">?w2</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> w1 w2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">g</span> <span class="bound">h</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">g</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">gs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="bound">h</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">gs</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> scalar_prod_smult_distrib<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ gsk<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">insert</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">subst</span> smult_scalar_prod_distrib<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ gsk<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">insert</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ortho<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v1</span> <span class="main">∙</span> <span class="var">?w2</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> scalar_prod_left_sum_distrib<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ w2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">insert</span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum_list_neutral<span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">insert</span> 0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>   
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v2</span> <span class="main">∙</span> <span class="var">?w1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> comm_scalar_prod<span class="main">[</span><span class="operator">OF</span> v2 w1<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> scalar_prod_left_sum_distrib<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ v2<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">insert</span> gs<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_neutral<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> 0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id
    <span class="keyword1"><span class="command">unfolding</span></span> scalar_prod_add_distrib<span class="main">[</span><span class="operator">OF</span> v12 w1 w2<span class="main">]</span>
      add_scalar_prod_distrib<span class="main">[</span><span class="operator">OF</span> v1 v2 w1<span class="main">]</span>
      add_scalar_prod_distrib<span class="main">[</span><span class="operator">OF</span> v1 v2 w2<span class="main">]</span>
      scalar_prod_smult_distrib<span class="main">[</span><span class="operator">OF</span> w2 gsk<span class="main">]</span>
      smult_scalar_prod_distrib<span class="main">[</span><span class="operator">OF</span> gsk gsk<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> kn<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 2 comm_scalar_prod<span class="main"><span class="main">[</span></span><span class="operator">OF</span> v2 w1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> gram_schmidt <span class="main">=</span> cof_vec_space <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">f_ty</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f_ty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>trivial_conjugatable_linordered_field<span class="main">}</span> itself"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Gramian_matrix</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Gramian_matrix</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">M</span> <span class="main">=</span> mat <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span> <span class="keyword1">in</span> <span class="bound">M</span> <span class="main">*</span> <span class="bound">M</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_2-Gramian_matrix_alt_def"><span class="command">lemma</span></span> Gramian_matrix_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">G</span> <span class="main">⟹</span> 
  Gramian_matrix <span class="free">G</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">M</span> <span class="main">=</span> mat_of_rows <span class="free">n</span> <span class="main">(</span>take <span class="free">k</span> <span class="free">G</span><span class="main">)</span> <span class="keyword1">in</span> <span class="bound">M</span> <span class="main">*</span> <span class="bound">M</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Gramian_matrix_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> mat_of_rows_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Gramian_determinant</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Gramian_determinant</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> det <span class="main">(</span>Gramian_matrix <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_2-Gramian_determinant_0"><span class="command">lemma</span></span> Gramian_determinant_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Gramian_determinant <span class="free">G</span> <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Gramian_determinant_def Gramian_matrix_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_mat_def<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-orthogonal_imp_lin_indpt_list"><span class="command">lemma</span></span> orthogonal_imp_lin_indpt_list<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> ortho<span class="main">:</span> <span class="quoted"><span class="quoted">"orthogonal <span class="free">gs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">gs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lin_indpt_list <span class="free">gs</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> corthogonal_distinct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">gs</span></span><span class="main">]</span> ortho <span class="keyword1"><span class="command">have</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">gs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lin_indpt_list_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI gs dist finite_lin_indpt2 finite_set<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">lc</span>
    <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"lincomb <span class="skolem">lc</span> <span class="main">(</span>set <span class="free">gs</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lc</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> lc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lc</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lincomb_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gs<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">gs</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> 0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="var">?lc</span> <span class="main">∙</span> <span class="var">?lc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lc</span> <span class="main">=</span> lincomb_list <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">lc</span> <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">gs</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> lincomb_as_lincomb_list_distinct<span class="main">[</span><span class="operator">OF</span> gs dist<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">lc</span> <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> <span class="var">?m</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> lincomb_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∙</span> <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="var">?m</span><span class="main">]</span><span class="main">.</span> <span class="main">(</span><span class="skolem">lc</span> <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">lc</span> <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> sq_norm <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> sum_list <span class="var">?sum</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> scalar_prod_lincomb_orthogonal<span class="main">[</span><span class="operator">OF</span> ortho gs le_refl<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod power2_eq_square<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> sum_0<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_list <span class="var">?sum</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">have</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="var">?sum</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> zero_le_square<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">lc</span> <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">i</span><span class="main">]</span> sq_norm_vec_ge_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">gs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">i</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">gs</span>"</span></span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">gs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lc</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">lc</span> <span class="skolem">x</span> <span class="main">*</span> sq_norm <span class="skolem">x</span> <span class="main">∈</span> set <span class="var">?sum</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> sum_list_nonneg_eq_0_iff<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?sum</span></span></span><span class="main">,</span> <span class="operator">OF</span> nonneg<span class="main">]</span> sum_0 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lc</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> sq_norm <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> orthogonalD<span class="main">[</span><span class="operator">OF</span> ortho<span class="main">,</span> <span class="operator">OF</span> i i<span class="main">,</span> <span class="operator">folded</span> x<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lc</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">∈</span>set <span class="free">gs</span><span class="main">.</span> <span class="skolem">lc</span> <span class="bound">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-orthocompl_span"><span class="command">lemma</span></span> orthocompl_span<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> span <span class="free">S</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∙</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">A</span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> lincomb <span class="skolem">a</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
   <span class="keyword1"><span class="command">note</span></span> assms <span class="main">=</span> assms this
   <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"lincomb <span class="skolem">a</span> <span class="skolem">A</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">→</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="main">(</span><span class="skolem">a</span> <span class="bound">x</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">∙</span> <span class="free">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">note</span></span> assms <span class="main">=</span> assms this
     <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∙</span> <span class="free">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> comm_scalar_prod<span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="skolem">x</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> <span class="free">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> smult_scalar_prod_distrib<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∙</span> lincomb <span class="skolem">a</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> comm_scalar_prod<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lincomb_def
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> finsum_scalar_prod_sum<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∈</span> span <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> span_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-orthogonal_sumlist"><span class="command">lemma</span></span> orthogonal_sumlist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ortho<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">S</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">S</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∙</span> sumlist <span class="free">S</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orthocompl_span<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ortho S v sumlist_in_span<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S span_mem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-oc_projection_alt_def"><span class="command">lemma</span></span> oc_projection_alt_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> carr<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">W</span><span class="main">::</span><span class="tfree">'a</span> vec set<span class="main">)</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> alt1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">y1</span> <span class="main">∈</span> <span class="free">W</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">-</span> <span class="free">y1</span> <span class="main">∈</span> orthogonal_complement <span class="free">W</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> alt2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">y2</span> <span class="main">∈</span> <span class="free">W</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">-</span> <span class="free">y2</span> <span class="main">∈</span> orthogonal_complement <span class="free">W</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">y1</span> <span class="main">=</span> <span class="free">y2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> carr<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">y1</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y2</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">y1</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alt1 alt2 carr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y1</span> <span class="main">-</span> <span class="free">y2</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> carr <span class="main">=</span> this carr
  <span class="keyword1"><span class="command">from</span></span> alt1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ya</span><span class="main">∈</span><span class="free">W</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y1</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">ya</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ya</span>
    <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_complement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y1</span><span class="main">)</span> <span class="main">∙</span> <span class="free">y2</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y1</span><span class="main">)</span> <span class="main">∙</span> <span class="free">y1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> alt2 alt1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> eq1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">y1</span> <span class="main">∙</span> <span class="free">y2</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∙</span> <span class="free">y2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y1</span> <span class="main">∙</span> <span class="free">y1</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∙</span> <span class="free">y1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> carr minus_scalar_prod_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">y2</span> <span class="main">∙</span> <span class="free">y1</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∙</span> <span class="free">y2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> carr comm_scalar_prod <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> alt2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ya</span><span class="main">∈</span><span class="free">W</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y2</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">ya</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ya</span>
    <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_complement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y2</span><span class="main">)</span> <span class="main">∙</span> <span class="free">y1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y2</span><span class="main">)</span> <span class="main">∙</span> <span class="free">y2</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> alt2 alt1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> eq3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">y2</span> <span class="main">∙</span> <span class="free">y2</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∙</span> <span class="free">y2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y2</span> <span class="main">∙</span> <span class="free">y1</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∙</span> <span class="free">y1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> carr minus_scalar_prod_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> eq2 <span class="keyword1"><span class="command">have</span></span> eq4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∙</span> <span class="free">y1</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∙</span> <span class="free">y2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="main">(</span><span class="free">y1</span> <span class="main">-</span> <span class="free">y2</span><span class="main">)</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_vec_as_cscalar_prod cscalar_prod_is_scalar_prod <span class="keyword1"><span class="command">using</span></span> carr
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> minus_scalar_prod_distrib<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>0 0<span class="main"><span class="main">)</span></span> scalar_prod_minus_distrib<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eq1 eq2 eq3 eq4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> sq_norm_vec_eq_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y1</span> <span class="main">-</span> <span class="free">y2</span><span class="main">)</span>"</span></span><span class="main">]</span> carr <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y1</span> <span class="main">-</span> <span class="free">y2</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y1</span> <span class="main">-</span> <span class="free">y2</span> <span class="main">+</span> <span class="free">y2</span> <span class="main">=</span> <span class="free">y2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> carr <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y1</span> <span class="main">-</span> <span class="free">y2</span> <span class="main">+</span> <span class="free">y2</span> <span class="main">=</span> <span class="free">y1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> carr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">y1</span> <span class="main">=</span> <span class="free">y2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_oc_projection</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∈</span> carrier_vec <span class="free">n</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∈</span> span <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∙</span> <span class="bound">u</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_2-is_oc_projection_sq_norm"><span class="command">lemma</span></span> is_oc_projection_sq_norm<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_oc_projection <span class="free">w</span> <span class="free">S</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sq_norm <span class="free">w</span> <span class="main">≤</span> sq_norm <span class="free">v</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> is_oc_projection_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> vw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">-</span> <span class="free">w</span> <span class="main">∈</span> span <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ortho<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">∙</span> <span class="bound">u</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sq_norm <span class="free">v</span> <span class="main">=</span> sq_norm <span class="main">(</span><span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v w 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">sq_norm_vec</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_vec_as_cscalar_prod
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span> <span class="main">∙</span> <span class="main">(</span><span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_scalar_prod_distrib<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> v w<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span> <span class="main">∙</span> <span class="free">w</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">w</span> <span class="main">∙</span> <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span> <span class="main">∙</span> <span class="free">w</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> scalar_prod_add_distrib<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> v w<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sq_norm <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">w</span> <span class="main">∙</span> <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> sq_norm <span class="free">w</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_vec_as_cscalar_prod <span class="keyword1"><span class="command">using</span></span> v w <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comm_scalar_prod<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">-</span> <span class="free">w</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">w</span> <span class="main">∙</span> <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> sq_norm <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_vec_ge_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">-</span> <span class="free">w</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∙</span> <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> orthocompl_span<span class="main">[</span><span class="operator">OF</span> ortho S w vw<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">oc_projection</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">oc_projection</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">v</span><span class="main">.</span> is_oc_projection <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_2-inv_in_span"><span class="command">lemma</span></span> inv_in_span<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> incarr<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> insp<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> span <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">a</span> <span class="main">∈</span> span <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> insp<span class="main">[</span><span class="operator">THEN</span> in_spanE<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">aa</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> lincomb <span class="skolem">aa</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">aa</span> <span class="bound">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">→</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> a<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> e1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">a</span> <span class="main">=</span> lincomb <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">-</span> <span class="main">1</span> <span class="main">*</span> <span class="skolem">aa</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> smult_smult_assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> lincomb_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> finsum_smult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> e1 a span_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-non_span_det_zero"><span class="command">lemma</span></span> non_span_det_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">G</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nonb<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>carrier_vec <span class="free">n</span> <span class="main">⊆</span> span <span class="main">(</span>set <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> carr<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="free">G</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> det_0_iff_vec_prod_zero
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">G</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> carr <span class="keyword1"><span class="command">have</span></span> carr_mat<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"mat_of_rows <span class="free">n</span> <span class="free">G</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len mat_of_rows_carrier<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> carr <span class="keyword1"><span class="command">have</span></span> g_len<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">G</span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> nonb <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> span <span class="main">(</span>set <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> span_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> gj<span class="main">:</span><span class="quoted"><span class="quoted">"gauss_jordan <span class="var">?A</span> <span class="var">?B</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">B</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">note</span></span> gj <span class="main">=</span> carr_mat<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> gj
  <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> fst <span class="main">(</span>gauss_jordan <span class="var">?A</span> <span class="var">?B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> gauss_jordan<span class="main">[</span><span class="operator">OF</span> gj<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> BC<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> gauss_jordan_transform<span class="main">[</span><span class="operator">OF</span> gj<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   P<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">P</span><span class="main">∈</span>Units <span class="main">(</span>ring_mat <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="free">n</span> <span class="var">?B</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">*</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">hence</span></span> PC<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Units_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_mat_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> mat_inverse<span class="main">[</span><span class="operator">OF</span> PC<span class="main">]</span> P <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">PI</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"mat_inverse <span class="skolem">P</span> <span class="main">=</span> Some <span class="skolem">PI</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> mat_inverse<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> PC this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> PI<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">*</span> <span class="skolem">PI</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">PI</span> <span class="main">*</span> <span class="skolem">P</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">PI</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">*</span> <span class="skolem">P</span> <span class="main">=</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> P
      <span class="keyword1"><span class="command">using</span></span> PC P<span class="main">(</span>2<span class="main">)</span> carr_mat<span class="main">(</span>1<span class="main">)</span> mat_mult_left_right_inverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">*</span> <span class="skolem">P</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> assoc_mult_mat_vec<span class="main">[</span><span class="operator">OF</span> carr_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> PC v<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> v_eq<span class="main">:</span><span class="quoted"><span class="quoted">"mat_of_cols <span class="free">n</span> <span class="free">G</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> transpose_mat_of_rows <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> pvc<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">∈</span> carrier_vec <span class="main">(</span>length <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PC v len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> mat_of_cols_mult_as_finsum<span class="main">[</span><span class="operator">OF</span> pvc g_len<span class="main">,</span><span class="operator">unfolded</span> v_eq<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> lincomb <span class="skolem">a</span> <span class="main">(</span>set <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> span <span class="main">(</span>set <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> in_spanI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_set subset_refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> det_non_zero_imp_unit<span class="main">[</span><span class="operator">OF</span> carr_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gauss_jordan_check_invertable<span class="main">[</span><span class="operator">OF</span> carr_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> B det_transpose<span class="main">[</span><span class="operator">OF</span> carr_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-span_basis_det_zero_iff"><span class="command">lemma</span></span> span_basis_det_zero_iff<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">G</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">G</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"carrier_vec <span class="free">n</span> <span class="main">⊆</span> span <span class="main">(</span>set <span class="free">G</span><span class="main">)</span> <span class="main">⟷</span> det <span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">G</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?q1</span></span></span><span class="main">)</span>
      <span class="quoted"><span class="quoted">"carrier_vec <span class="free">n</span> <span class="main">⊆</span> span <span class="main">(</span>set <span class="free">G</span><span class="main">)</span> <span class="main">⟷</span> basis <span class="main">(</span>set <span class="free">G</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?q2</span></span></span><span class="main">)</span>
      <span class="quoted"><span class="quoted">"det <span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">G</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟷</span> basis <span class="main">(</span>set <span class="free">G</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?q3</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> dc<span class="main">:</span><span class="quoted"><span class="quoted">"det <span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">G</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> carrier_vec <span class="free">n</span> <span class="main">⊆</span> span <span class="main">(</span>set <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms non_span_det_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> cb<span class="main">:</span><span class="quoted"><span class="quoted">"carrier_vec <span class="free">n</span> <span class="main">⊆</span> span <span class="main">(</span>set <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> basis <span class="main">(</span>set <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms basis_list_basis 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> basis_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> bd<span class="main">:</span><span class="quoted"><span class="quoted">"basis <span class="main">(</span>set <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> det <span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">G</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms basis_det_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?q1</span></span></span> <span class="var"><span class="quoted"><span class="var">?q2</span></span></span> <span class="var"><span class="quoted"><span class="var">?q3</span></span></span> <span class="keyword1"><span class="command">using</span></span> dc cb bd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-lin_indpt_list_nonzero"><span class="command">lemma</span></span> lin_indpt_list_nonzero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lin_indpt_list <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span> <span class="main">∉</span> set <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> lin_indpt_list_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lin_indpt <span class="main">(</span>set <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> vs_zero_lin_dep<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span> assms<span class="main">[</span><span class="operator">unfolded</span> lin_indpt_list_def<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span> <span class="main">∉</span> set <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-is_oc_projection_eq"><span class="command">lemma</span></span> is_oc_projection_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ispr<span class="main">:</span><span class="quoted"><span class="quoted">"is_oc_projection <span class="free">a</span> <span class="free">S</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"is_oc_projection <span class="free">b</span> <span class="free">S</span> <span class="free">v</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> carr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> carr <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span><span class="quoted"><span class="quoted">"span <span class="free">S</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">-</span> <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> carr ispr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">-</span> <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> carr ispr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> oc_projection_alt_def<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ispr a b <span class="keyword1"><span class="command">unfolding</span></span> in_orthogonal_complement_span<span class="main">[</span><span class="operator">OF</span> carr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> orthogonal_complement_def is_oc_projection_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">-</span> <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span> <span class="main">-</span> <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> a b<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">fun</span></span> <span class="entity">adjuster_wit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> vec <span class="main">⇒</span> <span class="tfree">'a</span> vec list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">adjuster_wit</span> <span class="free"><span class="bound"><span class="entity">wits</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">wits</span></span></span><span class="main">,</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free">adjuster_wit</span> <span class="free"><span class="bound"><span class="entity">wits</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">/</span> sq_norm <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">in</span> 
            <span class="keyword1">case</span> <span class="free">adjuster_wit</span> <span class="main">(</span><span class="bound">a</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">wits</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">wit</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span>
         <span class="main">⇒</span> <span class="main">(</span><span class="bound">wit</span><span class="main">,</span> <span class="main">-</span><span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">+</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sub2_wit</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">sub2_wit</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sub2_wit</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">case</span> adjuster_wit <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">wit</span><span class="main">,</span><span class="bound">aw</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">u</span> <span class="main">=</span> <span class="bound">aw</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">case</span> <span class="free">sub2_wit</span> <span class="main">(</span><span class="bound">u</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">wits</span><span class="main">,</span> <span class="bound">vvs</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">wit</span> <span class="main">#</span> <span class="bound">wits</span><span class="main">,</span> <span class="bound">u</span> <span class="main">#</span> <span class="bound">vvs</span><span class="main">)</span><span class="main">)</span>"</span></span>  
    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">main</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec list <span class="main">⇒</span> <span class="tfree">'a</span> list list <span class="main">×</span> <span class="tfree">'a</span> vec list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">main</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">=</span> sub2_wit <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> gram_schmidt_fs <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>trivial_conjugatable_linordered_field<span class="main">}</span> vec list"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> gram_schmidt <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gso</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">μ</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gso</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">-</span> <span class="free">μ</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">gso</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∙</span> <span class="free">gso</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">/</span> sq_norm <span class="main">(</span><span class="free">gso</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
    
<span class="keyword1"><span class="command">declare</span></span> gso.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> μ.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="keyword1" id="Gram_Schmidt_2-gso_carrier'"><span class="command">lemma</span></span> gso_carrier'<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gso <span class="free">j</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> gso.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sumlist_carrier add_carrier_vec<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-adjuster_wit"><span class="command">lemma</span></span> adjuster_wit<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"adjuster_wit <span class="free">wits</span> <span class="free">w</span> <span class="free">us</span> <span class="main">=</span> <span class="main">(</span><span class="free">wits'</span><span class="main">,</span><span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> us_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">=</span> map gso <span class="main">(</span>rev <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> wits<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wits</span> <span class="main">=</span> map <span class="main">(</span>μ <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">]</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> wi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adjuster <span class="free">n</span> <span class="free">w</span> <span class="free">us</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">∈</span> carrier_vec <span class="free">n</span> <span class="main">∧</span> <span class="free">wits'</span> <span class="main">=</span> map <span class="main">(</span>μ <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">]</span> <span class="main">∧</span>
      <span class="main">(</span><span class="free">a</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> res us us_gs wits j
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">wits</span></span> <span class="quoted"><span class="free">wits'</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">u</span> <span class="skolem">us</span> <span class="skolem">wits</span> <span class="skolem">wits'</span> <span class="skolem">a</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> us_gs <span class="main">=</span> Cons<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> wits <span class="main">=</span> Cons<span class="main">(</span>5<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> jn <span class="main">=</span> Cons<span class="main">(</span>6-7<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> us_gs <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">jj</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">jj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> jn j <span class="keyword1"><span class="command">have</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> zj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">jj</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">jj</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> jjn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">jj</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">jj</span> <span class="main">#</span> <span class="main">[</span><span class="skolem">j</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jj <span class="keyword1"><span class="command">unfolding</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> upt_conv_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> us_gs<span class="main">[</span><span class="operator">unfolded</span> zj<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ugs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> gso <span class="skolem">jj</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">=</span> map gso <span class="main">(</span>rev <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">jj</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∙</span> <span class="skolem">u</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">∙</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> muij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="main">=</span> μ <span class="free">i</span> <span class="skolem">jj</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> μ.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">jj</span></span><span class="main">]</span> ugs wi sq_norm_vec_as_cscalar_prod <span class="keyword1"><span class="command">using</span></span> jj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> wwits<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="main">#</span> <span class="skolem">wits</span> <span class="main">=</span> map <span class="main">(</span>μ <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="skolem">jj</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> jjn wits muij <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wwits</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"adjuster_wit <span class="main">(</span><span class="var">?w</span> <span class="main">#</span> <span class="skolem">wits</span><span class="main">)</span> <span class="free">w</span> <span class="skolem">us</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">wwits</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this Cons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> us wwits jj<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span><span class="operator">unfolded</span> j<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> 
     <span class="quoted"><span class="quoted">"adjuster <span class="free">n</span> <span class="free">w</span> <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wwits</span> <span class="main">=</span> map <span class="main">(</span>μ <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">jj</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simplified</span><span class="main">,</span> <span class="operator">unfolded</span> Let_def rec split sq_norm_vec_as_cscalar_prod 
      cscalar_prod_is_scalar_prod<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wits'</span> <span class="main">=</span> <span class="skolem">wwits</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">-</span> <span class="var">?w</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">u</span> <span class="main">+</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"adjuster <span class="free">n</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>     
  <span class="keyword1"><span class="command">from</span></span> id IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> wits'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wits'</span> <span class="main">=</span>  map <span class="main">(</span>μ <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> carr<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
            <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">jj</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Cons j <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>gso_carrier'<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> u b a <span class="keyword1"><span class="command">have</span></span> ac<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span><span class="main">-</span><span class="var">?w</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="skolem">b</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="skolem">u</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span> ac exI conjI wits'<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> carr a IH zj muij ugs<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> map_append
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_append<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems j <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">using</span></span> b u ugs IH<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-sub2_wit"><span class="command">lemma</span></span> sub2_wit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">us</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ws</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">us</span> <span class="main">+</span> length <span class="free">ws</span> <span class="main">=</span> <span class="free">m</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">=</span> map gso <span class="main">(</span>rev <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub2_wit <span class="free">us</span> <span class="free">ws</span> <span class="main">=</span> <span class="main">(</span><span class="free">wits</span><span class="main">,</span><span class="free">vvs</span><span class="main">)</span> <span class="main">⟹</span> gram_schmidt_sub2 <span class="free">n</span> <span class="free">us</span> <span class="free">ws</span> <span class="main">=</span> <span class="free">vvs</span> 
    <span class="main">∧</span> <span class="free">vvs</span> <span class="main">=</span> map gso <span class="main">[</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">]</span> <span class="main">∧</span> <span class="free">wits</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> map <span class="main">(</span>μ <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-6<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">us</span></span> <span class="quoted"><span class="free">vvs</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">wits</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">w</span> <span class="skolem">ws</span> <span class="skolem">us</span> <span class="skolem">vs</span><span class="main">)</span>  
  <span class="keyword1"><span class="command">note</span></span> us <span class="main">=</span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> wws <span class="main">=</span> Cons<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> wsf' <span class="main">=</span> Cons<span class="main">(</span>6<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> us_gs <span class="main">=</span> Cons<span class="main">(</span>7<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wsf' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> i_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> upt_conv_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> mn <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> i_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> upt_conv_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wsf' i_m <span class="keyword1"><span class="command">have</span></span> wsf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">]</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> fiw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span>  <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> wws <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ws<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">ws</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> list<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>μ <span class="skolem">i</span><span class="main">)</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">..&lt;</span> <span class="skolem">i</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"adjuster_wit <span class="main">[]</span> <span class="skolem">w</span> <span class="skolem">us</span>"</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wit</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">wit</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wits'</span></span> <span class="skolem"><span class="skolem">vv</span></span> <span class="keyword2"><span class="keyword">where</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"sub2_wit <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="skolem">ws</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">wits'</span><span class="main">,</span><span class="skolem">vv</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>      
  <span class="keyword1"><span class="command">from</span></span> adjuster_wit<span class="main">[</span><span class="operator">OF</span> a w Cons<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> us_gs list<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> _ fiw<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> us wws <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> awus<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>  
     <span class="keyword2"><span class="keyword">and</span></span> aa<span class="main">:</span> <span class="quoted"><span class="quoted">"adjuster <span class="free">n</span> <span class="skolem">w</span> <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> aaa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="skolem">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span>  
     <span class="keyword2"><span class="keyword">and</span></span> wit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wit</span> <span class="main">=</span> map <span class="main">(</span>μ <span class="skolem">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> aw_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="skolem">w</span> <span class="main">=</span> gso <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gso.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> fiw aaa<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> aa<span class="main">(</span>2<span class="main">)</span> w <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> us_gs <span class="keyword1"><span class="command">have</span></span> us_gs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">us</span> <span class="main">=</span> map gso <span class="main">(</span>rev <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> gs awus ws _ wsf us_gs' Cons<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">]</span> Cons<span class="main">(</span>5<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"gram_schmidt_sub2 <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="skolem">ws</span> <span class="main">=</span> <span class="skolem">vv</span>"</span></span>  
    <span class="keyword2"><span class="keyword">and</span></span> vv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vv</span> <span class="main">=</span> map gso <span class="main">[</span>Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> wits'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wits'</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> map <span class="main">(</span>μ <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> gs a aa IH Cons<span class="main">(</span>5<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> gs_vs<span class="main">:</span> <span class="quoted"><span class="quoted">"gram_schmidt_sub2 <span class="free">n</span> <span class="skolem">us</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">#</span> <span class="skolem">ws</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">vv</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def snd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> sub2_wit.simps a split Let_def gs<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> wits<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wits</span> <span class="main">=</span> <span class="skolem">wit</span> <span class="main">#</span> <span class="skolem">wits'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> vs vv aw_gs <span class="keyword1"><span class="command">have</span></span> vs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> map gso <span class="main">[</span><span class="skolem">i</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> i_m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> gs_vs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wits wit wits' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> i_m<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  
<span class="keyword1" id="Gram_Schmidt_2-partial_connect"><span class="command">lemma</span></span> partial_connect<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">vs</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">us</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>main <span class="free">us</span><span class="main">)</span> <span class="main">=</span> <span class="free">vs</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">=</span> take <span class="free">k</span> <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gram_schmidt <span class="free">n</span> <span class="free">us</span> <span class="main">=</span> <span class="free">vs</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">=</span> map gso <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(!)</span> <span class="free">fs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span> <span class="main">=</span> take <span class="free">k</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> carr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> main_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gram_schmidt_sub2 <span class="free">n</span> <span class="main">[]</span> <span class="main">(</span>take <span class="free">k</span> <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">vvs</span> <span class="main">∧</span> <span class="skolem">vvs</span> <span class="main">=</span> map gso <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span> <span class="main">∧</span> <span class="skolem">wits</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> map <span class="main">(</span>μ <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vvs</span> <span class="main">=</span> snd <span class="main">(</span>sub2_wit <span class="main">[]</span> <span class="main">(</span>take <span class="free">k</span> <span class="free">fs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wits</span> <span class="main">=</span> fst <span class="main">(</span>sub2_wit <span class="main">[]</span> <span class="main">(</span>take <span class="free">k</span> <span class="free">fs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">vvs</span> <span class="skolem">wits</span>
    <span class="keyword1"><span class="command">using</span></span> assms that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sub2_wit<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms main_def
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gram_schmidt <span class="free">n</span> <span class="free">us</span> <span class="main">=</span> <span class="free">vs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">=</span> map gso <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gram_schmidt_code
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> main_def case_prod_beta'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-adjuster_wit_small"><span class="command">lemma</span></span> adjuster_wit_small<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>adjuster_wit <span class="free">v</span> <span class="free">a</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x1</span><span class="main">,</span><span class="free">x2</span><span class="main">)</span>
  <span class="main">⟷</span> <span class="main">(</span>fst <span class="main">(</span>adjuster_wit <span class="free">v</span> <span class="free">a</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">x1</span> <span class="main">∧</span> <span class="free">x2</span> <span class="main">=</span> adjuster <span class="free">n</span> <span class="free">a</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">x1</span></span> <span class="quoted"><span class="free">x2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>Let_def sq_norm_vec_as_cscalar_prod <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>prod.splits<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-sub2"><span class="command">lemma</span></span> sub2<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">@</span> snd <span class="main">(</span>sub2_wit <span class="free">xs</span> <span class="free">us</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">(</span>gram_schmidt_sub <span class="free">n</span> <span class="free">xs</span> <span class="free">us</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sub2_wit <span class="skolem">xs</span> <span class="skolem">us</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">⟹</span> rev <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">x2</span> <span class="main">=</span> rev <span class="main">(</span>gram_schmidt_sub <span class="free">n</span> <span class="skolem">xs</span> <span class="skolem">us</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x1</span> <span class="skolem">x2</span> <span class="skolem">xs</span> <span class="skolem">us</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">x1</span></span> <span class="quoted"><span class="skolem">x2</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>Let_def rev_unsimp adjuster_wit_small <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>rev.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">us</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>Let_def rev_unsimp adjuster_wit_small <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>rev.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-gso_connect"><span class="command">lemma</span></span> gso_connect<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>main <span class="free">us</span><span class="main">)</span> <span class="main">=</span> gram_schmidt <span class="free">n</span> <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> main_def gram_schmidt_def
  <span class="keyword1"><span class="command">using</span></span> sub2<span class="main">[</span><span class="operator">of</span> <span class="quoted">Nil</span> <span class="quoted"><span class="free">us</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">weakly_reduced</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> 
  <span class="comment1">(* for k = n, this is reduced according to "Modern Computer Algebra" *)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">weakly_reduced</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">⟶</span> 
    sq_norm <span class="main">(</span>gso <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reduced</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> 
  <span class="comment1">(* this is reduced according to LLL original paper *)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduced</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span>weakly_reduced <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">⟶</span> abs <span class="main">(</span>μ <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* gram_schmidt_fs *)</span>


<span class="keyword1"><span class="command">locale</span></span> gram_schmidt_fs_Rn <span class="main">=</span> gram_schmidt_fs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">m</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≡</span> length <span class="free">fs</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">M</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> mat <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> μ <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_2-f_carrier"><span class="command">lemma</span></span> f_carrier<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m <span class="main">⟹</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> fs_carrier <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Gram_Schmidt_2-gso_carrier"><span class="command">lemma</span></span> gso_carrier<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m <span class="main">⟹</span> gso <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> gso_carrier' f_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-gso_dim"><span class="command">lemma</span></span> gso_dim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m <span class="main">⟹</span> dim_vec <span class="main">(</span>gso <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Gram_Schmidt_2-f_dim"><span class="command">lemma</span></span> f_dim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m <span class="main">⟹</span> dim_vec <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-fs0_gso0"><span class="command">lemma</span></span> fs0_gso0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> m <span class="main">⟹</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> gso <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> gso.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> f_dim<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_rec<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-fs_by_gso_def"><span class="command">lemma</span></span> fs_by_gso_def <span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> gso <span class="free">i</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ja</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">ja</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">ja</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">+</span> <span class="var">?sum</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ja</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">ja</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">ja</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> gso_carrier i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> M.sumlist_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ja</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">ja</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">ja</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> a this
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> sum_carrier <span class="main">=</span> this
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> sum_carrier<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gso <span class="free">i</span> <span class="main">+</span> <span class="var">?sum</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span> <span class="var">?sum</span> "</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">+</span> <span class="var">?minus_sum</span> <span class="main">+</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> gso.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?minus_sum</span> <span class="main">=</span> <span class="main">-</span> <span class="var">?sum</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gso_carrier i sum_carrier
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sumlist_nth sum_negf<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="var">?sum</span><span class="main">)</span> <span class="main">+</span> <span class="var">?sum</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_carrier fs_carrier f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt_2-main_connect"><span class="command">lemma</span></span> main_connect<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"m <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gram_schmidt <span class="free">n</span> <span class="free">fs</span> <span class="main">=</span> map gso <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>m<span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> snd_main<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>main <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gram_schmidt_sub2 <span class="free">n</span> <span class="main">[]</span> <span class="free">fs</span> <span class="main">=</span> snd <span class="main">(</span>sub2_wit <span class="main">[]</span> <span class="free">fs</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>sub2_wit <span class="main">[]</span> <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> map gso <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">fs</span><span class="main">]</span>
        <span class="main">∧</span> <span class="skolem">wits</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> map <span class="main">(</span>μ <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">fs</span><span class="main">]</span>"</span></span> 
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wits</span> <span class="main">=</span> fst <span class="main">(</span>sub2_wit <span class="main">[]</span> <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">wits</span>
    <span class="keyword1"><span class="command">using</span></span> assms that fs_carrier <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span>  sub2_wit<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_nth<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gram_schmidt_sub2 <span class="free">n</span> <span class="main">[]</span> <span class="free">fs</span> <span class="main">=</span> <span class="skolem">vs</span> <span class="main">∧</span> <span class="skolem">vs</span> <span class="main">=</span> map gso <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>m<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snd_main main_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"gram_schmidt <span class="free">n</span> <span class="free">fs</span> <span class="main">=</span> map gso <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>m<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gram_schmidt_code<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt_2-reduced_gso_E"><span class="command">lemma</span></span> reduced_gso_E<span class="main">:</span> <span class="quoted"><span class="quoted">"weakly_reduced <span class="free">α</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≤</span> m <span class="main">⟹</span> Suc <span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span> 
  sq_norm <span class="main">(</span>gso <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> weakly_reduced_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">FF</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">FF</span> <span class="main">≡</span> mat_of_rows <span class="free">n</span> <span class="free">fs</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">Fs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fs</span> <span class="main">≡</span> mat_of_rows <span class="free">n</span> <span class="main">(</span>map gso <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>m<span class="main">]</span><span class="main">)</span>"</span></span> 
  
<span class="keyword1" id="Gram_Schmidt_2-FF_dim"><span class="command">lemma</span></span> FF_dim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row FF <span class="main">=</span> m"</span></span> <span class="quoted"><span class="quoted">"dim_col FF <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"FF <span class="main">∈</span> carrier_mat m <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> mat_of_rows_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-Fs_dim"><span class="command">lemma</span></span> Fs_dim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row Fs <span class="main">=</span> m"</span></span> <span class="quoted"><span class="quoted">"dim_col Fs <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"Fs <span class="main">∈</span> carrier_mat m <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> mat_of_rows_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> main_connect<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-M_dim"><span class="command">lemma</span></span> M_dim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>M m<span class="main">)</span> <span class="main">=</span> m"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>M m<span class="main">)</span> <span class="main">=</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>M m<span class="main">)</span> <span class="main">∈</span> carrier_mat m m"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1" id="Gram_Schmidt_2-FF_index"><span class="command">lemma</span></span> FF_index<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> FF <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> mat_of_rows_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-M_index"><span class="command">lemma</span></span> M_index<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> m <span class="main">⟹</span> <span class="main">(</span>M m<span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">=</span> μ <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="comment1">(* equation 2 on page 463 of textbook *)</span>      
<span class="keyword1" id="Gram_Schmidt_2-matrix_equality"><span class="command">lemma</span></span> matrix_equality<span class="main">:</span> <span class="quoted"><span class="quoted">"FF <span class="main">=</span> <span class="main">(</span>M m<span class="main">)</span> <span class="main">*</span> Fs"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>M m<span class="main">)</span> <span class="main">*</span> Fs"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> dim<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row FF <span class="main">=</span> m"</span></span> <span class="quoted"><span class="quoted">"dim_col FF <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="var">?P</span> <span class="main">=</span> m"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="var">?P</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>M m<span class="main">)</span> <span class="main">=</span> m"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>M m<span class="main">)</span> <span class="main">=</span> m"</span></span> 
      <span class="quoted"><span class="quoted">"dim_row Fs <span class="main">=</span> m"</span></span> <span class="quoted"><span class="quoted">"dim_col Fs <span class="main">=</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mat_of_rows_def mat_of_rows_list_def main_connect<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">;</span></span> <span class="operator">unfold</span> dim<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> m"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> m<span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> m<span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_self_conv2 less_Suc_eq_le less_imp_add_positive upt_add_eq_append upt_rec zero_less_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?prod</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> μ <span class="skolem">i</span> <span class="bound">k</span> <span class="main">*</span> gso <span class="bound">k</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> dim2<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>col Fs <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> m"</span></span> <span class="keyword1"><span class="command">using</span></span> j dim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">idx</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> idx<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">idx</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> idx_def <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?vec</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="skolem">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> vec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?vec</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sumlist_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> idx gso_carrier i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> dimv<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="var">?vec</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> row <span class="main">(</span>M m<span class="main">)</span> <span class="skolem">i</span> <span class="main">∙</span> col Fs <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dim i j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>m<span class="main">.</span> row <span class="main">(</span>M m<span class="main">)</span> <span class="skolem">i</span> <span class="main">$</span> <span class="bound">k</span> <span class="main">*</span> col Fs <span class="skolem">j</span> <span class="main">$</span> <span class="bound">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> scalar_prod_def dim2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>m<span class="main">.</span> <span class="var">?prod</span> <span class="bound">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i j dim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mat_of_rows_list_def mat_of_rows_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="var">?prod</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> m<span class="main">]</span><span class="main">)</span>"</span></span>       
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_list_distinct_conv_sum_set<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="var">?prod</span> <span class="skolem">idx</span><span class="main">)</span> <span class="main">+</span> <span class="var">?prod</span> <span class="skolem">i</span> <span class="main">+</span> sum_list <span class="main">(</span>map <span class="var">?prod</span> <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> m<span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> split idx_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?prod</span> <span class="skolem">i</span> <span class="main">=</span> gso <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> μ.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">+</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">-</span> μ <span class="skolem">i</span> <span class="bound">k</span> <span class="main">*</span> gso <span class="bound">k</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gso.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> idx_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> index_add_vec<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> dimv<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> j<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sumlist_vec_index<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ j<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> idx gso_carrier i j<span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_cong<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">-</span> μ <span class="skolem">i</span> <span class="bound">k</span> <span class="main">*</span> gso <span class="bound">k</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> μ <span class="skolem">i</span> <span class="bound">k</span> <span class="main">*</span> gso <span class="bound">k</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">idx</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="var">?prod</span> <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> m<span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> μ.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> FF_index<span class="main">[</span><span class="operator">OF</span> i j<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"FF <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="var">?P</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Gram_Schmidt_2-fi_is_sum_of_mu_gso"><span class="command">lemma</span></span> fi_is_sum_of_mu_gso<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sumlist_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gso_carrier i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dim<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="var">?l</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> carrier_vecD<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> dim f_dim<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>     
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> m<span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Suc <span class="free">i</span> <span class="main">..&lt;</span> m<span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessI append.assoc append_same_eq less_imp_add_positive order_refl upt_add_eq_append zero_le<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?prod</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">k</span> <span class="main">*</span> gso <span class="bound">k</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">=</span> FF <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i j <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>M m<span class="main">)</span> <span class="main">*</span> Fs<span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> matrix_equality <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> row <span class="main">(</span>M m<span class="main">)</span> <span class="free">i</span> <span class="main">∙</span> col Fs <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>m<span class="main">.</span> row <span class="main">(</span>M m<span class="main">)</span> <span class="free">i</span> <span class="main">$</span> <span class="bound">k</span> <span class="main">*</span> col Fs <span class="skolem">j</span> <span class="main">$</span> <span class="bound">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> scalar_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>m<span class="main">.</span> <span class="var">?prod</span> <span class="bound">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i j dim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mat_of_rows_list_def mat_of_rows_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="var">?prod</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> m<span class="main">]</span><span class="main">)</span>"</span></span>       
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_list_distinct_conv_sum_set<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="var">?prod</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span> sum_list <span class="main">(</span>map <span class="var">?prod</span> <span class="main">[</span>Suc <span class="free">i</span> <span class="main">..&lt;</span> m<span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="var">?prod</span> <span class="main">[</span>Suc <span class="free">i</span> <span class="main">..&lt;</span> m<span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> μ.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="var">?prod</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?l</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_vec_index<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ j<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gso_carrier<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">sum_list</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i j<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?l</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-gi_is_fi_minus_sum_mu_gso"><span class="command">lemma</span></span> gi_is_fi_minus_sum_mu_gso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gso <span class="free">i</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">-</span> <span class="var">?sum</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sumlist_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gso_carrier i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs_by_gso_def<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gso_carrier<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">]</span></span> sum<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Theorem 16.5 (iv) *)</span>  
<span class="keyword1" id="Gram_Schmidt_2-det"><span class="command">lemma</span></span> det<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"m <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"det FF <span class="main">=</span> det Fs"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_equality
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> det_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M_dim<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">insert</span> Fs_dim<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> m<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> det_lower_triangular<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ M_dim<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> M_index<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> μ.simps<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> prod_list_diag_prod<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> μ.simps<span class="main">)</span> 
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> gram_schmidt_fs_lin_indpt <span class="main">=</span> gram_schmidt_fs_Rn <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lin_indpt<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_indpt <span class="main">(</span>set <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">fs</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> loc_assms <span class="main">=</span> lin_indpt dist

<span class="keyword1" id="Gram_Schmidt_2-mn"><span class="command">lemma</span></span> mn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"m <span class="main">≤</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> dim"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dim_is_n<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"m <span class="main">=</span> card <span class="main">(</span>set <span class="free">fs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct_card loc_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> m n <span class="keyword1"><span class="command">have</span></span> mn<span class="main">:</span> <span class="quoted"><span class="quoted">"m <span class="main">≤</span> <span class="free">n</span> <span class="main">⟷</span> card <span class="main">(</span>set <span class="free">fs</span><span class="main">)</span> <span class="main">≤</span> dim"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mn
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> li_le_dim<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> loc_assms fs_carrier <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> span_gso<span class="main">:</span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>m<span class="main">}</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>set <span class="free">fs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> orthogonal_gso<span class="main">:</span> <span class="quoted"><span class="quoted">"orthogonal <span class="main">(</span>map gso <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>m<span class="main">]</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> dist_gso<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map gso <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>m<span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gram_schmidt_result<span class="main">[</span><span class="operator">OF</span> fs_carrier _ _ main_connect<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">symmetric</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span><span class="main">]</span> loc_assms mn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-gso_inj"><span class="command">lemma</span></span> gso_inj<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on gso <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> assms'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"gso <span class="skolem">x</span> <span class="main">=</span> gso <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map gso <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>m<span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> length <span class="main">(</span>map gso <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>m<span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> length <span class="main">(</span>map gso <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>m<span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> dist_gso assms mn assms' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dist_gso<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> nth_eq_iff_index_eq<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> assms' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> inj_onI<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-partial_span"><span class="command">lemma</span></span> partial_span<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>set <span class="main">(</span>take <span class="free">i</span> <span class="free">fs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?us</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?us</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fs_carrier i <span class="keyword1"><span class="command">have</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="var">?us</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> set_take_subset subset_trans<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vi</span></span> <span class="keyword2"><span class="keyword">where</span></span> main<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>main <span class="var">?us</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">vi</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> dist <span class="keyword1"><span class="command">have</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> lin_indpt <span class="keyword1"><span class="command">have</span></span> indpt<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_indpt <span class="main">(</span>set <span class="var">?us</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> supset_ld_is_ld<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="var">?us</span>"</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="var">?us</span> <span class="main">@</span> drop <span class="free">i</span> <span class="free">fs</span><span class="main">)</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_take_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> partial_connect<span class="main">[</span><span class="operator">OF</span> _ i mn us main refl fs_carrier<span class="main">]</span> assms
  <span class="keyword1"><span class="command">have</span></span> gso<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vi</span> <span class="main">=</span> gram_schmidt <span class="free">n</span> <span class="var">?us</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vi</span> <span class="main">=</span> map gso <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> cof_vec_space.gram_schmidt_result<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> us dist indpt gso<span class="main">,</span> <span class="operator">unfolded</span> vi<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-partial_span'"><span class="command">lemma</span></span> partial_span'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> partial_span<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">span</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nth_image<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i loc_assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* Theorem 16.5 (iii) *)</span>
<span class="keyword1" id="Gram_Schmidt_2-orthogonal"><span class="command">lemma</span></span> orthogonal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gso <span class="free">i</span> <span class="main">∙</span> gso <span class="free">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms mn orthogonal_gso<span class="main">[</span><span class="operator">unfolded</span> orthogonal_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Theorem 16.5 (i) not in full general form *)</span>  
<span class="keyword1" id="Gram_Schmidt_2-same_base"><span class="command">lemma</span></span> same_base<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>set <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>m<span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> span_gso loc_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* Theorem 16.5 (ii), second half *)</span>
<span class="keyword1" id="Gram_Schmidt_2-sq_norm_gso_le_f"><span class="command">lemma</span></span> sq_norm_gso_le_f<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> sq_norm <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="free">i</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sum</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gsoi<span class="main">:</span> <span class="quoted"><span class="quoted">"gso <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sumlist_carrier gso_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fi_is_sum_of_mu_gso<span class="main">[</span><span class="operator">OF</span> i<span class="main">,</span> <span class="operator">unfolded</span> id<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> sq_norm <span class="main">(</span>sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>gso <span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> μ.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sq_norm <span class="main">(</span><span class="var">?sum</span> <span class="main">+</span> gso <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gso_carrier i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?sum</span> <span class="main">+</span> gso <span class="free">i</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="var">?sum</span> <span class="main">+</span> gso <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?sum</span> <span class="main">∙</span> <span class="main">(</span><span class="var">?sum</span> <span class="main">+</span> gso <span class="free">i</span><span class="main">)</span> <span class="main">+</span> gso <span class="free">i</span> <span class="main">∙</span> <span class="main">(</span><span class="var">?sum</span> <span class="main">+</span> gso <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_scalar_prod_distrib<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sum gsoi<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> sum gsoi<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?sum</span> <span class="main">∙</span> <span class="var">?sum</span> <span class="main">+</span> <span class="var">?sum</span> <span class="main">∙</span> gso <span class="free">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>gso <span class="free">i</span> <span class="main">∙</span> <span class="var">?sum</span> <span class="main">+</span> gso <span class="free">i</span> <span class="main">∙</span> gso <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> scalar_prod_add_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> sum gsoi<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">∙</span> <span class="var">?sum</span> <span class="main">=</span> sq_norm <span class="var">?sum</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gso <span class="free">i</span> <span class="main">∙</span> gso <span class="free">i</span> <span class="main">=</span> sq_norm <span class="main">(</span>gso <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gso <span class="free">i</span> <span class="main">∙</span> <span class="var">?sum</span> <span class="main">=</span> <span class="var">?sum</span> <span class="main">∙</span> gso <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gsoi sum <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comm_scalar_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> sq_norm <span class="var">?sum</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="var">?sum</span> <span class="main">∙</span> gso <span class="free">i</span><span class="main">)</span> <span class="main">+</span> sq_norm <span class="main">(</span>gso <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="var">?sum</span> <span class="main">∙</span> gso <span class="free">i</span><span class="main">)</span> <span class="main">+</span> sq_norm <span class="main">(</span>gso <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_vec_ge_0<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?sum</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">∙</span> gso <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">v</span><span class="main">←</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∙</span> gso <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> scalar_prod_left_sum_distrib<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ gsoi<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i gso_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>μ <span class="free">i</span> <span class="skolem">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="skolem">j</span><span class="main">)</span> <span class="main">∙</span> gso <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> j i <span class="keyword1"><span class="command">have</span></span> gsoj<span class="main">:</span> <span class="quoted"><span class="quoted">"gso <span class="skolem">j</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> μ <span class="free">i</span> <span class="skolem">j</span> <span class="main">*</span> <span class="main">(</span>gso <span class="skolem">j</span> <span class="main">∙</span> gso <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gsoi gsoj <span class="keyword1"><span class="command">unfolding</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gso <span class="skolem">j</span> <span class="main">∙</span> gso <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orthogonal<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j i assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Theorem 16.5 (ii), first half *)</span>
<span class="keyword1" id="Gram_Schmidt_2-oc_projection_exist"><span class="command">lemma</span></span> oc_projection_exist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> gso <span class="free">i</span> <span class="main">∈</span> span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> finA<span class="main">:</span><span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> carA<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gso_dim assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="free">v</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="bound">n</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">v</span> <span class="main">=</span> gso <span class="bound">n</span> <span class="keyword1">then</span> μ <span class="free">i</span> <span class="bound">n</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gso.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> gso_dim<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> carrier_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> f_carrier<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> gso_carrier<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> d
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="var">?a</span> <span class="bound">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">→</span> carrier_vec <span class="free">n</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> gso_carrier assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ia</span> <span class="keyword3"><span class="command">assume</span></span> ia<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="var">?a</span> <span class="bound">x</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">ia</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">ia</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_map comm_monoid_add_class.sum.reindex<span class="main">[</span><span class="operator">OF</span> gso_inj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> atLeastLessThan_upt sum_set_upt_conv_sum_list_nat uminus_sum_list_map o_def
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_cong<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> d<span class="main">:</span><span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="main">(</span>set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span>
              <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inj_on gso <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span>set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gso_inj<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> inj_on_filter_key_eq<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span><span class="operator">folded</span> replicate_count_mset_eq_filter_eq<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">n</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span> <span class="main">.</span> gso <span class="skolem">x</span> <span class="main">=</span> gso <span class="bound">n</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x assms d replicate.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">.</span> <span class="keyword1">if</span> gso <span class="skolem">x</span> <span class="main">=</span> gso <span class="bound">n</span> <span class="keyword1">then</span> μ <span class="free">i</span> <span class="bound">n</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> μ <span class="free">i</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> sum_list_map_filter'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> ia gso_dim x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> index_smult_vec<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="var">?a</span> <span class="bound">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">ia</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">-</span> local.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">ia</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d assms
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>0 0<span class="main"><span class="main">)</span></span> finsum_index index_uminus_vec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_vec_index<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span><span class="var">?A</span><span class="main">.</span> <span class="var">?a</span> <span class="bound">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d lincomb_dim<span class="main">[</span><span class="operator">OF</span> finA carA<span class="main">,</span><span class="operator">unfolded</span> lincomb_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> eq_vecI<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> gso <span class="free">i</span> <span class="main">=</span> lincomb <span class="var">?a</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lincomb_def gso.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> id
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-oc_projection_unique"><span class="command">lemma</span></span> oc_projection_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="free">v</span> <span class="main">∈</span> span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> gso <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> carr_span<span class="main">:</span><span class="quoted"><span class="quoted">"span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> span_is_subset2<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> carr<span class="main">:</span> <span class="quoted"><span class="quoted">"gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> orthocompl_span<span class="main">[</span><span class="operator">OF</span> _ carr<span class="main">]</span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∙</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> oc1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> orthogonal_complement <span class="main">(</span>span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> <span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eq orthogonal_complement_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">⟹</span> gso <span class="free">i</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> assms orthogonal <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> gso <span class="free">i</span> <span class="main">∙</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orthocompl_span<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> carr gso_carrier assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> oc2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> gso <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> orthogonal_complement <span class="main">(</span>span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> <span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eq orthogonal_complement_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> pe<span class="main">=</span> oc_projection_exist<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> prerec <span class="main">=</span> carr_span f_carrier<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>4<span class="main">)</span> oc1 oc_projection_exist<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> oc2
  <span class="keyword1"><span class="command">note</span></span> prerec <span class="main">=</span> carr_span f_carrier<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>4<span class="main">)</span> oc1 oc_projection_exist<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> oc2
  <span class="keyword1"><span class="command">have</span></span> gsoi<span class="main">:</span> <span class="quoted"><span class="quoted">"gso <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gso_carrier<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> m›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> f_carrier<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> m›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> arg_cong<span class="main">[</span><span class="operator">OF</span> oc_projection_alt_def<span class="main"><span class="main">[</span></span><span class="operator">OF</span> carr_span f_carrier<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> oc1 pe oc2<span class="main"><span class="main">]</span></span><span class="main">,</span> 
     <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="main">-</span> <span class="bound">v</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">j</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> gso <span class="free">i</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> eq_vecI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>gso <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">=</span> gso <span class="free">i</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms gsoi main<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms gsoi<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-gso_oc_projection"><span class="command">lemma</span></span> gso_oc_projection<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gso <span class="free">i</span> <span class="main">=</span> oc_projection <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> oc_projection_def is_oc_projection_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> some_equality<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span><span class="operator">OF</span> _ oc_projection_unique<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> orthogonal<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">xa</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> gso <span class="free">i</span> <span class="main">∙</span> gso <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orthogonal<span class="main"><span class="keyword3">,</span></span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gso <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span> <span class="main">∧</span>
        <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> gso <span class="free">i</span> <span class="main">∈</span> span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">⟶</span> gso <span class="free">i</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gso_carrier oc_projection_exist assms orthogonal <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-gso_oc_projection_span"><span class="command">lemma</span></span> gso_oc_projection_span<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gso <span class="free">i</span> <span class="main">=</span> oc_projection <span class="main">(</span>span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_oc_projection <span class="main">(</span>gso <span class="free">i</span><span class="main">)</span> <span class="main">(</span>span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> oc_projection_def is_oc_projection_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> some_equality<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span><span class="operator">OF</span> _ oc_projection_unique<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span> <span class="main">∧</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="bound">v</span> <span class="main">∈</span> span <span class="main">(</span>span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> carr<span class="main">:</span><span class="quoted"><span class="quoted">"gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">xa</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> gso <span class="free">i</span> <span class="main">∙</span> gso <span class="bound">xa</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orthogonal<span class="main"><span class="keyword3">,</span></span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> orthogonal<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> gso <span class="free">i</span> <span class="main">∙</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> orthocompl_span<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>gso <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>gso <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> span_span<span class="main">[</span><span class="operator">OF</span> carr<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> gso_carrier oc_projection_exist assms orthogonal <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="skolem">v</span> <span class="main">∈</span> span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> span_span<span class="main">[</span><span class="operator">OF</span> carr<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_own_span<span class="main">[</span><span class="operator">OF</span> carr<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∙</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-gso_is_oc_projection"><span class="command">lemma</span></span> gso_is_oc_projection<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_oc_projection <span class="main">(</span>gso <span class="free">i</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>take <span class="free">i</span> <span class="free">fs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free">i</span> <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> contra_subsetD fs_carrier in_set_takeD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> span <span class="main">(</span>set <span class="main">(</span>take <span class="free">i</span> <span class="free">fs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> partial_span<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms less_or_eq_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_oc_projection <span class="main">(</span>gso <span class="free">i</span><span class="main">)</span> <span class="main">(</span>span <span class="main">(</span>gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gso_oc_projection_span<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms less_or_eq_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_oc_projection <span class="main">(</span>gso <span class="free">i</span><span class="main">)</span> <span class="main">(</span>span <span class="main">(</span>set <span class="main">(</span>take <span class="free">i</span> <span class="free">fs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take <span class="free">i</span> <span class="free">fs</span><span class="main">)</span> <span class="main">⊆</span> span <span class="main">(</span>set <span class="main">(</span>take <span class="free">i</span> <span class="free">fs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> span_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_oc_projection_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> span_span<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-fi_scalar_prod_gso"><span class="command">lemma</span></span> fi_scalar_prod_gso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> gso <span class="free">j</span> <span class="main">=</span> μ <span class="free">i</span> <span class="free">j</span> <span class="main">*</span> <span class="main">∥</span>gso <span class="free">j</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> list1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> m<span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> Suc <span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Suc <span class="free">i</span> <span class="main">..&lt;</span> m<span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> j<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> j <span class="keyword1"><span class="command">have</span></span> list2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> m<span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Suc <span class="free">j</span> <span class="main">..&lt;</span> m<span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">k</span> <span class="main">-</span> <span class="free">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> gso <span class="free">j</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="var">?mu</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">∙</span> gso <span class="free">j</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> fi_is_sum_of_mu_gso<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">v</span><span class="main">←</span>map <span class="var">?mu</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∙</span> gso <span class="free">j</span><span class="main">)</span> <span class="main">+</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> scalar_prod_left_sum_distrib<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gso_carrier assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">v</span><span class="main">←</span>map <span class="var">?mu</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∙</span> gso <span class="free">j</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">v</span><span class="main">←</span>map <span class="var">?mu</span> <span class="main">[</span>Suc <span class="free">i</span><span class="main">..&lt;</span>m<span class="main">]</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∙</span> gso <span class="free">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sum_list_neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms gso_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> orthogonal <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> μ.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">v</span><span class="main">←</span>map <span class="var">?mu</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> m<span class="main">]</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∙</span> gso <span class="free">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> list1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">v</span><span class="main">←</span>map <span class="var">?mu</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∙</span> gso <span class="free">j</span><span class="main">)</span> <span class="main">+</span> <span class="var">?mu</span> <span class="free">j</span> <span class="main">∙</span> gso <span class="free">j</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">v</span><span class="main">←</span>map <span class="var">?mu</span> <span class="main">[</span>Suc <span class="free">j</span><span class="main">..&lt;</span> m<span class="main">]</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∙</span> gso <span class="free">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> list2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">v</span><span class="main">←</span>map <span class="var">?mu</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∙</span> gso <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms gso_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> orthogonal<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">v</span><span class="main">←</span>map <span class="var">?mu</span> <span class="main">[</span>Suc <span class="free">j</span><span class="main">..&lt;</span> m<span class="main">]</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∙</span> gso <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms gso_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> orthogonal<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu</span> <span class="free">j</span> <span class="main">∙</span> gso <span class="free">j</span> <span class="main">=</span> μ <span class="free">i</span> <span class="free">j</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="free">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> gso_carrier<span class="main">[</span><span class="operator">OF</span> j<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod<span class="main">)</span>  
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-gso_scalar_zero"><span class="command">lemma</span></span> gso_scalar_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gso <span class="free">k</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> comm_scalar_prod<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gso_carrier<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">subst</span> fi_scalar_prod_gso<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> μ.simps<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-scalar_prod_lincomb_gso"><span class="command">lemma</span></span> scalar_prod_lincomb_gso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">k</span><span class="main">]</span><span class="main">)</span> <span class="main">∙</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">h</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">k</span><span class="main">]</span><span class="main">)</span>
    <span class="main">=</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">h</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span>gso <span class="bound">i</span> <span class="main">∙</span> gso <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">k</span><span class="main">]</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> id1<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> map <span class="main">(</span>gso<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>m<span class="main">]</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">g</span> <span class="keyword1"><span class="command">using</span></span> k
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">h</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span>map <span class="main">(</span>gso<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>m<span class="main">]</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∙</span> map <span class="main">(</span>gso<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>m<span class="main">]</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">h</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span>gso <span class="bound">i</span> <span class="main">∙</span> gso <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_cong<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">gs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gs</span> <span class="main">=</span> map <span class="main">(</span>gso<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>m<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> gs_gso<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">gs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> gso <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">unfolding</span></span> gs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">)</span> <span class="main">∙</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">h</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">h</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">gs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∙</span> <span class="skolem">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gs_def <span class="keyword1"><span class="command">using</span></span>  assms  orthogonal_gso 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> scalar_prod_lincomb_orthogonal<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gs_gso <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">h</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">h</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gs_gso <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">h</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">gs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∙</span> <span class="skolem">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">h</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span>gso <span class="bound">i</span> <span class="main">∙</span> gso <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gs_gso <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-gso_times_self_is_norm"><span class="command">lemma</span></span> gso_times_self_is_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∙</span> gso <span class="free">j</span> <span class="main">=</span> sq_norm <span class="main">(</span>gso <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fi_scalar_prod_gso<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> μ.simps<span class="main">)</span>

<span class="comment1">(* Lemma 16.7 *)</span>
<span class="keyword1" id="Gram_Schmidt_2-gram_schmidt_short_vector"><span class="command">lemma</span></span> gram_schmidt_short_vector<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> in_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> lattice_of <span class="free">fs</span> <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> m<span class="main">.</span> <span class="main">∥</span><span class="free">h</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≥</span> <span class="main">∥</span>gso <span class="bound">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> in_L <span class="keyword1"><span class="command">have</span></span> non_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> in_L<span class="main">[</span><span class="operator">unfolded</span> lattice_of_def<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lam</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span>  sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">lam</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free">fs</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> in_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">lam</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> m<span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> length_map h
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">sumlist</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> map_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> m<span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">lam</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?vs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="var">?f</span> <span class="var">?n</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> m <span class="main">∧</span> <span class="skolem">lam</span> <span class="bound">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">kk</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">kk</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> m<span class="main">.</span> <span class="skolem">lam</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> vs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?vs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">)</span> <span class="var">?n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> f_dim *<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> in_L vs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sumlist_neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> non_0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">kk</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">kk</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> GreatestI_nat<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">m</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> Pk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
  <span class="keyword1"><span class="command">hence</span></span> kn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> m"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gso</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> μ <span class="bound">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="skolem">i</span> <span class="main">&lt;</span> m <span class="main">⟹</span> <span class="skolem">lam</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> Greatest_le_nat<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted">m</span><span class="main">,</span> <span class="operator">folded</span> k_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">lam</span> <span class="skolem">k</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> Pk <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> l_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">idx</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> idx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="skolem">idx</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="skolem">idx</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> m"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> idx_def <span class="keyword1"><span class="command">using</span></span> kn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Pk <span class="keyword1"><span class="command">have</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> m<span class="main">]</span> <span class="main">=</span> <span class="skolem">idx</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Suc <span class="skolem">k</span> <span class="main">..&lt;</span> m<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> idx_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_self_conv2 less_Suc_eq_le less_imp_add_positive upt_add_eq_append 
        upt_rec zero_less_Suc<span class="main">)</span>  
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">gg</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gg</span> <span class="main">=</span> sumlist 
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">lam</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span> <span class="main">+</span> of_int <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="skolem">k</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> sumlist <span class="var">?vs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> in_L <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sumlist <span class="main">(</span><span class="main">(</span>map <span class="var">?f</span> <span class="skolem">idx</span> <span class="main">@</span> <span class="main">[</span><span class="var">?f</span> <span class="skolem">k</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> map <span class="var">?f</span> <span class="main">[</span>Suc <span class="skolem">k</span> <span class="main">..&lt;</span> m<span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="var">?f</span> <span class="skolem">idx</span> <span class="main">@</span> <span class="main">[</span><span class="var">?f</span> <span class="skolem">k</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span> sumlist <span class="main">(</span>map <span class="var">?f</span> <span class="main">[</span>Suc <span class="skolem">k</span> <span class="main">..&lt;</span> m<span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sumlist_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> f_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Pk idx<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="var">?f</span> <span class="main">[</span>Suc <span class="skolem">k</span> <span class="main">..&lt;</span> m<span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sumlist_neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="var">?f</span> <span class="skolem">idx</span> <span class="main">@</span> <span class="main">[</span><span class="var">?f</span> <span class="skolem">k</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="var">?f</span> <span class="skolem">idx</span><span class="main">)</span> <span class="main">+</span> <span class="var">?f</span> <span class="skolem">k</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> f_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Pk idx<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="var">?gso</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fi_is_sum_of_mu_gso<span class="main">[</span><span class="operator">OF</span> kn<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="var">?gso</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">idx</span> <span class="main">@</span> <span class="main">[</span>gso <span class="skolem">k</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> μ.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="main">]</span></span> idx_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="var">?gso</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span> <span class="main">+</span> gso <span class="skolem">k</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> f_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Pk idx<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span><span class="skolem">lam</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">…</span> <span class="main">=</span> of_int <span class="main">(</span><span class="skolem">lam</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>sumlist <span class="main">(</span>map <span class="main">(</span><span class="var">?gso</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">+</span> of_int <span class="main">(</span><span class="skolem">lam</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="skolem">k</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> idx_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smult_add_distrib_vec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sumlist_carrier<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gso_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> kn<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="var">?f</span> <span class="skolem">idx</span><span class="main">)</span> <span class="main">+</span>
       <span class="main">(</span>of_int <span class="main">(</span><span class="skolem">lam</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="var">?gso</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span> <span class="main">+</span> of_int <span class="main">(</span><span class="skolem">lam</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span> "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">gg</span> <span class="main">+</span> of_int <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gg_def l_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> idx kn<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sumlist_vec_index<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">subst</span> index_add_vec<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sumlist_dim kn<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sumlist_dim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> hgg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="skolem">gg</span> <span class="main">+</span> of_int <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>      
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">]</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> <span class="main">{</span><span class="bound">gg</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">nu</span><span class="main">.</span> <span class="bound">gg</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">nu</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nu</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">nu</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sumlist_dim<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> kn<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> idx_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> dim_nu<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">kk</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">kk</span> <span class="main">=</span> <span class="var">?k</span>"</span></span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nu</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">nu</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="skolem">v</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gg_def v <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> dim_R <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v1</span> <span class="skolem">v2</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nu1</span></span> <span class="skolem"><span class="skolem">nu2</span></span> <span class="keyword2"><span class="keyword">where</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">nu1</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">nu2</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">+</span> <span class="skolem">v2</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> R_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">nu1</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">nu2</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> v1 v2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> 
        <span class="main">(</span><span class="operator">subst</span> sumlist_vec_index<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> idx<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gso_carrier <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">unfold</span> sum_list_addf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="skolem">idx</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> add_R <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gg</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gg_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> add_R<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"of_int <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="skolem">k</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> R_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> of_int <span class="skolem"><span class="skolem"><span class="skolem">l</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> μ <span class="skolem"><span class="skolem"><span class="skolem">k</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span>
       <span class="main">(</span><span class="operator">subst</span> sumlist_vec_index<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> idx<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gso_carrier <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> 
       <span class="operator">induct</span> <span class="quoted"><span class="skolem">idx</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="var">?f</span> <span class="skolem">idx</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> idx
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">idx</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">0</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span>
        <span class="main">(</span><span class="operator">subst</span> sumlist_vec_index<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> idx<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gso_carrier <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">induct</span> <span class="quoted"><span class="skolem">idx</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>      
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">i</span> <span class="skolem">idxs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="var">?f</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">#</span> <span class="skolem">idxs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sumlist <span class="main">(</span><span class="main">[</span><span class="var">?f</span> <span class="skolem">i</span><span class="main">]</span> <span class="main">@</span> map <span class="var">?f</span> <span class="skolem">idxs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">i</span> <span class="main">+</span> sumlist <span class="main">(</span>map <span class="var">?f</span> <span class="skolem">idxs</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Cons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> f_carrier<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="var">?f</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">#</span> <span class="skolem">idxs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">i</span> <span class="main">+</span> sumlist <span class="main">(</span>map <span class="var">?f</span> <span class="skolem">idxs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> add_R<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Cons<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2-3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> idx_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="skolem">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> idx_def 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessI append_Nil2 less_imp_add_positive upt_add_eq_append upt_rec zero_le<span class="main">)</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">idxs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idxs</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="skolem">i</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">&lt;</span> Suc <span class="skolem">i</span> <span class="keyword1">then</span> of_int <span class="main">(</span><span class="skolem">lam</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> μ <span class="skolem">i</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">x</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="skolem">idx</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="skolem">i</span><span class="main">]</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span> <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">]</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> idx_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span> <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">]</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j kn<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>          
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="skolem">i</span><span class="main">]</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="skolem">idxs</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">lam</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>μ <span class="skolem">i</span> <span class="bound">x</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">x</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> idxs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">sum_list</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
                <span class="operator">subst</span> index_smult_vec<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j i kn<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_int <span class="main">(</span><span class="skolem">lam</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">i</span><span class="main">]</span><span class="main">.</span> <span class="main">(</span>μ <span class="skolem">i</span> <span class="bound">x</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">x</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> idxs_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">idxs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="skolem">idx</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> of_int <span class="main">(</span><span class="skolem">lam</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">i</span><span class="main">]</span><span class="main">.</span> <span class="main">(</span>μ <span class="skolem">i</span> <span class="bound">x</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">x</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> this
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fi_is_sum_of_mu_gso<span class="main">[</span><span class="operator">OF</span> i<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> R_def
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">j</span></span><span class="main"><span class="main">.</span></span> <span class="keyword1"><span class="keyword1">if</span></span> <span class="bound"><span class="bound">j</span></span> <span class="main"><span class="main">&lt;</span></span> Suc <span class="skolem"><span class="skolem">i</span></span> <span class="keyword1"><span class="keyword1">then</span></span> of_int <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">lam</span></span> <span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">*</span></span> μ <span class="skolem"><span class="skolem">i</span></span> <span class="bound"><span class="bound">j</span></span> <span class="keyword1"><span class="keyword1">else</span></span> <span class="main"><span class="main">0</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_vecI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_vec_index<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> idx i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gso_carrier sumlist_dim <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> index_smult_vec<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sumlist_dim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_vec_index<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> idx i main<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nu</span></span> <span class="keyword2"><span class="keyword">where</span></span> gg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">gg</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">nu</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ff</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">nu</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span> <span class="main">+</span> of_int <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="skolem">k</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">hh</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hh</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="keyword1">then</span> <span class="skolem">nu</span> <span class="bound">i</span> <span class="keyword1">else</span> of_int <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?hh</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">hh</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="skolem">k</span><span class="main">]</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> ffhh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?hh</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">hh</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">hh</span> <span class="skolem">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="skolem">k</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">hh</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span> sumlist <span class="main">[</span><span class="skolem">hh</span> <span class="skolem">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="skolem">k</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sumlist_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> kn<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sumlist <span class="main">[</span><span class="skolem">hh</span> <span class="skolem">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">hh</span> <span class="skolem">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> kn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_int <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">hh</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">nu</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hh_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> ffhh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="main">=</span> <span class="var">?hh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> idx_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> hgg<span class="main">[</span><span class="operator">unfolded</span> gg<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="var">?ff</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gso <span class="skolem">k</span> <span class="main">∙</span> gso <span class="skolem">k</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> <span class="main">(</span>gso <span class="skolem">k</span> <span class="main">∙</span> gso <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> of_int <span class="main">(</span><span class="skolem">l</span> <span class="main">*</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>gso <span class="skolem">k</span> <span class="main">∙</span> gso <span class="skolem">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> l <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">*</span> <span class="skolem">l</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> eq_iff int_one_le_iff_zero_less mult_le_0_iff not_le<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="main">(</span>of_int <span class="main">(</span><span class="skolem">l</span> <span class="main">*</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>     
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> gso <span class="skolem">k</span> <span class="main">∙</span> gso <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scalar_prod_ge_0<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span> <span class="main">+</span> of_int <span class="main">(</span><span class="skolem">l</span> <span class="main">*</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>gso <span class="skolem">k</span> <span class="main">∙</span> gso <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">nu</span> <span class="bound">i</span> <span class="main">*</span> <span class="skolem">nu</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>gso <span class="bound">i</span> <span class="main">∙</span> gso <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">idx</span><span class="main">)</span> <span class="main">+</span> of_int <span class="main">(</span><span class="skolem">l</span> <span class="main">*</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>gso <span class="skolem">k</span> <span class="main">∙</span> gso <span class="skolem">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_right_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum_list_nonneg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> mult_nonneg_nonneg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scalar_prod_ge_0<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">nu</span> <span class="bound">i</span> <span class="main">*</span> <span class="skolem">nu</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>gso <span class="bound">i</span> <span class="main">∙</span> gso <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">idx</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">hh</span> <span class="bound">i</span> <span class="main">*</span> <span class="skolem">hh</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span>gso <span class="bound">i</span> <span class="main">∙</span> gso <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> idx_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hh_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span><span class="skolem">l</span> <span class="main">*</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">hh</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">hh</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span><span class="main">.</span> <span class="skolem">hh</span> <span class="bound">i</span> <span class="main">*</span> <span class="skolem">hh</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span>gso <span class="bound">i</span> <span class="main">∙</span> gso <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">hh</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">hh</span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span>gso <span class="skolem">k</span> <span class="main">∙</span> gso <span class="skolem">k</span><span class="main">)</span>
     <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span><span class="main">.</span> <span class="skolem">hh</span> <span class="bound">i</span> <span class="main">*</span> <span class="skolem">hh</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span>gso <span class="bound">i</span> <span class="main">∙</span> gso <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?hh</span> <span class="main">∙</span> <span class="var">?hh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> scalar_prod_lincomb_gso<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> kn assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?ff</span> <span class="main">∙</span> <span class="var">?ff</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffhh<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∙</span> <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> h <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> kn <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_vec_as_cscalar_prod <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

   
<span class="comment1">(* Theorem 16.9 
  (bound in textbook looks better as it uses 2^((n-1)/2), but this difference
  is caused by the fact that we here we look at the squared norms) *)</span>
<span class="keyword1" id="Gram_Schmidt_2-weakly_reduced_imp_short_vector"><span class="command">lemma</span></span> weakly_reduced_imp_short_vector<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"weakly_reduced <span class="free">α</span> m"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> in_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> lattice_of <span class="free">fs</span> <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> α_pos<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> sq_norm <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span><span class="main">^</span><span class="main">(</span>m<span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> sq_norm <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> gram_schmidt_short_vector assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> m"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> sq_norm <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> small<span class="main">:</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span><span class="main">^</span><span class="skolem">i</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs0_gso0<span class="main">[</span><span class="operator">OF</span> 0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span><span class="main">^</span><span class="skolem">i</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">α</span><span class="main">^</span><span class="skolem">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">α</span> <span class="main">*</span> <span class="main">(</span>sq_norm <span class="main">(</span>gso <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> reduced_gso_E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_refl Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> α_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> class_semiring.nat_pow_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">α</span><span class="main">^</span><span class="main">(</span>m<span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> sq_norm <span class="free">h</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> power_increasing le<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i α_pos<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt_2-sq_norm_pos"><span class="command">lemma</span></span> sq_norm_pos<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="free">j</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> j <span class="keyword1"><span class="command">have</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> m <span class="main">-</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> orthogonalD<span class="main">[</span><span class="operator">OF</span> orthogonal_gso<span class="main">,</span> <span class="operator">unfolded</span> length_map length_upt<span class="main">,</span> <span class="operator">OF</span> jj jj<span class="main">]</span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="free">j</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod<span class="main">)</span>    
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="free">j</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> sq_norm <span class="main">(</span>gso <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-Gramian_determinant"><span class="command">lemma</span></span> Gramian_determinant<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Gramian_determinant <span class="free">fs</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> sq_norm <span class="main">(</span>gso <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"Gramian_determinant <span class="free">fs</span> <span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Gk</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Gk</span> <span class="main">=</span> mat <span class="free">k</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> Gk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Gk</span> <span class="main">∈</span> carrier_mat <span class="free">k</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Gk_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Mk</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Mk</span> <span class="main">=</span> mat <span class="free">k</span> <span class="free">k</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> μ <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> Mk_μ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span> <span class="skolem">Mk</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> μ <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Mk_def <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Mk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Mk</span> <span class="main">∈</span> carrier_mat <span class="free">k</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">Mk</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">Mk</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Mk_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="skolem">Mk</span> <span class="main">=</span> prod_list <span class="main">(</span>diag_mat <span class="skolem">Mk</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> det_lower_triangular<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Mk<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Mk_μ μ.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_list_neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diag_mat_def Mk_μ μ.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> detMk<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="skolem">Mk</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Gsk</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Gsk</span> <span class="main">=</span> mat <span class="free">k</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> gso <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> Gsk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Gsk</span> <span class="main">∈</span> carrier_mat <span class="free">k</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Gsk_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Gsk'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Gsk</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Gsk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Rn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"carrier_vec <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Gk</span> <span class="main">=</span> <span class="skolem">Mk</span> <span class="main">*</span> <span class="skolem">Gsk</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Gk Mk Gsk 
    <span class="keyword1"><span class="command">have</span></span> dim<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">Gk</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span><span class="skolem">Mk</span> <span class="main">*</span> <span class="skolem">Gsk</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">Gk</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span><span class="skolem">Mk</span> <span class="main">*</span> <span class="skolem">Gsk</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> dim <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">Gk</span> <span class="main">=</span> dim_row <span class="main">(</span><span class="skolem">Mk</span> <span class="main">*</span> <span class="skolem">Gsk</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">Gk</span> <span class="main">=</span> dim_col <span class="main">(</span><span class="skolem">Mk</span> <span class="main">*</span> <span class="skolem">Gsk</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span><span class="skolem">Mk</span> <span class="main">*</span> <span class="skolem">Gsk</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="main">(</span><span class="skolem">Mk</span> <span class="main">*</span> <span class="skolem">Gsk</span><span class="main">)</span>"</span></span>     
    <span class="keyword1"><span class="command">hence</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> m"</span></span> <span class="keyword1"><span class="command">using</span></span> dim k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">have</span></span> Gi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="var">?Rn</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Gk</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Gk_def <span class="keyword1"><span class="command">using</span></span> ij k Gi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> FF <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FF <span class="main">=</span> <span class="main">(</span>M m<span class="main">)</span> <span class="main">*</span> Fs"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> matrix_equality<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> row <span class="main">(</span>M m<span class="main">)</span> <span class="skolem">i</span> <span class="main">∙</span> col Fs <span class="skolem">j</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> index_mult_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i ij<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mat_of_rows_list_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"row <span class="main">(</span>M m<span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> vec m <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="keyword1">then</span> <span class="skolem">Mk</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> vec m <span class="var">?Mk</span>"</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> Mk_def <span class="keyword1"><span class="command">using</span></span> ij i
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mat_of_rows_list_def μ.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"col Fs <span class="skolem">j</span> <span class="main">=</span> vec m <span class="main">(</span><span class="main">λ</span> <span class="bound">i'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i'</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="keyword1">then</span> <span class="skolem">Gsk</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i'</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>Fs <span class="main">$$</span> <span class="main">(</span><span class="bound">i'</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> vec m <span class="var">?Gsk</span>"</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> Gsk_def <span class="keyword1"><span class="command">using</span></span> ij i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mat_of_rows_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec m <span class="var">?Mk</span> <span class="main">∙</span> vec m <span class="var">?Gsk</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> m<span class="main">}</span><span class="main">.</span> <span class="var">?Mk</span> <span class="bound">i</span> <span class="main">*</span> <span class="var">?Gsk</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> scalar_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span> <span class="main">..&lt;</span> m<span class="main">}</span><span class="main">.</span> <span class="var">?Mk</span> <span class="bound">i</span> <span class="main">*</span> <span class="var">?Gsk</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="var">?Mk</span> <span class="bound">i</span> <span class="main">*</span> <span class="var">?Gsk</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span> <span class="main">..&lt;</span> m<span class="main">}</span><span class="main">.</span> <span class="var">?Mk</span> <span class="bound">i</span> <span class="main">*</span> <span class="var">?Gsk</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">k</span> <span class="main">..&lt;</span> m<span class="main">}</span><span class="main">.</span> <span class="var">?Mk</span> <span class="bound">i</span> <span class="main">*</span> <span class="var">?Gsk</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="var">?Mk</span> <span class="bound">i</span> <span class="main">*</span> <span class="var">?Gsk</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i'</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">Mk</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="bound">i'</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Gsk</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i'</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> row <span class="skolem">Mk</span> <span class="skolem">i</span> <span class="main">∙</span> col <span class="skolem">Gsk</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> scalar_prod_def <span class="keyword1"><span class="command">using</span></span> ij 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Gsk_def Mk_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Mk</span> <span class="main">*</span> <span class="skolem">Gsk</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij Mk Gsk <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Gk</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Mk</span> <span class="main">*</span> <span class="skolem">Gsk</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">d</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">*</span> <span class="bound">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Gramian_determinant <span class="free">fs</span> <span class="free">k</span> <span class="main">=</span> det <span class="main">(</span><span class="skolem">Gk</span> <span class="main">*</span> <span class="skolem">Gk</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Gramian_determinant_def Gramian_matrix_def Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">det</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Gk_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Gk</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">=</span> <span class="skolem">Gsk</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">*</span> <span class="skolem">Mk</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?TGsk</span> <span class="main">*</span> <span class="var">?TMk</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> id 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transpose_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mk Gsk<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Gk</span> <span class="main">=</span> <span class="skolem">Mk</span> <span class="main">*</span> <span class="skolem">Gsk</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">*</span> <span class="main">(</span><span class="var">?TGsk</span> <span class="main">*</span> <span class="var">?TMk</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Mk</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">Gsk</span> <span class="main">*</span> <span class="main">(</span><span class="var">?TGsk</span> <span class="main">*</span> <span class="var">?TMk</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assoc_mult_mat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mk Gsk<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Gsk Mk<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="main">…</span> <span class="main">=</span> det <span class="skolem">Mk</span> <span class="main">*</span> det <span class="main">(</span><span class="skolem">Gsk</span> <span class="main">*</span> <span class="main">(</span><span class="var">?TGsk</span> <span class="main">*</span> <span class="var">?TMk</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> det_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mk<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Gsk Mk<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> det <span class="main">(</span><span class="skolem">Gsk</span> <span class="main">*</span> <span class="main">(</span><span class="var">?TGsk</span> <span class="main">*</span> <span class="var">?TMk</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> detMk <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Gsk</span> <span class="main">*</span> <span class="main">(</span><span class="var">?TGsk</span> <span class="main">*</span> <span class="var">?TMk</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Gsk</span> <span class="main">*</span> <span class="var">?TGsk</span><span class="main">)</span> <span class="main">*</span> <span class="var">?TMk</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assoc_mult_mat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> Gsk<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Gsk Mk<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="main">…</span> <span class="main">=</span> det <span class="main">(</span><span class="skolem">Gsk</span> <span class="main">*</span> <span class="var">?TGsk</span><span class="main">)</span> <span class="main">*</span> det <span class="var">?TMk</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> det_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Gsk Mk<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> det <span class="main">(</span><span class="skolem">Gsk</span> <span class="main">*</span> <span class="var">?TGsk</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> detMk det_transpose<span class="main">[</span><span class="operator">OF</span> Mk<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Gsk</span> <span class="main">*</span> <span class="var">?TGsk</span> <span class="main">=</span> mat <span class="free">k</span> <span class="free">k</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> sq_norm <span class="main">(</span>gso <span class="bound">j</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?M</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span><span class="skolem">Gsk</span> <span class="main">*</span> <span class="var">?TGsk</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Gsk_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span><span class="skolem">Gsk</span> <span class="main">*</span> <span class="var">?TGsk</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Gsk_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="var">?M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="var">?M</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ijn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> m"</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> m"</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> Gs<span class="main">:</span> <span class="quoted"><span class="quoted">"gso <span class="skolem">i</span> <span class="main">∈</span> <span class="var">?Rn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"row <span class="skolem">Gsk</span> <span class="skolem">i</span> <span class="main">=</span> gso <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> row_def Gsk_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Gs <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> row <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Gsk</span> <span class="main">*</span> <span class="var">?TGsk</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> row <span class="skolem">Gsk</span> <span class="skolem">i</span> <span class="main">∙</span> row <span class="skolem">Gsk</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij Gsk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> gso <span class="skolem">i</span> <span class="main">∙</span> gso <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> row ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="keyword1">then</span> sq_norm <span class="main">(</span>gso <span class="skolem">j</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> 
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod<span class="main">)</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>›</span></span> orthogonalD<span class="main">[</span><span class="operator">OF</span> orthogonal_gso<span class="main">]</span> ijn assms
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?M</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Gsk</span> <span class="main">*</span> <span class="var">?TGsk</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="var">?M</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="var">?M</span> <span class="main">=</span> prod_list <span class="main">(</span>diag_mat <span class="var">?M</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> det_upper_triangular<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diag_mat <span class="var">?M</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> sq_norm <span class="main">(</span>gso <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">k</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diag_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">.</span> sq_norm <span class="main">(</span>gso <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.distinct_set_conv_list<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> prod.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Gramian_determinant <span class="free">fs</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">∥</span>gso <span class="bound">j</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_pos<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> ballI sq_norm_pos<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> k assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> Gramian_determinant <span class="free">fs</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-Gramian_determinant_div"><span class="command">lemma</span></span> Gramian_determinant_div<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Gramian_determinant <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">/</span> Gramian_determinant <span class="free">fs</span> <span class="free">l</span> <span class="main">=</span> <span class="main">∥</span>gso <span class="free">l</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> gram <span class="main">=</span> Gramian_determinant<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">l</span> <span class="main">≤</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> m"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">j</span><span class="main">&lt;</span>Suc <span class="free">l</span><span class="main">.</span> <span class="main">∥</span>gso <span class="bound">j</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">l</span><span class="main">}</span><span class="main">.</span> <span class="main">∥</span>gso <span class="bound">j</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">l</span><span class="main">.</span> <span class="main">∥</span>gso <span class="bound">j</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span>gso <span class="free">l</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod_Un<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atLeast0LessThan<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> gram<span class="main">[</span><span class="operator">OF</span> le<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> gram<span class="main">[</span><span class="operator">OF</span> le<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> Gramian_determinant<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> le<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gram_schmidt_fs_Rn<span class="main">)</span> Gramian_determinant_Ints<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> m <span class="main">⟹</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Gramian_determinant <span class="free">fs</span> <span class="free">k</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?oi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"of_int <span class="main">::</span> int <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> m <span class="main">⟶</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">=</span> <span class="var">?oi</span> <span class="bound">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Ints_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> choice<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">&lt;</span> m <span class="main">⟶</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">=</span> <span class="var">?oi</span> <span class="main">(</span><span class="bound">c</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> choice<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> m <span class="main">⟹</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">=</span> <span class="var">?oi</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> vec <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">c</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>m<span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">=</span> map <span class="main">(</span>map_vec <span class="var">?oi</span><span class="main">)</span> <span class="skolem">d</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_vecI c<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"mat <span class="free">k</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span>map_vec <span class="var">?oi</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> map_mat of_int <span class="main">(</span>mat <span class="free">k</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="skolem">d</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> m›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def o_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs Gramian_determinant_def Gramian_matrix_def Let_def id
    map_mat_transpose
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> of_int_hom.mat_hom_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> gram_schmidt_fs_int <span class="main">=</span> gram_schmidt_fs_lin_indpt <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> m <span class="main">⟹</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Gram_Schmidt_2-Gramian_determinant_ge1"><span class="command">lemma</span></span> Gramian_determinant_ge1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> Gramian_determinant <span class="free">fs</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> Gramian_determinant <span class="free">fs</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms Gramian_determinant<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_or_eq_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Gramian_determinant <span class="free">fs</span> <span class="free">k</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gramian_determinant_Ints assms fs_int<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Ints_nonzero_abs_ge1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-mu_bound_Gramian_determinant"><span class="command">lemma</span></span> mu_bound_Gramian_determinant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ <span class="free">k</span> <span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> Gramian_determinant <span class="free">fs</span> <span class="free">l</span> <span class="main">*</span> <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">k</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ <span class="free">k</span> <span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>  <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">k</span> <span class="main">∙</span> gso <span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="main">(</span><span class="main">∥</span>gso <span class="free">l</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_divide μ.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">k</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">∥</span>gso <span class="free">l</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">∥</span>gso <span class="free">l</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> scalar_prod_Cauchy divide_right_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">k</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="main">∥</span>gso <span class="free">l</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">k</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="main">(</span>Gramian_determinant <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">/</span> Gramian_determinant <span class="free">fs</span> <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Gramian_determinant_div<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  Gramian_determinant <span class="free">fs</span> <span class="free">l</span> <span class="main">*</span> <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">k</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> Gramian_determinant <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> Gramian_determinant <span class="free">fs</span> <span class="free">l</span> <span class="main">*</span> <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">k</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> divide_left_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Gramian_determinant_ge1<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> Gramian_determinant_ge1<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="free"><span class="free"><span class="free">l</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_nonneg_nonneg<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* gram_schmidt_fs_int *)</span>

<span class="keyword1"><span class="command">context</span></span> gram_schmidt
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Gram_Schmidt_2-gso_cong"><span class="command">lemma</span></span> gso_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f1</span> <span class="free">f2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">f1</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gram_schmidt_fs.gso <span class="free">n</span> <span class="free">f1</span> <span class="free">x</span> <span class="main">=</span> gram_schmidt_fs.gso <span class="free">n</span> <span class="free">f2</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> f1<span class="main">:</span> gram_schmidt_fs <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">f1</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> f2<span class="main">:</span> gram_schmidt_fs <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">f2</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> f1.μ <span class="skolem">x</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> f1.gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> f2.μ <span class="skolem">x</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> f2.gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> map_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f1.μ.simps f2.μ.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> f1.gso.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> f2.gso.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> *<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-μ_cong"><span class="command">lemma</span></span> μ_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f1</span> <span class="free">f2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">f1</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">f1</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">!</span> <span class="free">i</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gram_schmidt_fs.μ <span class="free">n</span> <span class="free">f1</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> gram_schmidt_fs.μ <span class="free">n</span> <span class="free">f2</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> f1<span class="main">:</span> gram_schmidt_fs <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">f1</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> f2<span class="main">:</span> gram_schmidt_fs <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">f2</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> gso_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">f1</span></span> <span class="quoted"><span class="free">f2</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> f1.gso <span class="free">j</span> <span class="main">=</span> f2.gso <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> f1.μ.simps f2.μ.simps <span class="keyword1"><span class="command">using</span></span> assms id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Gram_Schmidt_2-prod_list_le_mono"><span class="command">lemma</span></span> prod_list_le_mono<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">us</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>linordered_nonzero_semiring<span class="main">,</span>ordered_ring<span class="main">}</span> list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">us</span> <span class="main">=</span> length <span class="free">vs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">vs</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">us</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> <span class="free">us</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">vs</span> <span class="main">!</span> <span class="bound">i</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> prod_list <span class="free">us</span> <span class="main">∧</span> prod_list <span class="free">us</span> <span class="main">≤</span> prod_list <span class="free">vs</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">us</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">u</span> <span class="skolem">us</span> <span class="skolem">v</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> prod_list <span class="skolem">us</span> <span class="main">∧</span> prod_list <span class="skolem">us</span> <span class="main">≤</span> prod_list <span class="skolem">vs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Cons.prems<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">i</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">i</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Gram_Schmidt_2-lattice_of_of_int"><span class="command">lemma</span></span> lattice_of_of_int<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">F</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> vec_module.lattice_of <span class="free">n</span> <span class="free">F</span>"</span></span>     
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_vec rat_of_int <span class="free">f</span> <span class="main">∈</span> vec_module.lattice_of <span class="free">n</span> <span class="main">(</span>map <span class="main">(</span>map_vec of_int<span class="main">)</span> <span class="free">F</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> vec_module.lattice_of <span class="main">_</span> <span class="var">?F</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"abelian_monoid.sumlist <span class="main">(</span>module_vec <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>semiring_1<span class="main">)</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> vec_module.lattice_of_def
  <span class="keyword1"><span class="command">note</span></span> dim <span class="main">=</span> vec_module.sumlist_dim
  <span class="keyword1"><span class="command">note</span></span> sumlist_vec_index <span class="main">=</span> vec_module.sumlist_vec_index
  <span class="keyword1"><span class="command">from</span></span> G <span class="keyword1"><span class="command">have</span></span> Gi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">F</span> <span class="main">⟹</span> <span class="free">F</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Gi <span class="keyword1"><span class="command">have</span></span> Gid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">F</span> <span class="main">⟹</span> dim_vec <span class="main">(</span><span class="free">F</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> d<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    ffc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="var">?sl</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">F</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">F</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?g</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>   
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">=</span> <span class="var">?sl</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> of_int <span class="main">(</span><span class="skolem">c</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?F</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="var">?F</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?gg</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> d1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="var">?g</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> dim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Gi<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> d2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="var">?gg</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> length_map <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> vec_module.sumlist_dim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Gi G<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ffc length_map
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> d1 d2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> sumlist_vec_index<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def Gi G<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> of_int_hom.hom_sum_list<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">sum_list</span></span><span class="main"><span class="main">]</span></span> map_cong<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G Gi<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> index_smult_vec<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gid<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
         <span class="operator">subst</span> index_map_vec<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Gid<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> vec_module.lattice_of <span class="free">n</span> <span class="var">?F</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* Theorem 16.6, difficult part *)</span>
<span class="keyword1" id="Gram_Schmidt_2-Hadamard's_inequality"><span class="command">lemma</span></span> Hadamard's_inequality<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"real mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"abs <span class="main">(</span>det <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> sqrt <span class="main">(</span>prod_list <span class="main">(</span>map sq_norm <span class="main">(</span>rows <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?us</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>row <span class="free">A</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> gso<span class="main">:</span> gram_schmidt_fs <span class="quoted"><span class="free">n</span></span> <span class="var"><span class="quoted"><span class="var">?us</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?us</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="var">?us</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?vs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map gso.gso <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"carrier_vec <span class="free">n</span> <span class="main">⊆</span> gso.span <span class="main">(</span>set <span class="var">?us</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> us len <span class="keyword1"><span class="command">have</span></span> basis<span class="main">:</span> <span class="quoted"><span class="quoted">"gso.basis_list <span class="var">?us</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gso.basis_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> in_dep <span class="main">=</span> gso.basis_list_imp_lin_indpt_list<span class="main">[</span><span class="operator">OF</span> basis<span class="main">]</span>
    <span class="keyword1"><span class="command">interpret</span></span> gso<span class="main">:</span> gram_schmidt_fs_lin_indpt <span class="quoted"><span class="free">n</span></span> <span class="var"><span class="quoted"><span class="var">?us</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> in_dep gso.lin_indpt_list_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> last<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> prod_list <span class="main">(</span>map sq_norm <span class="var">?vs</span><span class="main">)</span> <span class="main">∧</span> prod_list <span class="main">(</span>map sq_norm <span class="var">?vs</span><span class="main">)</span> <span class="main">≤</span> prod_list <span class="main">(</span>map sq_norm <span class="var">?us</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prod_list_le_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> length_map length_upt<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> vsi<span class="main">:</span> <span class="quoted"><span class="quoted">"map sq_norm <span class="var">?vs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> sq_norm <span class="main">(</span><span class="var">?vs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> usi<span class="main">:</span> <span class="quoted"><span class="quoted">"map sq_norm <span class="var">?us</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> sq_norm <span class="main">(</span>row <span class="free">A</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> sq_norm <span class="main">(</span><span class="var">?vs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span><span class="var">?vs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> sq_norm <span class="main">(</span>row <span class="free">A</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gso.sq_norm_gso_le_f i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> map sq_norm <span class="var">?vs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∧</span> map sq_norm <span class="var">?vs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≤</span> map sq_norm <span class="var">?us</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> vsi usi <span class="keyword1"><span class="command">using</span></span> zero le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> Fs<span class="main">:</span> <span class="quoted"><span class="quoted">"gso.FF <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> A_Fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> gso.FF"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> gso.FF_index<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>det <span class="free">A</span><span class="main">)</span> <span class="main">=</span> abs <span class="main">(</span>det <span class="main">(</span>gso.FF<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="comment1">(* the following three steps are based on a discussion with Bertram Felgenhauer *)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> abs <span class="main">(</span>sqrt <span class="main">(</span>det <span class="main">(</span>gso.FF<span class="main">)</span> <span class="main">*</span> det <span class="main">(</span>gso.FF<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>gso.FF<span class="main">)</span> <span class="main">*</span> det <span class="main">(</span>gso.FF<span class="main">)</span> <span class="main">=</span> det <span class="main">(</span>gso.FF<span class="main">)</span> <span class="main">*</span> det <span class="main">(</span>gso.FF<span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> det_transpose<span class="main">[</span><span class="operator">OF</span> Fs<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> det <span class="main">(</span>gso.FF <span class="main">*</span> <span class="main">(</span>gso.FF<span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> det_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Fs<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Fs<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> gso.Gramian_determinant <span class="var">?us</span> <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> gso.Gramian_matrix_def gso.Gramian_determinant_def Let_def A_Fs<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">det</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(*)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">j</span> <span class="main">∈</span> set <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span><span class="main">.</span> <span class="main">∥</span><span class="var">?vs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gso.Gramian_determinant<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod.cong<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> sq_norm <span class="main">(</span><span class="var">?vs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.distinct_set_conv_list<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> sq_norm <span class="main">(</span><span class="var">?vs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span> <span class="main">=</span> map sq_norm <span class="var">?vs</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>sqrt <span class="main">(</span>prod_list <span class="main">…</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> sqrt <span class="main">(</span>prod_list <span class="main">(</span>map sq_norm <span class="var">?us</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> last <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?us</span> <span class="main">=</span> rows <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rows_def <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> mat_of_rows_rows<span class="main">[</span><span class="operator">unfolded</span> rows_def<span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> A gram_schmidt.non_span_det_zero<span class="main">[</span><span class="operator">OF</span> len False us<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> zero<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="free">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_list <span class="main">(</span>map sq_norm <span class="main">(</span>rows <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_list_nonneg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sq_norm_vec_ge_0<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> zero <span class="keyword1"><span class="command">using</span></span> ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gram_schmidt_wit</span> <span class="main">=</span> gram_schmidt.main"</span></span> 

<span class="keyword1"><span class="command">declare</span></span> gram_schmidt.adjuster_wit.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> gram_schmidt.sub2_wit.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> gram_schmidt.main_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
      
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gram_schmidt_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int vec list <span class="main">⇒</span> rat list list <span class="main">×</span> rat vec list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gram_schmidt_int</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">=</span> gram_schmidt_wit <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>map <span class="main">(</span>map_vec of_int<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="Gram_Schmidt_2-snd_gram_schmidt_int"><span class="command">lemma</span></span> snd_gram_schmidt_int <span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>gram_schmidt_int <span class="free">n</span> <span class="free">us</span><span class="main">)</span> <span class="main">=</span> gram_schmidt <span class="free">n</span> <span class="main">(</span>map <span class="main">(</span>map_vec of_int<span class="main">)</span> <span class="free">us</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gram_schmidt_int_def gram_schmidt_wit_def gram_schmidt_fs.gso_connect <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Faster implementation for rational vectors which also avoid recomputations
  of square-norms›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">adjuster_triv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> rat vec <span class="main">⇒</span> <span class="main">(</span>rat vec <span class="main">×</span> rat<span class="main">)</span> list <span class="main">⇒</span> rat vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">adjuster_triv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
    <span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free">adjuster_triv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nu</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">/</span> <span class="free"><span class="bound"><span class="entity">nu</span></span></span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">+</span> <span class="free">adjuster_triv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gram_schmidt_sub_triv</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gram_schmidt_sub_triv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gram_schmidt_sub_triv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">u</span> <span class="main">=</span> adjuster_triv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="keyword1">in</span>
     <span class="free">gram_schmidt_sub_triv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> sq_norm_vec_rat <span class="bound">u</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gram_schmidt_triv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> rat vec list <span class="main">⇒</span> <span class="main">(</span>rat vec <span class="main">×</span> rat<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gram_schmidt_triv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">=</span> rev <span class="main">(</span>gram_schmidt_sub_triv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_2-adjuster_triv"><span class="command">lemma</span></span> adjuster_triv<span class="main">:</span> <span class="quoted"><span class="quoted">"adjuster_triv <span class="free">n</span> <span class="free">w</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span>sq_norm <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">us</span><span class="main">)</span> <span class="main">=</span> adjuster <span class="free">n</span> <span class="free">w</span> <span class="free">us</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">us</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod<span class="main">)</span> 

<span class="keyword1" id="Gram_Schmidt_2-gram_schmidt_sub_triv"><span class="command">lemma</span></span> gram_schmidt_sub_triv<span class="main">:</span> <span class="quoted"><span class="quoted">"gram_schmidt_sub_triv <span class="free">n</span> <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span>sq_norm <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">us</span><span class="main">)</span><span class="main">)</span> <span class="free">ws</span> <span class="main">=</span> 
  map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> sq_norm <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>gram_schmidt_sub <span class="free">n</span> <span class="free">us</span> <span class="free">ws</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">us</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> adjuster_triv o_def Let_def<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-gram_schmidt_triv"><span class="command">lemma</span></span> gram_schmidt_triv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gram_schmidt_triv <span class="free">n</span> <span class="free">ws</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span>sq_norm <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>gram_schmidt <span class="free">n</span> <span class="free">ws</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> gram_schmidt_def gram_schmidt_triv_def rev_map<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gram_schmidt_sub_triv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> gram_schmidt
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mus_adjuster</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> vec <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> vec <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mus_adjuster</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span>           <span class="free"><span class="bound"><span class="entity">mus</span></span></span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mus</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">mus_adjuster</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ng</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">n_gs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">mus</span></span></span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">ng</span></span></span> <span class="keyword1">in</span>
                                             <span class="free">mus_adjuster</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n_gs</span></span></span> <span class="main">(</span><span class="bound">a</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">mus</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">norms_mus'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norms_mus'</span> <span class="main">[]</span>       <span class="free"><span class="bound"><span class="entity">n_gs</span></span></span> <span class="free"><span class="bound"><span class="entity">mus</span></span></span> <span class="main">=</span> <span class="main">(</span>map snd <span class="free"><span class="bound"><span class="entity">n_gs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mus</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norms_mus'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n_gs</span></span></span> <span class="free"><span class="bound"><span class="entity">mus</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">mus_row</span><span class="main">,</span> <span class="bound">g'</span><span class="main">)</span> <span class="main">=</span> mus_adjuster <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n_gs</span></span></span> <span class="main">[]</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">)</span><span class="main">;</span>
                     <span class="bound">g</span> <span class="main">=</span> <span class="bound">g'</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">in</span>
      <span class="free">norms_mus'</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">(</span><span class="main">(</span><span class="bound">g</span><span class="main">,</span> sq_norm_vec <span class="bound">g</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">n_gs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">mus_row</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">mus</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_2-adjuster_wit_carrier_vec"><span class="command">lemma</span></span> adjuster_wit_carrier_vec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">gs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>adjuster_wit <span class="free">mus</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">mus</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">gs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> adjuster_wit.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def case_prod_beta'<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-adjuster_wit''"><span class="command">lemma</span></span> adjuster_wit''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"adjuster_wit <span class="free">mus_acc</span> <span class="free">f</span> <span class="free">gs</span> <span class="main">=</span> <span class="main">(</span><span class="free">mus</span><span class="main">,</span> <span class="free">g'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n_gs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> sq_norm_vec <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">gs</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">acc</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">gs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mus_adjuster <span class="free">f</span> <span class="free">n_gs</span> <span class="free">mus_acc</span> <span class="free">acc</span> <span class="main">=</span> <span class="main">(</span><span class="free">mus</span><span class="main">,</span> <span class="free">acc</span> <span class="main">+</span> <span class="free">g'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">n_gs</span></span> <span class="quoted"><span class="free">mus_acc</span></span> <span class="quoted"><span class="free">acc</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g'</span></span> <span class="quoted"><span class="free">gs</span></span> <span class="quoted"><span class="free">mus</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mus_adjuster.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">mus'</span> <span class="skolem">f</span> <span class="skolem">acc</span> <span class="skolem">g</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">n_g</span> <span class="skolem">n_gs</span> <span class="skolem">mus_acc</span> <span class="skolem">acc</span> <span class="skolem">g'</span> <span class="skolem">gs</span> <span class="skolem">mus</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>adjuster_wit <span class="main">(</span><span class="skolem">f</span> <span class="main">∙</span> <span class="skolem">g</span> <span class="main">/</span> <span class="skolem">n_g</span> <span class="main">#</span> <span class="skolem">mus_acc</span><span class="main">)</span> <span class="skolem">f</span> <span class="main">(</span>tl <span class="skolem">gs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">gs</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">#</span> tl <span class="skolem">gs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> gg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gg</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> adjuster_wit_carrier_vec<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">∙</span> <span class="skolem">g</span> <span class="main">/</span> <span class="main">∥</span><span class="skolem">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">g</span> <span class="main">+</span> <span class="var">?gg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def case_prod_beta'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mus_adjuster <span class="skolem">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">n_g</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">n_gs</span><span class="main">)</span> <span class="skolem">mus_acc</span> <span class="skolem">acc</span> <span class="main">=</span>
        mus_adjuster <span class="skolem">f</span> <span class="skolem">n_gs</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">∙</span> <span class="skolem">g</span> <span class="main">/</span> <span class="skolem">n_g</span> <span class="main">#</span> <span class="skolem">mus_acc</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">∙</span> <span class="skolem">g</span> <span class="main">/</span> <span class="skolem">n_g</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">g</span> <span class="main">+</span> <span class="skolem">acc</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">mus</span><span class="main">,</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">∙</span> <span class="skolem">g</span> <span class="main">/</span> <span class="skolem">n_g</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">g</span> <span class="main">+</span> <span class="skolem">acc</span> <span class="main">+</span> <span class="var">?gg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adjuster_wit <span class="main">(</span><span class="skolem">f</span> <span class="main">∙</span> <span class="skolem">g</span> <span class="main">/</span> <span class="skolem">n_g</span> <span class="main">#</span> <span class="skolem">mus_acc</span><span class="main">)</span> <span class="skolem">f</span> <span class="main">(</span>tl <span class="skolem">gs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">mus</span><span class="main">,</span> <span class="var">?gg</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> l<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def case_prod_beta'<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"tl <span class="skolem"><span class="skolem"><span class="skolem">gs</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def case_prod_beta'<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 gg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-adjuster_wit'"><span class="command">lemma</span></span> adjuster_wit'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n_gs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> sq_norm_vec <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">gs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">gs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mus_adjuster <span class="free">f</span> <span class="free">n_gs</span> <span class="free">mus_acc</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> adjuster_wit <span class="free">mus_acc</span> <span class="free">f</span> <span class="free">gs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>adjuster_wit <span class="free">mus_acc</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mus</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>adjuster_wit <span class="free">mus_acc</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> adjuster_wit_carrier_vec<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> adjuster_wit''<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">gs</span></span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?mus</span></span></span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?g</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-sub2_wit_norms_mus'"><span class="command">lemma</span></span> sub2_wit_norms_mus'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n_gs'</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> sq_norm_vec <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">gs'</span>"</span></span>
   <span class="quoted"><span class="quoted">"sub2_wit <span class="free">gs'</span> <span class="free">fs</span> <span class="main">=</span> <span class="main">(</span><span class="free">mus</span><span class="main">,</span> <span class="free">gs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">gs'</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norms_mus' <span class="free">fs</span> <span class="free">n_gs'</span> <span class="free">mus_acc</span> <span class="main">=</span> <span class="main">(</span>map sq_norm_vec <span class="main">(</span>rev <span class="free">gs</span> <span class="main">@</span> <span class="free">gs'</span><span class="main">)</span><span class="main">,</span> rev <span class="free">mus</span> <span class="main">@</span> <span class="free">mus_acc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="free">n_gs'</span></span> <span class="quoted"><span class="free">mus_acc</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gs'</span></span> <span class="quoted"><span class="free">mus</span></span> <span class="quoted"><span class="free">gs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> norms_mus'.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n_gs</span> <span class="skolem">mus_acc</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_map<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2  <span class="skolem">f</span> <span class="skolem">fs</span> <span class="skolem">n_gs</span> <span class="skolem">mus_acc</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> aw1 <span class="main">=</span> conjunct1<span class="main">[</span><span class="operator">OF</span> conjunct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gram_schmidt_fs.adjuster_wit<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?aw</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mus_adjuster <span class="skolem">f</span> <span class="skolem">n_gs</span> <span class="main">[]</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> aw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?aw</span> <span class="main">=</span> adjuster_wit <span class="main">[]</span> <span class="skolem">f</span> <span class="skolem">gs'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> adjuster_wit'<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sub2_wit <span class="main">(</span><span class="main">(</span>snd <span class="var">?aw</span> <span class="main">+</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">gs'</span><span class="main">)</span> <span class="skolem">fs</span> <span class="main">=</span> sub2_wit <span class="main">(</span><span class="main">(</span>snd <span class="main">(</span>adjuster_wit <span class="main">[]</span> <span class="skolem">f</span> <span class="skolem">gs'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">gs'</span><span class="main">)</span> <span class="skolem">fs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> adjuster_wit'<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>tl <span class="skolem">mus</span><span class="main">,</span> tl <span class="skolem">gs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def case_prod_beta'<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> sub_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"sub2_wit <span class="main">(</span><span class="main">(</span>snd <span class="var">?aw</span> <span class="main">+</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">gs'</span><span class="main">)</span> <span class="skolem">fs</span> <span class="main">=</span> <span class="main">(</span>tl <span class="skolem">mus</span><span class="main">,</span> tl <span class="skolem">gs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> aw_c<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="var">?aw</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> adjuster_wit'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">gs'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> 2 adjuster_wit_carrier_vec <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">gs</span> <span class="main">=</span> <span class="main">(</span>snd <span class="var">?aw</span> <span class="main">+</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">#</span> tl <span class="skolem">gs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> aw<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def case_prod_beta'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> mus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mus</span> <span class="main">=</span> fst <span class="var">?aw</span> <span class="main">#</span> tl <span class="skolem">mus</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> aw<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def case_prod_beta'<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def case_prod_beta'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>snd <span class="var"><span class="var">?aw</span></span> <span class="main"><span class="main">+</span></span> <span class="skolem"><span class="skolem">f</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">#</span></span><span class="skolem"><span class="skolem">gs'</span></span>"</span></span></span>  <span class="quoted"><span class="quoted"><span class="quoted">"tl <span class="skolem"><span class="skolem">mus</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"tl <span class="skolem"><span class="skolem">gs</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> sub_tl <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 aw_c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> gs 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> gs<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gs<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> rev.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rev_map<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> mus
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-sub2_wit_gram_schmidt_sub_triv''"><span class="command">lemma</span></span> sub2_wit_gram_schmidt_sub_triv''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sub2_wit <span class="main">[]</span> <span class="free">fs</span> <span class="main">=</span> <span class="main">(</span><span class="free">mus</span><span class="main">,</span> <span class="free">gs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norms_mus' <span class="free">fs</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span>map sq_norm_vec <span class="main">(</span>rev <span class="free">gs</span><span class="main">)</span><span class="main">,</span> rev <span class="free">mus</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sub2_wit_norms_mus'<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">norms_mus</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norms_mus</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">n_gs</span><span class="main">,</span> <span class="bound">mus</span><span class="main">)</span> <span class="main">=</span> norms_mus' <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="keyword1">in</span> <span class="main">(</span>rev <span class="bound">n_gs</span><span class="main">,</span> rev <span class="bound">mus</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_2-sub2_wit_gram_schmidt_norm_mus"><span class="command">lemma</span></span> sub2_wit_gram_schmidt_norm_mus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sub2_wit <span class="main">[]</span> <span class="free">fs</span> <span class="main">=</span> <span class="main">(</span><span class="free">mus</span><span class="main">,</span> <span class="free">gs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norms_mus <span class="free">fs</span> <span class="main">=</span> <span class="main">(</span>map sq_norm_vec <span class="free">gs</span><span class="main">,</span> <span class="free">mus</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> norms_mus_def <span class="keyword1"><span class="command">using</span></span> assms sub2_wit_gram_schmidt_sub_triv''
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def case_prod_beta' rev_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gram_schmidt_fs_Rn<span class="main">)</span> norms_mus<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norms_mus <span class="free">fs</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">∥</span>gso <span class="bound">j</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">fs</span><span class="main">]</span><span class="main">,</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> map <span class="main">(</span>μ <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">fs</span><span class="main">]</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sub2_wit <span class="main">[]</span> <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gram_schmidt_sub2 <span class="free">n</span> <span class="main">[]</span> <span class="free">fs</span> <span class="main">=</span> snd <span class="var">?s</span> <span class="main">∧</span> snd <span class="var">?s</span> <span class="main">=</span> map <span class="main">(</span>gso<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">fs</span><span class="main">]</span> <span class="main">∧</span> fst <span class="var">?s</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> map <span class="main">(</span>μ <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">fs</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sub2_wit<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="var">?s</span> <span class="main">=</span> map <span class="main">(</span>gso<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">fs</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="var">?s</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> map <span class="main">(</span>μ <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">fs</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">=</span> <span class="main">(</span>fst <span class="var">?s</span><span class="main">,</span> snd <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sub2_wit_gram_schmidt_norm_mus<span class="main">[</span><span class="operator">OF</span> s assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> 1 2 o_def map_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mus_adjuster_rat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat vec <span class="main">⇒</span> <span class="main">(</span>rat vec <span class="main">×</span> rat<span class="main">)</span> list <span class="main">⇒</span> rat list <span class="main">⇒</span> rat vec <span class="main">⇒</span> rat list <span class="main">×</span> rat vec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mus_adjuster_rat</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span>           <span class="free"><span class="bound"><span class="entity">mus</span></span></span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mus</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">mus_adjuster_rat</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ng</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">n_gs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">mus</span></span></span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">ng</span></span></span> <span class="keyword1">in</span>
                                             <span class="free">mus_adjuster_rat</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n_gs</span></span></span> <span class="main">(</span><span class="bound">a</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">mus</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="bound">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">norms_mus_rat'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norms_mus_rat'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span>       <span class="free"><span class="bound"><span class="entity">n_gs</span></span></span> <span class="free"><span class="bound"><span class="entity">mus</span></span></span> <span class="main">=</span> <span class="main">(</span>map snd <span class="free"><span class="bound"><span class="entity">n_gs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mus</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">norms_mus_rat'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n_gs</span></span></span> <span class="free"><span class="bound"><span class="entity">mus</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">mus_row</span><span class="main">,</span> <span class="bound">g'</span><span class="main">)</span> <span class="main">=</span> mus_adjuster_rat <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n_gs</span></span></span> <span class="main">[]</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">;</span>
                     <span class="bound">g</span> <span class="main">=</span> <span class="bound">g'</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">in</span>
      <span class="free">norms_mus_rat'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">(</span><span class="main">(</span><span class="bound">g</span><span class="main">,</span> sq_norm_vec <span class="bound">g</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">n_gs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">mus_row</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">mus</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">norms_mus_rat</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norms_mus_rat</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">n_gs</span><span class="main">,</span> <span class="bound">mus</span><span class="main">)</span> <span class="main">=</span> norms_mus_rat' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="keyword1">in</span> <span class="main">(</span>rev <span class="bound">n_gs</span><span class="main">,</span> rev <span class="bound">mus</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_2-norms_mus_rat_norms_mus"><span class="command">lemma</span></span> norms_mus_rat_norms_mus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"norms_mus_rat <span class="free">n</span> <span class="free">fs</span> <span class="main">=</span> gram_schmidt.norms_mus <span class="free">n</span> <span class="free">fs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mus_adjuster_rat <span class="skolem">f</span> <span class="skolem">n_gs</span> <span class="skolem">mus_acc</span> <span class="skolem">g_acc</span> <span class="main">=</span> gram_schmidt.mus_adjuster <span class="skolem">f</span> <span class="skolem">n_gs</span> <span class="skolem">mus_acc</span> <span class="skolem">g_acc</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n_gs</span> <span class="skolem">mus_acc</span> <span class="skolem">g_acc</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">n_gs</span></span> <span class="quoted"><span class="skolem">mus_acc</span></span> <span class="quoted"><span class="skolem">g_acc</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mus_adjuster_rat.induct<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gram_schmidt.mus_adjuster.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norms_mus_rat' <span class="skolem">n</span> <span class="skolem">fs</span> <span class="skolem">n_gs</span> <span class="skolem">mus</span> <span class="main">=</span> gram_schmidt.norms_mus' <span class="skolem">n</span> <span class="skolem">fs</span> <span class="skolem">n_gs</span> <span class="skolem">mus</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">fs</span> <span class="skolem">n_gs</span> <span class="skolem">mus</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">fs</span></span> <span class="quoted"><span class="skolem">n_gs</span></span> <span class="quoted"><span class="skolem">mus</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> norms_mus_rat'.induct<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gram_schmidt.norms_mus'.simps case_prod_beta'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> norms_mus_rat_def gram_schmidt.norms_mus_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-of_int_dvd"><span class="command">lemma</span></span> of_int_dvd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"of_int <span class="free">a</span> <span class="main">/</span> <span class="main">(</span>of_int <span class="free">b</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field_char_0<span class="main">)</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Ints_cases<span class="main">)</span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> of_int_mult<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-denom_dvd_ints"><span class="command">lemma</span></span> denom_dvd_ints<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span><span class="main">::</span><span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"quotient_of <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">z</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"of_int <span class="free">i</span> <span class="main">*</span> <span class="free">r</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">dvd</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="free">i</span> <span class="main">*</span> <span class="main">(</span>rat_of_int <span class="free">z</span> <span class="main">/</span> rat_of_int <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms quotient_of_div <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">dvd</span> <span class="free">i</span> <span class="main">*</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> quotient_of_denom_pos assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> of_int_dvd<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">dvd</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms algebraic_semidom_class.coprime_commute 
      quotient_of_coprime coprime_dvd_mult_left_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-quotient_of_bounds"><span class="command">lemma</span></span> quotient_of_bounds<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"quotient_of <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="free">i</span> <span class="main">*</span> <span class="free">r</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">r</span><span class="main">¦</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">¦</span><span class="free">n</span><span class="main">¦</span> <span class="main">≤</span> of_int <span class="free">i</span> <span class="main">*</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> ni<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms denom_dvd_ints  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> zdvd_imp_le<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">r</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span>rat_of_int <span class="free">n</span> <span class="main">/</span> rat_of_int <span class="free">d</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms quotient_of_div <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> rat_of_int <span class="main">¦</span><span class="free">n</span><span class="main">¦</span> <span class="main">/</span> rat_of_int <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">using</span></span> quotient_of_denom_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">¦</span><span class="free">n</span><span class="main">¦</span> <span class="main">=</span> rat_of_int <span class="free">d</span> <span class="main">*</span> <span class="main">¦</span><span class="free">r</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> rat_of_int <span class="free">d</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms quotient_of_denom_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> rat_of_int <span class="free">i</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ni assms of_int_le_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_right_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">¦</span><span class="free">n</span><span class="main">¦</span> <span class="main">≤</span> rat_of_int <span class="free">i</span> <span class="main">*</span> <span class="free">b</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> gram_schmidt_fs_Rn
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Lemma 16.17 *)</span> 

<span class="keyword1" id="Gram_Schmidt_2-ex_κ"><span class="command">lemma</span></span> ex_κ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">κ</span><span class="main">.</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">l</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
             sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">κ</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">l</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">κ</span><span class="main">.</span> <span class="var">?Prop</span> <span class="free">l</span> <span class="free">i</span> <span class="bound">κ</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">κ<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> κ<span class="hidden">⇩</span><sub>i</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Prop</span> <span class="skolem">l</span> <span class="skolem">i</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">κ<span class="hidden">⇩</span><sub>l</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> κ<span class="hidden">⇩</span><sub>l</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Prop</span> <span class="skolem">l</span> <span class="skolem">l</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>l</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> Suc <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> Suc that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dim_sumlist<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">κ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">κ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">l</span> <span class="keyword1">then</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x</span> <span class="main">-</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>l</sub></span> <span class="bound">x</span> <span class="main">*</span> μ <span class="skolem">i</span> <span class="skolem">l</span> <span class="keyword1">else</span>  <span class="main">-</span> μ <span class="skolem">i</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sum</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="bound">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="skolem">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">l</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> 
        M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span> <span class="main">-</span> μ <span class="skolem">i</span> <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> κ<span class="hidden">⇩</span><sub>i</sub>_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sumlist_snoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gso <span class="skolem">l</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>l</sub></span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gso.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> κ<span class="hidden">⇩</span><sub>l</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span>
             <span class="main">-</span> μ <span class="skolem">i</span> <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>l</sub></span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
             <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">κ</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">l</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="main">$</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span> 
                <span class="main">-</span> μ <span class="skolem">i</span> <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>l</sub></span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">k</span>
          <span class="main">=</span> <span class="main">(</span>M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">+</span> 
                <span class="main">-</span> μ <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">*</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>l</sub></span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">.</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">j</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span> 
                 <span class="main">+</span> <span class="main">(</span><span class="main">-</span> μ <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">.</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>l</sub></span> <span class="bound">j</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> μ <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">$</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sumlist_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> μ <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">.</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>l</sub></span> <span class="bound">j</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span> 
               <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">.</span> <span class="main">-</span> μ <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">κ<span class="hidden">⇩</span><sub>l</sub></span> <span class="bound">j</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sum_distrib_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">.</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">j</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">.</span> <span class="main">-</span> μ <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">κ<span class="hidden">⇩</span><sub>l</sub></span> <span class="bound">j</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">.</span> <span class="main">(</span><span class="skolem">κ<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x</span> <span class="main">-</span> <span class="skolem">κ<span class="hidden">⇩</span><sub>l</sub></span> <span class="bound">x</span> <span class="main">*</span> μ <span class="skolem">i</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">.</span> <span class="skolem">κ</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> κ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">.</span> <span class="skolem">κ</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> μ <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">.</span> <span class="skolem">κ</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">=</span> <span class="skolem">l</span><span class="main">..&lt;</span>Suc <span class="skolem">l</span><span class="main">.</span> <span class="skolem">κ</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> κ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">l</span><span class="main">.</span> <span class="skolem">κ</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">l</span><span class="main">.</span> <span class="main">(</span><span class="skolem">κ</span> <span class="bound">x</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">κ</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">l</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_nth<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> that Suc<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dim_sumlist<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">κ</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">definition</span></span> κ_SOME_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">κ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">κ</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">fs</span> <span class="main">⟶</span> <span class="bound">l</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">⟶</span>
        sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="bound">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">l</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">κ</span> <span class="bound">i</span> <span class="bound">l</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_2-κ_def"><span class="command">lemma</span></span> κ_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
         sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span> <span class="bound">l</span> <span class="bound">κ</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">fs</span> <span class="main">⟶</span> <span class="bound">l</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">⟶</span>
                  sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="bound">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">l</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
                  sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">κ</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> ex_κ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">l</span><span class="main">.</span> <span class="main">∃</span><span class="bound">κ</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span> <span class="bound">l</span> <span class="bound">κ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> choice<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">κ</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">l</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span> <span class="bound">l</span> <span class="main">(</span><span class="bound">κ</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> choice<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">κ</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span> <span class="bound">l</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span> <span class="bound">l</span> <span class="main">(</span><span class="bound">κ</span> <span class="bound">i</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> κ_SOME_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gram_schmidt_fs_lin_indpt<span class="main">)</span> fs_i_sumlist_κ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span>
        <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms gso_carrier assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> κ_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dim_sumlist sumlist_nth sum_negf<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="free">l</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fi_is_sum_of_mu_gso<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span>
                  M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="free">l</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">l</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_zero le_imp_less_Suc length_upt list_trisect upt_conv_Cons<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> map_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sumlist_append<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> gso_carrier assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms gso_carrier assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> dim_sumlist<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
                M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="free">l</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∙</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms gso_carrier assms <span class="keyword1"><span class="command">unfolding</span></span> lin_indpt_list_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> scalar_prod_left_sum_distrib<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> dim_sumlist gso_scalar_zero <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_list_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* gram_schmidt_fs_Rn *)</span>

<span class="keyword1" id="Gram_Schmidt_2-Ints_sum"><span class="command">lemma</span></span> Ints_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">A</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-Ints_prod"><span class="command">lemma</span></span> Ints_prod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prod <span class="free">f</span> <span class="free">A</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-Ints_scalar_prod"><span class="command">lemma</span></span> Ints_scalar_prod<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>
   <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">ℤ</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">ℤ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∙</span> <span class="free">w</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> scalar_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Ints_sum Ints_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-Ints_det"><span class="command">lemma</span></span> Ints_det<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="free">A</span> 
  <span class="main">⟹</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"det <span class="free">A</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">A</span> <span class="main">=</span> dim_col <span class="free">A</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Determinant.det_def <span class="keyword1"><span class="command">using</span></span> True assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Ints_sum Ints_mult Ints_prod <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> signof_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Determinant.det_def <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gram_schmidt_fs_Rn<span class="main">)</span> Gramian_matrix_alt_alt_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Gramian_matrix <span class="free">fs</span> <span class="free">k</span> <span class="main">=</span> mat <span class="free">k</span> <span class="free">k</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"vec <span class="free">n</span> <span class="main">(</span><span class="main">($)</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> m"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gramian_matrix_def <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_matI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gram_schmidt_fs_int<span class="main">)</span> fs_scalar_Ints<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ints_scalar_prod<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> fs_int assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gram_schmidt_fs_lin_indpt<span class="main">)</span> <span class="entity">d</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≡</span> Gramian_determinant <span class="free">fs</span>"</span></span> 


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gram_schmidt_fs_lin_indpt<span class="main">)</span> fs_i_fs_j_sum_κ <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">t</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">.</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">t</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">*</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sumlist_carrier <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dim_sumlist<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span>  <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fs_i_sumlist_κ assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> add_scalar_prod_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span>
             <span class="main">(</span><span class="main">∑</span><span class="bound">v</span><span class="main">←</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> scalar_prod_left_sum_distrib<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">t</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">.</span> <span class="main">(</span>κ <span class="free">i</span> <span class="free">l</span> <span class="bound">t</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">sum_list</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  <span class="main">(</span><span class="main">∑</span><span class="bound">t</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">.</span> <span class="main">(</span>κ <span class="free">i</span> <span class="free">l</span> <span class="bound">t</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> interv_sum_list_conv_sum_set_nat<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">t</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">.</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">t</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">*</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gram_schmidt_fs_lin_indpt<span class="main">)</span> Gramian_matrix_times_κ <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Gramian_matrix <span class="free">fs</span> <span class="free">l</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>vec <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>vec <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">t</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">.</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">t</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">*</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> fs_i_fs_j_sum_κ assms that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Gramian_matrix_alt_alt_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scalar_prod_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gram_schmidt_fs_int<span class="main">)</span> d_κ_Ints <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"d <span class="free">l</span> <span class="main">*</span> κ <span class="free">i</span> <span class="free">l</span> <span class="free">t</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Gramian_matrix <span class="free">fs</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"replace_col <span class="var">?A</span> <span class="main">(</span>Gramian_matrix <span class="free">fs</span> <span class="free">l</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec <span class="free">l</span> <span class="main">(</span>κ <span class="free">i</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> deteq<span class="main">:</span> <span class="quoted"><span class="quoted">"d <span class="free">l</span> <span class="main">=</span> det <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gramian_determinant_def
    <span class="keyword1"><span class="command">using</span></span> Gramian_determinant_Ints
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"Gramian_matrix <span class="free">fs</span> <span class="free">l</span> <span class="main">∈</span> carrier_mat <span class="free">l</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Gramian_matrix_def Let_def  <span class="keyword1"><span class="command">using</span></span> fs_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" κ <span class="free">i</span> <span class="free">l</span> <span class="free">t</span> <span class="main">*</span> det <span class="var">?A</span> <span class="main">=</span> det <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms fs_carrier cramer_lemma_mat<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span>vec <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">...</span> <span class="main">∈</span> <span class="main">ℤ</span> "</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">&lt;</span><span class="free">l</span> <span class="main">⟹</span> <span class="main">(</span><span class="var">?A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec <span class="free">l</span> <span class="main">(</span>κ <span class="free">i</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Gramian_matrix_times_κ<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> fs_int fs_carrier
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fs_scalar_Ints Ints_minus<span class="main">)</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="var">?B</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> Bint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span><span class="main">&lt;</span><span class="free">l</span> <span class="main">⟶</span> <span class="skolem">s1</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">⟶</span> <span class="skolem">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">s1</span><span class="main">)</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t1</span> <span class="skolem">s1</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">=</span> <span class="free">t</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> * ** this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> replace_col_def B_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> * ** Gramian_matrix_def this fs_carrier assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> replace_col_def B_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Gramian_matrix_def Let_def scalar_prod_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Ints_sum Ints_mult fs_int<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> carrier_mat <span class="free">l</span> <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ** replace_col_def <span class="keyword1"><span class="command">unfolding</span></span> B_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> replace_col_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="skolem">B</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B Bint assms  det_col<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Ints_sum Ints_mult Ints_prod <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> signof_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> deteq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gram_schmidt_fs_int<span class="main">)</span> d_gso_Ints<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>d <span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>gso <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> d_κ_Ints<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>d <span class="free">k</span> <span class="main">*</span> κ <span class="free">k</span> <span class="free">k</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">$</span> <span class="free">i</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> that fs_int assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Ints_mult <span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>d <span class="free">k</span> <span class="main">*</span> κ <span class="free">k</span> <span class="free">k</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> d <span class="free">k</span> <span class="main">*</span> κ <span class="free">k</span> <span class="free">k</span> <span class="skolem">j</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">$</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">.</span> κ <span class="free">k</span> <span class="free">k</span> <span class="bound">j</span> <span class="main">*</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_distrib_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Ints_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gso <span class="free">k</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">k</span> <span class="main">$</span> <span class="free">i</span> <span class="main">+</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span>κ <span class="free">k</span> <span class="free">k</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="free">i</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> κ <span class="free">k</span> <span class="free">k</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_dim<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gso.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sumlist_nth sumlist_dim κ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left Gramian_determinant_Ints fs_int <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Ints_mult Ints_add<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gram_schmidt_fs_int<span class="main">)</span> d_mu_Ints<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"d <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">k</span> <span class="free">l</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> ll<span class="main">:</span> <span class="quoted"><span class="quoted">"d <span class="free">l</span> <span class="main">*</span> gso <span class="free">l</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>d <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="free">l</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">k</span> <span class="free">l</span> <span class="main">=</span>d <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">k</span> <span class="main">∙</span> gso <span class="free">l</span><span class="main">)</span> <span class="main">/</span> <span class="main">∥</span>gso <span class="free">l</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms True <span class="keyword1"><span class="command">unfolding</span></span> μ.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">k</span> <span class="main">∙</span> <span class="main">(</span>d <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Gramian_determinant<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="free">l</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Gramian_determinant_div<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="free">l</span> <span class="main">*</span> gso <span class="free">l</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> assms d_gso_Ints that ll <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Ints_sum <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fs_int scalar_prod_def<span class="main">)</span>
 <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> l μ.simps <span class="keyword1"><span class="command">using</span></span> Gramian_determinant_Ints fs_int assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt_2-max_list_Max"><span class="command">lemma</span></span> max_list_Max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> max_list <span class="free">ls</span> <span class="main">=</span> Max <span class="main">(</span>set <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_list_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Explicit Bounds for Size of Numbers that Occur During GSO Algorithm ›</span></span>

<span class="keyword1"><span class="command">context</span></span> gram_schmidt_fs_lin_indpt
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> Max <span class="main">(</span>sq_norm <span class="main">`</span> set <span class="free">fs</span><span class="main">)</span>"</span></span>



<span class="keyword1" id="Gram_Schmidt_2-N_ge_0"><span class="command">lemma</span></span> N_ge_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> N"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> sq_norm <span class="main">`</span> set <span class="free">fs</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> N_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-N_fs"><span class="command">lemma</span></span> N_fs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> N"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> N_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-N_gso"><span class="command">lemma</span></span> N_gso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>gso <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> N"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms N_fs sq_norm_gso_le_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Gram_Schmidt_2-N_d"><span class="command">lemma</span></span> N_d<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Gramian_determinant <span class="free">fs</span> <span class="free">i</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="main">∥</span>gso <span class="bound">j</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∏</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> N<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms N_gso <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms Gramian_determinant <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Gram_Schmidt_2-ex_MAXIMUM"><span class="command">lemma</span></span> ex_MAXIMUM<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max_in<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms imageE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> gram_schmidt_fs_int
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Gram_Schmidt_2-fs_int'"><span class="command">lemma</span></span> fs_int'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">$</span> <span class="free">k</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fs_int in_set_conv_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> fs_sq_norm_Ints<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fs_sq_norm_ge_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> fs_Ints<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms fs_int' carrier_vecD fs_carrier
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod scalar_prod_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Ints_sum Ints_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms fs_carrier loc_assms nth_mem vs_zero_lin_dep <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sq_norm_vec_eq_0 f_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ints_cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fs_Ints<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> * sq_norm_vec_ge_0<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">fs</span></span></span> <span class="main"><span class="main"><span class="main">!</span></span></span> <span class="free"><span class="free"><span class="free">i</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> N_Ints<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> N_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> N"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">∈</span> set <span class="free">fs</span><span class="main">.</span> N <span class="main">=</span> sq_norm <span class="bound">v<span class="hidden">⇩</span><sub>m</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> N_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ex_MAXIMUM<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>m</sub></span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="hidden">⇩</span><sub>m</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">∈</span> set <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"N <span class="main">=</span> sq_norm <span class="skolem">v<span class="hidden">⇩</span><sub>m</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> N_Ints<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fs_int' carrier_vecD fs_carrier
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod scalar_prod_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Ints_sum Ints_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> N"</span></span>
    <span class="keyword1"><span class="command">using</span></span> N_gso sq_norm_pos assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> N"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ints_cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> N_Ints<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> * N_ge_0 assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-N_mu"><span class="command">lemma</span></span> N_mu<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> Gramian_determinant <span class="free">fs</span> <span class="free">j</span> <span class="main">*</span> <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms ji <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mu_bound_Gramian_determinant<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">j</span> <span class="main">*</span> <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms N_d N_ge_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"N <span class="main">^</span> <span class="free">j</span> <span class="main">*</span> <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">j</span> <span class="main">*</span> N"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms N_fs N_ge_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ji <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> μ.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> N"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms N_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms N_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1" id="Gram_Schmidt_2-vec_hom_Ints"><span class="command">lemma</span></span> vec_hom_Ints<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"of_int_hom.vec_hom <span class="free">xs</span> <span class="main">$</span> <span class="free">i</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-division_to_div"><span class="command">lemma</span></span> division_to_div<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_int <span class="free">x</span>  <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> floor_ceiling<span class="main">)</span> <span class="main">=</span> of_int <span class="free">y</span> <span class="main">/</span> of_int <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">div</span> <span class="free">z</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> floor_divide_of_int_eq floor_of_int<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-exact_division"><span class="command">lemma</span></span> exact_division<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"of_int <span class="free">x</span> <span class="main">/</span> <span class="main">(</span>of_int <span class="free">y</span>  <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> floor_ceiling<span class="main">)</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span><span class="free">x</span> <span class="keyword1">div</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> of_int <span class="free">x</span> <span class="main">/</span> <span class="main">(</span>of_int <span class="free">y</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ints_cases division_to_div<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-int_via_rat_eqI"><span class="command">lemma</span></span> int_via_rat_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_of_int <span class="free">x</span> <span class="main">=</span> rat_of_int <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">locale</span></span> fs_int <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="comment1">(* n-dimensional vectors, *)</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">fs_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec list"</span></span> <span class="comment1">(* initial basis *)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> vec_module <span class="quoted"><span class="quoted">"<span class="keyword1">TYPE</span><span class="main">(</span>int<span class="main">)</span>"</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RAT</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RAT</span> <span class="main">≡</span> map <span class="main">(</span>map_vec rat_of_int<span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">m</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≡</span> length <span class="free">fs_init</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> gs<span class="main">:</span> gram_schmidt_fs <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs_init</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">d</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec list <span class="main">⇒</span> nat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> gs.Gramian_determinant <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">D</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> nat <span class="main">(</span><span class="main">∏</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">.</span> d <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="bound">i</span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="Gram_Schmidt_2-of_int_Gramian_determinant"><span class="command">lemma</span></span> of_int_Gramian_determinant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">F</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">F</span> <span class="main">⟹</span> dim_vec <span class="main">(</span><span class="free">F</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gs.Gramian_determinant <span class="main">(</span>map of_int_hom.vec_hom <span class="free">F</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> of_int <span class="main">(</span>gs.Gramian_determinant <span class="free">F</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gs.Gramian_determinant_def of_int_hom.hom_det<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">det</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map of_int_hom.vec_hom <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">d</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">*</span> <span class="bound">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gs.Gramian_matrix <span class="var">?F</span> <span class="free">k</span> <span class="main">=</span> map_mat of_int <span class="main">(</span>gs.Gramian_matrix <span class="free">F</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> gs.Gramian_matrix_def Let_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> of_int_hom.mat_hom_mult<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cong<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"mat <span class="free">k</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="var">?F</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> map_mat of_int <span class="main">(</span>mat <span class="free">k</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free">F</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> map_mat <span class="main">_</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">F</span>"</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span><span class="free">F</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">=</span> map_mat of_int <span class="var">?R</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> fs_int_indpt <span class="main">=</span> fs_int <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span> <span class="free">fs</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lin_indep<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.lin_indpt_list <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> gs<span class="main">:</span> gram_schmidt_fs_lin_indpt <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> lin_indep gs.lin_indpt_list_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> gs<span class="main">:</span> gram_schmidt_fs_int <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> gs.f_carrier lin_indep gs.lin_indpt_list_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main">!</span><span class="main">:</span> vec_hom_Ints›</span><span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_2-f_carrier"><span class="command">lemma</span></span> f_carrier<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m <span class="main">⟹</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fs_carrier <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lin_indep gs.f_carrier gs.gso_carrier <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-Gramian_determinant"><span class="command">lemma</span></span> Gramian_determinant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span>gs.Gramian_determinant <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> sq_norm <span class="main">(</span>gs.gso <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span><span class="main">)</span>
    <span class="quoted"><span class="quoted">"gs.Gramian_determinant <span class="free">fs</span> <span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> hom<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.Gramian_determinant <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> of_int <span class="main">(</span>gs.Gramian_determinant <span class="free">fs</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> of_int_Gramian_determinant<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> hom<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> gs.Gramian_determinant assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> hom gs.Gramian_determinant assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-fs_int_d_pos"><span class="command">lemma</span></span> fs_int_d_pos <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> m"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"d <span class="free">fs</span> <span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">using</span></span> Gramian_determinant<span class="main">[</span><span class="operator">OF</span> k<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_2-fs_int_d_Suc"><span class="command">lemma</span></span> fs_int_d_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> m"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sq_norm <span class="main">(</span>gs.gso <span class="free">k</span><span class="main">)</span> <span class="main">*</span> of_int <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> k <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> m"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">k</span> <span class="main">≤</span> m"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Gramian_determinant<span class="main">[</span><span class="operator">OF</span> k<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> Gramian_determinant<span class="main">[</span><span class="operator">OF</span> k<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> d_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.remove<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> prod.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-fs_int_D_pos"><span class="command">lemma</span></span> fs_int_D_pos<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"D <span class="free">fs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span> <span class="bound">j</span> <span class="main">&lt;</span> m<span class="main">.</span> d <span class="free">fs</span> <span class="bound">j</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_pos<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> fs_int_d_pos<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> D_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dμ</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> int_of_rat <span class="main">(</span>of_int <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> gs.μ <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="Gram_Schmidt_2-fs_int_mu_d_Z"><span class="command">lemma</span></span> fs_int_mu_d_Z<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">ii</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&lt;</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> gs.μ <span class="free">ii</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> gs.Gramian_determinant <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> d_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> of_int_Gramian_determinant<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j ii <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int_hom.vec_hom <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
     <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> vec_hom_Ints<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">using</span></span> j ii <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> gs.d_mu_Ints<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-fs_int_mu_d_Z_m_m"><span class="command">lemma</span></span> fs_int_mu_d_Z_m_m<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> m"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&lt;</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> gs.μ <span class="free">ii</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">ii</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fs_int_mu_d_Z<span class="main">[</span><span class="operator">OF</span> True ii<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gs.μ.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt_2-sq_norm_fs_via_sum_mu_gso"><span class="command">lemma</span></span> sq_norm_fs_via_sum_mu_gso<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">.</span> <span class="main">(</span>gs.μ <span class="free">i</span> <span class="bound">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">∥</span>gs.gso <span class="bound">j</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>gs.gso<span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> m<span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gso</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">fs</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?G</span> <span class="main">!</span> <span class="bound">j</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">∥</span>RAT <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_of_int<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> insert i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> gs.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> gs.μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gs.gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> gs.fi_is_sum_of_mu_gso i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> gs.μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gs.gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> gs.μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?gso</span> <span class="free">fs</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gs.sumlist <span class="main">…</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map sq_norm <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> gs.μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gs.gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> map_map o_def sq_norm_smult_vec
    <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_vec_as_cscalar_prod cscalar_prod_is_scalar_prod conjugate_id
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> gs.scalar_prod_lincomb_orthogonal<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">≤</span> length <span class="var">?G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?G</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gs.gso_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"orthogonal <span class="var">?G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gs.orthogonal_gso <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">sum_list</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map sq_norm <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> gs.μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gs.gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span>gs.μ <span class="free">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> sq_norm <span class="main">(</span>gs.gso <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> map_map o_def sq_norm_smult_vec <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_2-dμ"><span class="command">lemma</span></span> dμ<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&lt;</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span>dμ <span class="free">ii</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> of_int <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> gs.μ <span class="free">ii</span> <span class="free">j</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> dμ_def <span class="keyword1"><span class="command">using</span></span> fs_int_mu_d_Z_m_m assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Gram_Schmidt_Int">
<div class="head">
<h1>Theory Gram_Schmidt_Int</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Ralph Bottesch
                Maximilian Haslbeck
                René Thiemann
    License:    BSD
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Gram-Schmidt Implementation for Integer Vectors›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory implements the Gram-Schmidt algorithm on integer vectors
  using purely integer arithmetic. The formalization is based on \cite{GS_EKM}.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Gram_Schmidt_Int
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="#Gram_Schmidt_2">Gram_Schmidt_2</a>
    <a href="#More_IArray">More_IArray</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span>
  <span class="free">fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec iarray"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">begin</span></span> 
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sigma_array</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sigma_array</span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="free"><span class="bound"><span class="entity">dmusi</span></span></span> <span class="free"><span class="bound"><span class="entity">dmusj</span></span></span> <span class="free"><span class="bound"><span class="entity">dll</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">dmusi</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">dmusj</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">l1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">;</span> <span class="bound">dll1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="main">!!</span> <span class="bound">l1</span> <span class="main">!!</span> <span class="bound">l1</span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dll</span></span></span> <span class="main">*</span> <span class="free">sigma_array</span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="free"><span class="bound"><span class="entity">dmusi</span></span></span> <span class="free"><span class="bound"><span class="entity">dmusj</span></span></span> <span class="bound">dll1</span> <span class="bound">l1</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">dmusi</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">dmusj</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">div</span> 
          <span class="bound">dll1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> sigma_array.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">partial_function</span></span><span class="main">(</span>tailrec<span class="main">)</span> <span class="entity">dmu_array_row_main</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dmu_array_row_main</span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span>
     <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">sj</span> <span class="main">=</span> Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">;</span> 
       <span class="bound">dmus_i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
       <span class="bound">djj</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">;</span>
       <span class="bound">dmu_ij</span> <span class="main">=</span> <span class="bound">djj</span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fi</span></span></span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!!</span> <span class="bound">sj</span><span class="main">)</span> <span class="main">-</span> sigma_array <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="bound">dmus_i</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="main">!!</span> <span class="bound">sj</span><span class="main">)</span> <span class="bound">djj</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">;</span>
       <span class="bound">dmus'</span> <span class="main">=</span> iarray_update <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>iarray_append <span class="bound">dmus_i</span> <span class="bound">dmu_ij</span><span class="main">)</span>
      <span class="keyword1">in</span> <span class="free">dmu_array_row_main</span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">dmus'</span> <span class="bound">sj</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dmu_array_row</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dmu_array_row</span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">fi</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">in</span> 
      dmu_array_row_main <span class="bound">fi</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>iarray_append <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="main">(</span>IArray <span class="main">[</span><span class="bound">fi</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!!</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>tailrec<span class="main">)</span> <span class="entity">dmu_array</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dmu_array</span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="keyword1">else</span> 
    <span class="keyword1">let</span> <span class="bound">dmus'</span> <span class="main">=</span> dmu_array_row <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> 
      <span class="keyword1">in</span> <span class="free">dmu_array</span> <span class="bound">dmus'</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dμ_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec list <span class="main">⇒</span> int iarray iarray"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dμ_impl</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> dmu_array <span class="main">(</span>IArray <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">(</span>IArray <span class="main">[]</span><span class="main">)</span> <span class="main">0</span>"</span></span> 


<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gram_schmidt<span class="main">)</span> <span class="entity">β</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Gramian_determinant <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">/</span> Gramian_determinant <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> gram_schmidt_fs_lin_indpt
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-Gramian_beta"><span class="command">lemma</span></span> Gramian_beta<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"β <span class="free">fs</span> <span class="free">i</span> <span class="main">=</span> <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">.</span> <span class="main">(</span>μ <span class="free">i</span> <span class="bound">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> M.sumlist_carrier gso_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"β <span class="free">fs</span> <span class="free">i</span> <span class="main">=</span> gso <span class="free">i</span> <span class="main">∙</span> gso <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> β_def
    <span class="keyword1"><span class="command">using</span></span> assms dist <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gramian_determinant_div sq_norm_vec_as_cscalar_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?S</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gso.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gso.simps<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?S</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?S</span> <span class="main">+</span> <span class="var">?S</span> <span class="main">∙</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_scalar_prod_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span> scalar_prod_add_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?S</span> <span class="main">=</span> <span class="var">?S</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> comm_scalar_prod<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fi S<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?S</span> <span class="main">∙</span> gso <span class="free">i</span> <span class="main">-</span> <span class="var">?S</span> <span class="main">∙</span> <span class="var">?S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> gso <span class="free">i</span> <span class="main">-</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> assms S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gso.simps<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_scalar_prod_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span> scalar_prod_minus_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">∙</span> gso <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms orthogonal
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> scalar_prod_left_sum_distrib<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_list_neutral M.sumlist_carrier gso_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">∙</span> <span class="var">?S</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">.</span> <span class="main">(</span>μ <span class="free">i</span> <span class="bound">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span>gso <span class="bound">j</span> <span class="main">∙</span> gso <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms dist <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> scalar_prod_lincomb_gso<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square interv_sum_list_conv_sum_set_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">.</span> <span class="main">(</span>μ <span class="free">i</span> <span class="bound">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms dist
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> β_def Gramian_determinant_div sq_norm_vec_as_cscalar_prod
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-gso_norm_beta"><span class="command">lemma</span></span> gso_norm_beta<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"β <span class="free">fs</span> <span class="free">j</span> <span class="main">=</span> sq_norm <span class="main">(</span>gso <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> β_def
  <span class="keyword1"><span class="command">using</span></span> assms dist <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gramian_determinant_div sq_norm_vec_as_cscalar_prod<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_Int-mu_Gramian_beta_def"><span class="command">lemma</span></span> mu_Gramian_beta_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"μ <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">.</span> μ <span class="free">j</span> <span class="bound">k</span> <span class="main">*</span> μ <span class="free">i</span> <span class="bound">k</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> β <span class="free">fs</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">ja</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">ja</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">ja</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?neg_sum</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ja</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">j</span> <span class="bound">ja</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">ja</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> list<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="var">?list</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gso_carrier assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fi</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fi</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> list_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> neq0_conv upt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> upt_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"μ <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>gso <span class="free">j</span><span class="main">)</span> <span class="main">/</span> sq_norm <span class="main">(</span>gso <span class="free">j</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> μ.simps <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">...</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">+</span> <span class="var">?neg_sum</span><span class="main">)</span> <span class="main">/</span> sq_norm <span class="main">(</span>gso <span class="free">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gso.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">fi</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">+</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?neg_sum</span><span class="main">)</span> <span class="main">/</span> sq_norm <span class="main">(</span>gso <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fi_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> scalar_prod_add_distrib <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> M.sumlist_carrier gso_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> gso <span class="free">i</span> <span class="main">+</span> M.sumlist <span class="var">?list</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fs_by_gso_def<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">∙</span> <span class="var">?neg_sum</span> <span class="main">=</span> gso <span class="free">i</span> <span class="main">∙</span> <span class="var">?neg_sum</span> <span class="main">+</span> M.sumlist <span class="var">?list</span> <span class="main">∙</span> <span class="var">?neg_sum</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> add_scalar_prod_distrib <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> M.sumlist_carrier gso_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" M.sumlist <span class="var">?list</span> <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ja</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">ja</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">ja</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span><span class="main">)</span> 
     <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ja</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">ja</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">ja</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span> "</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?sumj</span> <span class="main">+</span> <span class="var">?sumi</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_id
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> M.sumlist_append<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gso_carrier assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gso <span class="free">i</span> <span class="main">∙</span> <span class="var">?neg_sum</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orthogonal_sumlist<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gso_carrier dist assms orthogonal<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="var">?sumj</span> <span class="main">+</span> <span class="var">?sumi</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?neg_sum</span> <span class="main">=</span> <span class="var">?sumj</span> <span class="main">∙</span> <span class="var">?neg_sum</span> <span class="main">+</span> <span class="var">?sumi</span> <span class="main">∙</span> <span class="var">?neg_sum</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> add_scalar_prod_distrib <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> M.sumlist_carrier gso_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="var">?sumj</span> <span class="main">∙</span> <span class="var">?neg_sum</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">.</span> <span class="main">(</span>μ <span class="free">i</span> <span class="bound">l</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span>μ <span class="free">j</span> <span class="bound">l</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>gso <span class="bound">l</span> <span class="main">∙</span> gso <span class="bound">l</span><span class="main">)</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> scalar_prod_lincomb_gso<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interv_sum_list_conv_sum_set_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">.</span> <span class="main">(</span>μ <span class="free">i</span> <span class="bound">l</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>μ <span class="free">j</span> <span class="bound">l</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>gso <span class="bound">l</span> <span class="main">∙</span> gso <span class="bound">l</span><span class="main">)</span><span class="main">)</span> "</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">-</span> <span class="var">?sum</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_negf<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">.</span> <span class="main">(</span>μ <span class="free">j</span> <span class="bound">l</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>μ <span class="free">i</span> <span class="bound">l</span><span class="main">)</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">l</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gso_norm_beta sq_norm_vec_as_cscalar_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sumi</span> <span class="main">∙</span> <span class="var">?neg_sum</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> orthogonal_sumlist<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gso_carrier assms orthogonal<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> M.sumlist_carrier gso_carrier<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> comm_scalar_prod<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> M.sumlist_carrier<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> orthogonal_sumlist<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> dist <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="free">j</span><span class="main">)</span> <span class="main">=</span> β <span class="free">fs</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gso_norm_beta<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gram_schmidt<span class="main">)</span> Gramian_matrix_alt_alt_alt_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Gramian_matrix <span class="free">fs</span> <span class="free">k</span> <span class="main">=</span> mat <span class="free">k</span> <span class="free">k</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"vec <span class="free">n</span> <span class="main">(</span><span class="main">($)</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> carrier_vecD dim_vec eq_vecI index_vec nth_mem subsetCE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Gramian_matrix_def <span class="keyword1"><span class="command">using</span></span>  assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_matI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gram_schmidt_fs_Rn<span class="main">)</span> Gramian_determinant_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Gramian_determinant <span class="free">fs</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="main">0</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Gramian_determinant <span class="free">fs</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Gramian_determinant_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> det_def'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gramian_matrix_def Let_def scalar_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sq_norm_vec_as_cscalar_prod<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">context</span></span> gram_schmidt_fs_lin_indpt
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">μ'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ'</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> d <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">*</span> μ <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span> 


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">σ</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span>d <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">+</span> μ' <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">*</span> μ' <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">/</span> d <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span> 

<span class="keyword1" id="Gram_Schmidt_Int-d_Suc"><span class="command">lemma</span></span> d_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"d <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> μ' <span class="free">i</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> μ'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> μ.simps<span class="main">)</span>
<span class="keyword1" id="Gram_Schmidt_Int-d_0"><span class="command">lemma</span></span> d_0<span class="main">:</span> <span class="quoted"><span class="quoted">"d <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Gramian_determinant_0<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_Int-σ"><span class="command">lemma</span></span> σ<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> lj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"σ <span class="free">l</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> d <span class="free">l</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">k</span> <span class="main">*</span> μ <span class="free">j</span> <span class="bound">k</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lj
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> lj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> m"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> lj<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">k</span> <span class="main">*</span> μ <span class="free">j</span> <span class="bound">k</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> dl0<span class="main">:</span> <span class="quoted"><span class="quoted">"d <span class="skolem">l</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lj Gramian_determinant dist <span class="keyword1"><span class="command">unfolding</span></span> lin_indpt_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"σ <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span>d <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> σ <span class="skolem">l</span> <span class="free">i</span> <span class="free">j</span> <span class="main">+</span> μ' <span class="free">i</span> <span class="skolem">l</span> <span class="main">*</span> μ' <span class="free">j</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">/</span> d <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>d <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> σ <span class="skolem">l</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">/</span> d <span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span>μ' <span class="free">i</span> <span class="skolem">l</span> <span class="main">*</span> μ' <span class="free">j</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">/</span> d <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dl0 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ' <span class="free">i</span> <span class="skolem">l</span> <span class="main">*</span> μ' <span class="free">j</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">/</span> d <span class="skolem">l</span> <span class="main">=</span> d <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> <span class="var">?f</span> <span class="skolem">l</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?one</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> β_def μ'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>d <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> σ <span class="skolem">l</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">/</span> d <span class="skolem">l</span> <span class="main">=</span> d <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">l</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?sum</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> dl0 <span class="keyword1"><span class="command">unfolding</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">+</span> <span class="var">?one</span> <span class="main">=</span> d <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">l</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">l</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> Suc <span class="skolem">l</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_Int-μ'"><span class="command">lemma</span></span> μ'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"μ' <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> d <span class="free">j</span> <span class="main">*</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">-</span> σ <span class="free">j</span> <span class="free">i</span> <span class="free">j</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> j<span class="main">:</span> True
  <span class="keyword1"><span class="command">have</span></span> dsj<span class="main">:</span> <span class="quoted"><span class="quoted">"d <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j i Gramian_determinant dist <span class="keyword1"><span class="command">unfolding</span></span> lin_indpt_list_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> less_trans_Suc nat_less_le<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sum</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">.</span> μ <span class="free">j</span> <span class="bound">k</span> <span class="main">*</span> μ <span class="free">i</span> <span class="bound">k</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"μ' <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">-</span> <span class="var">?sum</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>d <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">/</span> β <span class="free">fs</span> <span class="free">j</span><span class="main">)</span>"</span></span>     
    <span class="keyword1"><span class="command">unfolding</span></span> mu_Gramian_beta_def<span class="main">[</span><span class="operator">OF</span> j i<span class="main">]</span> μ'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">/</span> β <span class="free">fs</span> <span class="free">j</span> <span class="main">=</span> d <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> β_def <span class="keyword1"><span class="command">using</span></span> dsj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">-</span> <span class="var">?sum</span><span class="main">)</span> <span class="main">*</span> d <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> d <span class="free">j</span> <span class="main">-</span> d <span class="free">j</span> <span class="main">*</span> <span class="var">?sum</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="free">j</span> <span class="main">*</span> <span class="var">?sum</span> <span class="main">=</span> σ <span class="free">j</span> <span class="free">i</span> <span class="free">j</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> σ<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">insert</span> j i<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> j <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dsi<span class="main">:</span> <span class="quoted"><span class="quoted">"d <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"d <span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i Suc_leI dist  <span class="keyword1"><span class="command">unfolding</span></span> lin_indpt_list_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_leI Gramian_determinant<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sum</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">k</span> <span class="main">*</span> μ <span class="free">i</span> <span class="bound">k</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> bzero<span class="main">:</span> <span class="quoted"><span class="quoted">"β <span class="free">fs</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> β_def <span class="keyword1"><span class="command">using</span></span> dsi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"μ' <span class="free">i</span> <span class="free">i</span> <span class="main">=</span> d <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> μ.simps μ'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> β <span class="free">fs</span> <span class="free">i</span> <span class="main">*</span> <span class="main">(</span>d <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>  <span class="main">/</span> β <span class="free">fs</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">/</span> β <span class="free">fs</span> <span class="free">i</span> <span class="main">=</span> d <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> β_def <span class="keyword1"><span class="command">using</span></span> dsi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"β <span class="free">fs</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="var">?sum</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Gramian_beta<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(-)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ sum.cong<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square sq_norm_vec_as_cscalar_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="var">?sum</span><span class="main">)</span> <span class="main">*</span> d <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> d <span class="free">i</span> <span class="main">-</span> d <span class="free">i</span> <span class="main">*</span> <span class="var">?sum</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="free">i</span> <span class="main">*</span> <span class="var">?sum</span> <span class="main">=</span> σ <span class="free">i</span> <span class="free">i</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> σ<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">insert</span> i i<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-σ_via_μ'"><span class="command">lemma</span></span> σ_via_μ'<span class="main">:</span> <span class="quoted"><span class="quoted">"σ <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">l</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> μ' <span class="free">i</span> <span class="main">0</span> <span class="main">*</span> μ' <span class="free">j</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">(</span>μ' <span class="free">l</span> <span class="free">l</span> <span class="main">*</span> σ <span class="free">l</span> <span class="free">i</span> <span class="free">j</span> <span class="main">+</span> μ' <span class="free">i</span> <span class="free">l</span> <span class="main">*</span> μ' <span class="free">j</span> <span class="free">l</span><span class="main">)</span> <span class="main">/</span> μ' <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_Suc<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_Int-μ'_via_σ"><span class="command">lemma</span></span> μ'_via_σ<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"μ' <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="keyword1">else</span> μ' <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">-</span> σ <span class="free">j</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> μ'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_Suc<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_Int-fs_i_sumlist_κ"><span class="command">lemma</span></span> fs_i_sumlist_κ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span>
        <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms gso_carrier assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> κ_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dim_sumlist sumlist_nth sum_negf<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="free">l</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fi_is_sum_of_mu_gso<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span>
                  M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="free">l</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">l</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_zero le_imp_less_Suc length_upt list_trisect upt_conv_Cons<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> map_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sumlist_append<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> gso_carrier assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms gso_carrier assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> dim_sumlist<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
                M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="free">l</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∙</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms gso_carrier assms <span class="keyword1"><span class="command">unfolding</span></span> lin_indpt_list_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> scalar_prod_left_sum_distrib<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> dim_sumlist gso_scalar_zero <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_list_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* gram_schmidt_fs_lin_indpt *)</span>

<span class="keyword1"><span class="command">context</span></span> gram_schmidt_fs_int
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1" id="Gram_Schmidt_Int-β_pos"><span class="command">lemma</span></span> β_pos <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m <span class="main">⟹</span> β <span class="free">fs</span> <span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Gramian_determinant<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> lin_indpt_list_def β_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_Int-β_zero"><span class="command">lemma</span></span> β_zero <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m <span class="main">⟹</span> β <span class="free">fs</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> β_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Gram_Schmidt_Int-σ_integer"><span class="command">lemma</span></span> σ_integer<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"σ <span class="free">l</span> <span class="free">i</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> ll<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> m"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> fs_carr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> m <span class="main">⟹</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="keyword1"><span class="command">using</span></span> assms fs_carrier <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> fs_carr_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dim_gso<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> m <span class="main">⟹</span> dim_vec <span class="main">(</span>gso <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> gso_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dim_fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> m <span class="main">⟹</span> dim_vec <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="keyword1"><span class="command">using</span></span> smult_carrier_vec fs_carr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> i_l_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">⟹</span> <span class="skolem">i</span> <span class="main">&lt;</span> m"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> smult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
    <span class="keyword1"><span class="command">using</span></span> i_l_m dim_fs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"σ <span class="free">l</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> d <span class="free">l</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">k</span> <span class="main">*</span> μ <span class="free">j</span> <span class="bound">k</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> σ<span class="main">[</span><span class="operator">OF</span> ll<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">...</span> <span class="main">=</span> d <span class="free">l</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>gso <span class="bound">k</span><span class="main">)</span> <span class="main">/</span>  sq_norm <span class="main">(</span>gso <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">*</span> <span class="var">?sum</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> μ.simps <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">=</span>  <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>gso <span class="bound">k</span><span class="main">)</span> <span class="main">/</span>  β <span class="free">fs</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gso_norm_beta<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>gso <span class="bound">k</span><span class="main">)</span> <span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> β_zero assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">∙</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>μ <span class="free">i</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>gso <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span> <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms fs_carr<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> gso_carrier
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> scalar_prod_right_sum_distrib<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gso_carrier fs_carr sum.cong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_list_sum_nth<span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="free">l</span> <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>d <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>μ <span class="free">i</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>gso <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">∙</span> <span class="main">(</span><span class="main">_</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?sum2</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> scalar_prod_smult_distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fs_carr<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms gso_carrier
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sumlist_carrier<span class="main">)</span>

	  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum2</span> <span class="main">=</span> <span class="main">-</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> μ <span class="free">i</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>gso <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span>"</span></span>
	    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main">)</span>
	    <span class="keyword1"><span class="command">using</span></span> fs_carr gso_carrier assms i_l_m
	    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_negf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> dim_sumlist sumlist_nth dim_gso <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>

	  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">-</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span>"</span></span>
	    <span class="keyword1"><span class="command">using</span></span> assms gso_carrier assms 
	    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> κ_def<span class="main">)</span>
	    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

	  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>d <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">-</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
		     <span class="main">(</span><span class="main">-</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>d <span class="free">l</span> <span class="main">*</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
	    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main">)</span>
	    <span class="keyword1"><span class="command">using</span></span> fs_carr smult_carrier_vec dim_fs
	    <span class="keyword1"><span class="command">using</span></span> dim_fs i_l_m 
	    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smult dim_sumlist sumlist_nth sum_distrib_left <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>

	  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">" σ <span class="free">l</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∙</span> <span class="main">-</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> d <span class="free">l</span> <span class="main">*</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span> "</span></span> <span class="keyword1"><span class="command">.</span></span>
	  <span class="comment1">(* now we are able to apply d_κ_int *)</span>
	  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"σ <span class="free">l</span> <span class="free">i</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id
	    <span class="keyword1"><span class="command">using</span></span> i_l_m fs_carr assms fs_int d_κ_Ints
	    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dim_sumlist sumlist_nth smult 
	        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sumlist_carrier Ints_minus Ints_sum Ints_mult<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="main">_</span> <span class="main">$</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span>  Ints_scalar_prod<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fs_carr<span class="main"><span class="main">]</span></span><span class="main">)</span>
	<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* gram_schmidt_fs_int *)</span>



<span class="keyword1"><span class="command">context</span></span> fs_int_indpt
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">σs</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">μ'</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">σs</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free">μ'</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span> <span class="main">*</span> <span class="free">μ'</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">0</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">σs</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">μ'</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="free">σs</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">+</span> <span class="free">μ'</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="free">μ'</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">μ'</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">μ'</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">fs</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">else</span> <span class="free">μ'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="free">σs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> μ'.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Gram_Schmidt_Int-σs_μ'"><span class="command">lemma</span></span> σs_μ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> m <span class="main">⟹</span> of_int <span class="main">(</span>σs <span class="free">l</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> gs.σ <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> of_int <span class="main">(</span>μ'  <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> gs.μ' <span class="free">i</span> <span class="free">j</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> σs_μ'.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>                          
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gs.σ.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">l</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.σ<span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.σ_integer<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> 2 gs.fs_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>μ' <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> σs <span class="skolem">l</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> μ' <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> μ' <span class="skolem">j</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> rat_of_int <span class="main">(</span>μ' <span class="skolem">l</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 gs.d_Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>σs <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> 
             of_int <span class="main">(</span>μ' <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> σs <span class="skolem">l</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> μ' <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> μ' <span class="skolem">j</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> of_int <span class="main">(</span>μ' <span class="skolem">l</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> σs.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> exact_division<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> gs.σ <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 gs.d_Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> dim_vec <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 3 f_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> f_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> carrier_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int_hom.vec_hom <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">=</span> rat_of_int <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"of_int_hom.vec_hom <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∙</span> of_int_hom.vec_hom <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> rat_of_int <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scalar_prod_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> dim_vec <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 f_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> f_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> carrier_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"of_int_hom.vec_hom <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">=</span> rat_of_int <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ' <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> μ'.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> *<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"of_int_hom.vec_hom <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> map of_int_hom.vec_hom <span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gs.μ'_via_σ<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.μ' <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> gs.μ' <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>rat_of_int <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> gs.σ <span class="skolem">j</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * False 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gs.μ'_via_σ<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> False 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> μ'.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
	<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gram_Schmidt_Int-μ'"><span class="command">lemma</span></span> μ'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"μ' <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> dμ <span class="free">i</span> <span class="free">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">⟹</span> μ' <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted">rat_of_int</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> m"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> dμ <span class="main">=</span> dμ<span class="main">[</span><span class="operator">OF</span> this assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>μ' <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> gs.μ' <span class="free">i</span> <span class="free">j</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> σs_μ' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>dμ <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gs.μ'_def dμ
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> of_int_Gramian_determinant<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms fs_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"μ' <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> dμ <span class="free">i</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>μ' <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>dμ <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dμ <span class="keyword1"><span class="command">unfolding</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gs.μ.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"μ' <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-sigma_array"><span class="command">lemma</span></span> sigma_array<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> mm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mm</span> <span class="main">≤</span> m"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">mm</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> sigma_array <span class="main">(</span>IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> IArray.of_fun <span class="main">(</span>μ' <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">mm</span> <span class="keyword1">then</span> Suc <span class="free">j</span> <span class="keyword1">else</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">mm</span><span class="main">)</span><span class="main">)</span>
	     <span class="main">(</span>IArray.of_fun <span class="main">(</span>μ' <span class="free">mm</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IArray.of_fun <span class="main">(</span>μ' <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> Suc <span class="free">j</span> <span class="main">=</span> <span class="free">mm</span> <span class="keyword1">then</span> Suc <span class="free">j</span> <span class="keyword1">else</span> Suc <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>μ' <span class="free">l</span> <span class="free">l</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span>
	    σs <span class="free">l</span> <span class="free">mm</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> σs.simps sigma_array.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> mm j <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ineq<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">l</span> <span class="main">&lt;</span> Suc <span class="free">mm</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> Suc <span class="free">mm</span>"</span></span> 
    <span class="quoted"><span class="quoted">"Suc <span class="skolem">l</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">if</span> Suc <span class="skolem">l</span> <span class="main">=</span> <span class="free">mm</span> <span class="keyword1">then</span> Suc <span class="free">j</span> <span class="keyword1">else</span> Suc <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"Suc <span class="skolem">l</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">if</span> Suc <span class="free">j</span> <span class="main">=</span> <span class="free">mm</span> <span class="keyword1">then</span> Suc <span class="free">j</span> <span class="keyword1">else</span> Suc <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">l</span> <span class="main">=</span> <span class="free">mm</span> <span class="keyword1">then</span> Suc <span class="free">j</span> <span class="keyword1">else</span> Suc <span class="skolem">l</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"Suc <span class="skolem">l</span> <span class="main">&lt;</span> Suc <span class="free">j</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> mm l j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> l<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sigma_array.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">l</span>"</span></span><span class="main">]</span> id if_False Let_def IH
	    of_fun_nth<span class="main">[</span><span class="operator">OF</span> ineq<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> ineq<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> ineq<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> 
	    of_fun_nth<span class="main">[</span><span class="operator">OF</span> ineq<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> ineq<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> ineq<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span>
	  <span class="keyword1"><span class="command">unfolding</span></span> σs.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-dmu_array_row_main"><span class="command">lemma</span></span> dmu_array_row_main<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> mm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mm</span> <span class="main">≤</span> m"</span></span> <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">mm</span> <span class="main">⟹</span> dmu_array_row_main <span class="main">(</span>IArray <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>IArray <span class="free">fs</span> <span class="main">!!</span>  <span class="free">mm</span><span class="main">)</span> <span class="free">mm</span>
	    <span class="main">(</span>IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> IArray.of_fun <span class="main">(</span>μ' <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">mm</span> <span class="keyword1">then</span> Suc <span class="free">j</span> <span class="keyword1">else</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">mm</span><span class="main">)</span><span class="main">)</span>    
	     <span class="free">j</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> IArray.of_fun <span class="main">(</span>μ' <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">mm</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">mm</span> <span class="main">-</span> <span class="free">j</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dmu_array_row_main.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> prems<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">mm</span> <span class="main">-</span> Suc <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="free">mm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">mm</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prems<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span> <span class="main">=</span> <span class="free">mm</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mm</span> <span class="main">=</span> <span class="free">mm</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id2<span class="main">:</span> <span class="quoted"><span class="quoted">"IArray.of_fun <span class="main">(</span>μ' <span class="free">mm</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> IArray <span class="main">(</span>map <span class="main">(</span>μ' <span class="free">mm</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> id3<span class="main">:</span> <span class="quoted"><span class="quoted">"IArray <span class="free">fs</span> <span class="main">!!</span> <span class="free">mm</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">mm</span>"</span></span> <span class="quoted"><span class="quoted">"IArray <span class="free">fs</span> <span class="main">!!</span> Suc <span class="skolem">j</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> Suc <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="free">mm</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mm</span> <span class="main">&lt;</span> Suc <span class="free">mm</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="free">mm</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">mm</span> <span class="keyword1">then</span> Suc <span class="skolem">j</span> <span class="keyword1">else</span> Suc <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dmu_array_row_main.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> 
      IH<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> Let_def id if_True if_False id3
      of_fun_nth<span class="main">[</span><span class="operator">OF</span> le<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> le<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      of_fun_nth<span class="main">[</span><span class="operator">OF</span> le<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> le<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
      of_fun_nth<span class="main">[</span><span class="operator">OF</span> le<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>  
      sigma_array<span class="main">[</span><span class="operator">OF</span> mm j le_refl<span class="main">,</span> <span class="operator">folded</span> id2<span class="main">]</span>
      iarray_length_of_fun iarray_update_of_fun iarray_append_of_fun
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> dmu_array_row_main <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iarray_cong'<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> j 1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">mm</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> μ'.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-dmu_array_row"><span class="command">lemma</span></span> dmu_array_row<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> mm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mm</span> <span class="main">≤</span> m"</span></span> <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"dmu_array_row <span class="main">(</span>IArray <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> IArray.of_fun <span class="main">(</span>μ' <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">mm</span><span class="main">)</span> <span class="free">mm</span> <span class="main">=</span>
	    IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> IArray.of_fun <span class="main">(</span>μ' <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">mm</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">mm</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dmu_array_row_def Let_def dmu_array_row_main<span class="main">[</span><span class="operator">OF</span> assms 0<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> iarray_append.simps IArray.of_fun_def id map_append list.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> dmu_array_row_main <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>IArray <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> 
	      <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append μ'.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-dmu_array"><span class="command">lemma</span></span> dmu_array<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">mm</span> <span class="main">≤</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dmu_array <span class="main">(</span>IArray <span class="free">fs</span><span class="main">)</span> m <span class="main">(</span>IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> μ' <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">mm</span><span class="main">)</span> <span class="free">mm</span> 
	  <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> μ' <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> m"</span></span> 
	<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mm</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_measure<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">mm</span></span><span class="main"><span class="main">.</span></span> m <span class="main"><span class="main">-</span></span> <span class="bound"><span class="bound">mm</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">mm</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">mm</span> <span class="main">=</span> m"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dmu_array.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">mm</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> 1<span class="main">(</span>2-<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> mm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mm</span> <span class="main">≤</span> m"</span></span> <span class="keyword2"><span class="keyword">and</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">mm</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">mm</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">mm</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">mm</span> <span class="main">=</span> m<span class="main">)</span> <span class="main">=</span> False"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> prems<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">mm</span><span class="main">,</span> <span class="skolem">mm</span><span class="main">)</span> <span class="main">∈</span> measure <span class="main">(</span><span class="main">(-)</span> m<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">mm</span> <span class="main">≤</span> m"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">mm</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> <span class="skolem">mm</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">mm</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> prems<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dmu_array.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">mm</span></span><span class="main">]</span> id if_False Let_def 
      <span class="keyword1"><span class="command">unfolding</span></span> dmu_array_row<span class="main">[</span><span class="operator">OF</span> mm<span class="main">]</span> IH<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> dmu_array <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iarray_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-dμ_impl"><span class="command">lemma</span></span> dμ_impl<span class="main">:</span> <span class="quoted"><span class="quoted">"dμ_impl <span class="free">fs</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> dμ <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> m"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> dμ_impl_def <span class="keyword1"><span class="command">using</span></span> dmu_array<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> μ'<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* fs_int_indpt *)</span>

<span class="keyword1"><span class="command">context</span></span> gram_schmidt_fs_int
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-N_μ'"><span class="command">lemma</span></span> N_μ'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ' <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> Suc <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> N <span class="main">*</span> N <span class="main">^</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms N_1 one_le_power<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> d <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Gramian_determinant<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> d <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">have</span></span> N_d<span class="main">:</span> <span class="quoted"><span class="quoted">"d <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> N_d<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ' <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span>d <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>d <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>μ <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> μ'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span>d <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>d <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> μ.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> N_mu assms that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span>μ <span class="free"><span class="free"><span class="free">i</span></span></span> <span class="free"><span class="free"><span class="free">j</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main"><span class="hidden">⇧</span><sup>2</sup></span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms 1 N_d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"N <span class="main">^</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">=</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nat_pow_distrib nat_pow_pow power3_eq_cube <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-N_σ"><span class="command">lemma</span></span> N_σ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>σ <span class="free">l</span> <span class="free">i</span> <span class="free">j</span><span class="main">¦</span> <span class="main">≤</span> of_nat <span class="free">l</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">l</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>d <span class="free">l</span><span class="main">¦</span> <span class="main">=</span> d <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Gramian_determinant<span class="main">(</span>2<span class="main">)</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_of_pos<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>σ <span class="free">l</span> <span class="free">i</span> <span class="free">j</span><span class="main">¦</span> <span class="main">=</span> d <span class="free">l</span> <span class="main">*</span> <span class="main">¦</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">l</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">k</span> <span class="main">*</span> μ <span class="free">j</span> <span class="bound">k</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> σ<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> abs_mult<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">l</span> <span class="main">*</span> <span class="main">(</span>of_nat <span class="free">l</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">l</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">k</span> <span class="main">*</span> μ <span class="free">j</span> <span class="bound">k</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span><span class="main">¦</span> <span class="main">≤</span> of_nat <span class="free">l</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> β <span class="free">fs</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>gso <span class="skolem">k</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> N"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
        <span class="keyword1"><span class="command">using</span></span> that assms N_gso β_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> N <span class="main">*</span> N <span class="main">^</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
        <span class="keyword1"><span class="command">using</span></span> N_ge_0 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span><span class="main">.</span> μ <span class="free">i</span> <span class="bound">k</span> <span class="main">*</span> μ <span class="free">j</span> <span class="bound">k</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span><span class="main">.</span> <span class="main">¦</span>μ <span class="free">i</span> <span class="bound">k</span> <span class="main">*</span> μ <span class="free">j</span> <span class="bound">k</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span><span class="main">¦</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sum_abs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span><span class="main">.</span> <span class="main">¦</span>μ <span class="free">i</span> <span class="bound">k</span> <span class="main">*</span> μ <span class="free">j</span> <span class="bound">k</span><span class="main">¦</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gso_norm_beta abs_mult_pos sq_norm_vec_ge_0<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span><span class="main">.</span> <span class="main">¦</span>μ <span class="free">i</span> <span class="bound">k</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span>μ <span class="free">j</span> <span class="bound">k</span><span class="main">¦</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> abs_mult <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span><span class="main">.</span> <span class="main">(</span>max <span class="main">¦</span>μ <span class="free">i</span> <span class="bound">k</span><span class="main">¦</span> <span class="main">¦</span>μ <span class="free">j</span> <span class="bound">k</span><span class="main">¦</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>max <span class="main">¦</span>μ <span class="free">i</span> <span class="bound">k</span><span class="main">¦</span> <span class="main">¦</span>μ <span class="free">j</span> <span class="bound">k</span><span class="main">¦</span><span class="main">)</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_mono mult_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span><span class="main">.</span> <span class="main">(</span>max <span class="main">¦</span>μ <span class="free">i</span> <span class="bound">k</span><span class="main">¦</span> <span class="main">¦</span>μ <span class="free">j</span> <span class="bound">k</span><span class="main">¦</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span><span class="main">.</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> β <span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms N_mu<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> N_mu<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> assms
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_mono mult_right_mono <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span><span class="main">.</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> N<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gso_norm_beta <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_mono mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span><span class="main">.</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">*</span> N<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms N_1 N_ge_0 assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_mono mult_right_mono power_increasing<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_nat <span class="free">l</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms N_d N_ge_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_mono zero_le_power<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_nat <span class="free">l</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">l</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> mult_2_right <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-leq_squared"><span class="command">lemma</span></span> leq_squared<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">z</span><span class="main">::</span>int<span class="main">)</span> <span class="main">≤</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">z</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> self_le_power<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-abs_leq_squared"><span class="command">lemma</span></span> abs_leq_squared<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">z</span><span class="main">::</span>int<span class="main">¦</span> <span class="main">≤</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> leq_squared<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">z</span><span class="main">¦</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* gram_schmidt_fs_int *)</span>

<span class="keyword1"><span class="command">context</span></span> gram_schmidt_fs_int
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gso'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gso'</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> d <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>gso <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">a</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> d <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="main">(</span>d <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">a</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span> μ' <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso' <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-gso'_carrier_vec"><span class="command">lemma</span></span> gso'_carrier_vec<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gso' <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gso'_def<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_Int-a_carrier_vec"><span class="command">lemma</span></span> a_carrier_vec<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a <span class="free">i</span> <span class="free">l</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gso'_def<span class="main">)</span>

<span class="keyword1" id="Gram_Schmidt_Int-a_l"><span class="command">lemma</span></span> a_l<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a <span class="free">i</span> <span class="free">l</span> <span class="main">=</span> d <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> l_i_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> <span class="skolem">l</span> <span class="main">&lt;</span> m"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sum</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">]</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?term</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> μ <span class="free">i</span> <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="skolem">l</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> carr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?a</span><span class="main">,</span><span class="var">?sum</span><span class="main">,</span><span class="var">?term</span><span class="main">}</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> gso_dim l_i_m Suc<span class="main">(</span>2<span class="main">)</span> sumlist_dim assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sumlist_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a <span class="free">i</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">1</span> <span class="main">/</span> d <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="main">(</span>d <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>d <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">-</span> <span class="main">(</span> μ' <span class="free">i</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso' <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a.simps Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> d <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="main">(</span>d <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>d <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">+</span> <span class="main">-</span>d <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">i</span> <span class="skolem">l</span> <span class="main">*</span> d <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="skolem">l</span> <span class="main">)</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="var">?t1</span> <span class="main">+</span> <span class="var">?t2</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> μ'_def gso'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t2</span> <span class="main">=</span> d <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="main">-</span>d <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">i</span> <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="skolem">l</span> <span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> d <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?tt2</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> smult_smult_assoc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t1</span> <span class="main">=</span> d <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="main">(</span>d <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> d <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?tt1</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> smult_smult_assoc smult_smult_assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?tt1</span> <span class="main">+</span> d <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?tt2</span> <span class="main">=</span> d <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="var">?tt1</span> <span class="main">+</span> <span class="var">?tt2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gso_carrier l_i_m Suc fsi 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smult_add_distrib_vec<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span> add_carrier_vec sumlist_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">/</span> d <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">…</span> <span class="main">=</span> <span class="main">(</span>d <span class="skolem">l</span> <span class="main">/</span> d <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="var">?tt1</span> <span class="main">+</span> <span class="var">?tt2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="skolem">l</span> <span class="main">/</span> d <span class="skolem">l</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> Gramian_determinant<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> l_i_m Suc <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="var">?tt1</span> <span class="main">+</span> <span class="var">?tt2</span><span class="main">)</span> <span class="main">=</span> <span class="var">?tt1</span> <span class="main">+</span> <span class="var">?tt2</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?tt2</span> <span class="main">=</span> d <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="main">-</span> μ <span class="free">i</span> <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?sum</span><span class="main">)</span> <span class="main">+</span> <span class="main">…</span> <span class="main">=</span>
             d <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?sum</span> <span class="main">+</span> <span class="var">?term</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> carr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> smult_add_distrib_vec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?a</span> <span class="main">+</span> <span class="var">?sum</span><span class="main">)</span> <span class="main">+</span> <span class="var">?term</span> <span class="main">=</span> <span class="var">?a</span> <span class="main">+</span> <span class="main">(</span><span class="var">?sum</span> <span class="main">+</span> <span class="var">?term</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> carr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?term</span> <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="skolem">l</span><span class="main">..&lt;</span>Suc <span class="skolem">l</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gso_carrier Suc l_i_m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">+</span> <span class="main">...</span> <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">l</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> sumlist_append<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> fsi l_i_m Suc sumlist_carrier gso_carrier <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sumlist_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-a_l'"><span class="command">lemma</span></span> a_l'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a <span class="free">i</span> <span class="free">i</span> <span class="main">=</span> gso' <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a <span class="free">i</span> <span class="free">i</span> <span class="main">=</span> d <span class="free">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a_l assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> d <span class="free">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gso.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a <span class="free">i</span> <span class="free">i</span> <span class="main">=</span> gso' <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gso'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a <span class="free">i</span> <span class="free">l'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">l'</span> <span class="keyword1">of</span>
         <span class="main">0</span> <span class="main">⇒</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">|</span>
         Suc <span class="bound">l</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> d <span class="bound">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>d <span class="main">(</span>Suc <span class="bound">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>a <span class="free">i</span> <span class="bound">l</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>μ' <span class="free">i</span> <span class="bound">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> a <span class="bound">l</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a <span class="free">i</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> d <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="main">(</span>d <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>a <span class="free">i</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span> μ' <span class="free">i</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> a <span class="skolem">l</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms a_l Suc <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> a_l'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gram_Schmidt_Int-a_Ints"><span class="command">lemma</span></span> a_Ints<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a <span class="free">i</span> <span class="free">l</span> <span class="main">$</span> <span class="free">k</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a <span class="free">i</span> <span class="free">l</span> <span class="main">=</span> d <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> μ <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="main">_</span> <span class="main">+</span> <span class="var">?sum</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> a_l<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">=</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms gso_carrier
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> κ_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
           <span class="main">=</span> d <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> d <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">+</span> <span class="var">?sum</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> sumlist_carrier fsi <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span>
      <span class="main">(</span><span class="operator">subst</span> smult_add_distrib_vec<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">using</span></span> assms fsi <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">=</span> sumlist  <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>d <span class="free">l</span> <span class="main">*</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> eq_vecI sumlist_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> fsi assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dim_sumlist sum_distrib_left sumlist_nth smult_smult_assoc <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a <span class="free">i</span> <span class="free">l</span> <span class="main">=</span> d <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> sumlist  <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>d <span class="free">l</span> <span class="main">*</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"a <span class="free">i</span> <span class="free">l</span> <span class="main">$</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span>d <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>d <span class="free">l</span> <span class="main">*</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>d <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">$</span> <span class="free">k</span> <span class="main">+</span> <span class="main">(</span>sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>d <span class="free">l</span> <span class="main">*</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">k</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> index_add_vec<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms fsi <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_dim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"a <span class="free">i</span> <span class="free">l</span> <span class="main">$</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span>d <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">$</span> <span class="free">k</span> <span class="main">+</span> <span class="main">(</span>sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>d <span class="free">l</span> <span class="main">*</span> κ <span class="free">i</span> <span class="free">l</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">k</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id
    <span class="keyword1"><span class="command">using</span></span> fsi assms d_κ_Ints fs_int
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dim_sumlist sumlist_nth
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Gramian_determinant_Ints sumlist_carrier Ints_minus Ints_add Ints_sum Ints_mult<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="main">_</span> <span class="main">$</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span>  Ints_scalar_prod<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fsi<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-a_alt_def"><span class="command">lemma</span></span> a_alt_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a <span class="free">i</span> <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">v</span> <span class="main">=</span> μ' <span class="free">l</span> <span class="free">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>a <span class="free">i</span> <span class="free">l</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span> μ' <span class="free">i</span> <span class="free">l</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> a <span class="free">l</span> <span class="free">l</span> <span class="keyword1">in</span>
                       <span class="main">(</span><span class="keyword1">if</span> <span class="free">l</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="bound">v</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> μ' <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"μ' <span class="main">(</span><span class="free">l</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> d <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> μ'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> μ.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"μ' <span class="free">l</span> <span class="free">l</span> <span class="main">=</span> d <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> μ'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> μ.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def a_l'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* gram_schmidt_fs_int *)</span>


<span class="keyword1"><span class="command">context</span></span> fs_int_indpt
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gso_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> int vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gso_int</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gso_int</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">v</span> <span class="main">=</span> μ' <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">gso_int</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">-</span> μ' <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">gso_int</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span>
                         <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="bound">v</span> <span class="keyword1">else</span> map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="keyword1">div</span> μ' <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-gso_int_carrier_vec"><span class="command">lemma</span></span> gso_int_carrier_vec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gso_int <span class="free">i</span> <span class="free">l</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-gso_int"><span class="command">lemma</span></span> gso_int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"of_int_hom.vec_hom <span class="main">(</span>gso_int <span class="free">i</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> gs.a <span class="free">i</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>gso_int <span class="free">i</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>gs.a <span class="free">i</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gs.a_carrier_vec assms gso_int_carrier_vec carrier_dim_vec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int_hom.vec_hom <span class="main">(</span>gso_int <span class="free">i</span> <span class="free">l</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">=</span> gs.a <span class="free">i</span> <span class="free">l</span> <span class="main">$</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Suc<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>gso_int <span class="skolem">i</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>gs.a <span class="skolem">i</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>gso_int <span class="skolem">l</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>gs.a <span class="skolem">l</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc gs.a_carrier_vec gso_int_carrier_vec carrier_dim_vec gs.gso'_carrier_vec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>gso_int <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> gs.a <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">$</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>gso_int <span class="skolem">l</span> <span class="skolem">l</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> gs.a <span class="skolem">l</span> <span class="skolem">l</span> <span class="main">$</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>gso_int <span class="skolem">i</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>gso_int <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>gs.a <span class="skolem">i</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
        <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>gs.a <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc fs_carrier carrier_dim_vec gs.a_carrier_vec f_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>μ' <span class="skolem">i</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> gs.μ' <span class="skolem">i</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>μ' <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> gs.μ' <span class="main">0</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc σs_μ' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> σs_μ'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> that k Suc IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="main">]</span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gso_int.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> gs.a_alt_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> gso_int.simps gs.a.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>μ' <span class="skolem">l</span> <span class="skolem">l</span> <span class="main">*</span> gso_int <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">-</span> μ' <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">*</span> gso_int <span class="skolem">l</span> <span class="skolem">l</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> rat_of_int <span class="main">(</span>μ' <span class="main">(</span><span class="skolem">l</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>
     <span class="main">=</span> gs.a <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> σs_μ' k that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gs.a_alt_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int_hom.vec_hom <span class="main">(</span>gso_int <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">=</span>
            rat_of_int <span class="main">(</span><span class="main">(</span>μ' <span class="skolem">l</span> <span class="skolem">l</span> <span class="main">*</span> gso_int <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">-</span> μ' <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">*</span> gso_int <span class="skolem">l</span> <span class="skolem">l</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span> 
                        <span class="keyword1">div</span> μ' <span class="main">(</span><span class="skolem">l</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that gso_int_carrier_vec k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> rat_of_int <span class="main">(</span>μ' <span class="skolem">l</span> <span class="skolem">l</span> <span class="main">*</span> gso_int <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">-</span> μ' <span class="skolem">i</span> <span class="skolem">l</span> <span class="main">*</span> gso_int <span class="skolem">l</span> <span class="skolem">l</span> <span class="main">$</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> rat_of_int <span class="main">(</span>μ' <span class="main">(</span><span class="skolem">l</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gs.a_Ints k Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exact_division<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> *
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">gso_int_tail'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> int vec <span class="main">⇒</span> int vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gso_int_tail'</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">v</span> <span class="main">=</span> μ' <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">-</span> μ' <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso_int <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span>
              <span class="bound">acc'</span> <span class="main">=</span> <span class="main">(</span>map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="keyword1">div</span> μ' <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span>
        <span class="keyword1">in</span> <span class="free">gso_int_tail'</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">acc'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">l</span><span class="main">,</span><span class="bound">acc</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">-</span> <span class="bound">l</span><span class="main">)</span>  <span class="keyword1">&lt;*mlex*&gt;</span> <span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span>  <span class="operator">goal_cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mlex_less wf_mlex<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gso_int_tail</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gso_int_tail</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">0</span> <span class="keyword1">else</span>
     <span class="keyword1">let</span> <span class="bound">acc</span> <span class="main">=</span> μ' <span class="main">0</span> <span class="main">0</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> μ' <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="main">0</span> <span class="keyword1">in</span>
     gso_int_tail' <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">1</span> <span class="bound">acc</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-gso_int_tail'"><span class="command">lemma</span></span> gso_int_tail'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">acc</span> <span class="main">=</span> gso_int <span class="free">i</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gso_int_tail' <span class="free">i</span> <span class="free">l</span> <span class="free">acc</span> <span class="main">=</span> gso_int <span class="free">i</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">acc</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gso_int_tail'.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">l</span> <span class="skolem">acc</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> li<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gso_int_tail' <span class="skolem">i</span> <span class="skolem">l</span> <span class="skolem">acc</span> <span class="main">=</span>
        gso_int_tail' <span class="skolem">i</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="keyword1">div</span> μ' <span class="main">(</span><span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>μ' <span class="skolem">l</span> <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">acc</span> <span class="main">-</span> μ' <span class="skolem">i</span> <span class="skolem">l</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso_int <span class="skolem">l</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> gso_int <span class="skolem">i</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 li <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> 1<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-gso_int_tail"><span class="command">lemma</span></span> gso_int_tail<span class="main">:</span> <span class="quoted"><span class="quoted">"gso_int_tail <span class="free">i</span> <span class="main">=</span> gso_int <span class="free">i</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gso_int_tail <span class="free">i</span> <span class="main">=</span> gso_int_tail' <span class="free">i</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span>gso_int <span class="free">i</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gso_int_tail.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> gso_int <span class="free">i</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> gso_int_tail'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gso_int_tail'<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gso_int_tail <span class="free">i</span> <span class="main">=</span> gso_int <span class="free">i</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> gso_array
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">while</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> int vec iarray <span class="main">⇒</span> int iarray iarray <span class="main">⇒</span> int vec <span class="main">⇒</span> int vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">while</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">gsa</span></span></span> <span class="free"><span class="bound"><span class="entity">dmusa</span></span></span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">=</span>  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">v</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">dmusa</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">dmusa</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free"><span class="bound"><span class="entity">gsa</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span>
              <span class="bound">acc'</span> <span class="main">=</span> <span class="main">(</span>map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="keyword1">div</span> <span class="free"><span class="bound"><span class="entity">dmusa</span></span></span> <span class="main">!!</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">!!</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span>
        <span class="keyword1">in</span> <span class="free">while</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">gsa</span></span></span> <span class="free"><span class="bound"><span class="entity">dmusa</span></span></span> <span class="bound">acc'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">l</span><span class="main">,</span><span class="bound">acc</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">-</span> <span class="bound">l</span><span class="main">)</span>  <span class="keyword1">&lt;*mlex*&gt;</span> <span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span>  <span class="operator">goal_cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mlex_less wf_mlex<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> while.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gso'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gso'</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fsa</span></span></span> <span class="free"><span class="bound"><span class="entity">gsa</span></span></span> <span class="free"><span class="bound"><span class="entity">dmusa</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">fsa</span></span></span> <span class="main">!!</span> <span class="main">0</span> <span class="keyword1">else</span>
     <span class="keyword1">let</span> <span class="bound">acc</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">dmusa</span></span></span> <span class="main">!!</span> <span class="main">0</span> <span class="main">!!</span> <span class="main">0</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free"><span class="bound"><span class="entity">fsa</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">dmusa</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">!!</span> <span class="main">0</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free"><span class="bound"><span class="entity">fsa</span></span></span> <span class="main">!!</span> <span class="main">0</span> <span class="keyword1">in</span>
     while <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">gsa</span></span></span> <span class="free"><span class="bound"><span class="entity">dmusa</span></span></span> <span class="bound">acc</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">gsos'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gsos'</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">dmusa</span></span></span> <span class="free"><span class="bound"><span class="entity">fsa</span></span></span> <span class="free"><span class="bound"><span class="entity">gsa</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">gsa</span></span></span> <span class="keyword1">else</span>
    <span class="free">gsos'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">dmusa</span></span></span> <span class="free"><span class="bound"><span class="entity">fsa</span></span></span> <span class="main">(</span>iarray_append <span class="free"><span class="bound"><span class="entity">gsa</span></span></span> <span class="main">(</span>gso' <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fsa</span></span></span> <span class="free"><span class="bound"><span class="entity">gsa</span></span></span> <span class="free"><span class="bound"><span class="entity">dmusa</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">n</span><span class="main">,</span><span class="bound">dmusa</span><span class="main">,</span><span class="bound">fsa</span><span class="main">,</span><span class="bound">gsa</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span>  <span class="keyword1">&lt;*mlex*&gt;</span> <span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span>  <span class="operator">goal_cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mlex_less wf_mlex<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> gsos'.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gso'_array</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gso'_array</span> <span class="free"><span class="bound"><span class="entity">dmusa</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> gsos' <span class="main">0</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">dmusa</span></span></span> <span class="main">(</span>IArray <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">(</span>IArray <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gso_array</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gso_array</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">dmusa</span> <span class="main">=</span> dμ_impl <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">;</span> <span class="bound">gsa</span> <span class="main">=</span> gso'_array <span class="bound">dmusa</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span>
                   <span class="keyword1">in</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> inverse <span class="main">(</span>rat_of_int <span class="main">(</span><span class="bound">dmusa</span> <span class="main">!!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">!!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                      <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> of_int_hom.vec_hom <span class="main">(</span><span class="bound">gsa</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> gso_array.gso_array_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> gso_array.gso'_array_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> gso_array.gsos'.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> gso_array.gso'_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> gso_array.while.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1" id="Gram_Schmidt_Int-map_vec_id"><span class="command">lemma</span></span> map_vec_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_vec id <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_vecI<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> fs_int_indpt
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"gso_array.gso'_array <span class="main">(</span>dμ_impl <span class="free">fs</span><span class="main">)</span> <span class="free">fs</span> <span class="main">=</span> IArray <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> gso_int <span class="bound">k</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">fs</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"IArray <span class="main">(</span>IArray.list_of <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> iarray"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iarray.exhaust list_of.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>IArray.list_of <span class="main">(</span>iarray_append <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>IArray.length <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">unfolding</span></span> iarray_append_code <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_iarray <span class="skolem">f</span> <span class="skolem">as</span> <span class="main">=</span> IArray <span class="main">(</span>map <span class="skolem">f</span> <span class="main">(</span>IArray.list_of <span class="skolem">as</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">as</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a iarray.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> d<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"IArray.list_of <span class="main">(</span>IArray.list_of <span class="main">(</span>dμ_impl <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> μ' <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> μ' dμ_impl nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rat_vec</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"of_int_hom.vec_hom"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"gso_array.while <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">gsa</span> <span class="main">(</span>dμ_impl <span class="free">fs</span><span class="main">)</span> <span class="skolem">acc</span> <span class="main">=</span> gso_int_tail' <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">acc'</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">acc</span> <span class="main">=</span> <span class="skolem">acc'</span>"</span></span>
         <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="skolem">gsa</span> <span class="main">!!</span> <span class="bound">k</span> <span class="main">=</span> gso_int <span class="bound">k</span> <span class="bound">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">gsa</span> <span class="skolem">acc</span> <span class="skolem">acc'</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">acc</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">acc'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gso_int_tail'.induct<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gso_array.while.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> gso_int_tail'.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"gso_array.gso' <span class="skolem">i</span> <span class="main">(</span>IArray <span class="free">fs</span><span class="main">)</span> <span class="skolem">gsa</span> <span class="main">(</span>dμ_impl <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> gso_int <span class="skolem">i</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="skolem">gsa</span> <span class="main">!!</span> <span class="bound">k</span> <span class="main">=</span> gso_int <span class="bound">k</span> <span class="bound">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">gsa</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IArray.list_of <span class="main">(</span>IArray.list_of <span class="main">(</span>dμ_impl <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> μ' <span class="main">0</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> d<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gso_array.gso' <span class="skolem">i</span> <span class="main">(</span>IArray <span class="free">fs</span><span class="main">)</span> <span class="skolem">gsa</span> <span class="main">(</span>dμ_impl <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> gso_int_tail <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gso_array.gso'_def gso_int_tail.simps Let_def
      <span class="keyword1"><span class="command">using</span></span> that * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> gso_int_tail'.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> gso_int_tail <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"gso_array.gsos' <span class="skolem">i</span> <span class="skolem">n</span> <span class="main">(</span>dμ_impl <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>IArray <span class="free">fs</span><span class="main">)</span> <span class="skolem">gsa</span> <span class="main">=</span>
         IArray <span class="main">(</span>IArray.list_of <span class="skolem">gsa</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> gso_int <span class="bound">k</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> length <span class="free">fs</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="skolem">gsa</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> gso_int <span class="bound">k</span> <span class="bound">k</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">n</span> <span class="skolem">gsa</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dμ_impl <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>IArray <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">gsa</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gso_array.gsos'.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">n</span> <span class="skolem">gsa</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> i_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gso_array.gso' <span class="skolem">i</span> <span class="main">(</span>IArray <span class="free">fs</span><span class="main">)</span> <span class="skolem">gsa</span> <span class="main">(</span>dμ_impl <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> gso_int <span class="skolem">i</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 i_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> *<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gso_array.gsos' <span class="skolem">i</span> <span class="skolem">n</span> <span class="main">(</span>dμ_impl <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>IArray <span class="free">fs</span><span class="main">)</span> <span class="skolem">gsa</span> <span class="main">=</span> gso_array.gsos' <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">(</span>dμ_impl <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>IArray <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>iarray_append <span class="skolem">gsa</span> <span class="main">(</span>gso_array.gso' <span class="skolem">i</span> <span class="main">(</span>IArray <span class="free">fs</span><span class="main">)</span> <span class="skolem">gsa</span> <span class="main">(</span>dμ_impl <span class="free">fs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gso_array.gsos'.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> IArray <span class="main">(</span>IArray.list_of <span class="skolem">gsa</span> <span class="main">@</span> gso_int <span class="skolem">i</span> <span class="skolem">i</span> <span class="main">#</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> gso_int <span class="bound">k</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span>Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 i_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> 1<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iarray_append_code<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> IArray <span class="main">(</span>IArray.list_of <span class="skolem">gsa</span> <span class="main">@</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> gso_int <span class="bound">k</span> <span class="bound">k</span><span class="main">)</span> <span class="main">[</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_conv_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gso_array.gsos'.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gso_array.gso'_array_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas Summarizing All Bounds During GSO Computation›</span></span>

<span class="keyword1"><span class="command">context</span></span> gram_schmidt_fs_int
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-combined_size_bound_integer"><span class="command">lemma</span></span> combined_size_bound_integer<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> m <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span> 
    <span class="main">∪</span> <span class="main">{</span>μ' <span class="bound">i</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> m<span class="main">}</span>
    <span class="main">∪</span> <span class="main">{</span>σ <span class="bound">l</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> m <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≤</span> <span class="bound">j</span><span class="main">}</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="var">?fs</span> <span class="main">∪</span> <span class="var">?μ'</span> <span class="main">∪</span> <span class="var">?σ</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"m <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> of_nat m <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> Suc m<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_nat m<span class="main">)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>trivial_conjugatable_linordered_field"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="var">?m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Num.of_nat_simps One_nat_def Suc_leI neq0_conv of_nat_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span>of_int <span class="skolem">z</span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>trivial_conjugatable_linordered_field<span class="main">¦</span> <span class="main">≤</span> <span class="main">(</span>of_int <span class="skolem">z</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">using</span></span> abs_leq_squared <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_abs of_int_le_iff of_int_power<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">¦</span> <span class="main">≤</span> of_nat m <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> Suc m<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">¦</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ints_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">fs</span></span></span> <span class="main"><span class="main"><span class="main">!</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">i</span></span></span> <span class="main"><span class="main"><span class="main">$</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">j</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> fs_int that <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">¦</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> vec_le_sq_norm<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> N"</span></span>
      <span class="keyword1"><span class="command">using</span></span> N_fs that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> of_nat m <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> Suc m<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> m N_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_mono self_le_power<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> of_nat m <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> Suc m<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="var">?fs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> of_nat m <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> Suc m<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="var">?μ'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>μ' <span class="skolem">i</span> <span class="skolem">j</span><span class="main">¦</span> <span class="main">≤</span> of_nat m <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> m<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> m"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"μ' <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> μ'_def <span class="keyword1"><span class="command">using</span></span> that d_mu_Ints <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>μ' <span class="skolem">i</span> <span class="skolem">j</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">(</span>μ' <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ints_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"μ' <span class="skolem"><span class="skolem"><span class="skolem">i</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">j</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> Suc <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that N_μ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> Suc m<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that assms N_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> power_increasing<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> of_nat m <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> Suc m<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> N_ge_0 assms zero_le_power <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> of_nat m <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> Suc m<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="var">?σ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>σ <span class="skolem">l</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">¦</span> <span class="main">≤</span> of_nat m <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> m<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">l</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>σ <span class="skolem">l</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">¦</span> <span class="main">≤</span> of_nat <span class="skolem">l</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that N_σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> of_nat m <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that N_ge_0 assms zero_le_power <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> of_nat m <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> Suc m<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> Suc m<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> that assms N_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_increasing<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> power_increasing<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> that assms N_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* gram_schmidt_fs_int *)</span>

 <span class="comment1">(* "x ≠ 0 ⟹ log 2 ¦x¦ ≤ 2 * m * log 2 N       + m + log 2 m" (is "_ ⟹ ?l1 ≤ ?b1")
  "x ≠ 0 ⟹ log 2 ¦x¦ ≤ 4 * m * log 2 (M * n) + m + log 2 m" (is "_ ⟹ _ ≤ ?b2") *)</span>

<span class="keyword1"><span class="command">context</span></span> fs_int_indpt
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1" id="Gram_Schmidt_Int-combined_size_bound_rat_log"><span class="command">lemma</span></span> combined_size_bound_rat_log<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span>gs.μ' <span class="bound">i</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> m<span class="main">}</span>
    <span class="main">∪</span> <span class="main">{</span>gs.σ <span class="bound">l</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> m <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≤</span> <span class="bound">j</span><span class="main">}</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="var">?μ'</span> <span class="main">∪</span> <span class="var">?σ</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"m <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">¦</span>real_of_rat <span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> log <span class="numeral">2</span> m <span class="main">+</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> m<span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real_of_rat gs.N<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r_fs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map of_int_hom.vec_hom <span class="free">fs</span><span class="main">::</span>rat vec list"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"map of_int_hom.vec_hom <span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">=</span> of_int <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?r_fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">|</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="var">?r_fs</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> 
             <span class="main">{</span>rat_of_int <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">fs</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> length_map<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?r_fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">|</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>map of_int_hom.vec_hom <span class="free">fs</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span>
                 <span class="main">∪</span> <span class="main">{</span>gs.μ' <span class="bound">i</span> <span class="bound">j</span> <span class="main">|</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="var">?r_fs</span><span class="main">}</span>
                 <span class="main">∪</span> <span class="main">{</span>gs.σ <span class="bound">l</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">|</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="var">?r_fs</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≤</span> <span class="bound">j</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> rat_of_nat <span class="main">(</span>length <span class="var">?r_fs</span><span class="main">)</span> <span class="main">*</span> gs.N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> Suc <span class="main">(</span>length <span class="var">?r_fs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ax</span> <span class="main">≤</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> gs.combined_size_bound_integer<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"real_of_rat <span class="var">?ax</span> <span class="main">≤</span> real_of_rat <span class="var">?t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> of_rat_less_eq 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>real_of_rat <span class="free">x</span><span class="main">¦</span> <span class="main">=</span> real_of_rat <span class="main">¦</span><span class="free">x</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">¦</span>real_of_rat <span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>real_of_rat <span class="var">?t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> rat_of_nat <span class="main">(</span>length <span class="free">fs</span><span class="main">)</span> <span class="main">*</span> gs.N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> length <span class="free">fs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms gs.N_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_le_cancel_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_rat <span class="var">?t</span> <span class="main">=</span> real m <span class="main">*</span> real_of_rat gs.N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> m<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_rat_mult of_rat_power<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>m <span class="main">*</span> real_of_rat gs.N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> m<span class="main">)</span><span class="main">)</span> <span class="main">=</span> log <span class="numeral">2</span> m <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>real_of_rat gs.N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> m<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gs.N_1 assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_mult<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>real_of_rat gs.N <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> m<span class="main">)</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span><span class="numeral">3</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> length <span class="free">fs</span><span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real_of_rat gs.N<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gs.N_1 assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_nat_power<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gram_Schmidt_Int-combined_size_bound_integer_log"><span class="command">lemma</span></span> combined_size_bound_integer_log<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span>μ' <span class="bound">i</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> m<span class="main">}</span>
    <span class="main">∪</span> <span class="main">{</span>σs <span class="bound">l</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> m <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">}</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="var">?μ'</span> <span class="main">∪</span> <span class="var">?σ</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"m <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">¦</span>real_of_int <span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> log <span class="numeral">2</span> m <span class="main">+</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> m<span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real_of_rat gs.N<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> m <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"m <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ combined_size_bound_rat_log<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ m<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>1<span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> μ' <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> m"</span></span> 
      <span class="main">|</span> <span class="main">(</span>2<span class="main">)</span> <span class="skolem">l</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> σs <span class="skolem">l</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> m"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> <span class="main">{</span>gs.μ' <span class="bound">i</span> <span class="bound">j</span> <span class="main">|</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> m<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>gs.σ <span class="bound">l</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">|</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> m <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≤</span> <span class="bound">j</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> σs_μ'<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">l</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> σs_μ'<span class="main">(</span>1<span class="main">)</span> 2 this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LLL">
<div class="head">
<h1>Theory LLL</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Jose Divasón
                Maximilian Haslbeck
                Sebastiaan Joosten
                René Thiemann
                Akihisa Yamada
    License:    BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The LLL Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Soundness of the LLL algorithm is proven in four steps. 
  In the basic version, we do recompute the Gram-Schmidt ortogonal (GSO) basis 
  in every step. This basic version will have a full functional soundness proof, 
  i.e., termination and the property that the returned basis is reduced.
  Then in LLL-Number-Bounds we will strengthen the invariant and prove that
  all intermediate numbers stay polynomial in size.
  Moreover, in LLL-Impl we will refine the basic version, so that
  the GSO does not need to be recomputed in every step. 
  Finally, in LLL-Complexity, we develop an cost-annotated version
  of the refined algorithm and prove a polynomial upper bound on the 
  number of arithmetic operations.›</span></span> 


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory provides a basic implementation and a soundness proof of the LLL algorithm
      to compute a "short" vector in a lattice.›</span></span> 

<span class="keyword1"><span class="command">theory</span></span> LLL
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="#Gram_Schmidt_2">Gram_Schmidt_2</a> 
    <a href="#Missing_Lemmas">Missing_Lemmas</a> 
    <a href="../../jordan_normal_form/theories/#Determinant">Jordan_Normal_Form.Determinant</a> 
    <span class="quoted">"<a href="../Abstract-Rewriting/SN_Order_Carrier.html">Abstract-Rewriting.SN_Order_Carrier</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Core Definitions, Invariants, and Theorems for Basic Version›</span></span>

<span class="comment1">(* Note/TODO by Max Haslbeck:
  Up to here I refactored the code in Gram_Schmidt_2 and Gram_Schmidt_Int which now makes heavy
  use of locales. In the future I would also like to do this here (instead of using LLL_invariant
  everywhere). *)</span>

<span class="keyword1"><span class="command">locale</span></span> LLL <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="comment1">(* n-dimensional vectors, *)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="comment1">(* number of vectors *)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">fs_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec list"</span></span> <span class="comment1">(* initial basis *)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted">rat</span> <span class="comment1">(* approximation factor *)</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> vec_module <span class="quoted"><span class="quoted">"<span class="keyword1">TYPE</span><span class="main">(</span>int<span class="main">)</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="keyword1"><span class="command">.</span></span>




<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RAT</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RAT</span> <span class="main">≡</span> map <span class="main">(</span>map_vec rat_of_int<span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SRAT</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SRAT</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> set <span class="main">(</span>RAT <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Rn</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rn</span> <span class="main">≡</span> carrier_vec <span class="free">n</span> <span class="main">::</span> rat vec set"</span></span> 

<span class="keyword1"><span class="command">sublocale</span></span> gs<span class="main">:</span> gram_schmidt_fs <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs_init</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lin_indep</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lin_indep</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">≡</span> gs.lin_indpt_list <span class="main">(</span>RAT <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gso</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gso</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">≡</span> gram_schmidt_fs.gso <span class="free">n</span> <span class="main">(</span>RAT <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">μ</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">≡</span> gram_schmidt_fs.μ <span class="free">n</span> <span class="main">(</span>RAT <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">reduced</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduced</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">≡</span> gram_schmidt_fs.reduced <span class="free">n</span> <span class="main">(</span>RAT <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="free">α</span>"</span></span> 
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">weakly_reduced</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">weakly_reduced</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">≡</span> gram_schmidt_fs.weakly_reduced <span class="free">n</span> <span class="main">(</span>RAT <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="free">α</span>"</span></span> 
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹lattice of initial basis›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> lattice_of <span class="free">fs_init</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹maximum squared norm of initial basis›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> max_list <span class="main">(</span>map <span class="main">(</span>nat <span class="main">∘</span> sq_norm<span class="main">)</span> <span class="free">fs_init</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹maximum absolute value in initial basis›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> Max <span class="main">(</span><span class="main">{</span>abs <span class="main">(</span><span class="free">fs_init</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is the core invariant which enables to prove functional correctness.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ_small</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> abs <span class="main">(</span>μ <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LLL_invariant_weak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LLL_invariant_weak</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span>
    gs.lin_indpt_list <span class="main">(</span>RAT <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">∧</span> 
    lattice_of <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> L <span class="main">∧</span>
    length <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="free">m</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LLL-LLL_inv_wD"><span class="command">lemma</span></span> LLL_inv_wD<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LLL_invariant_weak <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"lin_indep <span class="free">fs</span>"</span></span> 
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span> 
  <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> gso <span class="free">fs</span> <span class="bound">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs</span> <span class="main">=</span> L"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">interpret</span></span> gs'<span class="main">:</span> gram_schmidt_fs_lin_indpt <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms LLL_invariant_weak_def gs.lin_indpt_list_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms gs'.fs_carrier gs'.f_carrier gs'.gso_carrier
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LLL_invariant_weak_def gram_schmidt_fs.reduced_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL-LLL_inv_wI"><span class="command">lemma</span></span> LLL_inv_wI<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>  
  <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs</span> <span class="main">=</span> L"</span></span> 
  <span class="quoted"><span class="quoted">"lin_indep <span class="free">fs</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_invariant_weak <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> LLL_invariant_weak_def Let_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LLL_invariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> nat <span class="main">⇒</span> int vec list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">LLL_invariant</span> <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span> 
    gs.lin_indpt_list <span class="main">(</span>RAT <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">∧</span> 
    lattice_of <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> L <span class="main">∧</span>
    reduced <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="free">m</span> <span class="main">∧</span> 
    length <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="free">m</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="main">∨</span> μ_small <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>    
  <span class="main">)</span>"</span></span> 

<span class="keyword1" id="LLL-LLL_inv_imp_w"><span class="command">lemma</span></span> LLL_inv_imp_w<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span> <span class="main">⟹</span> LLL_invariant_weak <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> LLL_invariant_def LLL_invariant_weak_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="LLL-LLL_invD"><span class="command">lemma</span></span> LLL_invD<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"lin_indep <span class="free">fs</span>"</span></span> 
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span> 
  <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> gso <span class="free">fs</span> <span class="bound">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs</span> <span class="main">=</span> L"</span></span> 
  <span class="quoted"><span class="quoted">"weakly_reduced <span class="free">fs</span> <span class="free">i</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"reduced <span class="free">fs</span> <span class="free">i</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">upw</span> <span class="main">∨</span> μ_small <span class="free">fs</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">interpret</span></span> gs'<span class="main">:</span> gram_schmidt_fs_lin_indpt <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms LLL_invariant_def gs.lin_indpt_list_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms gs'.fs_carrier gs'.f_carrier gs'.gso_carrier
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LLL_invariant_def gram_schmidt_fs.reduced_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL-LLL_invI"><span class="command">lemma</span></span> LLL_invI<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>  
  <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs</span> <span class="main">=</span> L"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"lin_indep <span class="free">fs</span>"</span></span> 
  <span class="quoted"><span class="quoted">"reduced <span class="free">fs</span> <span class="free">i</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">upw</span> <span class="main">∨</span> μ_small <span class="free">fs</span> <span class="free">i</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> LLL_invariant_def Let_def split <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>



<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> fs_int' <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">m</span> <span class="free">fs_init</span> <span class="free">fs</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> LLL_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL.LLL_invariant_weak <span class="free">n</span> <span class="free">m</span> <span class="free">fs_init</span> <span class="free">fs</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> fs_int' <span class="main">⊆</span> fs_int_indpt
   <span class="keyword1"><span class="command">using</span></span> LLL_inv <span class="keyword1"><span class="command">unfolding</span></span> LLL.LLL_invariant_weak_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">context</span></span> LLL
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="LLL-gso_cong"><span class="command">lemma</span></span> gso_cong<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">f1</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> length <span class="free">f1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> length <span class="free">f2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gso <span class="free">f1</span> <span class="free">x</span> <span class="main">=</span> gso <span class="free">f2</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.gso_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  
<span class="keyword1" id="LLL-μ_cong"><span class="command">lemma</span></span> μ_cong<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">f1</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">f1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">f2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">f1</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">!</span> <span class="free">i</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"μ <span class="free">f1</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> μ <span class="free">f2</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.μ_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reduction</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduction</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">4</span><span class="main">+</span><span class="free">α</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">α</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">d</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec list <span class="main">⇒</span> nat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> gs.Gramian_determinant <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">D</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> nat <span class="main">(</span><span class="main">∏</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">.</span> d <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="bound">i</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dμ</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> int_of_rat <span class="main">(</span>of_int <span class="main">(</span>d <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> μ <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">logD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec list <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">logD</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">α</span> <span class="main">=</span> <span class="numeral">4</span><span class="main">/</span><span class="numeral">3</span> <span class="keyword1">then</span> <span class="main">(</span>D <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="keyword1">else</span> nat <span class="main">(</span>floor <span class="main">(</span>log <span class="main">(</span><span class="main">1</span> <span class="main">/</span> of_rat reduction<span class="main">)</span> <span class="main">(</span>D <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LLL_measure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int vec list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">LLL_measure</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> logD <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">+</span> <span class="free">m</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fs</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Linv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant_weak <span class="free">fs</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> fs<span class="main">:</span> fs_int' <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">fs_init</span></span> <span class="quoted"><span class="free">fs</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> Linv <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="LLL-Gramian_determinant"><span class="command">lemma</span></span> Gramian_determinant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span>gs.Gramian_determinant <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span><span class="main">)</span>
  <span class="quoted"><span class="quoted">"gs.Gramian_determinant <span class="free">fs</span> <span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms fs.Gramian_determinant LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   
<span class="keyword1" id="LLL-LLL_d_pos"><span class="command">lemma</span></span> LLL_d_pos <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"d <span class="free">fs</span> <span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">using</span></span> fs.Gramian_determinant k LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL-LLL_d_Suc"><span class="command">lemma</span></span> LLL_d_Suc<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> of_int <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms fs.fs_int_d_Suc  LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> fs.d_def d_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL-LLL_D_pos"><span class="command">lemma</span></span> LLL_D_pos<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"D <span class="free">fs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fs.fs_int_D_pos LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> D_def fs.D_def fs.d_def d_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Condition when we can increase the value of $i$›</span></span>

<span class="keyword1" id="LLL-increase_i"><span class="command">lemma</span></span> increase_i<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Linv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> upw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">upw</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> red_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="free">fs</span> <span class="main">&gt;</span> LLL_measure <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">fs</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_invD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="main">(</span>8<span class="main">,</span>10<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> red<span class="main">:</span> <span class="quoted"><span class="quoted">"weakly_reduced <span class="free">fs</span> <span class="free">i</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> sred<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced <span class="free">fs</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> red red_i i <span class="keyword1"><span class="command">have</span></span> red<span class="main">:</span> <span class="quoted"><span class="quoted">"weakly_reduced <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> gram_schmidt_fs.weakly_reduced_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> ii<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="improper">ii</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="main">(</span>11<span class="main">)</span> upw <span class="keyword1"><span class="command">have</span></span> sred_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">¦</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="bound">j</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> μ_small_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> sred sred_i <span class="keyword1"><span class="command">have</span></span> sred<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gram_schmidt_fs.reduced_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> red<span class="main"><span class="main">]</span></span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> ii j<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">ii</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">fs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> LLL_invI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> inv red sred i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="free">fs</span> <span class="main">&gt;</span> LLL_measure <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> LLL_measure_def <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Standard addition step which makes $\mu_{i,j}$ small›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ_small_row</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">j'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≤</span> <span class="bound">j'</span> <span class="main">⟶</span> <span class="bound">j'</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⟶</span> abs <span class="main">(</span>μ <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">j'</span><span class="main">)</span> <span class="main">≤</span> inverse <span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LLL-basis_reduction_add_row_main"><span class="command">lemma</span></span> basis_reduction_add_row_main<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> Linv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant_weak <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> <span class="free">fs</span><span class="main">[</span> <span class="free">i</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">]</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_invariant_weak <span class="free">fs'</span>"</span></span> 
  <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">i</span> <span class="free">fs</span> <span class="main">⟹</span> LLL_invariant True <span class="free">i</span> <span class="free">fs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> round <span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span> μ_small_row <span class="free">i</span> <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span> μ_small_row <span class="free">i</span> <span class="free">fs'</span> <span class="free">j</span>"</span></span> <span class="comment1">(* mu-value at position i j gets small *)</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> round <span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span> abs <span class="main">(</span>μ <span class="free">fs'</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="comment1">(* mu-value at position i j gets small *)</span>
  <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="free">fs'</span> <span class="main">=</span> LLL_measure <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="comment1">(* new values of gso: no change *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> gso <span class="free">fs'</span> <span class="bound">i</span> <span class="main">=</span> gso <span class="free">fs</span> <span class="bound">i</span>"</span></span> 
  <span class="comment1">(* new values of mu *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i'</span> <span class="bound">j'</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="bound">j'</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span>       
     μ <span class="free">fs'</span> <span class="bound">i'</span> <span class="bound">j'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i'</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> <span class="bound">j'</span> <span class="main">≤</span> <span class="free">j</span> <span class="keyword1">then</span> μ <span class="free">fs</span> <span class="free">i</span> <span class="bound">j'</span> <span class="main">-</span> of_int <span class="free">c</span> <span class="main">*</span> μ <span class="free">fs</span> <span class="free">j</span> <span class="bound">j'</span> <span class="keyword1">else</span> μ <span class="free">fs</span> <span class="bound">i'</span> <span class="bound">j'</span><span class="main">)</span>"</span></span>
  <span class="comment1">(* new values of d *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ii</span><span class="main">.</span> <span class="bound">ii</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> d <span class="free">fs'</span> <span class="bound">ii</span> <span class="main">=</span> d <span class="free">fs</span> <span class="bound">ii</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bnd</span></span> <span class="main">::</span> <span class="quoted">rat</span> <span class="keyword2"><span class="keyword">where</span></span> bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bnd</span> <span class="main">=</span> <span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> Suc <span class="free">j</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> map <span class="main">(</span>μ <span class="free">fs</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> Gr <span class="main">=</span> inv<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> jstrict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> add<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> indep<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_indep <span class="free">fs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> inv j i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted">rat_of_int</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?RV</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_vec <span class="var">?R</span>"</span></span>   
  <span class="keyword1"><span class="command">from</span></span> inv i j
  <span class="keyword1"><span class="command">have</span></span> Fij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span>"</span></span>  
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gso <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gso <span class="free">fs'</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"μ <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"μ <span class="free">fs'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> inv j i 
  <span class="keyword1"><span class="command">have</span></span> Fi<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> gs_carr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="free">j</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
                <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
                <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="var">?g</span> <span class="bound">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
                <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="var">?g</span> <span class="bound">j</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> len'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> add'<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="var">?RV</span> <span class="free">fs</span><span class="main">)</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> RAT_F1<span class="main">:</span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs'</span> <span class="main">=</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="var">?R</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> fs'
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="main">=</span> <span class="main">(</span><span class="var">?RV</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span>
          <span class="var">?RV</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">-</span> <span class="var">?R</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?RV</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> 2 add <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Fij<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> RAT_F1_i<span class="main">:</span><span class="quoted"><span class="quoted">"RAT <span class="free">fs'</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="var">?R</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">-</span> <span class="var">?mui</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> i len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> uminus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> <span class="main">-</span><span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> minus_add_uminus_vec<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Fij<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs'</span> <span class="main">=</span> lattice_of <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs' uminus
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lattice_of_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> add<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">-</span></span></span> <span class="free"><span class="free"><span class="free">c</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv <span class="keyword1"><span class="command">have</span></span> lattice<span class="main">:</span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs'</span> <span class="main">=</span> L"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> add len
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">fs</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">fs'</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">unfolding</span></span> fs'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> nth_list_update nth_mem subset_eq carrier_dim_vec index_minus_vec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
        index_smult_vec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">fs</span> <span class="main">⟹</span> <span class="free">fs'</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">unfolding</span></span> fs' <span class="keyword1"><span class="command">using</span></span> add len <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> len <span class="keyword1"><span class="command">have</span></span> F1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs'</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">fs'</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> F1'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"SRAT <span class="free">fs'</span> <span class="main">⊆</span> Rn"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> indep <span class="keyword1"><span class="command">have</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gs.lin_indpt_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Fij'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> Rn"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> add'<span class="main">[</span><span class="operator">unfolded</span> set_conv_nth<span class="main">]</span> i <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> uminus'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="var">?R</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> <span class="main">-</span> <span class="var">?R</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> minus_add_uminus_vec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Fij'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> span_F_F1<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.span <span class="main">(</span>SRAT <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> gs.span <span class="main">(</span>SRAT <span class="free">fs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> RAT_F1 uminus' 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.add_vec_span<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> len add<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?RV</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="var">?R</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span>  <span class="var">?RV</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Fij len i j<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> i j len <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> gs.lin_indpt_list_add_vec<span class="main">[</span><span class="operator">OF</span> this indep<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> of_int <span class="free">c</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.lin_indpt_list <span class="main">(</span><span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> <span class="main">-</span> <span class="var">?R</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"gs.lin_indpt_list <span class="var">?F1</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F1</span> <span class="main">=</span> RAT <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs' <span class="keyword1"><span class="command">using</span></span> i len Fij' **
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_update<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> indep_F1<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_indep <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> conn1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>  <span class="quoted"><span class="quoted">"length <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"gs.lin_indpt <span class="main">(</span>set <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> conn2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>  <span class="quoted"><span class="quoted">"length <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"gs.lin_indpt <span class="main">(</span>set <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> indep_F1 F1' <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> gs1<span class="main">:</span> gram_schmidt_fs_lin_indpt <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> inv gs.lin_indpt_list_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> gs2<span class="main">:</span> gram_schmidt_fs_lin_indpt <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> indep_F1 F1' gs.lin_indpt_list_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="var">?g</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="var">?g'</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> gs1.span_gso gs2.span_gso gs1.gso_carrier gs2.gso_carrier conn1 conn2 span_F_F1 len 
  <span class="keyword1"><span class="command">have</span></span> span_G_G1<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.span <span class="main">(</span>set <span class="var">?G</span><span class="main">)</span> <span class="main">=</span> gs.span <span class="main">(</span>set <span class="var">?G'</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> lenG<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?G</span> <span class="main">=</span> <span class="free">m</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> Gi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="var">?G</span> <span class="main">⟹</span> <span class="var">?G</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> Rn"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> G1i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="var">?G'</span> <span class="main">⟹</span> <span class="var">?G'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">i</span> <span class="main">⟹</span> RAT <span class="free">fs'</span> <span class="main">!</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">unfolding</span></span> RAT_F1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> eq_part<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="var">?g'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?g</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> gs.gso_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> len<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> Rn"</span></span>
       <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">insert</span> add len'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> carr1<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> this<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> this<span class="main">[</span><span class="operator">OF</span> ji<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="var">?g</span> <span class="skolem">x</span> <span class="main">∈</span> Rn"</span></span> 
       <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="var">?g'</span> <span class="skolem">x</span> <span class="main">∈</span> Rn"</span></span>
       <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> dim_vec <span class="main">(</span>gso <span class="free">fs</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> dim_vec <span class="main">(</span>gso <span class="free">fs'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
       <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> inv G1i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>o_def Gi G1i<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> carr2<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="free">i</span> <span class="main">∈</span> Rn"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g'</span> <span class="free">i</span> <span class="main">∈</span> Rn"</span></span>
                 <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">⊆</span> Rn"</span></span>
                 <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">}</span> <span class="main">⊆</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> F1_RV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?RV</span> <span class="main">(</span><span class="free">fs'</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> RAT <span class="free">fs'</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i F1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> F_RV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?RV</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> eq_part 
  <span class="keyword1"><span class="command">have</span></span> span_G1_G<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.span <span class="main">(</span><span class="var">?g'</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> gs.span <span class="main">(</span><span class="var">?g</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ls</span> <span class="main">=</span> <span class="var">?rs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"gs.span"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span> image_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="var">?g'</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="var">?g'</span> <span class="free">i</span><span class="main">)</span> <span class="main">-</span> <span class="var">?mui</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> RAT_F1_i <span class="keyword1"><span class="command">using</span></span> carr1 carr2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> in1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="var">?g'</span> <span class="free">i</span><span class="main">)</span> <span class="main">-</span> <span class="var">?mui</span> <span class="main">∈</span> <span class="var">?rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gs2.oc_projection_exist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> conn2 i <span class="keyword1"><span class="command">unfolding</span></span> span_G1_G <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> Gj_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">have</span></span> id1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?RV</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> len
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nth_image<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∈</span> <span class="var">?rs</span> <span class="main">⟷</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∈</span> gs.span <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?RV</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gs1.partial_span  <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> id1 inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?RV</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> len <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∈</span> gs.span <span class="main">…</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.span_mem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Gj_mem<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> G<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∈</span> <span class="var">?rs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> in2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?mui</span> <span class="main">∈</span> <span class="var">?rs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> gs.prod_in_span<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> ineq<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="var">?g'</span> <span class="free">i</span><span class="main">)</span> <span class="main">+</span> <span class="var">?mui</span> <span class="main">-</span> <span class="var">?mui</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="var">?g'</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> carr1 carr2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cong'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">B</span> <span class="main">⟹</span> <span class="skolem">A</span> <span class="main">∈</span> <span class="skolem">C</span> <span class="main">⟹</span> <span class="skolem">B</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> vec"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">C</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">⊆</span> Rn"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> in_span<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="var">?g'</span> <span class="free">i</span> <span class="main">∈</span> <span class="var">?rs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq_vecI gs.span_add1<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> * in1 in2<span class="main"><span class="main"><span class="main">,</span></span></span><span class="operator">unfolded</span> ineq<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> carr1 carr2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> gs2.orthogonal this inv assms
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g'</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?g'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> G1_G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g'</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?g</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> gs1.oc_projection_unique<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> inv i eq_part in_span <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> eq_fs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="var">?g'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?g</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="var">?g'</span> <span class="skolem">m</span> <span class="main">=</span> <span class="var">?g</span> <span class="skolem">m</span>"</span></span>
       <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs2.gso.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> gs1.gso.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> gs1.μ.simps gs2.μ.simps
        <span class="keyword1"><span class="command">using</span></span> ind eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ cong<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> refl<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"gs.sumlist"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> eq_rest <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linorder_class.linorder_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">insert</span> G1_G eq_part eq_rest<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> Hs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?G'</span> <span class="main">=</span> <span class="var">?G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> red<span class="main">:</span> <span class="quoted"><span class="quoted">"weakly_reduced <span class="free">fs</span> <span class="free">i</span> <span class="main">⟹</span> weakly_reduced <span class="free">fs'</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_fs <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gram_schmidt_fs.weakly_reduced_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Mi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">!</span> <span class="free">i</span> <span class="main">!</span> <span class="free">j</span>"</span></span>  
  <span class="keyword1"><span class="command">have</span></span> Gjn<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Fij<span class="main">(</span>2<span class="main">)</span> carrier_vecD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> addrow_mat <span class="free">m</span> <span class="main">(</span><span class="main">-</span> <span class="var">?R</span> <span class="free">c</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">=</span> gs1.M <span class="free">m</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N'</span> <span class="main">=</span> gs2.M <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> E_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs1.M_def M'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N'</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs2.M_def N'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mat_of_rows <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?GsM</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?mat</span> <span class="var">?G</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> Gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?GsM</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> GsT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?GsM</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Gnn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mat</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mat_of_rows_def <span class="keyword1"><span class="command">using</span></span> len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mat</span> <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">addrow</span> <span class="main">(</span><span class="main">-</span> <span class="var">?R</span> <span class="free">c</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span><span class="var">?mat</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> RAT_F1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Gjn ji<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> len mat_of_rows_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">*</span> <span class="var">?mat</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> E_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> addrow_mat<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mat_of_rows_def len<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> HEG<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mat</span> <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">*</span> <span class="var">?mat</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="comment1">(* lemma 16.12(i), part 1 *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">E</span> <span class="main">*</span> <span class="skolem">M'</span><span class="main">)</span> <span class="main">*</span> <span class="var">?mat</span> <span class="var">?G</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">M'</span> <span class="main">*</span> <span class="var">?mat</span> <span class="var">?G</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assoc_mult_mat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> E M Gs<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">*</span> <span class="var">?GsM</span> <span class="main">=</span> <span class="var">?mat</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gs1.matrix_equality conn1 M'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> <span class="var">?mat</span> <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> HEG <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">N'</span> <span class="main">*</span> <span class="var">?mat</span> <span class="var">?G'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gs2.matrix_equality conn2 <span class="keyword1"><span class="command">unfolding</span></span> N'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mat</span> <span class="var">?G'</span> <span class="main">=</span> <span class="var">?GsM</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Hs <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">E</span> <span class="main">*</span> <span class="skolem">M'</span><span class="main">)</span> <span class="main">*</span> <span class="var">?GsM</span> <span class="main">=</span> <span class="skolem">N'</span> <span class="main">*</span> <span class="var">?GsM</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="var">?GsM</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span><span class="main">]</span> E M N 
  <span class="keyword1"><span class="command">have</span></span> EMN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">E</span> <span class="main">*</span> <span class="skolem">M'</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?GsM</span> <span class="main">*</span> <span class="var">?GsM</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">=</span> <span class="skolem">N'</span> <span class="main">*</span> <span class="main">(</span><span class="var">?GsM</span> <span class="main">*</span> <span class="var">?GsM</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> assoc_mult_mat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Gs GsT<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="main">(</span><span class="var">?GsM</span> <span class="main">*</span> <span class="var">?GsM</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">=</span> gs.Gramian_determinant <span class="var">?G</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> gs.Gramian_determinant_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gs.Gramian_matrix_alt_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.lin_indpt_list <span class="var">?G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> conn1 gs1.orthogonal_gso gs1.gso_carrier <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> gs.orthogonal_imp_lin_indpt_list<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">interpret</span></span> G<span class="main">:</span> gram_schmidt_fs_lin_indpt <span class="quoted"><span class="free">n</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span>
      <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> 1 gs.lin_indpt_list_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> G.Gramian_determinant<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="main">(</span><span class="var">?GsM</span> <span class="main">*</span> <span class="var">?GsM</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> vec_space.det_nonzero_congruence<span class="main">[</span><span class="operator">OF</span> EMN this _ _ N<span class="main">]</span> Gs E M
  <span class="keyword1"><span class="command">have</span></span> EMN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">*</span> <span class="skolem">M'</span> <span class="main">=</span> <span class="skolem">N'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(* lemma 16.12(i), part 2 *)</span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> <span class="skolem">j'</span>
    <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="free">i</span> <span class="main">∨</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="skolem">j'</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu'</span> <span class="skolem">i'</span> <span class="skolem">j'</span> 
      <span class="main">=</span> <span class="skolem">N'</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i'</span><span class="main">,</span><span class="skolem">j'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij F1 <span class="keyword1"><span class="command">unfolding</span></span> N'_def gs2.M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">addrow</span> <span class="main">(</span><span class="main">-</span> <span class="var">?R</span> <span class="free">c</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="skolem">M'</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i'</span><span class="main">,</span><span class="skolem">j'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> EMN<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> E_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> addrow_mat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ji<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span> <span class="keyword1">then</span> <span class="main">-</span> <span class="var">?R</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M'</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">M'</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i'</span><span class="main">,</span> <span class="skolem">j'</span><span class="main">)</span> <span class="keyword1">else</span> <span class="skolem">M'</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i'</span><span class="main">,</span> <span class="skolem">j'</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> index_mat_addrow<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ij M<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">M'</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i'</span><span class="main">,</span> <span class="skolem">j'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> choice <span class="keyword1"><span class="command">have</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">=</span> <span class="var">?mu</span> <span class="free">j</span> <span class="skolem">j'</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> ij ji len <span class="keyword1"><span class="command">unfolding</span></span> M'_def gs1.M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs1.μ.simps <span class="keyword1"><span class="command">using</span></span> jj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?mu</span> <span class="skolem">i'</span> <span class="skolem">j'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ij len <span class="keyword1"><span class="command">unfolding</span></span> M'_def gs1.M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> calculation
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> mu_no_change <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j'</span>
    <span class="keyword3"><span class="command">assume</span></span> jj'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> j i <span class="keyword1"><span class="command">have</span></span> j'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu'</span> <span class="free">i</span> <span class="skolem">j'</span> 
      <span class="main">=</span> <span class="skolem">N'</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="skolem">j'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jj' j i F1 <span class="keyword1"><span class="command">unfolding</span></span> N'_def gs2.M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">addrow</span> <span class="main">(</span><span class="main">-</span> <span class="var">?R</span> <span class="free">c</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="skolem">M'</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="skolem">j'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> EMN<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> E_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> addrow_mat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> M<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ji<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">-</span> <span class="var">?R</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M'</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">M'</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="skolem">j'</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> index_mat_addrow<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j' i M<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">M'</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">-</span> <span class="var">?R</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M'</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="skolem">j'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">=</span> <span class="var">?mu</span> <span class="free">i</span> <span class="skolem">j'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i j' len <span class="keyword1"><span class="command">unfolding</span></span> M'_def gs1.M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">=</span> <span class="var">?mu</span> <span class="free">j</span> <span class="skolem">j'</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> i j j' len <span class="keyword1"><span class="command">unfolding</span></span> M'_def gs1.M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu'</span> <span class="free">i</span> <span class="skolem">j'</span> <span class="main">=</span> <span class="var">?mu</span> <span class="free">i</span> <span class="skolem">j'</span> <span class="main">-</span> <span class="var">?R</span> <span class="free">c</span> <span class="main">*</span> <span class="var">?mu</span> <span class="free">j</span> <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> mu_change <span class="main">=</span> this  
  <span class="keyword3"><span class="command">show</span></span> mu_update<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="skolem">j'</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> 
    <span class="var">?mu'</span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> <span class="skolem">j'</span> <span class="main">≤</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="var">?mu</span> <span class="free">i</span> <span class="skolem">j'</span> <span class="main">-</span> <span class="var">?R</span> <span class="free">c</span> <span class="main">*</span> <span class="var">?mu</span> <span class="free">j</span> <span class="skolem">j'</span> <span class="keyword1">else</span> <span class="var">?mu</span> <span class="skolem">i'</span> <span class="skolem">j'</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="keyword1"><span class="command">using</span></span> mu_change<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">]</span> mu_no_change<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i'</span></span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">i</span> <span class="free">fs</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> LLL_invD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weakly_reduced <span class="free">fs</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sred<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced <span class="free">fs</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> red<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> red<span class="main">:</span> <span class="quoted"><span class="quoted">"weakly_reduced <span class="free">fs'</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> sred<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced <span class="free">fs'</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gram_schmidt_fs.reduced_def 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> red<span class="main"><span class="main">]</span></span> impI allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i'</span> <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> mu_no_change<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i'</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> sred<span class="main">[</span><span class="operator">unfolded</span> gram_schmidt_fs.reduced_def<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i'</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> i 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">i</span> <span class="free">fs'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> LLL_invI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> F1 lattice <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">m</span>›</span></span> indep_F1 sred<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword3"><span class="command">show</span></span> Linv'<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant_weak <span class="free">fs'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> LLL_inv_wI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> F1 lattice indep_F1<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> mudiff<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?mu</span> <span class="free">i</span> <span class="free">j</span> <span class="main">-</span> of_int <span class="free">c</span> <span class="main">=</span> <span class="var">?mu'</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mu_change<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gs1.μ.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lin_indpt_list_fs<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.lin_indpt_list <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def <span class="keyword1"><span class="command">using</span></span> conn2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> round <span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> small<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span><span class="var">?mu</span> <span class="free">i</span> <span class="free">j</span> <span class="main">-</span> of_int <span class="free">c</span><span class="main">)</span> <span class="main">≤</span> inverse <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> j c
      <span class="keyword1"><span class="command">using</span></span> of_int_round_abs_le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_minus_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> mudiff<span class="main">]</span> 
    <span class="keyword3"><span class="command">show</span></span> mu'_2<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span><span class="var">?mu'</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">assume</span></span> mu_small<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_small_row <span class="free">i</span> <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> 

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"μ_small_row <span class="free">i</span> <span class="free">fs'</span> <span class="free">j</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> μ_small_row_def 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">j'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> mu'_2 mu_small<span class="main">[</span><span class="operator">unfolded</span> μ_small_row_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&gt;</span> <span class="free">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> mu_update<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">j'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>d <span class="free">fs'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> of_int <span class="main">(</span>d <span class="free">fs</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> d_def Gramian_determinant<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Linv i<span class="main">]</span> Gramian_determinant<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Linv' i<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> eq_fs<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"d <span class="free">fs'</span> <span class="skolem">i</span> <span class="main">=</span> d <span class="free">fs</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> this 
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">fs'</span> <span class="main">=</span> D <span class="free">fs</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> D_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">nat</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> prod.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="free">fs'</span> <span class="main">=</span> LLL_measure <span class="free">i</span> <span class="free">fs</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> LLL_measure_def logD_def D <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Addition step which can be skipped since $\mu$-value is already small›</span></span>

<span class="keyword1" id="LLL-basis_reduction_add_row_main_0"><span class="command">lemma</span></span> basis_reduction_add_row_main_0<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> Linv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant_weak <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"round <span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> mu_small<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_small_row <span class="free">i</span> <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"μ_small_row <span class="free">i</span> <span class="free">fs</span> <span class="free">j</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> inv<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> i j
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="main">0</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="free">fs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> inv i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> basis_reduction_add_row_main<span class="main">[</span><span class="operator">OF</span> Linv i j _<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">fs</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span> 0 id mu_small <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL-μ_small_row_refl"><span class="command">lemma</span></span> μ_small_row_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_small_row <span class="free">i</span> <span class="free">fs</span> <span class="free">i</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> μ_small_row_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL-basis_reduction_add_row_done"><span class="command">lemma</span></span> basis_reduction_add_row_done<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> Linv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> mu_small<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_small_row <span class="free">i</span> <span class="free">fs</span> <span class="main">0</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_invariant False <span class="free">i</span> <span class="free">fs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_invD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> mu_small 
  <span class="keyword1"><span class="command">have</span></span> mu_small<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_small <span class="free">fs</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> μ_small_row_def μ_small_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> i mu_small <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> LLL_invI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>6<span class="main"><span class="main"><span class="main">,</span></span></span>7<span class="main"><span class="main"><span class="main">,</span></span></span>9<span class="main"><span class="main"><span class="main">,</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>10<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>     

<span class="comment1">(* lemma 16.16 (ii), one case *)</span>
<span class="keyword1" id="LLL-d_swap_unchanged"><span class="command">lemma</span></span> d_swap_unchanged<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">F1</span> <span class="main">=</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ki<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> km<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>   
  <span class="keyword2"><span class="keyword">and</span></span> swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F2</span> <span class="main">=</span> <span class="free">F1</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">F1</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="free">F1</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"d <span class="free">F1</span> <span class="free">k</span> <span class="main">=</span> d <span class="free">F2</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F1_M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mat <span class="free">k</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">F1</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F2_M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mat <span class="free">k</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">F2</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> carrier_mat <span class="free">k</span> <span class="free">k</span> <span class="main">∧</span> det <span class="bound">P</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">∧</span> <span class="var">?F2_M</span> <span class="main">=</span> <span class="bound">P</span> <span class="main">*</span> <span class="var">?F1_M</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> ki<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?F2_M</span> <span class="main">=</span> <span class="var">?F1_M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> swap
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">k</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">∈</span> carrier_mat <span class="free">k</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"det <span class="var">?P</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F2_M</span> <span class="main">=</span> <span class="var">?P</span> <span class="main">*</span> <span class="var">?F1_M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> ki <span class="keyword1"><span class="command">have</span></span> ki<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"swaprows_mat <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> i0 ki <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> kmi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">∈</span> carrier_mat <span class="free">k</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"det <span class="var">?P</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> det_swaprows_mat<span class="main">[</span><span class="operator">OF</span> ki kmi neq<span class="main">]</span> ki <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> i len <span class="keyword1"><span class="command">have</span></span> iH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">F1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">F1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">*</span> <span class="var">?F1_M</span> <span class="main">=</span> <span class="keyword1">swaprows</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="var">?F1_M</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> swaprows_mat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ki kmi<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?F2_M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> swap
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> ii jj<span class="main"><span class="keyword3">,</span></span> 
          <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">ii</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">insert</span> iH<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_list_update<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">ii</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> iH neq ki<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_list_update<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> carrier_mat <span class="free">k</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> detP<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="skolem">P</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?F2_M</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">*</span> <span class="var">?F1_M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="free">F2</span> <span class="free">k</span> <span class="main">=</span> det <span class="main">(</span>gs.Gramian_matrix <span class="free">F2</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> d_def gs.Gramian_determinant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> det <span class="main">(</span><span class="var">?F2_M</span> <span class="main">*</span> <span class="var">?F2_M</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs.Gramian_matrix_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F2_M</span> <span class="main">*</span> <span class="var">?F2_M</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">=</span> <span class="var">?F2_M</span> <span class="main">*</span> <span class="main">(</span><span class="var">?F1_M</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">*</span> <span class="skolem">P</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> H'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> transpose_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> P<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">*</span> <span class="main">(</span><span class="var">?F1_M</span> <span class="main">*</span> <span class="main">(</span><span class="var">?F1_M</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">*</span> <span class="skolem">P</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> H' 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> assoc_mult_mat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> P<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="main">…</span> <span class="main">=</span> det <span class="skolem">P</span> <span class="main">*</span> det <span class="main">(</span><span class="var">?F1_M</span> <span class="main">*</span> <span class="main">(</span><span class="var">?F1_M</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">*</span> <span class="skolem">P</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> det_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> P<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> P<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F1_M</span> <span class="main">*</span> <span class="main">(</span><span class="var">?F1_M</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">*</span> <span class="skolem">P</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?F1_M</span> <span class="main">*</span> <span class="var">?F1_M</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> assoc_mult_mat<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> P<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="main">…</span> <span class="main">=</span> det <span class="main">(</span><span class="var">?F1_M</span> <span class="main">*</span> <span class="var">?F1_M</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">*</span> det <span class="skolem">P</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> det_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> P<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> det_transpose<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="main">(</span><span class="var">?F1_M</span> <span class="main">*</span> <span class="var">?F1_M</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="main">=</span> det <span class="main">(</span>gs.Gramian_matrix <span class="free">F1</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs.Gramian_matrix_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> d <span class="free">F1</span> <span class="free">k</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> d_def gs.Gramian_determinant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="free">F2</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span>det <span class="skolem">P</span> <span class="main">*</span> det <span class="skolem">P</span><span class="main">)</span> <span class="main">*</span> d <span class="free">F1</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="skolem">P</span> <span class="main">*</span> det <span class="skolem">P</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> detP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"d <span class="free">F1</span> <span class="free">k</span> <span class="main">=</span> d <span class="free">F2</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">base</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">base</span> <span class="main">=</span> real_of_rat <span class="main">(</span><span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="free">α</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">+</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_bound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">g_bound</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">.</span> sq_norm <span class="main">(</span>gso <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> of_nat N<span class="main">)</span>"</span></span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> LLL_with_assms <span class="main">=</span> LLL <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">≥</span> <span class="numeral">4</span><span class="main">/</span><span class="numeral">3</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lin_dep<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_indep <span class="free">fs_init</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs_init</span> <span class="main">=</span> <span class="free">m</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="LLL-α0"><span class="command">lemma</span></span> α0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> α <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL-fs_init"><span class="command">lemma</span></span> fs_init<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs_init</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> lin_dep<span class="main">[</span><span class="operator">unfolded</span> gs.lin_indpt_list_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="LLL-reduction"><span class="command">lemma</span></span> reduction<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> reduction"</span></span> <span class="quoted"><span class="quoted">"reduction <span class="main">≤</span> <span class="main">1</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&gt;</span> <span class="numeral">4</span><span class="main">/</span><span class="numeral">3</span> <span class="main">⟹</span> reduction <span class="main">&lt;</span> <span class="main">1</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> <span class="numeral">4</span><span class="main">/</span><span class="numeral">3</span> <span class="main">⟹</span> reduction <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> α <span class="keyword1"><span class="command">unfolding</span></span> reduction_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL-base"><span class="command">lemma</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&gt;</span> <span class="numeral">4</span><span class="main">/</span><span class="numeral">3</span> <span class="main">⟹</span> base <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduction<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> reduction_def base_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL-basis_reduction_swap_main"><span class="command">lemma</span></span> basis_reduction_swap_main<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> Linvw<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant_weak <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> small<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant False <span class="free">i</span> <span class="free">fs</span> <span class="main">∨</span> abs <span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> norm_ineq<span class="main">:</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">α</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> fs'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> <span class="free">fs</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_invariant_weak <span class="free">fs'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"LLL_invariant False <span class="free">i</span> <span class="free">fs</span> <span class="main">⟹</span> LLL_invariant False <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">fs'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="free">fs</span> <span class="main">&gt;</span> LLL_measure <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">fs'</span>"</span></span> 
  <span class="comment1">(* new values of gso *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> gso <span class="free">fs'</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span>
         gso <span class="free">fs</span> <span class="free">i</span> <span class="main">+</span> μ <span class="free">fs</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> 
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span>
         gso <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>RAT <span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∙</span> gso <span class="free">fs'</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> sq_norm <span class="main">(</span>gso <span class="free">fs'</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="free">fs'</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
      <span class="keyword1">else</span> gso <span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">=</span> <span class="var">?newg</span> <span class="bound">k</span>"</span></span><span class="main">)</span>
  <span class="comment1">(* new values of norms of gso *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> sq_norm <span class="main">(</span>gso <span class="free">fs'</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span>
          sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">fs</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span>
         sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> sq_norm <span class="main">(</span>gso <span class="free">fs'</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">=</span> <span class="var">?new_norm</span> <span class="bound">k</span>"</span></span><span class="main">)</span>
  <span class="comment1">(* new values of μ-values *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ii</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">ii</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">ii</span> <span class="main">⟹</span> μ <span class="free">fs'</span> <span class="bound">ii</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">(</span>
        <span class="keyword1">if</span> <span class="bound">ii</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> 
           μ <span class="free">fs</span> <span class="free">i</span> <span class="bound">j</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">ii</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span> 
          <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> 
             μ <span class="free">fs</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> sq_norm <span class="main">(</span>gso <span class="free">fs'</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1">else</span> 
             μ <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">j</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">ii</span> <span class="main">&gt;</span> <span class="free">i</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span>
           μ <span class="free">fs</span> <span class="bound">ii</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> μ <span class="free">fs</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">fs</span> <span class="bound">ii</span> <span class="free">i</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">ii</span> <span class="main">&gt;</span> <span class="free">i</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> 
           μ <span class="free">fs</span> <span class="bound">ii</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">fs'</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> μ <span class="free">fs</span> <span class="bound">ii</span> <span class="free">i</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="main">/</span> sq_norm <span class="main">(</span>gso <span class="free">fs'</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span> μ <span class="free">fs</span> <span class="bound">ii</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ii</span> <span class="bound">j</span><span class="main">.</span> <span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">=</span> <span class="var">?new_mu</span> <span class="bound">ii</span> <span class="bound">j</span>"</span></span><span class="main">)</span>
  <span class="comment1">(* new d-values *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ii</span><span class="main">.</span> <span class="bound">ii</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> of_int <span class="main">(</span>d <span class="free">fs'</span> <span class="bound">ii</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">ii</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span> 
       sq_norm <span class="main">(</span>gso <span class="free">fs'</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> of_int <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span>
       <span class="keyword1">else</span> of_int <span class="main">(</span>d <span class="free">fs</span> <span class="bound">ii</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> Linvw<span class="main">]</span>
  <span class="keyword1"><span class="command">interpret</span></span> fs<span class="main">:</span> fs_int' <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">fs_init</span></span> <span class="quoted"><span class="free">fs</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> Linvw <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"μ <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"μ <span class="free">fs'</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gso <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gso <span class="free">fs'</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> m12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> inverse <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> small
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"LLL_invariant False <span class="free">i</span> <span class="free">fs</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> LLL_invD<span class="main">(</span>11<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> i0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> μ_small_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> d_def  
  <span class="keyword1"><span class="command">note</span></span> Gd <span class="main">=</span> Gramian_determinant<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> Gd12 <span class="main">=</span> Gd<span class="main">[</span><span class="operator">OF</span> Linvw<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span> <span class="free">i</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cond</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">*</span> sq_norm <span class="var">?y</span> <span class="main">&lt;</span> sq_norm <span class="var">?x</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> inv <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> HC<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs</span> <span class="main">=</span> L"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> i0 inv i <span class="keyword1"><span class="command">have</span></span> swap<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> RAT_fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs'</span> <span class="main">=</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">using</span></span> swap <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_list_update<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> span'<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.span <span class="main">(</span>SRAT <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> gs.span <span class="main">(</span>SRAT <span class="free">fs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">gs.span</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> swap<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lfs'<span class="main">:</span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs'</span> <span class="main">=</span> lattice_of <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lattice_of_swap<span class="main"><span class="main">[</span></span><span class="operator">OF</span> swap refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv <span class="keyword1"><span class="command">have</span></span> lattice<span class="main">:</span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs'</span> <span class="main">=</span> L"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> len'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs'</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs'</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> swap <span class="keyword1"><span class="command">unfolding</span></span> fs'_def set_conv_nth
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">k</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">k</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_vec rat_of_int"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> inv<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> indepH<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_indep <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> i i0 len <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> distinct_swap<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> len <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span> <span class="main">=</span> distinct <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> RAT_fs'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_update<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> len' fs' span' indepH <span class="keyword1"><span class="command">have</span></span> indepH'<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_indep <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">using</span></span> i i0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gs.lin_indpt_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lenR'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> len' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> conn1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>  <span class="quoted"><span class="quoted">"length <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"gs.lin_indpt <span class="main">(</span>set <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> conn2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>  <span class="quoted"><span class="quoted">"length <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"gs.lin_indpt <span class="main">(</span>set <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> indepH' lenR'  <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> gs2<span class="main">:</span> gram_schmidt_fs_lin_indpt <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> indepH' lenR' gs.lin_indpt_list_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fs'_fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">fs'</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> ki<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> kn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g2</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?g1</span> <span class="skolem">k</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.gso_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ki kn len<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> G2_G <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> take_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">fs'</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">fs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> len len' i swap<span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fs'_fs<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> i1n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted">rat_of_int</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?RV</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_vec <span class="var">?R</span>"</span></span>  
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> RAT <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> RAT <span class="free">fs'</span> <span class="main">!</span> <span class="bound">i</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> sq_norm <span class="main">(</span><span class="var">?g1</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> sq_norm <span class="main">(</span><span class="var">?g2</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> heq<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs'</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">fs</span> <span class="main">=</span> take <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">fs'</span>"</span></span>
           <span class="quoted"><span class="quoted">"<span class="var">?f2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f1</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f2</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">using</span></span> i len i0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> norm_pos2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="var">?n2</span> <span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> 
    <span class="keyword1"><span class="command">using</span></span> gs2.sq_norm_pos len' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> norm_pos1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="var">?n1</span> <span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> 
    <span class="keyword1"><span class="command">using</span></span> fs.gs.sq_norm_pos inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> norm_zero2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="var">?n2</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="keyword1"><span class="command">using</span></span> norm_pos2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> norm_zero1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="var">?n1</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="keyword1"><span class="command">using</span></span> norm_pos1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="var">?g1</span> <span class="bound">j</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> gs2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="var">?g2</span> <span class="bound">j</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> fs.gs.gso_carrier conn2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="var">?f1</span> <span class="bound">j</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> g2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="var">?f2</span> <span class="bound">j</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> gs2.f_carrier conn2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fs1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fs1</span> <span class="main">⊆</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> g i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gs1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> G'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gs1</span> <span class="main">⊆</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> gs i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gs.span <span class="var">?fs1</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gs.span <span class="var">?gs1</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> S'S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?S'</span> <span class="main">=</span> <span class="var">?S</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fs.gs.partial_span'<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> conn1 i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.is_oc_projection <span class="main">(</span><span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>gs.span <span class="main">(</span><span class="var">?g2</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?f2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> i len' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span>  gs2.gso_oc_projection_span<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f1</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">using</span></span> len i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.span <span class="main">(</span><span class="var">?g2</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> gs.span <span class="main">(</span><span class="var">?f2</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> i len' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> gs2.partial_span'<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f2</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="var">?fs1</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> len i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> claim1<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.is_oc_projection <span class="main">(</span><span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="var">?S</span> <span class="main">(</span><span class="var">?f1</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> list_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> Suc <span class="free">i</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"map <span class="skolem">f</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(* f1i_sum is claim 2 *)</span>
  <span class="keyword1"><span class="command">have</span></span> f1i_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="free">i</span> <span class="main">=</span> gs.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g1</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span> <span class="var">?g1</span> <span class="free">i</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?sum</span> <span class="main">+</span> <span class="main">_</span>"</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> fs.gs.fi_is_sum_of_mu_gso<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> len i<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_append list_id
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gs.M.sumlist_snoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i gs conn1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs.gs.μ.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f1im1_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> gs.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="var">?mu1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g1</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?sum1</span> <span class="main">+</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> fs.gs.fi_is_sum_of_mu_gso<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> len i<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_append list_id
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gs.M.sumlist_snoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i gs<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs.gs.μ.simps<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.sumlist_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sum1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sum1</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.sumlist_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> gs.span_closed<span class="main">[</span><span class="operator">OF</span> G<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> Rn"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> gs i <span class="keyword1"><span class="command">have</span></span> gs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟹</span> <span class="var">?g1</span> <span class="bound">j</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(* d does not change for k ≠ i *)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> kn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ki<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> d_swap_unchanged<span class="main">[</span><span class="operator">OF</span> len i0 i ki kn fs'_def<span class="main">]</span>  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="free">fs</span> <span class="skolem">k</span> <span class="main">=</span> d <span class="free">fs'</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> this

  <span class="comment1">(* new value of g (i-1) *)</span>
  <span class="keyword1"><span class="command">have</span></span> g2_im1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">+</span> <span class="var">?mu_f1</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> gs.is_oc_projection_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span>  claim1 _ S g<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gs.is_oc_projection <span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span><span class="main">)</span> <span class="var">?S</span> <span class="main">(</span><span class="var">?f1</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs.is_oc_projection_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI allI impI<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sum'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gs.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g1</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">have</span></span> sum'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sum'</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.sumlist_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> inRn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span><span class="main">)</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> gs<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> gsi i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> carr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">∈</span> Rn"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span> <span class="free">i</span> <span class="main">∈</span> Rn"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu_f1</span> <span class="main">∈</span> Rn"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum'</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> sum' sum gs<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> gsi i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="free">i</span> <span class="main">-</span> <span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?sum</span> <span class="main">+</span> <span class="var">?g1</span> <span class="free">i</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> f1i_sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?sum</span> <span class="main">-</span> <span class="var">?mu_f1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> carr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">=</span> gs.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g1</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="var">?mu_f1</span><span class="main">]</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> list <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?sum'</span> <span class="main">+</span> <span class="var">?mu_f1</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gs.sumlist_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs' gsi<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">-</span> <span class="var">?mu_f1</span> <span class="main">=</span> <span class="var">?sum'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum' gsi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="free">i</span> <span class="main">-</span> <span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?sum'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="free">i</span> <span class="main">-</span> <span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span><span class="main">)</span> <span class="main">∈</span> gs.span <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id gs.span_span<span class="main">[</span><span class="operator">OF</span> G<span class="main">]</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> gs.sumlist_in_span<span class="main"><span class="main">[</span></span><span class="operator">OF</span> G<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g1</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="skolem">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g1</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> v
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.smult_in_span<span class="main"><span class="main">[</span></span><span class="operator">OF</span> G<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> S'S<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gs.span_mem<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs i j<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S'S <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> gs.orthocompl_span<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ G' inRn x<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?gs1</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="var">?g1</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> j i x_id gs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
          <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span> <span class="skolem">k</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> x_id 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fs.gs.orthogonal<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> conn1 k<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> j i 
        <span class="keyword1"><span class="command">have</span></span> main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span> <span class="free">i</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?g1</span> <span class="free">i</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">+</span> <span class="var">?mu_f1</span> <span class="main">∙</span> <span class="skolem">x</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_scalar_prod_distrib<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">]</span></span> _ x<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gsi<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> main
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> smult_scalar_prod_distrib<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gsi x<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(* 16.13 (i): for g, only g_i and g_{i-1} can change *)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> kn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> ki<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g2</span> <span class="skolem">k</span> <span class="main">=</span> gs.oc_projection <span class="main">(</span>gs.span <span class="main">(</span><span class="var">?g2</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?f2</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs2.gso_oc_projection_span<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> kn conn2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.span <span class="main">(</span><span class="var">?g2</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> gs.span <span class="main">(</span><span class="var">?f2</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs2.partial_span'<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> conn2 kn<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f2</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span> <span class="main">=</span> <span class="var">?f1</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">≤</span><span class="free">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ki <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> image_cong<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">using</span></span> len i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f2</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span> <span class="main">=</span> Fun.swap <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="var">?f1</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Fun.swap_def fs'_def o_def <span class="keyword1"><span class="command">using</span></span> len i 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> image_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> len kn<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?f1</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> swap_image_eq<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.span <span class="main">…</span> <span class="main">=</span> gs.span <span class="main">(</span><span class="var">?g1</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> fs.gs.partial_span'<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> conn1 kn<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f2</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?f1</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ki kn len <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.oc_projection <span class="main">(</span>gs.span <span class="main">(</span><span class="var">?g1</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">…</span> <span class="main">=</span> <span class="var">?g1</span> <span class="skolem">k</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fs.gs.gso_oc_projection_span<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> kn conn1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g2</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?g1</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> g2_g1_identical <span class="main">=</span> this

  <span class="comment1">(* calculation of new mu-values *)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(* no change of mu for lines before line i - 1 *)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">jj</span> <span class="skolem">ii</span>
    <span class="keyword3"><span class="command">assume</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span>  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu2</span> <span class="skolem">ii</span> <span class="skolem">jj</span> <span class="main">=</span> <span class="var">?mu1</span> <span class="skolem">ii</span> <span class="skolem">jj</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ii i len
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gs.μ_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"RAT <span class="free"><span class="free"><span class="free">fs</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"RAT <span class="free"><span class="free"><span class="free">fs'</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> mu'_mu_small_i <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(* swap of mu-values in lines i - 1 and i for j &lt; i - 1 *)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">jj</span>
    <span class="keyword3"><span class="command">assume</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span>  
    <span class="keyword1"><span class="command">hence</span></span> id1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟷</span> True"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟷</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> id2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g2</span> <span class="skolem">jj</span> <span class="main">=</span> <span class="var">?g1</span> <span class="skolem">jj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> g2_g1_identical<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> jj i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>       
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu2</span> <span class="free">i</span> <span class="skolem">jj</span> <span class="main">=</span> <span class="var">?mu1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">jj</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">jj</span> <span class="main">=</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="skolem">jj</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> gs2.μ.simps fs.gs.μ.simps id1 id2 if_True <span class="keyword1"><span class="command">using</span></span> len i i0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> mu'_mu_i_im1_j <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> im1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">(* calculation of new value of g_i *)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g2_im1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> g2_im1_Rn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g2_im1</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> i conn2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fs.gs.gso_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu2_f2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">-</span> <span class="var">?mu2</span> <span class="free">i</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g2</span> <span class="bound">j</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sum</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gs.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> <span class="var">?mu1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g1</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> mhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mu2_f2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> i conn2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fs.gs.gso_carrier<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> sum'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.sumlist_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> gim1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> g i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g2</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?f2</span> <span class="free">i</span> <span class="main">+</span> gs.sumlist <span class="main">(</span>map <span class="var">?mu2_f2</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="var">?mu2_f2</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> gs2.gso.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> list <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f2</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">using</span></span> len i i0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="var">?mu2_f2</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">-</span> <span class="var">?mu1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g1</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> g2_g1_identical<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mu'_mu_i_im1_j<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.sumlist <span class="main">(</span><span class="main">…</span> <span class="main">@</span> <span class="main">[</span><span class="var">?mu2_f2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?sum</span> <span class="main">+</span> <span class="var">?mu2_f2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gs.sumlist_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs i mhs<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="var">?sum</span><span class="main">)</span> <span class="main">+</span> <span class="var">?mu2_f2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gim1 sum' mhs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="var">?sum</span> <span class="main">=</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs.gs.gso.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu2_f2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="var">?f2</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?g2_im1</span> <span class="main">/</span> sq_norm <span class="var">?g2_im1</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g2_im1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs2.μ.simps <span class="keyword1"><span class="command">using</span></span> i0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="var">?f2</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?g2_im1</span> <span class="main">/</span> sq_norm <span class="var">?g2_im1</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g2_im1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">…</span> <span class="main">=</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="var">?f2</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?g2_im1</span> <span class="main">/</span> sq_norm <span class="var">?g2_im1</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g2_im1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> minus_add_uminus_vec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gsi g2_im1_Rn<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f2</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g2</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> sq_norm <span class="main">(</span><span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> g2_i <span class="main">=</span> this

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> sq_norm <span class="main">(</span><span class="var">?g1</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> sq_norm <span class="main">(</span><span class="var">?g2</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 

  <span class="comment1">(* calculation of new norms *)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(* norm of g (i - 1) *)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> sq_norm <span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g2_im1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?mu_f1</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scalar_prod_add_distrib<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?g1</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_scalar_prod_distrib<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu_f1</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?mu_f1</span> <span class="main">=</span> <span class="var">?g1</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?mu_f1</span> <span class="main">+</span> <span class="var">?mu_f1</span> <span class="main">∙</span> <span class="var">?mu_f1</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_scalar_prod_distrib<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu_f1</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?g1</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?mu_f1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> comm_scalar_prod<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="free">i</span> <span class="main">=</span> sq_norm <span class="main">(</span><span class="var">?g1</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?mu_f1</span> <span class="main">=</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scalar_prod_smult_right<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">]</span></span> gs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> orthogonalD<span class="main">[</span><span class="operator">OF</span> fs.gs.orthogonal_gso<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> i len i0  
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu_f1</span> <span class="main">∙</span> <span class="var">?mu_f1</span> <span class="main">=</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?mu_f1</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scalar_prod_smult_right<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">]</span></span> gs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu_f1</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scalar_prod_smult_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">]</span></span> gs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> sq_norm <span class="main">(</span><span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?n1</span> <span class="free">i</span> <span class="main">+</span> <span class="main">(</span><span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> sq_norm_g2_im1 <span class="main">=</span> this

  <span class="keyword1"><span class="command">from</span></span> norm_pos1<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> norm_pos1<span class="main">[</span><span class="operator">OF</span> im1<span class="main">]</span> norm_pos2<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> norm_pos2<span class="main">[</span><span class="operator">OF</span> im1<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> norm0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n2</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> norm0'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(* new norm of g i *)</span>
    <span class="keyword1"><span class="command">have</span></span> si<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> im1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> det1<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.Gramian_determinant <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">j</span><span class="main">&lt;</span>Suc <span class="free">i</span><span class="main">.</span> <span class="main">∥</span>fs.gs.gso <span class="bound">j</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fs.gs.Gramian_determinant si len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> det2<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.Gramian_determinant <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">j</span><span class="main">&lt;</span>Suc <span class="free">i</span><span class="main">.</span> <span class="main">∥</span>gs2.gso <span class="bound">j</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gs2.Gramian_determinant si len' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> norm_zero1<span class="main">[</span><span class="operator">OF</span> less_le_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ im1<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="var">?n1</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod_zero_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>d <span class="free">fs'</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rat_of_int <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> d_swap_unchanged<span class="main">[</span><span class="operator">OF</span> len i0 i _ si fs'_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>d <span class="free">fs'</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> gs.Gramian_determinant <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fs.of_int_Gramian_determinant<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> conn2 i g fs'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">j</span><span class="main">&lt;</span>Suc <span class="free">i</span><span class="main">.</span> <span class="var">?n2</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> det2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> gs.Gramian_determinant <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fs.of_int_Gramian_determinant<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> conn1 i g<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">j</span><span class="main">&lt;</span>Suc <span class="free">i</span><span class="main">.</span> <span class="var">?n1</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> det1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>Suc <span class="free">i</span><span class="main">}</span> <span class="main">=</span> insert <span class="free">i</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?set</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">j</span><span class="main">∈</span> <span class="var">?set</span><span class="main">.</span> <span class="var">?n2</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="var">?n2</span> <span class="free">i</span> <span class="main">*</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="var">?n2</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i0
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.insert<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">subst</span> prod.insert<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">j</span><span class="main">∈</span> <span class="var">?set</span><span class="main">.</span> <span class="var">?n1</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="var">?n1</span> <span class="free">i</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="var">?n1</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i0
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.insert<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">subst</span> prod.insert<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="var">?n2</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="var">?n1</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> G2_G<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n2</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?n1</span> <span class="free">i</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> 0 norm0' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> sq_norm_g2_i <span class="main">=</span> this

  <span class="comment1">(* mu values in rows &gt; i do not change with j ∉ {i, i - 1} *)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ii</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">ii</span>"</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu2</span> <span class="skolem">ii</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="var">?f2</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">/</span> sq_norm <span class="main">(</span><span class="var">?g2</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> gs2.μ.simps <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f2</span> <span class="skolem">ii</span> <span class="main">=</span> <span class="var">?f1</span> <span class="skolem">ii</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ii len <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g2</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?g1</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> g2_g1_identical<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> j ii ji <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu2</span> <span class="skolem">ii</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?mu1</span> <span class="skolem">ii</span> <span class="skolem">j</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> fs.gs.μ.simps <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu2</span> <span class="skolem">ii</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?mu1</span> <span class="skolem">ii</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">ii</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gs2.μ.simps fs.gs.μ.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> mu_no_change_large_row <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(* the new value of mu i (i - 1) *)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu2</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?f2</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> gs2.μ.simps <span class="keyword1"><span class="command">using</span></span> i0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f2</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> len i i0 <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> g2_im1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scalar_prod_add_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i gs g<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fs.gs.fi_scalar_prod_gso<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> conn1 im1 i i0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs.gs.μ.simps fs.gs.μ.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
       <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scalar_prod_smult_distrib<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs g i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fs.gs.fi_scalar_prod_gso<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> conn1 im1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs.gs.μ.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu2</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_vec_as_cscalar_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> mu'_mu_i_im1 <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(* the new values of mu ii (i - 1) for ii &gt; i *)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ii</span> <span class="keyword3"><span class="command">assume</span></span> iii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> iii1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">ii</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu2</span> <span class="skolem">ii</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?f2</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> gs2.μ.simps <span class="keyword1"><span class="command">using</span></span> i0 iii1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f2</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> len i i0 iii ii <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="main">(</span><span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> g2_im1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="main">(</span><span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scalar_prod_add_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i ii gs g<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?mu1</span> <span class="skolem">ii</span> <span class="free">i</span> <span class="main">*</span> <span class="var">?n1</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fs.gs.fi_scalar_prod_gso<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> conn1 ii i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="main">(</span><span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
       <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scalar_prod_smult_distrib<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs g i ii<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?mu1</span> <span class="skolem">ii</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fs.gs.fi_scalar_prod_gso<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> conn1 ii im1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu2</span> <span class="skolem">ii</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?mu1</span> <span class="skolem">ii</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?mu2</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="var">?mu1</span> <span class="skolem">ii</span> <span class="free">i</span> <span class="main">*</span> <span class="var">?n1</span> <span class="free">i</span> <span class="main">/</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> mu'_mu_i_im1 <span class="keyword1"><span class="command">using</span></span> norm0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> mu'_mu_large_row_im1 <span class="main">=</span> this    

  <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(* the new values of mu ii i for ii &gt; i *)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ii</span> <span class="keyword3"><span class="command">assume</span></span> iii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu2</span> <span class="skolem">ii</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="var">?f2</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="free">i</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n2</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> gs2.μ.simps <span class="keyword1"><span class="command">using</span></span> i0 iii <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f2</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> len i i0 iii ii <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="main">(</span><span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> g2_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f2</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i i0 len <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f2</span> <span class="free">i</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?mu2</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> gs2.μ.simps <span class="keyword1"><span class="command">using</span></span> i i0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="main">(</span><span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?mu2</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
       <span class="main">=</span> <span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="main">(</span><span class="var">?mu2</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scalar_prod_minus_distrib<span class="main"><span class="main">[</span></span><span class="operator">OF</span> g gs<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs2 ii i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?mu1</span> <span class="skolem">ii</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fs.gs.fi_scalar_prod_gso<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> conn1 ii im1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="main">(</span><span class="var">?mu2</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
       <span class="var">?mu2</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scalar_prod_smult_distrib<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs gs2 g i ii<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> norm0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f2</span> <span class="skolem">ii</span> <span class="main">∙</span> <span class="var">?g2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> len ii iii <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">/</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?mu2</span> <span class="skolem">ii</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs2.μ.simps <span class="keyword1"><span class="command">using</span></span> iii <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu2</span> <span class="skolem">ii</span> <span class="free">i</span> <span class="main">=</span> 
       <span class="main">(</span><span class="var">?mu1</span> <span class="skolem">ii</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?mu2</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?mu2</span> <span class="skolem">ii</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n2</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?mu1</span> <span class="skolem">ii</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?mu2</span> <span class="skolem">ii</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n1</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_g2_i mu'_mu_i_im1 <span class="keyword1"><span class="command">using</span></span> norm0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?mu1</span> <span class="skolem">ii</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> 
      <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="var">?mu1</span> <span class="skolem">ii</span> <span class="free">i</span> <span class="main">*</span> <span class="var">?n1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?mu1</span> <span class="skolem">ii</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n1</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> mu'_mu_large_row_im1<span class="main">[</span><span class="operator">OF</span> iii ii<span class="main">]</span> mu'_mu_i_im1 <span class="keyword1"><span class="command">using</span></span> norm0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?mu1</span> <span class="skolem">ii</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?mu1</span> <span class="skolem">ii</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_g2_im1 <span class="keyword1"><span class="command">using</span></span> norm0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu2</span> <span class="skolem">ii</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?mu1</span> <span class="skolem">ii</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?mu1</span> <span class="skolem">ii</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> mu'_mu_large_row_i <span class="main">=</span> this


  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g2</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?newg</span> <span class="skolem">k</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> g2_i<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> g2_im1<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> g2_g1_identical<span class="main">[</span><span class="operator">OF</span> k<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n2</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?new_norm</span> <span class="skolem">k</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_g2_i<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_g2_im1<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> g2_g1_identical<span class="main">[</span><span class="operator">OF</span> k<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> jk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∨</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∨</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∨</span> <span class="skolem">k</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu2</span> <span class="skolem">k</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?new_mu</span> <span class="skolem">k</span> <span class="skolem">j</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> mu'_mu_i_im1<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span>
        mu'_mu_large_row_i<span class="main">[</span><span class="operator">OF</span> _ k<span class="main">]</span>
        mu'_mu_large_row_im1 <span class="main">[</span><span class="operator">OF</span> _ k<span class="main">]</span>
        mu_no_change_large_row<span class="main">[</span><span class="operator">OF</span> _ k<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>
        mu'_mu_small_i
        mu'_mu_i_im1_j jk j k
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> new_g <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(* 16.13 (ii) : norm of g (i - 1) decreases by reduction factor *)</span>
    <span class="keyword1"><span class="command">note</span></span> sq_norm_g2_im1
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span> <span class="free">i</span> <span class="main">+</span> <span class="main">(</span><span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
      <span class="main">&lt;</span> <span class="main">1</span><span class="main">/</span><span class="free">α</span> <span class="main">*</span> <span class="main">(</span><span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> add_less_le_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ mult_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> norm_ineq<span class="main">[</span><span class="operator">unfolded</span> mult.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">α</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span>
          <span class="operator">THEN</span> linordered_field_class.mult_imp_less_div_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> α0<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="main">1</span><span class="main">/</span><span class="free">α</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> len i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> m12 <span class="keyword1"><span class="command">have</span></span> abs<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span><span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> abs <span class="main">(</span><span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> abs <span class="main">(</span><span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mult_mono<span class="main">[</span><span class="operator">OF</span> abs abs<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> reduction <span class="main">*</span> sq_norm <span class="main">(</span><span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> reduction_def  
      <span class="keyword1"><span class="command">using</span></span> α0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs add_divide_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> reduction <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> g_reduction <span class="main">=</span> this <span class="comment1">(* Lemma 16.13 (ii) *)</span>

  <span class="keyword1"><span class="command">have</span></span> lin_indpt_list_fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.lin_indpt_list <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def <span class="keyword1"><span class="command">using</span></span> conn2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
  <span class="comment1">(* stay reduced *)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"LLL_invariant False <span class="free">i</span> <span class="free">fs</span>"</span></span> 
    <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_invD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 
    <span class="keyword1"><span class="command">from</span></span> inv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weakly_reduced <span class="free">fs</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"weakly_reduced <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gram_schmidt_fs.weakly_reduced_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> red<span class="main">:</span> <span class="quoted"><span class="quoted">"weakly_reduced <span class="free">fs'</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gram_schmidt_fs.weakly_reduced_def <span class="keyword1"><span class="command">using</span></span> i G2_G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> inv <span class="keyword1"><span class="command">have</span></span> sred<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced <span class="free">fs</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> sred<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced <span class="free">fs'</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gram_schmidt_fs.reduced_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> red<span class="main"><span class="main">]</span></span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i'</span> <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> sred <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?mu1</span> <span class="skolem">i'</span> <span class="skolem">j</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gram_schmidt_fs.reduced_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> mu'_mu_small_i<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> mu_small<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_small <span class="free">fs'</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> μ_small_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="main">(</span>11<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> mu'_mu_i_im1_j<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> μ_small_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>      
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LLL_invariant False <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">fs'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LLL_invI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> lin_indpt_list_fs' conn2 mu_small span' lattice fs' sred i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> 

      
  <span class="comment1">(* invariant is established *)</span>
  <span class="keyword3"><span class="command">show</span></span> newInvw<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant_weak <span class="free">fs'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LLL_inv_wI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> lin_indpt_list_fs' conn2 span' lattice fs'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="comment1">(* show decrease in measure *)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(* 16.16 (ii), the decreasing case *)</span>
    <span class="keyword1"><span class="command">have</span></span> ile<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Gd<span class="main">[</span><span class="operator">OF</span> newInvw<span class="main">,</span> <span class="operator">folded</span> d_def<span class="main">,</span> <span class="operator">OF</span> ile<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">(</span>d <span class="free">fs'</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="var">?n2</span> <span class="bound">j</span> <span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> prod <span class="var">?n2</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> prod.cong<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">insert</span> i0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> prod <span class="var">?n2</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod <span class="var">?n2</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> prod <span class="var">?n1</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> g2_g1_identical<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>prod <span class="var">?n1</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.union_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> norm_pos1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> im1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod <span class="var">?n1</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> prod <span class="var">?n1</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"prod <span class="var"><span class="var"><span class="var">?n1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="var">?n1</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?R</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def Gd<span class="main">[</span><span class="operator">OF</span> Linvw ile<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> new_di<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">(</span>d <span class="free">fs'</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?R</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">(</span>reduction <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?R</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_strict_right_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> divide_strict_right_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> g_reduction norm_pos1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> im1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">insert</span> LLL_d_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Linvw<span class="main"><span class="main">]</span></span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>  
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> reduction <span class="main">*</span> <span class="var">?R</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> norm_pos1<span class="main">[</span><span class="operator">OF</span> im1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="free">fs'</span> <span class="free">i</span> <span class="main">&lt;</span> real_of_rat reduction <span class="main">*</span> d <span class="free">fs</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> of_rat_less of_rat_mult of_rat_of_int_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">note</span></span> this new_di
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> d_i <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> <span class="var">?R</span> <span class="main">(</span>d <span class="free">fs'</span> <span class="skolem">ii</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">ii</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?R</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="keyword1">else</span> <span class="var">?R</span> <span class="main">(</span>d <span class="free">fs</span> <span class="skolem">ii</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ii</span> <span class="keyword1"><span class="command">using</span></span> d_i d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> d <span class="free">fs'</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> d <span class="free">fs'</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> 
    <span class="keyword1"><span class="command">using</span></span> LLL_d_pos<span class="main">[</span><span class="operator">OF</span> newInvw<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> prodpos<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> d <span class="free">fs'</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prod_pos<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> LLL_d_pos<span class="main">[</span><span class="operator">OF</span> newInvw<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> prod_pos'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> real_of_int <span class="main">(</span>d <span class="free">fs'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prod_pos<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> LLL_d_pos<span class="main">[</span><span class="operator">OF</span> newInvw<span class="main">]</span> pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> prod_nonneg<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> real_of_int <span class="main">(</span>d <span class="free">fs'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prod_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> LLL_d_pos<span class="main">[</span><span class="operator">OF</span> newInvw<span class="main">]</span> pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> prodpos2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span><span class="main">(</span><span class="main">∏</span><span class="bound">ia</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> d <span class="free">fs</span> <span class="bound">ia</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prod_pos<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> LLL_d_pos<span class="main">[</span><span class="operator">OF</span> Linvw<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"D <span class="free">fs'</span> <span class="main">=</span> real_of_int <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> d <span class="free">fs'</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> D_def <span class="keyword1"><span class="command">using</span></span> prodpos <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> d <span class="free">fs'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> d <span class="free">fs'</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">…</span> <span class="main">=</span> real_of_int <span class="main">(</span><span class="main">∏</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> d <span class="free">fs'</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> real_of_int <span class="main">(</span>d <span class="free">fs'</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.union_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∏</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> d <span class="free">fs'</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>of_rat reduction <span class="main">*</span> d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mult_strict_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> d_i<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">insert</span> prod_pos'<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> d <span class="free">fs'</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> d <span class="free">fs</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> d<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">*</span> <span class="main">(</span>of_rat reduction <span class="main">*</span> d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> 
    <span class="main">=</span> of_rat reduction <span class="main">*</span> <span class="main">(</span><span class="main">∏</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> d <span class="free">fs</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.union_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> d <span class="free">fs</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> d <span class="free">fs</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">fs'</span> <span class="main">&lt;</span> real_of_rat reduction <span class="main">*</span> D <span class="free">fs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> D_def <span class="keyword1"><span class="command">using</span></span> prodpos2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> logD<span class="main">:</span> <span class="quoted"><span class="quoted">"logD <span class="free">fs'</span> <span class="main">&lt;</span> logD <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> <span class="numeral">4</span><span class="main">/</span><span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">unfolding</span></span> reduction<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> logD_def <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> False'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> <span class="numeral">4</span><span class="main">/</span><span class="numeral">3</span> <span class="main">⟷</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> False α <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&gt;</span> <span class="numeral">4</span><span class="main">/</span><span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> reduction <span class="keyword1"><span class="command">have</span></span> reduction1<span class="main">:</span> <span class="quoted"><span class="quoted">"reduction <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?new</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>D <span class="free">fs'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?old</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>D <span class="free">fs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?log</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"log <span class="main">(</span><span class="main">1</span><span class="main">/</span>of_rat reduction<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">note</span></span> pos <span class="main">=</span> LLL_D_pos<span class="main">[</span><span class="operator">OF</span> newInvw<span class="main">]</span> LLL_D_pos<span class="main">[</span><span class="operator">OF</span> Linvw<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> reduction <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_rat reduction <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> gediv<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span>real_of_rat reduction <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">/</span>of_rat reduction<span class="main">)</span> <span class="main">*</span> <span class="var">?new</span> <span class="main">≤</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">/</span>of_rat reduction<span class="main">)</span> <span class="main">*</span> of_rat reduction<span class="main">)</span> <span class="main">*</span> <span class="var">?old</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mult.assoc mult_le_cancel_iff2<span class="main">[</span><span class="operator">OF</span> gediv<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">/</span>of_rat reduction<span class="main">)</span> <span class="main">*</span> of_rat reduction <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduction <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">/</span>of_rat reduction<span class="main">)</span> <span class="main">*</span> <span class="var">?new</span> <span class="main">≤</span> <span class="var">?old</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?log</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">/</span>of_rat reduction<span class="main">)</span> <span class="main">*</span> <span class="var">?new</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?log</span> <span class="var">?old</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_le_cancel_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pos reduction1 reduction<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"floor <span class="main">(</span><span class="var">?log</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">/</span>of_rat reduction<span class="main">)</span> <span class="main">*</span> <span class="var">?new</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> floor <span class="main">(</span><span class="var">?log</span> <span class="var">?old</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> floor_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span>floor <span class="main">(</span><span class="var">?log</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">/</span>of_rat reduction<span class="main">)</span> <span class="main">*</span> <span class="var">?new</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> nat <span class="main">(</span>floor <span class="main">(</span><span class="var">?log</span> <span class="var">?old</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> logD <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> logD_def False' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?log</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">/</span>of_rat reduction<span class="main">)</span> <span class="main">*</span> <span class="var">?new</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="var">?log</span> <span class="var">?new</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> reduction reduction1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pos <span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"floor <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?log</span> <span class="var">?new</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> floor <span class="main">(</span><span class="var">?log</span> <span class="var">?new</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="main">1</span> <span class="main">+</span> floor <span class="main">(</span><span class="var">?log</span> <span class="var">?new</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> nat <span class="main">(</span>floor <span class="main">(</span><span class="var">?log</span> <span class="var">?new</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nat_add_distrib<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> pos reduction reduction1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span>floor <span class="main">(</span><span class="var">?log</span> <span class="var">?new</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> logD <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> logD_def False' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"logD <span class="free">fs'</span> <span class="main">&lt;</span> logD <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="free">fs</span> <span class="main">&gt;</span> LLL_measure <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> LLL_measure_def 
    <span class="keyword1"><span class="command">using</span></span> i logD <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL-LLL_inv_initial_state"><span class="command">lemma</span></span> LLL_inv_initial_state<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="main">0</span> <span class="free">fs_init</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">from</span></span> lin_dep<span class="main">[</span><span class="operator">unfolded</span> gs.lin_indpt_list_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RAT <span class="free">fs_init</span><span class="main">)</span> <span class="main">⊆</span> Rn"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> fs_init<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs_init</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LLL_invI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fs_init len _ _ lin_dep<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> L_def gs.reduced_def gs.weakly_reduced_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL-LLL_inv_m_imp_reduced"><span class="command">lemma</span></span> LLL_inv_m_imp_reduced<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">m</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reduced <span class="free">fs</span> <span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> LLL_invD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LLL-basis_reduction_short_vector"><span class="command">lemma</span></span> basis_reduction_short_vector<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> LLL_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">m</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> hd <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> L <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span>"</span></span>  
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> L <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> rat_of_int <span class="main">(</span>sq_norm <span class="free">v</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> rat_of_int <span class="main">(</span>sq_norm <span class="free">h</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">j</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs_init</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> α <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> LLL_invD<span class="main">[</span><span class="operator">OF</span> LLL_inv<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    L<span class="main">:</span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs</span> <span class="main">=</span> L"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> red<span class="main">:</span> <span class="quoted"><span class="quoted">"gram_schmidt_fs.weakly_reduced <span class="free">n</span> <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="free">α</span> <span class="main">(</span>length <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> basis<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_indep <span class="free">fs</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> lenH<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gs.lin_indpt_list_def gs.reduced_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> lin_dep <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs_init</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> m0 len <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>hd <span class="free">fs_init</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fs_init</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> v m0 lenH v <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> gs1<span class="main">:</span> gram_schmidt_fs_lin_indpt <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms LLL_invariant_def gs.lin_indpt_list_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_vec <span class="var">?r</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?rv</span> <span class="free">h</span>"</span></span> 
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> L <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?h_req</span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> h<span class="main">[</span><span class="operator">folded</span> L<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> lattice_of <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="main">=</span> <span class="var">?rv</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> of_int_hom.vec_hom_zero_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">h</span></span><span class="main">]</span> of_int_hom.vec_hom_inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> h <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">hence</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> lattice_of_of_int<span class="main">[</span><span class="operator">OF</span> H h<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="main">∈</span> gs.lattice_of <span class="var">?F</span> <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">from</span></span> gs1.weakly_reduced_imp_short_vector<span class="main">[</span><span class="operator">OF</span> red this a1<span class="main">]</span> lenH
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> L <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> <span class="var">?r</span> <span class="main">(</span>sq_norm <span class="free">v</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>sq_norm <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> basis <span class="keyword1"><span class="command">unfolding</span></span> L v gs.lin_indpt_list_def  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sq_norm_of_int<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> m0 H lenH <span class="keyword3"><span class="command">show</span></span> vn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> v <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> L"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> L<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> v <span class="keyword1"><span class="command">using</span></span> m0 H lenH
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> basis_in_latticeI<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">fs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"hd <span class="var">?F</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> v <span class="keyword1"><span class="command">using</span></span> m0 lenH <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> gs.lin_indpt_list_nonzero<span class="main">[</span><span class="operator">OF</span> basis<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> m0 lenH <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> vL <span class="keyword3"><span class="command">show</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> L <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> jn<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">j</span> <span class="main">∈</span> carrier_vec <span class="free">n</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> zero_vec_def carrier_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> v vn <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="LLL-LLL_mu_d_Z"><span class="command">lemma</span></span> LLL_mu_d_Z<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant_weak <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">ii</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">fs</span> <span class="free">ii</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> fs<span class="main">:</span> fs_int' <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">fs_init</span></span> <span class="quoted"><span class="free">fs</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> inv <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms fs.fs_int_mu_d_Z LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> d_def fs.d_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fs</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Linv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant_weak <span class="free">fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> gs1<span class="main">:</span> gram_schmidt_fs_lin_indpt <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> Linv LLL_invariant_weak_def gs.lin_indpt_list_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="LLL-LLL_inv_N_pos"><span class="command">lemma</span></span> LLL_inv_N_pos<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted">rat_of_int</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> inv <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">∈</span> Rn"</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> m <span class="keyword1"><span class="command">have</span></span> upt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> <span class="free">m</span><span class="main">]</span> <span class="main">=</span> <span class="main">0</span> <span class="main">#</span> <span class="main">[</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> upt_add_eq_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="main">(</span>6<span class="main">)</span> m <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_vec <span class="var">?r</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gs.lin_indpt_list_nonzero<span class="main">[</span><span class="operator">OF</span> inv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> F0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_vec_ge_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="main">0</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> gbnd m <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> of_nat N"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_bound_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gso <span class="free">fs</span> <span class="main">0</span> <span class="main">=</span> RAT <span class="free">fs</span> <span class="main">!</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> upt <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gs1.gso.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> map_vec <span class="var">?r</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="main">(</span>6<span class="main">)</span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">…</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>sq_norm <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_of_int<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted">N</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* equation (3) in front of Lemma 16.18 *)</span>
<span class="keyword1" id="LLL-d_approx_main"><span class="command">lemma</span></span> d_approx_main<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>d <span class="free">fs</span> <span class="free">ii</span><span class="main">)</span> <span class="main">≤</span> rat_of_nat <span class="main">(</span>N<span class="main">^</span><span class="free">ii</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_inv_N_pos i <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> N"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> inv<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> gram_schmidt_int_def gram_schmidt_wit_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>d <span class="free">fs</span> <span class="free">ii</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">ii</span><span class="main">.</span> <span class="main">∥</span>gso <span class="free">fs</span> <span class="bound">j</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">using</span></span> i
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Gramian_determinant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> Linv<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∏</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">ii</span><span class="main">.</span> of_nat N<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod_mono ballI conjI prod_nonneg<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gbnd<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> g_bound_def<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>of_nat N<span class="main">)</span><span class="main">^</span><span class="free">ii</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prod_constant <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_nat <span class="main">(</span>N<span class="main">^</span><span class="free">ii</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL-d_approx"><span class="command">lemma</span></span> d_approx<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>d <span class="free">fs</span> <span class="free">ii</span><span class="main">)</span> <span class="main">≤</span> rat_of_nat <span class="main">(</span>N<span class="main">^</span><span class="free">ii</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> d_approx_main<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ii</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="LLL-d_bound"><span class="command">lemma</span></span> d_bound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"d <span class="free">fs</span> <span class="free">ii</span> <span class="main">≤</span> N<span class="main">^</span><span class="free">ii</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> d_approx<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>


<span class="keyword1" id="LLL-D_approx"><span class="command">lemma</span></span> D_approx<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">fs</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_inv_N_pos <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> N"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> inv<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> gram_schmidt_int_def gram_schmidt_wit_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> d <span class="free">fs</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> rat_of_int <span class="main">(</span>d <span class="free">fs</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> <span class="main">(</span>of_nat N<span class="main">)</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> d_approx LLL_d_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Linv<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> <span class="main">(</span>of_nat N <span class="main">^</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> N<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pow_mono_exp<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>of_nat N<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prod_constant power_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_nat <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> d <span class="free">fs</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> d <span class="free">fs</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> D <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> D_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nat_0_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> prod_nonneg<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> LLL_d_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Linv<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_less<span class="main">)</span>  
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"D <span class="free">fs</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="LLL-LLL_measure_approx"><span class="command">lemma</span></span> LLL_measure_approx<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&gt;</span> <span class="numeral">4</span><span class="main">/</span><span class="numeral">3</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="free">fs</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> log base N"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>   
  <span class="keyword1"><span class="command">have</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"base <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"base <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> real_of_rat reduction"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> base_def reduction_def <span class="keyword1"><span class="command">using</span></span> α0 <span class="keyword1"><span class="command">by</span></span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> of_rat_divide<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_D_pos<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> D1<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>D <span class="free">fs</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> invD <span class="main">=</span> LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>  
  <span class="keyword1"><span class="command">from</span></span> invD
  <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> N0<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LLL_inv_N_pos<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> D_approx 
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">fs</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>D <span class="free">fs</span><span class="main">)</span> <span class="main">≤</span> real <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> log<span class="main">:</span> <span class="quoted"><span class="quoted">"log base <span class="main">(</span>real <span class="main">(</span>D <span class="free">fs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> log base <span class="main">(</span>real N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>   
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_le_cancel_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> b1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> D1 N0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>logD <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span>nat <span class="main">⌊</span>log base <span class="main">(</span>real <span class="main">(</span>D <span class="free">fs</span><span class="main">)</span><span class="main">)</span><span class="main">⌋</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> logD_def id <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log base <span class="main">(</span>real <span class="main">(</span>D <span class="free">fs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b1 D1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log base <span class="main">(</span>real N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> log base <span class="main">(</span>real N<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> log_nat_power<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> N0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> main<span class="main">:</span> <span class="quoted"><span class="quoted">"logD <span class="free">fs</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> log base N"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>LLL_measure <span class="free">i</span> <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> logD <span class="free">fs</span> <span class="main">+</span> <span class="free">m</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> LLL_measure_def split invD<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> real <span class="main">(</span>logD <span class="free">fs</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invD <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> log base N<span class="main">)</span> <span class="main">+</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> main <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="LLL-g_bound_fs_init"><span class="command">lemma</span></span> g_bound_fs_init<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs_init</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>nat <span class="keyword1">o</span> sq_norm<span class="main">)</span> <span class="free">fs_init</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted">rat_of_int</span>
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span>sq_norm <span class="main">(</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fs_init len <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">interpret</span></span> gs<span class="main">:</span> gram_schmidt_fs_lin_indpt <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs_init</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> len lin_dep LLL_invariant_def gs.lin_indpt_list_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> mem_set_imp_le_max_list<span class="main">[</span><span class="operator">OF</span> _ mem<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> FN<span class="main">:</span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span>sq_norm <span class="main">(</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> N"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> N_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> int N"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> f_bnd<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> FN <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_nat <span class="main">(</span>nat <span class="main">(</span>sq_norm <span class="main">(</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> rat_of_nat N"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_nat <span class="main">(</span>nat <span class="main">(</span>sq_norm <span class="main">(</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>sq_norm <span class="main">(</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> sq_norm_vec_ge_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sq_norm <span class="main">(</span>RAT <span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_of_int<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> fs_init len i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>RAT <span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> rat_of_nat N"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> gs.sq_norm_gso_le_f i len lin_dep
    <span class="keyword1"><span class="command">have</span></span> g_bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>gs.gso <span class="skolem">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> rat_of_nat N"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">note</span></span> f_bnd g_bnd
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs_init</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_bound_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL-LLL_measure_approx_fs_init"><span class="command">lemma</span></span> LLL_measure_approx_fs_init<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs_init</span> <span class="main">⟹</span> <span class="numeral">4</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">&lt;</span> <span class="free">α</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> 
  real <span class="main">(</span>LLL_measure <span class="free">i</span> <span class="free">fs_init</span><span class="main">)</span> <span class="main">≤</span> real <span class="free">m</span> <span class="main">+</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> log base <span class="main">(</span>real N<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> LLL_measure_approx<span class="main">[</span><span class="operator">OF</span> LLL_inv_imp_w g_bound_fs_init<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="LLL-N_le_MMn"><span class="command">lemma</span></span> N_le_MMn<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"N <span class="main">≤</span> nat M <span class="main">*</span> nat M <span class="main">*</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> N_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> max_list_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> set_map o_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ni</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ni</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nat <span class="main">∥</span><span class="bound">x</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">`</span> set <span class="free">fs_init</span>"</span></span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fi</span></span> <span class="keyword2"><span class="keyword">where</span></span> ni<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ni</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">∥</span><span class="skolem">fi</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fi</span> <span class="main">∈</span> set <span class="free">fs_init</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fi len <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> fii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fi</span> <span class="main">=</span> <span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fi fs_init <span class="keyword1"><span class="command">have</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fi</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?set</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">¦</span><span class="free">fs_init</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">¦</span> <span class="main">|</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?set</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> abs <span class="main">(</span><span class="free">fs_init</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?set</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"M <span class="main">≥</span> <span class="main">¦</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">using</span></span> i
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max_ge<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"abs <span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">fs_init</span></span></span> <span class="main"><span class="main"><span class="main">!</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">i</span></span></span> <span class="main"><span class="main"><span class="main">$</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">j</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> fin<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> M <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> Max_ge<span class="main">[</span><span class="operator">OF</span> fin<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> M0<span class="main">:</span> <span class="quoted"><span class="quoted">"M <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ni</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">∥</span><span class="skolem">fi</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ni <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> nat <span class="main">(</span>int <span class="free">n</span> <span class="main">*</span> <span class="main">∥</span><span class="skolem">fi</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_vec_le_linf_norm<span class="main">[</span><span class="operator">OF</span> fi<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nat_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">n</span> <span class="main">*</span> nat <span class="main">(</span><span class="main">∥</span><span class="skolem">fi</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_mult_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">*</span> nat <span class="main">(</span>M<span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nat_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">fi</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span> <span class="main">≤</span> M"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> linf_norm_vec_def    
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> max_list_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> set_append set_map<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> abs <span class="main">`</span> set <span class="main">(</span>list_of_vec <span class="skolem">fi</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">[</span><span class="main">0</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">x</span> <span class="main">≤</span> M"</span></span>  
      <span class="keyword1"><span class="command">with</span></span> M0 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fij</span></span> <span class="keyword2"><span class="keyword">where</span></span> fij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fij</span> <span class="main">∈</span> set <span class="main">(</span>list_of_vec <span class="skolem">fi</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> abs <span class="skolem">fij</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> fij fi <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fij</span> <span class="main">=</span> <span class="skolem">fi</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> set_list_of_vec vec_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> M<span class="main">[</span><span class="operator">OF</span> j<span class="main">]</span> xM<span class="main">[</span><span class="operator">unfolded</span> x fij fii<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>                
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">fi</span><span class="main">∥<span class="hidden">⇩</span><sub>∞</sub></span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> M<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> abs_le_square_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> fi 
      <span class="keyword1"><span class="command">using</span></span> linf_norm_vec_ge_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">fi</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ni</span> <span class="main">≤</span> nat M <span class="main">*</span> nat M <span class="main">*</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> M0 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nat_mult_distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> m0 len<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic LLL implementation based on previous results›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now assemble a basic implementation of the LLL algorithm,
  where only the lattice basis is updated, and where the GSO and the $\mu$-values
  are always computed from scratch. This enables a simple soundness proof 
  and permits to separate an efficient implementation from the soundness reasoning.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">basis_reduction_add_rows_loop</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_add_rows_loop</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_add_rows_loop</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">let</span> <span class="bound">c</span> <span class="main">=</span> round <span class="main">(</span>μ <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">;</span>
         <span class="bound">fs'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">[</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="bound">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span><span class="main">)</span>
      <span class="keyword1">in</span> <span class="free">basis_reduction_add_rows_loop</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">fs'</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">basis_reduction_add_rows</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_add_rows</span> <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="keyword1">then</span> basis_reduction_add_rows_loop <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">basis_reduction_swap</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_swap</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">!</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">basis_reduction_step</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_step</span> <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">let</span> 
       <span class="bound">fs'</span> <span class="main">=</span> basis_reduction_add_rows <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span>
     <span class="keyword1">in</span> <span class="keyword1">if</span> sq_norm <span class="main">(</span>gso <span class="bound">fs'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="bound">fs'</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
          <span class="main">(</span>True<span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="bound">fs'</span><span class="main">)</span> 
        <span class="keyword1">else</span> basis_reduction_swap <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">fs'</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">function</span></span> <span class="entity">basis_reduction_main</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_main</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">upw</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> LLL_invariant <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span>
     <span class="keyword1">then</span> <span class="free">basis_reduction_main</span> <span class="main">(</span>basis_reduction_step <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="keyword1">else</span>
     <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduce_basis</span> <span class="main">=</span> basis_reduction_main <span class="main">(</span>True<span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="free">fs_init</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">short_vector</span> <span class="main">=</span> hd reduce_basis"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Soundness of this implementation is easily proven›</span></span>

<span class="keyword1" id="LLL-basis_reduction_add_rows_loop"><span class="command">lemma</span></span> basis_reduction_add_rows_loop<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 
  inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> mu_small<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_small_row <span class="free">i</span> <span class="free">fs</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_add_rows_loop <span class="free">i</span> <span class="free">fs</span> <span class="free">j</span> <span class="main">=</span> <span class="free">fs'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_invariant False <span class="free">i</span> <span class="free">fs'</span>"</span></span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="free">fs'</span> <span class="main">=</span> LLL_measure <span class="free">i</span> <span class="free">fs</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">fs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0 <span class="skolem">fs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> basis_reduction_add_row_done<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">fs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span> <span class="skolem">fs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"round <span class="main">(</span>μ <span class="skolem">fs</span> <span class="free">i</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> basis_reduction_add_row_main_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> LLL_inv_imp_w<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> i j True Suc<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      Suc<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> basis_reduction_add_row_main<span class="main">(</span>2-<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> LLL_inv_imp_w<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span></span></span></span> Suc<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span></span></span> i j refl<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> step<span class="main">(</span>2-<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> step<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span> False Suc<span class="main">(</span>2-<span class="main">)</span> step<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL-basis_reduction_add_rows"><span class="command">lemma</span></span> basis_reduction_add_rows<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 
  inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_add_rows <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="free">fs'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_invariant False <span class="free">i</span> <span class="free">fs'</span>"</span></span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="free">fs'</span> <span class="main">=</span> LLL_measure <span class="free">i</span> <span class="free">fs</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">note</span></span> def <span class="main">=</span> basis_reduction_add_rows_def
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">upw</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> res inv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> inv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> start <span class="main">=</span> this μ_small_row_refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">fs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> def<span class="main">]</span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"basis_reduction_add_rows_loop <span class="free">i</span> <span class="free">fs</span> <span class="free">i</span> <span class="main">=</span> <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> basis_reduction_add_rows_loop<span class="main">[</span><span class="operator">OF</span> start this i<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL-basis_reduction_swap"><span class="command">lemma</span></span> basis_reduction_swap<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 
  inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant False <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_swap <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="main">(</span><span class="free">upw'</span><span class="main">,</span><span class="free">i'</span><span class="main">,</span><span class="free">fs'</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">α</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw'</span> <span class="free">i'</span> <span class="free">fs'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span><span class="main">)</span>
  <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i'</span> <span class="free">fs'</span> <span class="main">&lt;</span> LLL_measure <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> def <span class="main">=</span> basis_reduction_swap_def
  <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> basis_reduction_swap_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">upw'</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> <span class="free">fs</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> basis_reduction_swap_main<span class="main">(</span>2-3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invw _ i cond id<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> inv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL-basis_reduction_step"><span class="command">lemma</span></span> basis_reduction_step<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 
  inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_step <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="main">(</span><span class="free">upw'</span><span class="main">,</span><span class="free">i'</span><span class="main">,</span><span class="free">fs'</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw'</span> <span class="free">i'</span> <span class="free">fs'</span>"</span></span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i'</span> <span class="free">fs'</span> <span class="main">&lt;</span> LLL_measure <span class="free">i</span> <span class="free">fs</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">note</span></span> def <span class="main">=</span> basis_reduction_step_def
  <span class="keyword1"><span class="command">note</span></span> invw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> fs''<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_add_rows <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="skolem">fs''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> increase_i<span class="main">[</span><span class="operator">OF</span> inv i<span class="main">]</span> True
      res <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> def id if_False fs'' Let_def<span class="main">]</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="skolem">fs''</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="skolem">fs''</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> basis_reduction_add_rows<span class="main">[</span><span class="operator">OF</span> inv fs'' i<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant False <span class="free">i</span> <span class="skolem">fs''</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> meas<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="skolem">fs''</span> <span class="main">=</span> LLL_measure <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> invw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">≤</span> <span class="var">?y</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> increase_i<span class="main">[</span><span class="operator">OF</span> inv i<span class="main">]</span> id True res meas
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt<span class="main">:</span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">&gt;</span> <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> basis_reduction_swap<span class="main">[</span><span class="operator">OF</span> inv _ this i False<span class="main">]</span> gt res meas
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">upw</span><span class="main">,</span><span class="bound">i</span><span class="main">,</span><span class="bound">fs</span><span class="main">)</span><span class="main">.</span> LLL_measure <span class="bound">i</span> <span class="bound">fs</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> basis_reduction_step<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> basis_reduction_main.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="LLL-basis_reduction_main"><span class="command">lemma</span></span> basis_reduction_main<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_main <span class="main">(</span><span class="free">upw</span><span class="main">,</span><span class="free">i</span><span class="main">,</span><span class="free">fs</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs'</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">m</span> <span class="free">fs'</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="free">upw</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">i</span> <span class="skolem">fs</span> <span class="skolem">upw</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="skolem">upw</span> <span class="skolem">i</span> <span class="skolem">fs</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> less<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> basis_reduction_main.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">upw</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">fs</span></span><span class="main"><span class="main">]</span></span> id<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> less<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> less<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> i<span class="main">:</span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">fs'</span></span> <span class="skolem"><span class="skolem">upw'</span></span> <span class="keyword2"><span class="keyword">where</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_step <span class="skolem">upw</span> <span class="skolem">i</span> <span class="skolem">fs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">upw'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">,</span><span class="skolem">fs'</span><span class="main">)</span>"</span></span> 
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?step</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?step</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> basis_reduction_step<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv step i<span class="main"><span class="main">]</span></span><span class="main">]</span> res<span class="main">[</span><span class="operator">unfolded</span> step<span class="main">]</span> i
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> LLL_invD<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> False res inv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="skolem">upw</span> <span class="free">m</span> <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">m</span> <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> LLL_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL-reduce_basis_inv"><span class="command">lemma</span></span> reduce_basis_inv<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"reduce_basis <span class="main">=</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">m</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> basis_reduction_main<span class="main">[</span><span class="operator">OF</span> LLL_inv_initial_state res<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> reduce_basis_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="LLL-reduce_basis"><span class="command">lemma</span></span> reduce_basis<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"reduce_basis <span class="main">=</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs</span> <span class="main">=</span> L"</span></span> 
  <span class="quoted"><span class="quoted">"reduced <span class="free">fs</span> <span class="free">m</span>"</span></span> 
  <span class="quoted"><span class="quoted">"lin_indep <span class="free">fs</span>"</span></span> 
  <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> LLL_invD<span class="main">[</span><span class="operator">OF</span> reduce_basis_inv<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span></span></span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span></span></span></span></span></span></span></span> res<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  
<span class="keyword1" id="LLL-short_vector"><span class="command">lemma</span></span> short_vector<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"short_vector <span class="main">=</span> <span class="free">v</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> L <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span>"</span></span>  
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> L <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> rat_of_int <span class="main">(</span>sq_norm <span class="free">v</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> rat_of_int <span class="main">(</span>sq_norm <span class="free">h</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">j</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> basis_reduction_short_vector<span class="main">[</span><span class="operator">OF</span> reduce_basis_inv<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span> refl<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span> res<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">symmetric</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span></span> <span class="operator"><span class="operator"><span class="operator"><span class="operator">unfolded</span></span></span></span> short_vector_def<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span> m0<span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LLL_Impl">
<div class="head">
<h1>Theory LLL_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    René Thiemann
    License:    BSD
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Integer LLL Implementation which Stores Multiples of the $\mu$-Values›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this part we aim to update the integer values $d\,(j+1) * \mu_{i,j}$ as well as the
  Gramian determinants $d\,i$. ›</span></span>


<span class="keyword1"><span class="command">theory</span></span> LLL_Impl
  <span class="keyword2"><span class="keyword">imports</span></span>
   <a href="#LLL">LLL</a>
   <a href="#List_Representation">List_Representation</a>
   <a href="#Gram_Schmidt_Int">Gram_Schmidt_Int</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Updates of the integer values for Swap, Add, etc.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We provide equations how to implement the LLL-algorithm by storing the integer values
  $d\, (j+1) * \mu_{i,j}$ and all $d\ i$ in addition to the vectors in $f$.
  Moreover, we show how to check condition like the one on norms via the integer values.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">round_num_denom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">round_num_denom</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="LLL_Impl-round_num_denom"><span class="command">lemma</span></span> round_num_denom<span class="main">:</span> <span class="quoted"><span class="quoted">"round_num_denom <span class="free">num</span> <span class="free">denom</span> <span class="main">=</span> 
  round <span class="main">(</span>of_int <span class="free">num</span> <span class="main">/</span> rat_of_int <span class="free">denom</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">denom</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">denom</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> round_def round_num_denom_def
    <span class="keyword1"><span class="command">unfolding</span></span> floor_divide_of_int_eq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span> <span class="main"><span class="main">=</span></span> <span class="quoted">rat</span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">floor</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_divide_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True round_num_denom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> fs_int_indpt
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="LLL_Impl-round_num_denom_dμ_d"><span class="command">lemma</span></span> round_num_denom_dμ_d<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span>  
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"round_num_denom <span class="main">(</span>dμ <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> round <span class="main">(</span>gs.μ <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> j i <span class="keyword1"><span class="command">have</span></span> sj<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span> <span class="main">≤</span> m"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> round_num_denom
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">round</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> dμ<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ i<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j i fs_int_d_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sj<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Impl-d_sq_norm_comparison"><span class="command">lemma</span></span> d_sq_norm_comparison<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> quot<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="free">α</span> <span class="main">=</span> <span class="main">(</span><span class="free">num</span><span class="main">,</span><span class="free">denom</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> m"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span> <span class="main">*</span> d <span class="free">fs</span> <span class="free">i</span> <span class="main">*</span> <span class="free">denom</span> <span class="main">≤</span> <span class="free">num</span> <span class="main">*</span> d <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>
   <span class="main">=</span> <span class="main">(</span>sq_norm <span class="main">(</span>gs.gso <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span> <span class="main">*</span> sq_norm <span class="main">(</span>gs.gso <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gs.gso <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">*</span> sq_norm <span class="main">(</span>gs.gso <span class="free">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> m"</span></span> <span class="quoted"><span class="quoted">" <span class="free">i</span> <span class="main">≤</span> m"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">≤</span> m"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> pos <span class="main">=</span> fs_int_d_pos<span class="main">[</span><span class="operator">OF</span> le<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> fs_int_d_pos<span class="main">[</span><span class="operator">OF</span> le<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> quotient_of_denom_pos<span class="main">[</span><span class="operator">OF</span> quot<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span> <span class="main">*</span> d <span class="free">fs</span> <span class="free">i</span> <span class="main">*</span> <span class="free">denom</span> <span class="main">≤</span> <span class="free">num</span> <span class="main">*</span> d <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span> <span class="main">*</span> d <span class="free">fs</span> <span class="free">i</span> <span class="main">*</span> <span class="free">denom</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?r</span> <span class="main">(</span><span class="free">num</span> <span class="main">*</span> d <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cond</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="free">denom</span> <span class="main">≤</span> <span class="var">?r</span> <span class="free">num</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> pos <span class="keyword1"><span class="command">unfolding</span></span> quotient_of_div<span class="main">[</span><span class="operator">OF</span> quot<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="main">/</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span> <span class="main">*</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="main">/</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fs_int_d_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> pos i i0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">*</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fs_int_d_Suc<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> pos i i0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cond</span> <span class="main">=</span> <span class="main">(</span><span class="var">?x</span> <span class="main">≤</span> <span class="var">?y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">context</span></span> LLL
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="LLL_Impl-d_dμ_add_row"><span class="command">lemma</span></span> d_dμ_add_row<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> Linv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant_weak <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> <span class="free">fs</span><span class="main">[</span> <span class="free">i</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">]</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span>  
  <span class="comment1">(* d-updates: none *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ii</span><span class="main">.</span> <span class="bound">ii</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> d <span class="free">fs'</span> <span class="bound">ii</span> <span class="main">=</span> d <span class="free">fs</span> <span class="bound">ii</span>"</span></span> 
  <span class="comment1">(* dμ-updates: *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i'</span> <span class="bound">j'</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="bound">j'</span> <span class="main">&lt;</span> <span class="bound">i'</span> <span class="main">⟹</span>       
     dμ <span class="free">fs'</span> <span class="bound">i'</span> <span class="bound">j'</span> <span class="main">=</span> <span class="main">(</span>
       <span class="keyword1">if</span> <span class="bound">i'</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> <span class="bound">j'</span> <span class="main">&lt;</span> <span class="free">j</span> 
         <span class="keyword1">then</span> dμ <span class="free">fs</span> <span class="bound">i'</span> <span class="bound">j'</span> <span class="main">-</span> <span class="free">c</span> <span class="main">*</span> dμ <span class="free">fs</span> <span class="free">j</span> <span class="bound">j'</span> 
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">i'</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> <span class="bound">j'</span> <span class="main">=</span> <span class="free">j</span> 
         <span class="keyword1">then</span> dμ <span class="free">fs</span> <span class="bound">i'</span> <span class="bound">j'</span> <span class="main">-</span> <span class="free">c</span> <span class="main">*</span> d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> 
       <span class="keyword1">else</span> dμ <span class="free">fs</span> <span class="bound">i'</span> <span class="bound">j'</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i'</span> <span class="bound">j'</span><span class="main">.</span> <span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">=</span> <span class="var">?new_mu</span> <span class="bound">i'</span> <span class="bound">j'</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> fs<span class="main">:</span> fs_int' <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">fs_init</span></span> <span class="quoted"><span class="free">fs</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> Linv <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> add <span class="main">=</span> basis_reduction_add_row_main<span class="main">[</span><span class="operator">OF</span> Linv i j fs'<span class="main">]</span>
  <span class="keyword1"><span class="command">interpret</span></span> fs'<span class="main">:</span> fs_int' <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">fs_init</span></span> <span class="quoted"><span class="free">fs'</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> add <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ii</span><span class="main">.</span> <span class="bound">ii</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> d <span class="free">fs'</span> <span class="bound">ii</span> <span class="main">=</span> d <span class="free">fs</span> <span class="bound">ii</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> <span class="skolem">j'</span>
  <span class="keyword3"><span class="command">assume</span></span> i'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span>    
  <span class="keyword1"><span class="command">hence</span></span> j'm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≤</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> updates <span class="main">=</span> add<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> i' j'm<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dμ <span class="free">fs'</span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="main">=</span> <span class="var">?new_mu</span> <span class="skolem">i'</span> <span class="skolem">j'</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> d i' j' <span class="keyword1"><span class="command">unfolding</span></span> dμ_def updates <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> id'<span class="main">:</span> <span class="quoted"><span class="quoted">"d <span class="free">fs'</span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span> <span class="main">=</span> d <span class="free">fs</span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> d<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i' j'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> fs'.dμ<span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>dμ <span class="free">fs'</span> <span class="skolem">i'</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">=</span> rat_of_int <span class="main">(</span>d <span class="free">fs'</span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> fs'.gs.μ <span class="skolem">i'</span> <span class="skolem">j'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dμ_def d_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> fs'.dμ<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fs'.dμ_def fs'.d_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> j' i'  LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> add<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>dμ <span class="free">fs</span> <span class="skolem">i'</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">=</span> rat_of_int <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> fs.gs.μ <span class="skolem">i'</span> <span class="skolem">j'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dμ_def d_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> fs.dμ<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fs.dμ_def fs.d_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> j' i' LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>dμ <span class="free">fs</span> <span class="free">j</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">=</span> rat_of_int <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> fs.gs.μ <span class="free">j</span> <span class="skolem">j'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dμ_def d_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> fs.dμ<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fs.dμ_def fs.d_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> that j i LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> int_via_rat_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> if_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">rat_of_int</span></span><span class="main"><span class="main">]</span></span> of_int_diff of_int_mult ** * updates id' ring_distribs<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> True i' j' i j<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs.gs.μ.simps <span class="dynamic"><span class="dynamic">algebra_simps</span></span> ***<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> LLL_with_assms
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="LLL_Impl-d_dμ_swap"><span class="command">lemma</span></span> d_dμ_swap<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> invw<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant_weak <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> small<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant False <span class="free">k</span> <span class="free">fs</span> <span class="main">∨</span> abs <span class="main">(</span>μ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> k0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> norm_ineq<span class="main">:</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">α</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> fs'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> <span class="free">fs</span><span class="main">[</span><span class="free">k</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">k</span><span class="main">]</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="comment1">(* d-updates *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span>
      d <span class="free">fs'</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>
        <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">k</span> <span class="keyword1">then</span> 
          <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">*</span> d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> dμ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> dμ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> d <span class="free">fs</span> <span class="free">k</span> 
        <span class="keyword1">else</span> d <span class="free">fs</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="comment1">(* dμ-updates *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">⟹</span> 
      dμ <span class="free">fs'</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">(</span>
        <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> 
           dμ <span class="free">fs</span> <span class="free">k</span> <span class="bound">j</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≠</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> 
             dμ <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">j</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">k</span> <span class="keyword1">then</span>
           <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">*</span> dμ <span class="free">fs</span> <span class="bound">i</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> dμ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> dμ <span class="free">fs</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="keyword1">div</span> d <span class="free">fs</span> <span class="free">k</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> 
           <span class="main">(</span>dμ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> dμ <span class="free">fs</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">+</span> dμ <span class="free">fs</span> <span class="bound">i</span> <span class="free">k</span> <span class="main">*</span> d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> d <span class="free">fs</span> <span class="free">k</span>
        <span class="keyword1">else</span> dμ <span class="free">fs</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">=</span> <span class="var">?new_mu</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> swap <span class="main">=</span> basis_reduction_swap_main<span class="main">[</span><span class="operator">OF</span> invw small k k0 norm_ineq fs'_def<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> invw2 <span class="main">=</span> swap<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> swap <span class="main">=</span> swap<span class="main">(</span>1<span class="main">,</span>3-<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> k k0 <span class="keyword1"><span class="command">have</span></span> kk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">k</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> invw<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> fs<span class="main">:</span> fs_int' <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">fs_init</span></span> <span class="quoted"><span class="free">fs</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> invw <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> fs'<span class="main">:</span> fs_int' <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">fs_init</span></span> <span class="quoted"><span class="free">fs'</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> invw2 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted">rat_of_int</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> sq_norm <span class="main">(</span>gso <span class="free">fs'</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="bound">i</span> <span class="main">*</span> d <span class="free">fs</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n</span> <span class="bound">i</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dn'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs'</span> <span class="bound">i</span> <span class="main">*</span> d <span class="free">fs'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n'</span> <span class="bound">i</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dmu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">fs</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dmu'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs'</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">fs'</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> dmu <span class="main">=</span> fs.dμ
  <span class="keyword1"><span class="command">note</span></span> dmu' <span class="main">=</span> fs'.dμ
  <span class="keyword1"><span class="command">note</span></span> inv' <span class="main">=</span> LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> invw<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> nim1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="free">k</span> <span class="main">+</span> square_rat <span class="main">(</span>μ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> 
    <span class="var">?n'</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> swap<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ni<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="var">?n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n'</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?n'</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> swap<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> k k0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> mu'<span class="main">:</span> <span class="quoted"><span class="quoted">"μ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n'</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> μ <span class="free">fs'</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> swap<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> k k0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs'</span> <span class="main">!</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="free">fs'</span> <span class="main">!</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">using</span></span> inv'<span class="main">(</span>6<span class="main">)</span> k k0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d'i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">*</span> d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> dμ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> dμ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> rat'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="var">?r</span> <span class="main">(</span>dμ <span class="free">fs'</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="var">?dmu'</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span> 
     <span class="keyword1"><span class="command">using</span></span> dmu'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> invw2<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> dμ_def fs'.dμ_def d_def fs'.d_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">have</span></span> rat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="var">?r</span> <span class="main">(</span>dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="var">?dmu</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
     <span class="keyword1"><span class="command">using</span></span> dmu<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> invw<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> dμ_def fs.dμ_def d_def fs.d_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> k k0 <span class="keyword1"><span class="command">have</span></span> sim1<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> km1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_d_Suc<span class="main">[</span><span class="operator">OF</span> invw km1<span class="main">,</span> <span class="operator">unfolded</span> sim1<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> dn_km1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?dn</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> pos <span class="main">=</span> Gramian_determinant<span class="main">[</span><span class="operator">OF</span> invw le_refl<span class="main">]</span> 
  <span class="keyword1"><span class="command">from</span></span> pos<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>gs.Gramian_determinant <span class="free">fs</span> <span class="free">m</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> pos<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> nzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="var">?n</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> pos <span class="main">=</span> Gramian_determinant<span class="main">[</span><span class="operator">OF</span> invw2 le_refl<span class="main">]</span> 
  <span class="keyword1"><span class="command">from</span></span> pos<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>gs.Gramian_determinant <span class="free">fs'</span> <span class="free">m</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> pos<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> nzero'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="var">?n'</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> d <span class="free">fs</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> LLL_d_pos<span class="main">[</span><span class="operator">OF</span> invw<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dzero'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> d <span class="free">fs'</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> LLL_d_pos<span class="main">[</span><span class="operator">OF</span> invw2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">start</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">start</span> <span class="main">=</span> <span class="var">?dmu'</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">start</span> <span class="main">=</span> <span class="main">(</span><span class="var">?n'</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">fs'</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> start_def swap<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> k k0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"μ <span class="free">fs'</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> μ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n'</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> mu' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?n'</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> nzero<span class="main">[</span><span class="operator">OF</span> km1<span class="main">]</span> nzero'<span class="main">[</span><span class="operator">OF</span> km1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?dmu</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dmu'</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?dmu</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> start_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> dmu_i_im1 <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(* d updates *)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> 
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">start</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">start</span> <span class="main">=</span> d <span class="free">fs'</span> <span class="skolem">j</span>"</span></span> 
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="free">k</span>"</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">start</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs'</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> start_def <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>d <span class="free">fs'</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> swap<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j jj<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">start</span> <span class="main">=</span> d <span class="free">fs</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> d_j <span class="main">=</span> this 
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">k</span>"</span></span>  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">start</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs'</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> start_def <span class="keyword1"><span class="command">unfolding</span></span> jj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?n'</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> swap<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n'</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> 
          <span class="main">*</span> <span class="main">(</span><span class="var">?n</span> <span class="free">k</span>  <span class="main">+</span> μ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> swap<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> km1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> dzero<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> LLL_d_Suc<span class="main">[</span><span class="operator">OF</span> invw km1<span class="main">,</span> <span class="operator">unfolded</span> sim1<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> dzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> k k0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">start</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="var">?dmu</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?dmu</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> 
          <span class="main">/</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> k k0 dzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> dzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n</span> <span class="free">k</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> LLL_d_Suc<span class="main">[</span><span class="operator">OF</span> invw k<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dmu</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>dμ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> rat<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> k k0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">start</span> <span class="main">=</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">*</span> d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> dμ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> dμ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">/</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> division_to_div<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">start</span> <span class="main">=</span> <span class="var">?d'i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> d_i <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> d_j d_i <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"d <span class="free">fs'</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">k</span> <span class="keyword1">then</span> <span class="var">?d'i</span> <span class="keyword1">else</span> d <span class="free">fs</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> start_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">fs'</span> <span class="main">=</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fs'_def inv'<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> j i <span class="keyword1"><span class="command">have</span></span> sj<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> swaps <span class="main">=</span> swap<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> i j<span class="main">]</span> swap<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> sj<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dμ <span class="free">fs'</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?new_mu</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> small<span class="main">:</span> True
      <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?new_mu</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> swaps small i j k k0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dμ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> j i <span class="keyword1"><span class="command">have</span></span> sj<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?start</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dμ <span class="free">fs'</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> 
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">start</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">start</span> <span class="main">=</span> <span class="var">?start</span>"</span></span> 
      <span class="keyword1"><span class="command">note</span></span> rat'<span class="main">[</span><span class="operator">OF</span> i j<span class="main">]</span>
      <span class="keyword1"><span class="command">note</span></span> rat_i_j <span class="main">=</span> rat<span class="main">[</span><span class="operator">OF</span> i j<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>i_k<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="main">(</span>i_small<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="main">|</span> 
          <span class="main">(</span>i_km1<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="main">(</span>i_large<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> *<span class="main">:</span> i_small
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> swaps dμ_def <span class="keyword1"><span class="command">using</span></span> * i k k0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> *<span class="main">:</span> i_k
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> dmu_i_im1 rat_i_j * k0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dμ_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> *<span class="main">:</span> i_km1
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> swaps dμ_def <span class="keyword1"><span class="command">using</span></span> * i j k k0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> *<span class="main">:</span> i_large
        <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>jj<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="free">k</span>"</span></span> <span class="main">|</span> <span class="main">(</span>ji<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="main">|</span> <span class="main">(</span>jim1<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> jj
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> swaps dμ_def <span class="keyword1"><span class="command">using</span></span> * i j jj k k0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> ji
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">start</span> <span class="main">=</span> <span class="var">?dmu'</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> start_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>d <span class="free">fs'</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> swaps <span class="keyword1"><span class="command">unfolding</span></span> ji <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"μ <span class="free">fs'</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> μ <span class="free">fs</span> <span class="skolem">i</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> μ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">fs</span> <span class="skolem">i</span> <span class="free">k</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> swaps <span class="keyword1"><span class="command">unfolding</span></span> ji <span class="keyword1"><span class="command">using</span></span> k0 * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">…</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> dzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  
            <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?dmu</span> <span class="skolem">i</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?dmu</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?dmu</span> <span class="skolem">i</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> k0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> 
            <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="var">?r</span> <span class="main">(</span>dμ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> rat<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> k k0 i *<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">*</span> dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> dμ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
            <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> of_int <span class="var">?x</span> <span class="main">/</span> <span class="main">_</span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">start</span> <span class="main">=</span> <span class="var">?r</span> <span class="var">?x</span> <span class="main">/</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">from</span></span> division_to_div<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?start</span> <span class="main">=</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">*</span> dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> dμ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="keyword1">div</span> d <span class="free">fs</span> <span class="free">k</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> start_def ji <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">using</span></span> * ji <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> jim1
          <span class="keyword1"><span class="command">hence</span></span> id''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span> <span class="main">=</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">using</span></span> k0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span><span class="skolem">start</span><span class="main">)</span> <span class="main">=</span> <span class="var">?dmu'</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> start_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"μ <span class="free">fs'</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> μ <span class="free">fs</span> <span class="skolem">i</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">fs'</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span>
                             μ <span class="free">fs</span> <span class="skolem">i</span> <span class="free">k</span> <span class="main">*</span> <span class="var">?n</span> <span class="free">k</span> <span class="main">/</span> <span class="var">?n'</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?x1</span> <span class="main">+</span> <span class="var">?x2</span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> swaps <span class="keyword1"><span class="command">unfolding</span></span> jim1 <span class="keyword1"><span class="command">using</span></span> k0 * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>d <span class="free">fs'</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?x1</span> <span class="main">+</span> <span class="var">?x2</span><span class="main">)</span>
              <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs'</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?x1</span> <span class="main">+</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs'</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?x2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>d <span class="free">fs'</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?x1</span> <span class="main">=</span> <span class="var">?dmu'</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">fs</span> <span class="skolem">i</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
            <span class="main">/</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> jim1 <span class="keyword1"><span class="command">using</span></span> k0 dzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dmu'</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?dmu</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">fs</span> <span class="skolem">i</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?dmu</span> <span class="skolem">i</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>d <span class="free">fs'</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?n'</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> swaps <span class="keyword1"><span class="command">unfolding</span></span> jim1 <span class="keyword1"><span class="command">using</span></span> k k0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">*</span> <span class="var">?x2</span> <span class="main">=</span> <span class="main">(</span><span class="var">?n</span> <span class="free">k</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">fs</span> <span class="skolem">i</span> <span class="free">k</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> k k0 nzero'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="free">k</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> LLL_d_Suc<span class="main">[</span><span class="operator">OF</span> invw k<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">fs</span> <span class="skolem">i</span> <span class="free">k</span> <span class="main">=</span> <span class="var">?dmu</span> <span class="skolem">i</span> <span class="free">k</span> <span class="main">/</span> <span class="var">?n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?dmu</span> <span class="skolem">i</span> <span class="free">k</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?dn</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> dzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">start</span> <span class="main">=</span> <span class="main">(</span><span class="var">?dmu</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?dmu</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">*</span> <span class="var">?dn</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> 
             <span class="var">?dmu</span> <span class="skolem">i</span> <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?dn</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> add_divide_distrib of_int_mult jim1
            <span class="keyword1"><span class="command">using</span></span> dzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> nzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> k dzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>dμ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> 
             <span class="var">?r</span> <span class="main">(</span>dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> dn_km1 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> rat<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> k k0 i * j<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>dμ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">+</span> <span class="var">?r</span> <span class="main">(</span>dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
              <span class="main">/</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> of_int_mult <span class="keyword1"><span class="command">using</span></span> dzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> dzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> k k0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>dμ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="free">k</span> <span class="main">*</span> d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
            <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> of_int <span class="var">?x</span> <span class="main">/</span> <span class="main">_</span>"</span></span> <span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">start</span> <span class="main">=</span> <span class="var">?r</span> <span class="var">?x</span> <span class="main">/</span> <span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">from</span></span> division_to_div<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?start</span> <span class="main">=</span> <span class="main">(</span>dμ <span class="free">fs</span> <span class="free">k</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">+</span> dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="free">k</span> <span class="main">*</span> d <span class="free">fs</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span>d <span class="free">fs</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> start_def <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">using</span></span> * jim1 k0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Implementation of LLL via Integer Operations and Arrays›</span></span>


<span class="keyword1"><span class="command">hide_fact</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Word.inc_i

<span class="keyword1"><span class="command">type_synonym</span></span> LLL_dmu_d_state <span class="main">=</span> <span class="quoted"><span class="quoted">"int vec list_repr <span class="main">×</span> int iarray iarray <span class="main">×</span> int iarray"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fi_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"LLL_dmu_d_state <span class="main">⇒</span> int vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fi_state</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mu</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> get_nth_i <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fim1_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"LLL_dmu_d_state <span class="main">⇒</span> int vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fim1_state</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mu</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> get_nth_im1 <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">d_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"LLL_dmu_d_state <span class="main">⇒</span> nat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">d_state</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mu</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fs_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"LLL_dmu_d_state <span class="main">⇒</span> int vec list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fs_state</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mu</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> of_list_repr <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">upd_fi_mu_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"LLL_dmu_d_state <span class="main">⇒</span> nat <span class="main">⇒</span> int vec <span class="main">⇒</span> int iarray <span class="main">⇒</span> LLL_dmu_d_state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">upd_fi_mu_state</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mu</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span> <span class="free"><span class="bound"><span class="entity">mu_i</span></span></span> <span class="main">=</span> <span class="main">(</span>update_i <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span><span class="main">,</span> iarray_update <span class="free"><span class="bound"><span class="entity">mu</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">mu_i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">small_fs_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"LLL_dmu_d_state <span class="main">⇒</span> int vec list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">small_fs_state</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dmu_ij_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"LLL_dmu_d_state <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dmu_ij_state</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mu</span></span></span><span class="main">,</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mu</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">inc_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"LLL_dmu_d_state <span class="main">⇒</span> LLL_dmu_d_state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inc_state</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mu</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>inc_i <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mu</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">basis_reduction_add_rows_loop</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_add_rows_loop</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_add_rows_loop</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">sj</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fj</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fjs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">let</span> <span class="bound">fi</span> <span class="main">=</span> fi_state <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">;</span>
         <span class="bound">dsj</span> <span class="main">=</span> d_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">sj</span></span></span><span class="main">;</span>
         <span class="bound">j</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sj</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">;</span>
         <span class="bound">c</span> <span class="main">=</span> round_num_denom <span class="main">(</span>dmu_ij_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="bound">dsj</span><span class="main">;</span>
         <span class="bound">state'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="keyword1">else</span> upd_fi_mu_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>vec <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">fi</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">-</span> <span class="bound">c</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">fj</span></span></span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
             <span class="main">(</span>IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">jj</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">mu</span> <span class="main">=</span> dmu_ij_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">jj</span> <span class="keyword1">in</span>
                  <span class="keyword1">if</span> <span class="bound">jj</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="bound">mu</span> <span class="main">-</span> <span class="bound">c</span> <span class="main">*</span> dmu_ij_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="bound">j</span> <span class="bound">jj</span> <span class="keyword1">else</span>
                  <span class="keyword1">if</span> <span class="bound">jj</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="bound">mu</span> <span class="main">-</span> <span class="bound">dsj</span> <span class="main">*</span> <span class="bound">c</span> <span class="keyword1">else</span> <span class="bound">mu</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">in</span> <span class="free">basis_reduction_add_rows_loop</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">state'</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">fjs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹More efficient code which breaks abstraction of state.›</span></span>

<span class="keyword1" id="LLL_Impl-basis_reduction_add_rows_loop_code"><span class="command">lemma</span></span> basis_reduction_add_rows_loop_code<span class="main">:</span>
  <span class="quoted"><span class="quoted">"basis_reduction_add_rows_loop <span class="free">n</span> <span class="free">state</span> <span class="free">i</span> <span class="free">sj</span> <span class="main">(</span><span class="free">fj</span> <span class="main">#</span> <span class="free">fjs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">case</span> <span class="free">state</span> <span class="keyword1">of</span> <span class="main">(</span><span class="main">(</span><span class="bound">f1</span><span class="main">,</span><span class="bound">f2</span><span class="main">)</span><span class="main">,</span><span class="bound">mus</span><span class="main">,</span><span class="bound">ds</span><span class="main">)</span> <span class="main">⇒</span>
     <span class="keyword1">let</span> <span class="bound">fi</span> <span class="main">=</span> hd <span class="bound">f2</span><span class="main">;</span>
         <span class="bound">j</span> <span class="main">=</span> <span class="free">sj</span> <span class="main">-</span> <span class="main">1</span><span class="main">;</span>
         <span class="bound">dsj</span> <span class="main">=</span> <span class="bound">ds</span> <span class="main">!!</span> <span class="free">sj</span><span class="main">;</span>
         <span class="bound">mui</span> <span class="main">=</span> <span class="bound">mus</span> <span class="main">!!</span> <span class="free">i</span><span class="main">;</span>
         <span class="bound">c</span> <span class="main">=</span> round_num_denom <span class="main">(</span><span class="bound">mui</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">dsj</span>
      <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span>
          basis_reduction_add_rows_loop <span class="free">n</span> <span class="free">state</span> <span class="free">i</span> <span class="bound">j</span> <span class="free">fjs</span>
         <span class="keyword1">else</span>
             <span class="keyword1">let</span> <span class="bound">muj</span> <span class="main">=</span> <span class="bound">mus</span> <span class="main">!!</span> <span class="bound">j</span> <span class="keyword1">in</span>
           basis_reduction_add_rows_loop <span class="free">n</span>
                <span class="main">(</span><span class="main">(</span><span class="bound">f1</span><span class="main">,</span>  vec <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">fi</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">-</span> <span class="bound">c</span> <span class="main">*</span> <span class="free">fj</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="main">#</span> tl <span class="bound">f2</span><span class="main">)</span><span class="main">,</span> iarray_update <span class="bound">mus</span> <span class="free">i</span>
             <span class="main">(</span>IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">jj</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">mu</span> <span class="main">=</span> <span class="bound">mui</span> <span class="main">!!</span> <span class="bound">jj</span> <span class="keyword1">in</span>
                  <span class="keyword1">if</span> <span class="bound">jj</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="bound">mu</span> <span class="main">-</span> <span class="bound">c</span> <span class="main">*</span> <span class="bound">muj</span> <span class="main">!!</span> <span class="bound">jj</span> <span class="keyword1">else</span>
                  <span class="keyword1">if</span> <span class="bound">jj</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="bound">mu</span> <span class="main">-</span> <span class="bound">dsj</span> <span class="main">*</span> <span class="bound">c</span> <span class="keyword1">else</span> <span class="bound">mu</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span><span class="main">,</span>
                  <span class="bound">ds</span><span class="main">)</span> <span class="free">i</span> <span class="bound">j</span> <span class="free">fjs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">f2</span></span> <span class="skolem"><span class="skolem">mus</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">state</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">f1</span><span class="main">,</span><span class="skolem">f2</span><span class="main">)</span><span class="main">,</span><span class="skolem">mus</span><span class="main">,</span> <span class="skolem">ds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">state</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> basis_reduction_add_rows_loop.simps Let_def
     state split dmu_ij_state.simps fi_state.simps get_nth_i_def update_i_def upd_fi_mu_state.simps
     d_state.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> basis_reduction_add_rows_loop_code_equations <span class="main">=</span>
  basis_reduction_add_rows_loop.simps<span class="main">(</span>1<span class="main">)</span> basis_reduction_add_rows_loop_code

<span class="keyword1"><span class="command">declare</span></span> basis_reduction_add_rows_loop_code_equations<span class="main">[</span><span class="operator">code</span><span class="main">]</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">basis_reduction_add_rows</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_add_rows</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">upw</span></span></span>
        <span class="keyword1">then</span> basis_reduction_add_rows_loop <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>small_fs_state <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted">rat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">fs_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec list"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">swap_mu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int iarray iarray <span class="main">⇒</span> nat <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> int iarray iarray"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">swap_mu</span> <span class="free"><span class="bound"><span class="entity">dmu</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">dmu_i_im1</span></span></span> <span class="free"><span class="bound"><span class="entity">dim1</span></span></span> <span class="free"><span class="bound"><span class="entity">di</span></span></span> <span class="free"><span class="bound"><span class="entity">dsi</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">im1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">in</span>
       IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">ii</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">ii</span> <span class="main">&lt;</span> <span class="bound">im1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">dmu</span></span></span> <span class="main">!!</span> <span class="bound">ii</span> <span class="keyword1">else</span>
       <span class="keyword1">if</span> <span class="bound">ii</span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">dmu_ii</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">dmu</span></span></span> <span class="main">!!</span> <span class="bound">ii</span> <span class="keyword1">in</span>
           IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">dmu_ii_j</span> <span class="main">=</span> <span class="bound">dmu_ii</span> <span class="main">!!</span> <span class="bound">j</span> <span class="keyword1">in</span>
               <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dsi</span></span></span> <span class="main">*</span> <span class="bound">dmu_ii</span> <span class="main">!!</span> <span class="bound">im1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">dmu_i_im1</span></span></span> <span class="main">*</span> <span class="bound">dmu_ii_j</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free"><span class="bound"><span class="entity">di</span></span></span>
               <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">im1</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dmu_i_im1</span></span></span> <span class="main">*</span> <span class="bound">dmu_ii_j</span> <span class="main">+</span> <span class="bound">dmu_ii</span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">dim1</span></span></span><span class="main">)</span> <span class="keyword1">div</span> <span class="free"><span class="bound"><span class="entity">di</span></span></span>
               <span class="keyword1">else</span> <span class="bound">dmu_ii_j</span><span class="main">)</span> <span class="bound">ii</span> <span class="keyword1">else</span>
       <span class="keyword1">if</span> <span class="bound">ii</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">mu_im1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">dmu</span></span></span> <span class="main">!!</span> <span class="bound">im1</span> <span class="keyword1">in</span>
           IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">im1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">dmu_i_im1</span></span></span> <span class="keyword1">else</span> <span class="bound">mu_im1</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">ii</span>
         <span class="keyword1">else</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">dmu</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">ii</span><span class="main">)</span> <span class="comment1">― ‹ii = i - 1›</span>
       <span class="free">m</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">basis_reduction_swap</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_swap</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
       <span class="bound">di</span> <span class="main">=</span> d_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
       <span class="bound">dsi</span> <span class="main">=</span> d_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">;</span>
       <span class="bound">dim1</span> <span class="main">=</span> d_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">fi</span> <span class="main">=</span> fi_state <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">;</span>
       <span class="bound">fim1</span> <span class="main">=</span> fim1_state <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">;</span>
       <span class="bound">dmu_i_im1</span> <span class="main">=</span> dmu_ij_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">fi'</span> <span class="main">=</span> <span class="bound">fim1</span><span class="main">;</span>
       <span class="bound">fim1'</span> <span class="main">=</span> <span class="bound">fi</span>
     <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">dmus</span><span class="main">,</span><span class="bound">djs</span><span class="main">)</span> <span class="main">⇒</span>
         <span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span>
           <span class="main">(</span>dec_i <span class="main">(</span>update_im1 <span class="main">(</span>update_i <span class="bound">f</span> <span class="bound">fi'</span><span class="main">)</span> <span class="bound">fim1'</span><span class="main">)</span><span class="main">,</span>
            swap_mu <span class="bound">dmus</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">dmu_i_im1</span> <span class="bound">dim1</span> <span class="bound">di</span> <span class="bound">dsi</span><span class="main">,</span>
            iarray_update <span class="bound">djs</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="main">(</span><span class="bound">dsi</span> <span class="main">*</span> <span class="bound">dim1</span> <span class="main">+</span> <span class="bound">dmu_i_im1</span> <span class="main">*</span> <span class="bound">dmu_i_im1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">di</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹More efficient code which breaks abstraction of state.›</span></span>

<span class="keyword1" id="LLL_Impl-basis_reduction_swap_code"><span class="command">lemma</span></span> basis_reduction_swap_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"basis_reduction_swap <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="free">f1</span><span class="main">,</span><span class="free">f2</span><span class="main">)</span><span class="main">,</span> <span class="free">dmus</span><span class="main">,</span> <span class="free">ds</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
       <span class="bound">di</span> <span class="main">=</span> <span class="free">ds</span> <span class="main">!!</span> <span class="free">i</span><span class="main">;</span>
       <span class="bound">dsi</span> <span class="main">=</span> <span class="free">ds</span> <span class="main">!!</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">im1</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">;</span>
       <span class="bound">dim1</span> <span class="main">=</span> <span class="free">ds</span> <span class="main">!!</span> <span class="bound">im1</span><span class="main">;</span>
       <span class="bound">fi</span> <span class="main">=</span> hd <span class="free">f2</span><span class="main">;</span>
       <span class="bound">fim1</span> <span class="main">=</span> hd <span class="free">f1</span><span class="main">;</span>
       <span class="bound">dmu_i_im1</span> <span class="main">=</span> <span class="free">dmus</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">!!</span> <span class="bound">im1</span><span class="main">;</span>
       <span class="bound">fi'</span> <span class="main">=</span> <span class="bound">fim1</span><span class="main">;</span>
       <span class="bound">fim1'</span> <span class="main">=</span> <span class="bound">fi</span>
     <span class="keyword1">in</span> <span class="main">(</span>False<span class="main">,</span> <span class="bound">im1</span><span class="main">,</span>
           <span class="main">(</span><span class="main">(</span>tl <span class="free">f1</span><span class="main">,</span><span class="bound">fim1'</span> <span class="main">#</span> <span class="bound">fi'</span> <span class="main">#</span> tl <span class="free">f2</span><span class="main">)</span><span class="main">,</span>
            swap_mu <span class="free">dmus</span> <span class="free">i</span> <span class="bound">dmu_i_im1</span> <span class="bound">dim1</span> <span class="bound">di</span> <span class="bound">dsi</span><span class="main">,</span>
            iarray_update <span class="free">ds</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="bound">dsi</span> <span class="main">*</span> <span class="bound">dim1</span> <span class="main">+</span> <span class="bound">dmu_i_im1</span> <span class="main">*</span> <span class="bound">dmu_i_im1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">di</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> basis_reduction_swap_def split Let_def fi_state.simps fim1_state.simps
    d_state.simps get_nth_im1_def get_nth_i_def update_i_def update_im1_def dec_i_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">basis_reduction_step</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_step</span> <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> inc_state <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">let</span>
       <span class="bound">state'</span> <span class="main">=</span> basis_reduction_add_rows <span class="free">n</span> <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">;</span>
       <span class="bound">di</span> <span class="main">=</span> d_state <span class="bound">state'</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
       <span class="bound">dsi</span> <span class="main">=</span> d_state <span class="bound">state'</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">;</span>
       <span class="bound">dim1</span> <span class="main">=</span> d_state <span class="bound">state'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="bound">num</span><span class="main">,</span><span class="bound">denom</span><span class="main">)</span> <span class="main">=</span> quotient_of <span class="free">α</span>
    <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">di</span> <span class="main">*</span> <span class="bound">di</span> <span class="main">*</span> <span class="bound">denom</span> <span class="main">≤</span> <span class="bound">num</span> <span class="main">*</span> <span class="bound">dim1</span> <span class="main">*</span> <span class="bound">dsi</span> <span class="keyword1">then</span>
          <span class="main">(</span>True<span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> inc_state <span class="bound">state'</span><span class="main">)</span>
        <span class="keyword1">else</span> basis_reduction_swap <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">state'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>tailrec<span class="main">)</span> <span class="entity">basis_reduction_main</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_main</span> <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free">m</span>
     <span class="keyword1">then</span> <span class="keyword1">case</span> basis_reduction_step <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">upw'</span><span class="main">,</span><span class="bound">i'</span><span class="main">,</span><span class="bound">state'</span><span class="main">)</span> <span class="main">⇒</span>
       <span class="free">basis_reduction_main</span> <span class="bound">upw'</span> <span class="bound">i'</span> <span class="bound">state'</span> <span class="keyword1">else</span>
       <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">initial_state</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
  <span class="bound">dmus</span> <span class="main">=</span> dμ_impl <span class="free">fs_init</span><span class="main">;</span>
  <span class="bound">ds</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">i1</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">in</span> <span class="bound">dmus</span> <span class="main">!!</span> <span class="bound">i1</span> <span class="main">!!</span> <span class="bound">i1</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">dmus'</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">row_i</span> <span class="main">=</span> <span class="bound">dmus</span> <span class="main">!!</span> <span class="bound">i</span> <span class="keyword1">in</span>
       IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">row_i</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="free">m</span>
  <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">fs_init</span><span class="main">)</span><span class="main">,</span> <span class="bound">dmus'</span><span class="main">,</span> <span class="bound">ds</span><span class="main">)</span> <span class="main">::</span> LLL_dmu_d_state<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">basis_reduction</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="keyword1">in</span>
  basis_reduction_main <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">m</span> True <span class="main">0</span> <span class="main">(</span>initial_state <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduce_basis</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="keyword1">of</span> Nil <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">|</span> Cons <span class="bound">f</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> fs_state <span class="main">(</span>basis_reduction <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">(</span>dim_vec <span class="bound">f</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">short_vector</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> hd <span class="main">(</span>reduce_basis <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LLL_Impl-map_rev_Suc"><span class="command">lemma</span></span> map_rev_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">(</span>rev <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">j</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">j</span> <span class="main">#</span> map <span class="free">f</span> <span class="main">(</span>rev <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">context</span></span> LLL
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mu_repr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int iarray iarray <span class="main">⇒</span> int vec list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mu_repr</span> <span class="free"><span class="bound"><span class="entity">mu</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mu</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> IArray.of_fun <span class="main">(</span>dμ <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">d_repr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int iarray <span class="main">⇒</span> int vec list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">d_repr</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">=</span> IArray.of_fun <span class="main">(</span>d <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">LLL_impl_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"LLL_dmu_d_state <span class="main">⇒</span> nat <span class="main">⇒</span> int vec list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LLL_impl_inv</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mu</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span>list_repr <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span><span class="main">)</span>
    <span class="main">∧</span> d_repr <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span>
    <span class="main">∧</span> mu_repr <span class="free"><span class="bound"><span class="entity">mu</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">state</span> <span class="free">i</span> <span class="free">fs</span> <span class="free">upw</span> <span class="free">f</span> <span class="free">mu</span> <span class="free">ds</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">state</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">mu</span><span class="main">,</span><span class="free">ds</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="LLL_Impl-to_list_repr"><span class="command">lemma</span></span> to_list_repr<span class="main">:</span> <span class="quoted"><span class="quoted">"list_repr <span class="free">i</span> <span class="free">f</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">fs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> impl<span class="main">[</span><span class="operator">unfolded</span> state<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL_Impl-to_mu_repr"><span class="command">lemma</span></span> to_mu_repr<span class="main">:</span> <span class="quoted"><span class="quoted">"mu_repr <span class="free">mu</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> impl<span class="main">[</span><span class="operator">unfolded</span> state<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="LLL_Impl-to_d_repr"><span class="command">lemma</span></span> to_d_repr<span class="main">:</span> <span class="quoted"><span class="quoted">"d_repr <span class="free">ds</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> impl<span class="main">[</span><span class="operator">unfolded</span> state<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL_Impl-dmu_ij_state"><span class="command">lemma</span></span> dmu_ij_state<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">ii</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dmu_ij_state <span class="free">state</span> <span class="free">ii</span> <span class="free">j</span> <span class="main">=</span> dμ <span class="free">fs</span> <span class="free">ii</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> to_mu_repr<span class="main">[</span><span class="operator">unfolded</span> mu_repr_def<span class="main">]</span> state <span class="keyword1"><span class="command">using</span></span> ii j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL_Impl-fi_state"><span class="command">lemma</span></span> fi_state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> fi_state <span class="free">state</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> get_nth_i<span class="main">[</span><span class="operator">OF</span> to_list_repr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> state <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL_Impl-fim1_state"><span class="command">lemma</span></span> fim1_state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> fim1_state <span class="free">state</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> get_nth_im1<span class="main">[</span><span class="operator">OF</span> to_list_repr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> state <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL_Impl-d_state"><span class="command">lemma</span></span> d_state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> d_state <span class="free">state</span> <span class="free">ii</span> <span class="main">=</span> d <span class="free">fs</span> <span class="free">ii</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> to_d_repr<span class="main">[</span><span class="operator">unfolded</span> d_repr_def<span class="main">]</span> state
  <span class="keyword1"><span class="command">unfolding</span></span> state <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

<span class="keyword1" id="LLL_Impl-fs_state"><span class="command">lemma</span></span> fs_state<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span> <span class="main">⟹</span> fs_state <span class="free">state</span> <span class="main">=</span> <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> of_list_repr<span class="main">[</span><span class="operator">OF</span> to_list_repr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> state <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>

<span class="keyword1" id="LLL_Impl-LLL_state_inc_state"><span class="command">lemma</span></span> LLL_state_inc_state<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="main">(</span>inc_state <span class="free">state</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">fs</span>"</span></span>
  <span class="quoted"><span class="quoted">"fs_state <span class="main">(</span>inc_state <span class="free">state</span><span class="main">)</span> <span class="main">=</span> fs_state <span class="free">state</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_invD<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> inc <span class="main">=</span> inc_i<span class="main">[</span><span class="operator">OF</span> to_list_repr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> inc i impl <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="main">(</span>inc_state <span class="free">state</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">fs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> state <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> of_list_repr<span class="main">[</span><span class="operator">OF</span> inc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> of_list_repr<span class="main">[</span><span class="operator">OF</span> to_list_repr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> i
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fs_state <span class="main">(</span>inc_state <span class="free">state</span><span class="main">)</span> <span class="main">=</span> fs_state <span class="free">state</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> state <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> LLL_with_assms
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="LLL_Impl-basis_reduction_add_rows_loop_impl"><span class="command">lemma</span></span> basis_reduction_add_rows_loop_impl<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>
    impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mu_small<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_small_row <span class="free">i</span> <span class="free">fs</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_add_rows_loop <span class="free">n</span> <span class="free">state</span> <span class="free">i</span> <span class="free">j</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>rev <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">state'</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_add_rows_loop <span class="free">n</span> <span class="free">state</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span><span class="var">?mapf</span> <span class="free">fs</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> fs_state <span class="free">state'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state'</span> <span class="free">i</span> <span class="free">fs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"basis_reduction_add_rows_loop <span class="free">i</span> <span class="free">fs</span> <span class="free">j</span> <span class="main">=</span> <span class="free">fs'</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="main">(</span></span>1-6<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="free">state</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0 <span class="skolem">fs</span> <span class="skolem">state</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_invD<span class="main">[</span><span class="operator">OF</span> 0<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fs_state<span class="main">[</span><span class="operator">OF</span> 0<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> _ len<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fs_state <span class="skolem">state</span> <span class="main">=</span> <span class="skolem">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">state</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0 i fs' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span> <span class="skolem">fs</span> <span class="skolem">state</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">mu</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">state</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">mu</span><span class="main">,</span><span class="skolem">ds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">state</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> Linv <span class="main">=</span> Suc<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_invD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> impl <span class="main">=</span> Suc<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fi_state<span class="main">[</span><span class="operator">OF</span> impl Linv state i<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"fi_state <span class="skolem">state</span> <span class="main">=</span> <span class="skolem">fs</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> mu <span class="main">=</span> dmu_ij_state<span class="main">[</span><span class="operator">OF</span> impl Linv state j i<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"round <span class="main">(</span>μ <span class="skolem">fs</span> <span class="free">i</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> Linvw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">interpret</span></span> fs<span class="main">:</span> fs_int' <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">fs_init</span></span> <span class="quoted"><span class="skolem">fs</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> Linvw <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> floor<span class="main">:</span> <span class="quoted"><span class="quoted">"round_num_denom <span class="main">(</span>dμ <span class="skolem">fs</span> <span class="free">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>d <span class="skolem">fs</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> round <span class="main">(</span>fs.gs.μ <span class="free">i</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> jj i inv <span class="keyword1"><span class="command">unfolding</span></span> dμ_def d_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fs.round_num_denom_dμ_d<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fs.dμ_def fs.d_def<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_d_pos<span class="main">[</span><span class="operator">OF</span> Linvw<span class="main">]</span> j i <span class="keyword1"><span class="command">have</span></span> dj<span class="main">:</span> <span class="quoted"><span class="quoted">"d <span class="skolem">fs</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> updates <span class="main">=</span> d_dμ_add_row<span class="main">[</span><span class="operator">OF</span> Linvw i j refl<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> d_state <span class="main">=</span> d_state<span class="main">[</span><span class="operator">OF</span> impl Linv state<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> d_state<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span>"</span></span><span class="main">]</span> j i <span class="keyword1"><span class="command">have</span></span> djs<span class="main">:</span> <span class="quoted"><span class="quoted">"d_state <span class="skolem">state</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> d <span class="skolem">fs</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> Suc<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> floor map_rev_Suc djs append.simps LLL_Impl.basis_reduction_add_rows_loop.simps
      fi Let_def mu id int_times_rat_def<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> True<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_add_rows_loop <span class="free">n</span> <span class="skolem">state</span> <span class="free">i</span> <span class="skolem">j</span> <span class="main">(</span><span class="var">?mapf</span> <span class="skolem">fs</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">state'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> Linv basis_reduction_add_row_main_0<span class="main">[</span><span class="operator">OF</span> Linvw i j True Suc<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> impl step<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> res _ i<span class="main">]</span> j True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> i j <span class="keyword1"><span class="command">have</span></span> jm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> idd<span class="main">:</span> <span class="quoted"><span class="quoted">"vec <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="skolem">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="bound">ia</span> <span class="main">-</span> <span class="var">?c</span> <span class="main">*</span> <span class="skolem">fs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">$</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">=</span>
      <span class="skolem">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="var">?c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">fs</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> inv<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">]</span></span> inv<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> jm<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fi'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fi'</span> <span class="main">=</span> <span class="skolem">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="var">?c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">fs</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> fs''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="var">?c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">fs''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> basis_reduction_add_row_main<span class="main">[</span><span class="operator">OF</span> Linvw i j fs''<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">symmetric</span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> Linvw2 <span class="main">=</span> step<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> step<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span> step<span class="main">(</span>3<span class="main">,</span>5-<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> updates <span class="main">=</span> updates<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?c</span></span></span></span></span><span class="main">,</span> <span class="operator">unfolded</span> fs''<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> map_id_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mapf</span> <span class="skolem">fs</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?mapf</span> <span class="skolem">fs''</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_nth fs''<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> nth_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> False map_id_f id if_False idd<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fi'</span> <span class="main">=</span> <span class="skolem">fs''</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs''<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> fi'_def <span class="keyword1"><span class="command">using</span></span> inv<span class="main">(</span>6<span class="main">)</span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">fs</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> sq_norm <span class="main">(</span>gso <span class="bound">fs</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">fs</span> <span class="bound">i</span><span class="main">.</span> d <span class="bound">fs</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"IArray.of_fun
       <span class="main">(</span><span class="main">λ</span><span class="bound">jj</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">jj</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="keyword1">then</span> dmu_ij_state <span class="skolem">state</span> <span class="free">i</span> <span class="bound">jj</span> <span class="main">-</span> <span class="var">?c</span> <span class="main">*</span> dmu_ij_state <span class="skolem">state</span> <span class="skolem">j</span> <span class="bound">jj</span>
             <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">jj</span> <span class="main">=</span> <span class="skolem">j</span> <span class="keyword1">then</span> dmu_ij_state <span class="skolem">state</span> <span class="free">i</span> <span class="bound">jj</span> <span class="main">-</span> <span class="var">?d</span> <span class="skolem">fs</span> <span class="skolem">j</span> <span class="main">*</span> <span class="var">?c</span> <span class="keyword1">else</span> dmu_ij_state <span class="skolem">state</span> <span class="free">i</span> <span class="bound">jj</span><span class="main">)</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> mu'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mu'</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span>dμ <span class="skolem">fs''</span> <span class="free">i</span><span class="main">)</span> <span class="free">i</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?mu'i</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iarray_cong'<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">jj</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 1 j i <span class="keyword1"><span class="command">have</span></span> jm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dmu_ij_state<span class="main">[</span><span class="operator">OF</span> impl Linv state 1 i<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> dmu_ij_state<span class="main">[</span><span class="operator">OF</span> impl Linv state _ jm<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> updates<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> i 1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ii</span>
      <span class="keyword3"><span class="command">assume</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">≠</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> IArray.of_fun <span class="main">(</span>dμ <span class="skolem">fs</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">ii</span>
        <span class="main">=</span> IArray.of_fun <span class="main">(</span>dμ <span class="skolem">fs</span> <span class="skolem">ii</span><span class="main">)</span> <span class="skolem">ii</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span>dμ <span class="skolem">fs''</span> <span class="skolem">ii</span><span class="main">)</span> <span class="skolem">ii</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iarray_cong'<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">j</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> ii <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> updates<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ii<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 1<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> ii <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> IArray.of_fun <span class="main">(</span>dμ <span class="skolem">fs</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">ii</span>
         <span class="main">=</span> IArray.of_fun <span class="main">(</span>dμ <span class="skolem">fs''</span> <span class="skolem">ii</span><span class="main">)</span> <span class="skolem">ii</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> ii <span class="main">=</span> this
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"iarray_update <span class="skolem">mu</span> <span class="free">i</span> <span class="main">(</span>IArray.of_fun <span class="main">(</span>dμ <span class="skolem">fs''</span> <span class="free">i</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> new_array<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mu''</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> IArray.of_fun <span class="main">(</span>dμ <span class="skolem">fs''</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> iarray_update_of_fun to_mu_repr<span class="main">[</span><span class="operator">OF</span> impl Linv state<span class="main">,</span> <span class="operator">unfolded</span> mu_repr_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iarray_cong'<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ii<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> d'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="var">?d</span> <span class="skolem">fs</span><span class="main">)</span> <span class="main">(</span>rev <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="var">?d</span> <span class="skolem">fs''</span><span class="main">)</span> <span class="main">(</span>rev <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> updates<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span>
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> repr_id<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="skolem">fs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="main">(</span><span class="skolem">fs''</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(!)</span> <span class="skolem">fs''</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xs</span> <span class="main">=</span> <span class="var">?ys</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="var">?xs</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?ys</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs''<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> repr_id_d<span class="main">:</span>
      <span class="quoted"><span class="quoted">"map <span class="main">(</span>d <span class="skolem">fs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">m</span><span class="main">]</span> <span class="main">=</span> map <span class="main">(</span>d <span class="skolem">fs''</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">m</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> step<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="var">?c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">fs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">fs''</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs''<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> inv<span class="main">(</span>6<span class="main">)</span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> mu' mu d'<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> basis_reduction_add_rows_loop.simps Let_def id if_False fs''
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ step<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> res _ i<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> list_repr <span class="main">=</span> to_list_repr<span class="main">[</span><span class="operator">OF</span> impl Linv state<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="main">(</span>upd_fi_mu_state <span class="skolem">state</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">fs''</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="var">?mu'i</span><span class="main">)</span> <span class="free">i</span> <span class="skolem">fs''</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> upd_fi_mu_state.simps state LLL_impl_inv.simps new_array
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_repr <span class="free">i</span> <span class="main">(</span>update_i <span class="skolem">f</span> <span class="main">(</span><span class="skolem">fs''</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="skolem">fs''</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> update_i<span class="main">[</span><span class="operator">OF</span> list_repr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> length_map<span class="main">,</span> <span class="operator">OF</span> ii<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> repr_id<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"d_repr <span class="skolem">ds</span> <span class="skolem">fs''</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> to_d_repr<span class="main">[</span><span class="operator">OF</span> impl Linv state<span class="main">,</span> <span class="operator">unfolded</span> d_repr_def<span class="main">]</span> d_repr_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iarray_cong'<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> step<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mu_repr_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> i j<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Impl-basis_reduction_add_rows_loop"><span class="command">lemma</span></span> basis_reduction_add_rows_loop<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>
    impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mu_small<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_small_row <span class="free">i</span> <span class="free">fs</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_add_rows_loop <span class="free">n</span> <span class="free">state</span> <span class="free">i</span> <span class="free">j</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>rev <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">state'</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_add_rows_loop <span class="free">n</span> <span class="free">state</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span><span class="var">?mapf</span> <span class="free">fs</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> fs_state <span class="free">state'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state'</span> <span class="free">i</span> <span class="free">fs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"LLL_invariant False <span class="free">i</span> <span class="free">fs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="free">fs'</span> <span class="main">=</span> LLL_measure <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="quoted"><span class="quoted">"basis_reduction_add_rows_loop <span class="free">i</span> <span class="free">fs</span> <span class="free">j</span> <span class="main">=</span> <span class="free">fs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> basis_reduction_add_rows_loop_impl<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    basis_reduction_add_rows_loop<span class="main">[</span><span class="operator">OF</span> inv mu_small _ i j<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LLL_Impl-basis_reduction_add_rows_impl"><span class="command">lemma</span></span> basis_reduction_add_rows_impl<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>
     impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_add_rows <span class="free">n</span> <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span> <span class="main">=</span> <span class="free">state'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> fs_state <span class="free">state'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state'</span> <span class="free">i</span> <span class="free">fs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"basis_reduction_add_rows <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="free">fs'</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">mu</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">state</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">mu</span><span class="main">,</span><span class="skolem">ds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">state</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> def <span class="main">=</span> LLL_Impl.basis_reduction_add_rows_def basis_reduction_add_rows_def
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">upw</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> LLL_invD<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> fs_state<span class="main">[</span><span class="operator">OF</span> impl inv state len<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fs_state <span class="free">state</span> <span class="main">=</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> inv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> start <span class="main">=</span> this μ_small_row_refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">fs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"small_fs_state <span class="free">state</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>rev <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> state <span class="keyword1"><span class="command">using</span></span> to_list_repr<span class="main">[</span><span class="operator">OF</span> impl inv state<span class="main">]</span> i
      <span class="keyword1"><span class="command">unfolding</span></span> list_repr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_equalityI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_nth min_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> mm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Suc <span class="free">i</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append nth_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> def<span class="main">]</span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_add_rows_loop <span class="free">n</span> <span class="free">state</span> <span class="free">i</span> <span class="free">i</span> <span class="main">(</span>small_fs_state <span class="free">state</span><span class="main">)</span> <span class="main">=</span> <span class="free">state'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> basis_reduction_add_rows_loop_impl<span class="main">[</span><span class="operator">OF</span> impl start<span class="main"><span class="main"><span class="main">(</span></span></span>1-2<span class="main"><span class="main"><span class="main">)</span></span></span> this<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> id<span class="main"><span class="main"><span class="main">]</span></span></span> le_refl i fs'<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> def <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Impl-basis_reduction_add_rows"><span class="command">lemma</span></span> basis_reduction_add_rows<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>
     impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_add_rows <span class="free">n</span> <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span> <span class="main">=</span> <span class="free">state'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> fs_state <span class="free">state'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state'</span> <span class="free">i</span> <span class="free">fs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"LLL_invariant False <span class="free">i</span> <span class="free">fs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="free">fs'</span> <span class="main">=</span> LLL_measure <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="quoted"><span class="quoted">"basis_reduction_add_rows <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="free">fs'</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> basis_reduction_add_rows_impl<span class="main">[</span><span class="operator">OF</span> impl inv res i fs'<span class="main">]</span>
    basis_reduction_add_rows<span class="main">[</span><span class="operator">OF</span> inv _ i<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LLL_Impl-basis_reduction_swap_impl"><span class="command">lemma</span></span> basis_reduction_swap_impl<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>
  impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant False <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_swap <span class="free">m</span> <span class="free">i</span> <span class="free">state</span> <span class="main">=</span> <span class="main">(</span><span class="free">upw'</span><span class="main">,</span><span class="free">i'</span><span class="main">,</span><span class="free">state'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">α</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> fs_state <span class="free">state'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state'</span> <span class="free">i'</span> <span class="free">fs'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span><span class="main">)</span>
  <span class="quoted"><span class="quoted">"basis_reduction_swap <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="main">(</span><span class="free">upw'</span><span class="main">,</span><span class="free">i'</span><span class="main">,</span><span class="free">fs'</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> i i0 <span class="keyword1"><span class="command">have</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">mu</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">state</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">mu</span><span class="main">,</span><span class="skolem">ds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">state</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> dmu_ij_state <span class="main">=</span> dmu_ij_state<span class="main">[</span><span class="operator">OF</span> impl inv state<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> d_state <span class="main">=</span> d_state<span class="main">[</span><span class="operator">OF</span> impl inv state<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> LLL_Impl.basis_reduction_swap_def Let_def split state<span class="main">,</span> <span class="operator">folded</span> state<span class="main">,</span>
    <span class="operator">unfolded</span> fi_state<span class="main"><span class="main">[</span></span><span class="operator">OF</span> impl inv state i<span class="main"><span class="main">]</span></span> fim1_state<span class="main"><span class="main">[</span></span><span class="operator">OF</span> impl inv state i i0<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> state_id <span class="main">=</span> dmu_ij_state<span class="main">[</span><span class="operator">OF</span> ii i<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> d_state_i <span class="main">=</span> d_state<span class="main">[</span><span class="operator">OF</span> le_m<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> d_state<span class="main">[</span><span class="operator">OF</span> le_m<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> d_state<span class="main">[</span><span class="operator">OF</span> le_m<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_invD<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fs_state<span class="main">[</span><span class="operator">OF</span> impl inv state len<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"fs_state <span class="free">state</span> <span class="main">=</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> fs''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">fs''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted">rat_of_int</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"d <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"d <span class="skolem">fs''</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dmus</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dmu_ij_state <span class="free">state</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ds</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"d_state <span class="free">state</span>"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> swap <span class="main">=</span> basis_reduction_swap_main<span class="main">[</span><span class="operator">OF</span> invw disjI1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span></span></span></span> inv<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span></span></span> i i0 cond refl<span class="main">,</span> <span class="operator">unfolded</span> fs''<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> invw2 <span class="main">=</span> swap<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> swap <span class="main">=</span> swap<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span> swap<span class="main">(</span>3-<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> fs<span class="main">:</span> fs_int' <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">fs_init</span></span> <span class="quoted"><span class="free">fs</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> invw <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> fs''<span class="main">:</span> fs_int' <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">fs_init</span></span> <span class="quoted"><span class="skolem">fs''</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> invw2 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> dmu <span class="main">=</span> fs.dμ
  <span class="keyword1"><span class="command">note</span></span> dmu' <span class="main">=</span> fs''.dμ
  <span class="keyword1"><span class="command">note</span></span> inv' <span class="main">=</span> LLL_invD<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">fs''</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">fs''</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fs''<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> inv'<span class="main">(</span>6<span class="main">)</span> i i0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> res <span class="keyword1"><span class="command">have</span></span> upw'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">upw'</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dmu_repr'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"swap_mu <span class="free">m</span> <span class="skolem">mu</span> <span class="free">i</span> <span class="main">(</span><span class="var">?dmus</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?d</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?d</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?d</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d'i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?d</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">*</span> <span class="var">?d</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="var">?dmus</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?dmus</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="var">?d</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> fi d_state_i<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">upw'</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">state'</span> <span class="main">=</span> <span class="main">(</span>dec_i <span class="main">(</span>update_im1 <span class="main">(</span>update_i <span class="skolem">f</span> <span class="main">(</span><span class="skolem">fs''</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">fs''</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       <span class="var">?dmu_repr'</span><span class="main">,</span> iarray_update <span class="skolem">ds</span> <span class="free">i</span> <span class="var">?d'i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> im1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> list_repr <span class="main">=</span> to_list_repr<span class="main">[</span><span class="operator">OF</span> impl inv state<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> dec_i<span class="main">[</span><span class="operator">OF</span> update_im1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> update_i<span class="main"><span class="main">[</span></span><span class="operator">OF</span> list_repr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> length_map<span class="main">,</span> <span class="operator">OF</span> ii i0 i0<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"list_repr <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>dec_i <span class="main">(</span>update_im1 <span class="main">(</span>update_i <span class="skolem">f</span> <span class="main">(</span><span class="skolem">fs''</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">fs''</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">fs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="main">(</span><span class="skolem">fs''</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">,</span>
       <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="main">(</span><span class="skolem">fs''</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"list_repr <span class="main">_</span> <span class="var">?fr</span> <span class="var">?xs</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(!)</span> <span class="skolem">fs''</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs''<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i i0 len<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> ii<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">ii</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">,</span><span class="free">i</span><span class="main">}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> f_repr<span class="main">:</span> <span class="quoted"><span class="quoted">"list_repr <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="var">?fr</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="skolem">fs''</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> i0 <span class="keyword1"><span class="command">have</span></span> sim1<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_d_Suc<span class="main">[</span><span class="operator">OF</span> invw im1<span class="main">,</span> <span class="operator">unfolded</span> sim1<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">fs''</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fs'' inv'<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> fs_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> <span class="skolem">fs''</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs' res fs_state.simps <span class="keyword1"><span class="command">using</span></span> of_list_repr<span class="main">[</span><span class="operator">OF</span> f_repr<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> to_mu_repr<span class="main">[</span><span class="operator">OF</span> impl inv state<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"mu_repr <span class="skolem">mu</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> to_d_repr<span class="main">[</span><span class="operator">OF</span> impl inv state<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> d_repr<span class="main">:</span> <span class="quoted"><span class="quoted">"d_repr <span class="skolem">ds</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> mu_def <span class="main">=</span> mu<span class="main">[</span><span class="operator">unfolded</span> mu_repr_def<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> updates <span class="main">=</span> d_dμ_swap<span class="main">[</span><span class="operator">OF</span> invw disjI1<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">OF</span></span> inv<span class="main"><span class="main"><span class="main">]</span></span></span> i i0 cond fs''<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> dmu_ii <span class="main">=</span> dmu_ij_state<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> i<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs_id LLL_impl_inv.simps res
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI f_repr<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"d_repr <span class="main">(</span>iarray_update <span class="skolem">ds</span> <span class="free">i</span> <span class="var">?d'i</span><span class="main">)</span> <span class="skolem">fs''</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> d_repr<span class="main">[</span><span class="operator">unfolded</span> d_repr_def<span class="main">]</span> d_repr_def iarray_update_of_fun dmu_ii
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iarray_cong'<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> updates<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mu_repr <span class="var">?dmu_repr'</span> <span class="skolem">fs''</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mu_repr_def swap_mu_def Let_def dmu_ii
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iarray_cong'<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> ii<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">ii</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> small<span class="main">:</span> True
        <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ii</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ii</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">ii</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ii</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mu</span> <span class="main">!!</span> <span class="skolem">ii</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span>dμ <span class="free">fs</span> <span class="skolem">ii</span><span class="main">)</span> <span class="skolem">ii</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ii <span class="keyword1"><span class="command">unfolding</span></span> mu_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id if_True if_False mu
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iarray_cong'<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> small ii i i0<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> updates<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">linarith</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> iFalse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ii</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> iFalse if_False if_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> IArray.of_fun <span class="bound">f</span> <span class="skolem">ii</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
          dmu_ij_state.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">mu</span></span> <span class="quoted"><span class="skolem">ds</span></span><span class="main">,</span> <span class="operator">folded</span> state<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iarray_cong'<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> j<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">j</span><span class="main">)</span>
          <span class="keyword1"><span class="command">note</span></span> upd <span class="main">=</span> updates<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ii j<span class="main">]</span> dmu_ii dmu_ij_state<span class="main">[</span><span class="operator">OF</span> j ii<span class="main">]</span> if_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="skolem">j</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">note</span></span> simps <span class="main">=</span> dmu_ij_state<span class="main">[</span><span class="operator">OF</span> _ ii<span class="main">]</span> dmu_ij_state<span class="main">[</span><span class="operator">OF</span> _ im1<span class="main">]</span> dmu_ij_state<span class="main">[</span><span class="operator">OF</span> _ i<span class="main">]</span>
          <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>I<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="main">(</span>Is<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
            <span class="main">(</span>Im1<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="main">(</span>large<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> upd <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Is<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> upd <span class="keyword1"><span class="command">using</span></span> Is j simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Im1<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">ii</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ii</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ii</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">using</span></span> i0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> upd <span class="keyword1"><span class="command">unfolding</span></span> id if_False if_True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j Im1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>large<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">ii</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">ii</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">note</span></span> simps <span class="main">=</span> simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">from</span></span> large <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">ii</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ii</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ii</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id if_True if_False upd simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs_id fs''<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> basis_reduction_swap_def <span class="keyword1"><span class="command">unfolding</span></span> res <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Impl-basis_reduction_swap"><span class="command">lemma</span></span> basis_reduction_swap<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>
  impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant False <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_swap <span class="free">m</span> <span class="free">i</span> <span class="free">state</span> <span class="main">=</span> <span class="main">(</span><span class="free">upw'</span><span class="main">,</span><span class="free">i'</span><span class="main">,</span><span class="free">state'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">α</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> fs_state <span class="free">state'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state'</span> <span class="free">i'</span> <span class="free">fs'</span>"</span></span> 
  <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw'</span> <span class="free">i'</span> <span class="free">fs'</span>"</span></span> 
  <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i'</span> <span class="free">fs'</span> <span class="main">&lt;</span> LLL_measure <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="quoted"><span class="quoted">"basis_reduction_swap <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="main">(</span><span class="free">upw'</span><span class="main">,</span><span class="free">i'</span><span class="main">,</span><span class="free">fs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> basis_reduction_swap_impl<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> basis_reduction_swap<span class="main">[</span><span class="operator">OF</span> inv _ cond i i0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LLL_Impl-basis_reduction_step_impl"><span class="command">lemma</span></span> basis_reduction_step_impl<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>
  impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_step <span class="free">α</span> <span class="free">n</span> <span class="free">m</span> <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span> <span class="main">=</span> <span class="main">(</span><span class="free">upw'</span><span class="main">,</span><span class="free">i'</span><span class="main">,</span><span class="free">state'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> fs_state <span class="free">state'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state'</span> <span class="free">i'</span> <span class="free">fs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"basis_reduction_step <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="main">(</span><span class="free">upw'</span><span class="main">,</span><span class="free">i'</span><span class="main">,</span><span class="free">fs'</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">mu</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">state</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">mu</span><span class="main">,</span><span class="skolem">ds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">state</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> def <span class="main">=</span> LLL_Impl.basis_reduction_step_def basis_reduction_step_def
  <span class="keyword1"><span class="command">from</span></span> LLL_invD<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fs_state<span class="main">[</span><span class="operator">OF</span> impl inv state len<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"fs_state <span class="free">state</span> <span class="main">=</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> LLL_state_inc_state<span class="main">[</span><span class="operator">OF</span> impl inv state i<span class="main">]</span> i
      assms increase_i<span class="main">[</span><span class="operator">OF</span> inv i True<span class="main">]</span> True
      res fs' fs
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">state''</span></span> <span class="keyword2"><span class="keyword">where</span></span> state''<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_add_rows <span class="free">n</span> <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span> <span class="main">=</span> <span class="skolem">state''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> fs''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs''</span> <span class="main">=</span> fs_state <span class="skolem">state''</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">mu</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">state''</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">mu</span><span class="main">,</span><span class="skolem">ds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">state''</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> basis_reduction_add_rows<span class="main">[</span><span class="operator">OF</span> impl inv state'' i fs''<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant False <span class="free">i</span> <span class="skolem">fs''</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> meas<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> LLL_measure <span class="free">i</span> <span class="skolem">fs''</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="skolem">state''</span> <span class="free">i</span> <span class="skolem">fs''</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> impl'<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_add_rows <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="skolem">fs''</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> invw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">num</span></span> <span class="skolem"><span class="skolem">denom</span></span> <span class="keyword2"><span class="keyword">where</span></span> quot<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="free">α</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">num</span><span class="main">,</span><span class="skolem">denom</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">note</span></span> d_state <span class="main">=</span> d_state<span class="main">[</span><span class="operator">OF</span> impl inv state<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">" <span class="free">i</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> d_state <span class="main">=</span> d_state<span class="main">[</span><span class="operator">OF</span> le<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> d_state<span class="main">[</span><span class="operator">OF</span> le<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> d_state<span class="main">[</span><span class="operator">OF</span> le<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">interpret</span></span> fs''<span class="main">:</span> fs_int' <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">fs_init</span></span> <span class="quoted"><span class="skolem">fs''</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> invw <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="skolem">fs''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LLL_invD<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> d_sq_norm_comparison <span class="main">=</span> fs''.d_sq_norm_comparison<span class="main">[</span><span class="operator">OF</span> quot this False<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> def id if_False Let_def state'' quot split d_state this<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> pos <span class="main">=</span> LLL_d_pos<span class="main">[</span><span class="operator">OF</span> invw le<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> LLL_d_pos<span class="main">[</span><span class="operator">OF</span> invw le<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> quotient_of_denom_pos<span class="main">[</span><span class="operator">OF</span> quot<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> sim1<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="skolem">fs''</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="skolem">fs''</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">≤</span> <span class="var">?y</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> increase_i<span class="main">[</span><span class="operator">OF</span> inv i _ True<span class="main">]</span> True res meas LLL_state_inc_state<span class="main">[</span><span class="operator">OF</span> impl inv state i<span class="main">]</span> fs' fs''
        d_def d_sq_norm_comparison fs''.d_def impl' False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> F<span class="main">:</span> False
      <span class="keyword1"><span class="command">hence</span></span> gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">&gt;</span> <span class="var">?y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?x</span> <span class="main">≤</span> <span class="var">?y</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> id if_False<span class="main">]</span> d_def d_sq_norm_comparison fs''.d_def id
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_swap <span class="free">m</span> <span class="free">i</span> <span class="skolem">state''</span> <span class="main">=</span> <span class="main">(</span><span class="free">upw'</span><span class="main">,</span> <span class="free">i'</span><span class="main">,</span> <span class="free">state'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> basis_reduction_swap<span class="main">[</span><span class="operator">OF</span> impl inv this gt i False fs'<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> meas F False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> def Let_def impl'<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Impl-basis_reduction_step"><span class="command">lemma</span></span> basis_reduction_step<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>
  impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_step <span class="free">α</span> <span class="free">n</span> <span class="free">m</span> <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span> <span class="main">=</span> <span class="main">(</span><span class="free">upw'</span><span class="main">,</span><span class="free">i'</span><span class="main">,</span><span class="free">state'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> fs_state <span class="free">state'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state'</span> <span class="free">i'</span> <span class="free">fs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw'</span> <span class="free">i'</span> <span class="free">fs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i'</span> <span class="free">fs'</span> <span class="main">&lt;</span> LLL_measure <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="quoted"><span class="quoted">"basis_reduction_step <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="main">(</span><span class="free">upw'</span><span class="main">,</span><span class="free">i'</span><span class="main">,</span><span class="free">fs'</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> basis_reduction_step_impl<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> basis_reduction_step<span class="main">[</span><span class="operator">OF</span> inv _ i<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span> 

<span class="keyword1" id="LLL_Impl-basis_reduction_main_impl"><span class="command">lemma</span></span> basis_reduction_main_impl<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>
  impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_main <span class="free">α</span> <span class="free">n</span> <span class="free">m</span> <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span> <span class="main">=</span> <span class="free">state'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> fs_state <span class="free">state'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state'</span> <span class="free">m</span> <span class="free">fs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"basis_reduction_main <span class="main">(</span><span class="free">upw</span><span class="main">,</span><span class="free">i</span><span class="main">,</span><span class="free">fs</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs'</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="free">upw</span></span> <span class="quoted"><span class="free">state</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">i</span> <span class="skolem">fs</span> <span class="skolem">upw</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="skolem">upw</span> <span class="skolem">i</span> <span class="skolem">fs</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> less<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> LLL_Impl.basis_reduction_main.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">upw</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> less<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> impl <span class="main">=</span> less<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> less<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> i<span class="main">:</span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i''</span></span> <span class="skolem"><span class="skolem">state''</span></span> <span class="skolem"><span class="skolem">upw''</span></span> <span class="keyword2"><span class="keyword">where</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_step <span class="free">α</span> <span class="free">n</span> <span class="free">m</span> <span class="skolem">upw</span> <span class="skolem">i</span> <span class="skolem">state</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">upw''</span><span class="main">,</span><span class="skolem">i''</span><span class="main">,</span><span class="skolem">state''</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?step</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?step</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> res i <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_main <span class="free">α</span> <span class="free">n</span> <span class="free">m</span> <span class="skolem">upw''</span> <span class="skolem">i''</span> <span class="skolem">state''</span> <span class="main">=</span> <span class="free">state'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> basis_reduction_step<span class="main">[</span><span class="operator">OF</span> impl inv step i refl<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> main<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> res<span class="main">]</span> main<span class="main">(</span>4<span class="main">)</span> step res
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i inv basis_reduction_main.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> LLL_invD<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">mu</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">state</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">mu</span><span class="main">,</span><span class="skolem">ds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">state</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> fs_state<span class="main">[</span><span class="operator">OF</span> impl inv state len<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"fs_state <span class="skolem">state</span> <span class="main">=</span> <span class="skolem">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> False fs res fs' <span class="keyword1"><span class="command">have</span></span> fs_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">=</span> <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> False LLL_invD<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> False res inv impl fs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="skolem">upw</span> <span class="free">m</span> <span class="free">fs'</span> <span class="main">∧</span> LLL_impl_inv <span class="free">state'</span> <span class="free">m</span> <span class="free">fs'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs'<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> basis_reduction_main.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">upw</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">fs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> False 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LLL_invariant_def fs_id<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Impl-basis_reduction_main"><span class="command">lemma</span></span> basis_reduction_main<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>
  impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_main <span class="free">α</span> <span class="free">n</span> <span class="free">m</span> <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span> <span class="main">=</span> <span class="free">state'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> fs_state <span class="free">state'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">m</span> <span class="free">fs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state'</span> <span class="free">m</span> <span class="free">fs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"basis_reduction_main <span class="main">(</span><span class="free">upw</span><span class="main">,</span><span class="free">i</span><span class="main">,</span><span class="free">fs</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs'</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> basis_reduction_main_impl<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> basis_reduction_main<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LLL_Impl-initial_state"><span class="command">lemma</span></span> initial_state<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="main">(</span>initial_state <span class="free">m</span> <span class="free">fs_init</span><span class="main">)</span> <span class="main">0</span> <span class="free">fs_init</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span><span class="main">)</span>
  <span class="quoted"><span class="quoted">"fs_state <span class="main">(</span>initial_state <span class="free">m</span> <span class="free">fs_init</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs_init</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f_repr<span class="main">:</span> <span class="quoted"><span class="quoted">"list_repr <span class="main">0</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">fs_init</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">fs_init</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_repr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> len<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fs_init <span class="keyword1"><span class="command">have</span></span> Rn<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RAT <span class="free">fs_init</span><span class="main">)</span> <span class="main">⊆</span> Rn"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> d <span class="free">fs_init</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> jm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="free">m</span> <span class="main">-</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> fs_init<span class="main">:</span> fs_int_indpt <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">fs_init</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> lin_dep <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> mu_repr<span class="main">:</span> <span class="quoted"><span class="quoted">"mu_repr <span class="main">(</span>IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> IArray.of_fun <span class="main">(</span><span class="main">(!!)</span> <span class="main">(</span>dμ_impl <span class="free">fs_init</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="free">fs_init</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fs_init.dμ_impl mu_repr_def fs_init.dμ_def dμ_def fs_init.d_def d_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> iarray_cong'<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> len<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> d_repr<span class="main">:</span> <span class="quoted"><span class="quoted">"d_repr <span class="main">(</span>IArray.of_fun <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> dμ_impl <span class="free">fs_init</span> <span class="main">!!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">!!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">fs_init</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fs_init.dμ_impl d_repr_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iarray_cong'<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">fs_init</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> le<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> of_fun_nth<span class="main">[</span><span class="operator">OF</span> le<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> id if_False
        dμ_def fs_init.dμ_def fs_init.d_def d_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gs.μ.simps <span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="free">fs_init</span> <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def gs.Gramian_determinant_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> initial_state_def Let_def LLL_impl_inv.simps id
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI f_repr mu_repr d_repr<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fs_state<span class="main">[</span><span class="operator">OF</span> this LLL_inv_initial_state<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> initial_state_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_list_repr_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Impl-basis_reduction"><span class="command">lemma</span></span> basis_reduction<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction <span class="free">α</span> <span class="free">n</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="free">state</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">=</span> fs_state <span class="free">state</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">m</span> <span class="free">fs</span>"</span></span>
  <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state</span> <span class="free">m</span> <span class="free">fs</span>"</span></span>
  <span class="quoted"><span class="quoted">"basis_reduction_main <span class="main">(</span>True<span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="free">fs_init</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> basis_reduction_main<span class="main">[</span><span class="operator">OF</span> initial_state<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> LLL_inv_initial_state res<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">unfolded</span></span></span> basis_reduction_def len Let_def<span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span> fs<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL_Impl-reduce_basis_impl"><span class="command">lemma</span></span> reduce_basis_impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.reduce_basis <span class="free">α</span> <span class="free">fs_init</span> <span class="main">=</span> reduce_basis"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.reduce_basis <span class="free">α</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="skolem">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reduce_basis <span class="main">=</span> <span class="skolem">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fs_init</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> fs_init<span class="main">[</span><span class="operator">unfolded</span> Cons<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="skolem">f</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> LLL_Impl.reduce_basis_def Cons list.simps this<span class="main">,</span> <span class="operator">folded</span> Cons<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fs_state <span class="main">(</span>LLL_Impl.basis_reduction <span class="free">α</span> <span class="free">n</span> <span class="free">fs_init</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> basis_reduction<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> refl refl<span class="main">,</span> <span class="operator">unfolded</span> this<span class="main">]</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"reduce_basis <span class="main">=</span> <span class="skolem">fs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> reduce_basis_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">with</span></span> len <span class="keyword1"><span class="command">have</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> res 
      <span class="keyword1"><span class="command">unfolding</span></span> reduce_basis_def LLL_Impl.reduce_basis_def basis_reduction_main.simps <span class="keyword1"><span class="command">using</span></span> Nil m0
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> res <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Impl-reduce_basis"><span class="command">lemma</span></span> reduce_basis<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LLL_Impl.reduce_basis <span class="free">α</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs</span> <span class="main">=</span> L"</span></span> 
  <span class="quoted"><span class="quoted">"reduced <span class="free">fs</span> <span class="free">m</span>"</span></span> 
  <span class="quoted"><span class="quoted">"lin_indep <span class="free">fs</span>"</span></span> 
  <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> 
  <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">m</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> reduce_basis_impl assms reduce_basis reduce_basis_inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LLL_Impl-short_vector_impl"><span class="command">lemma</span></span> short_vector_impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.short_vector <span class="free">α</span> <span class="free">fs_init</span> <span class="main">=</span> short_vector"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> reduce_basis_impl <span class="keyword1"><span class="command">unfolding</span></span> LLL_Impl.short_vector_def short_vector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="LLL_Impl-short_vector"><span class="command">lemma</span></span> short_vector<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.short_vector <span class="free">α</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> L <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> L <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> rat_of_int <span class="main">(</span>sq_norm <span class="free">v</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> rat_of_int <span class="main">(</span>sq_norm <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> short_vector<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">unfolded</span></span></span></span> short_vector_impl<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LLL_Complexity">
<div class="head">
<h1>Theory LLL_Complexity</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Maximilian Haslbeck
                René Thiemann
    License:    BSD
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bound on Number of Arithmetic Operations for Integer Implementation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section we define a version of the LLL algorithm which explicitly returns the
  costs of running the algorithm. Its soundness is mainly proven by stating that 
  projecting away yields the original result.

  The cost model counts the number of arithmetic operations that occur in vector-addition, scalar-products,
  and scalar multiplication and we prove a polynomial bound on this number.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LLL_Complexity
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="#LLL_Impl">LLL_Impl</a>
    <a href="#Cost">Cost</a>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Discrete.html">HOL-Library.Discrete</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">round_num_denom_cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> int cost"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">round_num_denom_cost</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">,</span> <span class="numeral">4</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹4 arith. operations›</span>

<span class="keyword1" id="LLL_Complexity-round_num_denom_cost"><span class="command">lemma</span></span> round_num_denom_cost<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"result <span class="main">(</span>round_num_denom_cost <span class="free">n</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> round_num_denom <span class="free">n</span> <span class="free">d</span>"</span></span>  
   <span class="quoted"><span class="quoted">"cost <span class="main">(</span>round_num_denom_cost <span class="free">n</span> <span class="free">d</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> round_num_denom_cost_def round_num_denom_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cost_simps<span class="main">)</span> 

<span class="keyword1"><span class="command">context</span></span> LLL_with_assms
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> α_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&gt;</span> <span class="numeral">4</span><span class="main">/</span><span class="numeral">3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">basis_reduction_add_rows_loop_cost</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_add_rows_loop_cost</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_add_rows_loop_cost</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">sj</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fj</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fjs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">let</span> <span class="bound">fi</span> <span class="main">=</span> fi_state <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">;</span>
         <span class="bound">dsj</span> <span class="main">=</span> d_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">sj</span></span></span><span class="main">;</span>
         <span class="bound">j</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sj</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">;</span>
         <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">cost1</span><span class="main">)</span> <span class="main">=</span> round_num_denom_cost <span class="main">(</span>dmu_ij_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="bound">dsj</span><span class="main">;</span>
         <span class="bound">state'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="keyword1">else</span> upd_fi_mu_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>vec <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">fi</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">-</span> <span class="bound">c</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">fj</span></span></span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="comment1">― ‹2n arith. operations›</span>
             <span class="main">(</span>IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">jj</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">mu</span> <span class="main">=</span> dmu_ij_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">jj</span> <span class="keyword1">in</span> <span class="comment1">― ‹3 sj arith. operations›</span>
                  <span class="keyword1">if</span> <span class="bound">jj</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="bound">mu</span> <span class="main">-</span> <span class="bound">c</span> <span class="main">*</span> dmu_ij_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="bound">j</span> <span class="bound">jj</span> <span class="keyword1">else</span> 
                  <span class="keyword1">if</span> <span class="bound">jj</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="bound">mu</span> <span class="main">-</span> <span class="bound">dsj</span> <span class="main">*</span> <span class="bound">c</span> <span class="keyword1">else</span> <span class="bound">mu</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">local_cost</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">sj</span></span></span><span class="main">;</span>
         <span class="main">(</span><span class="bound">res</span><span class="main">,</span><span class="bound">cost2</span><span class="main">)</span> <span class="main">=</span> <span class="free">basis_reduction_add_rows_loop_cost</span> <span class="bound">state'</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">fjs</span></span></span>
      <span class="keyword1">in</span> <span class="main">(</span><span class="bound">res</span><span class="main">,</span> <span class="bound">cost1</span> <span class="main">+</span> <span class="bound">local_cost</span> <span class="main">+</span> <span class="bound">cost2</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="LLL_Complexity-basis_reduction_add_rows_loop_cost"><span class="command">lemma</span></span> basis_reduction_add_rows_loop_cost<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">j</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"result <span class="main">(</span>basis_reduction_add_rows_loop_cost <span class="free">state</span> <span class="free">i</span> <span class="free">j</span> <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> LLL_Impl.basis_reduction_add_rows_loop <span class="free">n</span> <span class="free">state</span> <span class="free">i</span> <span class="free">j</span> <span class="free">fs</span>"</span></span>  
   <span class="quoted"><span class="quoted">"cost <span class="main">(</span>basis_reduction_add_rows_loop_cost <span class="free">state</span> <span class="free">i</span> <span class="free">j</span> <span class="free">fs</span><span class="main">)</span> <span class="main">≤</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">state</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">fj</span> <span class="skolem">fs</span> <span class="skolem">state</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dm_ij</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dmu_ij_state <span class="skolem">state</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dj</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"d_state <span class="skolem">state</span> <span class="skolem">j</span>"</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">fc</span></span> <span class="keyword2"><span class="keyword">where</span></span> flc<span class="main">:</span> <span class="quoted"><span class="quoted">"round_num_denom_cost <span class="var">?dm_ij</span> <span class="var">?dj</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">fc</span><span class="main">,</span> <span class="skolem">c1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> result_costD<span class="main">[</span><span class="operator">OF</span> round_num_denom_cost flc<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> fl<span class="main">:</span> <span class="quoted"><span class="quoted">"round_num_denom <span class="var">?dm_ij</span> <span class="var">?dj</span> <span class="main">=</span> <span class="skolem">fc</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="keyword2"><span class="keyword">where</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="skolem">fc</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">state</span>
             <span class="keyword1">else</span> upd_fi_mu_state <span class="skolem">state</span> <span class="free">i</span> <span class="main">(</span>vec <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> fi_state <span class="skolem">state</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">-</span> <span class="skolem">fc</span> <span class="main">*</span> <span class="skolem">fj</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">(</span>IArray.of_fun
                     <span class="main">(</span><span class="main">λ</span><span class="bound">jj</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">jj</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> dmu_ij_state <span class="skolem">state</span> <span class="free">i</span> <span class="bound">jj</span> <span class="main">-</span> <span class="skolem">fc</span> <span class="main">*</span> dmu_ij_state <span class="skolem">state</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">jj</span>
                           <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">jj</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> dmu_ij_state <span class="skolem">state</span> <span class="free">i</span> <span class="bound">jj</span> <span class="main">-</span> d_state <span class="skolem">state</span> <span class="skolem">j</span> <span class="main">*</span> <span class="skolem">fc</span> <span class="keyword1">else</span> dmu_ij_state <span class="skolem">state</span> <span class="free">i</span> <span class="bound">jj</span><span class="main">)</span>
                     <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">st</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">res</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_add_rows_loop_cost <span class="skolem">st</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">fs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">res</span><span class="main">,</span><span class="skolem">c2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">fs</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> result_costD'<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">OF</span></span> this<span class="main"><span class="main"><span class="main">]</span></span></span> rec<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_add_rows_loop <span class="free">n</span> <span class="skolem">st</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">fs</span> <span class="main">=</span> <span class="skolem">res</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> Suc <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> basis_reduction_add_rows_loop_cost.simps Let_def flc split 
      LLL_Impl.basis_reduction_add_rows_loop.simps fl st rec res cost_simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">c2</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> Suc <span class="bound">j</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> Suc <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> c1 c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sum.remove<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">j</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cost_simps<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">basis_reduction_add_rows_cost</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_add_rows_cost</span> <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="keyword1">then</span> basis_reduction_add_rows_loop_cost <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>small_fs_state <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">)</span> 
        <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="LLL_Complexity-basis_reduction_add_rows_cost"><span class="command">lemma</span></span> basis_reduction_add_rows_cost<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"result <span class="main">(</span>basis_reduction_add_rows_cost <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span><span class="main">)</span> <span class="main">=</span> LLL_Impl.basis_reduction_add_rows <span class="free">n</span> <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span>"</span></span>  
   <span class="quoted"><span class="quoted">"cost <span class="main">(</span>basis_reduction_add_rows_cost <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">i</span> <span class="main">+</span> <span class="numeral">7</span><span class="main">)</span> <span class="main">*</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> basis_reduction_add_rows_cost_def LLL_Impl.basis_reduction_add_rows_def
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">upw</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d cost_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> upw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">upw</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">mu</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">state</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">mu</span><span class="main">,</span><span class="skolem">ds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">state</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> to_list_repr<span class="main">[</span><span class="operator">OF</span> impl inv state<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>small_fs_state <span class="free">state</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> small_fs_state.simps state list_repr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?call</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"basis_reduction_add_rows_cost <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"result <span class="var">?call</span> <span class="main">=</span> LLL_Impl.basis_reduction_add_rows <span class="free">n</span> <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> cost<span class="main">:</span> <span class="quoted"><span class="quoted">"cost <span class="var">?call</span> <span class="main">≤</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> d upw if_True <span class="keyword1"><span class="command">using</span></span> basis_reduction_add_rows_loop_cost<span class="main">[</span><span class="operator">OF</span> len<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">state</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> cost
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">7</span><span class="main">)</span> <span class="main">*</span> <span class="free">i</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">.</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span>  sum.distrib sum_distrib_right sum_distrib_left<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">.</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cost <span class="var">?call</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">7</span><span class="main">)</span> <span class="main">*</span> <span class="free">i</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span><span class="free">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">7</span><span class="main">)</span> <span class="main">*</span> <span class="free">i</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">i</span> <span class="main">*</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> add_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span><span class="free">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">i</span> <span class="main">*</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span><span class="free">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">i</span> <span class="main">*</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">i</span> <span class="main">+</span> <span class="numeral">7</span><span class="main">)</span> <span class="main">*</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> cost<span class="main">:</span> <span class="quoted"><span class="quoted">"cost <span class="var">?call</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">i</span> <span class="main">+</span> <span class="numeral">7</span><span class="main">)</span> <span class="main">*</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> res cost <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">swap_mu_cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int iarray iarray <span class="main">⇒</span> nat <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> int iarray iarray cost"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">swap_mu_cost</span> <span class="free"><span class="bound"><span class="entity">dmu</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">dmu_i_im1</span></span></span> <span class="free"><span class="bound"><span class="entity">dim1</span></span></span> <span class="free"><span class="bound"><span class="entity">di</span></span></span> <span class="free"><span class="bound"><span class="entity">dsi</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">im1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">;</span>
       <span class="bound">res</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">ii</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">ii</span> <span class="main">&lt;</span> <span class="bound">im1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">dmu</span></span></span> <span class="main">!!</span> <span class="bound">ii</span> <span class="keyword1">else</span> 
         <span class="keyword1">if</span> <span class="bound">ii</span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">dmu_ii</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">dmu</span></span></span> <span class="main">!!</span> <span class="bound">ii</span> <span class="keyword1">in</span> 
             IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">dmu_ii_j</span> <span class="main">=</span> <span class="bound">dmu_ii</span> <span class="main">!!</span> <span class="bound">j</span> <span class="keyword1">in</span>   <span class="comment1">― ‹8 arith. operations for whole line›</span>
                 <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dsi</span></span></span> <span class="main">*</span> <span class="bound">dmu_ii</span> <span class="main">!!</span> <span class="bound">im1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">dmu_i_im1</span></span></span> <span class="main">*</span> <span class="bound">dmu_ii_j</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free"><span class="bound"><span class="entity">di</span></span></span> <span class="comment1">― ‹4 arith. operations for this entry›</span>
                 <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">im1</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dmu_i_im1</span></span></span> <span class="main">*</span> <span class="bound">dmu_ii_j</span> <span class="main">+</span> <span class="bound">dmu_ii</span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">dim1</span></span></span><span class="main">)</span> <span class="keyword1">div</span> <span class="free"><span class="bound"><span class="entity">di</span></span></span> <span class="comment1">― ‹4 arith. operations for this entry›</span>
                 <span class="keyword1">else</span> <span class="bound">dmu_ii_j</span><span class="main">)</span> <span class="bound">ii</span> <span class="keyword1">else</span> 
         <span class="keyword1">if</span> <span class="bound">ii</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">mu_im1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">dmu</span></span></span> <span class="main">!!</span> <span class="bound">im1</span> <span class="keyword1">in</span> 
             IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">im1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">dmu_i_im1</span></span></span> <span class="keyword1">else</span> <span class="bound">mu_im1</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">ii</span> 
           <span class="keyword1">else</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">dmu</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">ii</span><span class="main">)</span> <span class="comment1">― ‹ii = i - 1›</span>
         <span class="free">m</span><span class="main">;</span> <span class="comment1">― ‹in total, there are m - (i+1) many lines that require arithmetic operations: i + 1, ..., m - 1›</span>
       <span class="bound">cost</span> <span class="main">=</span> <span class="numeral">8</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">res</span><span class="main">,</span><span class="bound">cost</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="LLL_Complexity-swap_mu_cost"><span class="command">lemma</span></span> swap_mu_cost<span class="main">:</span> 
   <span class="quoted"><span class="quoted">"result <span class="main">(</span>swap_mu_cost <span class="free">dmu</span> <span class="free">i</span> <span class="free">dmu_i_im1</span> <span class="free">dim1</span> <span class="free">di</span> <span class="free">dsi</span><span class="main">)</span> <span class="main">=</span> swap_mu <span class="free">m</span> <span class="free">dmu</span> <span class="free">i</span> <span class="free">dmu_i_im1</span> <span class="free">dim1</span> <span class="free">di</span> <span class="free">dsi</span>"</span></span>  
   <span class="quoted"><span class="quoted">"cost <span class="main">(</span>swap_mu_cost <span class="free">dmu</span> <span class="free">i</span> <span class="free">dmu_i_im1</span> <span class="free">dim1</span> <span class="free">di</span> <span class="free">dsi</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">8</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> Suc <span class="free">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> swap_mu_cost_def swap_mu_def Let_def cost_simps<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">basis_reduction_swap_cost</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_swap_cost</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> 
       <span class="bound">di</span> <span class="main">=</span> d_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
       <span class="bound">dsi</span> <span class="main">=</span> d_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">;</span>
       <span class="bound">dim1</span> <span class="main">=</span> d_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">fi</span> <span class="main">=</span> fi_state <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">;</span>
       <span class="bound">fim1</span> <span class="main">=</span> fim1_state <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">;</span>
       <span class="bound">dmu_i_im1</span> <span class="main">=</span> dmu_ij_state <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">fi'</span> <span class="main">=</span> <span class="bound">fim1</span><span class="main">;</span>
       <span class="bound">fim1'</span> <span class="main">=</span> <span class="bound">fi</span><span class="main">;</span>
       <span class="bound">di'</span> <span class="main">=</span> <span class="main">(</span><span class="bound">dsi</span> <span class="main">*</span> <span class="bound">dim1</span> <span class="main">+</span> <span class="bound">dmu_i_im1</span> <span class="main">*</span> <span class="bound">dmu_i_im1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">di</span><span class="main">;</span> <span class="comment1">― ‹4 arith. operations›</span>
       <span class="bound">local_cost</span> <span class="main">=</span> <span class="numeral">4</span> 
     <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">dmus</span><span class="main">,</span><span class="bound">djs</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="keyword1">case</span> swap_mu_cost <span class="bound">dmus</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">dmu_i_im1</span> <span class="bound">dim1</span> <span class="bound">di</span> <span class="bound">dsi</span> <span class="keyword1">of</span>
          <span class="main">(</span><span class="bound">swap_res</span><span class="main">,</span> <span class="bound">swap_cost</span><span class="main">)</span> <span class="main">⇒</span>
          <span class="keyword1">let</span> <span class="bound">res</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> 
                     <span class="main">(</span>dec_i <span class="main">(</span>update_im1 <span class="main">(</span>update_i <span class="bound">f</span> <span class="bound">fi'</span><span class="main">)</span> <span class="bound">fim1'</span><span class="main">)</span><span class="main">,</span> 
                      <span class="bound">swap_res</span><span class="main">,</span> 
                      iarray_update <span class="bound">djs</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">di'</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
              <span class="bound">cost</span> <span class="main">=</span> <span class="bound">local_cost</span> <span class="main">+</span> <span class="bound">swap_cost</span> 
         <span class="keyword1">in</span> <span class="main">(</span><span class="bound">res</span><span class="main">,</span> <span class="bound">cost</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LLL_Complexity-basis_reduction_swap_cost"><span class="command">lemma</span></span> basis_reduction_swap_cost<span class="main">:</span> 
   <span class="quoted"><span class="quoted">"result <span class="main">(</span>basis_reduction_swap_cost <span class="free">i</span> <span class="free">state</span><span class="main">)</span> <span class="main">=</span> LLL_Impl.basis_reduction_swap <span class="free">m</span> <span class="free">i</span> <span class="free">state</span>"</span></span>  
   <span class="quoted"><span class="quoted">"cost <span class="main">(</span>basis_reduction_swap_cost <span class="free">i</span> <span class="free">state</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">8</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> Suc <span class="free">i</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">dmus</span></span> <span class="skolem"><span class="skolem">djs</span></span> <span class="keyword2"><span class="keyword">where</span></span> state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">state</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">dmus</span><span class="main">,</span><span class="skolem">djs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">state</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dmu_ij_state <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">dmus</span><span class="main">,</span> <span class="skolem">djs</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?di1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"d_state <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">dmus</span><span class="main">,</span> <span class="skolem">djs</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?di</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"d_state <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">dmus</span><span class="main">,</span> <span class="skolem">djs</span><span class="main">)</span> <span class="free">i</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dsi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"d_state <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">dmus</span><span class="main">,</span> <span class="skolem">djs</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> basis_reduction_swap_cost_def LLL_Impl.basis_reduction_swap_def Let_def state split
    <span class="keyword1"><span class="command">using</span></span> swap_mu_cost<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">dmus</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?mu</span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?di1</span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?di</span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?dsi</span></span></span></span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"swap_mu_cost <span class="skolem">dmus</span> <span class="free">i</span> <span class="var">?mu</span> <span class="var">?di1</span> <span class="var">?di</span> <span class="var">?dsi</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cost_simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">basis_reduction_step_cost</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_step_cost</span> <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">(</span>True<span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> inc_state <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">let</span> 
       <span class="main">(</span><span class="bound">state'</span><span class="main">,</span><span class="bound">cost_add</span><span class="main">)</span> <span class="main">=</span> basis_reduction_add_rows_cost <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">;</span>
       <span class="bound">di</span> <span class="main">=</span> d_state <span class="bound">state'</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
       <span class="bound">dsi</span> <span class="main">=</span> d_state <span class="bound">state'</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">;</span>
       <span class="bound">dim1</span> <span class="main">=</span> d_state <span class="bound">state'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="bound">num</span><span class="main">,</span><span class="bound">denom</span><span class="main">)</span> <span class="main">=</span> quotient_of <span class="free">α</span><span class="main">;</span>
       <span class="bound">cond</span> <span class="main">=</span> <span class="main">(</span><span class="bound">di</span> <span class="main">*</span> <span class="bound">di</span> <span class="main">*</span> <span class="bound">denom</span> <span class="main">≤</span> <span class="bound">num</span> <span class="main">*</span> <span class="bound">dim1</span> <span class="main">*</span> <span class="bound">dsi</span><span class="main">)</span><span class="main">;</span> <span class="comment1">― ‹5 arith. operations›</span>
       <span class="bound">local_cost</span> <span class="main">=</span> <span class="numeral">5</span>
    <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">cond</span> <span class="keyword1">then</span>
          <span class="main">(</span><span class="main">(</span>True<span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> inc_state <span class="bound">state'</span><span class="main">)</span><span class="main">,</span> <span class="bound">local_cost</span> <span class="main">+</span> <span class="bound">cost_add</span><span class="main">)</span> 
        <span class="keyword1">else</span> <span class="keyword1">case</span> basis_reduction_swap_cost <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">state'</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">res</span><span class="main">,</span> <span class="bound">cost_swap</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">res</span><span class="main">,</span> <span class="bound">local_cost</span> <span class="main">+</span> <span class="bound">cost_swap</span> <span class="main">+</span> <span class="bound">cost_add</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">body_cost</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">8</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span>"</span></span> 

<span class="keyword1" id="LLL_Complexity-basis_reduction_step_cost"><span class="command">lemma</span></span> basis_reduction_step_cost<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 
    impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"result <span class="main">(</span>basis_reduction_step_cost <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span><span class="main">)</span> <span class="main">=</span> LLL_Impl.basis_reduction_step <span class="free">α</span> <span class="free">n</span> <span class="free">m</span> <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span><span class="main">)</span>
     <span class="quoted"><span class="quoted">"cost <span class="main">(</span>basis_reduction_step_cost <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span><span class="main">)</span> <span class="main">≤</span> body_cost"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">state'</span></span> <span class="skolem"><span class="skolem">c_add</span></span> <span class="keyword2"><span class="keyword">where</span></span> add<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_add_rows_cost <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">state'</span><span class="main">,</span><span class="skolem">c_add</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?add</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?add</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">state''</span></span> <span class="skolem"><span class="skolem">c_swap</span></span> <span class="keyword2"><span class="keyword">where</span></span> swapc<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_swap_cost <span class="free">i</span> <span class="skolem">state'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">state''</span><span class="main">,</span><span class="skolem">c_swap</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?swap</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?swap</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> basis_reduction_step_cost_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">upw</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">state</span></span><span class="main">,</span> <span class="operator">unfolded</span> add split swap<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> result_costD<span class="main">[</span><span class="operator">OF</span> basis_reduction_add_rows_cost<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">OF</span></span> impl inv<span class="main"><span class="main"><span class="main">]</span></span></span> add<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> add<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_add_rows <span class="free">n</span> <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span> <span class="main">=</span> <span class="skolem">state'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> c_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c_add</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">i</span> <span class="main">+</span> <span class="numeral">7</span><span class="main">)</span> <span class="main">*</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> result_costD<span class="main">[</span><span class="operator">OF</span> basis_reduction_swap_cost swapc<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> swap<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_swap <span class="free">m</span> <span class="free">i</span> <span class="skolem">state'</span> <span class="main">=</span> <span class="skolem">state''</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> c_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c_swap</span> <span class="main">≤</span> <span class="numeral">8</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> Suc <span class="free">i</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c_add</span> <span class="main">+</span> <span class="skolem">c_swap</span> <span class="main">+</span> <span class="numeral">5</span> <span class="main">≤</span> <span class="numeral">8</span> <span class="main">*</span> <span class="free">m</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> c_add c_swap i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">8</span> <span class="main">*</span> <span class="free">m</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_left_mono mult_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">8</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> body<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c_add</span> <span class="main">+</span> <span class="skolem">c_swap</span> <span class="main">+</span> <span class="numeral">5</span> <span class="main">≤</span> body_cost"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> body_cost_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">num</span></span> <span class="skolem"><span class="skolem">denom</span></span> <span class="keyword2"><span class="keyword">where</span></span> alpha<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="free">α</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">num</span><span class="main">,</span><span class="skolem">denom</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">note</span></span> res' <span class="main">=</span> LLL_Impl.basis_reduction_step_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">upw</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">state</span></span><span class="main">,</span> <span class="operator">unfolded</span> add swap Let_def alpha split<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> res res'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cost_simps Let_def alpha swapc<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> d nat_distrib <span class="keyword1"><span class="command">using</span></span> body <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cost_simps alpha Let_def swapc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>tailrec<span class="main">)</span> <span class="entity">basis_reduction_main_cost</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_main_cost</span> <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free">m</span>
     <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="main">(</span><span class="main">(</span><span class="bound">upw'</span><span class="main">,</span><span class="bound">i'</span><span class="main">,</span><span class="bound">state'</span><span class="main">)</span><span class="main">,</span> <span class="bound">c_step</span><span class="main">)</span> <span class="main">=</span> basis_reduction_step_cost <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span>
       <span class="keyword1">in</span> <span class="free">basis_reduction_main_cost</span> <span class="bound">upw'</span> <span class="bound">i'</span> <span class="bound">state'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">+</span> <span class="bound">c_step</span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">num_loops</span> <span class="main">=</span> <span class="free">m</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> nat <span class="main">(</span>ceiling <span class="main">(</span>log base <span class="main">(</span>real N<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LLL_Complexity-basis_reduction_main_cost"><span class="command">lemma</span></span> basis_reduction_main_cost<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> impl<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="free">state</span> <span class="free">i</span> <span class="main">(</span>fs_state <span class="free">state</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="main">(</span>fs_state <span class="free">state</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">state</span> <span class="main">=</span> initial_state <span class="free">m</span> <span class="free">fs_init</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"result <span class="main">(</span>basis_reduction_main_cost <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> LLL_Impl.basis_reduction_main <span class="free">α</span> <span class="free">n</span> <span class="free">m</span> <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span><span class="main">)</span> 
   <span class="quoted"><span class="quoted">"cost <span class="main">(</span>basis_reduction_main_cost <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span> <span class="free">c</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">+</span> body_cost <span class="main">*</span> num_loops"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> cost<span class="main">:</span> <span class="quoted"><span class="quoted">"cost <span class="main">(</span>basis_reduction_main_cost <span class="free">upw</span> <span class="free">i</span> <span class="free">state</span> <span class="free">c</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">+</span> body_cost <span class="main">*</span> LLL_measure <span class="free">i</span> <span class="main">(</span>fs_state <span class="free">state</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-2<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="main">(</span>fs_state <span class="free">state</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">upw</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">state</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">i</span> <span class="skolem">state</span> <span class="skolem">upw</span> <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> less<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> impl <span class="main">=</span> less<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">upw'</span></span> <span class="skolem"><span class="skolem">state'</span></span> <span class="skolem"><span class="skolem">c_step</span></span> <span class="keyword2"><span class="keyword">where</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_step_cost <span class="skolem">upw</span> <span class="skolem">i</span> <span class="skolem">state</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">upw'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">,</span><span class="skolem">state'</span><span class="main">)</span><span class="main">,</span><span class="skolem">c_step</span><span class="main">)</span>"</span></span> 
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?step</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?step</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">state''</span></span> <span class="skolem"><span class="skolem">c_rec</span></span> <span class="keyword2"><span class="keyword">where</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_main_cost <span class="skolem">upw'</span> <span class="skolem">i'</span> <span class="skolem">state'</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">+</span> <span class="skolem">c_step</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">state''</span><span class="main">,</span> <span class="skolem">c_rec</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rec</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?rec</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> step' <span class="main">=</span> result_costD<span class="main">[</span><span class="operator">OF</span> basis_reduction_step_cost<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">OF</span></span> impl inv<span class="main"><span class="main"><span class="main">]</span></span></span> step<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> basis_reduction_main_cost.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">upw</span></span><span class="main">]</span> step split rec 
        LLL_Impl.basis_reduction_main.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">upw</span></span><span class="main">]</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> i<span class="main">:</span> True
      <span class="keyword1"><span class="command">from</span></span> step' i <span class="keyword1"><span class="command">have</span></span> step'<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_step <span class="free">α</span> <span class="free">n</span> <span class="free">m</span> <span class="skolem">upw</span> <span class="skolem">i</span> <span class="skolem">state</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">upw'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">,</span><span class="skolem">state'</span><span class="main">)</span>"</span></span>
         <span class="keyword2"><span class="keyword">and</span></span> c_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c_step</span> <span class="main">≤</span> body_cost"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> d step'
      <span class="keyword1"><span class="command">from</span></span> basis_reduction_step<span class="main">[</span><span class="operator">OF</span> impl inv step' i refl<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> impl'<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_impl_inv <span class="skolem">state'</span> <span class="skolem">i'</span> <span class="main">(</span>fs_state <span class="skolem">state'</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> inv'<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="skolem">upw'</span> <span class="skolem">i'</span> <span class="main">(</span>fs_state <span class="skolem">state'</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> meas<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_measure <span class="skolem">i'</span> <span class="main">(</span>fs_state <span class="skolem">state'</span><span class="main">)</span> <span class="main">&lt;</span> LLL_measure <span class="skolem">i</span> <span class="main">(</span>fs_state <span class="skolem">state</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> result_costD'<span class="main">[</span><span class="operator">OF</span> less<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">OF</span></span> meas impl' inv'<span class="main"><span class="main"><span class="main">]</span></span></span> rec<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> rec'<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_main <span class="free">α</span> <span class="free">n</span> <span class="free">m</span> <span class="skolem">upw'</span> <span class="skolem">i'</span> <span class="skolem">state'</span> <span class="main">=</span> <span class="skolem">state''</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> c_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c_rec</span> <span class="main">≤</span> <span class="skolem">c</span> <span class="main">+</span> <span class="skolem">c_step</span> <span class="main">+</span> body_cost <span class="main">*</span> LLL_measure <span class="skolem">i'</span> <span class="main">(</span>fs_state <span class="skolem">state'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> c_step c_rec <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c_rec</span> <span class="main">≤</span> <span class="skolem">c</span> <span class="main">+</span> body_cost <span class="main">*</span> Suc <span class="main">(</span>LLL_measure <span class="skolem">i'</span> <span class="main">(</span>fs_state <span class="skolem">state'</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">c</span> <span class="main">+</span> body_cost <span class="main">*</span> LLL_measure <span class="skolem">i</span> <span class="main">(</span>fs_state <span class="skolem">state</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> meas <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> plus_right_mono mult_left_mono<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> i inv impl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cost_simps d rec'<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cost_simps<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">note</span></span> cost <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"body_cost <span class="main">*</span> LLL_measure <span class="free">i</span> <span class="main">(</span>fs_state <span class="free">state</span><span class="main">)</span> <span class="main">≤</span> body_cost <span class="main">*</span> num_loops"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main"><span class="keyword3">;</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> log base <span class="main">(</span>real N<span class="main">)</span>"</span></span> 
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span>"</span></span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">mu</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"initial_state <span class="free">m</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">mu</span><span class="main">,</span><span class="skolem">ds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"initial_state <span class="free">m</span> <span class="free">fs_init</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> initial_state
    <span class="keyword1"><span class="command">have</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"fs_state <span class="main">(</span>initial_state <span class="free">m</span> <span class="free">fs_init</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs_init</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="main">(</span>fs_state <span class="free">state</span><span class="main">)</span> <span class="main">≤</span> nat <span class="main">(</span>ceiling <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> l_def k_def
      <span class="keyword1"><span class="command">using</span></span> LLL_measure_approx_fs_init<span class="main">[</span><span class="operator">OF</span> LLL_inv_initial_state α_gt m0<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> state fs i
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> num_loops"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> num_loops_def l_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> k_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_ceiling times_right_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="main">(</span>fs_state <span class="free">state</span><span class="main">)</span> <span class="main">≤</span> num_loops"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span>
  <span class="free">fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec iarray"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span> 
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sigma_array_cost</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sigma_array_cost</span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="free"><span class="bound"><span class="entity">dmusi</span></span></span> <span class="free"><span class="bound"><span class="entity">dmusj</span></span></span> <span class="free"><span class="bound"><span class="entity">dll</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dmusi</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">dmusj</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">l1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">;</span> <span class="bound">dll1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="main">!!</span> <span class="bound">l1</span> <span class="main">!!</span> <span class="bound">l1</span><span class="main">;</span>
        <span class="main">(</span><span class="bound">sig</span><span class="main">,</span> <span class="bound">cost_rec</span><span class="main">)</span> <span class="main">=</span> <span class="free">sigma_array_cost</span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="free"><span class="bound"><span class="entity">dmusi</span></span></span> <span class="free"><span class="bound"><span class="entity">dmusj</span></span></span> <span class="bound">dll1</span> <span class="bound">l1</span><span class="main">;</span>
        <span class="bound">res</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dll</span></span></span> <span class="main">*</span> <span class="bound">sig</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">dmusi</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">dmusj</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">dll1</span><span class="main">;</span> <span class="comment1">― ‹4 arith. operations›</span>
        <span class="bound">local_cost</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::</span> nat<span class="main">)</span>
        <span class="keyword1">in</span>
      <span class="main">(</span><span class="bound">res</span><span class="main">,</span> <span class="bound">local_cost</span> <span class="main">+</span> <span class="bound">cost_rec</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> sigma_array_cost.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="LLL_Complexity-sigma_array_cost"><span class="command">lemma</span></span> sigma_array_cost<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"result <span class="main">(</span>sigma_array_cost <span class="free">dmus</span> <span class="free">dmusi</span> <span class="free">dmusj</span> <span class="free">dll</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> sigma_array <span class="free">dmus</span> <span class="free">dmusi</span> <span class="free">dmusj</span> <span class="free">dll</span> <span class="free">l</span>"</span></span>
  <span class="quoted"><span class="quoted">"cost <span class="main">(</span>sigma_array_cost <span class="free">dmus</span> <span class="free">dmusi</span> <span class="free">dmusj</span> <span class="free">dll</span> <span class="free">l</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">l</span> <span class="main">+</span> <span class="main">1</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">dll</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sigma_array_cost.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> sigma_array.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cost_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">l</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dll</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">dmus</span> <span class="main">!!</span> <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">!!</span> <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sigma_array_cost.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?sl</span></span></span><span class="main">]</span> sigma_array.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?sl</span></span></span><span class="main">]</span> Let_def
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?dll</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cost_simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">dmu_array_row_main_cost</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dmu_array_row_main_cost</span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dmus</span></span></span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">sj</span> <span class="main">=</span> Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">;</span> 
       <span class="bound">dmus_i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
       <span class="bound">djj</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">;</span>
       <span class="main">(</span><span class="bound">sigma</span><span class="main">,</span> <span class="bound">cost_sigma</span><span class="main">)</span> <span class="main">=</span> sigma_array_cost <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="bound">dmus_i</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="main">!!</span> <span class="bound">sj</span><span class="main">)</span> <span class="bound">djj</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">;</span>
       <span class="bound">dmu_ij</span> <span class="main">=</span> <span class="bound">djj</span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fi</span></span></span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!!</span> <span class="bound">sj</span><span class="main">)</span> <span class="main">-</span> <span class="bound">sigma</span><span class="main">;</span> <span class="comment1">― ‹2n + 2 arith. operations›</span>
       <span class="bound">dmus'</span> <span class="main">=</span> iarray_update <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>iarray_append <span class="bound">dmus_i</span> <span class="bound">dmu_ij</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="bound">res</span><span class="main">,</span> <span class="bound">cost_rec</span><span class="main">)</span> <span class="main">=</span> <span class="free">dmu_array_row_main_cost</span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">dmus'</span> <span class="bound">sj</span><span class="main">;</span>
       <span class="bound">local_cost</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span>
      <span class="keyword1">in</span> <span class="main">(</span><span class="bound">res</span><span class="main">,</span> <span class="bound">cost_rec</span> <span class="main">+</span> <span class="bound">cost_sigma</span> <span class="main">+</span> <span class="bound">local_cost</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">fi</span><span class="main">,</span><span class="bound">i</span><span class="main">,</span><span class="bound">dmus</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> dmu_array_row_main_cost.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="LLL_Complexity-dmu_array_row_main_cost"><span class="command">lemma</span></span> dmu_array_row_main_cost<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"result <span class="main">(</span>dmu_array_row_main_cost <span class="free">fi</span> <span class="free">i</span> <span class="free">dmus</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> dmu_array_row_main <span class="free">fs</span> <span class="free">fi</span> <span class="free">i</span> <span class="free">dmus</span> <span class="free">j</span>"</span></span>
  <span class="quoted"><span class="quoted">"cost <span class="main">(</span>dmu_array_row_main_cost <span class="free">fi</span> <span class="free">i</span> <span class="free">dmus</span> <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">jj</span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="bound">jj</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="free">j</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">dmus</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0 <span class="skolem">j</span> <span class="skolem">dmus</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dmu_array_row_main_cost.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> 
    dmu_array_row_main.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cost_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span> <span class="skolem">j</span> <span class="skolem">dmus</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">l</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dll</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">dmus</span> <span class="main">!!</span> <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">!!</span> <span class="main">(</span>Suc <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sig</span></span> <span class="skolem"><span class="skolem">c_sig</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    sig_c<span class="main">:</span> <span class="quoted"><span class="quoted">"sigma_array_cost <span class="skolem">dmus</span> <span class="main">(</span><span class="skolem">dmus</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">dmus</span> <span class="main">!!</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">dmus</span> <span class="main">!!</span> <span class="skolem">j</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sig</span><span class="main">,</span><span class="skolem">c_sig</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> result_costD<span class="main">[</span><span class="operator">OF</span> sigma_array_cost sig_c<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> sig<span class="main">:</span> <span class="quoted"><span class="quoted">"sigma_array <span class="skolem">dmus</span> <span class="main">(</span><span class="skolem">dmus</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">dmus</span> <span class="main">!!</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">dmus</span> <span class="main">!!</span> <span class="skolem">j</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">sig</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> c_sig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c_sig</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">*</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dmus'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    dmus'<span class="main">:</span> <span class="quoted"><span class="quoted">"iarray_update <span class="skolem">dmus</span> <span class="free">i</span> <span class="main">(</span>iarray_append <span class="main">(</span><span class="skolem">dmus</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">dmus</span> <span class="main">!!</span> <span class="skolem">j</span> <span class="main">!!</span> <span class="skolem">j</span> <span class="main">*</span> <span class="main">(</span><span class="free">fi</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!!</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">sig</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">dmus'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">res</span></span> <span class="skolem"><span class="skolem">c_rec</span></span> <span class="keyword2"><span class="keyword">where</span></span> rec_c<span class="main">:</span> <span class="quoted"><span class="quoted">"dmu_array_row_main_cost <span class="free">fi</span> <span class="free">i</span> <span class="skolem">dmus'</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">res</span><span class="main">,</span> <span class="skolem">c_rec</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="bound">j</span> <span class="main">+</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> Suc <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">dmus'</span></span><span class="main">,</span> <span class="operator">unfolded</span> rec_c cost_simps<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"dmu_array_row_main <span class="free">fs</span> <span class="free">fi</span> <span class="free">i</span> <span class="skolem">dmus'</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">res</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> c_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c_rec</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">jj</span> <span class="main">=</span> Suc <span class="skolem">j</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">.</span> <span class="var">?c</span> <span class="bound">jj</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c_rec</span> <span class="main">+</span> <span class="skolem">c_sig</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="var">?c</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">jj</span> <span class="main">=</span> Suc <span class="skolem">j</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">.</span> <span class="var">?c</span> <span class="bound">jj</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> c_rec c_sig <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">jj</span> <span class="main">=</span> <span class="skolem">j</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">.</span> <span class="var">?c</span> <span class="bound">jj</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sum.remove<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">j</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Suc<span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> cost<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c_rec</span> <span class="main">+</span> <span class="skolem">c_sig</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">jj</span> <span class="main">=</span> <span class="skolem">j</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">.</span> <span class="var">?c</span> <span class="bound">jj</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dmu_array_row_main_cost.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> dmu_array_row_main.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> Let_def
    id if_False sig_c split sig dmus' rec rec_c cost_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dmu_array_row_cost</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dmu_array_row_cost</span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">fi</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
      <span class="bound">sp</span> <span class="main">=</span> <span class="bound">fi</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!!</span> <span class="main">0</span> <span class="comment1">― ‹2n arith. operations›</span><span class="main">;</span>
      <span class="bound">local_cost</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">res</span><span class="main">,</span> <span class="bound">main_cost</span><span class="main">)</span> <span class="main">=</span> dmu_array_row_main_cost <span class="bound">fi</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>iarray_append <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="main">(</span>IArray <span class="main">[</span><span class="bound">sp</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="keyword1">in</span> 
      <span class="main">(</span><span class="bound">res</span><span class="main">,</span> <span class="bound">local_cost</span> <span class="main">+</span> <span class="bound">main_cost</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="LLL_Complexity-dmu_array_row_cost"><span class="command">lemma</span></span> dmu_array_row_cost<span class="main">:</span> 
   <span class="quoted"><span class="quoted">"result <span class="main">(</span>dmu_array_row_cost <span class="free">dmus</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> dmu_array_row <span class="free">fs</span> <span class="free">dmus</span> <span class="free">i</span>"</span></span>  
   <span class="quoted"><span class="quoted">"cost <span class="main">(</span>dmu_array_row_cost <span class="free">dmus</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">i</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?arr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"iarray_append <span class="free">dmus</span> <span class="main">(</span>IArray <span class="main">[</span><span class="var">?fi</span> <span class="main">∙</span> <span class="free">fs</span> <span class="main">!!</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">res</span></span> <span class="skolem"><span class="skolem">c_main</span></span> <span class="keyword2"><span class="keyword">where</span></span> res_c<span class="main">:</span> <span class="quoted"><span class="quoted">"dmu_array_row_main_cost <span class="var">?fi</span> <span class="free">i</span> <span class="var">?arr</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">res</span><span class="main">,</span> <span class="skolem">c_main</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> result_costD<span class="main">[</span><span class="operator">OF</span> dmu_array_row_main_cost res_c<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"dmu_array_row_main <span class="free">fs</span> <span class="var">?fi</span> <span class="free">i</span> <span class="var">?arr</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">res</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> c_main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c_main</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">jj</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="bound">jj</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">c_main</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">jj</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="bound">jj</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_main <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">*</span> <span class="free">i</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">jj</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="bound">jj</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> sum.distrib <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_distrib_left <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">jj</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="bound">jj</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">c_main</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">c_main</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dmu_array_row_cost_def Let_def dmu_array_row_def res_c res split cost_simps 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">dmu_array_cost</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">dmu_array_cost</span> <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≥</span> <span class="free">m</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dmus</span></span></span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span> 
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">dmus'</span><span class="main">,</span> <span class="bound">cost_row</span><span class="main">)</span> <span class="main">=</span> dmu_array_row_cost <span class="free"><span class="bound"><span class="entity">dmus</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
        <span class="main">(</span><span class="bound">res</span><span class="main">,</span> <span class="bound">cost_rec</span><span class="main">)</span> <span class="main">=</span> <span class="free">dmu_array_cost</span> <span class="bound">dmus'</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>
     <span class="keyword1">in</span> <span class="main">(</span><span class="bound">res</span><span class="main">,</span> <span class="bound">cost_row</span> <span class="main">+</span> <span class="bound">cost_rec</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">dmus</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="free">m</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> dmu_array_cost.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="LLL_Complexity-dmu_array_cost"><span class="command">lemma</span></span> dmu_array_cost<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"result <span class="main">(</span>dmu_array_cost <span class="free">dmus</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> dmu_array <span class="free">fs</span> <span class="free">m</span> <span class="free">dmus</span> <span class="free">i</span>"</span></span>  
   <span class="quoted"><span class="quoted">"cost <span class="main">(</span>dmu_array_cost <span class="free">dmus</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">ii</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="bound">ii</span><span class="main">)</span> <span class="main">*</span> <span class="bound">ii</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">dmus</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0 <span class="skolem">i</span> <span class="skolem">dmus</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dmu_array_cost.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> 
    dmu_array.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cost_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span> <span class="skolem">i</span> <span class="skolem">dmus</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dmus'</span></span> <span class="skolem"><span class="skolem">c_row</span></span> <span class="keyword2"><span class="keyword">where</span></span> row_c<span class="main">:</span> <span class="quoted"><span class="quoted">"dmu_array_row_cost <span class="skolem">dmus</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">dmus'</span><span class="main">,</span><span class="skolem">c_row</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> result_costD<span class="main">[</span><span class="operator">OF</span> dmu_array_row_cost row_c<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> row<span class="main">:</span> <span class="quoted"><span class="quoted">"dmu_array_row <span class="free">fs</span> <span class="skolem">dmus</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">dmus'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> c_row<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c_row</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">i</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> <span class="var">?c</span> <span class="skolem">i</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">m</span> <span class="main">-</span> Suc <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">≤</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">res</span></span> <span class="skolem"><span class="skolem">c_rec</span></span> <span class="keyword2"><span class="keyword">where</span></span> rec_c<span class="main">:</span> <span class="quoted"><span class="quoted">"dmu_array_cost <span class="skolem">dmus'</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">res</span><span class="main">,</span> <span class="skolem">c_rec</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> result_costD'<span class="main">[</span><span class="operator">OF</span> IH rec_c<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"dmu_array <span class="free">fs</span> <span class="free">m</span> <span class="skolem">dmus'</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">res</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> c_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c_rec</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ii</span> <span class="main">=</span> Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">.</span> <span class="var">?c</span> <span class="bound">ii</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c_row</span> <span class="main">+</span> <span class="skolem">c_rec</span> <span class="main">≤</span> <span class="var">?c</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ii</span> <span class="main">=</span> Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">.</span> <span class="var">?c</span> <span class="bound">ii</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> c_rec c_row <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ii</span> <span class="main">=</span> <span class="skolem">i</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">.</span> <span class="var">?c</span> <span class="bound">ii</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.atLeast_Suc_lessThan <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> Suc <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dmu_array_cost.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> 
    dmu_array.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> id if_False Let_def rec_c row_c row rec split cost_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>  
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* fs *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dμ_impl_cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec list <span class="main">⇒</span> int iarray iarray cost"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dμ_impl_cost</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> dmu_array_cost <span class="main">(</span>IArray <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">(</span>IArray <span class="main">[]</span><span class="main">)</span> <span class="main">0</span>"</span></span>  

<span class="keyword1" id="LLL_Complexity-dμ_impl_cost"><span class="command">lemma</span></span> dμ_impl_cost<span class="main">:</span> <span class="quoted"><span class="quoted">"result <span class="main">(</span>dμ_impl_cost <span class="free">fs_init</span><span class="main">)</span> <span class="main">=</span> dμ_impl <span class="free">fs_init</span>"</span></span> 
  <span class="quoted"><span class="quoted">"cost <span class="main">(</span>dμ_impl_cost <span class="free">fs_init</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"IArray <span class="free">fs_init</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dmus</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"IArray <span class="main">[]</span>"</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">res</span></span> <span class="skolem"><span class="skolem">cost</span></span> <span class="keyword2"><span class="keyword">where</span></span> res_c<span class="main">:</span> <span class="quoted"><span class="quoted">"dmu_array_cost <span class="var">?fs</span> <span class="var">?dmus</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">res</span><span class="main">,</span> <span class="skolem">cost</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> result_costD<span class="main">[</span><span class="operator">OF</span> dmu_array_cost res_c<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"dmu_array <span class="var">?fs</span> <span class="free">m</span> <span class="var">?dmus</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">res</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> cost<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cost</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ii</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="bound">ii</span><span class="main">)</span> <span class="main">*</span> <span class="bound">ii</span><span class="main">)</span> "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">note</span></span> cost
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">ii</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="bound">ii</span><span class="main">)</span> <span class="main">*</span> <span class="bound">ii</span><span class="main">)</span> 
     <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">m</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ii</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">.</span>  <span class="bound">ii</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ii</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">.</span> <span class="bound">ii</span> <span class="main">*</span> <span class="bound">ii</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> sum.distrib sum_distrib_left <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">m</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ii</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">.</span>  <span class="bound">ii</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ii</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">.</span> <span class="bound">ii</span> <span class="main">*</span> <span class="bound">ii</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ii</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">.</span>  <span class="bound">ii</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ii</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">.</span>  <span class="bound">ii</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ii</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">.</span>  <span class="bound">ii</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ii</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">.</span>  <span class="bound">ii</span> <span class="main">*</span> <span class="bound">ii</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">6</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ii</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">.</span>  <span class="bound">ii</span> <span class="main">*</span> <span class="bound">ii</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">6</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ii</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">.</span>  <span class="bound">ii</span> <span class="main">*</span> <span class="bound">ii</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cost</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">m</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">m</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono div_le_mono mult_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>  
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">m</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">+</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dμ_impl_cost_def dμ_impl_def len res res_c cost_simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">initial_gso_cost</span> <span class="main">=</span> <span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">initial_state_cost</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
  <span class="main">(</span><span class="bound">dmus</span><span class="main">,</span> <span class="bound">cost</span><span class="main">)</span> <span class="main">=</span> dμ_impl_cost <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">;</span>
  <span class="bound">ds</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">i1</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">in</span> <span class="bound">dmus</span> <span class="main">!!</span> <span class="bound">i1</span> <span class="main">!!</span> <span class="bound">i1</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">dmus'</span> <span class="main">=</span> IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">row_i</span> <span class="main">=</span> <span class="bound">dmus</span> <span class="main">!!</span> <span class="bound">i</span> <span class="keyword1">in</span>
       IArray.of_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">row_i</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="free">m</span>
  <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">,</span> <span class="bound">dmus'</span><span class="main">,</span> <span class="bound">ds</span><span class="main">)</span><span class="main">,</span> <span class="bound">cost</span><span class="main">)</span> <span class="main">::</span> LLL_dmu_d_state cost<span class="main">)</span>"</span></span> 


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">basis_reduction_cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> LLL_dmu_d_state cost"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">basis_reduction_cost</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">case</span> initial_state_cost <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">state1</span><span class="main">,</span> <span class="bound">c1</span><span class="main">)</span> <span class="main">⇒</span> 
    <span class="keyword1">case</span> basis_reduction_main_cost True <span class="main">0</span> <span class="bound">state1</span> <span class="main">0</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">state2</span><span class="main">,</span> <span class="bound">c2</span><span class="main">)</span> <span class="main">⇒</span> 
      <span class="main">(</span><span class="bound">state2</span><span class="main">,</span> <span class="bound">c1</span> <span class="main">+</span> <span class="bound">c2</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reduce_basis_cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> int vec list cost"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reduce_basis_cost</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="keyword1">of</span> Nil <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">|</span> Cons <span class="bound">f</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> 
    <span class="keyword1">case</span> basis_reduction_cost <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">state</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span>fs_state <span class="bound">state</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="LLL_Complexity-initial_state_cost"><span class="command">lemma</span></span> initial_state_cost<span class="main">:</span> <span class="quoted"><span class="quoted">"result <span class="main">(</span>initial_state_cost <span class="free">fs_init</span><span class="main">)</span> <span class="main">=</span> initial_state <span class="free">m</span> <span class="free">fs_init</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span><span class="main">)</span>
  <span class="quoted"><span class="quoted">"cost <span class="main">(</span>initial_state_cost <span class="free">fs_init</span><span class="main">)</span> <span class="main">≤</span> initial_gso_cost"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> dmu<span class="main">:</span> <span class="quoted"><span class="quoted">"dμ_impl_cost <span class="free">fs_init</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> dμ_impl_cost<span class="main">[</span><span class="operator">unfolded</span> dmu cost_simps<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> dmu'<span class="main">:</span> <span class="quoted"><span class="quoted">"dμ_impl <span class="free">fs_init</span> <span class="main">=</span> <span class="skolem">st</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≤</span> initial_gso_cost"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> initial_gso_cost_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">unfolding</span></span> initial_state_cost_def dmu dmu' split cost_simps 
    initial_state_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Complexity-basis_reduction_cost"><span class="command">lemma</span></span> basis_reduction_cost<span class="main">:</span> 
   <span class="quoted"><span class="quoted">"result <span class="main">(</span>basis_reduction_cost <span class="free">fs_init</span><span class="main">)</span> <span class="main">=</span> basis_reduction <span class="free">α</span> <span class="free">n</span> <span class="free">fs_init</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span><span class="main">)</span>
   <span class="quoted"><span class="quoted">"cost <span class="main">(</span>basis_reduction_cost <span class="free">fs_init</span><span class="main">)</span> <span class="main">≤</span> initial_gso_cost <span class="main">+</span> body_cost <span class="main">*</span> num_loops"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">state1</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="keyword2"><span class="keyword">where</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"initial_state_cost <span class="free">fs_init</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">state1</span><span class="main">,</span> <span class="skolem">c1</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?init</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?init</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">state2</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> main<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_main_cost True <span class="main">0</span> <span class="skolem">state1</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">state2</span><span class="main">,</span> <span class="skolem">c2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?main</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?main</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_cost <span class="free">fs_init</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">state2</span><span class="main">,</span> <span class="skolem">c1</span> <span class="main">+</span> <span class="skolem">c2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> basis_reduction_cost_def init main split <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> result_costD<span class="main">[</span><span class="operator">OF</span> initial_state_cost init<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">≤</span> initial_gso_cost"</span></span> <span class="keyword2"><span class="keyword">and</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"initial_state <span class="free">m</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="skolem">state1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_inv_initial_state<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> impl <span class="main">=</span> initial_state
  <span class="keyword1"><span class="command">have</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"fs_state <span class="main">(</span>initial_state <span class="free">m</span> <span class="free">fs_init</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs_init</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> basis_reduction_main_cost<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"initial_state <span class="free"><span class="free">m</span></span> <span class="free"><span class="free">fs_init</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span><span class="main">,</span> <span class="operator">unfolded</span> fs<span class="main">,</span> <span class="operator">OF</span> impl<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> inv<span class="main">,</span>
    <span class="operator">unfolded</span> init main cost_simps<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> main<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.basis_reduction_main <span class="free">α</span> <span class="free">n</span> <span class="free">m</span> True <span class="main">0</span> <span class="skolem">state1</span> <span class="main">=</span> <span class="skolem">state2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">≤</span> body_cost <span class="main">*</span> num_loops"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> res'<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction <span class="free">α</span> <span class="free">n</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="skolem">state2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> basis_reduction_def len init main Let_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> res res' cost_simps <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> res cost_simps <span class="keyword1"><span class="command">using</span></span> c1 c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The lemma for the LLL algorithm with explicit cost annotations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> reduce_basis_cost<span class="antiquote"><span class="antiquote">}</span></span></span></span>
  shows that the termination measure
  indeed gives rise to an explicit cost bound. Moreover, the computed result is
  the same as in the non-cost counting <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> reduce_basis<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1" id="LLL_Complexity-reduce_basis_cost"><span class="command">lemma</span></span> reduce_basis_cost<span class="main">:</span> 
   <span class="quoted"><span class="quoted">"result <span class="main">(</span>reduce_basis_cost <span class="free">fs_init</span><span class="main">)</span> <span class="main">=</span> LLL_Impl.reduce_basis <span class="free">α</span> <span class="free">fs_init</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span><span class="main">)</span>
   <span class="quoted"><span class="quoted">"cost <span class="main">(</span>reduce_basis_cost <span class="free">fs_init</span><span class="main">)</span> <span class="main">≤</span> initial_gso_cost <span class="main">+</span> body_cost <span class="main">*</span> num_loops"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> reduce_basis_cost_def LLL_Impl.reduce_basis_def
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fs_init</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">unfolding</span></span> Nil <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cost_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">state</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_cost <span class="free">fs_init</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">state</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> result_costD<span class="main">[</span><span class="operator">OF</span> basis_reduction_cost b<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> bb<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction <span class="free">α</span> <span class="free">n</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="skolem">state</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≤</span> initial_gso_cost <span class="main">+</span> body_cost <span class="main">*</span> num_loops"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> fs_init<span class="main">[</span><span class="operator">unfolded</span> Cons<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> dim<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="skolem">f</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> d b split <span class="keyword1"><span class="command">unfolding</span></span> Cons list.simps <span class="keyword1"><span class="command">unfolding</span></span> Cons<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> dim bb
      <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cost_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Complexity-mn"><span class="command">lemma</span></span> mn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> len<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> lin_dep length_map <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct_card gs.dim_is_n gs.fin_dim gs.li_le_dim<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem with expanded costs: $O(n\cdot m^3 \cdot \log (\mathit{maxnorm}\ F))$ arithmetic operations›</span></span>
<span class="keyword1" id="LLL_Complexity-reduce_basis_cost_expanded"><span class="command">lemma</span></span> reduce_basis_cost_expanded<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Lg</span> <span class="main">≥</span> nat <span class="main">⌈</span>log <span class="main">(</span>of_rat <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="free">α</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">+</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> N<span class="main">⌉</span>"</span></span>   
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cost <span class="main">(</span>reduce_basis_cost <span class="free">fs_init</span><span class="main">)</span>
  <span class="main">≤</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">Lg</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span>
    <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">Lg</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span>
    <span class="main">+</span> <span class="numeral">16</span> <span class="main">*</span> <span class="free">Lg</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span>
    <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">Lg</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span>
    <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span>
    <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span> 
    <span class="main">+</span> <span class="numeral">10</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span>
    <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">m</span> 
    <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">m</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cost</span> <span class="main">≤</span> <span class="var">?exp</span> <span class="free">Lg</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Log</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Log</span> <span class="main">=</span> nat <span class="main">⌈</span>log <span class="main">(</span>of_rat <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="free">α</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">+</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> N<span class="main">⌉</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> Lg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Log</span> <span class="main">≤</span> <span class="free">Lg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Log_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cost</span> <span class="main">≤</span> <span class="var">?exp</span> <span class="skolem">Log</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Log_def
    <span class="keyword1"><span class="command">using</span></span> reduce_basis_cost<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> num_loops_def body_cost_def initial_gso_cost_def base_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?exp</span> <span class="free">Lg</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono mult_mono Lg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Complexity-reduce_basis_cost_0"><span class="command">lemma</span></span> reduce_basis_cost_0<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cost <span class="main">(</span>reduce_basis_cost <span class="free">fs_init</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> len assms <span class="keyword1"><span class="command">have</span></span> fs_init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs_init</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> reduce_basis_cost_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cost_simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Complexity-reduce_basis_cost_N"><span class="command">lemma</span></span> reduce_basis_cost_N<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Lg</span> <span class="main">≥</span> nat <span class="main">⌈</span>log <span class="main">(</span>of_rat <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="free">α</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">+</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> N<span class="main">⌉</span>"</span></span>   
  <span class="keyword2"><span class="keyword">and</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Lg</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cost <span class="main">(</span>reduce_basis_cost <span class="free">fs_init</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">49</span> <span class="main">*</span> <span class="free">m</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">Lg</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> mn 0 <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">Lg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> reduce_basis_cost_expanded<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> <span class="free">Lg</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span> <span class="main">=</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">m</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">Lg</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power3_eq_cube<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> <span class="free">Lg</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">m</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">Lg</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 mn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power3_eq_cube<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">16</span> <span class="main">*</span> <span class="free">Lg</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">≤</span> <span class="numeral">16</span> <span class="main">*</span> <span class="free">m</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">Lg</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power3_eq_cube<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> <span class="free">Lg</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">*</span>  <span class="free">m</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">Lg</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power3_eq_cube<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span>  <span class="free">m</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">Lg</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power3_eq_cube<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">m</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">Lg</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power3_eq_cube<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">10</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">≤</span> <span class="numeral">10</span> <span class="main">*</span> <span class="free">m</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">Lg</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power3_eq_cube<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">m</span>  <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">Lg</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power3_eq_cube<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">*</span> <span class="free">m</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">m</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">Lg</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power3_eq_cube<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> reduce_basis_cost_0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Complexity-reduce_basis_cost_M"><span class="command">lemma</span></span> reduce_basis_cost_M<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Lg</span> <span class="main">≥</span> nat <span class="main">⌈</span>log <span class="main">(</span>of_rat <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="free">α</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">+</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">⌉</span>"</span></span>   
  <span class="keyword2"><span class="keyword">and</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Lg</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cost <span class="main">(</span>reduce_basis_cost <span class="free">fs_init</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">98</span> <span class="main">*</span> <span class="free">m</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">Lg</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?prod</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nat M <span class="main">*</span> nat M <span class="main">*</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nat M <span class="main">*</span> nat M <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> 0 True <span class="keyword1"><span class="command">have</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_inv_N_pos<span class="main">[</span><span class="operator">OF</span> LLL_inv_imp_w<span class="main"><span class="main">[</span></span><span class="operator">OF</span> LLL_inv_initial_state<span class="main"><span class="main">]</span></span> g_bound_fs_init m0<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> N0<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> N_le_MMn<span class="main">[</span><span class="operator">OF</span> m0<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> N_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">≤</span> <span class="var">?prod</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> N0 N_prod <span class="keyword1"><span class="command">have</span></span> M0<span class="main">:</span> <span class="quoted"><span class="quoted">"M <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"M <span class="main">≤</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> N0 N_prod <span class="keyword1"><span class="command">have</span></span> prod0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?prod</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">from</span></span> prod0 <span class="keyword1"><span class="command">have</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> n0 prod0 M0 <span class="keyword1"><span class="command">have</span></span> prod_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?prod</span> <span class="main">≤</span> <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> N_prod prod0 <span class="keyword1"><span class="command">have</span></span> N_p<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">≤</span> <span class="var">?p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?base</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of_rat <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="free">α</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">+</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="var">?base</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> α_gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Lg<span class="main">:</span> <span class="quoted"><span class="quoted">"nat <span class="main">⌈</span>log <span class="var">?base</span> N<span class="main">⌉</span> <span class="main">≤</span> nat <span class="main">⌈</span>log <span class="var">?base</span> <span class="var">?p</span><span class="main">⌉</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nat_mono ceiling_mono log_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> log_le_cancel_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> base<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">insert</span> M0 N_p N0 p0 n0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> of_int_mult of_nat_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="var">?base</span> <span class="var">?p</span> <span class="main">=</span> log <span class="var">?base</span> <span class="main">(</span><span class="var">?lg</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> M0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="var">?base</span> <span class="var">?lg</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_nat_power<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> M0 n0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌈</span>log <span class="var">?base</span> N<span class="main">⌉</span> <span class="main">≤</span> nat <span class="main">⌈</span><span class="numeral">2</span> <span class="main">*</span> log <span class="var">?base</span> <span class="var">?lg</span><span class="main">⌉</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">Lg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> Log<span class="main">:</span> <span class="quoted"><span class="quoted">"nat <span class="main">⌈</span>log <span class="var">?base</span> N<span class="main">⌉</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">Lg</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> 0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">Lg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> reduce_basis_cost_N<span class="main">[</span><span class="operator">OF</span> Log this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> reduce_basis_cost_0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
  
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* fixing arith_cost and assume α &gt; 4/3 *)</span>
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* LLL locale *)</span>
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* theory *)</span>
</pre>
</div><div id="LLL_Number_Bounds">
<div class="head">
<h1>Theory LLL_Number_Bounds</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Maximilian Haslbeck
                René Thiemann
    License:    BSD
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Explicit Bounds for Size of Numbers that Occur During LLL Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The LLL invariant does not contain bounds on the number that occur during the execution. 
  We here strengthen the invariant so that it enforces bounds on the norms of the $f_i$ and $g_i$
  and we prove that the stronger invariant is maintained throughout the execution of the LLL algorithm.

  Based on the stronger invariant we prove bounds on the absolute values of the $\mu_{i,j}$,
  and on the absolute values of the numbers in the vectors $f_i$ and $g_i$. 
  Moreover, we further show that also the denominators in all of these numbers doesn't grow to much.
  Finally, we prove that each number (i.e., numerator or denominator) during the execution 
  can be represented with at most ${\cal O}(m \cdot \log(M \cdot n))$ bits, where
  $m$ is the number of input vectors, $n$ is the dimension of the input vectors,
  and $M$ is the maximum absolute value of all numbers in the input vectors.
  Hence, each arithmetic operation in the LLL algorithm can be performed in polynomial time.›</span></span>
<span class="keyword1"><span class="command">theory</span></span> LLL_Number_Bounds
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#LLL">LLL</a>
    <a href="#Gram_Schmidt_Int">Gram_Schmidt_Int</a>
<span class="keyword2"><span class="keyword">begin</span></span>



<span class="keyword1"><span class="command">context</span></span> LLL
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The bounds for the $f_i$ distinguishes whether we are inside or outside the inner for-loop.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">f_bound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> nat <span class="main">⇒</span> int vec list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">f_bound</span> <span class="free"><span class="bound"><span class="entity">outside</span></span></span> <span class="free"><span class="bound"><span class="entity">ii</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">.</span> sq_norm <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">ii</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">outside</span></span></span> <span class="keyword1">then</span> int <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">else</span> 
     int <span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_bnd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> int vec list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">g_bnd</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">.</span> sq_norm <span class="main">(</span>gso <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ_bound_row</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">bnd</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> <span class="main">(</span>μ <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">j</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">bnd</span></span></span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ_bound_row_inner</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> μ_bound_row <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>  

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">LLL_bound_invariant</span> <span class="free"><span class="bound"><span class="entity">outside</span></span></span> <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span>
  <span class="main">(</span>LLL_invariant <span class="free"><span class="bound"><span class="entity">upw</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">∧</span> f_bound <span class="free"><span class="bound"><span class="entity">outside</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">∧</span> g_bound <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="LLL_Number_Bounds-bound_invD"><span class="command">lemma</span></span> bound_invD<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LLL_bound_invariant <span class="free">outside</span> <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"f_bound <span class="free">outside</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LLL_bound_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL_Number_Bounds-bound_invI"><span class="command">lemma</span></span> bound_invI<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"f_bound <span class="free">outside</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_bound_invariant <span class="free">outside</span> <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LLL_bound_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL_Number_Bounds-μ_bound_rowI"><span class="command">lemma</span></span> μ_bound_rowI<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="free">bnd</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"μ_bound_row <span class="free">fs</span> <span class="free">bnd</span> <span class="free">i</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> μ_bound_row_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL_Number_Bounds-μ_bound_rowD"><span class="command">lemma</span></span> μ_bound_rowD<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"μ_bound_row <span class="free">fs</span> <span class="free">bnd</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="free">bnd</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> μ_bound_row_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL_Number_Bounds-μ_bound_row_1"><span class="command">lemma</span></span> μ_bound_row_1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"μ_bound_row <span class="free">fs</span> <span class="free">bnd</span> <span class="free">i</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">bnd</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> gs1<span class="main">:</span> gram_schmidt_fs <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> μ_bound_rowD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gs1.μ.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-reduced_μ_bound_row"><span class="command">lemma</span></span> reduced_μ_bound_row<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> red<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced <span class="free">fs</span> <span class="free">i</span>"</span></span>  
  <span class="keyword2"><span class="keyword">and</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"μ_bound_row <span class="free">fs</span> <span class="main">1</span> <span class="free">ii</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> μ_bound_rowI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">ii</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> gs1<span class="main">:</span> gram_schmidt_fs <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ <span class="free">fs</span> <span class="free">ii</span> <span class="skolem">j</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">ii</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> red<span class="main">[</span><span class="operator">unfolded</span> gram_schmidt_fs.reduced_def<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> ii True<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>μ <span class="free">fs</span> <span class="free">ii</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> mult_mono<span class="main">[</span><span class="operator">OF</span> this this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gs1.μ.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-f_bound_True_arbitrary"><span class="command">lemma</span></span> f_bound_True_arbitrary<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"f_bound True <span class="free">ii</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"f_bound <span class="free">outside</span> <span class="free">j</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> f_bound_def 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_vec_ge_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> f_bound_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> less_le_trans<span class="main">[</span><span class="operator">OF</span> gt one<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> N0<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"N <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> one
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">1</span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> int <span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> of_nat_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> mult_ge_one<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> 1 N0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>  
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_nat_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> one 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> lin_indep<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_indep <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> fs<span class="main">:</span> fs_int_indpt <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">fs</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> lin_indep <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp</span><span class="main">)</span>


<span class="keyword1" id="LLL_Number_Bounds-sq_norm_fs_mu_g_bound"><span class="command">lemma</span></span> sq_norm_fs_mu_g_bound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> mu_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_bound_row <span class="free">fs</span> <span class="free">bnd</span> <span class="free">i</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> g_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> of_nat <span class="main">(</span>Suc <span class="free">i</span> <span class="main">*</span> N<span class="main">)</span> <span class="main">*</span> <span class="free">bnd</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">.</span> <span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="bound">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">∥</span>gso <span class="free">fs</span> <span class="bound">j</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fs.sq_norm_fs_via_sum_mu_gso<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms lin_indep len <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">←</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">.</span> <span class="free">bnd</span> <span class="main">*</span> of_nat N<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_ge_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> length_map length_upt<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> nth_map_upt<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> g_bound<span class="main">[</span><span class="operator">unfolded</span> g_bound_def<span class="main">]</span> i ji 
    <span class="keyword1"><span class="command">have</span></span> GB<span class="main">:</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> of_nat N"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> μ_bound_rowD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mu_bound ji<span class="main"><span class="main">]</span></span>
          GB order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> zero_le_power2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_nat <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">bnd</span> <span class="main">*</span> of_nat N<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_list_triv length_upt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_nat <span class="main">(</span>Suc <span class="free">i</span> <span class="main">*</span> N<span class="main">)</span> <span class="main">*</span> <span class="free">bnd</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_nat_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="LLL_Number_Bounds-increase_i_bound"><span class="command">lemma</span></span> increase_i_bound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> LLL<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> upw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">upw</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> red_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True True <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">fs</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> bound_invD<span class="main">[</span><span class="operator">OF</span> LLL<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> LLL<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"f_bound True <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> fbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"f_bound True <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_bound_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> increase_i<span class="main">[</span><span class="operator">OF</span> LLL i upw red_i<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"LLL_measure <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">fs</span> <span class="main">&lt;</span> LLL_measure <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True True <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">fs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bound_invI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv fbnd gbnd<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Addition step preserves <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"LLL_bound_invariant False"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="LLL_Number_Bounds-basis_reduction_add_row_main_bound"><span class="command">lemma</span></span> basis_reduction_add_row_main_bound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> Linv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_bound_invariant False True <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> round <span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> <span class="free">fs</span><span class="main">[</span> <span class="free">i</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="free">c</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="free">j</span><span class="main">]</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> mu_small<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_small_row <span class="free">i</span> <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> mu_bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_bound_row_inner <span class="free">fs</span> <span class="free">i</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_bound_invariant False True <span class="free">i</span> <span class="free">fs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"μ_bound_row_inner <span class="free">fs'</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bound_invI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> bound_invD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> Linv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"f_bound False <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> Linvw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> basis_reduction_add_row_main<span class="main">[</span><span class="operator">OF</span> Linvw i j fs'<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> main<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span> main<span class="main">(</span>3<span class="main">,</span>5-<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> main<span class="main">(</span>1<span class="main">)</span> main<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> c mu_small<span class="main">]</span> main<span class="main">(</span>3-<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> Linv'<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">i</span> <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bnd</span></span> <span class="main">::</span> <span class="quoted">rat</span> <span class="keyword2"><span class="keyword">where</span></span> bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bnd</span> <span class="main">=</span> <span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> Suc <span class="free">j</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> mu_bnd <span class="main">=</span> mu_bnd<span class="main">[</span><span class="operator">folded</span> bnd<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_invD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"μ <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"μ <span class="free">fs'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted">rat_of_int</span>

  <span class="comment1">(* (squared) mu bound will increase at most by factor 4 *)</span>
  <span class="keyword1"><span class="command">have</span></span> mu_bound_factor<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_bound_row <span class="free">fs'</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="skolem">bnd</span><span class="main">)</span> <span class="free">i</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> μ_bound_rowI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> ki<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> μ_bound_rowD<span class="main">[</span><span class="operator">OF</span> mu_bnd<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> bnd_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">(</span><span class="var">?mu</span> <span class="free">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">bnd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> bnd_ik<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?mu</span> <span class="free">i</span> <span class="skolem">k</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="skolem">bnd</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bnd_i<span class="main">[</span><span class="operator">OF</span> ki<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> bnd_ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?mu</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="skolem">bnd</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bnd_i<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> μ_bound_row_1<span class="main">[</span><span class="operator">OF</span> mu_bnd<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> bnd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bnd</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bnd</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?mu'</span> <span class="free">i</span> <span class="skolem">k</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">*</span> <span class="skolem">bnd</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="free">j</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> main<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">insert</span> True ki i bnd1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bnd_ik<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> kj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">j</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True 
        <span class="keyword1"><span class="command">have</span></span> small<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span><span class="var">?mu'</span> <span class="free">i</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> main<span class="main">(</span>2<span class="main">)</span> j <span class="keyword1"><span class="command">unfolding</span></span> True μ_small_row_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mult_mono<span class="main">[</span><span class="operator">OF</span> small small<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> bnd1 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> kj <span class="keyword1"><span class="command">have</span></span> k_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> max <span class="main">(</span>abs <span class="main">(</span><span class="var">?mu</span> <span class="free">i</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>abs <span class="main">(</span><span class="var">?mu</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">have</span></span> M0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?new_mu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?mu</span> <span class="free">i</span> <span class="skolem">k</span> <span class="main">-</span> <span class="var">?R</span> <span class="free">c</span> <span class="main">*</span> <span class="var">?mu</span> <span class="free">j</span> <span class="skolem">k</span>"</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="var">?new_mu</span> <span class="main">≤</span> abs <span class="main">(</span><span class="var">?mu</span> <span class="free">i</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> abs <span class="main">(</span><span class="var">?R</span> <span class="free">c</span> <span class="main">*</span> <span class="var">?mu</span> <span class="free">j</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> abs <span class="main">(</span><span class="var">?mu</span> <span class="free">i</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> abs <span class="main">(</span><span class="var">?R</span> <span class="free">c</span><span class="main">)</span> <span class="main">*</span> abs <span class="main">(</span><span class="var">?mu</span> <span class="free">j</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> abs_mult <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> abs <span class="main">(</span><span class="var">?mu</span> <span class="free">i</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>abs <span class="main">(</span><span class="var">?mu</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> add_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mult_mono<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> c<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?R</span> <span class="main">(</span>round <span class="main">(</span><span class="var">?mu</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="var">?mu</span> <span class="free">i</span> <span class="free">j</span><span class="main">¦</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> round_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">from</span></span> inv<span class="main">(</span>10<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> gram_schmidt_fs.reduced_def<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> k_j<span class="main">]</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?mu</span> <span class="free">j</span> <span class="skolem">k</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">M</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">+</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ mult_right_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> add_mono<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="var">?new_mu</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?mu'</span> <span class="free">i</span> <span class="skolem">k</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="var">?new_mu</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> main<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> kj False i j<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">M</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> abs_le_square_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> le M0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">4</span> <span class="main">*</span> <span class="skolem">M</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">*</span> <span class="skolem">bnd</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main">)</span>            
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">bnd</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bnd_ij bnd_ik bnd1 <span class="keyword1"><span class="command">unfolding</span></span> M_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def power2_eq_square<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> <span class="skolem">bnd</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bnd 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> Suc <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_bound_row_inner <span class="free">fs'</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> gbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gbnd <span class="keyword1"><span class="command">unfolding</span></span> g_bound_def
    <span class="keyword1"><span class="command">using</span></span> main<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">note</span></span> inv' <span class="main">=</span> LLL_invD<span class="main">[</span><span class="operator">OF</span> Linv'<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"f_bound False <span class="free">i</span> <span class="free">fs'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_bound_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">jj</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> 1 fbnd<span class="main">[</span><span class="operator">unfolded</span> f_bound_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">jj</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs' <span class="keyword1"><span class="command">using</span></span> False 1 inv<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True        
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">∥</span><span class="free">fs'</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">∥</span>RAT <span class="free">fs'</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i inv' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sq_norm_of_int<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> rat_of_nat <span class="main">(</span>Suc <span class="free">i</span> <span class="main">*</span> N<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> sq_norm_fs_mu_g_bound<span class="main">[</span><span class="operator">OF</span> inv'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">)</span></span> i bnd gbnd<span class="main">]</span> i inv'
        <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_of_int<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> rat_of_int <span class="main">(</span> int <span class="main">(</span>Suc <span class="free">i</span> <span class="main">*</span> N<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">fs'</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> int <span class="main">(</span>Suc <span class="free">i</span> <span class="main">*</span> N<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>int N <span class="main">^</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> int <span class="free">m</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> of_nat_mult <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> int N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> int <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i j <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> int <span class="free">m</span> <span class="main">*</span> <span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> int N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> int <span class="free">m</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mult_right_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mult_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ pow_mono_exp<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">fs'</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> int <span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_nat_mult <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> LLL_with_assms
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> LLL_bound_invariant<span class="antiquote"><span class="antiquote">}</span></span></span></span> is maintained during execution of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> reduce_basis<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="LLL_Number_Bounds-basis_reduction_add_rows_enter_bound"><span class="command">lemma</span></span> basis_reduction_add_rows_enter_bound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> binv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True True <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>   
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_bound_invariant False True <span class="free">i</span> <span class="free">fs</span>"</span></span>
  <span class="quoted"><span class="quoted">"μ_bound_row_inner <span class="free">fs</span> <span class="free">i</span> <span class="free">i</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bound_invI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> bound_invD<span class="main">[</span><span class="operator">OF</span> binv<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> Linv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> fbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"f_bound True <span class="free">i</span> <span class="free">fs</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> gbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> Linvw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">interpret</span></span> fs<span class="main">:</span> fs_int' <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">fs_init</span></span> <span class="quoted"><span class="free">fs</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> Linvw <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_invD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> fbndF<span class="main">:</span> <span class="quoted"><span class="quoted">"f_bound False <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_bound_True_arbitrary<span class="main">[</span><span class="operator">OF</span> fbnd<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> N0<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LLL_inv_N_pos<span class="main">[</span><span class="operator">OF</span> Linvw gbnd<span class="main">]</span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> gs.Gramian_determinant <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">*</span> <span class="main">∥</span>RAT <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ji i inv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fs.gs.mu_bound_Gramian_determinant<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.Gramian_determinant <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">=</span> of_int <span class="main">(</span>d <span class="free">fs</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fs.of_int_Gramian_determinant<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ji i inv<span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>RAT <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> of_int <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i inv<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sq_norm_of_int<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span>d <span class="free">fs</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">…</span> <span class="main">≤</span> rat_of_nat <span class="main">(</span>N<span class="main">^</span><span class="skolem">j</span><span class="main">)</span> <span class="main">*</span> of_int <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ji i d_approx<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Linvw gbnd<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">j</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> rat_of_nat <span class="main">(</span>N<span class="main">^</span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> of_int <span class="main">(</span>int <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> of_nat_le_iff of_int_le_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> pow_mono_exp<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">insert</span> fbnd<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> f_bound_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> N0 ji i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> rat_of_nat <span class="main">(</span>N<span class="main">^</span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> N <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"N<span class="main">^</span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> N <span class="main">=</span> N<span class="main">^</span><span class="main">(</span>Suc <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ji i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> of_nat <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> mu_bound <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> mu_bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_bound_row_inner <span class="free">fs</span> <span class="free">i</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> μ_bound_rowI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> of_nat <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> mu_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> j <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True fs.gs.μ.simps <span class="keyword1"><span class="command">using</span></span> i N0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-basis_basis_reduction_add_rows_loop_leave"><span class="command">lemma</span></span> basis_basis_reduction_add_rows_loop_leave<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> binv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_bound_invariant False True <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> mu_small<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_small_row <span class="free">i</span> <span class="free">fs</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mu_bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_bound_row_inner <span class="free">fs</span> <span class="free">i</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True False <span class="free">i</span> <span class="free">fs</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> Linv <span class="main">=</span> bound_invD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> binv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> mu_small <span class="keyword1"><span class="command">have</span></span> mu_small<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_small <span class="free">fs</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> μ_small_row_def μ_small_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_invD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">interpret</span></span> gs1<span class="main">:</span> gram_schmidt_fs_int <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> inv gs.lin_indpt_list_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> vec_hom_Ints›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> fbnd <span class="main">=</span> bound_invD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> binv<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> gbnd <span class="main">=</span> bound_invD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> binv<span class="main">]</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ii</span>
    <span class="keyword3"><span class="command">assume</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">ii</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ii fbnd<span class="main">[</span><span class="operator">unfolded</span> f_bound_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> row<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_bound_row <span class="free">fs</span> <span class="main">1</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> μ_bound_rowI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
        <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> mu_small<span class="main">[</span><span class="operator">unfolded</span> μ_small_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">unfolding</span></span> μ_small_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gs1.μ.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> mult_mono<span class="main">[</span><span class="operator">OF</span> this this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> rat_of_int <span class="main">(</span>int <span class="main">(</span>Suc <span class="free">i</span> <span class="main">*</span> N<span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> sq_norm_fs_mu_g_bound<span class="main">[</span><span class="operator">OF</span> inv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">)</span></span> i row gbnd<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> int <span class="main">(</span>Suc <span class="free">i</span> <span class="main">*</span> N<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int N <span class="main">*</span> int <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_nat_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> int N <span class="main">*</span> int <span class="free">m</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> f_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"f_bound True <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_bound_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> binv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> basis_reduction_add_row_done<span class="main">[</span><span class="operator">OF</span> Linv i assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LLL_bound_invariant_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="LLL_Number_Bounds-basis_reduction_add_rows_loop_bound"><span class="command">lemma</span></span> basis_reduction_add_rows_loop_bound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>
  binv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_bound_invariant False True <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> mu_small<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_small_row <span class="free">i</span> <span class="free">fs</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mu_bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"μ_bound_row_inner <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_add_rows_loop <span class="free">i</span> <span class="free">fs</span> <span class="free">j</span> <span class="main">=</span> <span class="free">fs'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True False <span class="free">i</span> <span class="free">fs'</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">fs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0 <span class="skolem">fs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> binv <span class="main">=</span> 0<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> basis_basis_reduction_add_rows_loop_leave<span class="main">[</span><span class="operator">OF</span> 0<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> i<span class="main">]</span> 0<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span> <span class="skolem">fs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> binv <span class="main">=</span> Suc<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> Linv <span class="main">=</span> bound_invD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> binv<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> Linvw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"round <span class="main">(</span>μ <span class="skolem">fs</span> <span class="free">i</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> basis_reduction_add_row_main_bound<span class="main">[</span><span class="operator">OF</span> Suc<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> i j refl refl Suc<span class="main"><span class="main"><span class="main">(</span></span></span>3-4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> step' <span class="main">=</span> basis_reduction_add_row_main<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Linvw i j refl<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> step' <span class="main">=</span> step'<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span> step'<span class="main">(</span>2-<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_invD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> inv<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> inv<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> i j
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="main">0</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">fs</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> inv i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> step step' id True Suc<span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> step'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> step<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> Suc<span class="main">(</span>2-<span class="main">)</span> False step'<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-basis_reduction_add_rows_bound"><span class="command">lemma</span></span> basis_reduction_add_rows_bound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 
  binv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_add_rows <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="free">fs'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True False <span class="free">i</span> <span class="free">fs'</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> def <span class="main">=</span> basis_reduction_add_rows_def
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">upw</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> res binv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> binv <span class="keyword1"><span class="command">have</span></span> binv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True True <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> start <span class="main">=</span> basis_reduction_add_rows_enter_bound<span class="main">[</span><span class="operator">OF</span> this i<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> def<span class="main">]</span> True 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"basis_reduction_add_rows_loop <span class="free">i</span> <span class="free">fs</span> <span class="free">i</span> <span class="main">=</span> <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> basis_reduction_add_rows_loop_bound<span class="main">[</span><span class="operator">OF</span> start<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> μ_small_row_refl start<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this i le_refl<span class="main">]</span>      
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-g_bnd_swap"><span class="command">lemma</span></span> g_bnd_swap<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Linv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant_weak <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mu_F1_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">α</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> fs'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> <span class="free">fs</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> g_bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bnd <span class="free">B</span> <span class="free">fs</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"g_bnd <span class="free">B</span> <span class="free">fs'</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">∨</span> <span class="free">fs'</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∨</span> <span class="free">fs'</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">using</span></span> i inv<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> gso <span class="free">fs</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> gso <span class="free">fs'</span> <span class="bound">i</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> sq_norm <span class="main">(</span><span class="var">?g1</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> sq_norm <span class="main">(</span><span class="var">?g2</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> g_bnd<span class="main">[</span><span class="operator">unfolded</span> g_bnd_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> short<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="var">?n1</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> short<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> i 
  <span class="keyword1"><span class="command">have</span></span> short_im1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> swap <span class="main">=</span> basis_reduction_swap_main<span class="main">[</span><span class="operator">OF</span> Linv disjI2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span></span></span></span> mu_F1_i<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span></span></span> i cond fs'_def<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> updates <span class="main">=</span> swap<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> Linv' <span class="main">=</span> swap<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> inv' <span class="main">=</span> LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> Linv'<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_inv_wD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span>
  <span class="keyword1"><span class="command">interpret</span></span> gs1<span class="main">:</span> gram_schmidt_fs_int <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> inv gs.lin_indpt_list_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> vec_hom_Ints›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> gs2<span class="main">:</span> gram_schmidt_fs_int <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"RAT <span class="free">fs'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> inv' gs.lin_indpt_list_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> vec_hom_Ints›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"μ <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"μ <span class="free">fs'</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?mu1</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="var">?mu</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mu_F1_i <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?n1</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?mu</span> <span class="main">*</span> <span class="var">?mu</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> updates<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inverse <span class="free">α</span> <span class="main">*</span> <span class="main">(</span><span class="free">α</span> <span class="main">*</span> <span class="var">?n1</span> <span class="free">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="var">?mu</span> <span class="main">*</span> <span class="var">?mu</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> α <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> inverse <span class="free">α</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>abs <span class="var">?mu</span> <span class="main">*</span> abs <span class="var">?mu</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mult_left_mono<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> cond α<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>inverse <span class="free">α</span> <span class="main">+</span> abs <span class="var">?mu</span> <span class="main">*</span> abs <span class="var">?mu</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span>inverse <span class="free">α</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> add_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mult_mono<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> mu<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>  
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inverse <span class="free">α</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> reduction"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> reduction_def <span class="keyword1"><span class="command">using</span></span> α0 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reduction<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> n2im1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"g_bnd <span class="free">B</span> <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_bnd_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> 
    <span class="keyword3"><span class="command">assume</span></span> km<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>ki<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="main">|</span> <span class="main">(</span>im1<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="main">(</span>other<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="free">i</span><span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n2</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> other
      <span class="keyword1"><span class="command">from</span></span> short<span class="main">[</span><span class="operator">OF</span> km<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?n2</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> km other
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> updates<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> im1
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n2</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?n2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> im1 <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> short_im1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> ki
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n2</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?n2</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ki <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> RAT <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> RAT <span class="free">fs'</span> <span class="main">!</span> <span class="bound">i</span>"</span></span> 
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> gs.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="var">?mu1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">j</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?g1</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> 
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">=</span> <span class="var">?f1</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="var">?f1</span> <span class="free">i</span><span class="main">}</span>"</span></span> 
        <span class="keyword1"><span class="command">have</span></span> g2i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g2</span> <span class="free">i</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> i inv' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> Rn"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">using</span></span> inv i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> uU<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> gs.span <span class="skolem">U</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> im1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> G1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">⊆</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="main">(</span>5<span class="main">)</span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> gs.span <span class="main">(</span><span class="var">?g1</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u_def 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.sumlist_in_span<span class="main"><span class="main">[</span></span><span class="operator">OF</span> G1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> set_map<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> G1<span class="main"><span class="keyword3">,</span></span>
              <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gs.smult_in_span <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gs.span_mem<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.span <span class="main">(</span><span class="var">?g1</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> gs.span <span class="main">(</span><span class="var">?f1</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> gs1.partial_span<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> im1 inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> gs.lin_indpt_list_def<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">gs.span</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> nth_image<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> i inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> gs.span <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> U_def 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.span_is_monotone<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> im1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> uU U <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> id_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">+</span> <span class="main">(</span><span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?g2</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">+</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?g2</span> <span class="free">i</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> u g2i inv<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> im1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> list_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span>"</span></span> 
          <span class="quoted"><span class="quoted">"map <span class="skolem">f</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.is_oc_projection <span class="main">(</span>gs2.gso <span class="free">i</span><span class="main">)</span> <span class="main">(</span>gs.span <span class="main">(</span>gs2.gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> i inv' <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> gs2.gso_oc_projection_span<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.is_oc_projection <span class="main">(</span><span class="var">?g2</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>gs.span <span class="main">(</span>gs2.gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span><span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> fs'_def <span class="keyword1"><span class="command">using</span></span> inv<span class="main">(</span>6<span class="main">)</span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">+</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> "</span></span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> gs1.fi_is_sum_of_mu_gso<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> im1 inv<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> gs.lin_indpt_list_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> list_id map_append u_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gs.M.sumlist_snoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gs1.μ.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inv<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.span <span class="main">(</span>gs2.gso <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> gs.span <span class="main">(</span>set <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> inv' <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gs2.partial_span<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span>RAT <span class="free">fs'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f2</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv'<span class="main">(</span>6<span class="main">)</span> i 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nth_image<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f2</span> <span class="main">`</span> <span class="main">…</span> <span class="main">=</span> <span class="var">?f2</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="var">?f2</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> U_def fs'_def 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(∪)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i inv<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.is_oc_projection <span class="main">(</span><span class="var">?g2</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>gs.span <span class="skolem">U</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">+</span> <span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>        
        <span class="keyword1"><span class="command">hence</span></span> proj<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.is_oc_projection <span class="main">(</span><span class="var">?g2</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>gs.span <span class="skolem">U</span><span class="main">)</span> <span class="main">(</span><span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> gs.is_oc_projection_def <span class="keyword1"><span class="command">using</span></span> gs.span_add<span class="main">[</span><span class="operator">OF</span> U uU<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?g2</span> <span class="free">i</span>"</span></span><span class="main">]</span> 
          inv<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> im1<span class="main">]</span> g2i u id_u <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> U<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> gs.is_oc_projection_sq_norm<span class="main">[</span><span class="operator">OF</span> this gs.span_is_subset2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> U<span class="main"><span class="main">]</span></span>  inv<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> im1<span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n2</span> <span class="free">i</span> <span class="main">≤</span> <span class="var">?n1</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="LLL_Number_Bounds-basis_reduction_swap_bound"><span class="command">lemma</span></span> basis_reduction_swap_bound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 
  binv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True False <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_swap <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="main">(</span><span class="free">upw'</span><span class="main">,</span><span class="free">i'</span><span class="main">,</span><span class="free">fs'</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">α</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True <span class="free">upw'</span> <span class="free">i'</span> <span class="free">fs'</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bound_invI<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> Linv <span class="main">=</span> bound_invD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> binv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> basis_reduction_swap<span class="main">[</span><span class="operator">OF</span> Linv res cond i<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> Linv'<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw'</span> <span class="free">i'</span> <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> basis_reduction_swap_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">=</span> <span class="free">fs</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_invD<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span> i
  <span class="keyword1"><span class="command">have</span></span> choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs'</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">∨</span> <span class="free">fs'</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∨</span> <span class="free">fs'</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> bound_invD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> binv<span class="main">]</span> i 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"f_bound True <span class="free">i'</span> <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id<span class="main">(</span>1<span class="main">)</span> f_bound_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> choice<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> bound_invD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> binv<span class="main">,</span> <span class="operator">unfolded</span> g_bound_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> gbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bnd <span class="main">(</span>of_nat N<span class="main">)</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_bnd_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> LLL_invD<span class="main">(</span>11<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Linv<span class="main">,</span> <span class="operator">unfolded</span> μ_small_def<span class="main">]</span> i 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> g_bnd_swap<span class="main">[</span><span class="operator">OF</span> i LLL_inv_imp_w<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Linv<span class="main"><span class="main">]</span></span> this cond id<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gbnd<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"g_bnd <span class="main">(</span>rat_of_nat N<span class="main">)</span> <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_bnd_def g_bound_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-basis_reduction_step_bound"><span class="command">lemma</span></span> basis_reduction_step_bound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 
  binv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_step <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="main">(</span><span class="free">upw'</span><span class="main">,</span><span class="free">i'</span><span class="main">,</span><span class="free">fs'</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True <span class="free">upw'</span> <span class="free">i'</span> <span class="free">fs'</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> def <span class="main">=</span> basis_reduction_step_def
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> fs''<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_add_rows <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="skolem">fs''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> increase_i_bound<span class="main">[</span><span class="operator">OF</span> binv i True<span class="main">]</span> res True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> def id if_False fs'' Let_def<span class="main">]</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>gso <span class="skolem">fs''</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">*</span> sq_norm <span class="main">(</span>gso <span class="skolem">fs''</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> basis_reduction_add_rows_bound<span class="main">[</span><span class="operator">OF</span> binv fs'' i<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> binv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True False <span class="free">i</span> <span class="skolem">fs''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">≤</span> <span class="var">?y</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> increase_i_bound<span class="main">[</span><span class="operator">OF</span> binv i _ True<span class="main">]</span> True res
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt<span class="main">:</span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">&gt;</span> <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> basis_reduction_swap_bound<span class="main">[</span><span class="operator">OF</span> binv _ this i False<span class="main">]</span> gt res
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-basis_reduction_main_bound"><span class="command">lemma</span></span> basis_reduction_main_bound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True <span class="free">upw</span> <span class="free">i</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_main <span class="main">(</span><span class="free">upw</span><span class="main">,</span><span class="free">i</span><span class="main">,</span><span class="free">fs</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs'</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True True <span class="free">m</span> <span class="free">fs'</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"LLL_measure <span class="free">i</span> <span class="free">fs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="free">upw</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">i</span> <span class="skolem">fs</span> <span class="skolem">upw</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True <span class="skolem">upw</span> <span class="skolem">i</span> <span class="skolem">fs</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> less<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> basis_reduction_main.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">upw</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">fs</span></span><span class="main"><span class="main">]</span></span> id<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> less<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> less<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> Linv <span class="main">=</span> bound_invD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> i<span class="main">:</span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">fs'</span></span> <span class="skolem"><span class="skolem">upw'</span></span> <span class="keyword2"><span class="keyword">where</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"basis_reduction_step <span class="skolem">upw</span> <span class="skolem">i</span> <span class="skolem">fs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">upw'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">,</span><span class="skolem">fs'</span><span class="main">)</span>"</span></span> 
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?step</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?step</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> decrease <span class="main">=</span> basis_reduction_step<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Linv step i<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> decrease basis_reduction_step_bound<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv step i<span class="main"><span class="main">]</span></span><span class="main">]</span> res<span class="main">[</span><span class="operator">unfolded</span> step<span class="main">]</span> i Linv
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> LLL_invD<span class="main">[</span><span class="operator">OF</span> Linv<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> False res inv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True <span class="skolem">upw</span> <span class="free">m</span> <span class="free">fs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LLL_invariant_def LLL_bound_invariant_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-LLL_inv_initial_state_bound"><span class="command">lemma</span></span> LLL_inv_initial_state_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True True <span class="main">0</span> <span class="free">fs_init</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bound_invI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> LLL_inv_initial_state _ g_bound_fs_init<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>nat <span class="keyword1">o</span> sq_norm<span class="main">)</span> <span class="free">fs_init</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted">rat_of_int</span>
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span>sq_norm <span class="main">(</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fs_init len <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> mem_set_imp_le_max_list<span class="main">[</span><span class="operator">OF</span> _ mem<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> FN<span class="main">:</span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span>sq_norm <span class="main">(</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> N"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> N_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> int N"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> f_bnd<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"f_bound True <span class="main">0</span> <span class="free">fs_init</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_bound_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-reduce_basis_bound"><span class="command">lemma</span></span> reduce_basis_bound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"reduce_basis <span class="main">=</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_bound_invariant True True <span class="free">m</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> basis_reduction_main_bound<span class="main">[</span><span class="operator">OF</span> LLL_inv_initial_state_bound res<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> reduce_basis_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Bound extracted from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">LLL_bound_invariant</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">f_bnd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f_bnd</span> False <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">f_bnd</span> True <span class="main">=</span> N <span class="main">*</span> <span class="free">m</span>"</span></span> 

<span class="keyword1" id="LLL_Number_Bounds-f_bnd_mono"><span class="command">lemma</span></span> f_bnd_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"f_bnd <span class="free">outside</span> <span class="main">≤</span> f_bnd False"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">outside</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> out<span class="main">:</span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"N <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> out <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?num</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> 0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span> "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> out <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="LLL_Number_Bounds-aux_bnd_mono"><span class="command">lemma</span></span> aux_bnd_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">*</span> <span class="free">m</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"N <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?num</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> 0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"N <span class="main">*</span> <span class="free">m</span> <span class="main">≤</span> <span class="var">?num</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">outside</span> <span class="free">upw</span> <span class="free">k</span> <span class="free">fs</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> binv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_bound_invariant <span class="free">outside</span> <span class="free">upw</span> <span class="free">k</span> <span class="free">fs</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="LLL_Number_Bounds-LLL_f_bnd"><span class="command">lemma</span></span> LLL_f_bnd<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">¦</span> <span class="main">≤</span> f_bnd <span class="free">outside</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> bound_invD<span class="main">[</span><span class="operator">OF</span> binv<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">k</span> <span class="free">fs</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> fbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"f_bound <span class="free">outside</span> <span class="free">k</span> <span class="free">fs</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> gbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> invw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_inv_N_pos<span class="main">[</span><span class="operator">OF</span> invw gbnd<span class="main">]</span> i <span class="keyword1"><span class="command">have</span></span> N0<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> inv <span class="main">=</span> LLL_invD<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span> 
  <span class="keyword1"><span class="command">from</span></span> inv i <span class="keyword1"><span class="command">have</span></span> fsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">¦</span><span class="main">^</span><span class="main">1</span> <span class="main">≤</span> <span class="main">¦</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">¦</span><span class="main">^</span><span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> pow_mono_exp<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?num</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sq_bnd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="free">i</span> <span class="main">≠</span> <span class="free">k</span> <span class="main">∨</span> <span class="free">outside</span> <span class="keyword1">then</span> int <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">else</span> int <span class="var">?num</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">¦</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">∥</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fsi j <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vec_le_sq_norm<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?sq_bnd</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fbnd<span class="main">[</span><span class="operator">unfolded</span> f_bound_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> i<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> two<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="var">?sq_bnd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">outside</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> one two <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?num2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> four<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">4</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> int <span class="main">(</span>max <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="var">?num</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> two<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_nat_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span>N <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="var">?num</span> <span class="main">=</span> <span class="var">?num</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aux_bnd_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="var">?num</span> <span class="main">=</span> int <span class="var">?num</span> <span class="main">*</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> int <span class="var">?num</span> <span class="main">*</span> N <span class="main">^</span> <span class="free">m</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> N0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span><span class="var">?num</span> <span class="main">*</span> N <span class="main">^</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?num</span> <span class="main">*</span> N <span class="main">^</span> <span class="free">m</span> <span class="main">=</span> <span class="var">?num2</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square four power_mult_distrib
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">…</span> <span class="main">=</span> <span class="main">(</span>int <span class="var">?num2</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">(</span>int <span class="main">(</span>f_bnd <span class="free">outside</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> abs_le_square_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-LLL_gso_bound"><span class="command">lemma</span></span> LLL_gso_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> quot<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">num</span><span class="main">,</span> <span class="free">denom</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">num</span><span class="main">¦</span>   <span class="main">≤</span> N <span class="main">^</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">denom</span><span class="main">¦</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> bound_invD<span class="main">[</span><span class="operator">OF</span> binv<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">k</span> <span class="free">fs</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> gbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> invw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> LLL_invD<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword1"><span class="command">interpret</span></span> fs<span class="main">:</span> fs_int' <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">fs_init</span></span> <span class="quoted"><span class="free">fs</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> invw <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> d_approx<span class="main">[</span><span class="operator">OF</span> invw gbnd i<span class="main">,</span> <span class="operator">unfolded</span> d_def<span class="main">]</span>  
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int"</span></span>
  <span class="keyword1"><span class="command">have</span></span> int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gs.Gramian_determinant <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="free">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int_hom.vec_hom <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword1"><span class="command">using</span></span> that assms * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> vec_hom_Ints<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> * gs.gso_connect snd_gram_schmidt_int assms <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fs.gs.d_gso_Ints<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> gsi<span class="main">:</span> <span class="quoted"><span class="quoted">"gso <span class="free">fs</span> <span class="free">i</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> gs_sq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span><span class="main">¦</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> rat_of_nat N"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> vec_le_sq_norm<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">use</span> gsi assms gbnd * LLL.g_bound_def <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> N0<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> less_le_trans<span class="main">[</span><span class="operator">OF</span> LLL_D_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> invw<span class="main"><span class="main">]</span></span> D_approx<span class="main"><span class="main">[</span></span><span class="operator">OF</span> invw gbnd<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> max <span class="main">1</span> <span class="main">¦</span><span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span>max <span class="main">1</span> <span class="main">¦</span>gso <span class="free">fs</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">¦</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> self_le_power<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> of_nat N"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gs_sq N0 <span class="keyword1"><span class="command">unfolding</span></span> max_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> gs_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> of_nat N"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.Gramian_determinant <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> rat_of_int <span class="main">(</span>gs.Gramian_determinant <span class="free">fs</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  assms *<span class="main">(</span>4-6<span class="main">)</span> carrier_vecD nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fs.of_int_Gramian_determinant<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> int <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_int <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_int <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> gso <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span> <span class="main">=</span> of_int <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>gso <span class="free">fs</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gsi i j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> gso <span class="free">fs</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> num<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">¦</span><span class="free">num</span><span class="main">¦</span> <span class="main">≤</span> of_int <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span> <span class="main">*</span> int N<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> denom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">denom</span> <span class="main">≤</span> d <span class="free">fs</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> quotient_of_bounds<span class="main">[</span><span class="operator">OF</span> quot l LLL_d_pos<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">OF</span></span> invw<span class="main"><span class="main"><span class="main">]</span></span></span> gs_bound<span class="main">]</span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> num <span class="keyword1"><span class="command">have</span></span> num<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">num</span><span class="main">¦</span> <span class="main">≤</span> d <span class="free">fs</span> <span class="free">i</span> <span class="main">*</span> int N"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">from</span></span> d_approx<span class="main">[</span><span class="operator">OF</span> invw gbnd i<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"d <span class="free">fs</span> <span class="free">i</span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">^</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">from</span></span> denom d <span class="keyword1"><span class="command">have</span></span> denom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">denom</span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">^</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> num <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="free">fs</span> <span class="free">i</span> <span class="main">*</span> int N <span class="main">≤</span> int <span class="main">(</span>N <span class="main">^</span> <span class="free">i</span><span class="main">)</span> <span class="main">*</span> int N"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> d<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> num<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">num</span><span class="main">¦</span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">jj</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> pow_mono_exp<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">N</span><span class="main">]</span> N0
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"N<span class="main">^</span><span class="skolem">jj</span> <span class="main">≤</span> N<span class="main">^</span><span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>N<span class="main">^</span><span class="skolem">jj</span><span class="main">)</span> <span class="main">≤</span> int <span class="main">(</span>N<span class="main">^</span><span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> j_m <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">denom</span><span class="main">¦</span> <span class="main">=</span> <span class="free">denom</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> quotient_of_denom_pos<span class="main">[</span><span class="operator">OF</span> quot<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">^</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">^</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> j_m<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">denom</span><span class="main">¦</span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">^</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">num</span><span class="main">¦</span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">^</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j_m<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">]</span> num <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-LLL_f_bound"><span class="command">lemma</span></span> LLL_f_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">¦</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">¦</span> <span class="main">≤</span> int <span class="main">(</span>f_bnd <span class="free">outside</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LLL_f_bnd<span class="main">[</span><span class="operator">OF</span> i j<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> int <span class="main">(</span>f_bnd False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_bnd_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">outside</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span>N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-LLL_d_bound"><span class="command">lemma</span></span> LLL_d_bound<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>   
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">i</span> <span class="main">∧</span> abs <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">m</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> id <span class="keyword1"><span class="command">unfolding</span></span> gs.Gramian_determinant_0 d_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> m<span class="main">:</span> False  
  <span class="keyword1"><span class="command">from</span></span> bound_invD<span class="main">[</span><span class="operator">OF</span> binv<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">k</span> <span class="free">fs</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> gbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> invw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_inv_N_pos<span class="main">[</span><span class="operator">OF</span> invw gbnd<span class="main">]</span> m <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted">rat_of_int</span> 
  <span class="keyword1"><span class="command">from</span></span> d_approx_main<span class="main">[</span><span class="operator">OF</span> invw gbnd i m<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>d <span class="free">fs</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> of_nat <span class="main">(</span>N <span class="main">^</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> one<span class="main">:</span> <span class="quoted"><span class="quoted">"d <span class="free">fs</span> <span class="free">i</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_nat_le_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pow_mono_exp<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> N i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"d <span class="free">fs</span> <span class="free">i</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> LLL_d_pos<span class="main">[</span><span class="operator">OF</span> invw i<span class="main">]</span> one
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-LLL_mu_abs_bound"><span class="command">lemma</span></span> LLL_mu_abs_bound<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span><span class="main">¦</span> <span class="main">≤</span> rat_of_nat <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> bound_invD<span class="main">[</span><span class="operator">OF</span> binv<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">k</span> <span class="free">fs</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> fbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"f_bound <span class="free">outside</span> <span class="free">k</span> <span class="free">fs</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> gbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> invw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_inv_N_pos<span class="main">[</span><span class="operator">OF</span> invw gbnd<span class="main">]</span> i <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> LLL_invD<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword1"><span class="command">interpret</span></span> fs<span class="main">:</span> fs_int' <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">fs_init</span></span> <span class="quoted"><span class="free">fs</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> invw <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"μ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> j i <span class="keyword1"><span class="command">have</span></span> jm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> d_approx<span class="main">[</span><span class="operator">OF</span> invw gbnd jm<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> dj<span class="main">:</span> <span class="quoted"><span class="quoted">"d <span class="free">fs</span> <span class="free">j</span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">^</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?num</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bnd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"N<span class="main">^</span><span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> fbnd<span class="main">[</span><span class="operator">unfolded</span> f_bound_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> i<span class="main">]</span>
    aux_bnd_mono<span class="main">[</span><span class="operator">folded</span> of_nat_le_iff<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">int</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> sq_f_bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> int <span class="var">?num</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> four<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">4</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span>gs.Gramian_determinant <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> sq_norm <span class="main">(</span>RAT <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"of_int_hom.vec_hom <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">fs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> * that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vec_hom_Ints<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fs.gs.mu_bound_Gramian_determinant<span class="main"><span class="main">[</span></span><span class="operator">OF</span> j<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> * j i<span class="main"><span class="keyword3">,</span></span> 
          <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth gs.lin_indpt_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">(</span>RAT <span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> of_int <span class="main">(</span>sq_norm <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_of_int<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>6<span class="main">)</span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gs.Gramian_determinant <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> of_int <span class="main">(</span>d <span class="free">fs</span> <span class="free">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fs.of_int_Gramian_determinant<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i j *<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">*</span> of_int <span class="main">(</span>sq_norm <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> of_int <span class="main">(</span>d <span class="free">fs</span> <span class="free">j</span> <span class="main">*</span> sq_norm <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> of_int <span class="main">(</span>int <span class="main">(</span>N<span class="main">^</span><span class="free">j</span><span class="main">)</span> <span class="main">*</span> int <span class="var">?num</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_int_le_iff 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dj sq_f_bnd<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_nat <span class="main">(</span>N<span class="main">^</span><span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> of_nat <span class="main">(</span>N<span class="main">^</span><span class="main">(</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_nat_le_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pow_mono_exp<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> N j i jm<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_nat <span class="main">(</span><span class="var">?bnd</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> four power_mult_distrib power2_eq_square of_nat_mult <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span>of_nat <span class="var">?bnd</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">folded</span> abs_le_square_iff<span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"abs <span class="var">?mu</span> <span class="main">≤</span> of_nat <span class="var">?bnd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1" id="LLL_Number_Bounds-LLL_dμ_bound"><span class="command">lemma</span></span> LLL_dμ_bound<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>  
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>dμ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> bound_invD<span class="main">[</span><span class="operator">OF</span> binv<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">k</span> <span class="free">fs</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> fbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"f_bound <span class="free">outside</span> <span class="free">k</span> <span class="free">fs</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> gbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> invw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword1"><span class="command">interpret</span></span> fs<span class="main">:</span> fs_int' <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">fs_init</span></span> <span class="quoted"><span class="free">fs</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> invw <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_inv_N_pos<span class="main">[</span><span class="operator">OF</span> invw gbnd<span class="main">]</span> i <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> j i <span class="keyword1"><span class="command">have</span></span> jm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted">rat_of_int</span> 
  <span class="keyword1"><span class="command">from</span></span> LLL_d_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span>"</span></span><span class="main">]</span> jm
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> N <span class="main">^</span> Suc <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_nat_le_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pow_mono_exp<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> N jm<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> dsj<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> int N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fs.dμ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> j i LLL_invD<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>abs <span class="main">(</span>dμ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> abs <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> μ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> d_def fs.d_def dμ_def fs.dμ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>abs <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> abs <span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?r</span> <span class="main">(</span>int N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> rat_of_nat <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ LLL_mu_abs_bound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i j<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> dsj<span class="main"><span class="keyword3">,</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>int <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>dμ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-LLL_mu_num_denom_bound"><span class="command">lemma</span></span> LLL_mu_num_denom_bound<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>                 
  <span class="keyword2"><span class="keyword">and</span></span> quot<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="main">(</span>μ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">num</span><span class="main">,</span> <span class="free">denom</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">num</span><span class="main">¦</span>   <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">denom</span><span class="main">¦</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">m</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> bound_invD<span class="main">[</span><span class="operator">OF</span> binv<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">k</span> <span class="free">fs</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> fbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"f_bound <span class="free">outside</span> <span class="free">k</span> <span class="free">fs</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> gbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> invw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_inv_N_pos<span class="main">[</span><span class="operator">OF</span> invw gbnd<span class="main">]</span> i <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> LLL_invD<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword1"><span class="command">interpret</span></span> fs<span class="main">:</span> fs_int' <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">fs_init</span></span> <span class="quoted"><span class="free">fs</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> invw <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"μ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bnd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"N<span class="main">^</span><span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">num</span><span class="main">¦</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span> <span class="main">∧</span> <span class="main">¦</span><span class="free">denom</span><span class="main">¦</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> j<span class="main">:</span> True
    <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> jm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> LLL_d_pos<span class="main">[</span><span class="operator">OF</span> invw<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span>"</span></span><span class="main">]</span> i j <span class="keyword1"><span class="command">have</span></span> dsj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> quotient_of_square<span class="main">[</span><span class="operator">OF</span> quot<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> quot_sq<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="main">(</span><span class="var">?mu</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">num</span> <span class="main">*</span> <span class="free">num</span><span class="main">,</span> <span class="free">denom</span> <span class="main">*</span> <span class="free">denom</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> LLL_mu_abs_bound<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> j<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> mu_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="var">?mu</span> <span class="main">≤</span> of_nat <span class="var">?bnd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.Gramian_determinant <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">*</span> <span class="var">?mu</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fs.gs.d_mu_Ints<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">insert</span> j *<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3-6<span class="main"><span class="main">)</span></span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth gs.lin_indpt_list_def vec_hom_Ints<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gs.Gramian_determinant <span class="main">(</span>RAT <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> of_int <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fs.of_int_Gramian_determinant<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i j *<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> ints<span class="main">:</span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span>d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?mu</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> LLL_d_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span>"</span></span><span class="main">]</span> jm
    <span class="keyword1"><span class="command">have</span></span> d_j<span class="main">:</span> <span class="quoted"><span class="quoted">"d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> quot_bounds <span class="main">=</span> quotient_of_bounds<span class="main">[</span><span class="operator">OF</span> quot ints dsj mu_bound<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="free">denom</span> <span class="main">≤</span> <span class="free">denom</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> quotient_of_denom_pos<span class="main">[</span><span class="operator">OF</span> quot<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> denom<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="free">denom</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> quot_bounds<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">num</span><span class="main">¦</span> <span class="main">≤</span> d <span class="free">fs</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">*</span> int <span class="var">?bnd</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> of_int_le_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span> <span class="main"><span class="main">=</span></span> <span class="quoted">rat</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> int <span class="var">?bnd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> d_j<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>int N <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> int <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> power_add of_nat_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span>int N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> int <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_nat_mult
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono pow_mono_exp<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> N<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> num<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">num</span><span class="main">¦</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> denom num <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mu</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="var">?mu</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs.gs.μ.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"quotient_of <span class="var">?mu</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">)</span> <span class="main">∨</span> quotient_of <span class="var">?mu</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> quot<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> N i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_ge_one<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we have bounds on each number $(f_i)_j$, $(g_i)_j$, and $\mu_{i,j}$, i.e.,
  for rational numbers bounds on the numerators and denominators.›</span></span>

<span class="keyword1" id="LLL_Number_Bounds-logN_le_2log_Mn"><span class="command">lemma</span></span> logN_le_2log_Mn<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> N <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"N <span class="main">≤</span> nat M <span class="main">*</span> nat M <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> N_le_MMn m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> nat M <span class="main">*</span> nat M <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> m<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> NM<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">≤</span> nat M <span class="main">*</span> nat M <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat M <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"M <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> N <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>M <span class="main">*</span> M <span class="main">*</span> <span class="free">n</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> log_le_cancel_iff<span class="main">)</span>      
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real N <span class="main">≤</span> <span class="main">(</span>M <span class="main">*</span> M <span class="main">*</span> int <span class="free">n</span> <span class="main">*</span> int <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> NM<span class="main">[</span><span class="operator">folded</span> of_nat_le_iff<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">real</span><span class="main"><span class="main">]</span></span><span class="main">]</span> M
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> N M m<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>of_int <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> of_int <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> of_int_mult <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span>  <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> m M<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> N <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now prove a combined size-bound for all of these numbers. The bounds clearly indicate
  that the size of the numbers grows at most polynomial, namely the sizes are roughly 
  bounded by ${\cal O}(m \cdot \log(M \cdot n))$ where $m$ is the number of vectors, $n$ is the dimension
  of the vectors, and $M$ is the maximum absolute value that occurs in the input to the LLL algorithm.›</span></span>

<span class="keyword1" id="LLL_Number_Bounds-combined_size_bound"><span class="command">lemma</span></span> combined_size_bound<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">number</span> <span class="main">::</span> <span class="quoted">int</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span>of_int <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span><span class="main">,</span> gso <span class="free">fs</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">,</span> μ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> quot<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">num</span><span class="main">,</span> <span class="free">denom</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> number<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">number</span> <span class="main">∈</span> <span class="main">{</span><span class="free">num</span><span class="main">,</span> <span class="free">denom</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> number0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">number</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">¦</span><span class="free">number</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> log <span class="numeral">2</span> N       <span class="main">+</span> <span class="free">m</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">m</span>"</span></span> 
      <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">¦</span><span class="free">number</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> bound_invD<span class="main">[</span><span class="operator">OF</span> binv<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">k</span> <span class="free">fs</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> fbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"f_bound <span class="free">outside</span> <span class="free">k</span> <span class="free">fs</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> gbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> invw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_inv_N_pos<span class="main">[</span><span class="operator">OF</span> invw gbnd<span class="main">]</span> i <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bnd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> int <span class="main">1</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="free">m</span> <span class="main">*</span> int <span class="free">m</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> of_nat_le_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> pow_mono_exp<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> N i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>N <span class="main">^</span> <span class="free">m</span><span class="main">)</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="free">m</span> <span class="main">*</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>xfs<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> of_int <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="main">|</span> <span class="main">(</span>xgs<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> gso <span class="free">fs</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span>"</span></span> <span class="main">|</span> <span class="main">(</span>xmu<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> μ <span class="free">fs</span> <span class="free">i</span> <span class="free">j</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> num_denom_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">num</span><span class="main">¦</span> <span class="main">≤</span> <span class="var">?bnd</span> <span class="main">∧</span> <span class="main">¦</span><span class="free">denom</span><span class="main">¦</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> xgs
    <span class="keyword1"><span class="command">from</span></span> LLL_gso_bound<span class="main">[</span><span class="operator">OF</span> i j quot<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> xgs<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span> le
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> xmu
    <span class="keyword1"><span class="command">from</span></span> LLL_mu_num_denom_bound<span class="main">[</span><span class="operator">OF</span> i<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">j</span></span></span></span><span class="main">,</span> <span class="operator">OF</span> quot<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> xmu<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> xfs
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">denom</span><span class="main">¦</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> quot<span class="main">[</span><span class="operator">unfolded</span> xfs<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> denom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">denom</span><span class="main">¦</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">num</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> quot<span class="main">[</span><span class="operator">unfolded</span> xfs<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> int <span class="main">(</span>N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LLL_f_bound<span class="main">[</span><span class="operator">OF</span> i j<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?bnd</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_nat_mult of_nat_power
      <span class="keyword1"><span class="command">using</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_mono pow_mono_exp<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> denom <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> number <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>num<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">number</span> <span class="main">=</span> <span class="free">num</span>"</span></span> <span class="main">|</span> <span class="main">(</span>denom<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">number</span> <span class="main">=</span> <span class="free">denom</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> number_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">number</span><span class="main">¦</span> <span class="main">≤</span> <span class="var">?bnd</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> num
    <span class="keyword1"><span class="command">with</span></span> num_denom_bound <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> denom
    <span class="keyword1"><span class="command">with</span></span> num_denom_bound <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">number</span><span class="main">¦</span> <span class="main">≤</span> N <span class="main">^</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> le <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> number_bound <span class="keyword1"><span class="command">have</span></span> bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"of_int <span class="main">¦</span><span class="free">number</span><span class="main">¦</span> <span class="main">≤</span> real <span class="var">?bnd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">¦</span><span class="free">number</span><span class="main">¦</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="var">?bnd</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_le_cancel_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> number0 bnd<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>N<span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="free">m</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i N<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>N<span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="free">m</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i N<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>N<span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>N <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"log <span class="numeral"><span class="numeral"><span class="numeral">2</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> powr_realpow<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> N<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> N"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_powr<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> N<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> boundN<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">¦</span><span class="free">number</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> log <span class="numeral">2</span> N <span class="main">+</span> <span class="free">m</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_right_mono mult_mono logN_le_2log_Mn N<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i j N<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">¦</span><span class="free">number</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹And a combined size bound for an integer implementation which stores values 
  $f_i$, $d_{j+1}\mu_{ij}$ and $d_i$.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> fs<span class="main">:</span> fs_int_indpt <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">fs_init</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> lin_dep <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="LLL_Number_Bounds-fs_gs_N_N'"><span class="command">lemma</span></span> fs_gs_N_N'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fs.gs.N <span class="main">=</span> of_nat N"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>sq_norm <span class="main">`</span> set <span class="free">fs_init</span><span class="main">)</span>  <span class="main">∈</span>  sq_norm <span class="main">`</span> set <span class="free">fs_init</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">" nat <span class="main">(</span>Max <span class="main">(</span>sq_norm <span class="main">`</span> set <span class="free">fs_init</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>nat <span class="main">∘</span> sq_norm<span class="main">)</span> <span class="main">`</span> set <span class="free">fs_init</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> Max <span class="main">(</span>sq_norm <span class="main">`</span> set <span class="free">fs_init</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">`</span> of_int_hom.vec_hom <span class="main">`</span> set <span class="free">fs_init</span> <span class="main">=</span> rat_of_int <span class="main">`</span> sq_norm <span class="main">`</span> set <span class="free">fs_init</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_of_int image_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>Max <span class="main">(</span>sq_norm <span class="main">`</span> set <span class="free">fs_init</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> rat_of_int <span class="main">`</span> sq_norm <span class="main">`</span> set <span class="free">fs_init</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Missing_Lemmas.max_list <span class="main">(</span>map <span class="main">(</span>nat <span class="main">∘</span> sq_norm<span class="main">)</span> <span class="free">fs_init</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span><span class="main">(</span>nat <span class="main">∘</span> sq_norm<span class="main">)</span> <span class="main">`</span> set <span class="free">fs_init</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms len <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> max_list_Max<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nat <span class="main">(</span>Max <span class="main">(</span>sq_norm_vec <span class="main">`</span> set <span class="free">fs_init</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nat_mono Max_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">…</span> <span class="main">=</span> Max <span class="main">(</span>sq_norm_vec <span class="main">`</span> set <span class="free">fs_init</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> int_nat_eq<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">…</span> <span class="main">=</span> Max <span class="main">(</span>sq_norm <span class="main">`</span> set <span class="main">(</span>map of_int_hom.vec_hom <span class="free">fs_init</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max_eqI<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_of_int<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> N_def fs.gs.N_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-fs_gs_N_N"><span class="command">lemma</span></span> fs_gs_N_N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> real_of_rat fs.gs.N <span class="main">=</span> real N"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fs_gs_N_N' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="LLL_Number_Bounds-combined_size_bound_gso_integer"><span class="command">lemma</span></span> combined_size_bound_gso_integer<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> 
    <span class="main">{</span>fs.μ' <span class="bound">i</span> <span class="bound">j</span> <span class="main">|</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">}</span> <span class="main">∪</span> 
    <span class="main">{</span>fs.σs <span class="bound">l</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">|</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">¦</span>real_of_int <span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span> <span class="main">+</span> <span class="numeral">6</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">m</span> <span class="main">+</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> bound_invD<span class="main">[</span><span class="operator">OF</span> binv<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">k</span> <span class="free">fs</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> gbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">note</span></span> invw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_inv_N_pos<span class="main">[</span><span class="operator">OF</span> invw gbnd m<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">¦</span>real_of_int <span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">m</span> <span class="main">+</span> real <span class="main">(</span><span class="numeral">3</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> N"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms len fs.combined_size_bound_integer_log <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fs_gs_N_N<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">m</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> logN_le_2log_Mn assms N <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_left_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> mult_left_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="free">m</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">6</span> <span class="main">+</span> <span class="numeral">6</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-combined_size_bound_integer'"><span class="command">lemma</span></span> combined_size_bound_integer'<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span> 
    <span class="main">∪</span> <span class="main">{</span>dμ <span class="free">fs</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">}</span> 
    <span class="main">∪</span> <span class="main">{</span>d <span class="free">fs</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">m</span><span class="main">}</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="var">?fs</span> <span class="main">∪</span> <span class="var">?dμ</span> <span class="main">∪</span> <span class="var">?d</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abs <span class="free">x</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> log <span class="numeral">2</span> <span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> log <span class="numeral">2</span> N       <span class="main">+</span> <span class="free">m</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">m</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="var">?l1</span> <span class="main">≤</span> <span class="var">?b1</span>"</span></span><span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> log <span class="numeral">2</span> <span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">m</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">≤</span> <span class="var">?b2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bnd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"int N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> int <span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> bound_invD<span class="main">[</span><span class="operator">OF</span> binv<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant <span class="free">upw</span> <span class="free">k</span> <span class="free">fs</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> fbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"f_bound <span class="free">outside</span> <span class="free">k</span> <span class="free">fs</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> gbnd<span class="main">:</span> <span class="quoted"><span class="quoted">"g_bound <span class="free">fs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">note</span></span> invw <span class="main">=</span> LLL_inv_imp_w<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_inv_N_pos<span class="main">[</span><span class="operator">OF</span> invw gbnd m<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted">real_of_int</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>fs<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="var">?fs</span>"</span></span> <span class="main">|</span> <span class="main">(</span>dμ<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="var">?dμ</span>"</span></span> <span class="main">|</span> <span class="main">(</span>d<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="var">?d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"abs <span class="free">x</span> <span class="main">≤</span> <span class="var">?bnd</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> fs
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> LLL_f_bound<span class="main">[</span><span class="operator">OF</span> i j<span class="main">,</span> <span class="operator">folded</span> x<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> int N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> int <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?bnd</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono pow_mono_exp<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> N<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> dμ
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> dμ <span class="free">fs</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> LLL_dμ_bound<span class="main">[</span><span class="operator">OF</span> i j<span class="main">,</span> <span class="operator">folded</span> x<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> int N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> int <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?bnd</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono pow_mono_exp<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> N<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> d
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> d <span class="free">fs</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> LLL_d_bound<span class="main">[</span><span class="operator">OF</span> i<span class="main">,</span> <span class="operator">folded</span> x<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> int N <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">0</span> <span class="main">*</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?bnd</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono pow_mono_exp<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> N m<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"abs <span class="free">x</span> <span class="main">≤</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>abs <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?r</span> <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> abs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>abs <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="main">*</span> <span class="var">?r</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_le_cancel_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> x N m<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span><span class="var">?r</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span><span class="var">?r</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> N m <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> log_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="var">?r</span> N <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span><span class="var">?r</span> N<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_nat_power<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> N<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l1</span> <span class="main">≤</span> <span class="var">?b1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_right_mono mult_left_mono logN_le_2log_Mn<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> m n N<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l1</span> <span class="main">≤</span> <span class="var">?b2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Number_Bounds-combined_size_bound_integer"><span class="command">lemma</span></span> combined_size_bound_integer<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> 
      <span class="main">{</span><span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span> 
    <span class="main">∪</span> <span class="main">{</span>dμ <span class="free">fs</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">}</span> 
    <span class="main">∪</span> <span class="main">{</span>d <span class="free">fs</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">m</span><span class="main">}</span>
    <span class="main">∪</span> <span class="main">{</span>fs.μ' <span class="bound">i</span> <span class="bound">j</span> <span class="main">|</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">}</span>
    <span class="main">∪</span> <span class="main">{</span>fs.σs <span class="bound">l</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">|</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> <span class="var">?s1</span> <span class="main">∪</span> <span class="var">?s2</span> <span class="main">∪</span> <span class="var">?s3</span> <span class="main">∪</span> <span class="var">?g1</span> <span class="main">∪</span> <span class="var">?g2</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> M"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span> <span class="main">+</span> <span class="numeral">6</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">m</span> <span class="main">+</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> <span class="var">?g1</span> <span class="main">∪</span> <span class="var">?g2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> combined_size_bound_gso_integer assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="var">?s1</span> <span class="main">∪</span> <span class="var">?s2</span> <span class="main">∪</span> <span class="var">?s3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> combined_size_bound_integer'<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this m n <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">m</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span> <span class="main">+</span> <span class="numeral">6</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>M <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">m</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_right_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> mult_right_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* LLL_bound_invariant *)</span>  
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* LLL locale *)</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LLL_Certification">
<div class="head">
<h1>Theory LLL_Certification</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    René Thiemann
                BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Certification of External LLL Invocations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Instead of using a fully verified algorithm, we also provide a technique to invoke
an external LLL solver. In order to check its result, we not only need the reduced basic,
but also the matrices which translate between the input basis and the reduced basis. 
Then we can easily check whether the resulting lattices are indeed identical and just have
to start the verified algorithm on the already reduced basis.
This invocation will then usually just require one computation of Gram--Schmidt in order
to check that the basis is already reduced. Alternatively, one could also throw an error
message in case the basis is not reduced.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Checking Results of External LLL Solvers›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LLL_Certification
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#LLL_Impl">LLL_Impl</a>
    <a href="../../jordan_normal_form/theories/#Show_Matrix">Jordan_Normal_Form.Show_Matrix</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gauss_jordan_integer_inverse</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> gauss_jordan <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">of</span>
   <span class="main">(</span><span class="bound">C</span><span class="main">,</span><span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">C</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> list_all is_int_rat <span class="main">(</span>concat <span class="main">(</span>mat_to_list <span class="bound">D</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">integer_equivalent</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> 
  <span class="bound">fs'</span> <span class="main">=</span> map_mat rat_of_int <span class="main">(</span>mat_of_cols <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">;</span>
  <span class="bound">gs'</span> <span class="main">=</span> map_mat rat_of_int <span class="main">(</span>mat_of_cols <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span><span class="main">;</span>
  <span class="bound">I</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>
  <span class="keyword1">in</span> gauss_jordan_integer_inverse <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">fs'</span> <span class="bound">gs'</span> <span class="bound">I</span> <span class="main">∧</span> gauss_jordan_integer_inverse <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">gs'</span> <span class="bound">fs'</span> <span class="bound">I</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">context</span></span> vec_module
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="LLL_Certification-mat_mult_sub_lattice"><span class="command">lemma</span></span> mat_mult_sub_lattice<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">gs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>length <span class="free">fs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">gs</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> prod<span class="main">:</span> <span class="quoted"><span class="quoted">"mat_of_rows <span class="free">n</span> <span class="free">fs</span> <span class="main">=</span> map_mat of_int <span class="free">A</span> <span class="main">*</span> mat_of_rows <span class="free">n</span> <span class="free">gs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs</span> <span class="main">⊆</span> lattice_of <span class="free">gs</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">gs</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"of_int <span class="main">::</span> int <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_mat <span class="var">?i</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="free">A</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> gsC<span class="main">:</span> <span class="quoted"><span class="quoted">"mat_of_rows <span class="free">n</span> <span class="free">gs</span> <span class="main">∈</span> carrier_mat <span class="var">?m'</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∈</span> carrier_mat <span class="var">?m</span> <span class="var">?m'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fs <span class="keyword1"><span class="command">have</span></span> fsi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?m</span> <span class="main">⟹</span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> fsi'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?m</span> <span class="main">⟹</span> dim_vec <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> gs <span class="keyword1"><span class="command">have</span></span> fsi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?m'</span> <span class="main">⟹</span> <span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> gsi'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?m'</span> <span class="main">⟹</span> dim_vec <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> lattice_of <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> in_latticeE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?i</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="var">?m</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"vec <span class="var">?m</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?i</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec <span class="var">?m</span> <span class="skolem">c</span>"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> v
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> mat_of_cols <span class="free">n</span> <span class="free">fs</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?c</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dim_sumlist sum.cong 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sumlist_nth scalar_prod_def mat_of_cols_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mat_of_cols <span class="free">n</span> <span class="free">fs</span> <span class="main">=</span> <span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">fs</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transpose_mat_of_rows<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?A</span> <span class="main">*</span> mat_of_rows <span class="free">n</span> <span class="free">gs</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prod <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">gs</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">*</span> <span class="var">?A</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transpose_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A gsC<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">gs</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">=</span> mat_of_cols <span class="free">n</span> <span class="free">gs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transpose_mat_of_rows<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">gs</span> <span class="main">*</span> <span class="var">?A</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> mat_of_cols <span class="free">n</span> <span class="free">gs</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="var">?A</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?c</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assoc_mult_mat_vec<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">=</span> <span class="var">?I</span> <span class="main">(</span><span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">=</span> map_vec <span class="var">?i</span> <span class="main">(</span>vec <span class="var">?m</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">(</span><span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">…</span> <span class="main">=</span> map_vec <span class="var">?i</span> <span class="var">?d</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_int_hom.mult_mat_vec_hom<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> mat_of_cols <span class="free">n</span> <span class="free">gs</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> map_vec <span class="var">?i</span> <span class="var">?d</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="var">?d</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> carrier_vec <span class="var">?m'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> mat_of_cols <span class="free">n</span> <span class="free">gs</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> map_vec <span class="var">?i</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  M.sumlist <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?i</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="var">?m'</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> d<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dim_sumlist sum.cong 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sumlist_nth scalar_prod_def mat_of_cols_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> lattice_of <span class="free">gs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> in_latticeI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> LLL_with_assms
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="LLL_Certification-mult_left_identity"><span class="command">lemma</span></span> mult_left_identity<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≡</span> <span class="main">(</span>map_mat rat_of_int <span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">fs_init</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P_carrier<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> PB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">*</span> <span class="free">B</span> <span class="main">=</span> <span class="free">B</span>"</span></span>  
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">m</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?set_rows</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>rows <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?hom</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"of_int_hom.vec_hom <span class="main">::</span> int vec <span class="main">⇒</span> rat vec"</span></span>
  <span class="keyword1"><span class="command">have</span></span> set_rows_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?set_rows</span> <span class="main">⊆</span> <span class="main">(</span>carrier_vec <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rows_def B_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> set_rows_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?set_rows</span> <span class="main">=</span> set <span class="main">(</span>map of_int_hom.vec_hom <span class="free">fs_init</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> of_int_hom.vec_hom <span class="main">`</span> set <span class="free">fs_init</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>rows <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">unfolding</span></span> B_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cof_vec_space.lin_indpt_list_def fs_init image_set 
          lin_dep mat_of_rows_map rows_mat_of_rows<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int_hom.vec_hom <span class="skolem">xa</span> <span class="main">∈</span> set <span class="main">(</span>rows <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> xa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> set <span class="free">fs_init</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xa</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> xa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> <span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth len xa<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?hom</span> <span class="main">(</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> row <span class="free">B</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i cof_vec_space.lin_indpt_list_def fs_init index_map_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> len lin_dep 
            mat_of_rows_carrier<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mat_of_rows_map nth_map nth_rows rows_mat_of_rows<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> B_def xa i cof_vec_space.lin_indpt_list_def fs_init index_map_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> len 
            length_rows lin_dep mat_of_rows_map nth_map nth_mem rows_mat_of_rows<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> ind_set_rows<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.lin_indpt <span class="var">?set_rows</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lin_dep set_rows_eq <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> inj_on_rowB<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>row <span class="free">B</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> row_xy<span class="main">:</span> <span class="quoted"><span class="quoted">"row <span class="free">B</span> <span class="skolem">x</span> <span class="main">=</span> row <span class="free">B</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?hom</span> <span class="main">(</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> row <span class="free">B</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fs_init index_map_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> len local.set_rows_carrier mat_of_rows_carrier<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
            mat_of_rows_map nth_map nth_rows rows_mat_of_rows set_rows_eq that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?hom</span> <span class="main">(</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> row <span class="free">B</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fs_init index_map_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> len local.set_rows_carrier mat_of_rows_carrier<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
            mat_of_rows_map nth_map nth_rows rows_mat_of_rows set_rows_eq that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?hom</span> <span class="main">(</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="var">?hom</span> <span class="main">(</span><span class="free">fs_init</span> <span class="main">!</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> row_xy <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> lin_dep x y row_xy <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def 
        <span class="keyword1"><span class="command">using</span></span> xy x y len <span class="keyword1"><span class="command">unfolding</span></span> distinct_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> the_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> row <span class="free">B</span> <span class="skolem">x</span> <span class="main">=</span> row <span class="free">B</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> theI2<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> row <span class="free">B</span> <span class="skolem">x</span> <span class="main">=</span> row <span class="free">B</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> <span class="keyword3"><span class="command">assume</span></span> xa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> row <span class="free">B</span> <span class="skolem">x</span> <span class="main">=</span> row <span class="free">B</span> <span class="skolem">xa</span>"</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xa inj_on_rowB x <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span><span class="main">=</span> <span class="quoted"><span class="quoted">"row <span class="free">B</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> one_mat_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="free">P</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="keyword1">THE</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">=</span> row <span class="free">B</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> row <span class="free">B</span> <span class="skolem">j</span> <span class="keyword1">then</span> <span class="main">(</span><span class="var">?f</span> <span class="bound">v</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="var">?f</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> finsum_closed<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
       <span class="quoted"><span class="quoted">"finsum_vec <span class="keyword1">TYPE</span><span class="main">(</span>rat<span class="main">)</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> row <span class="free">B</span> <span class="bound">k</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finsum_vec_closed<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> len B_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> B_carrier<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> len fs_init B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≡</span> row <span class="free">B</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> v_set_rows<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> set <span class="main">(</span>rows <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_rows j <span class="keyword1"><span class="command">unfolding</span></span> v_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> B_carrier carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> length_rows nth_mem<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mat_of_rows <span class="free">n</span> <span class="free">fs_init</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> len fs_init <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="free">P</span><span class="main">*</span><span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PB <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">mat<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">m</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> finsum_vec <span class="keyword1">TYPE</span><span class="main">(</span>rat<span class="main">)</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> row <span class="free">B</span> <span class="bound">k</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mat_mul_finsum_alt<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"row <span class="main">(</span><span class="main">...</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">=</span> finsum_vec <span class="keyword1">TYPE</span><span class="main">(</span>rat<span class="main">)</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> row <span class="free">B</span> <span class="bound">k</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> row_mat_of_row_fun<span class="main"><span class="main">[</span></span><span class="operator">OF</span> j<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> finsum_vec <span class="keyword1">TYPE</span><span class="main">(</span>rat<span class="main">)</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span>  <span class="var">?f</span> <span class="bound">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span> <span class="var">?set_rows</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> rhs_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finsum_vec_closed<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> set_rows_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="var">?lhs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> vec_space.finsum_dim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> dim_rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dim_vec <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rhs_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="var">?lhs</span> <span class="main">=</span> dim_vec <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_vec <span class="var">?rhs</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> i_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i dim_rhs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="var">?f</span> <span class="bound">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> image_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="main">`</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">=</span> <span class="var">?set_rows</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> B_def len rows_def<span class="main">)</span>      
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> row <span class="free">B</span> <span class="bound">k</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> index_finsum_vec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ i_n<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="var">?g</span> <span class="main">∘</span> <span class="var">?h</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> o_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> the_x<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="var">?f</span> <span class="bound">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?h</span> <span class="main">`</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> inj_on_rowB<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">(</span><span class="main">∑</span><span class="bound">v</span><span class="main">∈</span><span class="var">?set_rows</span><span class="main">.</span> <span class="main">(</span><span class="var">?f</span> <span class="bound">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> image_h <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> index_finsum_vec<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ i_n<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> set_rows_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>gs.V</sub><span class="hidden">⇙</span><span class="bound">v</span><span class="main">∈</span><span class="var">?set_rows</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vec_space.finsum_vec <span class="keyword1"><span class="command">..</span></span>  
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> gs.lincomb <span class="var">?f</span> <span class="var">?set_rows</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs.lincomb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> lincomb_rowBj<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.lincomb <span class="var">?f</span> <span class="var">?set_rows</span> <span class="main">=</span> row <span class="free">B</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">have</span></span> lincomb_0<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.lincomb <span class="var">?g</span> <span class="main">(</span><span class="var">?set_rows</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> v_closed<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> v_def <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> lincomb_f_closed<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gs.lincomb <span class="var">?f</span> <span class="main">(</span><span class="var">?set_rows</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> Rn"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.lincomb_closed<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> set_rows_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> fv_v_closed<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">∈</span> Rn"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> lincomb_f<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.lincomb <span class="var">?f</span> <span class="var">?set_rows</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">+</span> gs.lincomb <span class="var">?f</span> <span class="main">(</span><span class="var">?set_rows</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.lincomb_del2<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> set_rows_carrier v_set_rows<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">have</span></span> fvv_gvv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">-</span> <span class="skolem">v</span> <span class="main">=</span> <span class="var">?g</span> <span class="skolem">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> v_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_diff_distrib<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> lincomb_fg<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.lincomb <span class="var">?f</span> <span class="main">(</span><span class="var">?set_rows</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> gs.lincomb <span class="var">?g</span> <span class="main">(</span><span class="var">?set_rows</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">)</span>"</span></span> 
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> dim_vec_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="var">?lhs</span> <span class="main">=</span> dim_vec <span class="var">?rhs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> DiffE carrier_vecD gs.lincomb_closed local.set_rows_carrier subsetCE subsetI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>dim_vec <span class="var">?rhs</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> i_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dim_vec_eq lincomb_f_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span>  <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="var">?set_rows</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.lincomb_index<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i_n<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> set_rows_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="var">?set_rows</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="var">?g</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.lincomb_index<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> i_n<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> set_rows_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span> <span class="main">=</span> gs.lincomb <span class="var">?f</span> <span class="var">?set_rows</span> <span class="main">-</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lincomb_rowBj <span class="keyword1"><span class="command">unfolding</span></span> v_def B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">+</span> gs.lincomb <span class="var">?f</span> <span class="main">(</span><span class="var">?set_rows</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lincomb_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>gs.lincomb <span class="var">?f</span> <span class="main">(</span><span class="var">?set_rows</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> <span class="var">?f</span> <span class="skolem">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span><span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="skolem">v</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> gs.M.a_comm<span class="main">[</span><span class="operator">OF</span> lincomb_f_closed fv_v_closed<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> gs.lincomb <span class="var">?f</span> <span class="main">(</span><span class="var">?set_rows</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">+</span> <span class="main">-</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.M.a_assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> gs.lincomb <span class="var">?f</span> <span class="main">(</span><span class="var">?set_rows</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">-</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> gs.lincomb <span class="var">?g</span> <span class="main">(</span><span class="var">?set_rows</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="var">?g</span> <span class="skolem">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> lincomb_fg fvv_gvv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="var">?g</span> <span class="skolem">v</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span><span class="main">)</span> <span class="main">+</span> gs.lincomb <span class="var">?g</span> <span class="main">(</span><span class="var">?set_rows</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.M.a_comm<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gs.lincomb_closed<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> set_rows_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> gs.lincomb <span class="var">?g</span> <span class="main">(</span><span class="var">?set_rows</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.lincomb_del2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> v_set_rows set_rows_carrier<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> g0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">∈</span> <span class="var">?set_rows</span> <span class="main">→</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.not_lindepD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?set_rows</span></span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> ind_set_rows _ _ _ lincomb_0<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>  
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">(</span>row <span class="free">B</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v_set_rows <span class="keyword1"><span class="command">unfolding</span></span> v_def Pi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span>row <span class="free">B</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> the_x j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">$$</span><span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> row_ij<span class="main">:</span> <span class="quoted"><span class="quoted">"row <span class="free">B</span> <span class="skolem">i</span> <span class="main">≠</span> row <span class="free">B</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inj_on_rowB ji i j <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"row <span class="free">B</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="var">?set_rows</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_rows i
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> B_carrier carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> length_rows nth_mem<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">(</span>row <span class="free">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> g0 <span class="keyword1"><span class="command">unfolding</span></span> Pi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span>row <span class="free">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> row_ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> the_x i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="free">P</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">P</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P_carrier <span class="keyword1"><span class="command">unfolding</span></span> carrier_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is the key lemma. It permits to change from the initial basis
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">fs_init</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to an arbitrary <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">gs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that has been computed by some
external tool. Here, two change-of-basis matrices U1 and U2 are required 
to certify the change via the conditions prod1 and prod2.›</span></span>


<span class="keyword1" id="LLL_Certification-LLL_change_basis"><span class="command">lemma</span></span> LLL_change_basis<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">gs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> len'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">gs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> U1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U1</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> U2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U2</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> prod1<span class="main">:</span> <span class="quoted"><span class="quoted">"mat_of_rows <span class="free">n</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="free">U1</span> <span class="main">*</span> mat_of_rows <span class="free">n</span> <span class="free">gs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> prod2<span class="main">:</span> <span class="quoted"><span class="quoted">"mat_of_rows <span class="free">n</span> <span class="free">gs</span> <span class="main">=</span> <span class="free">U2</span> <span class="main">*</span> mat_of_rows <span class="free">n</span> <span class="free">fs_init</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">gs</span> <span class="main">=</span> lattice_of <span class="free">fs_init</span>"</span></span> <span class="quoted"><span class="quoted">"LLL_with_assms <span class="free">n</span> <span class="free">m</span> <span class="free">gs</span> <span class="free">α</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"of_int <span class="main">::</span> int <span class="main">⇒</span> int"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">U1</span> <span class="main">=</span> map_mat <span class="var">?i</span> <span class="free">U1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> prod1 <span class="keyword1"><span class="command">have</span></span> prod1<span class="main">:</span> <span class="quoted"><span class="quoted">"mat_of_rows <span class="free">n</span> <span class="free">fs_init</span> <span class="main">=</span> map_mat <span class="var">?i</span> <span class="free">U1</span> <span class="main">*</span> mat_of_rows <span class="free">n</span> <span class="free">gs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">U2</span> <span class="main">=</span> map_mat <span class="var">?i</span> <span class="free">U2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> prod2 <span class="keyword1"><span class="command">have</span></span> prod2<span class="main">:</span> <span class="quoted"><span class="quoted">"mat_of_rows <span class="free">n</span> <span class="free">gs</span> <span class="main">=</span> map_mat <span class="var">?i</span> <span class="free">U2</span> <span class="main">*</span> mat_of_rows <span class="free">n</span> <span class="free">fs_init</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">gs</span> <span class="main">⊆</span> lattice_of <span class="free">fs_init</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mat_mult_sub_lattice<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gs fs_init _ prod2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> U2 len len'<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">gs</span> <span class="main">⊇</span> lattice_of <span class="free">fs_init</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mat_mult_sub_lattice<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fs_init gs _ prod1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> U1 len len'<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">gs</span> <span class="main">=</span> lattice_of <span class="free">fs_init</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LLL_with_assms <span class="free">n</span> <span class="free">m</span> <span class="free">gs</span> <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span><span class="main">/</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free">α</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> α<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="free">gs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lin_indep <span class="free">gs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_mat rat_of_int <span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">fs_init</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_mat rat_of_int <span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="free">gs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_mat rat_of_int <span class="free">U1</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_mat rat_of_int <span class="free">U2</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?U1</span> <span class="main">*</span> <span class="var">?U2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> rows_gs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"rows <span class="var">?gs</span> <span class="main">=</span> map of_int_hom.vec_hom <span class="free">gs</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>        
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>rows <span class="var">?gs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rows <span class="var">?gs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> row <span class="var">?gs</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_rows<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> of_int_hom.vec_hom <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> gs i index_map_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_map length_rows map_carrier_vec 
              mat_of_rows_map mat_of_rows_row nth_map nth_mem rows_mat_of_rows subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> map of_int_hom.vec_hom <span class="free">gs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>        
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rows <span class="var">?gs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> map of_int_hom.vec_hom <span class="free">gs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> fs_hom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fs</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> carrier_mat_def <span class="keyword1"><span class="command">using</span></span> len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> gs_hom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gs</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> carrier_mat_def <span class="keyword1"><span class="command">using</span></span> len' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
      <span class="keyword1"><span class="command">have</span></span> U1U2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U1</span> <span class="main">*</span> <span class="free">U2</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> mult_carrier_mat<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> U1_hom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?U1</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> U1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> U2_hom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?U2</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> U2<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> U1U2_hom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?U1</span> <span class="main">*</span> <span class="var">?U2</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U1 U2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> Gs_U2Fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gs</span> <span class="main">=</span> <span class="var">?U2</span> <span class="main">*</span> <span class="var">?fs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> U2 assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> len mat_of_rows_carrier<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> of_int_hom.mat_hom_mult<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> fs_hom_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fs</span> <span class="main">=</span> <span class="var">?P</span> <span class="main">*</span> <span class="var">?fs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> U1 U1U2 U2 assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> assoc_mult_mat fs_hom 
            map_carrier_mat of_int_hom.mat_hom_mult<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> P_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_left_identity<span class="main"><span class="main">[</span></span><span class="operator">OF</span> U1U2_hom fs_hom_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"det <span class="main">(</span><span class="var">?U1</span><span class="main">)</span> <span class="main">*</span> det <span class="main">(</span><span class="var">?U2</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> U1_hom U2_hom det_mult det_one of_int_hom.hom_det<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> det_U2<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="var">?U2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> det_U1<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="var">?U1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
      <span class="keyword1"><span class="command">from</span></span> det_non_zero_imp_unit<span class="main">[</span><span class="operator">OF</span> U2_hom det_U2<span class="main">,</span> <span class="operator">unfolded</span> Units_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> inv_U2<span class="main">:</span> <span class="quoted"><span class="quoted">"invertible_mat <span class="var">?U2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> U1_hom U2_hom
        <span class="keyword1"><span class="command">unfolding</span></span> invertible_mat_def inverts_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ring_mat_def<span class="main">)</span>
      <span class="keyword1"><span class="command">interpret</span></span> Rs<span class="main">:</span> vectorspace <span class="quoted">class_ring</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gs.vs <span class="main">(</span>gs.row_space <span class="var">?gs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.vector_space_row_space<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gs_hom<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">interpret</span></span> RS_fs<span class="main">:</span> vectorspace <span class="quoted">class_ring</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gs.vs <span class="main">(</span>gs.row_space <span class="main">(</span><span class="var">?fs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.vector_space_row_space<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fs_hom<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> submoduleGS<span class="main">:</span> <span class="quoted"><span class="quoted">"submodule class_ring <span class="main">(</span>gs.row_space <span class="var">?gs</span><span class="main">)</span> gs.V"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> submoduleFS<span class="main">:</span> <span class="quoted"><span class="quoted">"submodule class_ring <span class="main">(</span>gs.row_space <span class="var">?fs</span><span class="main">)</span> gs.V"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gs.row_space_def gs.span_is_submodule index_map_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 
            mat_of_rows_carrier<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> rows_carrier<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">have</span></span> set_rows_fs_in<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>rows <span class="var">?fs</span><span class="main">)</span> <span class="main">⊆</span> gs.row_space <span class="var">?fs</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> rows_gs_row_space<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>rows <span class="var">?gs</span><span class="main">)</span> <span class="main">⊆</span> gs.row_space <span class="var">?gs</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> gs.row_space_def      
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gs.in_own_span index_map_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mat_of_rows_carrier<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> rows_carrier<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">have</span></span> Rs_fs_dim<span class="main">:</span> <span class="quoted"><span class="quoted">"RS_fs.dim <span class="main">=</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RS_fs.dim <span class="main">=</span> card <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?fs</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> RS_fs.dim_basis<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RS_fs.span <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?fs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> gs.span <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?fs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.span_li_not_depend<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ submoduleFS<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_rows_fs_in<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> carrier <span class="main">(</span>gs.vs <span class="main">(</span>gs.row_space <span class="var">?fs</span><span class="main">)</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">unfolding</span></span> gs.row_space_def <span class="keyword1"><span class="command">unfolding</span></span> gs.carrier_vs_is_self <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RS_fs.gen_set <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?fs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RS_fs.lin_indpt <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?fs</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"module.lin_dep class_ring <span class="main">(</span>gs.vs <span class="main">(</span>gs.row_space <span class="var">?fs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?fs</span><span class="main">)</span><span class="main">)</span> 
              <span class="main">=</span> gs.lin_dep <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?fs</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.span_li_not_depend<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ submoduleFS<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_rows_fs_in<span class="main">)</span> 
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lin_dep <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_indpt_list_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fs_init mat_of_rows_map rows_mat_of_rows<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>rows <span class="var">?fs</span><span class="main">)</span> <span class="main">⊆</span> carrier <span class="main">(</span>gs.vs <span class="main">(</span>gs.row_space <span class="var">?fs</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_rows_fs_in<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RS_fs.basis <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?fs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> RS_fs.basis_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cof_vec_space.lin_indpt_list_def distinct_card fs_init len 
              length_map lin_dep mat_of_rows_map rows_mat_of_rows<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.row_space <span class="var">?fs</span> <span class="main">=</span> gs.row_space <span class="main">(</span><span class="var">?U2</span><span class="main">*</span><span class="var">?fs</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.row_space_is_preserved<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> inv_U2 U2_hom fs_hom<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> gs.row_space <span class="var">?gs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Gs_U2Fs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.row_space <span class="var">?fs</span> <span class="main">=</span> gs.row_space <span class="var">?gs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vectorspace.dim class_ring <span class="main">(</span>gs.vs <span class="main">(</span>gs.row_space <span class="var">?gs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Rs_fs_dim fs_hom_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> Rs_dim_is_m<span class="main">:</span> <span class="quoted"><span class="quoted">"Rs.dim <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> card_set_rows<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?gs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card_length length_map rows_gs_eq<span class="main">)</span>     
      <span class="keyword1"><span class="command">have</span></span> Rs_basis<span class="main">:</span> <span class="quoted"><span class="quoted">"Rs.basis <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?gs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Rs.dim_gen_is_basis<span class="main">)</span>        
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?gs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> Rs.dim"</span></span> <span class="keyword1"><span class="command">using</span></span> card_set_rows Rs_dim_is_m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rs.span <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?gs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> gs.span <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?gs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.span_li_not_depend<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rows_gs_row_space submoduleGS<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> carrier <span class="main">(</span>gs.vs <span class="main">(</span>gs.row_space <span class="var">?gs</span><span class="main">)</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">unfolding</span></span> gs.row_space_def <span class="keyword1"><span class="command">unfolding</span></span> gs.carrier_vs_is_self <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Rs.gen_set <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?gs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>rows <span class="var">?gs</span><span class="main">)</span> <span class="main">⊆</span> carrier <span class="main">(</span>gs.vs <span class="main">(</span>gs.row_space <span class="var">?gs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rows_gs_row_space <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>      
      <span class="keyword1"><span class="command">hence</span></span> indpt_Rs<span class="main">:</span> <span class="quoted"><span class="quoted">"Rs.lin_indpt <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?gs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Rs.basis_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> gs_lin_indpt_rows<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.lin_indpt <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?gs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="comment1">(*Is there any automatic way to prove this?*)</span> 
        <span class="comment1">(*TODO: via gs.span_li_not_depend*)</span>
      <span class="keyword1"><span class="command">proof</span></span> 
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">≡</span> <span class="main">(</span>gs.row_space <span class="var">?gs</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"gs.lin_dep <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?gs</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> set <span class="main">(</span>rows <span class="var">?gs</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> lc_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"gs.lincomb <span class="skolem">f</span> <span class="skolem">A</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> gs.lin_dep_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gs.lincomb <span class="skolem">f</span> <span class="skolem">A</span> <span class="main">=</span> module.lincomb <span class="main">(</span>gs.vs <span class="skolem">N</span><span class="main">)</span> <span class="skolem">f</span> <span class="skolem">A</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gs.lincomb_not_depend<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> submoduleGS A1 A2 gs.row_space_def 
              rows_gs_row_space<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N_def gs.row_space_def<span class="main">)</span>          
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Rs.lincomb <span class="skolem">f</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> N_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rs.lin_dep <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?gs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> Rs.lin_dep_def <span class="keyword1"><span class="command">using</span></span> A1 A2 v fv lc_gs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> indpt_Rs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?gs</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> Rs.dim"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rs.gen_ge_dim<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> rows_gs_row_space Rs_basis<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rs.basis_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> card_m<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="main">(</span>rows <span class="var">?gs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_set_rows Rs_dim_is_m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="main">(</span>of_int_hom.vec_hom<span class="main">::</span>int vec <span class="main">⇒</span> rat vec<span class="main">)</span> <span class="free">gs</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> rows_gs_eq assms<span class="main">(</span>2<span class="main">)</span> card_m card_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map of_int_hom.vec_hom <span class="free">gs</span><span class="main">)</span> <span class="main">⊆</span> Rn"</span></span> <span class="keyword1"><span class="command">using</span></span> gs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gs.lin_indpt_list <span class="main">(</span>map of_int_hom.vec_hom <span class="free">gs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gs_lin_indpt_rows
        <span class="keyword1"><span class="command">unfolding</span></span> rows_gs_eq gs.lin_indpt_list_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Certification-gauss_jordan_integer_inverse"><span class="command">lemma</span></span> gauss_jordan_integer_inverse<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fs</span> <span class="free">gs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int vec list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">gs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> len_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">gs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">fs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> len_fs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> gauss<span class="main">:</span> <span class="quoted"><span class="quoted">"gauss_jordan_integer_inverse <span class="free">n</span> <span class="main">(</span>map_mat rat_of_int <span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">fs</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span>map_mat rat_of_int <span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">gs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"gauss_jordan_integer_inverse <span class="main">_</span> <span class="var">?fs</span> <span class="var">?gs</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">U</span><span class="main">.</span> <span class="bound">U</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span> <span class="main">∧</span> mat_of_rows <span class="free">n</span> <span class="free">gs</span> <span class="main">=</span> <span class="bound">U</span> <span class="main">*</span> mat_of_rows <span class="free">n</span> <span class="free">fs</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fs</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fs len_fs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> gs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gs</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gs len_gs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> gauss <span class="main">=</span> gauss<span class="main">[</span><span class="operator">unfolded</span> gauss_jordan_integer_inverse_def<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> gauss <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> gauss<span class="main">:</span> <span class="quoted"><span class="quoted">"gauss_jordan <span class="var">?fs</span> <span class="var">?gs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">,</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> int<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all is_int_rat <span class="main">(</span>concat <span class="main">(</span>mat_to_list <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> gauss <span class="main">=</span> gauss_jordan<span class="main">[</span><span class="operator">OF</span> fs' gs' gauss<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> gauss<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_mat int_of_rat <span class="skolem">A</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> gauss<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> A
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?fs</span> <span class="main">*</span> <span class="skolem">A</span> <span class="main">=</span> <span class="var">?gs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_mat int_of_rat <span class="skolem">A</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> map_mat of_int <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> int<span class="main">[</span><span class="operator">unfolded</span> list_all_iff<span class="main">]</span> A
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mat_to_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> id <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?gs</span> <span class="main">=</span> <span class="var">?fs</span> <span class="main">*</span> map_mat of_int <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_mat of_int <span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">fs</span> <span class="main">*</span> <span class="var">?A</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> of_int_hom.mat_hom_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> fs' A<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mat_of_cols <span class="free">n</span> <span class="free">fs</span> <span class="main">*</span> <span class="var">?A</span> <span class="main">=</span> mat_of_cols <span class="free">n</span> <span class="free">gs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> of_int_hom.mat_hom_inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">gs</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">=</span> <span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">fs</span> <span class="main">*</span> <span class="var">?A</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?U</span> <span class="main">*</span> <span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">fs</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transpose_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> fs' A<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">fs</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">=</span> mat_of_rows <span class="free">n</span> <span class="free">fs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fs len_fs <span class="keyword1"><span class="command">unfolding</span></span> mat_of_rows_def mat_of_cols_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">gs</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="main">=</span> mat_of_rows <span class="free">n</span> <span class="free">gs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> gs len_gs <span class="keyword1"><span class="command">unfolding</span></span> mat_of_rows_def mat_of_cols_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> U <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> 
  

<span class="keyword1" id="LLL_Certification-LLL_change_basis_mat_inverse"><span class="command">lemma</span></span> LLL_change_basis_mat_inverse<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">gs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> len'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">gs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"integer_equivalent <span class="free">n</span> <span class="free">fs_init</span> <span class="free">gs</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">gs</span> <span class="main">=</span> lattice_of <span class="free">fs_init</span>"</span></span> <span class="quoted"><span class="quoted">"LLL_with_assms <span class="free">n</span> <span class="free">m</span> <span class="free">gs</span> <span class="free">α</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> eq<span class="main">[</span><span class="operator">unfolded</span> integer_equivalent_def Let_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"gauss_jordan_integer_inverse <span class="free">n</span> <span class="main">(</span>of_int_hom.mat_hom <span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">fs_init</span><span class="main">)</span><span class="main">)</span>
   <span class="main">(</span>of_int_hom.mat_hom <span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">gs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"gauss_jordan_integer_inverse <span class="free">n</span> <span class="main">(</span>of_int_hom.mat_hom <span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">gs</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>of_int_hom.mat_hom <span class="main">(</span>mat_of_cols <span class="free">n</span> <span class="free">fs_init</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> len <span class="main">=</span> len<span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">=</span> <span class="free">n</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> gauss_jordan_integer_inverse<span class="main">[</span><span class="operator">OF</span> gs len' fs_init len 1<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">=</span> <span class="free">n</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"mat_of_rows <span class="free">n</span> <span class="free">gs</span> <span class="main">=</span> <span class="skolem">U</span> <span class="main">*</span> mat_of_rows <span class="free">n</span> <span class="free">fs_init</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> gauss_jordan_integer_inverse<span class="main">[</span><span class="operator">OF</span> fs_init len gs len' 2<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">=</span> <span class="free">n</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="keyword2"><span class="keyword">where</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"mat_of_rows <span class="free">n</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="skolem">V</span> <span class="main">*</span> mat_of_rows <span class="free">n</span> <span class="free">gs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> LLL_change_basis<span class="main">[</span><span class="operator">OF</span> gs len'<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">folded</span></span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">m</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">n</span></span>›</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> V<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> U<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> V<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> U<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">gs</span> <span class="main">=</span> lattice_of <span class="free">fs_init</span>"</span></span> <span class="quoted"><span class="quoted">"LLL_with_assms <span class="free">n</span> <span class="free">m</span> <span class="free">gs</span> <span class="free">α</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹External solvers must deliver a reduced basis and optionally two
  matrices to convert between the input and the reduced basis. These two
  matrices are mandatory if the input matrix is not a square matrix.›</span></span>
<span class="keyword1"><span class="command">consts</span></span> external_lll_solver <span class="main">::</span> <span class="quoted"><span class="quoted">"integer <span class="main">×</span> integer <span class="main">⇒</span> integer list list <span class="main">⇒</span> 
  integer list list <span class="main">×</span> <span class="main">(</span>integer list list <span class="main">×</span> integer list list<span class="main">)</span>option"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reduce_basis_external</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> int vec list <span class="main">⇒</span> int vec list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reduce_basis_external</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="keyword1">of</span> Nil <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Cons <span class="bound">f</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">let</span> 
    <span class="bound">rb</span> <span class="main">=</span> reduce_basis <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">;</span>
    <span class="bound">fsi</span> <span class="main">=</span> map <span class="main">(</span>map integer_of_int <span class="keyword1">o</span> list_of_vec<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">;</span>
    <span class="bound">n</span> <span class="main">=</span> dim_vec <span class="bound">f</span><span class="main">;</span>
    <span class="bound">m</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="keyword1">in</span> 
  <span class="keyword1">case</span> external_lll_solver <span class="main">(</span>map_prod integer_of_int integer_of_int <span class="main">(</span>quotient_of <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">fsi</span> <span class="keyword1">of</span> 
    <span class="main">(</span><span class="bound">gsi</span><span class="main">,</span> <span class="bound">co</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="keyword1">let</span> <span class="bound">gs</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>vec_of_list <span class="keyword1">o</span> map int_of_integer<span class="main">)</span> <span class="bound">gsi</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="main">¬</span> <span class="main">(</span>length <span class="bound">gs</span> <span class="main">=</span> <span class="bound">m</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">gi</span> <span class="main">∈</span> set <span class="bound">gs</span><span class="main">.</span> dim_vec <span class="bound">gi</span> <span class="main">=</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
      Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''error in external LLL invocation: dimensions of reduced basis do not fit⏎input to external solver: ''</span>
        <span class="main">+</span> String.implode <span class="main">(</span>show <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''⏎⏎''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">rb</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> 
       <span class="keyword1">case</span> <span class="bound">co</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">u1i</span><span class="main">,</span> <span class="bound">u2i</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">let</span> 
         <span class="bound">u1</span> <span class="main">=</span> mat_of_rows_list <span class="bound">m</span> <span class="main">(</span>map <span class="main">(</span>map int_of_integer<span class="main">)</span> <span class="bound">u1i</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">u2</span> <span class="main">=</span> mat_of_rows_list <span class="bound">m</span> <span class="main">(</span>map <span class="main">(</span>map int_of_integer<span class="main">)</span> <span class="bound">u2i</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">gs</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>vec_of_list <span class="keyword1">o</span> map int_of_integer<span class="main">)</span> <span class="bound">gsi</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">Fs</span> <span class="main">=</span> mat_of_rows <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">;</span>
         <span class="bound">Gs</span> <span class="main">=</span> mat_of_rows <span class="bound">n</span> <span class="bound">gs</span> <span class="keyword1">in</span> 
         <span class="keyword1">if</span> <span class="main">(</span>dim_row <span class="bound">u1</span> <span class="main">=</span> <span class="bound">m</span> <span class="main">∧</span> dim_col <span class="bound">u1</span> <span class="main">=</span> <span class="bound">m</span> <span class="main">∧</span> dim_row <span class="bound">u2</span> <span class="main">=</span> <span class="bound">m</span> <span class="main">∧</span> dim_col <span class="bound">u2</span> <span class="main">=</span> <span class="bound">m</span> 
             <span class="main">∧</span> <span class="bound">Fs</span> <span class="main">=</span> <span class="bound">u1</span> <span class="main">*</span> <span class="bound">Gs</span> <span class="main">∧</span> <span class="bound">Gs</span> <span class="main">=</span> <span class="bound">u2</span> <span class="main">*</span> <span class="bound">Fs</span><span class="main">)</span>
          <span class="keyword1">then</span> <span class="bound">rb</span> <span class="bound">gs</span>
          <span class="keyword1">else</span> Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''error in external lll invocation⏎f,g,u1,u2 are as follows⏎''</span>
            <span class="main">+</span> String.implode <span class="main">(</span>show <span class="bound">Fs</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''⏎⏎''</span>
            <span class="main">+</span> String.implode <span class="main">(</span>show <span class="bound">Gs</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''⏎⏎''</span>
            <span class="main">+</span> String.implode <span class="main">(</span>show <span class="bound">u1</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''⏎⏎''</span>
            <span class="main">+</span> String.implode <span class="main">(</span>show <span class="bound">u2</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''⏎⏎''</span>
            <span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">rb</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">)</span>
   <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="bound">n</span> <span class="main">=</span> <span class="bound">m</span> <span class="main">∧</span> integer_equivalent <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="bound">gs</span><span class="main">)</span> <span class="keyword1">then</span>
       <span class="bound">rb</span> <span class="bound">gs</span>
      <span class="keyword1">else</span> Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''error in external LLL invocation:⏎''</span> <span class="main">+</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="bound">m</span> <span class="keyword1">then</span> <span class="keyword1">STR</span> <span class="inner_quoted">''reduced matrix does not span same lattice''</span> <span class="keyword1">else</span> 
          <span class="keyword1">STR</span> <span class="inner_quoted">''no certificate only allowed for square matrices''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">rb</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">short_vector_external</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> int vec list <span class="main">⇒</span> int vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">short_vector_external</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span>hd <span class="main">(</span>reduce_basis_external <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">instance</span></span> bool <span class="main">::</span> <span class="quoted">prime_card</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> LLL_with_assms
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="LLL_Certification-reduce_basis_external"><span class="command">lemma</span></span> reduce_basis_external<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"reduce_basis_external <span class="free">α</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reduced <span class="free">fs</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">m</span> <span class="free">fs</span>"</span></span> 
  <span class="comment1">(* "lattice_of fs = lattice_of fs_init" is part of LLL_invariant *)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"LLL_Impl.reduce_basis <span class="free">α</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="free">fs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> reduce_basis<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fs_init</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">with</span></span> res <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> reduce_basis_external_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> False Nil <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LLL_Impl.reduce_basis_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f</span> <span class="skolem">rest</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons fs_init len <span class="keyword1"><span class="command">have</span></span> dim_fs_n<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="skolem">f</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ext</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"external_lll_solver <span class="main">(</span>map_prod integer_of_int integer_of_int <span class="main">(</span>quotient_of <span class="free">α</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">(</span>map <span class="main">(</span>map integer_of_int <span class="main">∘</span> list_of_vec<span class="main">)</span> <span class="free">fs_init</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> reduce_basis_external_def Cons Let_def list.case Code.abort_def dim_fs_n<span class="main">,</span>
          <span class="operator">folded</span> Cons<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> res False <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gsi</span></span> <span class="skolem"><span class="skolem">co</span></span> <span class="keyword2"><span class="keyword">where</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ext</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">gsi</span><span class="main">,</span> <span class="skolem">co</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?ext</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">gs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gs</span> <span class="main">=</span> map <span class="main">(</span>vec_of_list <span class="keyword1">o</span> map int_of_integer<span class="main">)</span> <span class="skolem">gsi</span>"</span></span> 
      <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> ext option.simps split len dim_fs_n<span class="main">,</span> <span class="operator">folded</span> gs_def<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> res False <span class="keyword1"><span class="command">have</span></span> not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="main">(</span>length <span class="skolem">gs</span> <span class="main">=</span> <span class="free">m</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">gi</span><span class="main">∈</span>set <span class="skolem">gs</span><span class="main">.</span> dim_vec <span class="bound">gi</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> False"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> this if_False<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> not <span class="keyword1"><span class="command">have</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">gs</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> 
         <span class="keyword2"><span class="keyword">and</span></span> len_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">gs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lattice_of <span class="skolem">gs</span> <span class="main">=</span> lattice_of <span class="free">fs_init</span> <span class="main">∧</span> LLL_with_assms <span class="free">n</span> <span class="free">m</span> <span class="skolem">gs</span> <span class="free">α</span> <span class="main">∧</span> LLL_Impl.reduce_basis <span class="free">α</span> <span class="skolem">gs</span> <span class="main">=</span> <span class="free">fs</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">co</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">pair</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> res Some <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u1i</span></span> <span class="skolem"><span class="skolem">u2i</span></span> <span class="keyword2"><span class="keyword">where</span></span> co<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">co</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">u1i</span><span class="main">,</span> <span class="skolem">u2i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">co</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u1</span> <span class="main">=</span> mat_of_rows_list <span class="free">m</span> <span class="main">(</span>map <span class="main">(</span>map int_of_integer<span class="main">)</span> <span class="skolem">u1i</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u2</span> <span class="main">=</span> mat_of_rows_list <span class="free">m</span> <span class="main">(</span>map <span class="main">(</span>map int_of_integer<span class="main">)</span> <span class="skolem">u2i</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> co option.simps split len dim_fs_n<span class="main">,</span> <span class="operator">folded</span> u1_def u2_def gs_def<span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> res False 
        <span class="keyword1"><span class="command">have</span></span> u1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u1</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> u2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u2</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> prod1<span class="main">:</span> <span class="quoted"><span class="quoted">"mat_of_rows <span class="free">n</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="skolem">u1</span> <span class="main">*</span> mat_of_rows <span class="free">n</span> <span class="skolem">gs</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> prod2<span class="main">:</span> <span class="quoted"><span class="quoted">"mat_of_rows <span class="free">n</span> <span class="skolem">gs</span> <span class="main">=</span> <span class="skolem">u2</span> <span class="main">*</span> mat_of_rows <span class="free">n</span> <span class="free">fs_init</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> gs_v<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.reduce_basis <span class="free">α</span> <span class="skolem">gs</span> <span class="main">=</span> <span class="free">fs</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> LLL_change_basis<span class="main">[</span><span class="operator">OF</span> gs len_gs u1 u2 prod1 prod2<span class="main">]</span> gs_v
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> None
        <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> None option.simps<span class="main">]</span> False
        <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">=</span> LLL_Impl.reduce_basis <span class="free">α</span> <span class="skolem">gs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">m</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"integer_equivalent <span class="free">n</span> <span class="free">fs_init</span> <span class="skolem">gs</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> LLL_change_basis_mat_inverse<span class="main">[</span><span class="operator">OF</span> gs len_gs<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">folded</span></span> nm<span class="main"><span class="main"><span class="main">]</span></span></span> nm<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> equiv<span class="main">]</span> id
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"lattice_of <span class="skolem">gs</span> <span class="main">=</span> lattice_of <span class="free">fs_init</span>"</span></span> 
         <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_with_assms <span class="free">n</span> <span class="free">m</span> <span class="skolem">gs</span> <span class="free">α</span>"</span></span>
         <span class="keyword2"><span class="keyword">and</span></span> gs_fs<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_Impl.reduce_basis <span class="free">α</span> <span class="skolem">gs</span> <span class="main">=</span> <span class="free">fs</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> LLL_with_assms.reduce_basis<span class="main">[</span><span class="operator">OF</span> assms gs_fs<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> red<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced <span class="free">fs</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL.LLL_invariant <span class="free">n</span> <span class="free">m</span> <span class="skolem">gs</span> <span class="free">α</span> True <span class="free">m</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> inv<span class="main">[</span><span class="operator">unfolded</span> LLL.LLL_invariant_def LLL.L_def id<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> lattice<span class="main">:</span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">fs</span> <span class="main">=</span> lattice_of <span class="free">fs_init</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI red lattice<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">m</span> <span class="free">fs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> LLL.LLL_invariant_def LLL.L_def id <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Certification-short_vector_external"><span class="command">lemma</span></span> short_vector_external<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"short_vector_external <span class="free">α</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> L <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> L <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> rat_of_int <span class="main">(</span>sq_norm <span class="free">v</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> rat_of_int <span class="main">(</span>sq_norm <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> red<span class="main">:</span> <span class="quoted"><span class="quoted">"reduce_basis_external <span class="free">α</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="skolem">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> short_vector_external_def red<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> hd <span class="skolem">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> reduce_basis_external<span class="main">[</span><span class="operator">OF</span> red<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> red<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced <span class="skolem">fs</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">m</span> <span class="skolem">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> basis_reduction_short_vector<span class="main">[</span><span class="operator">OF</span> inv v m0<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Unspecified constant to easily enable/disable external lll solver in generated code›</span></span>

<span class="keyword1"><span class="command">consts</span></span> enable_external_lll_solver <span class="main">::</span> <span class="quoted">bool</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">short_vector_hybrid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> int vec list <span class="main">⇒</span> int vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">short_vector_hybrid</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> enable_external_lll_solver <span class="keyword1">then</span> short_vector_external <span class="keyword1">else</span> short_vector<span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reduce_basis_hybrid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> int vec list <span class="main">⇒</span> int vec list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reduce_basis_hybrid</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> enable_external_lll_solver <span class="keyword1">then</span> reduce_basis_external <span class="keyword1">else</span> reduce_basis<span class="main">)</span>"</span></span> 


<span class="keyword1"><span class="command">context</span></span> LLL_with_assms
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="LLL_Certification-short_vector_hybrid"><span class="command">lemma</span></span> short_vector_hybrid<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"short_vector_hybrid <span class="free">α</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> L <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> L <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> rat_of_int <span class="main">(</span>sq_norm <span class="free">v</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> rat_of_int <span class="main">(</span>sq_norm <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> short_vector<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">v</span></span></span></span></span></span></span></span><span class="main">,</span> <span class="operator">OF</span> _ m0<span class="main">]</span> short_vector_external<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">v</span></span></span></span></span></span></span></span><span class="main">,</span> <span class="operator">OF</span> _ m0<span class="main">]</span>
    res<span class="main">[</span><span class="operator">unfolded</span> short_vector_hybrid_def<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="LLL_Certification-reduce_basis_hybrid"><span class="command">lemma</span></span> reduce_basis_hybrid<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"reduce_basis_hybrid <span class="free">α</span> <span class="free">fs_init</span> <span class="main">=</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reduced <span class="free">fs</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"LLL_invariant True <span class="free">m</span> <span class="free">fs</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> reduce_basis_external<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">fs</span></span></span></span><span class="main">]</span> reduce_basis<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">fs</span></span></span></span></span></span></span></span></span></span><span class="main">]</span> res<span class="main">[</span><span class="operator">unfolded</span> reduce_basis_hybrid_def<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1" id="LLL_Certification-lll_oracle_default_code"><span class="command">lemma</span></span> lll_oracle_default_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"external_lll_solver <span class="free">x</span> <span class="main">=</span> Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''no implementation of external_lll_solver specified''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> external_lll_solver <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹By default, external solvers are disabled.
  For enabling an external solver, load it via a separate theory like <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">🗏</span></span>‹FPLLL_Solver.thy›</span></span>›</span></span>

<span class="keyword1"><span class="command">overloading</span></span> enable_external_lll_solver <span class="main">≡</span> <span class="quoted">enable_external_lll_solver</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">enable_external_lll_solver</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">enable_external_lll_solver</span> <span class="main">=</span> False"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">short_vector_test_hybrid</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">ys</span> <span class="main">=</span> map <span class="main">(</span>vec_of_list <span class="keyword1">o</span> map int_of_integer<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
   <span class="keyword1">in</span> integer_of_int <span class="main">(</span>sq_norm <span class="main">(</span>short_vector_hybrid <span class="main">(</span><span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
 
<span class="comment1">(* export_code short_vector_test_hybrid in Haskell module_name LLL *)</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FPLLL_Solver">
<div class="head">
<h1>Theory FPLLL_Solver</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Sebastiaan Joosten
                René Thiemann
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A Haskell Interface to the FPLLL-Solver›</span></span>

<span class="keyword1"><span class="command">theory</span></span> FPLLL_Solver
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#LLL_Certification">LLL_Certification</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> external_lll_solver<span class="antiquote"><span class="antiquote">}</span></span></span></span> via an invocation of the fplll solver.
  For eta we use the default value of fplll, and delta is chosen so that 
  the required precision of alpha will be guaranteed. We use the command-line
  option -bvu in order to get the witnesses that are required for certification.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Warning: Since we only define a Haskell binding for FPLLL, 
  the target languages do no longer evaluate to the same results on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> short_vector_hybrid<span class="antiquote"><span class="antiquote">}</span></span></span></span>!›</span></span>

<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">code_module</span></span> <span class="quoted">"FPLLL_Solver"</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> 
<span class="quoted">‹module FPLLL_Solver where {

import System.Process (proc,createProcess,waitForProcess,CreateProcess(..),StdStream(..));
import System.IO.Unsafe (unsafePerformIO);
import System.IO (stderr,hPutStrLn,hPutStr,hClose);
import Data.ByteString.Lazy (hPut,hGetContents,intercalate,ByteString);
import Data.ByteString.Lazy.Char8 (pack,unpack,uncons,cons);
import GHC.IO.Exception (ExitCode(ExitSuccess));
import Data.Char (isNumber, isSpace);
import GHC.IO.Handle (hSetBinaryMode,hSetBuffering,BufferMode(BlockBuffering));
import Control.Exception;
import Data.IORef;

fplll_command :: String;
fplll_command = "fplll";

default_eta :: Double;
default_eta = 0.51;

alpha_to_delta :: (Integer,Integer) -&gt; Double;
alpha_to_delta (num,denom) = (fromIntegral denom / fromIntegral num) + 
  (default_eta * default_eta);

showrow :: [Integer] -&gt; ByteString;
showrow rowA = (pack "[") `mappend` intercalate (pack " ") (map (pack . show) rowA) `mappend` (pack "]");
showmat :: [[Integer]] -&gt; ByteString;
showmat matA = (pack "[") `mappend` intercalate (pack "\n ") (map showrow matA) `mappend` (pack "]");

data Mode = Simple | Certificate;

flags :: Mode -&gt; String;
flags Simple = "b";
flags Certificate = "bvu";

getMode xs = (let m = length xs in if m == 0 then Certificate
  else if m == length (head xs) then Simple else Certificate);

fplll_solver :: (Integer,Integer) -&gt; [[Integer]] -&gt; ([[Integer]], Maybe ([[Integer]],[[Integer]]));
fplll_solver alpha in_mat = unsafePerformIO $ catchE $ do {
  (Just f_in,Just f_out,Just f_err,f_pid) &lt;- createProcess (proc fplll_command ["-e", show default_eta, "-d", show (alpha_to_delta alpha), "-of", flags mode]){std_in = CreatePipe, std_err = CreatePipe, std_out = CreatePipe};
  hSetBinaryMode f_in True;
  hSetBinaryMode f_out True;
  hSetBinaryMode f_err True;
  hSetBuffering f_out (BlockBuffering Nothing);
  hPut f_in (showmat in_mat);
  res &lt;- hGetContents f_out;
  hClose f_in;
  parseRes res}
 where {
   mode = getMode in_mat;
   catchE m = catch m def;
   def :: SomeException -&gt; IO ([[Integer]], Maybe ([[Integer]], [[Integer]]));
   def _ = seq sendError $ default_answer;
   unconsIO a = case uncons a of{
      Just b -&gt; return b;
      _ -&gt; abort "Unexpected end of file / input"};
   parseMat ('[',as)
    = do {
      (h0,rem0) &lt;- parseSpaces =&lt;&lt; unconsIO as;
      (rows,(h1,rem1)) &lt;- parseRows (h0,rem0);
      case seq rows h1 of{
        ']' -&gt; return (rows,rem1);
        _ -&gt; abort$ "Expecting closing ']' while parsing a matrix.\n"}
      } :: IO ([[Integer]], ByteString);
   parseMat _ = abort "Expecting opening '[' while parsing a matrix";
   parseRows ('[',rem0)
    = do {
     (nums,(h2,rem2))&lt;-parseNums =&lt;&lt; parseSpaces =&lt;&lt; unconsIO rem0;
     case seq nums h2 of
       ']' -&gt; do { (h4,rem4) &lt;- parseSpaces =&lt;&lt; unconsIO rem2;
                   (rows,rem5) &lt;- parseRows (h4,rem4);
                   return (nums:rows,rem5) }
       _ -&gt; abort$ "Expecting closing ']' while parsing a row\n"
       } :: IO ([[Integer]],(Char, ByteString));
   parseRows r = return ([],r);
   parseNums (a,rem0) =
     (if isNumber a || a == '-' then do {
       (n,(h1,rem1)) &lt;- parseNum =&lt;&lt; unconsIO rem0;
       rem2 &lt;- parseSpaces (h1,rem1);
       num &lt;- return (read (a:n));
       (nums,rem3) &lt;- seq (num==num)$ parseNums rem2;
       return (seq nums $ num:nums,rem3) }
     else if isSpace a then do {
       rem1 &lt;- parseSpaces (a,rem0);
       parseNums rem1}
     else return ([],(a, rem0))) :: IO ([Integer], (Char, ByteString));
   parseNum (a,rem0) =
     if isNumber a then do {
       (num,rem1) &lt;- parseNum =&lt;&lt; unconsIO rem0;
       return (a:num,rem1) 
       }
     else return (mempty,(a,rem0));
   parseSpaces (a,as) = if isSpace a then case uncons as of { Nothing -&gt; return (a,mempty); Just v -&gt; parseSpaces v } else return (a,as);
   parseRes :: ByteString -&gt; IO ([[Integer]], Maybe ([[Integer]], [[Integer]]));
   parseRes res = if res == mempty
       then default_answer
       else do {
         rem0' &lt;- parseSpaces =&lt;&lt; unconsIO res;
         (m1,rem1) &lt;- parseMat rem0';
         -- putStrLn "Parsed a matrix";
         case mode of 
           Simple -&gt; return (m1, Nothing);
           _ -&gt; do {
             rem1' &lt;- parseSpaces =&lt;&lt; unconsIO rem1;
             (m2,rem2) &lt;- seq m1$ parseMat rem1';
             -- putStrLn "Parsed a matrix";
             rem2' &lt;- parseSpaces =&lt;&lt; unconsIO rem2;
             (m3,rem3) &lt;- seq m2$ parseMat rem2';
             seq m3$ return ();
             -- putStrLn "Parsed a matrix";
             if rem3 /= mempty
                then do { (_,rem2') &lt;- parseSpaces =&lt;&lt; unconsIO rem3;
                          if rem2' /= mempty
                             then abort "Unexpected output after parsing three matrices."
                             else return (m1, Just (m2,m3)) }
                else return (m1,Just (m2,m3))
                }
        };
   fail_to_execute = seq sendError default_answer;
   
   default_answer = -- not small enough, but it'll be accepted
     return (in_mat, case mode of Simple -&gt; Nothing; _ -&gt; Just (id_ofsize (length in_mat),id_ofsize (length in_mat)));
   abort str = error$ "Runtime exception in parsing fplll output:\n"++str;
   };
   

sendError :: (); -- bad trick using unsafeIO to make this error only appear once. I believe this is OK since the error is non-critical and the 'only appear once' is non-critical too.
sendError = unsafePerformIO $ do {
  hPutStrLn stderr "--- WARNING ---";
  hPutStrLn stderr "Failed to run fplll.";
  hPutStrLn stderr "To remove this warning, either:";
  hPutStrLn stderr "  - install fplll and ensure it is in your path.";
  hPutStrLn stderr "  - create an executable fplll that always returns successfully without generating output.";
  hPutStrLn stderr "Installing fplll correctly helps to reduce time spent verifying your certificate.";
  hPutStrLn stderr "--- END OF WARNING ---"
  };

id_ofsize :: Int -&gt; [[Integer]];
id_ofsize n = [[if i == j then 1 else 0 | j &lt;- [0..n-1]] | i &lt;- [0..n-1]];
}›</span>

<span class="keyword1"><span class="command">code_reserved</span></span> Haskell FPLLL_Solver fplll_solver

<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">external_lll_solver</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"FPLLL'_Solver.fplll'_solver"</span>
<span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">enable_external_lll_solver</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"True"</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that since we only enabled the external LLL solver for Haskell, the result of 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> short_vector_hybrid<span class="antiquote"><span class="antiquote">}</span></span></span></span> will usually differ when executed in Haskell in
  comparison to any of the other target languages. For instance, consider the 
  invocation of:›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="main">(</span>code<span class="main">)</span> <span class="quoted"><span class="quoted">"short_vector_test_hybrid <span class="main">[</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">4903</span><span class="main">,</span><span class="numeral">4902</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="numeral">39023</span><span class="main">,</span><span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">39023</span><span class="main">]</span><span class="main">]</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The above value-command evaluates the expression in Eval/SML to 77714 (by computing
  a short vector solely by the verified <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> short_vector<span class="antiquote"><span class="antiquote">}</span></span></span></span> algorithm, whereas
  the generated Haskell-code via the external LLL solver yields 60414!›</span></span>

<span class="comment1">(* export_code short_vector_test_hybrid in Haskell module_name LLL *)</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>