<div id="HOModel">
<div class="head">
<h1>Theory HOModel</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> HOModel
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> if_split_asm <span class="main">[</span><span class="operator">split</span><span class="main">]</span> <span class="comment1">― ‹perform default perform case splitting on conditionals›</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Heard-Of Algorithms›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Consensus Problem›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We are interested in the verification of fault-tolerant distributed algorithms.
  The Consensus problem is paradigmatic in this area. Stated
  informally, it assumes that all processes participating in the algorithm
  initially propose some value, and that they may at some point decide some value.
  It is required that every process eventually decides, and that all processes
  must decide the same value.

  More formally, we represent runs of algorithms as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ω›</span></span></span></span>-sequences of
  configurations (vectors of process states). Hence, a run is modeled as
  a function of type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nat ⇒ 'proc ⇒ 'pst›</span></span></span></span> where type variables 
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'proc›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'pst›</span></span></span></span> represent types of processes and process
  states, respectively. The Consensus property is expressed with respect
  to a collection <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vals›</span></span></span></span> of initially proposed values (one per process) 
  and an observer function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dec::'pst ⇒ val option›</span></span></span></span> that retrieves the decision
  (if any) from a process state. The Consensus problem is stated as the conjunction
  of the following properties:
  \begin{description}
  \item[Integrity.] Processes can only decide initially proposed values.
  \item[Agreement.] Whenever processes <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> decide,
    their decision values must be the same. (In particular, process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>
    may never change the value it decides, which is referred to as Irrevocability.)
  \item[Termination.] Every process decides eventually.
  \end{description}

  The above properties are sometimes only required of non-faulty processes, since
  nothing can be required of a faulty process.
  The Heard-Of model does not attribute faults to processes, and therefore the
  above formulation is appropriate in this framework.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span><span class="tfree">'pst</span><span class="main">)</span> run <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'pst</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">consensus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'val</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'pst</span> <span class="main">⇒</span> <span class="tfree">'val</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span><span class="tfree">'pst</span><span class="main">)</span> run <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">consensus</span> <span class="free"><span class="bound"><span class="entity">vals</span></span></span> <span class="free"><span class="bound"><span class="entity">dec</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">dec</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∈</span> range <span class="free"><span class="bound"><span class="entity">vals</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">m</span> <span class="bound">n</span> <span class="bound">p</span> <span class="bound">q</span> <span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">dec</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">m</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">dec</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span> 
         <span class="main">⟶</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">w</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">dec</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A variant of the Consensus problem replaces the Integrity requirement by
  \begin{description}
  \item[Validity.] If all processes initially propose the same value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>
    then every process may only decide <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>.
  \end{description}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">weak_consensus</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">weak_consensus</span> <span class="free"><span class="bound"><span class="entity">vals</span></span></span> <span class="free"><span class="bound"><span class="entity">dec</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">vals</span></span></span> <span class="bound">p</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">p</span> <span class="bound">w</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">dec</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span> <span class="main">⟶</span> <span class="bound">w</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">m</span> <span class="bound">n</span> <span class="bound">p</span> <span class="bound">q</span> <span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">dec</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">m</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">dec</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span> 
         <span class="main">⟶</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">w</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">dec</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Clearly, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>consensus›</span></span></span></span> implies <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>weak_consensus›</span></span></span></span>.
›</span></span>

<span class="keyword1" id="HOModel-consensus_then_weak_consensus"><span class="command">lemma</span></span> consensus_then_weak_consensus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consensus <span class="free">vals</span> <span class="free">dec</span> <span class="free">rho</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weak_consensus <span class="free">vals</span> <span class="free">dec</span> <span class="free">rho</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> consensus_def weak_consensus_def image_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Over Boolean values (``binary Consensus''), <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>weak_consensus›</span></span></span></span>
  implies <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>consensus›</span></span></span></span>, hence the two problems are equivalent.
  In fact, this theorem holds more generally whenever at most two
  different values are proposed initially (i.e., <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>card (range vals) ≤ 2›</span></span></span></span>).
›</span></span>

<span class="keyword1" id="HOModel-binary_weak_consensus_then_consensus"><span class="command">lemma</span></span> binary_weak_consensus_then_consensus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bc<span class="main">:</span> <span class="quoted"><span class="quoted">"weak_consensus <span class="main">(</span><span class="free">vals</span><span class="main">::</span><span class="tfree">'proc</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="free">dec</span> <span class="free">rho</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consensus <span class="free">vals</span> <span class="free">dec</span> <span class="free">rho</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="comment1">― ‹Show the Integrity property, the other conjuncts are the same.›</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> range <span class="free">vals</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">vals</span> <span class="bound">p</span> <span class="main">=</span> <span class="bound">w</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">vals</span> <span class="bound">p</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">with</span></span> bc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span>Some <span class="skolem">w</span><span class="main">,</span> None<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> weak_consensus_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> dec w <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="comment1">― ‹In this case both possible values occur in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"vals"</span><span class="antiquote">}</span></span>, and the result is trivial.›</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> integrity <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> bc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> consensus_def weak_consensus_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integrity<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The algorithms that we are going to verify solve the Consensus or weak Consensus
  problem, under different hypotheses about the kinds and number of faults.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A Generic Representation of Heard-Of Algorithms›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Charron-Bost and Schiper~\cite{charron:heardof} introduce
  the Heard-Of (HO) model for representing fault-tolerant
  distributed algorithms. In this model, algorithms execute in communication-closed
  rounds: at any round~$r$, processes only receive messages that were sent for
  that round. For every process~$p$ and round~$r$, the ``heard-of set'' $HO(p,r)$
  denotes the set of processes from which~$p$ receives a message in round~$r$.
  Since every process is assumed to send a message to all processes in each round,
  the complement of $HO(p,r)$ represents the set of faults that may affect~$p$ in
  round~$r$ (messages that were not received, e.g. because the sender crashed,
  because of a network problem etc.).

  The HO model expresses hypotheses on the faults tolerated by an algorithm
  through ``communication predicates'' that constrain the sets $HO(p,r)$
  that may occur during an execution. Charron-Bost and Schiper show that
  standard fault models can be represented in this form.

  The original HO model is sufficient for representing algorithms
  tolerating benign failures such as process crashes or message loss. A later
  extension for algorithms tolerating Byzantine (or value) failures~\cite{biely:tolerating} 
  adds a second collection of sets $SHO(p,r) \subseteq HO(p,r)$ that contain those
  processes $q$ from which process $p$ receives the message that $q$ was indeed
  supposed to send for round $r$ according to the algorithm. In other words, 
  messages from processes in $HO(p,r) \setminus SHO(p,r)$ were corrupted, be it
  due to errors during message transmission or because of the sender was faulty or
  lied deliberately. For both benign and Byzantine errors, the HO model registers
  the fault but does not try to identify the faulty component (i.e., designate the
  sending or receiving process, or the communication channel as the ``culprit'').

  Executions of HO algorithms are defined with respect to collections
  $HO(p,r)$ and $SHO(p,r)$. However, the code of a process does not have
  access to these sets. In particular, process $p$ has no way of determining
  if a message it received from another process $q$ corresponds to what $q$
  should have sent or if it has been corrupted.

  Certain algorithms rely on the assignment of ``coordinator'' processes for
  each round. Just as the collections $HO(p,r)$, the definitions assume an
  external coordinator assignment such that $coord(p,r)$ denotes the coordinator
  of process $p$ and round $r$. Again, the correctness of algorithms may depend
  on hypotheses about coordinator assignments -- e.g., it may be assumed that
  processes agree sufficiently often on who the current coordinator is.

  The following definitions provide a generic representation of HO and SHO algorithms
  in Isabelle/HOL. A (coordinated) HO algorithm is described by the following parameters:
  \begin{itemize}
  \item a finite type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'proc›</span></span></span></span> of processes,
  \item a type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'pst›</span></span></span></span> of local process states,
  \item a type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'msg›</span></span></span></span> of messages sent in the course of the algorithm,
  \item a predicate <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>CinitState›</span></span></span></span> such that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>CinitState p st crd›</span></span></span></span> is
    true precisely of the initial states <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>st›</span></span></span></span> of process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>, assuming
    that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>crd›</span></span></span></span> is the initial coordinator of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>,
  \item a function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sendMsg›</span></span></span></span> where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sendMsg r p q st›</span></span></span></span> yields
    the message that process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> sends to process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> at round
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>, given its local state <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>st›</span></span></span></span>, and
  \item a predicate <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>CnextState›</span></span></span></span> where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>CnextState r p st msgs crd st'›</span></span></span></span>
    characterizes the successor states <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>st'›</span></span></span></span> of process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> at round
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>, given current state <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>st›</span></span></span></span>, the vector
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>msgs :: 'proc ⇒ 'msg option›</span></span></span></span> of messages that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> received at
    round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>msgs q = None›</span></span></span></span> indicates that no message has been
    received from process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span>),
    and process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>crd›</span></span></span></span> as the coordinator for the following round.
  \end{itemize}
  Note that every process can store the coordinator for the current round in its
  local state, and it is therefore not necessary to make the coordinator a parameter
  of the message sending function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sendMsg›</span></span></span></span>.

  We represent an algorithm by a record as follows.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'pst</span><span class="main">,</span> <span class="tfree">'msg</span><span class="main">)</span> CHOAlgorithm <span class="main">=</span>
  CinitState <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'pst</span> <span class="main">⇒</span> <span class="tfree">'proc</span> <span class="main">⇒</span> bool"</span></span>
  sendMsg <span class="main">::</span>   <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'pst</span> <span class="main">⇒</span> <span class="tfree">'msg</span>"</span></span>
  CnextState <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'pst</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'msg</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'pst</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For non-coordinated HO algorithms, the coordinator argument of functions
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>CinitState›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>CnextState›</span></span></span></span> is irrelevant, and we
  define utility functions that omit that argument.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isNCAlgorithm</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isNCAlgorithm</span> <span class="free"><span class="bound"><span class="entity">alg</span></span></span> <span class="main">≡</span> 
      <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">st</span> <span class="bound">crd</span> <span class="bound">crd'</span><span class="main">.</span> CinitState <span class="free"><span class="bound"><span class="entity">alg</span></span></span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">crd</span> <span class="main">=</span> CinitState <span class="free"><span class="bound"><span class="entity">alg</span></span></span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">crd'</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span> <span class="bound">crd'</span> <span class="bound">st'</span><span class="main">.</span> CnextState <span class="free"><span class="bound"><span class="entity">alg</span></span></span> <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span> <span class="bound">st'</span>
                               <span class="main">=</span> CnextState <span class="free"><span class="bound"><span class="entity">alg</span></span></span> <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd'</span> <span class="bound">st'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">initState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">initState</span> <span class="free"><span class="bound"><span class="entity">alg</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> CinitState <span class="free"><span class="bound"><span class="entity">alg</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> undefined"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nextState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nextState</span> <span class="free"><span class="bound"><span class="entity">alg</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span> CnextState <span class="free"><span class="bound"><span class="entity">alg</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> undefined <span class="free"><span class="bound"><span class="entity">st'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A \emph{heard-of assignment} associates a set of processes with each
  process. The following type is used to represent the collections $HO(p,r)$
  and $SHO(p,r)$ for fixed round $r$.
%
  Similarly, a \emph{coordinator assignment} associates a process (its coordinator)
  to each process.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="tfree">'proc</span> HO <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'proc</span> set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="tfree">'proc</span> coord <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'proc</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An execution of an HO algorithm is defined with respect to HO and SHO
  assignments that indicate, for every round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> and every process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>,
  from which sender processes <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> receives messages (resp., uncorrupted
  messages) at round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>.

%% That's the intention, but we don't enforce this in the definitions.
%  Obviously, SHO sets are always included in HO sets, for the same process and round.

  The following definitions formalize this idea. We define ``coarse-grained''
  executions whose unit of atomicity is the round of execution. At each round,
  the entire collection of processes performs a transition according to the
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>CnextState›</span></span></span></span> function of the algorithm. Consequently, a system state is
  simply described by a configuration, i.e. a function assigning a process state
  to every process. This definition of executions may appear surprising for an
  asynchronous distributed system, but it simplifies system verification,
  compared to a ``fine-grained'' execution model that records individual events
  such as message sending and reception or local transitions. We will justify
  later why the ``coarse-grained'' model is sufficient for verifying interesting
  correctness properties of HO algorithms.

  The predicate <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>CSHOinitConfig›</span></span></span></span> describes the possible initial configurations
  for algorithm <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span> (remember that a configuration is a function that assigns
  local states to every process).
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CHOinitConfig</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CHOinitConfig</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">coord</span></span></span><span class="main">::</span><span class="tfree">'proc</span> coord<span class="main">)</span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> CinitState <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">p</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">coord</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given the current configuration <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>cfg›</span></span></span></span> and the HO and SHO sets <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>HOp›</span></span></span></span>
  and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SHOp›</span></span></span></span> for process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> at round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>, the function
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SHOmsgVectors›</span></span></span></span> computes the set of possible vectors of messages that
  process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> may receive. For processes <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q ∉ HOp›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> 
  receives no message (represented as value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>None›</span></span></span></span>). For processes
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q ∈ SHOp›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> receives the message that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> computed
  according to the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sendMsg›</span></span></span></span> function of the algorithm. For the remaining
  processes <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q ∈ HOp - SHOp›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> may receive some arbitrary value.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SHOmsgVectors</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SHOmsgVectors</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">HOp</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOp</span></span></span> <span class="main">≡</span>
   <span class="main">{</span><span class="bound">μ</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">HOp</span></span></span> <span class="main">⟷</span> <span class="bound">μ</span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">)</span>
     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">SHOp</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">HOp</span></span></span> <span class="main">⟶</span> <span class="bound">μ</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>sendMsg <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Predicate <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>CSHOnextConfig›</span></span></span></span> uses the preceding function and the algorithm's
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>CnextState›</span></span></span></span> function to characterize the possible successor configurations
  in a coarse-grained step, and predicate <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>CSHORun›</span></span></span></span> defines (coarse-grained)
  executions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rho›</span></span></span></span> of an HO algorithm.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CSHOnextConfig</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CSHOnextConfig</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="free"><span class="bound"><span class="entity">coord</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg'</span></span></span> <span class="main">≡</span>
   <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">μ</span> <span class="main">∈</span> SHOmsgVectors <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span>
          CnextState <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">p</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="bound">μ</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">coord</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cfg'</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CSHORun</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CSHORun</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">coords</span></span></span> <span class="main">≡</span>
     CHOinitConfig <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">coords</span></span></span> <span class="main">0</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> CSHOnextConfig <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">r</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">coords</span></span></span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
                             <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For non-coordinated algorithms. the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>coord›</span></span></span></span> arguments of the above functions
  are irrelevant. We define similar functions that omit that argument, and relate
  them to the above utility functions for these algorithms.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HOinitConfig</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HOinitConfig</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">≡</span> CHOinitConfig <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> undefined<span class="main">)</span>"</span></span>

<span class="keyword1" id="HOModel-HOinitConfig_eq"><span class="command">lemma</span></span> HOinitConfig_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HOinitConfig <span class="free">A</span> <span class="free">cfg</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> initState <span class="free">A</span> <span class="bound">p</span> <span class="main">(</span><span class="free">cfg</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOinitConfig_def CHOinitConfig_def initState_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SHOnextConfig</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SHOnextConfig</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg'</span></span></span> <span class="main">≡</span>
   CSHOnextConfig <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> undefined<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cfg'</span></span></span>"</span></span>

<span class="keyword1" id="HOModel-SHOnextConfig_eq"><span class="command">lemma</span></span> SHOnextConfig_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SHOnextConfig <span class="free">A</span> <span class="free">r</span> <span class="free">cfg</span> <span class="free">HO</span> <span class="free">SHO</span> <span class="free">cfg'</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">μ</span> <span class="main">∈</span> SHOmsgVectors <span class="free">A</span> <span class="free">r</span> <span class="bound">p</span> <span class="free">cfg</span> <span class="main">(</span><span class="free">HO</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHO</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span>
             nextState <span class="free">A</span> <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">μ</span> <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHOnextConfig_def CSHOnextConfig_def SHOmsgVectors_def nextState_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SHORun</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SHORun</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="main">≡</span>
   CSHORun <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">q</span><span class="main">.</span> undefined<span class="main">)</span>"</span></span>

<span class="keyword1" id="HOModel-SHORun_eq"><span class="command">lemma</span></span> SHORun_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SHORun <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="main">=</span>
     <span class="main">(</span>HOinitConfig <span class="free">A</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> SHOnextConfig <span class="free">A</span> <span class="bound">r</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHORun_def CSHORun_def HOinitConfig_def SHOnextConfig_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Algorithms designed to tolerate benign failures are not subject to
  message corruption, and therefore the SHO sets are irrelevant (more formally,
  each SHO set equals the corresponding HO set). We define corresponding
  special cases of the definitions of successor configurations and of runs,
  and prove that these are equivalent to simpler definitions that will be more
  useful in proofs. In particular, the vector of messages received by a process
  in a benign execution is uniquely determined from the current configuration
  and the HO sets.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HOrcvdMsgs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HOrcvdMsgs</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">≡</span>
   <span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span>sendMsg <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None"</span></span>

<span class="keyword1" id="HOModel-SHOmsgVectors_HO"><span class="command">lemma</span></span> SHOmsgVectors_HO<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SHOmsgVectors <span class="free">A</span> <span class="free">r</span> <span class="free">p</span> <span class="free">cfg</span> <span class="free">HO</span> <span class="free">HO</span> <span class="main">=</span> <span class="main">{</span>HOrcvdMsgs <span class="free">A</span> <span class="free">r</span> <span class="free">p</span> <span class="free">HO</span> <span class="free">cfg</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SHOmsgVectors_def HOrcvdMsgs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹With coordinators›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CHOnextConfig</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CHOnextConfig</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">coord</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg'</span></span></span> <span class="main">≡</span> 
   CSHOnextConfig <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">coord</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg'</span></span></span>"</span></span>

<span class="keyword1" id="HOModel-CHOnextConfig_eq"><span class="command">lemma</span></span> CHOnextConfig_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"CHOnextConfig <span class="free">A</span> <span class="free">r</span> <span class="free">cfg</span> <span class="free">HO</span> <span class="free">coord</span> <span class="free">cfg'</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> CnextState <span class="free">A</span> <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>HOrcvdMsgs <span class="free">A</span> <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">HO</span> <span class="bound">p</span><span class="main">)</span> <span class="free">cfg</span><span class="main">)</span> 
                   <span class="main">(</span><span class="free">coord</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> CHOnextConfig_def CSHOnextConfig_def SHOmsgVectors_HO<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CHORun</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CHORun</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">coords</span></span></span> <span class="main">≡</span> CSHORun <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">coords</span></span></span>"</span></span>

<span class="keyword1" id="HOModel-CHORun_eq"><span class="command">lemma</span></span> CHORun_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"CHORun <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span> <span class="main">=</span> 
     <span class="main">(</span>CHOinitConfig <span class="free">A</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">coords</span> <span class="main">0</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> CHOnextConfig <span class="free">A</span> <span class="bound">r</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> CHORun_def CSHORun_def CHOinitConfig_def CHOnextConfig_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Without coordinators›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HOnextConfig</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HOnextConfig</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg'</span></span></span> <span class="main">≡</span> SHOnextConfig <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg'</span></span></span>"</span></span>

<span class="keyword1" id="HOModel-HOnextConfig_eq"><span class="command">lemma</span></span> HOnextConfig_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HOnextConfig <span class="free">A</span> <span class="free">r</span> <span class="free">cfg</span> <span class="free">HO</span> <span class="free">cfg'</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> nextState <span class="free">A</span> <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>HOrcvdMsgs <span class="free">A</span> <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">HO</span> <span class="bound">p</span><span class="main">)</span> <span class="free">cfg</span><span class="main">)</span> <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOnextConfig_def SHOnextConfig_eq SHOmsgVectors_HO<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HORun</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HORun</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">≡</span> SHORun <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span>"</span></span>

<span class="keyword1" id="HOModel-HORun_eq"><span class="command">lemma</span></span> HORun_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HORun <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="main">=</span> 
   <span class="main">(</span>  HOinitConfig <span class="free">A</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> HOnextConfig <span class="free">A</span> <span class="bound">r</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HORun_def SHORun_eq HOnextConfig_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following derived proof rules are immediate consequences of
  the definition of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>CHORun›</span></span></span></span>; they simplify automatic reasoning.
›</span></span>

<span class="keyword1" id="HOModel-CHORun_0"><span class="command">lemma</span></span> CHORun_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"CHORun <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cfg</span><span class="main">.</span> CHOinitConfig <span class="free">A</span> <span class="bound">cfg</span> <span class="main">(</span><span class="free">coords</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">cfg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> CHORun_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="HOModel-CHORun_Suc"><span class="command">lemma</span></span> CHORun_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"CHORun <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> CHOnextConfig <span class="free">A</span> <span class="bound">r</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
            <span class="main">⟹</span> <span class="free">P</span> <span class="bound">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> CHORun_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="HOModel-CHORun_induct"><span class="command">lemma</span></span> CHORun_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"CHOinitConfig <span class="free">A</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">coords</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P</span> <span class="bound">r</span><span class="main">;</span> CHOnextConfig <span class="free">A</span> <span class="bound">r</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span><span class="main">)</span> 
                                      <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> run <span class="keyword1"><span class="command">unfolding</span></span> CHORun_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> init step<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Because algorithms will not operate for arbitrary HO, SHO, and coordinator
  assignments, these are constrained by a \emph{communication predicate}.
  For convenience, we split this predicate into a \emph{per Round} part that
  is expected to hold at every round and a \emph{global} part that must hold
  of the sequence of (S)HO assignments and may thus express liveness assumptions.

  In the parlance of~\cite{charron:heardof}, a \emph{HO machine} is an HO algorithm
  augmented with a communication predicate. We therefore define (C)(S)HO machines as
  the corresponding extensions of the record defining an HO algorithm.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'pst</span><span class="main">,</span> <span class="tfree">'msg</span><span class="main">)</span> HOMachine <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'pst</span><span class="main">,</span> <span class="tfree">'msg</span><span class="main">)</span> CHOAlgorithm"</span></span> <span class="main">+</span>
  HOcommPerRd<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> HO <span class="main">⇒</span> bool"</span></span>
  HOcommGlobal<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> HO<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'pst</span><span class="main">,</span> <span class="tfree">'msg</span><span class="main">)</span> CHOMachine <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'pst</span><span class="main">,</span> <span class="tfree">'msg</span><span class="main">)</span> CHOAlgorithm"</span></span> <span class="main">+</span>
  CHOcommPerRd<span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'proc</span> HO <span class="main">⇒</span> <span class="tfree">'proc</span> coord <span class="main">⇒</span> bool"</span></span>
  CHOcommGlobal<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> HO<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> coord<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'pst</span><span class="main">,</span> <span class="tfree">'msg</span><span class="main">)</span> SHOMachine <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'pst</span><span class="main">,</span> <span class="tfree">'msg</span><span class="main">)</span> CHOAlgorithm"</span></span> <span class="main">+</span>
  SHOcommPerRd<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'proc</span> HO<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'proc</span> HO<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  SHOcommGlobal<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> HO<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> HO<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'pst</span><span class="main">,</span> <span class="tfree">'msg</span><span class="main">)</span> CSHOMachine <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'pst</span><span class="main">,</span> <span class="tfree">'msg</span><span class="main">)</span> CHOAlgorithm"</span></span> <span class="main">+</span>
  CSHOcommPerRd<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'proc</span> HO<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'proc</span> HO<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'proc</span> coord <span class="main">⇒</span> bool"</span></span>
  CSHOcommGlobal<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> HO<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> HO<span class="main">)</span>
                                     <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> coord<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">― ‹theory HOModel›</span>
</pre>
</div><div id="Reduction">
<div class="head">
<h1>Theory Reduction</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Reduction
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#HOModel">HOModel</a> <a href="../../stuttering_equivalence/theories/#StutterEquivalence">Stuttering_Equivalence.StutterEquivalence</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Reduction Theorem›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We have defined the semantics of HO algorithms such that rounds are executed
  atomically, by all processes. This definition is surprising for a model of
  asynchronous distributed algorithms since it models a synchronous execution
  of rounds. However, it simplifies representing and reasoning about the algorithms. 
  For example, the communication network does not have to be modeled explicitly,
  since the possible sets of messages received by processes can be computed
  from the global configuration and the collections of HO and SHO sets.

  We will now define a more conventional ``fine-grained'' semantics where
  communication is modeled explicitly and rounds of processes can be arbitrarily
  interleaved (subject to the constraints of the communication predicates).
  We will then establish a \emph{reduction theorem} that shows that for every
  fine-grained run there exists an equivalent round-based (``coarse-grained'')
  run in the sense that the two runs exhibit the same sequences of local states
  of all processes, modulo stuttering. We prove the reduction theorem for the
  most general class of coordinated SHO algorithms. It is easy to see that the
  theorem equally holds for the special cases of uncoordinated or HO algorithms,
  and since we have in fact defined these classes of algorithms from the more
  general ones, we can directly apply the general theorem.

  As a corollary, interesting properties remain valid in the fine-grained semantics
  if they hold in the coarse-grained semantics. It is therefore enough to
  verify such properties in the coarse-grained semantics, which is much easier
  to reason about. The essential restriction is that properties may not depend
  on states of different processes occurring simultaneously. (For example, the
  coarse-grained semantics ensures by definition that all processes execute the
  same round at any instant, which is obviously not true of the fine-grained
  semantics.) We claim that all ``reasonable'' properties of fault-tolerant
  distributed algorithms are preserved by our reduction. For example, the
  Consensus (and Weak Consensus) problems fall into this class.

  The proofs follow Chaouch-Saad et al.~\cite{saad:reduction}, where the
  reduction theorem was proved for uncoordinated HO algorithms.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Fine-Grained Semantics›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In the fine-grained semantics, a run of an HO algorithm is represented
  as an $\omega$-sequence of system configurations. Each configuration 
  is represented as a record carrying the following information:
  \begin{itemize}
  \item for every process $p$, the current round that process $p$ is executing,
  \item the local state of every process,
  \item for every process $p$, the set of processes to which $p$ has already
    sent a message for the current round,
  \item for all processes $p$ and $q$, the message (if any) that $p$ has
    received from $q$ for the round that $p$ is currently executing, and
  \item the set of messages in transit, represented as triples of the form
    $(p,r,q,m)$ meaning that process $p$ sent message $m$ to process $q$
    for round $r$, but $q$ has not yet received that message.
  \end{itemize}

  As explained earlier, the coordinators of processes are not recorded in
  the configuration, but algorithms may record them as part of the process states.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'pst</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'msg</span><span class="main">)</span> config <span class="main">=</span>
  round <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> <span class="main">⇒</span> nat"</span></span>
  state <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'pst</span>"</span></span>
  sent  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'proc</span> set"</span></span>
  rcvd  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'msg</span> option"</span></span>
  network <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="tfree">'proc</span> <span class="main">*</span> nat <span class="main">*</span> <span class="tfree">'proc</span> <span class="main">*</span> <span class="tfree">'msg</span><span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'pst</span> <span class="main">,</span><span class="tfree">'proc</span> <span class="main">,</span> <span class="tfree">'msg</span><span class="main">)</span> fgrun <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'pst</span><span class="main">,</span> <span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'msg</span><span class="main">)</span> config"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In an initial configuration for an algorithm, the local state of every process
  satisfies the algorithm's initial-state predicate, and all other components
  have obvious default values.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fg_init_config</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fg_init_config</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">config</span></span></span><span class="main">::</span><span class="main">(</span><span class="tfree">'pst</span><span class="main">,</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'msg</span><span class="main">)</span> config<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">coord</span></span></span><span class="main">::</span><span class="tfree">'proc</span> coord<span class="main">)</span> <span class="main">≡</span>
     round <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> CinitState <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">p</span> <span class="main">(</span>state <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">coord</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> sent <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span>
   <span class="main">∧</span> rcvd <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> None<span class="main">)</span>
   <span class="main">∧</span> network <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In the fine-grained semantics, we have three types of transitions due to
  \begin{itemize}
  \item some process sending a message,
  \item some process receiving a message, and
  \item some process executing a local transition.
  \end{itemize}

  The following definition models process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> sending a message to
  process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span>. The transition is enabled if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> has not yet
  sent any message to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> for the current round. The message to be
  sent is computed according to the algorithm's <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sendMsg›</span></span></span></span> function. 
  The effect of the transition is to add <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> to the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sent›</span></span></span></span>
  component of the configuration and the message quadruple to the
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>network›</span></span></span></span> component.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fg_send_msg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fg_send_msg</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">config'</span></span></span> <span class="main">≡</span>
     <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∉</span> <span class="main">(</span>sent <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">config'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="main">⦇</span> 
        sent <span class="main">:=</span> <span class="main">(</span>sent <span class="free"><span class="bound"><span class="entity">config</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">(</span>sent <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">,</span>
        network <span class="main">:=</span> network <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="main">∪</span>
                   <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> round <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span>
                     sendMsg <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>round <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">(</span>state <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following definition models the reception of a message by process
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> from process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span>. The action is enabled if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span>
  is in the heard-of set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>HO›</span></span></span></span> of process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> for the current
  round, and if the network contains some message from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> to
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> for the round that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> is currently executing.
  W.l.o.g., we model message corruption at reception: if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> is not
  in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>'s SHO set (parameter <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SHO›</span></span></span></span>), then an arbitrary value
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m'›</span></span></span></span> is received instead of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fg_rcv_msg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fg_rcv_msg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">config'</span></span></span> <span class="main">≡</span> 
   <span class="main">∃</span><span class="bound">m</span> <span class="bound">m'</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="main">(</span>round <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> network <span class="free"><span class="bound"><span class="entity">config</span></span></span>
     <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span>
     <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">config'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="main">⦇</span>
          rcvd <span class="main">:=</span> <span class="main">(</span>rcvd <span class="free"><span class="bound"><span class="entity">config</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">(</span>rcvd <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">:=</span> 
                    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="keyword1">then</span> Some <span class="bound">m</span> <span class="keyword1">else</span> Some <span class="bound">m'</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          network <span class="main">:=</span> network <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="main">(</span>round <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">}</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Finally, we consider local state transition of process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>. 
  A local transition is enabled only after <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> has sent all messages
  for its current round and has received all messages that it is supposed
  to receive according to its current HO set (parameter <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>HO›</span></span></span></span>). The
  local state is updated according to the algorithm's <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>CnextState›</span></span></span></span> 
  relation, which may depend on the coordinator <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>crd›</span></span></span></span> of the following
  round. The round of process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> is incremented, and the
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sent›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rcvd›</span></span></span></span> components for process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> are
  reset to initial values for the new round.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fg_local</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fg_local</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">config'</span></span></span> <span class="main">≡</span>
     sent <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> UNIV
   <span class="main">∧</span> dom <span class="main">(</span>rcvd <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> CnextState <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>round <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>state <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>rcvd <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="bound">s</span>
        <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">config'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="main">⦇</span>
             round <span class="main">:=</span> <span class="main">(</span>round <span class="free"><span class="bound"><span class="entity">config</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> Suc <span class="main">(</span>round <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
             state <span class="main">:=</span> <span class="main">(</span>state <span class="free"><span class="bound"><span class="entity">config</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="bound">s</span><span class="main">)</span><span class="main">,</span>
             sent <span class="main">:=</span> <span class="main">(</span>sent <span class="free"><span class="bound"><span class="entity">config</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">{}</span><span class="main">)</span><span class="main">,</span>
             rcvd <span class="main">:=</span> <span class="main">(</span>rcvd <span class="free"><span class="bound"><span class="entity">config</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">λ</span><span class="bound">q</span><span class="main">.</span> None<span class="main">)</span> <span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The next-state relation for process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> is just the disjunction of
  the above three types of transitions.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fg_next_config</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fg_next_config</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">config'</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> fg_send_msg <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">config'</span></span></span><span class="main">)</span>
   <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> fg_rcv_msg <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">config'</span></span></span><span class="main">)</span>
   <span class="main">∨</span> fg_local <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="free"><span class="bound"><span class="entity">config</span></span></span> <span class="free"><span class="bound"><span class="entity">config'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Fine-grained runs are infinite sequences of configurations that start
  in an initial configuration and where each step corresponds to some process
  sending a message, receiving a message or performing a local step. We also
  require that every process eventually executes every round -- note that
  this condition is implicit in the definition of coarse-grained runs.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fg_run</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fg_run</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">coords</span></span></span> <span class="main">≡</span>
      fg_init_config <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">coords</span></span></span> <span class="main">0</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> fg_next_config <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">p</span> 
                                    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">(</span>round <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
                                    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="main">(</span>round <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
                                    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">coords</span></span></span> <span class="main">(</span>round <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
                                    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">r</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> round <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">n</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following function computes at which ``time point'' (index in the
  fine-grained computation) process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> starts executing round 
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>. This function plays an important role in the correspondence
  between the two semantics, and in the subsequent proofs.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fg_start_round</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fg_start_round</span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="keyword1">LEAST</span> <span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> round <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">n</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of the Fine-Grained Semantics›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In preparation for the proof of the reduction theorem, we establish a
  number of consequences of the above definitions.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Process states change only when round numbers change during a
  fine-grained run.
›</span></span>
<span class="keyword1" id="Reduction-fg_state_change"><span class="command">lemma</span></span> fg_state_change<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> rd<span class="main">:</span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> round <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"state <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> state <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> rho <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p'</span><span class="main">.</span> fg_next_config <span class="free">A</span> <span class="bound">p'</span> <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="bound">p'</span><span class="main">)</span> <span class="bound">p'</span><span class="main">)</span> 
                                          <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="bound">p'</span><span class="main">)</span> <span class="bound">p'</span><span class="main">)</span>
                                          <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="bound">p'</span><span class="main">)</span> <span class="bound">p'</span><span class="main">)</span> 
                                          <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_run_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> rd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_next_config_def fg_send_msg_def fg_rcv_msg_def fg_local_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Round numbers never decrease.
›</span></span>
<span class="keyword1" id="Reduction-fg_round_numbers_increase"><span class="command">lemma</span></span> fg_round_numbers_increase<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> round <span class="main">(</span><span class="free">rho</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> n <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span><span class="main">+</span><span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_iff_add<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> rho <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p'</span><span class="main">.</span> fg_next_config <span class="free">A</span> <span class="bound">p'</span> <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="bound">p'</span><span class="main">)</span> <span class="bound">p'</span><span class="main">)</span>
                                              <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="bound">p'</span><span class="main">)</span> <span class="bound">p'</span><span class="main">)</span>
                                              <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">p'</span><span class="main">)</span> <span class="bound">p'</span><span class="main">)</span>
                                              <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_run_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_next_config_def fg_send_msg_def fg_rcv_msg_def fg_local_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> k <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Combining the two preceding lemmas, it follows that the local states
  of process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> at two configurations are the same if these 
  configurations have the same round number.
›</span></span>
<span class="keyword1" id="Reduction-fg_same_round_same_state"><span class="command">lemma</span></span> fg_same_round_same_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> rd<span class="main">:</span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> round <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"state <span class="main">(</span><span class="free">rho</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> state <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> round <span class="main">(</span><span class="free">rho</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span> 
          <span class="main">⟹</span> state <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> state <span class="main">(</span><span class="free">rho</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="var">?S</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">j</span> <span class="main">⟹</span> <span class="var">?S</span> <span class="skolem">j</span>"</span></span> 
         <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> round <span class="main">(</span><span class="free">rho</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> rho <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> fg_round_numbers_increase<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> rho <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> fg_round_numbers_increase<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 1 2 r <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> round <span class="main">(</span><span class="free">rho</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> r <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> rho <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> state <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> fg_state_change<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> 3 ih <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> aux <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span><span class="main">+</span><span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_iff_add<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> rd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> aux<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">m</span><span class="main">+</span><span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_iff_add<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> rd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> aux<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Since every process executes every round, function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fg_startRound›</span></span></span></span>
  is well-defined. We also list a few facts about <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fg_startRound›</span></span></span></span> that
  will be used to show that it is a ``stuttering sampling function'',
  a notion introduced in the theories about stuttering equivalence.
›</span></span>
<span class="keyword1" id="Reduction-fg_start_round"><span class="command">lemma</span></span> fg_start_round<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fg_run <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_run_def fg_start_round_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> LeastI_ex<span class="main">)</span>

<span class="keyword1" id="Reduction-fg_start_round_smallest"><span class="command">lemma</span></span> fg_start_round_smallest<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="free">k</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="free">r</span> <span class="main">≤</span> <span class="main">(</span><span class="free">k</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fg_start_round_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Least_le<span class="main">)</span>

<span class="keyword1" id="Reduction-fg_start_round_later"><span class="command">lemma</span></span> fg_start_round_later<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="free">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="free">r'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">&lt;</span> <span class="var">?start</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?start</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> rho this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="var">?start</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> round <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fg_round_numbers_increase<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> r <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">≤</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fg_start_round<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rho<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> r' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Reduction-fg_start_round_0"><span class="command">lemma</span></span> fg_start_round_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> rho <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_run_def fg_init_config_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="main">0</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fg_start_round_smallest<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Reduction-fg_start_round_strict_mono"><span class="command">lemma</span></span> fg_start_round_strict_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span>fg_start_round <span class="free">rho</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">r'</span>
  <span class="keyword3"><span class="command">assume</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">r'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> rho <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fg_start_round<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> rho this r <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="skolem">r</span> <span class="main">&lt;</span> fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="skolem">r'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fg_start_round_later<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> is at round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> at all configurations between 
  the start of round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> and the start of round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r+1›</span></span></span></span>.
  By lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fg_same_round_same_state›</span></span></span></span>, this implies that the
  local state of process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> is the same at all these configurations.
›</span></span>
<span class="keyword1" id="Reduction-fg_round_between_start_rounds"><span class="command">lemma</span></span> fg_round_between_start_rounds<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="free">r</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rd</span> <span class="main">=</span> <span class="free">r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> <span class="var">?rd</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fg_round_numbers_increase<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rho<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> <span class="var">?rd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fg_start_round<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rho<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rd</span> <span class="main">≤</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">r</span> <span class="main">≤</span> <span class="var">?rd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="var">?rd</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rho<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> fg_start_round_strict_mono<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> strict_mono_mono<span class="main"><span class="main">,</span></span> 
                   <span class="operator">THEN</span> monoD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fg_start_round_smallest<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> 2
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For any process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> and round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> there is some instant <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span>
  where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> executes a local transition from round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>. In fact,
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n+1›</span></span></span></span> marks the start of round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r+1›</span></span></span></span>.
›</span></span>
<span class="keyword1" id="Reduction-fg_local_transition_from_round"><span class="command">lemma</span></span> fg_local_transition_from_round<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span>
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fg_local <span class="free">A</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?start</span> <span class="main">≠</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?start</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> rho <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="var">?start</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Suc <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fg_start_round<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> contr rho <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_run_def fg_init_config_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?start</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gr0_conv_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> fg_start_round<span class="main">[</span><span class="operator">OF</span> rho<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">r</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Suc <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fg_round_between_start_rounds<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rho<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="free">r</span> <span class="main">&lt;</span> fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fg_start_round_strict_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rho<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> strict_monoD<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> n <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="free">r</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> n <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="var">?start</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> rho <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"fg_next_config <span class="free">A</span> <span class="skolem">p'</span> <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span>
                         <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span>
                         <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span>
                         <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"fg_next_config <span class="main">_</span> <span class="main">_</span> <span class="var">?HO</span> <span class="var">?SHO</span> <span class="var">?crd</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_run_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fg_local <span class="free">A</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_next_config_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fg_send_msg <span class="free">A</span> <span class="skolem">p'</span> <span class="skolem">q</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span>
      <span class="comment1">― ‹impossible because round changes›</span>
    <span class="keyword1"><span class="command">with</span></span> 0 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_send_msg_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fg_rcv_msg <span class="skolem">p'</span> <span class="skolem">q</span> <span class="var">?HO</span> <span class="var">?SHO</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span>
      <span class="comment1">― ‹impossible because round changes›</span>
    <span class="keyword1"><span class="command">with</span></span> 0 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_rcv_msg_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fg_local <span class="free">A</span> <span class="skolem">p'</span> <span class="var">?HO</span> <span class="var">?crd</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 0 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="free">p</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_local_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> 1 n that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now prove two invariants asserted in \cite{saad:reduction}. The first
  one states that any message <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m›</span></span></span></span> in transit from process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>
  to process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> for round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> corresponds to the message
  computed by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span>, given <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>'s state at its
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>th local transition.
›</span></span>

<span class="keyword1" id="Reduction-fg_invariant1"><span class="command">lemma</span></span> fg_invariant1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">r</span><span class="main">,</span><span class="free">q</span><span class="main">,</span><span class="free">m</span><span class="main">)</span> <span class="main">∈</span> network <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?msg</span> <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> sendMsg <span class="free">A</span> <span class="free">r</span> <span class="free">p</span> <span class="free">q</span> <span class="main">(</span>state <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="comment1">― ‹the base case is trivial because the network is empty›</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?msg</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> rho <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_run_def fg_init_config_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> m'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?msg</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?msg</span> <span class="skolem">n</span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> rho <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"fg_next_config <span class="free">A</span> <span class="skolem">p'</span> <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span> 
                         <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span>
                         <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span>
                         <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"fg_next_config <span class="main">_</span> <span class="main">_</span> <span class="var">?HO</span> <span class="var">?SHO</span> <span class="var">?crd</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_run_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_next_config_def<span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹
      Only <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fg_send_msg›</span></span></span></span> transitions for process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> are interesting,
      since all other transitions cannot add a message for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>, hence we can
      apply the induction hypothesis.
›</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q'</span>
    <span class="keyword3"><span class="command">assume</span></span> send<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_send_msg <span class="free">A</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?msg</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> send m' <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"round <span class="var">?cfg</span> <span class="free">p</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
                    <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> sendMsg <span class="free">A</span> <span class="free">r</span> <span class="free">p</span> <span class="free">q</span> <span class="main">(</span>state <span class="var">?cfg</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_send_msg_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> rho 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state <span class="var">?cfg</span> <span class="free">p</span> <span class="main">=</span> state <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_start_round fg_same_round_same_state<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fg_rcv_msg <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="var">?HO</span> <span class="var">?SHO</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> m' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?msg</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_rcv_msg_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fg_local <span class="free">A</span> <span class="skolem">p'</span> <span class="var">?HO</span> <span class="var">?crd</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> m' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?msg</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_local_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The second invariant states that if process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> received message
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m›</span></span></span></span> from process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>, then (a) <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> is in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span>'s
  HO set for that round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m›</span></span></span></span>, and (b) if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> is moreover in
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span>'s SHO set, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m›</span></span></span></span> is the message that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> computed
  at the start of that round.
›</span></span>

<span class="keyword1" id="Reduction-fg_invariant2a"><span class="command">lemma</span></span> fg_invariant2a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"rcvd <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">m</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rcvd</span> <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="main">(</span><span class="var">?rd</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="comment1">― ‹The base case is trivial because <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">q</span><span class="antiquote">}</span></span> has not received any message initially›</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rcvd</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> rho <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_run_def fg_init_config_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> rcvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rcvd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rcvd</span> <span class="skolem">n</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="skolem">n</span>"</span></span>
  <span class="comment1">― ‹For the inductive step we distinguish the possible transitions›</span>
  <span class="keyword1"><span class="command">from</span></span> rho <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"fg_next_config <span class="free">A</span> <span class="skolem">p'</span> <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span> 
                         <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span>
                         <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span>
                         <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"fg_next_config <span class="main">_</span> <span class="main">_</span> <span class="var">?HO</span> <span class="var">?SHO</span> <span class="var">?crd</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_run_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_next_config_def<span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹
      Except for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fg_rcv_msg›</span></span></span></span> steps of process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span>, the proof
      is immediately reduced to the induction hypothesis.
›</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q'</span>
    <span class="keyword3"><span class="command">assume</span></span> rcvmsg<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_rcv_msg <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="var">?HO</span> <span class="var">?SHO</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> rd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="var">?rd</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_rcv_msg_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?rcvd</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> ih rd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> rcvd rcvmsg rd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_rcv_msg_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fg_send_msg <span class="free">A</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> rcvd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rcvd</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="var">?rd</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_send_msg_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fg_local <span class="free">A</span> <span class="skolem">p'</span> <span class="var">?HO</span> <span class="var">?crd</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> rcvd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rcvd</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="var">?rd</span> <span class="skolem">n</span>"</span></span>
      <span class="comment1">― ‹in fact, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"p' = q"</span><span class="antiquote">}</span></span> is impossible because the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">rcvd</span><span class="antiquote">}</span></span> field of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">p'</span><span class="antiquote">}</span></span> is cleared›</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_local_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Reduction-fg_invariant2b"><span class="command">lemma</span></span> fg_invariant2b<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"rcvd <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">m</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rcvd</span> <span class="free">n</span>"</span></span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">and</span></span> sho<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span><span class="var">?rd</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> sendMsg <span class="free">A</span> <span class="main">(</span><span class="var">?rd</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span> 
                     <span class="main">(</span>state <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>fg_start_round <span class="free">rho</span> <span class="free">p</span> <span class="main">(</span><span class="var">?rd</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> m sho <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="comment1">― ‹The base case is trivial because <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">q</span><span class="antiquote">}</span></span> has not received any message initially›</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rcvd</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> rho <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_run_def fg_init_config_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> rcvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rcvd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span><span class="var">?rd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rcvd</span> <span class="skolem">n</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span><span class="var">?rd</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">q</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="skolem">n</span>"</span></span>
  <span class="comment1">― ‹For the inductive step we again distinguish the possible transitions›</span>
  <span class="keyword1"><span class="command">from</span></span> rho <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"fg_next_config <span class="free">A</span> <span class="skolem">p'</span> <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span>
                         <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span>
                         <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span>
                         <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"fg_next_config <span class="main">_</span> <span class="main">_</span> <span class="var">?HO</span> <span class="var">?SHO</span> <span class="var">?crd</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_run_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_next_config_def<span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹
      Except for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fg_rcv_msg›</span></span></span></span> steps of process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span>, the proof
      is immediately reduced to the induction hypothesis.
›</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q'</span>
    <span class="keyword3"><span class="command">assume</span></span> rcvmsg<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_rcv_msg <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="var">?HO</span> <span class="var">?SHO</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> rd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="var">?rd</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_rcv_msg_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?rcvd</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> ih p rd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> rcvmsg <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="skolem"><span class="skolem">m''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> round <span class="var">?cfg</span> <span class="skolem">p'</span><span class="main">,</span> <span class="skolem">p'</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">∈</span> network <span class="var">?cfg</span>"</span></span>
        <span class="quoted"><span class="quoted">"rcvd <span class="var">?cfg'</span> <span class="main">=</span> <span class="main">(</span>rcvd <span class="var">?cfg</span><span class="main">)</span><span class="main">(</span><span class="skolem">p'</span> <span class="main">:=</span> <span class="main">(</span>rcvd <span class="var">?cfg</span> <span class="skolem">p'</span><span class="main">)</span><span class="main">(</span><span class="skolem">q'</span> <span class="main">:=</span> 
                          <span class="keyword1">if</span> <span class="skolem">q'</span> <span class="main">∈</span> <span class="var">?SHO</span> <span class="keyword1">then</span> Some <span class="skolem">m'</span> <span class="keyword1">else</span> Some <span class="skolem">m''</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_rcv_msg_def <span class="quasi_keyword">split</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> False rcvd p rd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="var">?rd</span> <span class="skolem">n</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> network <span class="var">?cfg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> rho rd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_invariant1<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fg_send_msg <span class="free">A</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> rcvd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rcvd</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="var">?rd</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_send_msg_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> p ih <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fg_local <span class="free">A</span> <span class="skolem">p'</span> <span class="var">?HO</span> <span class="var">?crd</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> rcvd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rcvd</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="var">?rd</span> <span class="skolem">n</span>"</span></span>
      <span class="comment1">― ‹in fact, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"p' = q"</span><span class="antiquote">}</span></span> is impossible because the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">rcvd</span><span class="antiquote">}</span></span> field of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">p'</span><span class="antiquote">}</span></span> is cleared›</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_local_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> p ih <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹From Fine-Grained to Coarse-Grained Runs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The reduction theorem asserts that for any fine-grained run <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rho›</span></span></span></span>
  there is a coarse-grained run such that every process sees the same
  sequence of local states in the two runs, modulo stuttering. In other words,
  no process can locally distinguish the two runs.

  Given fine-grained run <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rho›</span></span></span></span>, the corresponding coarse-grained run <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sigma›</span></span></span></span> is 
  defined as the sequence of state vectors at the beginning of every round. 
  Notice in particular that the local states <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sigma r p›</span></span></span></span> and 
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sigma r q›</span></span></span></span> of two different processes <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span>
  appear at different instants in the original run <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rho›</span></span></span></span>. Nevertheless,
  we prove that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sigma›</span></span></span></span> is a coarse-grained run of the algorithm for
  the same HO, SHO, and coordinator assignments. By definition (and the
  fact that local states remain equal between <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fg_start_round›</span></span></span></span>
  instants), the sequences of process states in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rho›</span></span></span></span> and
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sigma›</span></span></span></span> are easily seen to be stuttering equivalent, and this
  will be formally stated below.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">coarse_run</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">coarse_run</span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> state <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">(</span>fg_start_round <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> reduction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CSHORun <span class="free">A</span> <span class="main">(</span>coarse_run <span class="free">rho</span><span class="main">)</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"CSHORun <span class="main">_</span> <span class="var">?cr</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> CSHORun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> rho <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"CHOinitConfig <span class="free">A</span> <span class="main">(</span><span class="var">?cr</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">coords</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_run_def fg_init_config_def CHOinitConfig_def 
                   coarse_run_def fg_start_round_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rho<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"CSHOnextConfig <span class="free">A</span> <span class="skolem">r</span> <span class="main">(</span><span class="var">?cr</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>
                       <span class="main">(</span><span class="var">?cr</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CSHOnextConfig_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">from</span></span> rho<span class="main">[</span><span class="operator">THEN</span> fg_local_transition_from_round<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_start_round <span class="free">rho</span> <span class="skolem">p</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?start</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">and</span></span> loc<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_local <span class="free">A</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
                 <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"fg_local <span class="main">_</span> <span class="main">_</span> <span class="var">?HO</span> <span class="var">?crd</span> <span class="var">?cfg</span> <span class="var">?cfg'</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> cfg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cr</span> <span class="skolem">r</span> <span class="skolem">p</span> <span class="main">=</span> state <span class="var">?cfg</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> coarse_run_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fg_same_round_same_state<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rho<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> n <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>fg_start_round <span class="free">rho</span> <span class="skolem">p</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> round <span class="var">?cfg</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fg_start_round<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rho<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> start <span class="keyword1"><span class="command">have</span></span> cfg'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cr</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> state <span class="var">?cfg'</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coarse_run_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> rcvd<span class="main">:</span> <span class="quoted"><span class="quoted">"rcvd <span class="var">?cfg</span> <span class="skolem">p</span> <span class="main">∈</span> SHOmsgVectors <span class="free">A</span> <span class="skolem">r</span> <span class="skolem">p</span> <span class="main">(</span><span class="var">?cr</span> <span class="skolem">r</span><span class="main">)</span> <span class="var">?HO</span> <span class="main">(</span><span class="free">SHOs</span> <span class="skolem">r</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHOmsgVectors_def<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="var">?HO</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> n loc <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span><span class="main">.</span> rcvd <span class="var">?cfg</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="bound">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_local_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">m</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rcvd <span class="var">?cfg</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> rho n <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="var">?HO</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_invariant2a<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> sho<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="skolem">r</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ho<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="var">?HO</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> ho n loc <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rcvd <span class="var">?cfg</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_local_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> rho n sho <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rcvd <span class="var">?cfg</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span>sendMsg <span class="free">A</span> <span class="skolem">r</span> <span class="skolem">q</span> <span class="skolem">p</span> <span class="main">(</span><span class="var">?cr</span> <span class="skolem">r</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_invariant2b coarse_run_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> n loc cfg cfg'
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">μ</span> <span class="main">∈</span> SHOmsgVectors <span class="free">A</span> <span class="skolem">r</span> <span class="skolem">p</span> <span class="main">(</span><span class="var">?cr</span> <span class="skolem">r</span><span class="main">)</span> <span class="var">?HO</span> <span class="main">(</span><span class="free">SHOs</span> <span class="skolem">r</span> <span class="skolem">p</span><span class="main">)</span><span class="main">.</span>
             CnextState <span class="free">A</span> <span class="skolem">r</span> <span class="skolem">p</span> <span class="main">(</span><span class="var">?cr</span> <span class="skolem">r</span> <span class="skolem">p</span><span class="main">)</span> <span class="bound">μ</span> <span class="var">?crd</span> <span class="main">(</span><span class="var">?cr</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_local_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Locally Similar Runs and Local Properties›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We say that two sequences of configurations (vectors of process states)
  are \emph{locally similar} if for every process the sequences of its
  process states are stuttering equivalent. Observe that different stuttering
  reduction may be applied for every process, hence the original sequences of
  configurations need not be stuttering equivalent and can indeed differ
  wildly in the combinations of local states that occur.

  A property of a sequence of configurations is called \emph{local} if it
  is insensitive to local similarity.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locally_similar</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">locally_similar</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">::</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'pst</span><span class="main">)</span>  <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">≡</span> 
   <span class="main">∀</span><span class="bound">p</span><span class="main">::</span><span class="tfree">'proc</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">local_property</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">local_property</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span>
   <span class="main">∀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> locally_similar <span class="bound">σ</span> <span class="bound">τ</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">σ</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">τ</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Local similarity is an equivalence relation.
›</span></span>

<span class="keyword1" id="Reduction-locally_similar_refl"><span class="command">lemma</span></span> locally_similar_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"locally_similar <span class="free">σ</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_similar_def stutter_equiv_refl<span class="main">)</span>

<span class="keyword1" id="Reduction-locally_similar_sym"><span class="command">lemma</span></span> locally_similar_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"locally_similar <span class="free">σ</span> <span class="free">τ</span> <span class="main">⟹</span> locally_similar <span class="free">τ</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_similar_def stutter_equiv_sym<span class="main">)</span>

<span class="keyword1" id="Reduction-locally_similar_trans"><span class="command">lemma</span></span> locally_similar_trans <span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"locally_similar <span class="free">ρ</span> <span class="free">σ</span> <span class="main">⟹</span> locally_similar <span class="free">σ</span> <span class="free">τ</span> <span class="main">⟹</span> locally_similar <span class="free">ρ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_similar_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> stutter_equiv_trans<span class="main">)</span>

<span class="keyword1" id="Reduction-local_property_eq"><span class="command">lemma</span></span> local_property_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"local_property <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> locally_similar <span class="bound">σ</span> <span class="bound">τ</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">P</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> local_property_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> locally_similar_sym<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Consider any fine-grained run <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rho›</span></span></span></span>. The projection of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rho›</span></span></span></span>
  to vectors of process states is locally similar to the coarse-grained run
  computed from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rho›</span></span></span></span>.
›</span></span>

<span class="keyword1" id="Reduction-coarse_run_locally_similar"><span class="command">lemma</span></span> coarse_run_locally_similar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_similar <span class="main">(</span>state <span class="main">∘</span> <span class="free">rho</span><span class="main">)</span> <span class="main">(</span>coarse_run <span class="free">rho</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> locally_similar_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> state <span class="main">(</span><span class="free">rho</span> <span class="bound">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> coarse_run <span class="free">rho</span> <span class="bound">n</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fgr</span> <span class="main">≈</span> <span class="var">?cgr</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equivI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="main">(</span>fg_start_round <span class="free">rho</span> <span class="skolem">p</span><span class="main">)</span> <span class="var">?fgr</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stutter_sampler_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> rho <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fg_start_round <span class="free">rho</span> <span class="skolem">p</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fg_start_round_0<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span>fg_start_round <span class="free">rho</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fg_start_round_strict_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rho<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">n</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fg_start_round <span class="free">rho</span> <span class="skolem">p</span> <span class="skolem">r</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> fg_start_round <span class="free">rho</span> <span class="skolem">p</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> rho <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"round <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> round <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>fg_start_round <span class="free">rho</span> <span class="skolem">p</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fg_start_round fg_round_between_start_rounds<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> rho <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"state <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> state <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>fg_start_round <span class="free">rho</span> <span class="skolem">p</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fg_same_round_same_state<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stutter_sampler id <span class="var">?cgr</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> id_stutter_sampler<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fgr</span> <span class="main">∘</span> fg_start_round <span class="free">rho</span> <span class="skolem">p</span> <span class="main">=</span> <span class="var">?cgr</span> <span class="main">∘</span> id"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coarse_run_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Therefore, in order to verify a local property <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> for a
  fine-grained run over given <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>HO›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SHO›</span></span></span></span>, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>coord›</span></span></span></span>
  collections, it is enough to show that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> holds for all
  coarse-grained runs for these same collections.
  Indeed, one may restrict attention to coarse-grained runs whose 
  initial states agree with that of the given fine-grained run.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> local_property_reduction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run <span class="free">A</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"local_property <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> coarse_correct<span class="main">:</span> 
            <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">crho</span><span class="main">.</span> <span class="main">⟦</span> CSHORun <span class="free">A</span> <span class="bound">crho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span><span class="main">;</span> <span class="bound">crho</span> <span class="main">0</span> <span class="main">=</span> state <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span><span class="main">⟧</span>
                      <span class="main">⟹</span> <span class="free">P</span> <span class="bound">crho</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>state <span class="main">∘</span> <span class="free">rho</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coarse_run <span class="free">rho</span> <span class="main">0</span> <span class="main">=</span> state <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coarse_run_def fg_start_round_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rho<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> rho<span class="main">[</span><span class="operator">THEN</span> reduction<span class="main">]</span> this 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>coarse_run <span class="free">rho</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> coarse_correct<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> coarse_run_locally_similar<span class="main">[</span><span class="operator">OF</span> rho<span class="main">]</span> P 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> local_property_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Consensus as a Local Property›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Consensus and Weak Consensus are local properties and can therefore
  be verified just over coarse-grained runs, according to theorem
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>local_property_reduction›</span></span></span></span>.
›</span></span>

<span class="keyword1" id="Reduction-integrity_is_local"><span class="command">lemma</span></span> integrity_is_local<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"locally_similar <span class="free">σ</span> <span class="free">τ</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">dec</span> <span class="main">(</span><span class="free">σ</span> <span class="bound">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> range <span class="free">vals</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="main">(</span><span class="free">τ</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> range <span class="free">vals</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> sim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">τ</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_similar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">m</span> <span class="free">p</span> <span class="main">=</span> <span class="free">τ</span> <span class="free">n</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equiv_element_left<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sym<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> dec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> val<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Reduction-validity_is_local"><span class="command">lemma</span></span> validity_is_local<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"locally_similar <span class="free">σ</span> <span class="free">τ</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">dec</span> <span class="main">(</span><span class="free">σ</span> <span class="bound">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="main">(</span><span class="free">τ</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> sim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">τ</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_similar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">m</span> <span class="free">p</span> <span class="main">=</span> <span class="free">τ</span> <span class="free">n</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equiv_element_left<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sym<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> dec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> val<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Reduction-agreement_is_local"><span class="command">lemma</span></span> agreement_is_local<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"locally_similar <span class="free">σ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> agr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">n</span><span class="main">.</span> <span class="main">⟦</span><span class="free">dec</span> <span class="main">(</span><span class="free">σ</span> <span class="bound">m</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">;</span> <span class="free">dec</span> <span class="main">(</span><span class="free">σ</span> <span class="bound">n</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">v</span><span class="main">=</span><span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="main">(</span><span class="free">τ</span> <span class="free">m</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="main">(</span><span class="free">τ</span> <span class="free">n</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> sim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">τ</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_similar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> m'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">m'</span> <span class="free">p</span> <span class="main">=</span> <span class="free">τ</span> <span class="free">m</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equiv_element_left<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">τ</span> <span class="bound">r</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_similar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">n'</span> <span class="free">q</span> <span class="main">=</span> <span class="free">τ</span> <span class="free">n</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equiv_element_left<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sym<span class="main">[</span><span class="operator">OF</span> m'<span class="main">]</span> sym<span class="main">[</span><span class="operator">OF</span> n'<span class="main">]</span> v w <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> agr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Reduction-termination_is_local"><span class="command">lemma</span></span> termination_is_local<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"locally_similar <span class="free">σ</span> <span class="free">τ</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> trm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="main">(</span><span class="free">σ</span> <span class="free">m</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">dec</span> <span class="main">(</span><span class="free">τ</span> <span class="bound">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> sim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">τ</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_similar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">m</span> <span class="free">p</span> <span class="main">=</span> <span class="free">τ</span> <span class="skolem">n</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equiv_element_right<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> trm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> consensus_is_local<span class="main">:</span> <span class="quoted"><span class="quoted">"local_property <span class="main">(</span>consensus <span class="free">vals</span> <span class="free">dec</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> local_property_def consensus_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"locally_similar <span class="skolem">σ</span> <span class="skolem">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">.</span> <span class="free">dec</span> <span class="main">(</span><span class="skolem">σ</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∈</span> range <span class="free">vals</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="main">(</span><span class="skolem">τ</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> range <span class="free">vals</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> integrity_is_local<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">v</span> <span class="skolem">w</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"locally_similar <span class="skolem">σ</span> <span class="skolem">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span> <span class="bound">n</span> <span class="bound">p</span> <span class="bound">q</span> <span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="free">dec</span> <span class="main">(</span><span class="skolem">σ</span> <span class="bound">m</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="free">dec</span> <span class="main">(</span><span class="skolem">σ</span> <span class="bound">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="main">(</span><span class="skolem">τ</span> <span class="skolem">m</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="main">(</span><span class="skolem">τ</span> <span class="skolem">n</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> agreement_is_local<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"locally_similar <span class="skolem">σ</span> <span class="skolem">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">m</span> <span class="bound">v</span><span class="main">.</span> <span class="free">dec</span> <span class="main">(</span><span class="skolem">σ</span> <span class="bound">m</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span> <span class="bound">w</span><span class="main">.</span> <span class="free">dec</span> <span class="main">(</span><span class="skolem">τ</span> <span class="bound">n</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> termination_is_local<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> weak_consensus_is_local<span class="main">:</span> <span class="quoted"><span class="quoted">"local_property <span class="main">(</span>weak_consensus <span class="free">vals</span> <span class="free">dec</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> local_property_def weak_consensus_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">v</span> <span class="skolem">w</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"locally_similar <span class="skolem">σ</span> <span class="skolem">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">p</span> <span class="bound">w</span><span class="main">.</span> <span class="free">dec</span> <span class="main">(</span><span class="skolem">σ</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span> <span class="main">⟶</span> <span class="bound">w</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="main">(</span><span class="skolem">τ</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> validity_is_local<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">v</span> <span class="skolem">w</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"locally_similar <span class="skolem">σ</span> <span class="skolem">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span> <span class="bound">n</span> <span class="bound">p</span> <span class="bound">q</span> <span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="free">dec</span> <span class="main">(</span><span class="skolem">σ</span> <span class="bound">m</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="free">dec</span> <span class="main">(</span><span class="skolem">σ</span> <span class="bound">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="main">(</span><span class="skolem">τ</span> <span class="skolem">m</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="main">(</span><span class="skolem">τ</span> <span class="skolem">n</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> agreement_is_local<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"locally_similar <span class="skolem">σ</span> <span class="skolem">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">m</span> <span class="bound">v</span><span class="main">.</span> <span class="free">dec</span> <span class="main">(</span><span class="skolem">σ</span> <span class="bound">m</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span> <span class="bound">w</span><span class="main">.</span> <span class="free">dec</span> <span class="main">(</span><span class="skolem">τ</span> <span class="bound">n</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> termination_is_local<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Majorities">
<div class="head">
<h1>Theory Majorities</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Majorities
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Utility Lemmas About Majorities›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Consensus algorithms usually ensure that a majority of processes
  proposes the same value before taking a decision,
  and we provide a few utility lemmas for reasoning about majorities.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Any two subsets <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> of a finite  set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E›</span></span></span></span> such that
  the sum of their cardinalities is larger than the size of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E›</span></span></span></span> have a
  non-empty intersection.
›</span></span>
<span class="keyword1" id="Majorities-abs_majorities_intersect"><span class="command">lemma</span></span> abs_majorities_intersect<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> crd<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">E</span> <span class="main">&lt;</span> card <span class="free">S</span> <span class="main">+</span> card <span class="free">T</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">E</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> contra<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> s t e <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> crd contra <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">E</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_Int<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> s t e <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Majorities-abs_majoritiesE"><span class="command">lemma</span></span> abs_majoritiesE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> crd<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">E</span> <span class="main">&lt;</span> card <span class="free">S</span> <span class="main">+</span> card <span class="free">T</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_majorities_intersect<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∩</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Special case: both sets <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> are majorities.›</span></span>

<span class="keyword1" id="Majorities-abs_majoritiesE'"><span class="command">lemma</span></span> abs_majoritiesE'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Smaj<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">S</span> <span class="main">&gt;</span> <span class="main">(</span>card <span class="free">E</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Tmaj<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">T</span> <span class="main">&gt;</span> <span class="main">(</span>card <span class="free">E</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> abs_majoritiesE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ s t e<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Smaj Tmaj <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="free">E</span> <span class="main">&lt;</span> card <span class="free">S</span> <span class="main">+</span> card <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We restate the above theorems for the case where the base type
  is finite (taking <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E›</span></span></span></span> as the universal set).
›</span></span>

<span class="keyword1" id="Majorities-majorities_intersect"><span class="command">lemma</span></span> majorities_intersect<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> crd<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>UNIV<span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> set<span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="free">S</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="main">+</span> card <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_majorities_intersect<span class="main"><span class="main">[</span></span><span class="operator">OF</span> crd<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Majorities-majoritiesE"><span class="command">lemma</span></span> majoritiesE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> crd<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>UNIV<span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> set<span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="free">S</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="free">T</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> crd majorities_intersect <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Majorities-majoritiesE'"><span class="command">lemma</span></span> majoritiesE'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> set<span class="main">)</span> <span class="main">&gt;</span> <span class="main">(</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">T</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="main">&gt;</span> <span class="main">(</span>card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_majoritiesE'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S T<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* theory Majorities *)</span>
</pre>
</div><div id="OneThirdRuleDefs">
<div class="head">
<h1>Theory OneThirdRuleDefs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> OneThirdRuleDefs
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#HOModel">../HOModel</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Verification of the \emph{One-Third Rule} Consensus Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now apply the framework introduced so far to the verification of
  concrete algorithms, starting with algorithm \emph{One-Third Rule},
  which is one of the simplest algorithms presented in~\cite{charron:heardof}.
  Nevertheless, the algorithm has some interesting characteristics:
  it ensures safety (i.e., the Integrity and Agreement) properties in the
  presence of arbitrary benign faults, and if everything works perfectly,
  it terminates in just two rounds. \emph{One-Third Rule} is an uncoordinated
  algorithm tolerating benign faults, hence SHO or coordinator sets do not
  play a role in its definition.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model of the Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We begin by introducing an anonymous type of processes of finite
  cardinality that will instantiate the type variable <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'proc›</span></span></span></span>
  of the generic HO model.
›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> Proc <span class="comment1">― ‹the set of processes›</span>
<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span> Proc_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">OFCLASS</span><span class="main">(</span>Proc<span class="main">,</span> finite_class<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> Proc <span class="main">::</span> <span class="quoted">finite</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Proc_finite<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> card <span class="main">(</span>UNIV<span class="main">::</span>Proc set<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The state of each process consists of two fields: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> holds
  the current value proposed by the process and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>decide›</span></span></span></span> the
  value (if any, hence the option type) it has decided.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'val</span> pstate <span class="main">=</span>
  x <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span>"</span></span>
  decide <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The initial value of field <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> is unconstrained, but no decision
  has been taken initially.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OTR_initState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OTR_initState</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> decide <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given a vector <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>msgs›</span></span></span></span> of values (possibly null) received from 
  each process, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">HOV</span></span> <span class="free"><span class="free">msgs</span></span> <span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> denotes the set of processes from
  which value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> was received.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HOV</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Proc <span class="main">⇒</span> <span class="tfree">'val</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'val</span> <span class="main">⇒</span> Proc set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HOV</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">MFR</span></span> <span class="free"><span class="free">msgs</span></span> <span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (``most frequently received'') holds for
  vector <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>msgs›</span></span></span></span> if no value has been received more frequently
  than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>.

  Some such value always exists, since there is only a finite set of
  processes and thus a finite set of possible cardinalities of the
  sets <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"HOV <span class="free"><span class="free">msgs</span></span> <span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">MFR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Proc <span class="main">⇒</span> <span class="tfree">'val</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'val</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">MFR</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">w</span><span class="main">.</span> card <span class="main">(</span>HOV <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">w</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>HOV <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="OneThirdRuleDefs-MFR_exists"><span class="command">lemma</span></span> MFR_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> MFR <span class="free">msgs</span> <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cards</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> card <span class="main">(</span>HOV <span class="free">msgs</span> <span class="bound">v</span><span class="main">)</span> <span class="main">|</span> <span class="bound">v</span> <span class="main">.</span> True <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mfr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max <span class="var">?cards</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> card <span class="main">(</span>HOV <span class="free">msgs</span> <span class="bound">v</span><span class="main">)</span> <span class="main">≤</span> N"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cards</span> <span class="main">⊆</span> <span class="main">{</span> <span class="main">0</span> <span class="main">..</span> N <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?cards</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeast0AtMost finite_atMost finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mfr</span> <span class="main">∈</span> <span class="var">?cards</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max_in<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mfr</span> <span class="main">=</span> card <span class="main">(</span>HOV <span class="free">msgs</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFR <span class="free">msgs</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MFR_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>HOV <span class="free">msgs</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?mfr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max_ge<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>HOV <span class="free">msgs</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>HOV <span class="free">msgs</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> v<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Also, if a process has heard from at least one other process,
  the most frequently received values are among the received messages.
›</span></span>

<span class="keyword1" id="OneThirdRuleDefs-MFR_in_msgs"><span class="command">lemma</span></span> MFR_in_msgs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> HO<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="free">m</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"MFR <span class="main">(</span>HOrcvdMsgs <span class="free">OTR_M</span> <span class="free">m</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">m</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">v</span>"</span></span>
             <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"MFR <span class="var">?msgs</span> <span class="free">v</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="free">m</span> <span class="free">p</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> the <span class="main">(</span><span class="var">?msgs</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> HO <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="free">m</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HOV <span class="var">?msgs</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?msgs</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOV_def HOrcvdMsgs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> HOp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="main">(</span>HOV <span class="var">?msgs</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?msgs</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span>HOV <span class="var">?msgs</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MFR_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HOV <span class="var">?msgs</span> <span class="free">v</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOV_def HOrcvdMsgs_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">TwoThirds</span></span> <span class="free"><span class="free">msgs</span></span> <span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> holds if value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> has been
  received from more than $2/3$ of all processes.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">TwoThirds</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">TwoThirds</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">(</span>HOV <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The next-state relation of algorithm \emph{One-Third Rule} for every process
  is defined as follows:
  if the process has received values from more than $2/3$ of all processes,
  the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field is set to the smallest among the most frequently received
  values, and the process decides value $v$ if it received $v$ from more than
  $2/3$ of all processes. If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> hasn't heard from more than $2/3$ of
  all processes, the state remains unchanged.
  (Note that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Some›</span></span></span></span> is the constructor of the option datatype, whereas
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ϵ›</span></span></span></span> is Hilbert's choice operator.)
  We require the type of values to be linearly ordered so that the minimum
  is guaranteed to be well-defined.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OTR_nextState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OTR_nextState</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">::</span><span class="main">(</span><span class="tfree">'val</span><span class="main">::</span>linorder<span class="main">)</span> pstate<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span> 
   <span class="keyword1">if</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">}</span>
   <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="main">⦇</span> x <span class="main">=</span> Min <span class="main">{</span><span class="bound">v</span> <span class="main">.</span> MFR <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">v</span><span class="main">}</span><span class="main">,</span>
          decide <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> TwoThirds <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">v</span><span class="main">)</span>
                    <span class="keyword1">then</span> Some <span class="main">(</span><span class="main">ϵ</span><span class="bound">v</span><span class="main">.</span> TwoThirds <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">v</span><span class="main">)</span>
                    <span class="keyword1">else</span> decide <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">⦈</span>
   <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The message sending function is very simple: at every round, every process
  sends its current proposal (field <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> of its local state) to all 
  processes.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OTR_sendMsg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OTR_sendMsg</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> x <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Communication Predicate for \emph{One-Third Rule}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the communication predicate for the \emph{One-Third Rule}
  algorithm to be correct.
  It requires that, infinitely often, there is a round where all processes
  receive messages from the same set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Π›</span></span></span></span> of processes where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Π›</span></span></span></span>
  contains more than two thirds of all processes.
  The ``per-round'' part of the communication predicate is trivial.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OTR_commPerRd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OTR_commPerRd</span> <span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="main">≡</span> True"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OTR_commGlobal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OTR_commGlobal</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r0</span> <span class="bound">Π</span><span class="main">.</span> <span class="bound">r0</span> <span class="main">≥</span> <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r0</span> <span class="bound">p</span> <span class="main">=</span> <span class="bound">Π</span><span class="main">)</span> <span class="main">∧</span> card <span class="bound">Π</span> <span class="main">&gt;</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The \emph{One-Third Rule} Heard-Of Machine›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the HO machine for the \emph{One-Third Rule} algorithm
  by assembling the algorithm definition and its communication-predicate.
  Because this is an uncoordinated algorithm, the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>crd›</span></span></span></span> arguments
  of the initial- and next-state predicates are unused.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OTR_HOMachine</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OTR_HOMachine</span> <span class="main">=</span>
    <span class="main">⦇</span> CinitState <span class="main">=</span>  <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">crd</span><span class="main">.</span> OTR_initState <span class="bound">p</span> <span class="bound">st</span><span class="main">)</span><span class="main">,</span>
     sendMsg <span class="main">=</span>  OTR_sendMsg<span class="main">,</span>
     CnextState <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span> <span class="bound">st'</span><span class="main">.</span> OTR_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">st'</span><span class="main">)</span><span class="main">,</span>
     HOcommPerRd <span class="main">=</span> OTR_commPerRd<span class="main">,</span>
     HOcommGlobal <span class="main">=</span> OTR_commGlobal <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">OTR_M</span> <span class="main">≡</span> OTR_HOMachine<span class="main">::</span><span class="main">(</span>Proc<span class="main">,</span> <span class="tfree">'val</span><span class="main">::</span>linorder pstate<span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> HOMachine"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="OneThirdRuleProof">
<div class="head">
<h1>Theory OneThirdRuleProof</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> OneThirdRuleProof
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#OneThirdRuleDefs">OneThirdRuleDefs</a> <span class="quoted">"<a href="#Reduction">../Reduction</a>"</span> <span class="quoted">"<a href="#Majorities">../Majorities</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We prove that \emph{One-Third Rule} solves the Consensus problem
  under the communication predicate defined above. The proof is
  split into proofs of the Integrity, Agreement, and Termination
  properties.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of Integrity›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Showing integrity of the algorithm is a simple, if slightly tedious
  exercise in invariant reasoning. The following inductive invariant
  asserts that the values of the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>decide›</span></span></span></span> fields
  of the process states are limited to the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> values present
  in the initial states since the algorithm does not introduce any
  new values.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">VInv</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">VInv</span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
   <span class="keyword1">let</span> <span class="bound">xinit</span> <span class="main">=</span> <span class="main">(</span>range <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="keyword1">in</span>  range <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">xinit</span>
     <span class="main">∧</span> range <span class="main">(</span>decide <span class="main">∘</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>Some <span class="main">`</span> <span class="bound">xinit</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="OneThirdRuleProof-vinv_invariant"><span class="command">lemma</span></span> vinv_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span><span class="quoted"><span class="quoted">"HORun OTR_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"VInv <span class="free">rho</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"VInv <span class="free">rho</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HORun_eq HOinitConfig_eq OTR_HOMachine_def initState_def
                  OTR_initState_def VInv_def image_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"VInv <span class="free">rho</span> <span class="skolem">m</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xinit</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?xinit</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> image_cong_simp<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">from</span></span> run
    <span class="keyword1"><span class="command">have</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"OTR_nextState <span class="skolem">m</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">m</span> <span class="skolem">p</span><span class="main">)</span> 
                        <span class="main">(</span>HOrcvdMsgs OTR_M <span class="skolem">m</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">m</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>
                        <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"OTR_nextState <span class="main">_</span> <span class="main">_</span> <span class="var">?st</span> <span class="var">?msgs</span> <span class="var">?st'</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HORun_eq HOnextConfig_eq OTR_HOMachine_def nextState_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="var">?st'</span> <span class="main">∈</span> <span class="var">?xinit</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="free">HOs</span> <span class="skolem">m</span> <span class="skolem">p</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> HO<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="skolem">m</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?MFRs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span><span class="main">.</span> MFR <span class="var">?msgs</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?MFRs</span> <span class="main">∈</span> <span class="var">?MFRs</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Min_in<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> HO <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MFRs</span> <span class="main">⊆</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?msgs</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free">HOs</span> <span class="skolem">m</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> MFR_in_msgs<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?MFRs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">from</span></span> MFR_exists <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MFRs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> HO <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="skolem">m</span> <span class="skolem">p</span><span class="main">.</span> Min <span class="var">?MFRs</span> <span class="main">=</span> the <span class="main">(</span><span class="var">?msgs</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> MFR_in_msgs<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="skolem">m</span> <span class="skolem">p</span><span class="main">.</span> Min <span class="var">?MFRs</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">m</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOrcvdMsgs_def OTR_HOMachine_def OTR_sendMsg_def<span class="main">)</span>
     <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> True nxt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="var">?st'</span> <span class="main">=</span> Min <span class="var">?MFRs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> OTR_nextState_def HOrcvdMsgs_def<span class="main">)</span>
     <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> VInv_def image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> nxt ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> OTR_nextState_def VInv_def HOrcvdMsgs_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> decide <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>Some <span class="main">`</span> <span class="var">?xinit</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">from</span></span> run
    <span class="keyword1"><span class="command">have</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"OTR_nextState <span class="skolem">m</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">m</span> <span class="skolem">p</span><span class="main">)</span> 
                        <span class="main">(</span>HOrcvdMsgs OTR_M <span class="skolem">m</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">m</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>
                        <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"OTR_nextState <span class="main">_</span> <span class="main">_</span> <span class="var">?st</span> <span class="var">?msgs</span> <span class="var">?st'</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HORun_eq HOnextConfig_eq OTR_HOMachine_def nextState_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"decide <span class="var">?st'</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>Some <span class="main">`</span> <span class="var">?xinit</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> HO<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> TwoThirds <span class="var">?msgs</span> <span class="bound">v</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dec</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">ϵ</span><span class="bound">v</span><span class="main">.</span> TwoThirds <span class="var">?msgs</span> <span class="bound">v</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TwoThirds <span class="var">?msgs</span> <span class="var">?dec</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"HOV <span class="var">?msgs</span> <span class="var">?dec</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> TwoThirds_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="skolem">m</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="var">?dec</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOV_def HOrcvdMsgs_def OTR_HOMachine_def
                         OTR_sendMsg_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> sym<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> nxt ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> OTR_nextState_def VInv_def image_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> HO nxt ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> OTR_nextState_def VInv_def HOrcvdMsgs_def image_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> nxt ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> OTR_nextState_def VInv_def image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>decide <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>Some <span class="main">`</span> <span class="var">?xinit</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"VInv <span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> VInv_def image_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Integrity is an immediate consequence.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> OTR_integrity<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span><span class="quoted"><span class="quoted">"HORun OTR_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xinit</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"VInv <span class="free">rho</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vinv_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>decide <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>Some <span class="main">`</span> <span class="var">?xinit</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> VInv_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>Some <span class="main">`</span> <span class="var">?xinit</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> dec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of Agreement›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A1›</span></span></span></span> asserts that if process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> 
  decides in a round on a value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> then more than $2/3$ of 
  all processes have <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> as their <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> value in their 
  local state.

  We show a few simple lemmas in preparation.
›</span></span>

<span class="keyword1" id="OneThirdRuleProof-nextState_change"><span class="command">lemma</span></span> nextState_change<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HORun OTR_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> 
              <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span>HOrcvdMsgs OTR_M <span class="free">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rho</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="free">rho</span> <span class="free">n</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HORun_eq HOnextConfig_eq OTR_HOMachine_def
                 nextState_def OTR_nextState_def<span class="main">)</span>

<span class="keyword1" id="OneThirdRuleProof-nextState_decide"><span class="command">lemma</span></span> nextState_decide<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span><span class="quoted"><span class="quoted">"HORun OTR_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> chg<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"TwoThirds <span class="main">(</span>HOrcvdMsgs OTR_M <span class="free">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">(</span>the <span class="main">(</span>decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"OTR_nextState <span class="free">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span>
                    <span class="main">(</span>HOrcvdMsgs OTR_M <span class="free">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HORun_eq HOnextConfig_eq OTR_HOMachine_def nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> chg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> OTR_nextState_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> someI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="OneThirdRuleProof-A1"><span class="command">lemma</span></span> A1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span><span class="quoted"><span class="quoted">"HORun OTR_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> chg<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"decide <span class="var">?st'</span> <span class="main">≠</span> decide <span class="var">?st</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run chg
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TwoThirds <span class="main">(</span>HOrcvdMsgs OTR_M <span class="free">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> 
                  <span class="main">(</span>the <span class="main">(</span>decide <span class="var">?st'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"TwoThirds <span class="var">?msgs</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nextState_decide<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> dec <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TwoThirds <span class="var">?msgs</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> TwoThirds_def HOV_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> OTR_HOMachine_def OTR_sendMsg_def HOrcvdMsgs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">}</span> <span class="main">≤</span> card <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A2›</span></span></span></span> contains the crucial correctness argument:
  if more than $2/3$ of all processes send <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> and process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>
  hears from more than $2/3$ of all processes then the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field of
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> will be updated to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>.
›</span></span>

<span class="keyword1" id="OneThirdRuleProof-A2"><span class="command">lemma</span></span> A2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun OTR_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> HO<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span>
             <span class="main">&lt;</span> card <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> HOrcvdMsgs OTR_M <span class="free">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="bound">q</span> <span class="main">≠</span> None <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> maj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span> <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run 
  <span class="keyword1"><span class="command">have</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"OTR_nextState <span class="free">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> 
                      <span class="main">(</span>HOrcvdMsgs OTR_M <span class="free">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> 
                      <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"OTR_nextState <span class="main">_</span> <span class="main">_</span> <span class="var">?st</span> <span class="var">?msgs</span> <span class="var">?st'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HORun_eq HOnextConfig_eq OTR_HOMachine_def nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?HOVothers</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">{</span> HOV <span class="var">?msgs</span> <span class="bound">w</span> <span class="main">|</span> <span class="bound">w</span> <span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="free">v</span><span class="main">}</span>"</span></span>
  <span class="comment1">― ‹processes from which <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">p</span><span class="antiquote">}</span></span> received values different from <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">v</span><span class="antiquote">}</span></span>›</span>

  <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?HOVothers</span> <span class="main">≤</span> N <span class="keyword1">div</span> <span class="numeral">3</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?HOVothers</span> <span class="main">≤</span> card <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span> <span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOV_def HOrcvdMsgs_def OTR_HOMachine_def OTR_sendMsg_def 
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> N <span class="main">-</span> card <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span> <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_Diff_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> maj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> N <span class="keyword1">div</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> hov<span class="main">:</span> <span class="quoted"><span class="quoted">"HOV <span class="var">?msgs</span> <span class="free">v</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="main">≠</span> None <span class="main">}</span> <span class="main">-</span> <span class="var">?HOVothers</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOV_def<span class="main">)</span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> othHO<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?HOVothers</span> <span class="main">⊆</span> <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="main">≠</span> None <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOV_def<span class="main">)</span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Show that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> has been received from more than $N/3$ processes.›</span></span>
  <span class="keyword1"><span class="command">from</span></span> HO <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"N <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="main">≠</span> None <span class="main">}</span> <span class="main">-</span> <span class="main">(</span>N <span class="keyword1">div</span> <span class="numeral">3</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> w HO <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="main">≠</span> None <span class="main">}</span> <span class="main">-</span> card <span class="var">?HOVothers</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> hov othHO <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span>HOV <span class="var">?msgs</span> <span class="free">v</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_Diff_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> HOV<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">(</span>HOV <span class="var">?msgs</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹All other values are received from at most $N/3$ processes.›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">⟶</span> card <span class="main">(</span>HOV <span class="var">?msgs</span> <span class="bound">w</span><span class="main">)</span> <span class="main">≤</span> card <span class="var">?HOVothers</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> w <span class="keyword1"><span class="command">have</span></span> cardw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">⟶</span> card <span class="main">(</span>HOV <span class="var">?msgs</span> <span class="bound">w</span><span class="main">)</span> <span class="main">≤</span> N <span class="keyword1">div</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹In particular, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> is the single most frequently received value.›</span></span>
  <span class="keyword1"><span class="command">with</span></span> HOV <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFR <span class="var">?msgs</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MFR_def<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span>MFR <span class="var">?msgs</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MFR_def not_le<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> cardw HOV <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>HOV <span class="var">?msgs</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span>HOV <span class="var">?msgs</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> card <span class="main">(</span>HOV <span class="var">?msgs</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span>HOV <span class="var">?msgs</span> <span class="bound">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> mfrv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">w</span> <span class="main">.</span> MFR <span class="var">?msgs</span> <span class="bound">w</span> <span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">}</span> <span class="main">≤</span> card <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="main">≠</span> None <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> HO mfrv nxt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> OTR_nextState_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Therefore, once more than two thirds of the processes hold <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>
  in their <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field, this will remain true forever.
›</span></span>

<span class="keyword1" id="OneThirdRuleProof-A3"><span class="command">lemma</span></span> A3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span><span class="quoted"><span class="quoted">"HORun OTR_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span> <span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?twothird</span> <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="var">?twothird</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> n <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?twothird</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
  <span class="keyword3"><span class="command">assume</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?twothird</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">m</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⟶</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> Suc <span class="skolem">m</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?msgs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"HOrcvdMsgs OTR_M <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">m</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">m</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> Suc <span class="skolem">m</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="main">≠</span> None <span class="main">}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> m <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">m</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> True run <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> A2<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> run q <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nextState_change<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">m</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> Suc <span class="skolem">m</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> m <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?twothird</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> Suc <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  It now follows that once a process has decided on some value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>, 
  more than two thirds of all processes continue to hold <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> in
  their <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field.
›</span></span>

<span class="keyword1" id="OneThirdRuleProof-A4"><span class="command">lemma</span></span> A4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun OTR_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="bound">k</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span> <span class="main">}</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="var">?twothird</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="bound">k</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> dec <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="comment1">― ‹The base case is trivial since no process has decided›</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> run <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="var">?twothird</span> <span class="main">(</span><span class="main">0</span><span class="main">+</span><span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HORun_eq HOinitConfig_eq OTR_HOMachine_def 
                  initState_def OTR_initState_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">― ‹For the inductive step, we assume that process <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">p</span><span class="antiquote">}</span></span> has decided on <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">v</span><span class="antiquote">}</span></span>.›</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="skolem">m</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="var">?twothird</span> <span class="main">(</span><span class="skolem">m</span><span class="main">+</span><span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="var">?twothird</span> <span class="main">(</span><span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?twothird</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹
      There are two cases to consider: if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> had already decided on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>
      before, the assertion follows from the induction hypothesis. Otherwise, the
      assertion follows from lemmas <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A1›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A3›</span></span></span></span>.
›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="skolem">m</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> run m <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?twothird</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> A1<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> run <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A3<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?twothird</span> <span class="main">(</span><span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The Agreement property follows easily from lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A4›</span></span></span></span>: if processes
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> decide values <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>w›</span></span></span></span>,
  respectively, then more than two thirds of the processes must propose
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> and more than two thirds must propose <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>w›</span></span></span></span>.
  Because these two majorities must have an intersection, we must have
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v=w›</span></span></span></span>.

  We first prove an ``asymmetric'' version of the agreement property before
  deriving the general agreement theorem.
›</span></span>


<span class="keyword1" id="OneThirdRuleProof-A5"><span class="command">lemma</span></span> A5<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span><span class="quoted"><span class="quoted">"HORun OTR_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="free">p'</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run p 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">&lt;</span> card <span class="var">?V</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A4<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> run p'
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">+</span><span class="main">0</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">&lt;</span> card <span class="var">?W</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A4<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"N <span class="main">&lt;</span> card <span class="var">?V</span> <span class="main">+</span> card <span class="var">?W</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">proc</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">proc</span> <span class="main">∈</span> <span class="var">?V</span> <span class="main">∩</span> <span class="var">?W</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> majorities_intersect<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> OTR_agreement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span><span class="quoted"><span class="quoted">"HORun OTR_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">m</span> <span class="free">p'</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span><span class="main">+</span><span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_iff_add<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> run p p' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> A5<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">m</span><span class="main">+</span><span class="skolem">k</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_iff_add<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> run p p' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> A5<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of  Termination›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now show that every process must eventually decide.

  The idea of the proof is to observe that the communication predicate
  guarantees the existence of two uniform rounds where every process hears
  from the same two-thirds majority of processes. The first such round
  serves to ensure that all <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> fields hold the same value, the
  second round copies that value into all decision fields.

  Lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A2›</span></span></span></span> is instrumental in this proof.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> OTR_termination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun OTR_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"HOcommGlobal OTR_M <span class="free">HOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span> <span class="bound">v</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> commG <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r0</span></span> <span class="skolem"><span class="skolem">Π</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    pi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="free">HOs</span> <span class="skolem">r0</span> <span class="bound">q</span> <span class="main">=</span> <span class="skolem">Π</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pic<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">Π</span> <span class="main">&gt;</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> OTR_HOMachine_def OTR_commGlobal_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?msgs</span> <span class="free">q</span> <span class="free">r</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"HOrcvdMsgs OTR_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> run pi <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="skolem">r0</span> <span class="main">=</span> <span class="var">?msgs</span> <span class="bound">p</span> <span class="skolem">r0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HORun_eq OTR_HOMachine_def HOrcvdMsgs_def OTR_sendMsg_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="skolem">r0</span> <span class="main">=</span> <span class="skolem">μ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> pi pic <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="var">?msgs</span> <span class="bound">p</span> <span class="skolem">r0</span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HORun_eq HOnextConfig_eq HOrcvdMsgs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Min <span class="main">{</span><span class="bound">v</span> <span class="main">.</span> MFR <span class="main">(</span><span class="var">?msgs</span> <span class="bound">q</span> <span class="skolem">r0</span><span class="main">)</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HORun_eq HOnextConfig_eq OTR_HOMachine_def 
                   nextState_def OTR_nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Min <span class="main">{</span><span class="bound">v</span> <span class="main">.</span> MFR <span class="skolem">μ</span> <span class="bound">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">+</span><span class="bound">k</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> v <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">+</span><span class="main">0</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span> <span class="bound">p</span> <span class="main">.</span> <span class="var">?msgs</span> <span class="skolem">q</span> <span class="main">(</span>Suc <span class="skolem">r0</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">p</span> <span class="main">≠</span> None <span class="main">}</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_UNIV_card_ge_0<span class="main">)</span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> ih 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span> <span class="bound">p</span> <span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> True run <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> A2<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> run ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nextState_change<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> commG <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r0'</span></span> <span class="skolem"><span class="skolem">Π'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> r0'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r0'</span> <span class="main">≥</span> Suc <span class="skolem">r0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> pi'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="free">HOs</span> <span class="skolem">r0'</span> <span class="bound">q</span> <span class="main">=</span> <span class="skolem">Π'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> pic'<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">Π'</span> <span class="main">&gt;</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> OTR_HOMachine_def OTR_commGlobal_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> r0' P <span class="keyword1"><span class="command">have</span></span> v'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">r0'</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_iff_add<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> run 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"OTR_nextState <span class="skolem">r0'</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r0'</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span> <span class="skolem">r0'</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0'</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HORun_eq HOnextConfig_eq OTR_HOMachine_def nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">from</span></span> pi' pic' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span> <span class="skolem">r0'</span><span class="main">)</span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOrcvdMsgs_def OTR_sendMsg_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> pi' pic' v' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TwoThirds <span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span> <span class="skolem">r0'</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> TwoThirds_def HOrcvdMsgs_def OTR_HOMachine_def 
                  OTR_sendMsg_def HOV_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0'</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">ϵ</span><span class="bound">v</span><span class="main">.</span> TwoThirds <span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span> <span class="skolem">r0'</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> OTR_nextState_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹\emph{One-Third Rule} Solves Consensus›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Summing up, all (coarse-grained) runs of \emph{One-Third Rule} for
  HO collections that satisfy the communication predicate satisfy
  the Consensus property.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> OTR_consensus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun OTR_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"HOcommGlobal OTR_M <span class="free">HOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consensus <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> decide <span class="free">rho</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> OTR_integrity<span class="main">[</span><span class="operator">OF</span> run<span class="main">]</span> OTR_agreement<span class="main">[</span><span class="operator">OF</span> run<span class="main">]</span> OTR_termination<span class="main">[</span><span class="operator">OF</span> run commG<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> consensus_def image_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  By the reduction theorem, the correctness of the algorithm also follows
  for fine-grained runs of the algorithm. It would be much more tedious
  to establish this theorem directly.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> OTR_consensus_fg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run OTR_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">HOs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">q</span><span class="main">.</span> undefined<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"HOcommGlobal OTR_M <span class="free">HOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consensus <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> x <span class="main">(</span>state <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> decide <span class="main">(</span>state <span class="main">∘</span> <span class="free">rho</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"consensus <span class="var">?inits</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> local_property_reduction<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run consensus_is_local<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">crun</span>
  <span class="keyword3"><span class="command">assume</span></span> crun<span class="main">:</span> <span class="quoted"><span class="quoted">"CSHORun OTR_M <span class="skolem">crun</span> <span class="free">HOs</span> <span class="free">HOs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">q</span><span class="main">.</span> undefined<span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">crun</span> <span class="main">0</span> <span class="main">=</span> state <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> crun <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HORun OTR_M <span class="skolem">crun</span> <span class="free">HOs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> HORun_def SHORun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this commG <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consensus <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="skolem">crun</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> decide <span class="skolem">crun</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> OTR_consensus<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> init <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consensus <span class="var">?inits</span> decide <span class="skolem">crun</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="UvDefs">
<div class="head">
<h1>Theory UvDefs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> UvDefs
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#HOModel">../HOModel</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Verification of the \emph{UniformVoting} Consensus Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Algorithm \emph{UniformVoting} is presented in~\cite{charron:heardof}.
  It can be considered as a deterministic version of Ben-Or's well-known 
  probabilistic Consensus algorithm~\cite{ben-or:advantage}. We formalize
  in Isabelle the correctness proof given in~\cite{charron:heardof},
  using the framework of theory <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>HOModel›</span></span></span></span>.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model of the Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We begin by introducing an anonymous type of processes of finite
  cardinality that will instantiate the type variable <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'proc›</span></span></span></span>
  of the generic HO model.
›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> Proc <span class="comment1">― ‹the set of processes›</span>
<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span> Proc_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">OFCLASS</span><span class="main">(</span>Proc<span class="main">,</span> finite_class<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> Proc <span class="main">::</span> <span class="quoted">finite</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Proc_finite<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> card <span class="main">(</span>UNIV<span class="main">::</span>Proc set<span class="main">)</span>"</span></span>   <span class="comment1">― ‹number of processes›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The algorithm proceeds in \emph{phases} of $2$ rounds each (we call
  \emph{steps} the individual rounds that constitute a phase).
  The following utility functions compute the phase and step of a round,
  given the round number.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">nSteps</span> <span class="main">≡</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">phase</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">phase</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">div</span> nSteps"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">step</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">mod</span> nSteps"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following record models the local state of a process.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'val</span> pstate <span class="main">=</span>
  x <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'val</span></span></span>                <span class="comment1">― ‹current value held by process›</span>
  vote <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>    <span class="comment1">― ‹value the process voted for, if any›</span>
  decide <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>  <span class="comment1">― ‹value the process has decided on, if any›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Possible messages sent during the execution of the algorithm, and characteristic
  predicates to distinguish types of messages.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'val</span> msg <span class="main">=</span>
  Val <span class="tfree"><span class="quoted"><span class="tfree">'val</span></span></span>
<span class="main">|</span> ValVote <span class="tfree"><span class="quoted"><span class="tfree">'val</span></span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>
<span class="main">|</span> Null  <span class="comment1">― ‹dummy message in case nothing needs to be sent›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isValVote</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isValVote</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">z</span> <span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> ValVote <span class="bound">z</span> <span class="bound">v</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isVal</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isVal</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> Val <span class="bound">v</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Selector functions to retrieve components of messages. These functions
  have a meaningful result only when the message is of appropriate kind.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">getvote</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">getvote</span> <span class="main">(</span>ValVote <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">getval</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">getval</span> <span class="main">(</span>ValVote <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">getval</span> <span class="main">(</span>Val <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field of the initial state is unconstrained, all other
  fields are initialized appropriately.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UV_initState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_initState</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> <span class="main">(</span>vote <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>decide <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We separately define the transition predicates and the send functions
  for each step and later combine them to define the overall next-state relation.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">msgRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="comment1">― ‹processes from which some message was received›</span>
  <span class="quoted"><span class="quoted">"<span class="free">msgRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">::</span> Proc <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">smallestValRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">smallestValRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">::</span>Proc <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'val</span><span class="main">::</span>linorder<span class="main">)</span> msg<span class="main">)</span> <span class="main">≡</span>
   Min <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In step 0, each process sends its current <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> value.

  It updates its <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field to the smallest value it has received.
  If the process has received the same value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> from all processes
  from which it has heard, it updates its <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vote›</span></span></span></span> field to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> Val <span class="main">(</span>x <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">::</span>Proc <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'val</span><span class="main">::</span>linorder<span class="main">)</span> msg<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
           <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> vote <span class="main">:=</span> Some <span class="bound">v</span><span class="main">,</span> x <span class="main">:=</span> smallestValRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">⦈</span><span class="main">)</span>
    <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
       <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> x <span class="main">:=</span> smallestValRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In step 1, each process sends its current <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vote›</span></span></span></span> values.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> ValVote <span class="main">(</span>x <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">(</span>vote <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valVoteRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹processes from which values and votes were received›</span>
  <span class="quoted"><span class="quoted">"<span class="free">valVoteRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">::</span> Proc <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="main">≡</span> 
   <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">z</span> <span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>ValVote <span class="bound">z</span> <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">smallestValNoVoteRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">smallestValNoVoteRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">::</span>Proc <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'val</span><span class="main">::</span>linorder<span class="main">)</span> msg<span class="main">)</span> <span class="main">≡</span>
   Min <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>ValVote <span class="bound">v</span> None<span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">someVoteRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹set of processes from which some vote was received›</span>
  <span class="quoted"><span class="quoted">"<span class="free">someVoteRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">::</span> Proc <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="main">≡</span>
   <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">∧</span> isValVote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> getvote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> None <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">identicalVoteRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">identicalVoteRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">::</span> Proc <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span>
   <span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">.</span> isValVote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> getvote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">x_update</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">x_update</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> someVoteRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">.</span> x <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> the <span class="main">(</span>getvote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
 <span class="main">∨</span> someVoteRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> x <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> smallestValNoVoteRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dec_update</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dec_update</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> identicalVoteRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">v</span> <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span>
  <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> identicalVoteRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> decide <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
     x_update <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span>
   <span class="main">∧</span> dec_update <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span>
   <span class="main">∧</span> vote <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The overall send function and next-state relation are simply obtained as 
  the composition of the individual relations defined above.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UV_sendMsg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_sendMsg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span> <span class="keyword1">if</span> step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> send0 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> send1 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UV_nextState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_nextState</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> next0 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> next1 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Communication Predicate for \emph{UniformVoting}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the communication predicate for the \emph{UniformVoting}
  algorithm to be correct.

  The round-by-round predicate requires that for any two processes
  there is always one process heard by both of them. In other words,
  no ``split rounds'' occur during the execution of the algorithm~\cite{charron:heardof}.
  Note that in particular, heard-of sets are never empty.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UV_commPerRd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_commPerRd</span> <span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound">pq</span><span class="main">.</span> <span class="bound">pq</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="bound">p</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="bound">q</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The global predicate requires the existence of a (space-)uniform round
  during which the heard-of sets of all processes are equal.
  (Observe that \cite{charron:heardof} requires infinitely many uniform
  rounds, but the correctness proof uses just one such round.)
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UV_commGlobal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_commGlobal</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span> <span class="bound">q</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The \emph{UniformVoting} Heard-Of Machine›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the HO machine for \emph{Uniform Voting} by assembling the
  algorithm definition and its communication predicate. Notice that the
  coordinator arguments for the initialization and transition functions are
  unused since \emph{UniformVoting} is not a coordinated algorithm.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UV_HOMachine</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_HOMachine</span> <span class="main">=</span> <span class="main">⦇</span> 
    CinitState <span class="main">=</span>  <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">st</span> <span class="bound">crd</span><span class="main">.</span> UV_initState <span class="bound">p</span> <span class="bound">st</span><span class="main">)</span><span class="main">,</span>
    sendMsg <span class="main">=</span>  UV_sendMsg<span class="main">,</span>
    CnextState <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span> <span class="bound">st'</span><span class="main">.</span> UV_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">st'</span><span class="main">)</span><span class="main">,</span>
    HOcommPerRd <span class="main">=</span> UV_commPerRd<span class="main">,</span>
    HOcommGlobal <span class="main">=</span> UV_commGlobal
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_M</span> <span class="main">≡</span> <span class="main">(</span>UV_HOMachine<span class="main">::</span><span class="main">(</span>Proc<span class="main">,</span> <span class="tfree">'val</span><span class="main">::</span>linorder pstate<span class="main">,</span> <span class="tfree">'val</span> msg<span class="main">)</span> HOMachine<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="UvProof">
<div class="head">
<h1>Theory UvProof</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> UvProof
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#UvDefs">UvDefs</a> <span class="quoted">"<a href="#Reduction">../Reduction</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminary Lemmas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  At any round, given two processes <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span>, there is always
  some process which is heard by both of them, and from which <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> and
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> have received the same message.
›</span></span>
<span class="keyword1" id="UvProof-some_common_msg"><span class="command">lemma</span></span> some_common_msg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pq</span><span class="main">.</span> <span class="bound">pq</span> <span class="main">∈</span> msgRcvd <span class="main">(</span>HOrcvdMsgs UV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∧</span> <span class="bound">pq</span> <span class="main">∈</span> msgRcvd <span class="main">(</span>HOrcvdMsgs UV_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∧</span> <span class="main">(</span>HOrcvdMsgs UV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">pq</span> 
              <span class="main">=</span> <span class="main">(</span>HOrcvdMsgs UV_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">pq</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def UV_commPerRd_def HOrcvdMsgs_def
                 UV_sendMsg_def send0_def send1_def msgRcvd_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  When executing step 0, the minimum received value is always well defined.
›</span></span>

<span class="keyword1" id="UvProof-minval_step0"><span class="command">lemma</span></span> minval_step0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> com<span class="main">:</span> <span class="quoted"><span class="quoted">"HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s0<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"smallestValRcvd <span class="main">(</span>HOrcvdMsgs UV_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>
         <span class="main">∈</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>HOrcvdMsgs UV_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
         <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"smallestValRcvd <span class="var">?msgs</span> <span class="main">∈</span> <span class="var">?vals</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> smallestValRcvd_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Min_in<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?vals</span> <span class="main">⊆</span> getval <span class="main">`</span> <span class="main">(</span><span class="main">(</span>the <span class="main">∘</span> <span class="var">?msgs</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOrcvdMsgs_def image_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?vals</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> some_common_msg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">HOs</span></span><span class="main">,</span> <span class="operator">OF</span> com<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> msgRcvd <span class="var">?msgs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> s0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?vals</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> msgRcvd_def HOrcvdMsgs_def UV_HOMachine_def 
                   UV_sendMsg_def send0_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  When executing step 1 and no vote has been received, the minimum among values received
  in messages carrying no vote is well defined.
›</span></span>

<span class="keyword1" id="UvProof-minval_step1"><span class="command">lemma</span></span> minval_step1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  com<span class="main">:</span> <span class="quoted"><span class="quoted">"HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nov<span class="main">:</span> <span class="quoted"><span class="quoted">"someVoteRcvd <span class="main">(</span>HOrcvdMsgs UV_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"smallestValNoVoteRcvd <span class="main">(</span>HOrcvdMsgs UV_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>
          <span class="main">∈</span> <span class="main">{</span><span class="bound">v</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>HOrcvdMsgs UV_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span>
                     <span class="main">=</span> Some <span class="main">(</span>ValVote <span class="bound">v</span> None<span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"smallestValNoVoteRcvd <span class="var">?msgs</span> <span class="main">∈</span> <span class="var">?vals</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> smallestValNoVoteRcvd_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Min_in<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?vals</span> <span class="main">⊆</span> getval <span class="main">`</span> <span class="main">(</span><span class="main">(</span>the <span class="main">∘</span> <span class="var">?msgs</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOrcvdMsgs_def image_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?vals</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> some_common_msg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">HOs</span></span><span class="main">,</span> <span class="operator">OF</span> com<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> msgRcvd <span class="var">?msgs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> s1 nov <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?vals</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> msgRcvd_def HOrcvdMsgs_def someVoteRcvd_def isValVote_def
                   UV_HOMachine_def UV_sendMsg_def send1_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vote›</span></span></span></span> field is reset every time a new phase begins. 
›</span></span>

<span class="keyword1" id="UvProof-reset_vote"><span class="command">lemma</span></span> reset_vote<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s0<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">r'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="free">r'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> run <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HORun_eq HOinitConfig_eq
                   initState_def UV_initState_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">assume</span></span> sucr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">=</span> Suc <span class="skolem">r</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> run
  <span class="keyword1"><span class="command">have</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState UV_M <span class="skolem">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span>
                                <span class="main">(</span>HOrcvdMsgs UV_M <span class="skolem">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> 
                                <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HORun_eq HOnextConfig_eq nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s0 sucr <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="skolem">r</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> nxt sucr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def nextState_def UV_nextState_def next1_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Processes only vote for the value they hold in their <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field.
›</span></span>
<span class="comment1">(* The proof relies on previous lemmas @{text reset_vote} and @{text some_common_msg}. *)</span>

<span class="keyword1" id="UvProof-x_vote_eq"><span class="command">lemma</span></span> x_vote_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> com<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> vote<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">with</span></span> run vote <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="comment1">― ‹no vote in initial state›</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HORun_eq HOinitConfig_eq 
                   initState_def UV_initState_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span>
  <span class="keyword3"><span class="command">assume</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> Suc <span class="skolem">r'</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?msgs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"HOrcvdMsgs UV_M <span class="skolem">r'</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nextState UV_M <span class="skolem">r'</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span> <span class="var">?msgs</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HORun_eq HOnextConfig_eq nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> vote r
  <span class="keyword1"><span class="command">have</span></span> nxt0<span class="main">:</span> <span class="quoted"><span class="quoted">"next0 <span class="skolem">r'</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span> <span class="var">?msgs</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s0<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="skolem">r'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  nextState_def UV_HOMachine_def UV_nextState_def next1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> run s0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reset_vote<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> vote nxt0
  <span class="keyword1"><span class="command">have</span></span> idv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="var">?msgs</span><span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> smallestValRcvd <span class="var">?msgs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> com <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> msgRcvd <span class="var">?msgs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> some_common_msg<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> idv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="var">?msgs</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> msgRcvd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"smallestValRcvd <span class="var">?msgs</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smallestValRcvd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of Irrevocability, Agreement and Integrity›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A decision can only be taken in the second round of a phase.›</span></span>

<span class="keyword1" id="UvProof-decide_step"><span class="command">lemma</span></span> decide_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> decide<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?msgs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"HOrcvdMsgs UV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nextState UV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="var">?msgs</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HORun_eq HOnextConfig_eq nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> decide <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nextState_def UV_HOMachine_def UV_nextState_def
                   next0_def step_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹No process ever decides <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>None›</span></span></span></span>.›</span></span>
<span class="keyword1" id="UvProof-decide_nonnull"><span class="command">lemma</span></span> decide_nonnull<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> decide<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?msgs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"HOrcvdMsgs UV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> decide_step<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next1 <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="var">?msgs</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HORun_eq HOnextConfig_eq
                   nextState_def UV_nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> decide <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next1_def dec_update_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If some process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> votes for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> at some round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>, then any message
  that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> received in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> was holding <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> as a value.
›</span></span>

<span class="keyword1" id="UvProof-msgs_unanimity"><span class="command">lemma</span></span> msgs_unanimity<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> vote<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> msgRcvd <span class="main">(</span>HOrcvdMsgs UV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
             <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> msgRcvd <span class="var">?msgs</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"getval <span class="main">(</span>the <span class="main">(</span><span class="var">?msgs</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> s0<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> run vote <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reset_vote<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> novote<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reset_vote<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nextState UV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="var">?msgs</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HORun_eq HOnextConfig_eq nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> s0 <span class="keyword1"><span class="command">have</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"next0 <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="var">?msgs</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def nextState_def UV_nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> novote vote q <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next0_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Any two processes can only vote for the same value.
›</span></span>
<span class="comment1">(* The proof relies on previous lemmas @{text some_common_msg} and @{text msgs_unanimity}. *)</span>

<span class="keyword1" id="UvProof-vote_agreement"><span class="command">lemma</span></span> vote_agreement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> com<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">with</span></span> run p <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="comment1">― ‹no votes in initial state›</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HORun_eq HOinitConfig_eq
                   initState_def UV_initState_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span>
  <span class="keyword3"><span class="command">assume</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> Suc <span class="skolem">r'</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?msgs</span> <span class="free">p</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"HOrcvdMsgs UV_M <span class="skolem">r'</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> com <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pq</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?msgs</span> <span class="free">p</span> <span class="skolem">pq</span> <span class="main">=</span> <span class="var">?msgs</span> <span class="free">q</span> <span class="skolem">pq</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> smp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pq</span> <span class="main">∈</span> msgRcvd <span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> smq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pq</span> <span class="main">∈</span> msgRcvd <span class="main">(</span><span class="var">?msgs</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> some_common_msg<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> run p smp r <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"getval <span class="main">(</span>the <span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span> <span class="skolem">pq</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> msgs_unanimity<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> run q smq r <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"getval <span class="main">(</span>the <span class="main">(</span><span class="var">?msgs</span> <span class="free">q</span> <span class="skolem">pq</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> msgs_unanimity<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If a process decides value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> then all processes must have <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>
  in their <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> fields.
›</span></span>
<span class="comment1">(* The proof relies on previous lemmas @{text decide_step}, @{text some_common_msg},
   @{text vote_agreement}. *)</span>

<span class="keyword1" id="UvProof-decide_equals_x"><span class="command">lemma</span></span> decide_equals_x<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> com<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> decide<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> decval<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?msgs</span> <span class="free">p'</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"HOrcvdMsgs UV_M <span class="free">r</span> <span class="free">p'</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p'</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> run decide <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> decide_step<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nextState UV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HORun_eq HOnextConfig_eq nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> s1 <span class="keyword1"><span class="command">have</span></span> nxtp<span class="main">:</span> <span class="quoted"><span class="quoted">"next1 <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def nextState_def UV_nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nextState UV_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="var">?msgs</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HORun_eq HOnextConfig_eq nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> s1 <span class="keyword1"><span class="command">have</span></span> nxtq<span class="main">:</span> <span class="quoted"><span class="quoted">"next1 <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="var">?msgs</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def nextState_def UV_nextState_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> com <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pq</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    pq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pq</span> <span class="main">∈</span> msgRcvd <span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pq</span> <span class="main">∈</span> msgRcvd <span class="main">(</span><span class="var">?msgs</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">pq</span> <span class="main">=</span> <span class="main">(</span><span class="var">?msgs</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">pq</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> some_common_msg<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> decide decval nxtp
  <span class="keyword1"><span class="command">have</span></span> vote<span class="main">:</span> <span class="quoted"><span class="quoted">"isValVote <span class="main">(</span>the <span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span> <span class="skolem">pq</span><span class="main">)</span><span class="main">)</span>"</span></span>
             <span class="quoted"><span class="quoted">"getvote <span class="main">(</span>the <span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span> <span class="skolem">pq</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next1_def dec_update_def identicalVoteRcvd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> nxtq pq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> someVoteRcvd <span class="main">(</span><span class="var">?msgs</span> <span class="free">q</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>getvote <span class="main">(</span>the <span class="main">(</span><span class="var">?msgs</span> <span class="free">q</span> <span class="skolem">q'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next1_def x_update_def someVoteRcvd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> s1 pq vote <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOrcvdMsgs_def UV_HOMachine_def UV_sendMsg_def send1_def
                   someVoteRcvd_def msgRcvd_def vote_agreement<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run com<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If at some point all processes hold value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> in their <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>
  fields, then this will still be the case at the next step.
›</span></span>
<span class="comment1">(* The proof relies on the previous lemma @{text x_vote_eq}. *)</span>

<span class="keyword1" id="UvProof-same_x_stable"><span class="command">lemma</span></span> same_x_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?msgs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"HOrcvdMsgs UV_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> comm <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> msgRcvd <span class="var">?msgs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> some_common_msg<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nextState UV_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="var">?msgs</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HORun_eq HOnextConfig_eq nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"next0 <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="var">?msgs</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>
         <span class="main">∨</span> next1 <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="var">?msgs</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> step <span class="free">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nxt0</span> <span class="main">∨</span> <span class="var">?nxt1</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def nextState_def UV_nextState_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> nxt0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?nxt0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> smallestValRcvd <span class="var">?msgs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next0_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> nxt0 x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> msgRcvd <span class="var">?msgs</span><span class="main">.</span> <span class="var">?msgs</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HOrcvdMsgs_def UV_sendMsg_def
                     msgRcvd_def send0_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="var">?msgs</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> msgRcvd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"smallestValRcvd <span class="var">?msgs</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smallestValRcvd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> nxt1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?nxt1</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"someVoteRcvd <span class="var">?msgs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> nxt1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> smallestValNoVoteRcvd <span class="var">?msgs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next1_def x_update_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> nxt1 x True 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> msgRcvd <span class="var">?msgs</span><span class="main">.</span> <span class="var">?msgs</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="main">(</span>ValVote <span class="free">v</span> None<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HOrcvdMsgs_def UV_sendMsg_def
                       msgRcvd_def send1_def someVoteRcvd_def isValVote_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="var">?msgs</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="main">(</span>ValVote <span class="bound">x</span> None<span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> msgRcvd_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"smallestValNoVoteRcvd <span class="var">?msgs</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smallestValNoVoteRcvd_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> nxt1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        p'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> msgRcvd <span class="var">?msgs</span>"</span></span> <span class="quoted"><span class="quoted">"isValVote <span class="main">(</span>the <span class="main">(</span><span class="var">?msgs</span> <span class="skolem">p'</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"getvote <span class="main">(</span>the <span class="main">(</span><span class="var">?msgs</span> <span class="skolem">p'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v'</span>"</span></span><span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> someVoteRcvd_def next1_def x_update_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> nxt1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HOrcvdMsgs_def UV_sendMsg_def
                       msgRcvd_def send1_def isValVote_def
                       x_vote_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run comm<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Combining the last two lemmas, it follows that as soon as some process
  decides value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>, all processes hold <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> in their <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> fields.
›</span></span>

<span class="keyword1" id="UvProof-safety_argument"><span class="command">lemma</span></span> safety_argument<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> com<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> decide<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> decval<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
  <span class="keyword1"><span class="command">from</span></span> decide_equals_x<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> run com <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> same_x_stable<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Any process that holds a non-null decision value has made a decision
  sometime in the past.
›</span></span>

<span class="keyword1" id="UvProof-decided_then_past_decision"><span class="command">lemma</span></span> decided_then_past_decision<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="bound">m</span> <span class="free">p</span><span class="main">)</span>
             <span class="main">∧</span> decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="free">k</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">k</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="var">?dec</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?dec</span> <span class="bound">m</span> <span class="main">⟶</span> <span class="var">?dec</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v</span><span class="main">)</span>
        <span class="main">⟶</span> <span class="var">?dec</span> <span class="free">n</span> <span class="main">≠</span> Some <span class="free">v</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="free">n</span> <span class="main">⟶</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HORun_eq UV_HOMachine_def HOinitConfig_eq
                     initState_def UV_initState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">n</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> dec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can now prove the safety properties of the algorithm, and start with
  proving Integrity.
›</span></span>

<span class="keyword1" id="UvProof-x_values_initial"><span class="command">lemma</span></span> x_values_initial<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span><span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> com<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?msgs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"HOrcvdMsgs UV_M <span class="skolem">r</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nextState UV_M <span class="skolem">r</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="skolem">p</span><span class="main">)</span> <span class="var">?msgs</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HORun_eq HOnextConfig_eq nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"next0 <span class="skolem">r</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="skolem">p</span><span class="main">)</span> <span class="var">?msgs</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∧</span> step <span class="skolem">r</span> <span class="main">=</span> <span class="main">0</span>
         <span class="main">∨</span> next1 <span class="skolem">r</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="skolem">p</span><span class="main">)</span> <span class="var">?msgs</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∧</span> step <span class="skolem">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nxt0</span> <span class="main">∨</span> <span class="var">?nxt1</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def nextState_def UV_nextState_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> nxt0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?nxt0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> smallestValRcvd <span class="var">?msgs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next0_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> com nxt0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">v</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> minval_step0<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> nxt0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="bound">q</span><span class="main">)</span> <span class="main">|</span> <span class="bound">q</span> <span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="var">?msgs</span> <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HOrcvdMsgs_def UV_sendMsg_def 
                     msgRcvd_def send0_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> nxt1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?nxt1</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"someVoteRcvd <span class="var">?msgs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> nxt1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> smallestValNoVoteRcvd <span class="var">?msgs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next1_def x_update_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> com nxt1 True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">v</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>ValVote <span class="bound">v</span> None<span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> minval_step1<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> nxt1 True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="bound">q</span><span class="main">)</span> <span class="main">|</span> <span class="bound">q</span> <span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="var">?msgs</span> <span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HOrcvdMsgs_def UV_sendMsg_def 
                       someVoteRcvd_def isValVote_def msgRcvd_def send1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> nxt1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> someVoteRcvd <span class="var">?msgs</span>"</span></span> 
        <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>getvote <span class="main">(</span>the <span class="main">(</span><span class="var">?msgs</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next1_def x_update_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> nxt1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HOrcvdMsgs_def UV_sendMsg_def 
                       someVoteRcvd_def isValVote_def msgRcvd_def send1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> run com <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> x_vote_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> uv_integrity<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> com<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run dec <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="skolem">k</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decided_then_past_decision<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> run com <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> decide_equals_x<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> run com <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> x_values_initial<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now turn to Agreement.
›</span></span>

<span class="keyword1" id="UvProof-two_decisions_agree"><span class="command">lemma</span></span> two_decisions_agree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> com<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> decidep<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> decvalp<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> decideq<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> decvalq<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run com decidep decvalp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> safety_argument<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> run com decideq decvalq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> decide_equals_x<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> uv_agreement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> com<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">m</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run p <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    k<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="skolem">k</span> <span class="free">p</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decided_then_past_decision<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> run q <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    l<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="skolem">l</span> <span class="free">q</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decided_then_past_decision<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">l</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">+</span><span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_iff_add<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> run com k l m <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> two_decisions_agree<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">l</span><span class="main">+</span><span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_iff_add<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> run com k l m <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> two_decisions_agree<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Irrevocability is a consequence of Agreement and the fact that no process
  can decide <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>None›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> uv_irrevocability<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> com<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">m</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="main">0</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> run ih <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> decide_nonnull<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> uv_agreement<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run com<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> w <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of Termination›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Two processes having the same \emph{Heard-Of} set at some round will
  hold the same value in their <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> variable at the next round.
›</span></span>
<span class="comment1">(* The proof relies on the previous lemma @{text vote_agreement}. *)</span>

<span class="keyword1" id="UvProof-hoeq_xeq"><span class="command">lemma</span></span> hoeq_xeq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> com<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hoeq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span> <span class="main">=</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?msgs</span> <span class="free">p</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"HOrcvdMsgs UV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> hoeq <span class="keyword1"><span class="command">have</span></span> msgeq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?msgs</span> <span class="free">p</span> <span class="main">=</span> <span class="var">?msgs</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HOrcvdMsgs_def UV_sendMsg_def 
                   send0_def send1_def<span class="main">)</span>
 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> run
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="var">?msgs</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="var">?nxt0</span> <span class="bound">p</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HORun_eq HOnextConfig_eq
                      nextState_def UV_nextState_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nxt0</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nxt0</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> msgeq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> run
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="var">?msgs</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="var">?nxt1</span> <span class="bound">p</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HORun_eq HOnextConfig_eq
                      nextState_def UV_nextState_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"x_update <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"x_update <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="var">?msgs</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> msgeq <span class="keyword1"><span class="command">have</span></span>
      x'<span class="main">:</span> <span class="quoted"><span class="quoted">"x_update <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"x_update <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"someVoteRcvd <span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> x' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x_update_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> x' stp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qp</span></span> <span class="skolem"><span class="skolem">qq</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="skolem">qp</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HOrcvdMsgs_def UV_sendMsg_def 
                        x_update_def someVoteRcvd_def isValVote_def 
                        msgRcvd_def send1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> run com <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vote_agreement<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now prove that \emph{UniformVoting} terminates.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> uv_termination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"HOcommGlobal UV_M <span class="free">HOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span> <span class="bound">v</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹First obtain a round where all <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> values agree.›</span></span>
  <span class="keyword1"><span class="command">from</span></span> commG <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r0</span></span> <span class="keyword2"><span class="keyword">where</span></span> r0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="free">HOs</span> <span class="skolem">r0</span> <span class="bound">q</span> <span class="main">=</span> <span class="free">HOs</span> <span class="skolem">r0</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def UV_commGlobal_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> run commR r0 <span class="keyword1"><span class="command">have</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="var">?v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> hoeq_xeq<span class="main">)</span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Now obtain a round where all votes agree.›</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> step <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Suc <span class="skolem">r0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> stp'<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="skolem">r'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r'_def step_def mod_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="var">?v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r'_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">from</span></span> xs <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">from</span></span> run commR xs <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="var">?v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> same_x_stable<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> vote'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="var">?v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?msgs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"HOrcvdMsgs UV_M <span class="skolem">r'</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r'</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> run stp' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next0 <span class="skolem">r'</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="skolem">q</span><span class="main">)</span> <span class="var">?msgs</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HORun_eq HOnextConfig_eq
                      nextState_def UV_nextState_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> stp' x' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q'</span> <span class="main">∈</span> msgRcvd <span class="var">?msgs</span><span class="main">.</span> <span class="var">?msgs</span> <span class="bound">q'</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="var">?v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HOrcvdMsgs_def UV_sendMsg_def 
                     send0_def msgRcvd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> commR <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgRcvd <span class="var">?msgs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> some_common_msg<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="var">?v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹At the subsequent round, process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> will decide.›</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">r'</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?msgs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"HOrcvdMsgs UV_M <span class="var">?r''</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="var">?r''</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> stp' <span class="keyword1"><span class="command">have</span></span> stp''<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="var">?r''</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next1 <span class="var">?r''</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r''</span> <span class="free">p</span><span class="main">)</span> <span class="var">?msgs'</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="var">?r''</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HORun_eq HOnextConfig_eq
                   nextState_def UV_nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> stp'' vote' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"identicalVoteRcvd <span class="var">?msgs'</span> <span class="var">?v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UV_HOMachine_def HOrcvdMsgs_def UV_sendMsg_def
                   send1_def identicalVoteRcvd_def isValVote_def msgRcvd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> commR <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgRcvd <span class="var">?msgs'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> some_common_msg<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="var">?r''</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="var">?v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next1_def dec_update_def identicalVoteRcvd_def
                    msgRcvd_def isValVote_def<span class="main">)</span>
  <span class="comment1">(* subtle point: there can't be two different identical votes received,
     proving this requires "force" and takes a while *)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹\emph{UniformVoting} Solves Consensus›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Summing up, all (coarse-grained) runs of \emph{UniformVoting} for
  HO collections that satisfy the communication predicate satisfy
  the Consensus property.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> uv_consensus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="free">rho</span> <span class="free">HOs</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"HOcommGlobal UV_M <span class="free">HOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consensus <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> decide <span class="free">rho</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> consensus_def image_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> uv_integrity uv_agreement uv_termination<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  By the reduction theorem, the correctness of the algorithm carries over
  to the fine-grained model of runs.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> uv_consensus_fg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run UV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">HOs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">q</span><span class="main">.</span> undefined<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> HOcommPerRd UV_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"HOcommGlobal UV_M <span class="free">HOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consensus <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> x <span class="main">(</span>state <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> decide <span class="main">(</span>state <span class="main">∘</span> <span class="free">rho</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"consensus <span class="var">?inits</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> local_property_reduction<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run consensus_is_local<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">crun</span>
  <span class="keyword3"><span class="command">assume</span></span> crun<span class="main">:</span> <span class="quoted"><span class="quoted">"CSHORun UV_M <span class="skolem">crun</span> <span class="free">HOs</span> <span class="free">HOs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">q</span><span class="main">.</span> undefined<span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">crun</span> <span class="main">0</span> <span class="main">=</span> state <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> crun <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HORun UV_M <span class="skolem">crun</span> <span class="free">HOs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> HORun_def SHORun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this commR commG <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consensus <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="skolem">crun</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> decide <span class="skolem">crun</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> uv_consensus<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> init <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consensus <span class="var">?inits</span> decide <span class="skolem">crun</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LastVotingDefs">
<div class="head">
<h1>Theory LastVotingDefs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> LastVotingDefs
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#HOModel">../HOModel</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Verification of the \emph{LastVoting} Consensus Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The \emph{LastVoting} algorithm can be considered as a representation of
  Lamport's Paxos consensus algorithm~\cite{lamport:part-time}
  in the Heard-Of model. It is a coordinated algorithm designed to
  tolerate benign failures. Following~\cite{charron:heardof}, we formalize
  its proof of correctness in Isabelle, using the framework of theory <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>HOModel›</span></span></span></span>.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model of the Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We begin by introducing an anonymous type of processes of finite
  cardinality that will instantiate the type variable <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'proc›</span></span></span></span>
  of the generic CHO model.
›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> Proc <span class="comment1">― ‹the set of processes›</span>
<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span> Proc_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">OFCLASS</span><span class="main">(</span>Proc<span class="main">,</span> finite_class<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> Proc <span class="main">::</span> <span class="quoted">finite</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Proc_finite<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> card <span class="main">(</span>UNIV<span class="main">::</span>Proc set<span class="main">)</span>"</span></span>   <span class="comment1">― ‹number of processes›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The algorithm proceeds in \emph{phases} of $4$ rounds each (we call
  \emph{steps} the individual rounds that constitute a phase).
  The following utility functions compute the phase and step of a round,
  given the round number.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">phase</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">phase</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">div</span> <span class="numeral">4</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">step</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">mod</span> <span class="numeral">4</span>"</span></span>

<span class="keyword1" id="LastVotingDefs-phase_zero"><span class="command">lemma</span></span> phase_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> phase_def<span class="main">)</span>

<span class="keyword1" id="LastVotingDefs-step_zero"><span class="command">lemma</span></span> step_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>

<span class="keyword1" id="LastVotingDefs-phase_step"><span class="command">lemma</span></span> phase_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>phase <span class="free">r</span> <span class="main">*</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">+</span> step <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> phase_def step_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following record models the local state of a process.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'val</span> pstate <span class="main">=</span>
  x <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'val</span></span></span>                <span class="comment1">― ‹current value held by process›</span>
  vote <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>    <span class="comment1">― ‹value the process voted for, if any›</span>
  commt <span class="main">::</span> <span class="quoted">bool</span>            <span class="comment1">― ‹did the process commit to the vote?›</span>
  ready <span class="main">::</span> <span class="quoted">bool</span>            <span class="comment1">― ‹for coordinators: did the round finish successfully?›</span>
  timestamp <span class="main">::</span> <span class="quoted">nat</span>         <span class="comment1">― ‹time stamp of current value›</span>
  decide <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>  <span class="comment1">― ‹value the process has decided on, if any›</span>
  coordΦ <span class="main">::</span> <span class="quoted">Proc</span>           <span class="comment1">― ‹coordinator for current phase›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Possible messages sent during the execution of the algorithm.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'val</span> msg <span class="main">=</span>
  ValStamp <span class="quoted"><span class="quoted">"<span class="tfree">'val</span>"</span></span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="main">|</span> Vote <span class="quoted"><span class="quoted">"<span class="tfree">'val</span>"</span></span>
<span class="main">|</span> Ack
<span class="main">|</span> Null  <span class="comment1">― ‹dummy message in case nothing needs to be sent›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Characteristic predicates on messages.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isValStamp</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isValStamp</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">v</span> <span class="bound">ts</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> ValStamp <span class="bound">v</span> <span class="bound">ts</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isVote</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isVote</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> Vote <span class="bound">v</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isAck</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isAck</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> Ack"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Selector functions to retrieve components of messages. These functions
  have a meaningful result only when the message is of an appropriate kind.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">val</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">val</span> <span class="main">(</span>ValStamp <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">val</span> <span class="main">(</span>Vote <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">stamp</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stamp</span> <span class="main">(</span>ValStamp <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field of the initial state is unconstrained, all other
  fields are initialized appropriately.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LV_initState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LV_initState</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="main">≡</span>
     vote <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None
   <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span>commt <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span>ready <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>
   <span class="main">∧</span> timestamp <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="main">0</span>
   <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None
   <span class="main">∧</span> coordΦ <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We separately define the transition predicates and the send functions
  for each step and later combine them to define the overall next-state relation.
›</span></span>

<span class="comment1">― ‹processes from which values and timestamps were received›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valStampsRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valStampsRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">::</span> Proc <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="main">≡</span>
   <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">v</span> <span class="bound">ts</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>ValStamp <span class="bound">v</span> <span class="bound">ts</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">highestStampRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">highestStampRcvd</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">≡</span> 
   Max <span class="main">{</span><span class="bound">ts</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">q</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">::</span>Proc <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>ValStamp <span class="bound">v</span> <span class="bound">ts</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In step 0, each process sends its current <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>timestamp›</span></span></span></span>
  values to its coordinator.

  A process that considers itself to be a coordinator updates its
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vote›</span></span></span></span> field if it has received messages from a majority of processes.
  It then sets its <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>commt›</span></span></span></span> field to true.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> coordΦ <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">then</span> ValStamp <span class="main">(</span>x <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">(</span>timestamp <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="keyword1">else</span> Null"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> coordΦ <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">∧</span> card <span class="main">(</span>valStampsRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>
      <span class="keyword1">then</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">p</span> <span class="main">=</span> Some <span class="main">(</span>ValStamp <span class="bound">v</span> <span class="main">(</span>highestStampRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">)</span><span class="main">)</span>
                <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> vote <span class="main">:=</span> Some <span class="bound">v</span><span class="main">,</span> commt <span class="main">:=</span> True <span class="main">⦈</span> <span class="main">)</span>
      <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In step 1, coordinators that have committed send their vote to all
  processes.

  Processes update their <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>timestamp›</span></span></span></span> fields if they
  have received a vote from their coordinator.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> coordΦ <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">∧</span> commt <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">then</span> Vote <span class="main">(</span>the <span class="main">(</span>vote <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> Null"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">(</span>coordΦ <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">≠</span> None <span class="main">∧</span> isVote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">(</span>coordΦ <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> x <span class="main">:=</span> val <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">(</span>coordΦ <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> timestamp <span class="main">:=</span> Suc<span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⦈</span>
   <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In step 2, processes that have current timestamps send an acknowledgement
  to their coordinator.

  A coordinator sets its <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ready›</span></span></span></span> field to true if it receives a majority
  of acknowledgements.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> timestamp <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> Suc<span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> coordΦ <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">then</span> Ack <span class="keyword1">else</span> Null"</span></span>

<span class="comment1">― ‹processes from which an acknowledgement was received›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">acksRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">acksRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">::</span> Proc <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="main">≡</span>
   <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">≠</span> None <span class="main">∧</span> isAck <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> coordΦ <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">∧</span> card <span class="main">(</span>acksRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>
   <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> ready <span class="main">:=</span> True <span class="main">⦈</span>
   <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In step 3, coordinators that are ready send their vote to all processes.

  Processes that received a vote from their coordinator decide on that value.
  Coordinators reset their <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ready›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>commt›</span></span></span></span> fields to false.
  All processes reset the coordinators as indicated by the parameter of
  the operator.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send3</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> coordΦ <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">∧</span> ready <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">then</span> Vote <span class="main">(</span>the <span class="main">(</span>vote <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> Null"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next3</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">(</span>coordΦ <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">≠</span> None <span class="main">∧</span> isVote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">(</span>coordΦ <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">then</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> Some <span class="main">(</span>val <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">(</span>coordΦ <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">else</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> decide <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> coordΦ <span class="free"><span class="bound"><span class="entity">st</span></span></span>
      <span class="keyword1">then</span> <span class="main">¬</span><span class="main">(</span>ready <span class="free"><span class="bound"><span class="entity">st'</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span>commt <span class="free"><span class="bound"><span class="entity">st'</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> ready <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> ready <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">∧</span> commt <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> commt <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>
   <span class="main">∧</span> x <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> x <span class="free"><span class="bound"><span class="entity">st</span></span></span>
   <span class="main">∧</span> vote <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> vote <span class="free"><span class="bound"><span class="entity">st</span></span></span>
   <span class="main">∧</span> timestamp <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> timestamp <span class="free"><span class="bound"><span class="entity">st</span></span></span>
   <span class="main">∧</span> coordΦ <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The overall send function and next-state relation are simply obtained as
  the composition of the individual relations defined above.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LV_sendMsg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Proc <span class="main">⇒</span> Proc <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> <span class="tfree">'val</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LV_sendMsg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span>
   <span class="keyword1">if</span> step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> send0 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> send1 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> send2 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> send3 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">LV_nextState</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Proc <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> <span class="main">(</span>Proc <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> 
                       <span class="main">⇒</span> Proc <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LV_nextState</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> next0 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> next1 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> next2 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> next3 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Communication Predicate for \emph{LastVoting}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the communication predicate that will be assumed for the
  correctness proof of the \emph{LastVoting} algorithm.
  The ``per-round'' part is trivial: integrity and agreement are always ensured.

  For the ``global'' part, Charron-Bost and Schiper propose a predicate
  that requires the existence of infinitely many phases <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ph›</span></span></span></span> such that:
  \begin{itemize}
  \item all processes agree on the same coordinator <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span>,
  \item <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span> hears from a strict majority of processes in steps 0 and 2
    of phase <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ph›</span></span></span></span>, and
  \item every process hears from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span> in steps 1 and 3 (this is slightly
    weaker than the predicate that appears in~\cite{charron:heardof}, but
    obviously sufficient).
  \end{itemize}

  Instead of requiring infinitely many such phases, we only assume the
  existence of one such phase (Charron-Bost and Schiper note that this is enough.)
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">LV_commPerRd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LV_commPerRd</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HO</span></span></span><span class="main">::</span>Proc HO<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">coord</span></span></span><span class="main">::</span>Proc coord<span class="main">)</span> <span class="main">≡</span> True"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">LV_commGlobal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LV_commGlobal</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">coords</span></span></span> <span class="main">≡</span>
      <span class="main">∃</span><span class="bound">ph</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">∃</span><span class="bound">c</span><span class="main">::</span>Proc<span class="main">.</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">coords</span></span></span> <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">ph</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="bound">c</span><span class="main">)</span>
         <span class="main">∧</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">ph</span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>
         <span class="main">∧</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">ph</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">ph</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">ph</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The \emph{LastVoting} Heard-Of Machine›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the coordinated HO machine for the \emph{LastVoting} algorithm
  by assembling the algorithm definition and its communication-predicate.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LV_CHOMachine</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LV_CHOMachine</span> <span class="main">≡</span>
    <span class="main">⦇</span> CinitState <span class="main">=</span> LV_initState<span class="main">,</span>
      sendMsg <span class="main">=</span> LV_sendMsg<span class="main">,</span>
      CnextState <span class="main">=</span> LV_nextState<span class="main">,</span>
      CHOcommPerRd <span class="main">=</span> LV_commPerRd<span class="main">,</span>
      CHOcommGlobal <span class="main">=</span> LV_commGlobal <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">LV_M</span> <span class="main">≡</span> <span class="main">(</span>LV_CHOMachine<span class="main">::</span><span class="main">(</span>Proc<span class="main">,</span> <span class="tfree">'val</span> pstate<span class="main">,</span> <span class="tfree">'val</span> msg<span class="main">)</span> CHOMachine<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LastVotingProof">
<div class="head">
<h1>Theory LastVotingProof</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> LastVotingProof
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#LastVotingDefs">LastVotingDefs</a> <span class="quoted">"<a href="#Majorities">../Majorities</a>"</span> <span class="quoted">"<a href="#Reduction">../Reduction</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminary Lemmas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We begin by proving some simple lemmas about the utility functions
  used in the model of \emph{LastVoting}. We also specialize the induction
  rules of the generic CHO model for this particular algorithm.
›</span></span>

<span class="keyword1" id="LastVotingProof-timeStampsRcvdFinite"><span class="command">lemma</span></span> timeStampsRcvdFinite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">ts</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">q</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">msgs</span><span class="main">::</span>Proc <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>ValStamp <span class="bound">v</span> <span class="bound">ts</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?ts</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="main">=</span> stamp <span class="main">`</span> the <span class="main">`</span> <span class="free">msgs</span> <span class="main">`</span> <span class="main">(</span>valStampsRcvd <span class="free">msgs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valStampsRcvd_def image_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LastVotingProof-highestStampRcvd_exists"><span class="command">lemma</span></span> highestStampRcvd_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nempty<span class="main">:</span> <span class="quoted"><span class="quoted">"valStampsRcvd <span class="free">msgs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">msgs</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span>ValStamp <span class="free">v</span> <span class="main">(</span>highestStampRcvd <span class="free">msgs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ts</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">q</span> <span class="bound">v</span><span class="main">.</span> <span class="free">msgs</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>ValStamp <span class="bound">v</span> <span class="bound">ts</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> nempty <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valStampsRcvd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> timeStampsRcvdFinite
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"highestStampRcvd <span class="free">msgs</span> <span class="main">∈</span> <span class="var">?ts</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> highestStampRcvd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max_in<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">msgs</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="main">(</span>ValStamp <span class="skolem">v</span> <span class="main">(</span>highestStampRcvd <span class="free">msgs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> highestStampRcvd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LastVotingProof-highestStampRcvd_max"><span class="command">lemma</span></span> highestStampRcvd_max<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">msgs</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span>ValStamp <span class="free">v</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">≤</span> highestStampRcvd <span class="free">msgs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> highestStampRcvd_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Max_ge timeStampsRcvdFinite<span class="main">)</span>

<span class="keyword1" id="LastVotingProof-phase_Suc"><span class="command">lemma</span></span> phase_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"phase <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> step <span class="free">r</span> <span class="main">=</span> <span class="numeral">3</span> <span class="keyword1">then</span> Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span>
                   <span class="keyword1">else</span> phase <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> step_def phase_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Many proofs are by induction on runs of the LastVoting algorithm, and
  we derive a specific induction rule to support these proofs.
›</span></span>

<span class="keyword1" id="LastVotingProof-LV_induct"><span class="command">lemma</span></span> LV_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> CinitState LV_M <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">coords</span> <span class="main">0</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span>
                  <span class="main">⟦</span> step <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> <span class="free">P</span> <span class="bound">r</span><span class="main">;</span> phase <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> phase <span class="bound">r</span><span class="main">;</span> step <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">;</span>
                    <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span>
                              <span class="main">(</span>HOrcvdMsgs LV_M <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
                              <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
                              <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟧</span>
                  <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span>
                  <span class="main">⟦</span> step <span class="bound">r</span> <span class="main">=</span> <span class="main">1</span><span class="main">;</span> <span class="free">P</span> <span class="bound">r</span><span class="main">;</span> phase <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> phase <span class="bound">r</span><span class="main">;</span> step <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">;</span>
                    <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span>
                              <span class="main">(</span>HOrcvdMsgs LV_M <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
                              <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
                              <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟧</span>
                  <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span>
                  <span class="main">⟦</span> step <span class="bound">r</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">;</span> <span class="free">P</span> <span class="bound">r</span><span class="main">;</span> phase <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> phase <span class="bound">r</span><span class="main">;</span> step <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">;</span>
                    <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next2 <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span>
                              <span class="main">(</span>HOrcvdMsgs LV_M <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
                              <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
                              <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟧</span>
                  <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span>
                  <span class="main">⟦</span> step <span class="bound">r</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">;</span> <span class="free">P</span> <span class="bound">r</span><span class="main">;</span> phase <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="bound">r</span><span class="main">)</span><span class="main">;</span> step <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span>
                    <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next3 <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span>
                              <span class="main">(</span>HOrcvdMsgs LV_M <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
                              <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
                              <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟧</span>
                  <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> CHORun_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"CHOinitConfig LV_M <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">coords</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CHOinitConfig_def init<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">r</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"CHOnextConfig LV_M <span class="skolem">r</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> 
                                 <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="skolem">r</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="skolem">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ih nxt stp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> step0<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def CHOnextConfig_eq 
                     LV_nextState_def LV_sendMsg_def phase_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="skolem">r</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ih nxt stp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> step1<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def CHOnextConfig_eq 
                     LV_nextState_def LV_sendMsg_def phase_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="skolem">r</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ih nxt stp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> step2<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def CHOnextConfig_eq 
                     LV_nextState_def LV_sendMsg_def phase_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="skolem">r</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ih nxt stp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> step3<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def CHOnextConfig_eq 
                     LV_nextState_def LV_sendMsg_def phase_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following rule similarly establishes a property of two successive
  configurations of a run by case distinction on the step that was executed.
›</span></span>

<span class="keyword1" id="LastVotingProof-LV_Suc"><span class="command">lemma</span></span> LV_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">;</span> phase <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> phase <span class="free">r</span><span class="main">;</span>
                <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">p</span><span class="main">)</span>
                          <span class="main">(</span>HOrcvdMsgs LV_M <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>
                          <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="free">P</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> step <span class="free">r</span> <span class="main">=</span> <span class="main">1</span><span class="main">;</span> step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">;</span> phase <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> phase <span class="free">r</span><span class="main">;</span>
                <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">p</span><span class="main">)</span>
                          <span class="main">(</span>HOrcvdMsgs LV_M <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>
                          <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="free">P</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> step <span class="free">r</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">;</span> step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">;</span> phase <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> phase <span class="free">r</span><span class="main">;</span>
                <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next2 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">p</span><span class="main">)</span>
                          <span class="main">(</span>HOrcvdMsgs LV_M <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>
                          <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="free">P</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> step <span class="free">r</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">;</span> step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> phase <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span><span class="main">;</span>
                <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next3 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">p</span><span class="main">)</span>
                          <span class="main">(</span>HOrcvdMsgs LV_M <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>
                          <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="free">P</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run 
  <span class="keyword1"><span class="command">have</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"CHOnextConfig LV_M <span class="free">r</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> 
                                  <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CHORun_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> nxt stp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> step0<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def CHOnextConfig_eq 
                     LV_nextState_def LV_sendMsg_def phase_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> nxt stp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> step1<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def CHOnextConfig_eq 
                     LV_nextState_def LV_sendMsg_def phase_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> nxt stp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> step2<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def CHOnextConfig_eq 
                     LV_nextState_def LV_sendMsg_def phase_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> nxt stp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> step3<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def CHOnextConfig_eq 
                     LV_nextState_def LV_sendMsg_def phase_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Sometimes the assertion to prove talks about a specific process and follows
  from the next-state relation of that particular process. We prove corresponding 
  variants of the induction and case-distinction rules. When these variants are
  applicable, they help automating the Isabelle proof.
›</span></span>

<span class="keyword1" id="LastVotingProof-LV_induct'"><span class="command">lemma</span></span> LV_induct'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"CinitState LV_M <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">coords</span> <span class="main">0</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">p</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="main">⟦</span> step <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> <span class="free">P</span> <span class="free">p</span> <span class="bound">r</span><span class="main">;</span> phase <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> phase <span class="bound">r</span><span class="main">;</span> step <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">;</span>
                     next0 <span class="bound">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span>
                           <span class="main">(</span>HOrcvdMsgs LV_M <span class="bound">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
                           <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟧</span>
                  <span class="main">⟹</span> <span class="free">P</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="main">⟦</span> step <span class="bound">r</span> <span class="main">=</span> <span class="main">1</span><span class="main">;</span> <span class="free">P</span> <span class="free">p</span> <span class="bound">r</span><span class="main">;</span> phase <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> phase <span class="bound">r</span><span class="main">;</span> step <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">;</span>
                     next1 <span class="bound">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span>
                           <span class="main">(</span>HOrcvdMsgs LV_M <span class="bound">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
                           <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟧</span>
                  <span class="main">⟹</span> <span class="free">P</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="main">⟦</span> step <span class="bound">r</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">;</span> <span class="free">P</span> <span class="free">p</span> <span class="bound">r</span><span class="main">;</span> phase <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> phase <span class="bound">r</span><span class="main">;</span> step <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">;</span>
                     next2 <span class="bound">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span>
                           <span class="main">(</span>HOrcvdMsgs LV_M <span class="bound">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
                           <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟧</span>
                  <span class="main">⟹</span> <span class="free">P</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="main">⟦</span> step <span class="bound">r</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">;</span> <span class="free">P</span> <span class="free">p</span> <span class="bound">r</span><span class="main">;</span> phase <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="bound">r</span><span class="main">)</span><span class="main">;</span> step <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span>
                     next3 <span class="bound">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span>
                           <span class="main">(</span>HOrcvdMsgs LV_M <span class="bound">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
                           <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟧</span>
                  <span class="main">⟹</span> <span class="free">P</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">p</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LV_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> init step0 step1 step2 step3<span class="main">)</span>

<span class="keyword1" id="LastVotingProof-LV_Suc'"><span class="command">lemma</span></span> LV_Suc'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">;</span> phase <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> phase <span class="free">r</span><span class="main">;</span>
                next0 <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>
                      <span class="main">(</span>HOrcvdMsgs LV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="free">P</span> <span class="free">p</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> step <span class="free">r</span> <span class="main">=</span> <span class="main">1</span><span class="main">;</span> step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">;</span> phase <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> phase <span class="free">r</span><span class="main">;</span>
                next1 <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>
                      <span class="main">(</span>HOrcvdMsgs LV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="free">P</span> <span class="free">p</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> step <span class="free">r</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">;</span> step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">;</span> phase <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> phase <span class="free">r</span><span class="main">;</span>
                next2 <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>
                      <span class="main">(</span>HOrcvdMsgs LV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="free">P</span> <span class="free">p</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> step <span class="free">r</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">;</span> step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> phase <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span><span class="main">;</span>
                next3 <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>
                      <span class="main">(</span>HOrcvdMsgs LV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="free">P</span> <span class="free">p</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">p</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LV_Suc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step0 step1 step2 step3<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Boundedness and Monotonicity of Timestamps›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The timestamp of any process is bounded by the current phase.
›</span></span>

<span class="keyword1" id="LastVotingProof-LV_timestamp_bounded"><span class="command">lemma</span></span> LV_timestamp_bounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">if</span> step <span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="keyword1">then</span> phase <span class="free">n</span> <span class="keyword1">else</span> Suc <span class="main">(</span>phase <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LV_induct' <span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?P</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def LV_initState_def 
                 next0_def next1_def next2_def next3_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Moreover, timestamps can only grow over time.
›</span></span>

<span class="keyword1" id="LastVotingProof-LV_timestamp_increasing"><span class="command">lemma</span></span> LV_timestamp_increasing<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LV_Suc'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?P</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The case of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>next1›</span></span></span></span> is the only interesting one because the
    timestamp may change: here we use the previously established fact that
    the timestamp is bounded by the phase number.›</span></span>
  <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"next1 <span class="free">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span>
                     <span class="main">(</span>HOrcvdMsgs LV_M <span class="free">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> stp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="main">≤</span> phase <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LV_timestamp_bounded<span class="main">[</span><span class="operator">OF</span> run<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">n</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> nxt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next1_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def next2_def next3_def<span class="main">)</span>

<span class="keyword1" id="LastVotingProof-LV_timestamp_monotonic"><span class="command">lemma</span></span> LV_timestamp_monotonic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="free">m</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="free">m</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> le <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">m</span><span class="main">+</span><span class="skolem">k</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_iff_add<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="free">m</span> <span class="main">≤</span> <span class="var">?ts</span> <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?ts</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LV_timestamp_increasing<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> k <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following definition collects the set of processes whose timestamp
  is beyond a given bound at a system state.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">procsBeyondTS</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">procsBeyondTS</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">p</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">≤</span> timestamp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Since timestamps grow monotonically, so does the set of processes
  that are beyond a certain bound.
›</span></span>

<span class="keyword1" id="LastVotingProof-procsBeyondTS_monotonic"><span class="command">lemma</span></span> procsBeyondTS_monotonic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> procsBeyondTS <span class="free">ts</span> <span class="main">(</span><span class="free">rho</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> procsBeyondTS <span class="free">ts</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">≤</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="free">m</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> <span class="var">?ts</span> <span class="free">m</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> procsBeyondTS_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> run le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="free">m</span> <span class="main">≤</span> <span class="var">?ts</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LV_timestamp_monotonic<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> procsBeyondTS_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Obvious Facts About the Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemmas state some very obvious facts that follow
  ``immediately'' from the definition of the algorithm. We could
  prove them in one fell swoop by defining a big invariant, but it
  appears more readable to prove them separately.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Coordinators change only at step 3.
›</span></span>

<span class="keyword1" id="LastVotingProof-notStep3EqualCoord"><span class="command">lemma</span></span> notStep3EqualCoord<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> stp<span class="main">:</span><span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">≠</span> <span class="numeral">3</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="free">r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LV_Suc'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?P</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stp next0_def next1_def next2_def<span class="main">)</span>

<span class="keyword1" id="LastVotingProof-coordinators"><span class="command">lemma</span></span> coordinators<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">coords</span> <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="main">(</span>phase <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="main">(</span>phase <span class="free">r</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="main">(</span>phase <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="var">?r1</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">coords</span> <span class="var">?r1</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"phase <span class="free">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"phase <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> run <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def CHORun_eq CHOinitConfig_def
                     LV_initState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="var">?r0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"step <span class="var">?r0</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mod_Suc step_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> run 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LV_nextState <span class="var">?r0</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r0</span> <span class="free">p</span><span class="main">)</span>
                  <span class="main">(</span>HOrcvdMsgs LV_M <span class="var">?r0</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="var">?r0</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r0</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="var">?r0</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="var">?r0</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def CHORun_eq CHOnextConfig_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"next3 <span class="var">?r0</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r0</span> <span class="free">p</span><span class="main">)</span>
                      <span class="main">(</span>HOrcvdMsgs LV_M <span class="var">?r0</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="var">?r0</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r0</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="var">?r0</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="var">?r0</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_nextState_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="var">?r0</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">coords</span> <span class="main">(</span>Suc <span class="var">?r0</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next3_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> run
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="var">?r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="var">?r1</span> <span class="free">p</span><span class="main">)</span>
        <span class="main">∧</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="var">?r1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="var">?r1</span> <span class="free">p</span><span class="main">)</span>
        <span class="main">∧</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="var">?r1</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="var">?r1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> notStep3EqualCoord step_def phase_def mod_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?r1</span><span class="main">,</span> Suc <span class="var">?r1</span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="var">?r1</span><span class="main">)</span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="var">?r1</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def phase_def mod_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Votes only change at step 0.
›</span></span>

<span class="keyword1" id="LastVotingProof-notStep0EqualVote"><span class="command">lemma</span></span> notStep0EqualVote <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> vote <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="free">r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LV_Suc'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?P</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next0_def next1_def next2_def next3_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Commit status only changes at steps 0 and 3.
›</span></span>

<span class="keyword1" id="LastVotingProof-notStep03EqualCommit"><span class="command">lemma</span></span> notStep03EqualCommit <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> step <span class="free">r</span> <span class="main">≠</span> <span class="numeral">3</span> <span class="main">⟶</span> commt <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> commt <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="free">r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LV_Suc'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?P</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next0_def next1_def next2_def next3_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Timestamps only change at step 1.
›</span></span>

<span class="keyword1" id="LastVotingProof-notStep1EqualTimestamp"><span class="command">lemma</span></span> notStep1EqualTimestamp <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟶</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="free">r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LV_Suc'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?P</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next0_def next1_def next2_def next3_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field only changes at step 1.
›</span></span>

<span class="keyword1" id="LastVotingProof-notStep1EqualX"><span class="command">lemma</span></span> notStep1EqualX <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟶</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="free">r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LV_Suc'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?P</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next0_def next1_def next2_def next3_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A process $p$ has its <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>commt›</span></span></span></span> flag set only if the following conditions hold:
  \begin{itemize}
  \item the step number is at least $1$,
  \item $p$ considers itself to be the coordinator,
  \item $p$ has a non-null <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vote›</span></span></span></span>,
  \item a majority of processes consider $p$ as their coordinator.
  \end{itemize}
›</span></span>

<span class="keyword1" id="LastVotingProof-commitE"><span class="command">lemma</span></span> commitE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cmt<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> conds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">1</span> <span class="main">≤</span> step <span class="free">r</span><span class="main">;</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">;</span> vote <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> None<span class="main">;</span>
                card <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">}</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>
              <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟶</span> 
          <span class="main">1</span> <span class="main">≤</span> step <span class="free">r</span>
        <span class="main">∧</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>
        <span class="main">∧</span> vote <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> None
        <span class="main">∧</span> card <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">}</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> <span class="var">?R</span> <span class="free">r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LV_induct'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?P</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="comment1">― ‹the only interesting step is step 0›</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"next0 <span class="skolem">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>HOrcvdMsgs LV_M <span class="skolem">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>
                           <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> ph<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> phase <span class="skolem">n</span>"</span></span> 
       <span class="keyword2"><span class="keyword">and</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> stp'<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> cm'<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> stp ih <span class="keyword1"><span class="command">have</span></span> cm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> commt <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> nxt cm'
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>
            <span class="main">∧</span> vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> None 
            <span class="main">∧</span> card <span class="main">(</span>valStampsRcvd <span class="main">(</span>HOrcvdMsgs LV_M <span class="skolem">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> stp 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valStampsRcvd <span class="main">(</span>HOrcvdMsgs LV_M <span class="skolem">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>
             <span class="main">⊆</span> <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valStampsRcvd_def LV_CHOMachine_def
                       HOrcvdMsgs_def  LV_sendMsg_def send0_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>valStampsRcvd <span class="main">(</span>HOrcvdMsgs LV_M <span class="skolem">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span>  <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">≤</span> card <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">note</span></span> stp stp' run
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> notStep3EqualCoord<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="comment1">― ‹the remaining cases are all solved by expanding the definitions›</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def LV_initState_def next1_def next2_def
                  next3_def notStep3EqualCoord<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> cmt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conds<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A process has a current timestamp only if:
  \begin{itemize}
  \item it is at step 2 or beyond,
  \item its coordinator has committed,
  \item its <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> value is the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vote›</span></span></span></span> of its coordinator.
  \end{itemize}
›</span></span>

<span class="keyword1" id="LastVotingProof-currentTimestampE"><span class="command">lemma</span></span> currentTimestampE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> conds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="numeral">2</span> <span class="main">≤</span> step <span class="free">r</span><span class="main">;</span>
                commt <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="main">(</span>coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                x <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>vote <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="main">(</span>coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="free">n</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?crd</span> <span class="free">n</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="free">r</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span> <span class="main">⟶</span> 
           <span class="numeral">2</span> <span class="main">≤</span> step <span class="free">r</span> 
         <span class="main">∧</span> commt <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="main">(</span><span class="var">?crd</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>
         <span class="main">∧</span> x <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>vote <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="main">(</span><span class="var">?crd</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">p</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> <span class="var">?R</span> <span class="free">r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LV_induct'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?Q</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="comment1">― ‹The assertion is trivially true initially because the timestamp is 0.›</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"CinitState LV_M <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">coords</span> <span class="main">0</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">p</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def LV_initState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The assertion is trivially preserved by step 0 because the timestamp in the
          post-state cannot be current (cf. lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>LV_timestamp_bounded›</span></span></span></span>).›</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> stp'<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> run LV_timestamp_bounded<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> phase <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Step 1 establishes the assertion by definition of the transition relation.›</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> stp'<span class="main">:</span><span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> ph<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> phase <span class="skolem">n</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"next1 <span class="skolem">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>HOrcvdMsgs LV_M <span class="skolem">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> 
                           <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> run stp LV_timestamp_bounded<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="skolem">n</span> <span class="main">≤</span> phase <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> run stp
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?crd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="main">(</span><span class="var">?crd</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> notStep3EqualCoord notStep0EqualVote<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> run stp
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?crd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> commt <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="main">(</span><span class="var">?crd</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> notStep3EqualCoord notStep03EqualCommit<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">note</span></span> ts nxt stp stp' ph
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def HOrcvdMsgs_def LV_sendMsg_def
                       next1_def send1_def isVote_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹For step 2, the assertion follows from the induction hypothesis,
          observing that none of the relevant state components change.›</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="skolem">n</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> stp'<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> ph<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> phase <span class="skolem">n</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">p</span> <span class="skolem">n</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"next2 <span class="skolem">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>HOrcvdMsgs LV_M <span class="skolem">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>
                           <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> run stp
      <span class="keyword1"><span class="command">have</span></span> vt<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?crd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="main">(</span><span class="var">?crd</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep3EqualCoord notStep0EqualVote<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> run stp
      <span class="keyword1"><span class="command">have</span></span> cmt<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?crd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> commt <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="main">(</span><span class="var">?crd</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep3EqualCoord notStep03EqualCommit<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> vt ts ph stp stp' ih nxt
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next2_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The assertion is trivially preserved by step 3 because the timestamp in the
          post-state cannot be current (cf. lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>LV_timestamp_bounded›</span></span></span></span>).›</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> stp'<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> run LV_timestamp_bounded<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> phase <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> ts <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conds<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If a process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> has its <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ready›</span></span></span></span> bit set then:
  \begin{itemize}
  \item it is at step 3,
  \item it considers itself to be the coordinator of that phase and
  \item a majority of processes considers <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> to be the coordinator
    and has a current timestamp.
  \end{itemize}
›</span></span>

<span class="keyword1" id="LastVotingProof-readyE"><span class="command">lemma</span></span> readyE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rdy<span class="main">:</span> <span class="quoted"><span class="quoted">"ready <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> conds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> step <span class="free">r</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">;</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">;</span>
                card <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> 
                         <span class="main">∧</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span> <span class="main">}</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>
              <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?qs</span> <span class="free">n</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> 
                     <span class="main">∧</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="free">n</span><span class="main">)</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ready <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟶</span> 
          step <span class="free">r</span> <span class="main">=</span> <span class="numeral">3</span>
        <span class="main">∧</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>
        <span class="main">∧</span> card <span class="main">(</span><span class="var">?qs</span> <span class="free">r</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">p</span> <span class="free">r</span>"</span></span>  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> <span class="var">?R</span> <span class="free">p</span> <span class="free">r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LV_induct'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?Q</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="comment1">― ‹the interesting case is step 2›</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="skolem">n</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> stp'<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">p</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ph<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> phase <span class="skolem">n</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"next2 <span class="skolem">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>HOrcvdMsgs LV_M <span class="skolem">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>
                           <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> rdy<span class="main">:</span> <span class="quoted"><span class="quoted">"ready <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> stp ih <span class="keyword1"><span class="command">have</span></span> nrdy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ready <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> rdy nxt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next2_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> run stp <span class="keyword1"><span class="command">have</span></span> coord<span class="main">:</span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep3EqualCoord<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?acks</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"acksRcvd <span class="main">(</span>HOrcvdMsgs LV_M <span class="skolem">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> nrdy rdy nxt <span class="keyword1"><span class="command">have</span></span> aRcvd<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?acks</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next2_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acks</span> <span class="main">⊆</span> <span class="var">?qs</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
        <span class="keyword3"><span class="command">assume</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="var">?acks</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> stp 
        <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def HOrcvdMsgs_def LV_sendMsg_def 
                         acksRcvd_def send2_def isAck_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> run stp ph
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>
              <span class="main">∧</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep3EqualCoord notStep1EqualTimestamp<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?acks</span> <span class="main">≤</span> card <span class="main">(</span><span class="var">?qs</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> stp' coord aRcvd <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="comment1">― ‹the remaining steps are all solved trivially›</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def LV_initState_def
                  next0_def next1_def next3_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> rdy <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> conds<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A process decides only if the following conditions hold:
  \begin{itemize}
  \item it is at step 3,
  \item its coordinator votes for the value the process decides on,
  \item the coordinator has its <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ready›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>commt›</span></span></span></span> bits set.
  \end{itemize}
›</span></span>

<span class="keyword1" id="LastVotingProof-decisionE"><span class="command">lemma</span></span> decisionE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> conds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
        step <span class="free">r</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">;</span> 
        decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="main">(</span>vote <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="main">(</span>coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        ready <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="main">(</span>coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> commt <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="main">(</span>coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cfg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">rho</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cfg'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?crd</span> <span class="free">p</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="var">?cfg</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dec'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="var">?cfg'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Except for the assertion about the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>commt›</span></span></span></span> field, the assertion can be
         proved directly from the next-state relation.›</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="numeral">3</span>
           <span class="main">∧</span> <span class="var">?dec'</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="main">(</span>vote <span class="main">(</span><span class="var">?cfg</span> <span class="main">(</span><span class="var">?crd</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
           <span class="main">∧</span> ready <span class="main">(</span><span class="var">?cfg</span> <span class="main">(</span><span class="var">?crd</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">p</span> <span class="free">r</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LV_Suc'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?Q</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="comment1">― ‹for step 3, we prove the thesis by expanding the relevant definitions›</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"next3 <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="var">?cfg</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>HOrcvdMsgs LV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="var">?cfg</span><span class="main">)</span> 
                      <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="var">?cfg'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> dec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next3_def send3_def isVote_def LV_CHOMachine_def 
                     HOrcvdMsgs_def LV_sendMsg_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="comment1">― ‹the other steps don't change the decision›</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"next0 <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="var">?cfg</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>HOrcvdMsgs LV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="var">?cfg</span><span class="main">)</span>
                      <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="var">?cfg'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> dec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"next1 <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="var">?cfg</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>HOrcvdMsgs LV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="var">?cfg</span><span class="main">)</span>
                      <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="var">?cfg'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> dec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"next2 <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="var">?cfg</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>HOrcvdMsgs LV_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="var">?cfg</span><span class="main">)</span>
                      <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="var">?cfg'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> dec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ready <span class="main">(</span><span class="var">?cfg</span> <span class="main">(</span><span class="var">?crd</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Because the coordinator is ready, there is a majority of processes that
         consider it to be the coordinator and that have a current timestamp.›</span></span>
  <span class="keyword1"><span class="command">with</span></span> run
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> <span class="var">?crd</span> <span class="bound">q</span> <span class="main">=</span> <span class="var">?crd</span> <span class="free">p</span> <span class="main">∧</span> timestamp <span class="main">(</span><span class="var">?cfg</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span><span class="main">}</span> 
          <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> readyE<span class="main">)</span>
  <span class="comment1">― ‹Hence there is at least one such process \ldots›</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> <span class="var">?crd</span> <span class="bound">q</span> <span class="main">=</span> <span class="var">?crd</span> <span class="free">p</span> <span class="main">∧</span> timestamp <span class="main">(</span><span class="var">?cfg</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span><span class="main">}</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>  <span class="comment1">(** auto simplifies too much **)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?crd</span> <span class="skolem">q</span> <span class="main">=</span> <span class="var">?crd</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="var">?cfg</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">― ‹\ldots\ and by a previous lemma the coordinator must have committed.›</span>
  <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="var">?cfg</span> <span class="main">(</span><span class="var">?crd</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> currentTimestampE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> conds<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of Integrity›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Integrity is proved using a standard invariance argument that asserts
  that only values present in the initial state appear in the relevant
  fields.
›</span></span>

<span class="comment1">(*
  The proof mainly relies on lemmas @{text notStep1EqualX},
  @{text notStep0EqualVote}, @{text commitE} and @{text decisionE}.
*)</span>

<span class="keyword1" id="LastVotingProof-lv_integrityInvariant"><span class="command">lemma</span></span> lv_integrityInvariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> range <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> range <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
              range <span class="main">(</span>vote <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> Some <span class="main">`</span> range <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
              range <span class="main">(</span>decide <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> Some <span class="main">`</span> range <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>
       <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>x <span class="main">∘</span> <span class="free">rho</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x0opt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> Some <span class="main">`</span> <span class="var">?x0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>x <span class="main">∘</span> <span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?x0</span>
        <span class="main">∧</span> range <span class="main">(</span>vote <span class="main">∘</span> <span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?x0opt</span>
        <span class="main">∧</span> range <span class="main">(</span>decide <span class="main">∘</span> <span class="free">rho</span> <span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?x0opt</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Inv</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="free">n</span> <span class="main">∧</span> <span class="var">?Vote</span> <span class="free">n</span> <span class="main">∧</span> <span class="var">?Decide</span> <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Inv</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> CHORun_eq CHOinitConfig_def LV_CHOMachine_def
                     LV_initState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Inv</span> <span class="skolem">n</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Inv</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Vote</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Decide</span> <span class="skolem">n</span>"</span></span>

      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Proof of first conjunct›</span></span>
      <span class="keyword1"><span class="command">have</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
        <span class="keyword1"><span class="command">from</span></span> run
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">p</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LV_Suc'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?P</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="comment1">― ‹only <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">step1</span><span class="antiquote">}</span></span> is of interest›</span>
          <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
             <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"next1 <span class="skolem">n</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>
                             <span class="main">(</span>HOrcvdMsgs LV_M <span class="skolem">n</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>
                             <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">with</span></span> stp nxt <span class="keyword1"><span class="command">have</span></span> cmt<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="main">(</span>coordΦ <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> xp<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="main">(</span>coordΦ <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next1_def LV_CHOMachine_def HOrcvdMsgs_def 
                           LV_sendMsg_def send1_def isVote_def<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> run cmt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="main">(</span>coordΦ <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> commitE<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">from</span></span> vt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="main">(</span>coordΦ <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?x0opt</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">note</span></span> xp
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="comment1">― ‹the other steps don't change <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">x</span><span class="antiquote">}</span></span>›</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"step <span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep1EqualX<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"step <span class="skolem">n</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep1EqualX<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"step <span class="skolem">n</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep1EqualX<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Proof of second conjunct›</span></span>
      <span class="keyword1"><span class="command">have</span></span> vt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Vote</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">v</span>
        <span class="keyword3"><span class="command">assume</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> run
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span> <span class="main">⟶</span> <span class="skolem">v</span> <span class="main">∈</span> <span class="var">?x0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">p</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LV_Suc'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?P</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="comment1">― ‹here only <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">step0</span><span class="antiquote">}</span></span> is of interest›</span>
          <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
             <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"next0 <span class="skolem">n</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>
                             <span class="main">(</span>HOrcvdMsgs LV_M <span class="skolem">n</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>
                             <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span>  <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">from</span></span> vt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?x0opt</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">from</span></span> nxt stp False v <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next0_def send0_def LV_CHOMachine_def 
                             HOrcvdMsgs_def LV_sendMsg_def<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="comment1">― ‹the other cases don't change the vote›</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"step <span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep0EqualVote<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> vt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?x0opt</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"step <span class="skolem">n</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep0EqualVote<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> vt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?x0opt</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"step <span class="skolem">n</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep0EqualVote<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> vt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?x0opt</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">with</span></span> v <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Proof of third conjunct›</span></span>
      <span class="keyword1"><span class="command">have</span></span> dec'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Decide</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">v</span>
        <span class="keyword3"><span class="command">assume</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> decide <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">with</span></span> dec True v <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?crd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> False run 
          <span class="keyword1"><span class="command">have</span></span> d'<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="main">(</span>vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="var">?crd</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword2"><span class="keyword">and</span></span> cmt<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="var">?crd</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> decisionE<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> vt <span class="keyword1"><span class="command">have</span></span> vtc<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="var">?crd</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?x0opt</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> run cmt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="var">?crd</span><span class="main">)</span> <span class="main">≠</span> None"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> commitE<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> d' v vtc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> x' vt' dec' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> inv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Integrity now follows immediately.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> lv_integrity<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> Some <span class="main">`</span> <span class="main">(</span>range <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lv_integrityInvariant<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> dec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of Agreement and Irrevocability›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemmas closely follow a hand proof provided by
  Bernadette Charron-Bost.

  If a process decides, then a majority of processes have a current
  timestamp.
›</span></span>
<span class="comment1">(*
  The proof mainly relies on lemmas @{text decisionE}, @{text readyE}
  and @{text LV_timestamp_bounded}. 
*)</span>

<span class="keyword1" id="LastVotingProof-decisionThenMajorityBeyondTS"><span class="command">lemma</span></span> decisionThenMajorityBeyondTS<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>procsBeyondTS <span class="main">(</span>Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> run dec <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> decisionE<span class="main">)</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>decisionE›</span></span></span></span> tells us that we are at step 3 and
    that the coordinator is ready.›</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?crd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?qs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="var">?crd</span>
                 <span class="main">∧</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span> <span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rdy<span class="main">:</span> <span class="quoted"><span class="quoted">"ready <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="var">?crd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Now, lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>readyE›</span></span></span></span> implies that a majority of processes
    have a recent timestamp.›</span></span>
  <span class="keyword1"><span class="command">from</span></span> run rdy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?qs</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> readyE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> stp LV_timestamp_bounded<span class="main">[</span><span class="operator">OF</span> run<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?qs</span> <span class="main">⊆</span> procsBeyondTS <span class="main">(</span>Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> procsBeyondTS_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?qs</span> <span class="main">≤</span> card <span class="main">(</span>procsBeyondTS <span class="main">(</span>Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  No two different processes have their \emph{commit} flag set at any state.
›</span></span>

<span class="keyword1" id="LastVotingProof-committedProcsEqual"><span class="command">lemma</span></span> committedProcsEqual<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> cmt<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cmt'<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">p'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run cmt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">}</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> commitE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> run cmt' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">p'</span><span class="main">}</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> commitE<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> majoritiesE'<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  No two different processes have their \emph{ready} flag set at any state.
›</span></span>

<span class="keyword1" id="LastVotingProof-readyProcsEqual"><span class="command">lemma</span></span> readyProcsEqual<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rdy<span class="main">:</span> <span class="quoted"><span class="quoted">"ready <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rdy'<span class="main">:</span> <span class="quoted"><span class="quoted">"ready <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">p'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="free">p</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span> <span class="main">.</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> run rdy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?C</span> <span class="free">p</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> readyE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> run rdy' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?C</span> <span class="free">p'</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> readyE<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> majoritiesE'<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemma asserts that whenever a process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> commits
  at a state where a majority of processes have a timestamp beyond <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ts›</span></span></span></span>,
  then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> votes for a value held by some process whose timestamp is
  beyond <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ts›</span></span></span></span>.
›</span></span>
<span class="comment1">(*
  The proof mainly relies on lemmas @{text commitE}, @{text highestStampRcvd_max},
  @{text notStep1EqualTimestamp}, @{text notStep1EqualX} and then on
  lemmas @{text notStep03EqualCommit}, @{text notStep0EqualVote}, @{text commitE},
  @{text committedProcsEqual} and @{text LV_timestamp_monotonic}.
*)</span>

<span class="keyword1" id="LastVotingProof-commitThenVoteRecent"><span class="command">lemma</span></span> commitThenVoteRecent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> maj<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>procsBeyondTS <span class="free">ts</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> cmt<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> procsBeyondTS <span class="free">ts</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span><span class="main">.</span> vote <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>x <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bynd</span> <span class="free">n</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"procsBeyondTS <span class="free">ts</span> <span class="main">(</span><span class="free">rho</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?bynd</span> <span class="free">r</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">∧</span> commt <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟶</span> <span class="var">?Q</span> <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="free">r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LV_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>next0›</span></span></span></span> establishes the property›</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> next0 <span class="skolem">n</span> <span class="bound">q</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="bound">q</span><span class="main">)</span> 
                             <span class="main">(</span>HOrcvdMsgs LV_M <span class="skolem">n</span> <span class="bound">q</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> 
                             <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> 
                             <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
              <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="var">?nxt</span> <span class="bound">q</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> nxt <span class="keyword1"><span class="command">have</span></span> nxp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?nxt</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> mj<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?bynd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
         <span class="keyword2"><span class="keyword">and</span></span> ct<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?msgs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"HOrcvdMsgs LV_M <span class="skolem">n</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> stp run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> commt <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> commitE<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> nxp ct <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?msgs</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span>ValStamp <span class="skolem">v</span> <span class="main">(</span>highestStampRcvd <span class="var">?msgs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          vote<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          rcvd<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>valStampsRcvd <span class="var">?msgs</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next0_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> mj rcvd <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          q1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> <span class="var">?bynd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> valStampsRcvd <span class="var">?msgs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> majoritiesE'<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">≤</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> q2' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">ts'</span></span>
            <span class="keyword2"><span class="keyword">where</span></span> ts'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?msgs</span> <span class="skolem">q'</span> <span class="main">=</span> Some <span class="main">(</span>ValStamp <span class="skolem">v'</span> <span class="skolem">ts'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valStampsRcvd_def<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts'</span> <span class="main">≤</span> highestStampRcvd <span class="var">?msgs</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> highestStampRcvd_max<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> ts' stp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ts'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def HOrcvdMsgs_def 
                           LV_sendMsg_def send0_def<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> v stp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> highestStampRcvd <span class="var">?msgs</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def HOrcvdMsgs_def
                           LV_sendMsg_def send0_def<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> run stp 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">=</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep1EqualTimestamp<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> run stp
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep1EqualTimestamp<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">note</span></span> q1'
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="var">?bynd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> procsBeyondTS_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> v vote stp
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>x <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def HOrcvdMsgs_def
                         LV_sendMsg_def send0_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> run stp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep1EqualX<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹We now prove that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>next1›</span></span></span></span> preserves the property.
      Observe that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>next1›</span></span></span></span> may establish a majority of processes
      with current timestamps, so we cannot just refer to the induction
      hypothesis. However, if that happens, there is at least one process
      with a fresh timestamp that copies the vote of the (only) committed
      coordinator, thus establishing the property.›</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> next1 <span class="skolem">n</span> <span class="bound">q</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="bound">q</span><span class="main">)</span> 
                               <span class="main">(</span>HOrcvdMsgs LV_M <span class="skolem">n</span> <span class="bound">q</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> 
                               <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span>
                               <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span>"</span></span> 
               <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="var">?nxt</span> <span class="bound">q</span>"</span></span><span class="main">)</span>
       <span class="keyword2"><span class="keyword">and</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> nxt <span class="keyword1"><span class="command">have</span></span> nxp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?nxt</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> mj'<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?bynd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
         <span class="keyword2"><span class="keyword">and</span></span> ct'<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> run stp ct' <span class="keyword1"><span class="command">have</span></span> ct<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep03EqualCommit<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> run stp <span class="keyword1"><span class="command">have</span></span> vote'<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep0EqualVote<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> <span class="var">?bynd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">q</span> <span class="main">≠</span> <span class="free">rho</span> <span class="skolem">n</span> <span class="bound">q</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹in this case the property holds because <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> updates
          its <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field to the vote›</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          q1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="var">?bynd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">≠</span> <span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">from</span></span> nxt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nxt</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">with</span></span> q2 stp
        <span class="keyword1"><span class="command">have</span></span>  x'<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="main">(</span>coordΦ <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> coord<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="main">(</span>coordΦ <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next1_def send1_def LV_CHOMachine_def HOrcvdMsgs_def
                         LV_sendMsg_def isVote_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> run ct <span class="keyword1"><span class="command">have</span></span> vote<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> None"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> commitE<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> run coord ct <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> committedProcsEqual<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> q1 x' vote vote' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹if no relevant process moves then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>procsBeyondTS›</span></span></span></span> doesn't 
          change and we invoke the induction hypothesis›</span></span>
        <span class="keyword1"><span class="command">hence</span></span> bynd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?bynd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="var">?bynd</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> procsBeyondTS_def<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
          <span class="keyword3"><span class="command">assume</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">≤</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">≤</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LV_timestamp_monotonic<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> ts <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">≤</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">with</span></span> mj' <span class="keyword1"><span class="command">have</span></span> mj<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?bynd</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> ct ih <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="var">?bynd</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>x <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> vote' bynd False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>step2›</span></span></span></span> preserves the property, via the induction hypothesis.›</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="skolem">n</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> next2 <span class="skolem">n</span> <span class="bound">q</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="bound">q</span><span class="main">)</span> 
                               <span class="main">(</span>HOrcvdMsgs LV_M <span class="skolem">n</span> <span class="bound">q</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">n</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> 
                               <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> 
                               <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
               <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="var">?nxt</span> <span class="bound">q</span>"</span></span><span class="main">)</span>
       <span class="keyword2"><span class="keyword">and</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> nxt <span class="keyword1"><span class="command">have</span></span> nxp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?nxt</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> mj'<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?bynd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
         <span class="keyword2"><span class="keyword">and</span></span> ct'<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> run stp ct' <span class="keyword1"><span class="command">have</span></span> ct<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep03EqualCommit<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> run stp <span class="keyword1"><span class="command">have</span></span> vote'<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> vote <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep0EqualVote<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> run stp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep1EqualTimestamp<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> bynd'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?bynd</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="var">?bynd</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> procsBeyondTS_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> run stp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> notStep1EqualX<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> bynd' vote' ct mj' ih <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹the initial state and the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>step3›</span></span></span></span> transition are trivial 
    because the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>commt›</span></span></span></span> flag cannot be set.›</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> commitE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> maj cmt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemma gives the crucial argument for agreement:
  after some process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> has decided, all processes whose
  timestamp is beyond the timestamp at the point of decision contain
  the decision value in their <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field.
›</span></span>
<span class="comment1">(*
  The proof mainly relies on lemmas @{text LV_timestamp_bounded},
  @{text currentTimestampE}, @{text committedProcsEqual},
  @{text decisionThenMajorityBeyondTS}, @{text procsBeyondTS_monotonic}
  @{text commitThenVoteRecent}, @{text  notStep1EqualX}
  and @{text notStep1EqualTimestamp}.
*)</span>

<span class="keyword1" id="LastVotingProof-XOfTimestampBeyondDecision"><span class="command">lemma</span></span> XOfTimestampBeyondDecision<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> procsBeyondTS <span class="main">(</span>Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
              x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="var">?bynd</span> <span class="free">k</span><span class="main">.</span> <span class="main">_</span> <span class="main">=</span> <span class="var">?v</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="free">k</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="comment1">― ‹base step›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="var">?bynd</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹use preceding lemmas about the decision value and the 
      <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field of processes with fresh timestamps›</span></span>
    <span class="keyword1"><span class="command">from</span></span> run dec
    <span class="keyword1"><span class="command">have</span></span>  stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="main">(</span>vote <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="main">(</span>coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cmt<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="main">(</span>coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> decisionE<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> stp LV_timestamp_bounded<span class="main">[</span><span class="operator">OF</span> run<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> procsBeyondTS_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> run
    <span class="keyword1"><span class="command">have</span></span>  x<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>vote <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="main">(</span>coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cmt'<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="main">(</span>coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> currentTimestampE<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> run cmt cmt' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> committedProcsEqual<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> x v <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="main">0</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">― ‹induction step›</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="skolem">k</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">p</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="var">?bynd</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="comment1">― ‹distinguish the kind of transition---only <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">step1</span><span class="antiquote">}</span></span> is interesting›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="var">?v</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LV_Suc'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?X</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"next1 <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>
                      <span class="main">(</span>HOrcvdMsgs LV_M <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>
                      <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span> <span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">q</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> q ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> procsBeyondTS_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">from</span></span> run dec <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?bynd</span> <span class="main">0</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> decisionThenMajorityBeyondTS<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bynd</span> <span class="main">0</span> <span class="main">⊆</span> <span class="var">?bynd</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> procsBeyondTS_monotonic<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?bynd</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="var">?bynd</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> maj<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?bynd</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?crd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> False stp nxt <span class="keyword1"><span class="command">have</span></span> 
          cmt<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="var">?crd</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          x<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="var">?crd</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next1_def LV_CHOMachine_def HOrcvdMsgs_def
                         LV_sendMsg_def send1_def isVote_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> run maj cmt stp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span>
          <span class="keyword2"><span class="keyword">where</span></span> q1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> <span class="var">?bynd</span> <span class="skolem">k</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> q2'<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="var">?crd</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">q'</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> commitThenVoteRecent<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> x ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="comment1">― ‹all other steps hold by induction hypothesis›</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> notStep1EqualX notStep1EqualTimestamp<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ts q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="var">?bynd</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> procsBeyondTS_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> x ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> notStep1EqualX notStep1EqualTimestamp<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ts q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="var">?bynd</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> procsBeyondTS_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> x ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> notStep1EqualX notStep1EqualTimestamp<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ts q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="var">?bynd</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> procsBeyondTS_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> x ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We are now in position to prove Agreement: if some process decides
  at step <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> and another (or possibly the same) process decides
  at step <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r+k›</span></span></span></span> then they decide the same value.
›</span></span>

<span class="comment1">(*
  The proof mainly relies on lemmas @{text decisionE},
  @{text decisionThenMajorityBeyondTS}, @{text procsBeyondTS_monotonic}
  @{text commitThenVoteRecent} and @{text XOfTimestampBeyondDecision}.
*)</span>

<span class="keyword1" id="LastVotingProof-laterProcessDecidesSameValue"><span class="command">lemma</span></span> laterProcessDecidesSameValue<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bynd</span> <span class="free">k</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"procsBeyondTS <span class="main">(</span>Suc <span class="main">(</span>phase <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?qcrd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> run p <span class="keyword1"><span class="command">have</span></span> notNone<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> decisionE<span class="main">)</span>
  <span class="comment1">― ‹process <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">q</span><span class="antiquote">}</span></span> decides on the vote of its coordinator›</span>
  <span class="keyword1"><span class="command">from</span></span> run q
  <span class="keyword1"><span class="command">have</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="main">(</span>vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="var">?qcrd</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> cmt<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="var">?qcrd</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> decisionE<span class="main">)</span>
  <span class="comment1">― ‹that vote is the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">x</span><span class="antiquote">}</span></span> field of some process <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"q'"</span><span class="antiquote">}</span></span> with a recent timestamp›</span>
  <span class="keyword1"><span class="command">from</span></span> run p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?bynd</span> <span class="main">0</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> decisionThenMajorityBeyondTS<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bynd</span> <span class="main">0</span> <span class="main">⊆</span> <span class="var">?bynd</span> <span class="free">k</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> procsBeyondTS_monotonic<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?bynd</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="var">?bynd</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> maj<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?bynd</span> <span class="free">k</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> run maj cmt <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> q'1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> <span class="var">?bynd</span> <span class="free">k</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> q'2<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="var">?qcrd</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="skolem">q'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> commitThenVoteRecent<span class="main">)</span>
  <span class="comment1">― ‹the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">x</span><span class="antiquote">}</span></span> field of process <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"q'"</span><span class="antiquote">}</span></span> is the value <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">p</span><span class="antiquote">}</span></span> decided on›</span>
  <span class="keyword1"><span class="command">from</span></span> run p q'1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> XOfTimestampBeyondDecision<span class="main">)</span>
  <span class="comment1">― ‹which proves the assertion›</span>
  <span class="keyword1"><span class="command">with</span></span> dec q'2 notNone <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A process that holds some decision <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> has decided <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>
  sometime in the past.
›</span></span>

<span class="keyword1" id="LastVotingProof-decisionNonNullThenDecided"><span class="command">lemma</span></span> decisionNonNullThenDecided<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="bound">m</span> <span class="free">p</span><span class="main">)</span> 
             <span class="main">∧</span> decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="free">k</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">k</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="var">?dec</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?dec</span> <span class="bound">m</span> <span class="main">⟶</span> <span class="var">?dec</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v</span><span class="main">)</span>
         <span class="main">⟶</span> <span class="var">?dec</span> <span class="free">n</span> <span class="main">≠</span> Some <span class="free">v</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="free">n</span> <span class="main">⟶</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> CHORun_eq LV_CHOMachine_def
                     CHOinitConfig_def LV_initState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="skolem">n</span> <span class="main">≠</span> Some <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> p
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?dec</span> <span class="skolem">n</span> <span class="main">⟶</span> <span class="var">?dec</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> v <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> dec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Irrevocability and Agreement are straightforward consequences
  of the two preceding lemmas.
›</span></span>
<span class="comment1">(*
  The proof mainly relies on lemmas @{text decisionNonNullThenDecided}
  and @{text laterProcessDecidesSameValue}. 
*)</span>

<span class="keyword1"><span class="command">theorem</span></span> lv_irrevocability<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">m</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run p <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    n1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    n2<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="skolem">n</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    n3<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decisionNonNullThenDecided<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="var">?dec</span> <span class="bound">i</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> n3 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> ctr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="var">?dec</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> ih 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> run n2
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> laterProcessDecidesSameValue<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> ctr n3 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> n1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">+</span><span class="free">k</span> <span class="main">=</span> Suc<span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_imp_Suc_add<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> lv_agreement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">m</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run p <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> k1<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="skolem">k</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> k2<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decisionNonNullThenDecided<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> run q <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> l1<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="skolem">l</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> l2<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decisionNonNullThenDecided<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">l</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">+</span><span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_iff_add<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> run k1 l1 m
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> laterProcessDecidesSameValue<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> k2 l2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">l</span><span class="main">+</span><span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_iff_add<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> run l1 k1 m
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> laterProcessDecidesSameValue<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> l2 k2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of Termination›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  The proof of termination relies on the communication predicate,
  which stipulates the existence of some phase
  during which there is a single coordinator that (a) receives a majority
  of messages and (b) is heard by everybody. Therefore, all processes
  successfully execute the protocol, deciding at step $3$ of that phase.
›</span></span>
<span class="comment1">(*
  The proof mainly relies on lemmas @{text notStep3EqualCoord},
  @{text commitE} and @{text readyE}.
*)</span>

<span class="keyword1"><span class="command">theorem</span></span> lv_termination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span><span class="quoted"><span class="quoted">"CHOcommGlobal LV_M <span class="free">HOs</span> <span class="free">coords</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The communication predicate implies the existence of a ``successful'' phase
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ph›</span></span></span></span>, coordinated by some process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span> for all processes.›</span></span>
  <span class="keyword1"><span class="command">from</span></span> commG <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ph</span></span> <span class="skolem"><span class="skolem">c</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">coords</span> <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="skolem">ph</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> maj0<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="skolem">ph</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> maj2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="skolem">ph</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rcv1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="skolem">ph</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rcv3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="skolem">ph</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LV_CHOMachine_def LV_commGlobal_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span><span class="main">*</span><span class="skolem">ph</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Suc <span class="var">?r0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Suc <span class="var">?r1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r3</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Suc <span class="var">?r2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r4</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Suc <span class="var">?r3</span>"</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span> is the coordinator of all steps of phase <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ph›</span></span></span></span>.›</span></span>
  <span class="keyword1"><span class="command">from</span></span> run c <span class="keyword1"><span class="command">have</span></span> c'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> phase_def coordinators<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="var">?r1</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def mod_Suc notStep3EqualCoord<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="var">?r2</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def mod_Suc notStep3EqualCoord<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> c3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> coordΦ <span class="main">(</span><span class="free">rho</span> <span class="var">?r3</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def mod_Suc notStep3EqualCoord<span class="main">)</span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The coordinator receives <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ValStamp›</span></span></span></span> messages from a majority of
    processes at step $0$ of phase <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ph›</span></span></span></span> and therefore commits during the
    transition at the end of step $0$.›</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="var">?r1</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">c</span> <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="skolem">ph</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LV_Suc'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?P</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"next0 <span class="var">?r</span> <span class="skolem">c</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span>HOrcvdMsgs LV_M <span class="var">?r</span> <span class="skolem">c</span> <span class="main">(</span><span class="free">HOs</span> <span class="var">?r</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="var">?r</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="var">?r</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> c' maj0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="var">?r</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def next0_def send0_def valStampsRcvd_def 
                     LV_CHOMachine_def HOrcvdMsgs_def LV_sendMsg_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹All processes receive the vote of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span> at step 1 and therefore
    update their time stamps during the transition at the end of step $1$.›</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> timestamp <span class="main">(</span><span class="free">rho</span> <span class="var">?r2</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">ph</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?msgs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"HOrcvdMsgs LV_M <span class="var">?r1</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="var">?r1</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?crd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="var">?r1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> run 1 c1 rcv1
    <span class="keyword1"><span class="command">have</span></span> cnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?msgs</span> <span class="var">?crd</span> <span class="main">≠</span> None <span class="main">∧</span> isVote <span class="main">(</span>the <span class="main">(</span><span class="var">?msgs</span> <span class="var">?crd</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> commitE
               <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def LV_CHOMachine_def HOrcvdMsgs_def
                     LV_sendMsg_def send1_def isVote_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"timestamp <span class="main">(</span><span class="free">rho</span> <span class="var">?r2</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">ph</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">p</span> <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="skolem">ph</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LV_Suc'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?P</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"next1 <span class="var">?r1</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r1</span> <span class="skolem">p</span><span class="main">)</span> <span class="var">?msgs</span> <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="var">?r1</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r2</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> cnd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next1_def phase_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The coordinator receives acknowledgements from a majority of processes
    at step $2$ and sets its <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ready›</span></span></span></span> flag during the transition at the
    end of step $2$.›</span></span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"ready <span class="main">(</span><span class="free">rho</span> <span class="var">?r3</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">c</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="skolem">ph</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LV_Suc'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?P</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"next2 <span class="var">?r2</span> <span class="skolem">c</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r2</span> <span class="skolem">c</span><span class="main">)</span> 
                      <span class="main">(</span>HOrcvdMsgs LV_M <span class="var">?r2</span> <span class="skolem">c</span> <span class="main">(</span><span class="free">HOs</span> <span class="var">?r2</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r2</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="var">?r2</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r3</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 2 c2 maj2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mod_Suc step_def LV_CHOMachine_def HOrcvdMsgs_def
                     LV_sendMsg_def next2_def send2_def acksRcvd_def
                     isAck_def phase_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹All processes receive the vote of the coordinator during step $3$
    and decide during the transition at the end of that step.›</span></span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="var">?r4</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?msgs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"HOrcvdMsgs LV_M <span class="var">?r3</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="var">?r3</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r3</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?crd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"coordΦ <span class="main">(</span><span class="free">rho</span> <span class="var">?r3</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> run 3 c3 rcv3
    <span class="keyword1"><span class="command">have</span></span> cnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?msgs</span> <span class="var">?crd</span> <span class="main">≠</span> None <span class="main">∧</span> isVote <span class="main">(</span>the <span class="main">(</span><span class="var">?msgs</span> <span class="var">?crd</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> readyE
               <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def mod_Suc LV_CHOMachine_def HOrcvdMsgs_def
                     LV_sendMsg_def send3_def isVote_def numeral_3_eq_3<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="var">?r4</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> None"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">p</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="skolem">ph</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LV_Suc'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?P</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"next3 <span class="var">?r3</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r3</span> <span class="skolem">p</span><span class="main">)</span> <span class="var">?msgs</span> <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="var">?r3</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r4</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> cnd <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="var">?r4</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next3_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹This immediately proves the assertion.›</span></span>
  <span class="keyword1"><span class="command">from</span></span> 4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹\emph{LastVoting} Solves Consensus›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Summing up, all (coarse-grained) runs of \emph{LastVoting} for
  HO collections that satisfy the communication predicate satisfy
  the Consensus property.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> lv_consensus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"CHOcommGlobal LV_M <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consensus <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> decide <span class="free">rho</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹the above statement of termination is stronger than what we need›</span>
  <span class="keyword1"><span class="command">from</span></span> lv_termination<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> lv_integrity<span class="main">[</span><span class="operator">OF</span> run<span class="main">]</span> lv_agreement<span class="main">[</span><span class="operator">OF</span> run<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> consensus_def image_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  By the reduction theorem, the correctness of the algorithm carries over
  to the fine-grained model of runs.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> lv_consensus_fg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run LV_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"CHOcommGlobal LV_M <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consensus <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> x <span class="main">(</span>state <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> decide <span class="main">(</span>state <span class="main">∘</span> <span class="free">rho</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"consensus <span class="var">?inits</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> local_property_reduction<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run consensus_is_local<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">crun</span>
  <span class="keyword3"><span class="command">assume</span></span> crun<span class="main">:</span> <span class="quoted"><span class="quoted">"CSHORun LV_M <span class="skolem">crun</span> <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">crun</span> <span class="main">0</span> <span class="main">=</span> state <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> crun <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"CHORun LV_M <span class="skolem">crun</span> <span class="free">HOs</span> <span class="free">coords</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> CHORun_def SHORun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this commG <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consensus <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="skolem">crun</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> decide <span class="skolem">crun</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lv_consensus<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> init <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consensus <span class="var">?inits</span> decide <span class="skolem">crun</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="UteDefs">
<div class="head">
<h1>Theory UteDefs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> UteDefs
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#HOModel">../HOModel</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Verification of the \ute{} Consensus Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Algorithm \ute{} is presented in~\cite{biely:tolerating}. It is an
  uncoordinated algorithm that tolerates value (a.k.a.\ Byzantine) faults,
  and can be understood as a variant of \emph{UniformVoting}. The parameters
  $T$, $E$, and $\alpha$ appear as thresholds of the algorithm and in the
  communication predicates. Their values can be chosen within certain bounds
  in order to adapt the algorithm to the characteristics of different systems.

  We formalize in Isabelle the correctness proof of the algorithm that
  appears in~\cite{biely:tolerating}, using the framework of theory
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>HOModel›</span></span></span></span>.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model of the Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We begin by introducing an anonymous type of processes of finite
  cardinality that will instantiate the type variable <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'proc›</span></span></span></span>
  of the generic HO model.
›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> Proc <span class="comment1">― ‹the set of processes›</span>
<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span> Proc_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">OFCLASS</span><span class="main">(</span>Proc<span class="main">,</span> finite_class<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> Proc <span class="main">::</span> <span class="quoted">finite</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Proc_finite<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> card <span class="main">(</span>UNIV<span class="main">::</span>Proc set<span class="main">)</span>"</span></span>   <span class="comment1">― ‹number of processes›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The algorithm proceeds in \emph{phases} of $2$ rounds each (we call
  \emph{steps} the individual rounds that constitute a phase).
  The following utility functions compute the phase and step of a round,
  given the round number.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">nSteps</span> <span class="main">≡</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">phase</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">phase</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">div</span> nSteps"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">step</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">mod</span> nSteps"</span></span>

<span class="keyword1" id="UteDefs-phase_zero"><span class="command">lemma</span></span> phase_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> phase_def<span class="main">)</span>

<span class="keyword1" id="UteDefs-step_zero"><span class="command">lemma</span></span> step_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>

<span class="keyword1" id="UteDefs-phase_step"><span class="command">lemma</span></span> phase_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>phase <span class="free">r</span> <span class="main">*</span> nSteps<span class="main">)</span> <span class="main">+</span> step <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> phase_def step_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following record models the local state of a process.›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'val</span> pstate <span class="main">=</span>
  x <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'val</span></span></span>                <span class="comment1">― ‹current value held by process›</span>
  vote <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>    <span class="comment1">― ‹value the process voted for, if any›</span>
  decide <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>  <span class="comment1">― ‹value the process has decided on, if any›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Possible messages sent during the execution of the algorithm.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'val</span> msg <span class="main">=</span>
   Val <span class="quoted"><span class="quoted">"<span class="tfree">'val</span>"</span></span>
 <span class="main">|</span> Vote <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field of the initial state is unconstrained, all other
  fields are initialized appropriately.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ute_initState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ute_initState</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span>
   <span class="main">(</span>vote <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>decide <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following locale introduces the parameters used for the \ute{}
  algorithm and their constraints~\cite{biely:tolerating}.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ute_parameters <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">T</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">E</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> majE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="free">E</span> <span class="main">≥</span> N <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="free">α</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> majT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="free">T</span> <span class="main">≥</span> N <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="free">α</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> EltN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">&lt;</span> N"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> TltN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">&lt;</span> N"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simple consequences of the above parameter constraints.›</span></span>

<span class="keyword1" id="UteDefs-alpha_lt_N"><span class="command">lemma</span></span> alpha_lt_N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&lt;</span> N"</span></span>
<span class="keyword1"><span class="command">using</span></span> EltN majE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="UteDefs-alpha_lt_T"><span class="command">lemma</span></span> alpha_lt_T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&lt;</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> majT alpha_lt_N <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="UteDefs-alpha_lt_E"><span class="command">lemma</span></span> alpha_lt_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&lt;</span> <span class="free">E</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> majE alpha_lt_N <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We separately define the transition predicates and the send functions
  for each step and later combine them to define the overall next-state relation.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In step 0, each process sends its current <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>.
  If it receives the value $v$ more than $T$ times, it votes for $v$,
  otherwise it doesn't vote.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">send0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Proc <span class="main">⇒</span> Proc <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> <span class="tfree">'val</span> msg"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> Val <span class="main">(</span>x <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">next0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Proc <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> <span class="main">(</span>Proc <span class="main">⇒</span> <span class="tfree">'val</span> msg option<span class="main">)</span> 
                <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">v</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> vote <span class="main">:=</span> Some <span class="bound">v</span> <span class="main">⦈</span><span class="main">)</span>
   <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">v</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> vote <span class="main">:=</span> None <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In step 1, each process sends its current <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vote›</span></span></span></span>.

  If it receives more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>α›</span></span></span></span> votes for a given value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>,
  it sets its <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>, else it sets <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> to a
  default value.

  If the process receives more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E›</span></span></span></span> votes for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>, it decides
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>, otherwise it leaves its decision unchanged.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">send1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Proc <span class="main">⇒</span> Proc <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> <span class="tfree">'val</span> msg"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> Vote <span class="main">(</span>vote <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">next1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Proc <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> <span class="main">(</span>Proc <span class="main">⇒</span> <span class="tfree">'val</span> msg option<span class="main">)</span> 
                <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
    <span class="main">(</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">α</span> <span class="main">∧</span> x <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span>
     <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">α</span><span class="main">)</span> 
         <span class="main">∧</span> x <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> undefined  <span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span>
     <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span><span class="main">)</span> 
         <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> decide <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">)</span>
  <span class="main">∧</span> vote <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The overall send function and next-state relation are simply obtained as
  the composition of the individual relations defined above.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">Ute_sendMsg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Proc <span class="main">⇒</span> Proc <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> <span class="tfree">'val</span> msg"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ute_sendMsg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span> <span class="keyword1">if</span> step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> send0 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> send1 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">Ute_nextState</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Proc <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> <span class="main">(</span>Proc <span class="main">⇒</span> <span class="tfree">'val</span> msg option<span class="main">)</span>
                        <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ute_nextState</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> next0 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> next1 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Communication Predicate for \ute{}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Following~\cite{biely:tolerating}, we now define the communication predicate
  for the \ute{} algorithm to be correct.

  The round-by-round predicate stipulates the following conditions:
  \begin{itemize}
  \item no process may receive more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>α›</span></span></span></span> corrupted messages, and
  \item every process should receive more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>max(T, N + 2*α - E - 1)›</span></span></span></span> 
    correct messages.
  \end{itemize}
  \cite{biely:tolerating} also requires that every process should receive more
  than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>α›</span></span></span></span> correct messages, but this is implied, since <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T &gt; α›</span></span></span></span>
  (cf. lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>alpha_lt_T›</span></span></span></span>).
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ute_commPerRd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ute_commPerRd</span> <span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOrs</span></span></span> <span class="main">≡</span>
   <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="bound">p</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">SHOrs</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span>
     <span class="main">∧</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHOrs</span></span></span> <span class="bound">p</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="free">α</span> <span class="main">-</span> <span class="free">E</span> <span class="main">-</span> <span class="main">1</span>
     <span class="main">∧</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHOrs</span></span></span> <span class="bound">p</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The global communication predicate requires there exists some phase
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Φ›</span></span></span></span> such that:
  \begin{itemize}
  \item all HO and SHO sets of all processes are equal in the second step
    of phase <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Φ›</span></span></span></span>, i.e.\ all processes receive messages from the 
    same set of processes, and none of these messages is corrupted,
  \item every process receives more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> correct messages in
    the first step of phase <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Φ+1›</span></span></span></span>, and
  \item every process receives more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E›</span></span></span></span> correct messages in the
    second step of phase <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Φ+1›</span></span></span></span>.
  \end{itemize}
  The predicate in the article~\cite{biely:tolerating} requires infinitely
  many such phases, but one is clearly enough.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ute_commGlobal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ute_commGlobal</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="main">≡</span>
    <span class="main">∃</span><span class="bound">Φ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">r</span> <span class="main">=</span> Suc <span class="main">(</span>nSteps<span class="main">*</span><span class="bound">Φ</span><span class="main">)</span>
         <span class="keyword1">in</span>  <span class="main">(</span><span class="main">∃</span><span class="bound">π</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">π</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">π</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span>
           <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">T</span><span class="main">)</span>
           <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">E</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The \ute{} Heard-Of Machine›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the coordinated HO machine for the \ute{} algorithm
  by assembling the algorithm definition and its communication-predicate.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ute_SHOMachine</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ute_SHOMachine</span> <span class="main">=</span> <span class="main">⦇</span>
     CinitState <span class="main">=</span>  <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">crd</span><span class="main">.</span> Ute_initState <span class="bound">p</span> <span class="bound">st</span><span class="main">)</span><span class="main">,</span>
     sendMsg <span class="main">=</span>  Ute_sendMsg<span class="main">,</span>
     CnextState <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span> <span class="bound">st'</span><span class="main">.</span> Ute_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">st'</span><span class="main">)</span><span class="main">,</span>
     SHOcommPerRd <span class="main">=</span> Ute_commPerRd<span class="main">,</span>
     SHOcommGlobal <span class="main">=</span> Ute_commGlobal 
   <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ute_M</span> <span class="main">≡</span> <span class="main">(</span>Ute_SHOMachine<span class="main">::</span><span class="main">(</span>Proc<span class="main">,</span> <span class="tfree">'val</span> pstate<span class="main">,</span> <span class="tfree">'val</span> msg<span class="main">)</span> SHOMachine<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>   <span class="comment1">― ‹locale <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"ute_parameters"</span><span class="antiquote">}</span></span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>   <span class="comment1">(* theory UteDefs *)</span>
</pre>
</div><div id="UteProof">
<div class="head">
<h1>Theory UteProof</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> UteProof
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#UteDefs">UteDefs</a> <span class="quoted">"<a href="#Majorities">../Majorities</a>"</span> <span class="quoted">"<a href="#Reduction">../Reduction</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> ute_parameters
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminary Lemmas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Processes can make a vote only at first round of each phase.›</span></span>

<span class="keyword1" id="UteProof-vote_step"><span class="command">lemma</span></span> vote_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="free">μ</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>Ute_SHOMachine_def nextState_def Ute_nextState_def next1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Processes can make a new decision only at second round of each phase.›</span></span>

<span class="keyword1" id="UteProof-decide_step"><span class="command">lemma</span></span> decide_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ute_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> sr<span class="main">:</span><span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Ute_nextState <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">μ</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Ute_SHOMachine_def nextState_def SHORun_eq SHOnextConfig_eq 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> sr <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next0 <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">μ</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Ute_nextState_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>next0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> d1 d2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="UteProof-unique_majority_E"><span class="command">lemma</span></span> unique_majority_E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> majv<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> majw<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">m'</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">m'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> majv majw majE 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">}</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">m'</span><span class="main">}</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qq</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qq</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qq</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">m'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> majoritiesE'<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="UteProof-unique_majority_E_α"><span class="command">lemma</span></span> unique_majority_E_α<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> majv<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> <span class="free">m</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> majw<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> <span class="free">m'</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">m'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> majE alpha_lt_N majv majw
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> <span class="free">m</span><span class="main">}</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> <span class="free">m'</span><span class="main">}</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qq</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qq</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> <span class="free">m</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qq</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> <span class="free">m'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> majoritiesE'<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="UteProof-unique_majority_T"><span class="command">lemma</span></span> unique_majority_T<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> majv<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> majw<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">m'</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">m'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> majT majv majw
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">}</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">m'</span><span class="main">}</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qq</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qq</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qq</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">qq</span><span class="main">::</span>Proc<span class="main">.</span> <span class="free">F</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">m'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> majoritiesE'<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹No two processes may vote for different values in the same round.›</span></span>

<span class="keyword1" id="UteProof-common_vote"><span class="command">lemma</span></span> common_vote<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> usafe<span class="main">:</span> <span class="quoted"><span class="quoted">"SHOcommPerRd Ute_M <span class="free">HO</span> <span class="free">SHO</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nxtp<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>  <span class="free">μp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μp</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HO</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHO</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nxtq<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span>  <span class="free">μq</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> muq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μq</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HO</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">SHO</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">vp</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> vq<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">vq</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">vp</span> <span class="main">=</span> <span class="free">vq</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> gtn<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ute_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> Val <span class="free">vp</span><span class="main">}</span>
           <span class="main">+</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ute_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> Val <span class="free">vq</span><span class="main">}</span> <span class="main">&gt;</span> N"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ute_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> Val <span class="free">vp</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span> <span class="main">-</span> <span class="free">α</span>
        <span class="main">∧</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ute_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> Val <span class="free">vq</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?vsentp</span> <span class="main">&gt;</span> <span class="main">_</span> <span class="main">∧</span> card <span class="var">?vsentq</span> <span class="main">&gt;</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> nxtp vp <span class="keyword1"><span class="command">have</span></span> stp<span class="main">:</span><span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vote_step<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> mup
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="free">vp</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">(</span><span class="free">HO</span> <span class="free">p</span> <span class="main">-</span> <span class="free">SHO</span> <span class="free">p</span><span class="main">)</span> 
             <span class="main">⊆</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ute_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> Val <span class="free">vp</span><span class="main">}</span>"</span></span>
             <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?vrcvdp</span> <span class="main">-</span> <span class="var">?ahop</span> <span class="main">⊆</span> <span class="var">?vsentp</span>"</span></span><span class="main">)</span> 
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHOmsgVectors_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?vrcvdp</span> <span class="main">-</span> <span class="var">?ahop</span><span class="main">)</span> <span class="main">≤</span> card <span class="var">?vsentp</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?vrcvdp</span> <span class="main">-</span> <span class="var">?ahop</span><span class="main">)</span> <span class="main">≥</span> card <span class="var">?vrcvdp</span> <span class="main">-</span> card <span class="var">?ahop</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono diff_card_le_card_Diff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?vsentp</span> <span class="main">≥</span> card <span class="var">?vrcvdp</span> <span class="main">-</span> card <span class="var">?ahop</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> nxtp stp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next0 <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="free">μp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def nextState_def Ute_nextState_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> vp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?vrcvdp</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> next0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> muq
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="free">vq</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">(</span><span class="free">HO</span> <span class="free">q</span> <span class="main">-</span> <span class="free">SHO</span> <span class="free">q</span><span class="main">)</span>
             <span class="main">⊆</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ute_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> Val <span class="free">vq</span><span class="main">}</span>"</span></span>
             <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?vrcvdq</span> <span class="main">-</span> <span class="var">?ahoq</span> <span class="main">⊆</span> <span class="var">?vsentq</span>"</span></span><span class="main">)</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHOmsgVectors_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?vrcvdq</span> <span class="main">-</span> <span class="var">?ahoq</span><span class="main">)</span> <span class="main">≤</span> card <span class="var">?vsentq</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?vrcvdq</span> <span class="main">-</span> <span class="var">?ahoq</span><span class="main">)</span> <span class="main">≥</span> card <span class="var">?vrcvdq</span> <span class="main">-</span> card <span class="var">?ahoq</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono diff_card_le_card_Diff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?vsentq</span> <span class="main">≥</span> card <span class="var">?vrcvdq</span> <span class="main">-</span> card <span class="var">?ahoq</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> nxtq stp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next0 <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="free">μq</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def nextState_def Ute_nextState_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> vq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="free">vq</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> next0_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> usafe <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?ahop</span> <span class="main">≤</span> <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?ahoq</span> <span class="main">≤</span> <span class="free">α</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def Ute_commPerRd_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> alpha_lt_T <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> majT <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> vpq<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">vp</span> <span class="main">≠</span> <span class="free">vq</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ute_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span>
               <span class="main">=</span> sendMsg Ute_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def Ute_sendMsg_def 
                     step_def send0_def send1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> vpq 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ute_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> Val <span class="free">vp</span><span class="main">}</span> 
           <span class="main">∩</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ute_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> Val <span class="free">vq</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> gtn
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ute_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> Val <span class="free">vp</span><span class="main">}</span> 
                  <span class="main">∪</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ute_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> Val <span class="free">vq</span><span class="main">}</span><span class="main">)</span> <span class="main">&gt;</span> N"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_Un_Int<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ute_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> Val <span class="free">vp</span><span class="main">}</span> 
                  <span class="main">∪</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ute_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> Val <span class="free">vq</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> N"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  No decision may be taken by a process unless it received enough messages
  holding the same value.
›</span></span>
<span class="comment1">(*
  The proof mainly relies on lemma @{text decide_step}
  and the @{text Ute_commPerRound} predicate. 
*)</span>

<span class="keyword1" id="UteProof-decide_with_threshold_E"><span class="command">lemma</span></span> decide_with_threshold_E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ute_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> usafe<span class="main">:</span> <span class="quoted"><span class="quoted">"SHOcommPerRd Ute_M <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="free">r</span> <span class="bound">q</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">}</span>
           <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μp</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> nxt<span class="main">:</span><span class="quoted"><span class="quoted">"nextState Ute_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">μp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">qq</span><span class="main">.</span> <span class="bound">qq</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span> <span class="main">⟷</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">≠</span> None"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">qq</span><span class="main">.</span> <span class="bound">qq</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="free">r</span> <span class="free">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span> 
                <span class="main">⟶</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>sendMsg Ute_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Ute_SHOMachine_def SHORun_eq SHOnextConfig_eq SHOmsgVectors_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>
          <span class="main">⊆</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ute_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
         <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?vrcvdp</span> <span class="main">-</span> <span class="var">?ahop</span> <span class="main">⊆</span> <span class="var">?vsentp</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?vrcvdp</span> <span class="main">-</span> <span class="var">?ahop</span><span class="main">)</span> <span class="main">≤</span> card <span class="var">?vsentp</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?vrcvdp</span> <span class="main">-</span> <span class="var">?ahop</span><span class="main">)</span> <span class="main">≥</span> card <span class="var">?vrcvdp</span> <span class="main">-</span> card <span class="var">?ahop</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono diff_card_le_card_Diff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?vsentp</span> <span class="main">≥</span> card <span class="var">?vrcvdp</span> <span class="main">-</span> card <span class="var">?ahop</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> usafe <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def Ute_commPerRd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> run d1 d2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> decide_step<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> nxt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next1 <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">μp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def nextState_def Ute_nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> run d1 d2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> alpha_lt_E <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of Agreement and Validity›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E - α›</span></span></span></span> messages holding <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> are sent to
  some process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> at round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>, then every process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>pp›</span></span></span></span>
  correctly receives more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>α›</span></span></span></span> such messages.
›</span></span>
<span class="comment1">(*
  The proof mainly relies on the @{text Ute_commPerRound} predicate. 
*)</span>

<span class="keyword1" id="UteProof-common_x_argument_1"><span class="command">lemma</span></span> common_x_argument_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> usafe<span class="main">:</span><span class="quoted"><span class="quoted">"SHOcommPerRd Ute_M <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> threshold<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">q</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> 
                            <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
                 <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?msgs</span> <span class="free">p</span> <span class="free">v</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?msgs</span> <span class="free">pp</span> <span class="free">v</span> <span class="main">∩</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?msgs</span> <span class="free">pp</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="main">+</span> <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">q</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> 
                <span class="main">=</span> sendMsg Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">q</span> <span class="free">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def Ute_sendMsg_def 
                     step_def send0_def send1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> usafe
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="free">α</span> <span class="main">-</span> <span class="free">E</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def step_def Ute_commPerRd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> threshold <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?msgs</span> <span class="free">pp</span> <span class="free">v</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span>
        <span class="main">=</span> card <span class="main">(</span><span class="var">?msgs</span> <span class="free">pp</span> <span class="free">v</span> <span class="main">∪</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span><span class="main">)</span>
          <span class="main">+</span> card <span class="main">(</span><span class="var">?msgs</span> <span class="free">pp</span> <span class="free">v</span> <span class="main">∩</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_Un_Int<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?msgs</span> <span class="free">pp</span> <span class="free">v</span> <span class="main">∪</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> N"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E - α›</span></span></span></span> messages holding <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> are sent to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>
  at some round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>, then any process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>pp›</span></span></span></span> will set its <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> to
  value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>.
›</span></span>
<span class="comment1">(*
  The proof relies on previous lemmas @{text common_x_argument_1}
  and @{text common_vote} and the @{text Ute_commPerRound} predicate. 
*)</span>

<span class="keyword1" id="UteProof-common_x_argument_2"><span class="command">lemma</span></span> common_x_argument_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ute_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> usafe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> SHOcommPerRd Ute_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nxtpp<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span> 
                        <span class="free">μpp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mupp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μpp</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> 
                                 <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> threshold<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">q</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> 
                             <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
                 <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?sent</span> <span class="free">p</span> <span class="free">v</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> stp<span class="main">:</span><span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> sr<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">q</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> 
                 <span class="main">=</span> Val <span class="main">(</span>x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def Ute_sendMsg_def send0_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> threshold <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qq</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"sendMsg Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> va<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μpp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">α</span>"</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?msgs</span> <span class="free">v</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">α</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> mupp
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> 
          <span class="main">⊆</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μpp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>sendMsg Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">qq</span> <span class="free">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> SHOmsgVectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?msgs</span> <span class="free">v</span><span class="main">)</span> <span class="main">⊇</span> <span class="main">(</span><span class="var">?sent</span> <span class="free">pp</span> <span class="free">v</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?msgs</span> <span class="free">v</span><span class="main">)</span> 
             <span class="main">≥</span> card <span class="main">(</span><span class="main">(</span><span class="var">?sent</span> <span class="free">pp</span> <span class="free">v</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> usafe threshold 
    <span class="keyword1"><span class="command">have</span></span> alph<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span><span class="var">?sent</span> <span class="free">pp</span> <span class="free">v</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">α</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> common_x_argument_1<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> nxtpp stp
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next1 <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span>  <span class="free">μpp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def nextState_def Ute_nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> wa<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?msgs</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xw<span class="main">:</span><span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> usafe
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qv</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">μpp</span> <span class="skolem">qv</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="var">?msgs</span> <span class="free">v</span> <span class="main">⊆</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?msgs</span> <span class="free">v</span> <span class="main">⊆</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?msgs</span> <span class="free">v</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> usafe
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def Ute_commPerRd_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">note</span></span> va
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qv</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qv</span> <span class="main">∉</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> qsv<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">μpp</span> <span class="skolem">qv</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> mupp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qv</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> SHOmsgVectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> qsv that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> stp mupp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">qv</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHOmsgVectors_def 
                     Ute_sendMsg_def send1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qw</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">qw</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">μpp</span> <span class="skolem">qw</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="var">?msgs</span> <span class="skolem">w</span> <span class="main">⊆</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?msgs</span> <span class="skolem">w</span> <span class="main">⊆</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?msgs</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> usafe
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def Ute_commPerRd_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">note</span></span> wa
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qw</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qw</span> <span class="main">∉</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> qsw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μpp</span> <span class="skolem">qw</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> mupp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qw</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">pp</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> SHOmsgVectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> qsw that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> stp mupp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">qw</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHOmsgVectors_def
                     Ute_sendMsg_def send1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μqv</span></span> <span class="skolem"><span class="skolem">μqw</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="free">r</span> <span class="skolem">qv</span> <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span> <span class="skolem">qv</span><span class="main">)</span>  <span class="skolem">μqv</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">qv</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μqv</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="free">r</span> <span class="skolem">qv</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="skolem">qv</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="free">r</span> <span class="skolem">qv</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="free">r</span> <span class="skolem">qw</span> <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span> <span class="skolem">qw</span><span class="main">)</span>  <span class="skolem">μqw</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">qw</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μqw</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="free">r</span> <span class="skolem">qw</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="skolem">qw</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="free">r</span> <span class="skolem">qw</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHORun_eq SHOnextConfig_eq<span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> usafe <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> common_vote<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> xw <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">pp</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Inductive argument for the agreement and validity theorems.
›</span></span>
<span class="comment1">(*
  The proof relies on previous lemmas @{text common_x_argument_2}
  and @{text unique_majority_T} and the @{text Ute_commPerRound} predicate.
*)</span>

<span class="keyword1" id="UteProof-safety_inductive_argument"><span class="command">lemma</span></span> safety_inductive_argument<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ute_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> SHOcommPerRd Ute_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="free">r'</span> <span class="bound">q</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r'</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> stp1<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">r'</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span>
         card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span>
                     <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> stp1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> stp1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> rr'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">=</span> Suc <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> stpr<span class="main">:</span><span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> gr0_implies_Suc<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">pp</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">pp</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pp</span>
    <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μpp</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μpp</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="free">r'</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r'</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r'</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="free">r'</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="free">r'</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r'</span> <span class="skolem">pp</span><span class="main">)</span>  <span class="skolem">μpp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHORun_eq SHOnextConfig_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> run comm ih rr' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> common_x_argument_2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> run stpr
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">pp</span> <span class="bound">p</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">pp</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">pp</span><span class="main">)</span> <span class="main">=</span> Val <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHORun_eq SHOnextConfig_eq
                   Ute_sendMsg_def send0_def mod_Suc step_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> rr'
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">μp'</span><span class="main">.</span> <span class="bound">μp'</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span><span class="main">)</span> 
                                     <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
             <span class="main">⟹</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="bound">p</span>
                   <span class="main">⊆</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="bound">μp'</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHOmsgVectors_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">μp'</span><span class="main">.</span> <span class="bound">μp'</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span><span class="main">)</span> 
                                       <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
             <span class="main">⟹</span> card <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
                   <span class="main">≤</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="bound">μp'</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> comm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="free">T</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def Ute_commPerRd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword1"><span class="command">have</span></span> vT<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">μp'</span><span class="main">.</span> <span class="bound">μp'</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span><span class="main">)</span> 
                                         <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
                <span class="main">⟹</span> <span class="free">T</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="bound">μp'</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_le_trans<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">pp</span><span class="main">.</span> vote <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">pp</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pp</span>
      <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μpp</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> nxtpp<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="skolem">μpp</span> 
                                      <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> mupp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μpp</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span><span class="main">)</span>
                                     <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHORun_eq SHOnextConfig_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> vT <span class="keyword1"><span class="command">have</span></span> vT'<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">μpp</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="free">v</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> stpr rr' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mod_Suc step_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> nxtpp
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next0 <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="skolem">μpp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def nextState_def Ute_nextState_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> wT<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">μpp</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="skolem">w</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> votew<span class="main">:</span><span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next0_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> vT' wT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> unique_majority_T<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> votew <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> run stpr rr'
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> N <span class="main">=</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span> <span class="bound">p</span> 
                                  <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHORun_eq SHOnextConfig_eq 
                     Ute_sendMsg_def send1_def step_def mod_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> rr' majE EltN <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A process that holds some decision <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> has decided <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>
  sometime in the past.
›</span></span>

<span class="keyword1" id="UteProof-decisionNonNullThenDecided"><span class="command">lemma</span></span> decisionNonNullThenDecided<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span><span class="quoted"><span class="quoted">"SHORun Ute_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="bound">m</span> <span class="free">p</span><span class="main">)</span> 
             <span class="main">∧</span> decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="free">k</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="free">k</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="var">?dec</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?dec</span> <span class="bound">m</span> <span class="main">⟶</span> <span class="var">?dec</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v</span><span class="main">)</span>
        <span class="main">⟶</span> <span class="var">?dec</span> <span class="free">n</span> <span class="main">≠</span> Some <span class="free">v</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="free">n</span> <span class="main">⟶</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHORun_eq HOinitConfig_eq
                     initState_def Ute_initState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">n</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> dec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p1›</span></span></span></span> has decided value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v1›</span></span></span></span> and process
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p2›</span></span></span></span> later decides, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p2›</span></span></span></span> must decide <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v1›</span></span></span></span>.
›</span></span>
<span class="comment1">(*
  The proof relies on previous lemmas @{text decide_step},
  @{text decide_with_threshold_E}, @{text unique_majority_E_α},
  @{text decisionNonNullThenDecided} and @{text safety_inductive_argument}.
*)</span>

<span class="keyword1" id="UteProof-laterProcessDecidesSameValue"><span class="command">lemma</span></span> laterProcessDecidesSameValue<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span><span class="quoted"><span class="quoted">"SHORun Ute_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> comm<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> SHOcommPerRd Ute_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dv1<span class="main">:</span><span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p1</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dn2<span class="main">:</span><span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="free">p2</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dv2<span class="main">:</span><span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">p2</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v2</span> <span class="main">=</span> <span class="free">v1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run dv1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r1</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> r1r<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">&lt;</span> Suc <span class="free">r</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dn1<span class="main">:</span><span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="skolem">r1</span> <span class="free">p1</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dv1'<span class="main">:</span><span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r1</span><span class="main">)</span> <span class="free">p1</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decisionNonNullThenDecided<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> r1r <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> rr1<span class="main">:</span><span class="quoted"><span class="quoted">"Suc <span class="free">r</span> <span class="main">=</span> Suc <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_imp_Suc_add<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> kk'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">+</span> <span class="free">k</span> <span class="main">=</span> <span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> dn2 dv2 
  <span class="keyword1"><span class="command">have</span></span> dn2'<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">)</span> <span class="free">p2</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dv2'<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">)</span><span class="main">)</span> <span class="free">p2</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> run dn1 dv1' dn2' dv2' 
  <span class="keyword1"><span class="command">have</span></span> rs0<span class="main">:</span><span class="quoted"><span class="quoted">"step <span class="skolem">r1</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  rks0<span class="main">:</span><span class="quoted"><span class="quoted">"step <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mod_Suc step_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decide_step<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">)</span> <span class="main">=</span> step <span class="main">(</span>step <span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> step_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_add_left_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> rs0 rks0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="skolem">k'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">=</span> <span class="skolem">k''</span><span class="main">*</span>nSteps"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> dn2' dv2' 
  <span class="keyword1"><span class="command">have</span></span> dn2''<span class="main">:</span><span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="free">p2</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dv2''<span class="main">:</span><span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">*</span>nSteps<span class="main">)</span><span class="main">)</span> <span class="free">p2</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> rs0 <span class="keyword1"><span class="command">have</span></span> stp<span class="main">:</span><span class="quoted"><span class="quoted">"step <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> step_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="bound">q</span> <span class="free">p1</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="bound">q</span><span class="main">)</span>
                         <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v1</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k''</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> stp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="main">0</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> run comm dn1 dv1'
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="main">0</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="bound">q</span> <span class="free">p1</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="main">0</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="bound">q</span><span class="main">)</span>
                      <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v1</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> decide_with_threshold_E<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k''</span>
    <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span>
          card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="bound">q</span> <span class="free">p1</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="bound">q</span><span class="main">)</span>
                       <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v1</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> rs0 <span class="keyword1"><span class="command">have</span></span> stps<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> run comm ih
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span>  <span class="main">&lt;</span>
       card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">*</span>nSteps<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span> <span class="free">p1</span> 
                              <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">*</span>nSteps<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> 
                   <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v1</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> safety_inductive_argument<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span>
       card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> Suc <span class="skolem">k''</span> <span class="main">*</span> nSteps<span class="main">)</span> <span class="bound">q</span> <span class="free">p1</span>
                              <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> Suc <span class="skolem">k''</span> <span class="main">*</span> nSteps<span class="main">)</span> <span class="bound">q</span><span class="main">)</span>
                     <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v1</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> run
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="bound">q</span> <span class="free">p1</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="bound">q</span><span class="main">)</span>
          <span class="main">=</span> sendMsg Ute_M <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="bound">q</span> <span class="free">p2</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def Ute_sendMsg_def 
                   step_def send0_def send1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> run comm dn2'' dv2''
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span>
      card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="bound">q</span> <span class="free">p2</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">r1</span> <span class="main">+</span> <span class="skolem">k''</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="bound">q</span><span class="main">)</span>
                  <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v2</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decide_with_threshold_E<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v2</span> <span class="main">=</span> <span class="free">v1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> unique_majority_E_α<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The Agreement property is an immediate consequence of the two
  preceding lemmas.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ute_agreement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ute_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> SHOcommPerRd Ute_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">m</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run p <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> k1<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="skolem">k</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> k2<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decisionNonNullThenDecided<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> run q <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> l1<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">rho</span> <span class="skolem">l</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> l2<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decisionNonNullThenDecided<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">l</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">+</span><span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_iff_add<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> run comm k2 l1 l2 m <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> laterProcessDecidesSameValue<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">l</span><span class="main">+</span><span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_iff_add<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> run comm l2 k1 k2 m <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> laterProcessDecidesSameValue<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Main lemma for the proof of the Validity property.
›</span></span>
<span class="comment1">(*
  The proof relies on previous lemmas @{text safety_inductive_argument},
  @{text unique_majority_T} and the @{text Ute_commPerRound} predicate.
*)</span>

<span class="keyword1" id="UteProof-validity_argument"><span class="command">lemma</span></span> validity_argument<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ute_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> SHOcommPerRd Ute_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> x <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dw<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">r'</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="free">r'</span> <span class="bound">q</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r'</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">r'</span> <span class="keyword1">div</span> nSteps"</span></span>
  <span class="keyword1"><span class="command">with</span></span> stp <span class="keyword1"><span class="command">have</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">*</span> nSteps"</span></span>
    <span class="keyword1"><span class="command">using</span></span> div_mult_mod_eq <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r'</span></span> <span class="quoted">nSteps</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span>
        card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span>Suc <span class="main">0</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">*</span>nSteps<span class="main">)</span> <span class="bound">q</span> <span class="free">p</span> <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">0</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">*</span>nSteps<span class="main">)</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span>
                   <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">pp</span><span class="main">.</span> vote <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="bound">pp</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pp</span>
      <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μpp</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> nxtpp<span class="main">:</span><span class="quoted"><span class="quoted">"nextState Ute_M <span class="main">0</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="skolem">pp</span><span class="main">)</span> <span class="skolem">μpp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> mupp<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">μpp</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">0</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="main">0</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">0</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHORun_eq SHOnextConfig_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> majv<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">μpp</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="free">v</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> run init <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">0</span> <span class="bound">q</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Val <span class="free">v</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHORun_eq SHOnextConfig_eq 
                         Ute_sendMsg_def send0_def step_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> comm <span class="keyword1"><span class="command">have</span></span> shoT<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">SHOs</span> <span class="main">0</span> <span class="skolem">pp</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">0</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def Ute_commPerRd_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> mupp
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">SHOs</span> <span class="main">0</span> <span class="skolem">pp</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">0</span> <span class="skolem">pp</span> 
               <span class="main">⊆</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">μpp</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>sendMsg Ute_M <span class="main">0</span> <span class="bound">q</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHOmsgVectors_def<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">SHOs</span> <span class="main">0</span> <span class="skolem">pp</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">0</span> <span class="skolem">pp</span><span class="main">)</span>
                 <span class="main">≤</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">μpp</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>sendMsg Ute_M <span class="main">0</span> <span class="bound">q</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_le_trans<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> nxtpp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next0 <span class="main">0</span> <span class="skolem">pp</span> <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="skolem">μpp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def nextState_def Ute_nextState_def step_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> majw<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">μpp</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="skolem">w</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>
                 <span class="keyword2"><span class="keyword">and</span></span> votew<span class="main">:</span><span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next0_def<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> majv majw <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> unique_majority_T<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> votew <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> run
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="bound">q</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> N"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHORun_eq SHOnextConfig_eq
                     Ute_nextState_def step_def Ute_sendMsg_def send1_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span>
      card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span>Suc <span class="main">0</span> <span class="main">+</span> <span class="main">0</span> <span class="main">*</span> nSteps<span class="main">)</span> <span class="bound">q</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">0</span> <span class="main">+</span> <span class="main">0</span> <span class="main">*</span> nSteps<span class="main">)</span> <span class="bound">q</span><span class="main">)</span>
                   <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> majE EltN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span>
        card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span>Suc <span class="main">0</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">*</span> nSteps<span class="main">)</span> <span class="bound">q</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">0</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">*</span> nSteps<span class="main">)</span> <span class="bound">q</span><span class="main">)</span>
                     <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="main">0</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">*</span> nSteps<span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mod_Suc step_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> run comm ih this
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span>
      card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">*</span> nSteps<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span> <span class="free">p</span>
                             <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">*</span> nSteps<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span>
                  <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> safety_inductive_argument<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span>
       card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="main">(</span>Suc <span class="main">0</span> <span class="main">+</span> Suc <span class="skolem">k</span> <span class="main">*</span> nSteps<span class="main">)</span> <span class="bound">q</span> <span class="free">p</span> 
                              <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">0</span> <span class="main">+</span> Suc <span class="skolem">k</span> <span class="main">*</span> nSteps<span class="main">)</span> <span class="bound">q</span><span class="main">)</span>
                 <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following theorem shows the Validity property of algorithm \ute{}.
›</span></span>
<span class="comment1">(*
 The proof relies on previous lemmas @{text decisionNonNullThenDecided},
 @{text decide_step}, @{text decide_with_threshold_E},  @{text unique_majority_E_α},
 and the @{text Validity_argument}. 
*)</span>

<span class="keyword1"><span class="command">theorem</span></span> ute_validity<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ute_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> SHOcommPerRd Ute_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dw<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run dw <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r1</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> dnr1<span class="main">:</span><span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="skolem">r1</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dwr1<span class="main">:</span><span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decisionNonNullThenDecided<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="skolem">r1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> decide_step<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"step <span class="skolem">r1</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span>
        card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="skolem">r1</span> <span class="bound">q</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r1</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> validity_argument<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> run comm dnr1 dwr1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sendMsg Ute_M <span class="skolem">r1</span> <span class="bound">q</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r1</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Vote <span class="main">(</span>Some <span class="free">w</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decide_with_threshold_E<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> unique_majority_E_α<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of Termination›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  At the second round of a phase that satisfies the conditions expressed in
  the global communication predicate, processes update their <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> variable 
  with the value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> they receive in more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>α›</span></span></span></span> messages.
›</span></span>
<span class="comment1">(* The proof relies on @{text common_vote}. *)</span>

<span class="keyword1" id="UteProof-set_x_from_vote"><span class="command">lemma</span></span> set_x_from_vote<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ute_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"SHOcommPerRd Ute_M <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> π<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="free">μ</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span>
                                   <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μ</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> nxt stp vp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wp</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> xwp<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μ</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="skolem">wp</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> xp<span class="main">:</span><span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">wp</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def nextState_def Ute_nextState_def next1_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wp</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> xwp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pp</span></span> <span class="keyword2"><span class="keyword">where</span></span> smw<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="skolem">pp</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="skolem">wp</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">wp</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> smw mu π 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="skolem">pp</span> <span class="main">=</span> Some <span class="main">(</span>sendMsg Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">pp</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> SHOmsgVectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">with</span></span> stp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="skolem">pp</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def Ute_sendMsg_def send1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> smw <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> vp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qq</span></span> <span class="keyword2"><span class="keyword">where</span></span> smv<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="skolem">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> smv mu π
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="skolem">qq</span> <span class="main">=</span> Some <span class="main">(</span>sendMsg Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> SHOmsgVectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">with</span></span> stp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="skolem">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def Ute_sendMsg_def send1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> smv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μpp</span></span> <span class="skolem"><span class="skolem">μqq</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="free">r</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="skolem">pp</span><span class="main">)</span> <span class="skolem">μpp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μpp</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="free">r</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="free">r</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="free">r</span> <span class="skolem">qq</span> <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span>  <span class="skolem">μqq</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μqq</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="free">r</span> <span class="skolem">qq</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="free">r</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Ute_SHOMachine_def SHORun_eq SHOnextConfig_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> comm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> common_vote<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> xp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Assume that HO and SHO sets are uniform at the second step of some
  phase. Then at the subsequent round there exists some value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>
  such that any received message which is not corrupted holds <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>.
›</span></span>
<span class="comment1">(* The proof relies on lemma @{text set_x_from_vote}. *)</span>

<span class="keyword1" id="UteProof-termination_argument_1"><span class="command">lemma</span></span> termination_argument_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ute_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"SHOcommPerRd Ute_M <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> stp<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> π<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">π0</span> <span class="main">=</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∧</span> <span class="free">π0</span> <span class="main">=</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">μp'</span> <span class="bound">q</span><span class="main">.</span> 
       <span class="main">⟦</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">;</span> 
         <span class="bound">μp'</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                             <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
       <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">μp'</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">(</span>Val <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> π <span class="keyword1"><span class="command">have</span></span> hosho<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μp</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>  
                                  <span class="skolem">μp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μp</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> 
                                          <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHORun_eq SHOnextConfig_eq<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μq</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> nxtq<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>
                                   <span class="skolem">μq</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> muq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μq</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span>
                                          <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHORun_eq SHOnextConfig_eq<span class="main">)</span>
       
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> <span class="skolem">μq</span> <span class="bound">qq</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">qq</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μp</span> <span class="skolem">qq</span> <span class="main">=</span> <span class="skolem">μq</span> <span class="skolem">qq</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">μp</span> <span class="skolem">qq</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> mu π <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">qq</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">qq</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> SHOmsgVectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> mu π 1
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μp</span> <span class="skolem">qq</span> <span class="main">=</span> Some <span class="main">(</span>sendMsg Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">qq</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> SHOmsgVectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> muq π 2 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μq</span> <span class="skolem">qq</span> <span class="main">=</span> Some <span class="main">(</span>sendMsg Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">qq</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> SHOmsgVectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def Ute_sendMsg_def step_def 
                         send0_def send1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> mu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qq</span> <span class="main">∉</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> SHOmsgVectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> π muq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μq</span> <span class="skolem">qq</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> SHOmsgVectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> vsets<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> 
                    <span class="main">=</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="comment1">(* NB: due to the Global predicate (HO = SHO), we do not need α + 1 msgs
       holding a true vote, only 1. We might also prefer to invoke only the
       @{text Ute_commPerRound} predicate to obtain qq :
       since "card (HOs (Suc r) p - SHOs (Suc r) p) &lt; α", there should be one
       "correct" message holding a vote and this vote should be common according
       to previous (Suc r)esults. *)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> run comm stp π nxt mu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_x_from_vote<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> vsets vp
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> run comm stp π nxtq muq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_x_from_vote<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> nov<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> nxt stp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> undefined"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def nextState_def 
                       Ute_nextState_def next1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> vsets nov
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> nxtq stp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> undefined"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def nextState_def 
                       Ute_nextState_def next1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> stp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def mod_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">μp'</span> <span class="bound">q</span><span class="main">.</span> 
    <span class="main">⟦</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">;</span>
      <span class="bound">μp'</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                          <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">μp'</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="main">(</span>x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHOmsgVectors_def Ute_sendMsg_def send0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">μp'</span> <span class="bound">q</span><span class="main">.</span> 
    <span class="main">⟦</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span>  <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">;</span> 
      <span class="bound">μp'</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                                <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">μp'</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">(</span>Val <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If a process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> votes <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> at some round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>,
  then all messages received by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> that are not
  corrupted hold <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>.
›</span></span>
<span class="comment1">(* immediate from lemma @{text vote_step} and the algorithm definition. *)</span>

<span class="keyword1" id="UteProof-termination_argument_2"><span class="command">lemma</span></span> termination_argument_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μp</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> 
                                     <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nxtq<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span>  <span class="free">μq</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> vq<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> qsho<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">μp</span> <span class="free">q</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> nxtq vq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vote_step<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> mup qsho <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">μp</span> <span class="free">q</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHOmsgVectors_def Ute_sendMsg_def
                   step_def send1_def mod_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> vq <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">μp</span> <span class="free">q</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  We now prove the Termination property.
›</span></span>
<span class="comment1">(*
  The proof relies on previous lemmas @{text termination_argument_1},
  @{text termination_argument_2}, @{text common_vote}, @{text unique_majority_E},
  and the @{text Ute_commGlobal} predicate.
*)</span>

<span class="keyword1"><span class="command">theorem</span></span> ute_termination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ute_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> SHOcommPerRd Ute_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"SHOcommGlobal Ute_M <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span> <span class="bound">v</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> commG
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="skolem"><span class="skolem">r0</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r0</span> <span class="main">=</span> Suc <span class="main">(</span>nSteps <span class="main">*</span> <span class="skolem">Φ</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> π<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">π</span> <span class="main">=</span> <span class="free">HOs</span> <span class="skolem">r0</span> <span class="bound">p</span> <span class="main">∧</span> <span class="skolem">π</span> <span class="main">=</span> <span class="free">SHOs</span> <span class="skolem">r0</span> <span class="bound">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> card <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> card <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def Ute_commGlobal_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> rr <span class="keyword1"><span class="command">have</span></span> stp<span class="main">:</span><span class="quoted"><span class="quoted">"step <span class="skolem">r0</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> votew<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>    
    <span class="keyword1"><span class="command">have</span></span> abc<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span><span class="main">.</span> vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">from</span></span> run stp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μp</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> nxt<span class="main">:</span><span class="quoted"><span class="quoted">"nextState Ute_M <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">μp</span> 
                                   <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> mup<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">μp</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> 
                                      <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHORun_eq SHOnextConfig_eq<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">T</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">..</span></span> 
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> run commR stp π rr
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">μp'</span> <span class="bound">q</span><span class="main">.</span> 
              <span class="main">⟦</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="bound">p</span><span class="main">;</span>
                <span class="bound">μp'</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> 
                                          <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
              <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">μp'</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="skolem">v</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> termination_argument_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

        <span class="keyword1"><span class="command">with</span></span> mup <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">qq</span><span class="main">.</span> <span class="bound">qq</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">⟹</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="skolem">v</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">SHOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="skolem">v</span><span class="main">)</span><span class="main">}</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>
                 <span class="main">≤</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="skolem">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="skolem">v</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> stp nxt <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span><span class="main">.</span> vote <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def nextState_def Ute_nextState_def 
                       step_def mod_Suc next0_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qq</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> qqw<span class="main">:</span><span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">pp</span><span class="main">.</span> vote <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="bound">pp</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pp</span>
      <span class="keyword1"><span class="command">from</span></span> abc <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wp</span></span> <span class="keyword2"><span class="keyword">where</span></span> pwp<span class="main">:</span><span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">wp</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μpp</span></span> <span class="skolem"><span class="skolem">μqq</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> nxtp<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span>
                                     <span class="skolem">μpp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> mup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μpp</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span>
                                          <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> nxtq<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">qq</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span>
                                     <span class="skolem">μqq</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> muq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μqq</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">qq</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span>
                                          <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Ute_SHOMachine_def SHORun_eq SHOnextConfig_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> commR this pwp qqw <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wp</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> common_vote<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> pwp <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μp'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> nxtp<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ute_M <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>
                                 <span class="skolem">μp'</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mup'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μp'</span> <span class="main">∈</span> SHOmsgVectors Ute_M <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                                     <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHORun_eq SHOnextConfig_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">qq</span><span class="main">.</span> <span class="bound">qq</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> 
              <span class="main">⟹</span> <span class="skolem">μp'</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">qq</span>
    <span class="keyword3"><span class="command">assume</span></span> qqsho<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">qq</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μqq</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      nxtqq<span class="main">:</span><span class="quoted"><span class="quoted">"nextState Ute_M <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">qq</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span>
                             <span class="skolem">μqq</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def SHORun_eq SHOnextConfig_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> commR mup' nxtqq votew qqsho <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μp'</span> <span class="skolem">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> termination_argument_2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">SHOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>  <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>
           <span class="main">⊆</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp'</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="skolem">w</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> wsho<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>  <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>
                 <span class="main">≤</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp'</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="skolem">w</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
   
  <span class="keyword1"><span class="command">from</span></span> stp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> step_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> nxtp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next1 <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">μp'</span>
                        <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ute_SHOMachine_def nextState_def Ute_nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> e <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> wsho <span class="keyword1"><span class="command">have</span></span> majv<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp'</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="skolem">w</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next1_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹\ute{} Solves Weak Consensus›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Summing up, all (coarse-grained) runs of \ute{} for
  HO and SHO collections that satisfy the communication predicate 
  satisfy the Weak Consensus property.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ute_weak_consensus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ute_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> SHOcommPerRd Ute_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"SHOcommGlobal Ute_M <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weak_consensus <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> decide <span class="free">rho</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> weak_consensus_def
  <span class="keyword1"><span class="command">using</span></span> ute_validity<span class="main">[</span><span class="operator">OF</span> run commR<span class="main">]</span>
        ute_agreement<span class="main">[</span><span class="operator">OF</span> run commR<span class="main">]</span>
        ute_termination<span class="main">[</span><span class="operator">OF</span> run commR commG<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  By the reduction theorem, the correctness of the algorithm carries over
  to the fine-grained model of runs.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ute_weak_consensus_fg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run Ute_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">q</span><span class="main">.</span> undefined<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> SHOcommPerRd Ute_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"SHOcommGlobal Ute_M <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weak_consensus <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> x <span class="main">(</span>state <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> decide <span class="main">(</span>state <span class="main">∘</span> <span class="free">rho</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"weak_consensus <span class="var">?inits</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> local_property_reduction<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run weak_consensus_is_local<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">crun</span>
  <span class="keyword3"><span class="command">assume</span></span> crun<span class="main">:</span> <span class="quoted"><span class="quoted">"CSHORun Ute_M <span class="skolem">crun</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">q</span><span class="main">.</span> undefined<span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">crun</span> <span class="main">0</span> <span class="main">=</span> state <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> crun <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SHORun Ute_M <span class="skolem">crun</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> SHORun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this commR commG 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_consensus <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="skolem">crun</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> decide <span class="skolem">crun</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ute_weak_consensus<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> init <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"weak_consensus <span class="var">?inits</span> decide <span class="skolem">crun</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>    <span class="comment1">― ‹context <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"ute_parameters"</span><span class="antiquote">}</span></span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>    <span class="comment1">(* theory UteProof *)</span>
</pre>
</div><div id="AteDefs">
<div class="head">
<h1>Theory AteDefs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> AteDefs
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#HOModel">../HOModel</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Verification of the \ate{} Consensus algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Algorithm \ate{} is presented in~\cite{biely:tolerating}. Like \ute{},
  it is an uncoordinated algorithm that tolerates value faults, and it
  is parameterized by values $T$, $E$, and $\alpha$ that serve a similar
  function as in \ute{}, allowing the algorithm to be adapted to the
  characteristics of different systems. \ate{} can be understood as a
  variant of \emph{OneThirdRule} tolerating Byzantine faults.

  We formalize in Isabelle the correctness proof of the algorithm that
  appears in~\cite{biely:tolerating}, using the framework of theory
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>HOModel›</span></span></span></span>.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model of the Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We begin by introducing an anonymous type of processes of finite
  cardinality that will instantiate the type variable <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'proc›</span></span></span></span>
  of the generic HO model.
›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> Proc <span class="comment1">― ‹the set of processes›</span>
<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span> Proc_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">OFCLASS</span><span class="main">(</span>Proc<span class="main">,</span> finite_class<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> Proc <span class="main">::</span> <span class="quoted">finite</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Proc_finite<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> card <span class="main">(</span>UNIV<span class="main">::</span>Proc set<span class="main">)</span>"</span></span>   <span class="comment1">― ‹number of processes›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following record models the local state of a process.›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'val</span> pstate <span class="main">=</span>
  x <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span>"</span></span>              <span class="comment1">― ‹current value held by process›</span>
  decide <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>  <span class="comment1">― ‹value the process has decided on, if any›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field of the initial state is unconstrained, but no
  decision has yet been taken.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ate_initState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_initState</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> <span class="main">(</span>decide <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following locale introduces the parameters used for the \ate{}
  algorithm and their constraints~\cite{biely:tolerating}.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ate_parameters <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">T</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">E</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> TNaE<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span>N <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="free">α</span> <span class="main">-</span> <span class="free">E</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> TltN<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">&lt;</span> N"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> EltN<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">&lt;</span> N"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following are consequences of the assumptions on the parameters.›</span></span>

<span class="keyword1" id="AteDefs-majE"><span class="command">lemma</span></span> majE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">E</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">≥</span> N"</span></span>
<span class="keyword1"><span class="command">using</span></span> TNaE TltN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="AteDefs-Egta"><span class="command">lemma</span></span> Egta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">&gt;</span> <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> majE EltN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="AteDefs-Tge2a"><span class="command">lemma</span></span> Tge2a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> TNaE EltN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  At every round, each process sends its current <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>.
  If it received more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> messages, it selects the smallest value
  and store it in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>. As in algorithm \emph{OneThirdRule}, we
  therefore require values to be linearly ordered.

  If more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E›</span></span></span></span> messages holding the same value are received,
  the process decides that value.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mostOftenRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mostOftenRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">::</span>Proc <span class="main">⇒</span> <span class="tfree">'val</span> option<span class="main">)</span> <span class="main">≡</span>
   <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∀</span><span class="bound">w</span><span class="main">.</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="bound">w</span><span class="main">}</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">Ate_sendMsg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Proc <span class="main">⇒</span> Proc <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> <span class="tfree">'val</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_sendMsg</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> x <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">Ate_nextState</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Proc <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'val</span><span class="main">::</span>linorder<span class="main">)</span> pstate <span class="main">⇒</span> <span class="main">(</span>Proc <span class="main">⇒</span> <span class="tfree">'val</span> option<span class="main">)</span>
                        <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_nextState</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="keyword1">if</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span>
      <span class="keyword1">then</span> x <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> Min <span class="main">(</span>mostOftenRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> x <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> x <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span>   <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span>  <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span>
       <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span><span class="main">)</span> 
         <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> decide <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Communication Predicate for \ate{}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Following~\cite{biely:tolerating}, we now define the communication
  predicate for the \ate{} algorithm. The round-by-round predicate
  requires that no process may receive more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>α›</span></span></span></span> corrupted
  messages at any round.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ate_commPerRd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_commPerRd</span> <span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOrs</span></span></span> <span class="main">≡</span>
   <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="bound">p</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">SHOrs</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The global communication predicate stipulates the three following
  conditions:
  \begin{itemize}
  \item for every process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> there are infinitely many rounds 
    where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> receives more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> messages,
  \item for every process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> there are infinitely many rounds 
    where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> receives more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E›</span></span></span></span> uncorrupted messages,
  \item and there are infinitely many rounds in which more than
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E - α›</span></span></span></span> processes receive uncorrupted messages from the
    same set of processes, which contains more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> processes.
  \end{itemize}
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">Ate_commGlobal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_commGlobal</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">r'</span></span> <span class="main">&gt;</span> <span class="bound">r</span><span class="main">.</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">T</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="bound">p</span><span class="main">.</span>  <span class="main">∃</span><span class="bound"><span class="bound">r'</span></span> <span class="main">&gt;</span> <span class="bound">r</span><span class="main">.</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="bound">r'</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">E</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">r'</span></span> <span class="main">&gt;</span> <span class="bound">r</span><span class="main">.</span> <span class="main">∃</span><span class="bound">π1</span> <span class="bound">π2</span><span class="main">.</span>
        card <span class="bound">π1</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>
      <span class="main">∧</span> card <span class="bound">π2</span> <span class="main">&gt;</span> <span class="free">T</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="bound">π1</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r'</span> <span class="bound">p</span> <span class="main">=</span> <span class="bound">π2</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="bound">r'</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r'</span> <span class="bound">p</span> <span class="main">=</span> <span class="bound">π2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The \ate{} Heard-Of Machine›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the non-coordinated SHO machine for the \ate{} algorithm
  by assembling the algorithm definition and its communication-predicate.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ate_SHOMachine</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_SHOMachine</span> <span class="main">=</span> <span class="main">⦇</span> 
    CinitState <span class="main">=</span>  <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">crd</span><span class="main">.</span> Ate_initState <span class="bound">p</span> <span class="main">(</span><span class="bound">st</span><span class="main">::</span><span class="main">(</span><span class="tfree">'val</span><span class="main">::</span>linorder<span class="main">)</span> pstate<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    sendMsg <span class="main">=</span>  Ate_sendMsg<span class="main">,</span>
    CnextState <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span> <span class="bound">st'</span><span class="main">.</span> Ate_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">st'</span><span class="main">)</span><span class="main">,</span>
    SHOcommPerRd <span class="main">=</span> <span class="main">(</span>Ate_commPerRd<span class="main">::</span> Proc HO <span class="main">⇒</span> Proc HO <span class="main">⇒</span> bool<span class="main">)</span><span class="main">,</span>
    SHOcommGlobal <span class="main">=</span> Ate_commGlobal
   <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_M</span> <span class="main">≡</span> <span class="main">(</span>Ate_SHOMachine<span class="main">::</span><span class="main">(</span>Proc<span class="main">,</span> <span class="tfree">'val</span><span class="main">::</span>linorder pstate<span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> SHOMachine<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>   <span class="comment1">― ‹locale <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"ate_parameters"</span><span class="antiquote">}</span></span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>   <span class="comment1">(* theory AteDefs *)</span>
</pre>
</div><div id="AteProof">
<div class="head">
<h1>Theory AteProof</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> AteProof
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#AteDefs">AteDefs</a> <span class="quoted">"<a href="#Reduction">../Reduction</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> ate_parameters
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminary Lemmas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If a process newly decides value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> at some round,
  then it received more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E - α›</span></span></span></span> messages holding <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>
  at this round.
›</span></span>

<span class="keyword1" id="AteProof-decide_sent_msgs_threshold"><span class="command">lemma</span></span> decide_sent_msgs_threshold<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ate_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"SHOcommPerRd Ate_M <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nvp<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μp</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μp</span> <span class="main">∈</span> SHOmsgVectors Ate_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ate_M <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">μp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHORun_eq SHOnextConfig_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> mu
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span> <span class="main">-</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span>
          <span class="main">⊆</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?vrcvdp</span> <span class="main">-</span> <span class="var">?ahop</span> <span class="main">⊆</span> <span class="var">?vsentp</span>"</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHOmsgVectors_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?vrcvdp</span> <span class="main">-</span> <span class="var">?ahop</span><span class="main">)</span> <span class="main">≤</span> card <span class="var">?vsentp</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?vrcvdp</span> <span class="main">-</span> <span class="var">?ahop</span><span class="main">)</span> <span class="main">≥</span> card <span class="var">?vrcvdp</span> <span class="main">-</span> card <span class="var">?ahop</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono diff_card_le_card_Diff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?vsentp</span> <span class="main">≥</span> card <span class="var">?vrcvdp</span> <span class="main">-</span> card <span class="var">?ahop</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> nxt nvp vp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?vrcvdp</span> <span class="main">&gt;</span> <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def nextState_def Ate_nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> comm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_commPerRd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Egta <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E - α›</span></span></span></span> processes send a value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> to some
  process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> at some round, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> will receive at least
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>N + 2*α - E›</span></span></span></span> messages holding <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> at this round. 
›</span></span>

<span class="keyword1" id="AteProof-other_values_received"><span class="command">lemma</span></span> other_values_received<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"SHOcommPerRd Ate_M <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ate_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="free">μq</span> <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> muq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μq</span> <span class="main">∈</span> SHOmsgVectors Ate_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> vsent<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
             <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?vsent</span> <span class="main">&gt;</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">≠</span> Some <span class="free">v</span><span class="main">}</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">≤</span> N <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="free">α</span> <span class="main">-</span> <span class="free">E</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> nxt muq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">≠</span> Some <span class="free">v</span><span class="main">}</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span>
        <span class="main">⊆</span>  <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">≠</span> <span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?notvrcvd</span> <span class="main">-</span> <span class="var">?aho</span> <span class="main">⊆</span> <span class="var">?notvsent</span>"</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> SHOmsgVectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?notvsent</span> <span class="main">≥</span> card <span class="main">(</span><span class="var">?notvrcvd</span> <span class="main">-</span> <span class="var">?aho</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?notvrcvd</span> <span class="main">-</span> <span class="var">?aho</span><span class="main">)</span> <span class="main">≥</span> card <span class="var">?notvrcvd</span> <span class="main">-</span> card <span class="var">?aho</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono diff_card_le_card_Diff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> comm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?aho</span> <span class="main">≤</span> <span class="free">α</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_commPerRd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?notvsent</span> <span class="main">+</span> card <span class="var">?vsent</span> <span class="main">=</span> card <span class="main">(</span><span class="var">?notvsent</span> <span class="main">∪</span> <span class="var">?vsent</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_Un_Int<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?notvsent</span> <span class="main">∪</span> <span class="var">?vsent</span> <span class="main">=</span> <span class="main">(</span>UNIV<span class="main">::</span>Proc set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?notvsent</span> <span class="main">∪</span> <span class="var">?vsent</span><span class="main">)</span> <span class="main">=</span> N"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> 1 vsent <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?notvsent</span> <span class="main">≤</span>  N <span class="main">-</span> <span class="main">(</span><span class="free">E</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> EltN Egta <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E - α›</span></span></span></span> processes send a value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> to some
  process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> at some round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>, and if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> receives more than
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> messages in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> is the most frequently
  received value by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>.
›</span></span>

<span class="keyword1" id="AteProof-mostOftenRcvd_v"><span class="command">lemma</span></span> mostOftenRcvd_v<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"SHOcommPerRd Ate_M <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ate_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="free">μq</span> <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> muq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μq</span> <span class="main">∈</span> SHOmsgVectors Ate_M <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> threshold_T<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> threshold_E<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mostOftenRcvd <span class="free">μq</span> <span class="main">=</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> muq <span class="keyword1"><span class="command">have</span></span> hodef<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span> <span class="main">=</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> SHOmsgVectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> comm nxt muq threshold_E
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">≠</span> Some <span class="free">v</span><span class="main">}</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">≤</span> N <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="free">α</span> <span class="main">-</span> <span class="free">E</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?heardnotv</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> other_values_received<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?heardnotv</span> <span class="main">≥</span> <span class="free">T</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> muq
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?heardnotv</span> <span class="main">=</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> SHOmsgVectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?heardnotv</span> <span class="main">=</span> card <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">-</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_Diff_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> hodef threshold_T <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span> <span class="main">&gt;</span> card <span class="var">?heardnotv</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> TNaE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> hodef <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="skolem">w</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?heardnotv</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="skolem">w</span><span class="main">}</span> <span class="main">≤</span> card <span class="var">?heardnotv</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">w</span><span class="main">.</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="bound">w</span><span class="main">}</span> <span class="main">≥</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mostOftenRcvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If at some round more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E - α›</span></span></span></span> processes have their <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>
  variable set to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>, then this is also true at next round.
›</span></span>

<span class="keyword1" id="AteProof-common_x_induct"><span class="command">lemma</span></span> common_x_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ate_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"SHOcommPerRd Ate_M <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="free">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ih 
  <span class="keyword1"><span class="command">have</span></span> thrE<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">pp</span><span class="main">.</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="bound">qq</span> <span class="bound">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>
                      <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_sendMsg_def<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">qq</span>
    <span class="keyword3"><span class="command">assume</span></span> kv<span class="main">:</span><span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μqq</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ate_M <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">qq</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="skolem">μqq</span> <span class="main">(</span><span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> muq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μqq</span> <span class="main">∈</span> SHOmsgVectors Ate_M <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">qq</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> 
                                         <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHORun_eq SHOnextConfig_eq<span class="main">)</span>
        
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="free">k</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> comm nxt muq thrE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mostOftenRcvd <span class="skolem">μqq</span> <span class="main">=</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mostOftenRcvd_v<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> nxt True <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="free">k</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def nextState_def Ate_nextState_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> nxt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="free">k</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def nextState_def Ate_nextState_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> kv <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="free">k</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="free">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="free">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Whenever some process newly decides value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>, then any
  process that updates its <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> variable will set it to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>.
›</span></span>
<span class="comment1">(* The proof mainly relies on lemmas @{text decide_sent_msgs_threshold},
   @{text mostOftenRcvd_v} and @{text common_x_induct}. *)</span>

<span class="keyword1" id="AteProof-common_x"><span class="command">lemma</span></span> common_x<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ate_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> SHOcommPerRd <span class="main">(</span>Ate_M<span class="main">::</span><span class="main">(</span>Proc<span class="main">,</span> <span class="tfree">'val</span><span class="main">::</span>linorder pstate<span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> SHOMachine<span class="main">)</span>
                              <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> qupdatex<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="free">k</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="free">k</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> comm 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SHOcommPerRd <span class="main">(</span>Ate_M<span class="main">::</span><span class="main">(</span>Proc<span class="main">,</span> <span class="tfree">'val</span><span class="main">::</span>linorder pstate<span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> SHOMachine<span class="main">)</span> 
                     <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μq</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ate_M <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">μq</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="free">k</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> muq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μq</span> <span class="main">∈</span> SHOmsgVectors Ate_M <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>
                                   <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHORun_eq SHOnextConfig_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> nxt qupdatex 
  <span class="keyword1"><span class="command">have</span></span> threshold_T<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μq</span> <span class="bound">qq</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xsmall<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="free">k</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Min <span class="main">(</span>mostOftenRcvd <span class="skolem">μq</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def nextState_def Ate_nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> run comm d1 d2
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decide_sent_msgs_threshold<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_sendMsg_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> run comm <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> common_x_induct<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> run
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_sendMsg_def SHORun_eq SHOnextConfig_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mostOftenRcvd <span class="skolem">μq</span> <span class="main">=</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>mostOftenRcvd_v<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> xsmall <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A process that holds some decision <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> has decided <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>
  sometime in the past.
›</span></span>
<span class="keyword1" id="AteProof-decisionNonNullThenDecided"><span class="command">lemma</span></span> decisionNonNullThenDecided<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ate_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">m</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">m</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dec</span> <span class="free">k</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">k</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="var">?dec</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?dec</span> <span class="bound">m</span> <span class="main">⟶</span> <span class="var">?dec</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v</span><span class="main">)</span> <span class="main">⟶</span> <span class="var">?dec</span> <span class="free">n</span> <span class="main">≠</span> Some <span class="free">v</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="free">n</span> <span class="main">⟶</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def SHORun_eq HOinitConfig_eq
                     initState_def Ate_initState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">n</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> dec that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of Validity›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Validity asserts that if all processes were initialized with the same value,
  then no other value may ever be decided.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ate_validity<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ate_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> SHOcommPerRd Ate_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> initv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dp<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="skolem">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> run initv <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="main">0</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHORun_eq SHOnextConfig_eq Ate_SHOMachine_def Ate_sendMsg_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
      <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="skolem">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">qq</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">qq</span>
        <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μqq</span></span>
          <span class="keyword2"><span class="keyword">where</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ate_M <span class="skolem">r</span> <span class="skolem">qq</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="skolem">qq</span><span class="main">)</span> <span class="skolem">μqq</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μqq</span> <span class="main">∈</span> SHOmsgVectors Ate_M <span class="skolem">r</span> <span class="skolem">qq</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="skolem">r</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHORun_eq SHOnextConfig_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> nxt
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span> <span class="main">∧</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> Min <span class="main">(</span>mostOftenRcvd <span class="skolem">μqq</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∨</span> <span class="main">(</span>card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">≤</span> <span class="free">T</span> <span class="main">∧</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="skolem">qq</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def nextState_def Ate_nextState_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_sendMsg_def<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> threshold_T<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>
             <span class="keyword2"><span class="keyword">and</span></span> xsmall<span class="main">:</span><span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> Min <span class="main">(</span>mostOftenRcvd <span class="skolem">μqq</span><span class="main">)</span>"</span></span>
                   
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">∧</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="bound">w</span><span class="main">}</span> <span class="main">≤</span> <span class="free">T</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">from</span></span> comm <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">qq</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="skolem">r</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_commPerRd_def<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">from</span></span> mu ih
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">SHOs</span> <span class="skolem">r</span> <span class="skolem">qq</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">qq</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">qq</span> <span class="main">=</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHOmsgVectors_def Ate_SHOMachine_def Ate_sendMsg_def<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span> 
                   <span class="main">⊆</span> <span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">qq</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="skolem">r</span> <span class="skolem">qq</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span><span class="main">)</span>
                      <span class="main">≤</span> card <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">qq</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="skolem">r</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>card_mono<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="free">T</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Tge2a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span>
                  <span class="main">=</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">∧</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="bound">w</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span>
                <span class="main">=</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">∧</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="bound">w</span><span class="main">}</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">∧</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="bound">w</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span>
                 <span class="main">=</span> card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span> <span class="main">+</span> card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">∧</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="bound">w</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_Un_Int<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">note</span></span> threshold_T
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span> <span class="main">&gt;</span> card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">∧</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="bound">w</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="skolem">w</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">∧</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="bound">w</span><span class="main">}</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="skolem">w</span><span class="main">}</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">∧</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="bound">w</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> zz<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">⟹</span> 
                       card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="bound">w</span><span class="main">}</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μqq</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="bound">w</span><span class="main">}</span>
                      <span class="main">⟹</span> <span class="bound">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">with</span></span> zz <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mostOftenRcvd <span class="skolem">μqq</span> <span class="main">=</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mostOftenRcvd_def<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> xsmall <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_sendMsg_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> P <span class="main">=</span> this

  <span class="keyword1"><span class="command">from</span></span> run dp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rp</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rp</span> <span class="main">&lt;</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="skolem">rp</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">w</span>"</span></span> 
              <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">rp</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> decisionNonNullThenDecided<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μp</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ate_M <span class="skolem">rp</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">rp</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">μp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">rp</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μp</span> <span class="main">∈</span> SHOmsgVectors Ate_M <span class="skolem">rp</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">rp</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="skolem">rp</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHORun_eq SHOnextConfig_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> comm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">HOs</span> <span class="skolem">rp</span> <span class="free">p</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="skolem">rp</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_commPerRd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> mu P
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">SHOs</span> <span class="skolem">rp</span> <span class="free">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="skolem">rp</span> <span class="free">p</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="skolem">rp</span> <span class="free">p</span> <span class="main">=</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHOmsgVectors_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span>
           <span class="main">⊆</span> <span class="free">HOs</span> <span class="skolem">rp</span> <span class="free">p</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="skolem">rp</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span><span class="main">)</span>
            <span class="main">≤</span> card <span class="main">(</span><span class="free">HOs</span> <span class="skolem">rp</span> <span class="free">p</span> <span class="main">-</span> <span class="free">SHOs</span> <span class="skolem">rp</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">E</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Egta <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> w <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="skolem">w</span><span class="main">}</span> 
                 <span class="main">⊆</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="skolem">w</span><span class="main">}</span> 
             <span class="main">≤</span> card <span class="main">(</span><span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">pp</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="skolem">w</span><span class="main">}</span> <span class="main">&lt;</span> <span class="free">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> PP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> card <span class="main">{</span><span class="bound">pp</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">pp</span> <span class="main">=</span> Some <span class="bound">w</span><span class="main">}</span> <span class="main">≥</span> <span class="free">E</span> <span class="main">⟹</span> <span class="bound">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">from</span></span> rp nxt mu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="free">w</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHOmsgVectors_def Ate_SHOMachine_def 
                   nextState_def Ate_nextState_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> PP <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of Agreement›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If two processes decide at the some round, they decide the same value.
›</span></span>
<span class="comment1">(* The proof mainly relies on lemma @{text decide_sent_msgs_threshold}. *)</span>

<span class="keyword1" id="AteProof-common_decision"><span class="command">lemma</span></span> common_decision<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ate_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"SHOcommPerRd Ate_M <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nvp<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nwq<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> wq<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> gtn<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>
             <span class="main">+</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span><span class="main">}</span> <span class="main">&gt;</span> N"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> run comm nvp vp
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> decide_sent_msgs_threshold<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> run comm nwq wq
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> decide_sent_msgs_threshold<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> majE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> vw<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_sendMsg_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> vw
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>
          <span class="main">∩</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> gtn
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span> 
                 <span class="main">∪</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span><span class="main">}</span><span class="main">)</span> <span class="main">&gt;</span> N"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_Un_Int<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span> 
                 <span class="main">∪</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> N"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> decides at step <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> and process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> decides
  at some later step <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r+k›</span></span></span></span> then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> decide the
  same value.
›</span></span>
<span class="comment1">(*
  The proof mainly relies on lemmas @{text common_decision}, @{text common_x},
  @{text decide_with_threshold_E}, @{text unique_majority_E_α} 
  and @{text  decide_sent_msgs_threshold}.
*)</span>

<span class="keyword1" id="AteProof-laterProcessDecidesSameValue"><span class="command">lemma</span></span> laterProcessDecidesSameValue <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ate_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> SHOcommPerRd Ate_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nd1<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nd2<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> vdifw<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> kgt0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> run comm nd1 d1 nd2 d2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> common_decision<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> vdifw <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>
           <span class="main">∩</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sentv</span> <span class="main">∩</span> <span class="var">?sentw</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qq</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> xrv<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rkw<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_sendMsg_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k'</span></span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="bound">k'</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">≠</span> <span class="free">w</span> <span class="main">∧</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="bound">k'</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k'</span>
        <span class="keyword3"><span class="command">assume</span></span> kk'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">≠</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k'</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> xrv vdifw
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">≠</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k'</span>
          <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">≠</span> <span class="free">w</span>"</span></span>
             <span class="keyword2"><span class="keyword">and</span></span> ksk'<span class="main">:</span><span class="quoted"><span class="quoted">"Suc <span class="skolem">k'</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> ksk' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> ih f  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="skolem">k'</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">≠</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">with</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k'</span></span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="bound">k'</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">≠</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> kgt0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> kk<span class="main">:</span><span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">≠</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> rkw kk <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="skolem">k'</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> qqupdatex<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="skolem">k'</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">≠</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> run comm nd1 d1 qqupdatex
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> Suc <span class="skolem">k'</span><span class="main">)</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> common_x<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> w vdifw <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> run comm nd1 d1 <span class="keyword1"><span class="command">have</span></span> sentv<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?sentv</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decide_sent_msgs_threshold<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> run comm nd2 d2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?sentw</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> decide_sent_msgs_threshold<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> sentv majE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="var">?sentv</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>card <span class="var">?sentw</span><span class="main">)</span> <span class="main">&gt;</span> N"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> 1 vdifw  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?sentv</span> <span class="main">∪</span> <span class="var">?sentw</span><span class="main">)</span> <span class="main">&gt;</span> N"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_Un_Int<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?sentv</span> <span class="main">∪</span> <span class="var">?sentw</span><span class="main">)</span> <span class="main">≤</span> N"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The Agreement property is now an immediate consequence.
›</span></span>
<span class="comment1">(*
  The proof mainly relies on lemmas @{text decisionNonNullThenDecided}
  and @{text laterProcessDecidesSameValue}.
*)</span>

<span class="keyword1"><span class="command">theorem</span></span> ate_agreement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ate_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> SHOcommPerRd Ate_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">m</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> run p <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="skolem">k</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> decisionNonNullThenDecided<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> run q <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="skolem">l</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> decisionNonNullThenDecided<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">l</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">+</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_iff_add<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> run comm k l <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> laterProcessDecidesSameValue<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">l</span><span class="main">+</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_iff_add<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> run comm k l <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> laterProcessDecidesSameValue<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of Termination›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now prove that every process must eventually decide, given the
  global and round-by-round communication predicates.
›</span></span>
<span class="comment1">(* The proof relies on previous lemmas @{text common_x_induct} and @{text mostOftenRcvd_v}. *)</span>

<span class="keyword1"><span class="command">theorem</span></span> ate_termination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ate_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span>SHOcommPerRd<span class="main">::</span><span class="main">(</span><span class="main">(</span>Proc<span class="main">,</span> <span class="tfree">'val</span><span class="main">::</span>linorder pstate<span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> SHOMachine<span class="main">)</span>
                                     <span class="main">⇒</span> <span class="main">(</span>Proc HO<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>Proc HO<span class="main">)</span> <span class="main">⇒</span> bool<span class="main">)</span> 
                  Ate_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"SHOcommGlobal Ate_M <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span> <span class="bound">v</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> commG <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">π1</span></span> <span class="skolem"><span class="skolem">π2</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> πea<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">π1</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> πt<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">π2</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>  hosho<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">π1</span><span class="main">.</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r'</span> <span class="bound">p</span> <span class="main">=</span> <span class="skolem">π2</span> <span class="main">∧</span> <span class="free">SHOs</span> <span class="skolem">r'</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="skolem">r'</span> <span class="bound">p</span> <span class="main">=</span> <span class="skolem">π2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_commGlobal_def<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    P1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">pp</span><span class="main">.</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="bound">qq</span> <span class="bound">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">π1</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="skolem">π1</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">π1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="skolem">π1</span>"</span></span>

      <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μp</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> nxtp<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ate_M <span class="skolem">r'</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">μp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> mup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μp</span> <span class="main">∈</span> SHOmsgVectors Ate_M <span class="skolem">r'</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="skolem">r'</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHORun_eq SHOnextConfig_eq<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μq</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> nxtq<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ate_M <span class="skolem">r'</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">μq</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> muq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μq</span> <span class="main">∈</span> SHOmsgVectors Ate_M <span class="skolem">r'</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r'</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="skolem">r'</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHORun_eq SHOnextConfig_eq<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> mup muq p q
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μq</span> <span class="bound">qq</span> <span class="main">≠</span> None<span class="main">}</span>  <span class="main">=</span> <span class="free">HOs</span> <span class="skolem">r'</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>sendMsg Ate_M <span class="skolem">r'</span> <span class="bound">qq</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="bound">qq</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
               <span class="main">⊇</span> <span class="free">SHOs</span> <span class="skolem">r'</span> <span class="skolem">q</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="skolem">r'</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">≠</span> None<span class="main">}</span>  <span class="main">=</span> <span class="free">HOs</span> <span class="skolem">r'</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>sendMsg Ate_M <span class="skolem">r'</span> <span class="bound">qq</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="bound">qq</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
               <span class="main">⊇</span> <span class="free">SHOs</span> <span class="skolem">r'</span> <span class="skolem">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="skolem">r'</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHOmsgVectors_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> p q hosho 
      <span class="keyword1"><span class="command">have</span></span> aa<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">π2</span> <span class="main">=</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μq</span> <span class="bound">qq</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> cc<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">π2</span> <span class="main">=</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> p q hosho 2
      <span class="keyword1"><span class="command">have</span></span> bb<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>sendMsg Ate_M <span class="skolem">r'</span> <span class="bound">qq</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="bound">qq</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">⊇</span> <span class="skolem">π2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> p q hosho 4
      <span class="keyword1"><span class="command">have</span></span> dd<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="main">(</span>sendMsg Ate_M <span class="skolem">r'</span> <span class="bound">qq</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="bound">qq</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">⊇</span> <span class="skolem">π2</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>mostOftenRcvd <span class="skolem">μp</span><span class="main">)</span> <span class="main">=</span> Min <span class="main">(</span>mostOftenRcvd <span class="skolem">μq</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="skolem">r'</span> <span class="bound">qq</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="bound">qq</span><span class="main">)</span>
                   <span class="main">=</span> sendMsg Ate_M <span class="skolem">r'</span> <span class="bound">qq</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_sendMsg_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> aa bb cc dd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">≠</span> None <span class="main">⟶</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> <span class="skolem">μq</span> <span class="bound">qq</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> aa bb cc dd
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μq</span> <span class="bound">qq</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="skolem">μq</span> <span class="bound">qq</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> None <span class="main">⟶</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> <span class="skolem">μq</span> <span class="bound">qq</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">qq</span> <span class="main">=</span> <span class="skolem">μq</span> <span class="bound">qq</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mostOftenRcvd_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> πt aa nxtq πt cc nxtp
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def nextState_def Ate_nextState_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> Pv<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">π1</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pp</span>
      <span class="keyword1"><span class="command">from</span></span> Pv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">π1</span><span class="main">.</span> sendMsg Ate_M <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="bound">p</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_sendMsg_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">π1</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="bound">qq</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> πea
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="bound">qq</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">pp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">qq</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> P1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> commR
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>SHOcommPerRd<span class="main">::</span><span class="main">(</span><span class="main">(</span>Proc<span class="main">,</span> <span class="tfree">'val</span><span class="main">::</span>linorder pstate<span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> SHOMachine<span class="main">)</span> 
                               <span class="main">⇒</span> <span class="main">(</span>Proc HO<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>Proc HO<span class="main">)</span> <span class="main">⇒</span> bool<span class="main">)</span> 
                Ate_M <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> ih <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_sendMsg_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> common_x_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_sendMsg_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> P2 <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">pp</span>
    <span class="keyword3"><span class="command">assume</span></span> ppupdatex<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">≠</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> commR 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>SHOcommPerRd<span class="main">::</span><span class="main">(</span><span class="main">(</span>Proc<span class="main">,</span> <span class="tfree">'val</span><span class="main">::</span>linorder pstate<span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> SHOMachine<span class="main">)</span>
                            <span class="main">⇒</span> <span class="main">(</span>Proc HO<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>Proc HO<span class="main">)</span> <span class="main">⇒</span> bool<span class="main">)</span>
              Ate_M <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μpp</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> nxt<span class="main">:</span><span class="quoted"><span class="quoted">"nextState Ate_M <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="skolem">μpp</span> 
                           <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μpp</span> <span class="main">∈</span> SHOmsgVectors Ate_M <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>
                           <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHORun_eq SHOnextConfig_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> nxt ppupdatex
    <span class="keyword1"><span class="command">have</span></span> threshold_T<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μpp</span> <span class="bound">qq</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> xsmall<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> Min <span class="main">(</span>mostOftenRcvd <span class="skolem">μpp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def nextState_def Ate_nextState_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> P2
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">qq</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mostOftenRcvd <span class="skolem">μpp</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mostOftenRcvd_v<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> xsmall 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> P3 <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> P4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">pp</span><span class="main">.</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="bound">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pp</span>
    <span class="keyword1"><span class="command">from</span></span> commG <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">r''</span></span> <span class="main">&gt;</span> <span class="skolem">r'</span><span class="main">.</span> card <span class="main">(</span><span class="free">HOs</span> <span class="bound">r''</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_commGlobal_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">&gt;</span> <span class="skolem">r'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_imp_Suc_add<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μpp</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ate_M <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="skolem">μpp</span>
                                  <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μpp</span> <span class="main">∈</span> SHOmsgVectors Ate_M <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>
                                  <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHORun_eq SHOnextConfig_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> commR
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>SHOcommPerRd<span class="main">::</span><span class="main">(</span><span class="main">(</span>Proc<span class="main">,</span> <span class="tfree">'val</span><span class="main">::</span>linorder pstate<span class="main">,</span> <span class="tfree">'val</span><span class="main">::</span>linorder<span class="main">)</span> SHOMachine<span class="main">)</span>
                                <span class="main">⇒</span> <span class="main">(</span>Proc HO<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>Proc HO<span class="main">)</span> <span class="main">⇒</span> bool<span class="main">)</span> 
                Ate_M <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> mu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">μpp</span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHOmsgVectors_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> nxt t
      <span class="keyword1"><span class="command">have</span></span> threshold_T<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">μpp</span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> xsmall<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> Min <span class="main">(</span>mostOftenRcvd <span class="skolem">μpp</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def nextState_def Ate_nextState_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> P2
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">qq</span> <span class="skolem">pp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mostOftenRcvd <span class="skolem">μpp</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span>"</span></span>  
        <span class="keyword1"><span class="command">using</span></span> nxt mu <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mostOftenRcvd_v<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> xsmall <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> P5a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">pp</span><span class="main">.</span> <span class="main">∃</span><span class="bound">rr</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="bound">rr</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pp</span>
    <span class="keyword1"><span class="command">from</span></span> P4 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rk</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      xrrv<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> Suc <span class="skolem">rk</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="var">?rr</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="var">?rr</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="var">?rr</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> xrrv <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="var">?rr</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="var">?rr</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> rrk<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="var">?rr</span> <span class="main">+</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="var">?rr</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> nv<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="var">?rr</span> <span class="main">+</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> rrk ih
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> Suc <span class="skolem">k'</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">≠</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span> <span class="main">+</span> Suc <span class="skolem">k'</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> P3<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> rrk nv <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">rr</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="bound">rr</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> P5a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">F</span><span class="main">.</span> <span class="main">∀</span><span class="bound">pp</span> <span class="bound">k</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="bound">F</span> <span class="bound">pp</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> choice<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>Proc <span class="main">⇒</span> nat<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> imgR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">`</span> <span class="main">(</span>UNIV<span class="main">::</span>Proc set<span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">pp</span> <span class="bound">k</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="skolem">R</span> <span class="bound">pp</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rr</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rr</span> <span class="main">=</span> Max <span class="main">(</span><span class="skolem">R</span> <span class="main">`</span> UNIV<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> P5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">r'</span></span> <span class="main">&gt;</span> <span class="skolem">rr</span><span class="main">.</span> <span class="main">∀</span><span class="bound">pp</span><span class="main">.</span> x <span class="main">(</span><span class="free">rho</span> <span class="bound">r'</span> <span class="bound">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span> <span class="skolem">pp</span>
    <span class="keyword3"><span class="command">assume</span></span> r'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">&gt;</span> <span class="skolem">rr</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">&gt;</span> <span class="skolem">R</span> <span class="skolem">pp</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rr_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="skolem">R</span> <span class="skolem">pp</span> <span class="main">+</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_imp_Suc_add<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> R <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="skolem">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> commG <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">r'</span></span> <span class="main">&gt;</span> <span class="skolem">rr</span><span class="main">.</span> card <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r'</span> <span class="free">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="bound">r'</span> <span class="free">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_commGlobal_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> P5 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">&gt;</span> <span class="skolem">rr</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">SHOs</span> <span class="skolem">r'</span> <span class="free">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">E</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">pp</span><span class="main">.</span> sendMsg Ate_M <span class="skolem">r'</span> <span class="bound">pp</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="bound">pp</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_sendMsg_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μp</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState Ate_M <span class="skolem">r'</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">μp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μp</span> <span class="main">∈</span> SHOmsgVectors Ate_M <span class="skolem">r'</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHORun_eq SHOnextConfig_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> mu 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">SHOs</span> <span class="skolem">r'</span> <span class="free">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span>
        <span class="main">≤</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>sendMsg Ate_M <span class="skolem">r'</span> <span class="bound">q</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r'</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SHOmsgVectors_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> threshold_E<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">μp</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="skolem">v</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> nxt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def nextState_def Ate_nextState_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹\ate{} Solves Weak Consensus›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Summing up, all (coarse-grained) runs of \ate{} for
  HO and SHO collections that satisfy the communication predicate 
  satisfy the Weak Consensus property.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ate_weak_consensus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun Ate_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> SHOcommPerRd Ate_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"SHOcommGlobal Ate_M <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weak_consensus <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> decide <span class="free">rho</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> weak_consensus_def <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ate_validity ate_agreement ate_termination<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  By the reduction theorem, the correctness of the algorithm carries over
  to the fine-grained model of runs.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ate_weak_consensus_fg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run Ate_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">q</span><span class="main">.</span> undefined<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> SHOcommPerRd Ate_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"SHOcommGlobal Ate_M <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weak_consensus <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> x <span class="main">(</span>state <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> decide <span class="main">(</span>state <span class="main">∘</span> <span class="free">rho</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"weak_consensus <span class="var">?inits</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> local_property_reduction<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run weak_consensus_is_local<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">crun</span>
  <span class="keyword3"><span class="command">assume</span></span> crun<span class="main">:</span> <span class="quoted"><span class="quoted">"CSHORun Ate_M <span class="skolem">crun</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">q</span><span class="main">.</span> undefined<span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">crun</span> <span class="main">0</span> <span class="main">=</span> state <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> crun <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SHORun Ate_M <span class="skolem">crun</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> SHORun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this commR commG 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_consensus <span class="main">(</span>x <span class="main">∘</span> <span class="main">(</span><span class="skolem">crun</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> decide <span class="skolem">crun</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ate_weak_consensus<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> init <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"weak_consensus <span class="var">?inits</span> decide <span class="skolem">crun</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>   <span class="comment1">― ‹context <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"ate_parameters"</span><span class="antiquote">}</span></span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>   <span class="comment1">(* theory AteProof *)</span>
</pre>
</div><div id="EigbyzDefs">
<div class="head">
<h1>Theory EigbyzDefs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> EigbyzDefs
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#HOModel">../HOModel</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Verification of the \eigbyz{} Consensus Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Lynch~\cite{lynch:distributed} presents \eigbyz{}, a version of
  the \emph{exponential information gathering} algorithm tolerating
  Byzantine faults, that works in $f$ rounds, and that was originally
  introduced in~\cite{bar-noy:shifting-gears}.

  We begin by introducing an anonymous type of processes of finite
  cardinality that will instantiate the type variable <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'proc›</span></span></span></span>
  of the generic HO model.
›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> Proc <span class="comment1">― ‹the set of processes›</span>
<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span> Proc_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">OFCLASS</span><span class="main">(</span>Proc<span class="main">,</span> finite_class<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> Proc <span class="main">::</span> <span class="quoted">finite</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Proc_finite<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> card <span class="main">(</span>UNIV<span class="main">::</span>Proc set<span class="main">)</span>"</span></span>   <span class="comment1">― ‹number of processes›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The algorithm is parameterized by $f$, which represents the number of
  rounds and the height of the tree data structure (see below).
›</span></span>

<span class="keyword1"><span class="command">axiomatization</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">&lt;</span> N"</span></span>
<span class="comment1">(* NB: couldn't turn this into a locale, since f is used in the typedef below *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Tree Data Structure›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The algorithm relies on propagating information about the initially proposed
  values among all the processes. This information is stored in trees whose
  branches are labeled by lists of (distinct) processes. For example, the
  interpretation of an entry <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[p,q] ↦ Some v›</span></span></span></span> is that the current
  process heard from process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> that it had heard from process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>
  that its proposed value is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>. The value initially proposed by the process
  itself is stored at the root of the tree.

  We introduce the type of \emph{labels}, which encapsulate lists of distinct
  process identifiers and whose length is at most <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f+1›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Label</span> <span class="main">=</span> <span class="main">{</span><span class="bound">xs</span><span class="main">::</span>Proc list<span class="main">.</span> length <span class="bound">xs</span> <span class="main">≤</span> Suc f <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">typedef</span></span> Label <span class="main">=</span> <span class="quoted">Label</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Label_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>  <span class="comment1">― ‹the empty list is a label›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There is a finite number of different labels.›</span></span>

<span class="keyword1" id="EigbyzDefs-finite_Label"><span class="command">lemma</span></span> finite_Label<span class="main">:</span> <span class="quoted"><span class="quoted">"finite Label"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Label <span class="main">⊆</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">(</span>UNIV<span class="main">::</span>Proc set<span class="main">)</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">≤</span> Suc f<span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Label_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">(</span>UNIV<span class="main">::</span>Proc set<span class="main">)</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">≤</span> Suc f<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_lists_length_le<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EigbyzDefs-finite_UNIV_Label"><span class="command">lemma</span></span> finite_UNIV_Label<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV<span class="main">::</span>Label set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> finite_Label <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Abs_Label <span class="main">`</span> Label<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span><span class="main">::</span><span class="quoted">Label</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> Abs_Label <span class="main">`</span> Label"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Abs_Label_cases<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV<span class="main">::</span>Label set<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Abs_Label <span class="main">`</span> Label<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EigbyzDefs-finite_Label_set"><span class="command">lemma</span></span> finite_Label_set <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">S</span> <span class="main">::</span> Label set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_UNIV_Label <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Utility functions on labels.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">root_node</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_node</span> <span class="main">≡</span> Abs_Label <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">length_lbl</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">length_lbl</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> length <span class="main">(</span>Rep_Label <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">(* Don't declare the following [simp] because it would then be simplified away from
   hypotheses, whereas it can be useful for arithmetic reasoning. *)</span>
<span class="keyword1" id="EigbyzDefs-length_lbl"><span class="command">lemma</span></span> length_lbl <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length_lbl <span class="free">l</span> <span class="main">≤</span> Suc f"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> length_lbl_def <span class="keyword1"><span class="command">using</span></span> Label_def Rep_Label <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_leaf</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">is_leaf</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> length_lbl <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Suc f"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">last_lbl</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">last_lbl</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> last <span class="main">(</span>Rep_Label <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">butlast_lbl</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">butlast_lbl</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> Abs_Label <span class="main">(</span>butlast <span class="main">(</span>Rep_Label <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">set_lbl</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_lbl</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> set <span class="main">(</span>Rep_Label <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The children of a non-leaf label are all possible extensions of that label.
›</span></span>
<span class="comment1">(**
definition children where
  "children t ≡ { s . s ≠ root_node ∧ t = butlast_lbl s }"
**)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">children</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">children</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> 
   <span class="keyword1">if</span> is_leaf <span class="free"><span class="bound"><span class="entity">l</span></span></span>
   <span class="keyword1">then</span> <span class="main">{}</span> 
   <span class="keyword1">else</span> <span class="main">{</span> Abs_Label <span class="main">(</span>Rep_Label <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">|</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∉</span> set_lbl <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model of the Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following record models the local state of a process.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'val</span> pstate <span class="main">=</span>
  vals <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">⇒</span> <span class="tfree">'val</span> option"</span></span>
  newvals <span class="main">::</span> <span class="quoted"><span class="quoted">"Label <span class="main">⇒</span> <span class="tfree">'val</span>"</span></span>
  decide <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Initially, no values are assigned to non-root labels, and an arbitrary value
  is assigned to the root: that value is interpreted as the initial proposal of
  the process. No decision has yet been taken, and the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>newvals›</span></span></span></span> field
  is unconstrained.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EIG_initState</span> <span class="comment1">(*::"Proc ⇒ 'val pstate ⇒ bool"*)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">EIG_initState</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">.</span> <span class="main">(</span>vals <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="bound">l</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">l</span> <span class="main">≠</span> root_node<span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'val</span> Msg <span class="main">=</span> <span class="quoted"><span class="quoted">"Label <span class="main">⇒</span> <span class="tfree">'val</span> option"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  At every round, every process sends its current <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vals›</span></span></span></span> tree to all processes.
  In fact, only the level of the tree corresponding to the round number
  is used (cf. definition of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>extend_vals›</span></span></span></span> below).
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EIG_sendMsg</span> <span class="comment1">(*:: "nat ⇒ Proc ⇒ Proc ⇒ 'val pstate ⇒ 'val Msg"*)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">EIG_sendMsg</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> vals <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  During the first <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f-1›</span></span></span></span> rounds, every process extends its
  tree <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vals›</span></span></span></span> according to the values received in the round.
  No decision is taken.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extend_vals</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">extend_vals</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
   vals <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">l</span><span class="main">.</span>
      <span class="keyword1">if</span> length_lbl <span class="bound">l</span> <span class="main">=</span> Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">(</span>last_lbl <span class="bound">l</span><span class="main">)</span> <span class="main">≠</span> None
      <span class="keyword1">then</span> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">(</span>last_lbl <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>butlast_lbl <span class="bound">l</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> length_lbl <span class="bound">l</span> <span class="main">=</span> Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">(</span>last_lbl <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> None <span class="keyword1">then</span> None
      <span class="keyword1">else</span> vals <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="bound">l</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_main</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_main</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span> extend_vals <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In the final round, in addition to extending the tree as described previously,
  processes construct the tree <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>newvals›</span></span></span></span>, starting
  at the leaves. The values at the leaves are copied from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vals›</span></span></span></span>,
  except that missing values <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>None›</span></span></span></span> are replaced by the default value
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>undefined›</span></span></span></span>. Moving up, if there exists a majority value among the 
  children, it is assigned to the parent node, otherwise the parent node
  receives the default value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>undefined›</span></span></span></span>. The decision is set to the
  value computed for the root of the tree.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fixupval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option <span class="main">⇒</span> <span class="tfree">'val</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fixupval</span> None <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fixupval</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_majority</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'val</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">has_majority</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> card <span class="main">{</span><span class="bound"><span class="bound">e</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">e</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span> <span class="main">&gt;</span> <span class="main">(</span>card <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_newvals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> pstate <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_newvals</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span>
   <span class="main">∀</span><span class="bound">l</span><span class="main">.</span> is_leaf <span class="bound">l</span> <span class="main">∧</span> newvals <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="bound">l</span> <span class="main">=</span> fixupval <span class="main">(</span>vals <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="bound">l</span><span class="main">)</span>
     <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span>is_leaf <span class="bound">l</span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span> <span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> has_majority <span class="bound">w</span> <span class="main">(</span>newvals <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">(</span>children <span class="bound">l</span><span class="main">)</span> <span class="main">∧</span> newvals <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="bound">l</span> <span class="main">=</span> <span class="bound">w</span><span class="main">)</span>
       <span class="main">∨</span> <span class="main">(</span><span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> has_majority <span class="bound">w</span> <span class="main">(</span>newvals <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">(</span>children <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
             <span class="main">∧</span> newvals <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="bound">l</span> <span class="main">=</span> undefined<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_end</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_end</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span> 
     extend_vals <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span>
   <span class="main">∧</span> check_newvals <span class="free"><span class="bound"><span class="entity">st'</span></span></span>
   <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> Some <span class="main">(</span>newvals <span class="free"><span class="bound"><span class="entity">st'</span></span></span> root_node<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The overall next-state relation is defined such that every process applies
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nextMain›</span></span></span></span> during rounds <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>0›</span></span></span></span>, \ldots, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f-1›</span></span></span></span>, and applies
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nextEnd›</span></span></span></span> during round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span>. After that, the algorithm terminates
  and nothing changes anymore.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EIG_nextState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">EIG_nextState</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> 
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&lt;</span> f <span class="keyword1">then</span> next_main <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> f <span class="keyword1">then</span> next_end <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">st'</span><span class="main">.</span> <span class="bound">st'</span> <span class="main">=</span> <span class="bound">st</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Communication Predicate for \eigbyz›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The secure kernel <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SKr›</span></span></span></span> w.r.t. given HO and SHO collections consists
  of the process from which every process receives the correct message.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SKr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Proc HO <span class="main">⇒</span> Proc HO <span class="main">⇒</span> Proc set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SKr</span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="bound">p</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="bound">p</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The secure kernel <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SK›</span></span></span></span> of an entire execution (i.e., for sequences of
  HO and SHO collections) is the intersection of the secure kernels for
  all rounds. Obviously, only the first <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> rounds really matter,
  since the algorithm terminates after that.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> Proc HO<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> Proc HO<span class="main">)</span> <span class="main">⇒</span> Proc set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SK</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> SKr <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="bound">r</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The round-by-round predicate requires that the secure kernel at every round
  contains more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(N+f) div 2›</span></span></span></span> processes.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EIG_commPerRd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">EIG_commPerRd</span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="main">≡</span> card <span class="main">(</span>SKr <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">SHO</span></span></span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">(</span>N <span class="main">+</span> f<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The global predicate requires that the secure kernel for the entire
  execution contains at least <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>N-f›</span></span></span></span> processes. Messages from these
  processes are always correctly received by all processes.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EIG_commGlobal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">EIG_commGlobal</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="main">≡</span> card <span class="main">(</span>SK <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span><span class="main">)</span> <span class="main">≥</span> N <span class="main">-</span> f"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The above communication predicates differ from Lynch's presentation of
  \eigbyz{}. In fact, the algorithm was originally designed for synchronous
  systems with reliable links and at most <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> faulty processes.
  In such a system, every process receives the correct message from at least
  the non-faulty processes at every round, and therefore the global predicate
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>EIG_commGlobal›</span></span></span></span> is satisfied. The standard correctness
  proof assumes that $N&gt;3f$, and therefore $N - f &gt; (N + f) \div 2$.
  Since moreover, for any $r$, we obviously have
  \[
   \bigg(\bigcap_{p \in \Pi, r' \in \nat}\!\!\!\! SHO(p,r')\bigg)
   \ \subseteq\ \bigg(\bigcap_{p \in \Pi} SHO(p,r)\bigg),
  \]
  it follows that any execution of \eigbyz{} where $N&gt;3f$ also satisfies
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>EIG_commPerRd›</span></span></span></span> at any round. The standard correctness hypotheses thus imply
  our communication predicates.

  However, our proof shows that \eigbyz{} can indeed tolerate more
  transient faults than the standard bound can express. For example, consider the
  case where $N=5$ and $f=2$. Our predicates are satisfied in
  executions where two processes exhibit transient faults, but never fail
  simultaneously. Indeed, in such an execution, every process receives four
  correct messages at every round, hence <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>EIG_commPerRd›</span></span></span></span> always holds.
  Also, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>EIG_commGlobal›</span></span></span></span> is satisfied because there are
  three processes from which every process receives the correct messages at all
  rounds. By our correctness proof, it follows that $EIGByz_f$ then
  achieves Consensus, unlike what one could expect from the standard correctness
  predicate. This observation underlines the interest of expressing assumptions
  about transient faults, as in the HO model.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The \eigbyz{} Heard-Of Machine›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the non-coordinated SHO machine for \eigbyz{} by assembling
  the algorithm definition and its communication-predicate.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EIG_SHOMachine</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">EIG_SHOMachine</span> <span class="main">=</span> <span class="main">⦇</span>
    CinitState <span class="main">=</span>  <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">crd</span><span class="main">.</span> EIG_initState <span class="bound">p</span> <span class="bound">st</span><span class="main">)</span><span class="main">,</span>
    sendMsg <span class="main">=</span>  EIG_sendMsg<span class="main">,</span>
    CnextState <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span> <span class="bound">st'</span><span class="main">.</span> EIG_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">st'</span><span class="main">)</span><span class="main">,</span>
    SHOcommPerRd <span class="main">=</span> EIG_commPerRd<span class="main">,</span>
    SHOcommGlobal <span class="main">=</span> EIG_commGlobal 
   <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">EIG_M</span> <span class="main">≡</span> <span class="main">(</span>EIG_SHOMachine<span class="main">::</span><span class="main">(</span>Proc<span class="main">,</span> <span class="tfree">'val</span> pstate<span class="main">,</span> <span class="tfree">'val</span> Msg<span class="main">)</span> SHOMachine<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>  <span class="comment1">(* theory EIGbyzDefs *)</span>
</pre>
</div><div id="EigbyzProof">
<div class="head">
<h1>Theory EigbyzProof</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> EigbyzProof
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#EigbyzDefs">EigbyzDefs</a> <span class="quoted">"<a href="#Majorities">../Majorities</a>"</span> <span class="quoted">"<a href="#Reduction">../Reduction</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminary Lemmas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some technical lemmas about labels and trees.›</span></span>

<span class="keyword1" id="EigbyzProof-not_leaf_length"><span class="command">lemma</span></span> not_leaf_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>is_leaf <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length_lbl <span class="free">l</span> <span class="main">≤</span> f"</span></span>
  <span class="keyword1"><span class="command">using</span></span> l length_lbl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_leaf_def<span class="main">)</span>

<span class="keyword1" id="EigbyzProof-nil_is_Label"><span class="command">lemma</span></span> nil_is_Label<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> Label"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Label_def<span class="main">)</span>

<span class="keyword1" id="EigbyzProof-card_set_lbl"><span class="command">lemma</span></span> card_set_lbl<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set_lbl <span class="free">l</span><span class="main">)</span> <span class="main">=</span> length_lbl <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_lbl_def length_lbl_def
  <span class="keyword1"><span class="command">using</span></span> Rep_Label<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">,</span> <span class="operator">unfolded</span> Label_def<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> distinct_card<span class="main">)</span>

<span class="keyword1" id="EigbyzProof-Rep_Label_root_node"><span class="command">lemma</span></span> Rep_Label_root_node <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_Label root_node <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nil_is_Label <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> root_node_def Abs_Label_inverse<span class="main">)</span>

<span class="keyword1" id="EigbyzProof-root_node_length"><span class="command">lemma</span></span> root_node_length <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length_lbl root_node <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_lbl_def<span class="main">)</span>

<span class="keyword1" id="EigbyzProof-root_node_not_leaf"><span class="command">lemma</span></span> root_node_not_leaf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>is_leaf root_node<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_leaf_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Removing the last element of a non-root label gives a label.›</span></span>

<span class="keyword1" id="EigbyzProof-butlast_rep_in_label"><span class="command">lemma</span></span> butlast_rep_in_label<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> root_node"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"butlast <span class="main">(</span>Rep_Label <span class="free">l</span><span class="main">)</span> <span class="main">∈</span> Label"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep_Label <span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Rep_Label <span class="free">l</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Rep_Label <span class="free">l</span> <span class="main">=</span> Rep_Label root_node"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> l <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Rep_Label_inject<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> Rep_Label<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Label_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> distinct_butlast<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The label of a child is well-formed.
›</span></span>

<span class="keyword1" id="EigbyzProof-Rep_Label_append"><span class="command">lemma</span></span> Rep_Label_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>is_leaf <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Rep_Label <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">p</span><span class="main">]</span> <span class="main">∈</span> Label<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">∉</span> set_lbl <span class="free">l</span><span class="main">)</span>"</span></span>
     <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?l'</span> <span class="main">∈</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Label_def set_lbl_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> l<span class="main">[</span><span class="operator">THEN</span> not_leaf_length<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?l'</span> <span class="main">≤</span> Suc f"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_lbl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> Rep_Label<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>Rep_Label <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Label_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="var">?l'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_lbl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Label_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The label of a child is the label of the parent, extended by a process.
›</span></span>
<span class="keyword1" id="EigbyzProof-label_children"><span class="command">lemma</span></span> label_children<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> children <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∉</span> set_lbl <span class="free">l</span> <span class="main">∧</span> Rep_Label <span class="free">c</span> <span class="main">=</span> Rep_Label <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="bound">p</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> c <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> set_lbl <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>is_leaf <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> Abs_Label <span class="main">(</span>Rep_Label <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> children_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Rep_Label_append<span class="main">[</span><span class="operator">OF</span> l<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Abs_Label_inverse<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The label of any child node is one longer than the label of its parent.
›</span></span>

<span class="keyword1" id="EigbyzProof-children_length"><span class="command">lemma</span></span> children_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> children <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length_lbl <span class="free">l</span> <span class="main">=</span> Suc <span class="main">(</span>length_lbl <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> label_children<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_lbl_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The root node is never a child.›</span></span>

<span class="keyword1" id="EigbyzProof-children_not_root"><span class="command">lemma</span></span> children_not_root<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"root_node <span class="main">∈</span> children <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> label_children<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> Abs_Label_inverse<span class="main">[</span><span class="operator">OF</span> nil_is_Label<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> root_node_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The label of a child with the last element removed is the label of
  the parent.
›</span></span>

<span class="keyword1" id="EigbyzProof-children_butlast_lbl"><span class="command">lemma</span></span> children_butlast_lbl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> children <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"butlast_lbl <span class="free">c</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> label_children<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> butlast_lbl_def Rep_Label_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The root node is not a child, and it is the only such node.
›</span></span>

<span class="keyword1" id="EigbyzProof-root_iff_no_child"><span class="command">lemma</span></span> root_iff_no_child<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span> <span class="main">=</span> root_node<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l'</span><span class="main">.</span> <span class="free">l</span> <span class="main">∉</span> children <span class="bound">l'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> root_node"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l'</span><span class="main">.</span> <span class="free">l</span> <span class="main">∉</span> children <span class="bound">l'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> children_not_root<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l'</span><span class="main">.</span> <span class="free">l</span> <span class="main">∉</span> children <span class="bound">l'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> root_node"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rev_exhaust<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Rep_Label <span class="free"><span class="free">l</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Rep_Label <span class="free">l</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Rep_Label <span class="free">l</span> <span class="main">=</span> Rep_Label root_node"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Rep_Label_inject<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l'</span> <span class="skolem">q</span> 
    <span class="keyword3"><span class="command">assume</span></span> l'<span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_Label <span class="free">l</span> <span class="main">=</span> <span class="skolem">l'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Abs_Label <span class="skolem">l'</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Rep_Label<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span> l' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> Label"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Label_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> repl'<span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_Label <span class="var">?l'</span> <span class="main">=</span> <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Abs_Label_inverse<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> Rep_Label<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span> l' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q</span><span class="main">]</span> <span class="main">∈</span> Label"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Label_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> l' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep_Label <span class="free">l</span> <span class="main">=</span> Rep_Label <span class="main">(</span>Abs_Label <span class="main">(</span><span class="skolem">l'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_Label_inverse<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> Abs_Label <span class="main">(</span><span class="skolem">l'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rep_Label_inject<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Rep_Label<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span> l' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l'</span> <span class="main">&lt;</span> Suc f"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∉</span> set <span class="skolem">l'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Label_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> repl'
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> children <span class="var">?l'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> children_def is_leaf_def length_lbl_def set_lbl_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> rhs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If some label <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span> is not a leaf, then the set of processes that
  appear at the end of the labels of its children is the set of all 
  processes that do not appear in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span>.
›</span></span>

<span class="keyword1" id="EigbyzProof-children_last_set"><span class="command">lemma</span></span> children_last_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>is_leaf <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"last_lbl <span class="main">`</span> <span class="main">(</span>children <span class="free">l</span><span class="main">)</span> <span class="main">=</span> UNIV <span class="main">-</span> set_lbl <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"last_lbl <span class="main">`</span> <span class="main">(</span>children <span class="free">l</span><span class="main">)</span> <span class="main">⊆</span> UNIV <span class="main">-</span> set_lbl <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> label_children <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last_lbl_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">-</span> set_lbl <span class="free">l</span> <span class="main">⊆</span> last_lbl <span class="main">`</span> <span class="main">(</span>children <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> set_lbl <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> l <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"Abs_Label <span class="main">(</span>Rep_Label <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> children <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> children_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Rep_Label_append<span class="main">[</span><span class="operator">OF</span> l<span class="main">]</span> p
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span> <span class="main">∈</span> children <span class="free">l</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> last_lbl <span class="bound">c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last_lbl_def Abs_Label_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The function returning the last element of a label is injective on the
  set of children of some given label.
›</span></span>

<span class="keyword1" id="EigbyzProof-last_lbl_inj_on_children"><span class="command">lemma</span></span> last_lbl_inj_on_children<span class="main">:</span><span class="quoted"><span class="quoted">"inj_on last_lbl <span class="main">(</span>children <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">c'</span>
  <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> children <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> children <span class="free">l</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"last_lbl <span class="skolem">c</span> <span class="main">=</span> last_lbl <span class="skolem">c'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> c c' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">p'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_Label <span class="skolem">c</span> <span class="main">=</span> Rep_Label <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">p</span><span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_Label <span class="skolem">c'</span> <span class="main">=</span> Rep_Label <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">p'</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> label_children<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> p p' eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_lbl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> p p' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep_Label <span class="skolem">c</span> <span class="main">=</span> Rep_Label <span class="skolem">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rep_Label_inject<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The number of children of any non-leaf label <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span> is the
  number of processes that do not appear in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span>.
›</span></span>

<span class="keyword1" id="EigbyzProof-card_children"><span class="command">lemma</span></span> card_children<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>is_leaf <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>children <span class="free">l</span><span class="main">)</span> <span class="main">=</span> N <span class="main">-</span> <span class="main">(</span>length_lbl <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last_lbl <span class="main">`</span> <span class="main">(</span>children <span class="free">l</span><span class="main">)</span> <span class="main">=</span> UNIV <span class="main">-</span> set_lbl <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> children_last_set<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>UNIV <span class="main">-</span> set_lbl <span class="free">l</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>UNIV<span class="main">::</span>Proc set<span class="main">)</span> <span class="main">-</span> card <span class="main">(</span>set_lbl <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_Diff_subset_Int<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> last_lbl_inj_on_children 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>children <span class="free">l</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>last_lbl <span class="main">`</span> children <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> card_image<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> card_set_lbl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Suppose a non-root label <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l'›</span></span></span></span> of length <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r+1›</span></span></span></span> ending in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span>, 
  and suppose that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> is well heard by process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> in round
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>. Then the value with which <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> decorates <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span> is the one
  that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> associates to the parent of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span>.
›</span></span>

<span class="keyword1" id="EigbyzProof-sho_correct_vals"><span class="command">lemma</span></span> sho_correct_vals<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun EIG_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> l'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> children <span class="free">l</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> shop<span class="main">:</span> <span class="quoted"><span class="quoted">"last_lbl <span class="free">l'</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span>length_lbl <span class="free">l</span><span class="main">)</span> <span class="free">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="main">(</span>length_lbl <span class="free">l</span><span class="main">)</span> <span class="free">p</span>"</span></span>
                <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?q</span> <span class="main">∈</span> <span class="free">SHOs</span> <span class="main">(</span><span class="var">?len</span> <span class="free">l</span><span class="main">)</span> <span class="free">p</span> <span class="main">∩</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="var">?len</span> <span class="free">l'</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="free">l'</span> <span class="main">=</span> vals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="var">?len</span> <span class="free">l</span><span class="main">)</span> <span class="var">?q</span><span class="main">)</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?len</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μp</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState EIG_M <span class="var">?r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">μp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="var">?r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μp</span> <span class="main">∈</span> SHOmsgVectors EIG_M <span class="var">?r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="var">?r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="var">?r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EIG_SHOMachine_def SHORun_eq SHOnextConfig_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> shop 
  <span class="keyword1"><span class="command">have</span></span> msl<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">μp</span> <span class="var">?q</span> <span class="main">=</span> Some <span class="main">(</span>vals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="var">?q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EIG_SHOMachine_def EIG_sendMsg_def SHOmsgVectors_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> nxt length_lbl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l'</span></span><span class="main">]</span> children_length<span class="main">[</span><span class="operator">OF</span> l'<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend_vals <span class="var">?r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">μp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="var">?r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EIG_SHOMachine_def nextState_def EIG_nextState_def
                   next_main_def next_end_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> msl l' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extend_vals_def children_length children_butlast_lbl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A process fixes the value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vals l›</span></span></span></span> of a label at state
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>length_lbl l›</span></span></span></span>, and then never modifies the value.
›</span></span>
<span class="comment1">(* currently nowhere used *)</span>
<span class="keyword1" id="EigbyzProof-keep_vals"><span class="command">lemma</span></span> keep_vals<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun EIG_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>length_lbl <span class="free">l</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> vals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>length_lbl <span class="free">l</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="free">l</span>"</span></span>
     <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="free">n</span> <span class="main">=</span> <span class="var">?vl</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">0</span> <span class="main">=</span> <span class="var">?vl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="skolem">n</span> <span class="main">=</span> <span class="var">?vl</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length_lbl <span class="free">l</span> <span class="main">+</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μp</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"nextState EIG_M <span class="var">?r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">μp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="var">?r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EIG_SHOMachine_def SHORun_eq SHOnextConfig_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="var">?vl</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EIG_SHOMachine_def nextState_def EIG_nextState_def
                   next_main_def next_end_def extend_vals_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lynch's Lemmas and Theorems›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If some process is safely heard by all processes at round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>,
  then all processes agree on the value associated to labels of length 
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r+1›</span></span></span></span> ending in that process.
›</span></span>

<span class="keyword1" id="EigbyzProof-lynch_6_15"><span class="command">lemma</span></span> lynch_6_15<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun EIG_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> l'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> children <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> skr<span class="main">:</span> <span class="quoted"><span class="quoted">"last_lbl <span class="free">l'</span> <span class="main">∈</span> SKr <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>length_lbl <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>length_lbl <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>length_lbl <span class="free">l'</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="free">l'</span> <span class="main">=</span> vals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>length_lbl <span class="free">l'</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="free">l'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> SKr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sho_correct_vals<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Suppose that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span> is a non-root label whose last element was well
  heard by all processes at round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>, and that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l'›</span></span></span></span> is a
  child of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span> corresponding to process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> that is also
  well heard by all processes at round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r+1›</span></span></span></span>. Then the values
  associated with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l'›</span></span></span></span> by any process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>
  are identical.
›</span></span>

<span class="keyword1" id="EigbyzProof-lynch_6_16_a"><span class="command">lemma</span></span> lynch_6_16_a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun EIG_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> children <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> skrl<span class="main">:</span> <span class="quoted"><span class="quoted">"last_lbl <span class="free">l</span> <span class="main">∈</span> SKr <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>length_lbl <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>length_lbl <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> l'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> children <span class="free">l</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> skrl'<span class="main">:</span><span class="quoted"><span class="quoted">"last_lbl <span class="free">l'</span> <span class="main">∈</span> SKr <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>length_lbl <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>length_lbl <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>length_lbl <span class="free">l'</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="free">l'</span> <span class="main">=</span> vals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>length_lbl <span class="free">l</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SKr_def sho_correct_vals<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For any non-leaf label <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span>, more than half of its children end with a 
  process that is well heard by everyone at round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>length_lbl l›</span></span></span></span>.
›</span></span>

<span class="keyword1" id="EigbyzProof-lynch_6_16_c"><span class="command">lemma</span></span> lynch_6_16_c<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"EIG_commPerRd <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>length_lbl <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>length_lbl <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
                 <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"EIG_commPerRd <span class="main">(</span><span class="free">HOs</span> <span class="var">?r</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>is_leaf <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">l'</span></span> <span class="main">∈</span> children <span class="free">l</span><span class="main">.</span> last_lbl <span class="bound">l'</span> <span class="main">∈</span> SKr <span class="main">(</span><span class="free">HOs</span> <span class="var">?r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="var">?r</span><span class="main">)</span><span class="main">}</span>
         <span class="main">&gt;</span> card <span class="main">(</span>children <span class="free">l</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?lhs</span> <span class="main">&gt;</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?skr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"SKr <span class="main">(</span><span class="free">HOs</span> <span class="var">?r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="var">?r</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last_lbl <span class="main">`</span> <span class="var">?lhs</span> <span class="main">=</span> <span class="var">?skr</span> <span class="main">-</span> set_lbl <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">from</span></span> children_last_set<span class="main">[</span><span class="operator">OF</span> l<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"last_lbl <span class="main">`</span> <span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?skr</span> <span class="main">-</span> set_lbl <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> children_length<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="var">?skr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> set_lbl <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span>  children_last_set<span class="main">[</span><span class="operator">OF</span> l<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> last_lbl <span class="main">`</span> children <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> last_lbl <span class="main">`</span> <span class="var">?lhs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def children_length<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?skr</span> <span class="main">-</span> set_lbl <span class="free">l</span> <span class="main">⊆</span> last_lbl <span class="main">`</span> <span class="var">?lhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> last_lbl_inj_on_children<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on last_lbl <span class="var">?lhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?lhs</span> <span class="main">=</span> card <span class="main">(</span><span class="var">?skr</span> <span class="main">-</span> set_lbl <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> card_image<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≥</span> <span class="main">(</span>card <span class="var">?skr</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>card <span class="main">(</span>set_lbl <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_card_le_card_Diff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?lhs</span> <span class="main">≥</span> <span class="main">(</span>card <span class="var">?skr</span><span class="main">)</span> <span class="main">-</span> <span class="var">?r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_set_lbl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> commR <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?skr</span> <span class="main">&gt;</span> <span class="main">(</span>N <span class="main">+</span> f<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EIG_commPerRd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> not_leaf_length<span class="main">[</span><span class="operator">OF</span> l<span class="main">]</span> f
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="var">?skr</span><span class="main">)</span> <span class="main">-</span> <span class="var">?r</span> <span class="main">&gt;</span> <span class="main">(</span>N <span class="main">-</span> <span class="var">?r</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> card_children<span class="main">[</span><span class="operator">OF</span> l<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="var">?skr</span><span class="main">)</span> <span class="main">-</span> <span class="var">?r</span> <span class="main">&gt;</span> card <span class="main">(</span>children <span class="free">l</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span> is a non-leaf label such that all of its children corresponding
  to well-heard processes at round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>length_lbl l›</span></span></span></span> have a uniform
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>newvals›</span></span></span></span> decoration at round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f+1›</span></span></span></span>, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span>
  itself is decorated with that same value.
›</span></span>
<span class="keyword1" id="EigbyzProof-newvals_skr_uniform"><span class="command">lemma</span></span> newvals_skr_uniform<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun EIG_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"EIG_commPerRd <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>length_lbl <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>length_lbl <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
                 <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"EIG_commPerRd <span class="main">(</span><span class="free">HOs</span> <span class="var">?r</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">and</span></span> notleaf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>is_leaf <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> unif<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l'</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">l'</span> <span class="main">∈</span> children <span class="free">l</span><span class="main">;</span>
                   last_lbl <span class="bound">l'</span> <span class="main">∈</span> SKr <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>length_lbl <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>length_lbl <span class="free">l</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">⟧</span> <span class="main">⟹</span> newvals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc f<span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="bound">l'</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"newvals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc f<span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> unif
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">l'</span></span> <span class="main">∈</span> children <span class="free">l</span><span class="main">.</span> last_lbl <span class="bound">l'</span> <span class="main">∈</span> SKr <span class="main">(</span><span class="free">HOs</span> <span class="var">?r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="var">?r</span><span class="main">)</span><span class="main">}</span>
      <span class="main">≤</span> card <span class="main">{</span><span class="bound"><span class="bound">l'</span></span> <span class="main">∈</span> children <span class="free">l</span><span class="main">.</span> newvals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc f<span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="bound">l'</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> lynch_6_16_c<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">HOs</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">SHOs</span></span><span class="main">,</span> <span class="operator">OF</span> commR notleaf<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> maj<span class="main">:</span> <span class="quoted"><span class="quoted">"has_majority <span class="free">v</span> <span class="main">(</span>newvals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc f<span class="main">)</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>children <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_majority_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"check_newvals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc f<span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EIG_SHOMachine_def SHORun_eq SHOnextConfig_eq
                   nextState_def EIG_nextState_def next_end_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> maj notleaf <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> wmaj<span class="main">:</span> <span class="quoted"><span class="quoted">"has_majority <span class="skolem">w</span> <span class="main">(</span>newvals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc f<span class="main">)</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>children <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wupd<span class="main">:</span> <span class="quoted"><span class="quoted">"newvals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc f<span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_newvals_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> maj wmaj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_majority_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> abs_majoritiesE'<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> wupd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A node whose label <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span> ends with a process which is well heard
  at round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>length_lbl l›</span></span></span></span> will have its <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>newvals›</span></span></span></span> field set
  (at round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f+1›</span></span></span></span>) to the ``fixed-up'' value given by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vals›</span></span></span></span>.
›</span></span>

<span class="keyword1" id="EigbyzProof-lynch_6_16_d"><span class="command">lemma</span></span> lynch_6_16_d<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun EIG_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> EIG_commPerRd <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> notroot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> children <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> skr<span class="main">:</span> <span class="quoted"><span class="quoted">"last_lbl <span class="free">l</span> <span class="main">∈</span> SKr <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>length_lbl <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>length_lbl <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> SKr <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span><span class="var">?len</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"newvals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc f<span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> fixupval <span class="main">(</span>vals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="var">?len</span> <span class="free">l</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">l</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> notroot skr <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"Suc f <span class="main">-</span> <span class="main">(</span><span class="var">?len</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> Suc f <span class="main">-</span> <span class="var">?len</span> <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> length_lbl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> leaf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leaf <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_leaf_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"check_newvals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc f<span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EIG_SHOMachine_def SHORun_eq SHOnextConfig_eq
                   nextState_def EIG_nextState_def next_end_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> leaf <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_newvals_def is_leaf_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">l</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l'</span> <span class="bound">t'</span><span class="main">.</span>
                <span class="main">⟦</span><span class="skolem">k</span> <span class="main">=</span> Suc f <span class="main">-</span> length_lbl <span class="bound">l'</span><span class="main">;</span> <span class="bound">l'</span> <span class="main">∈</span> children <span class="bound">t'</span><span class="main">;</span>
                 last_lbl <span class="bound">l'</span> <span class="main">∈</span> SKr <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span><span class="var">?len</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span><span class="var">?len</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
                <span class="main">⟹</span> <span class="var">?P</span> <span class="bound">l'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> flk<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">=</span> Suc f <span class="main">-</span> <span class="var">?len</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> notroot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> children <span class="skolem">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> skr<span class="main">:</span> <span class="quoted"><span class="quoted">"last_lbl <span class="skolem">l</span> <span class="main">∈</span> SKr <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span><span class="var">?len</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span><span class="var">?len</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fixupval <span class="main">(</span>vals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="var">?len</span> <span class="skolem">l</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> flk <span class="keyword1"><span class="command">have</span></span> notlf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>is_leaf <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_leaf_def<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l'</span>
    <span class="keyword3"><span class="command">assume</span></span> l'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> children <span class="skolem">l</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> skr'<span class="main">:</span> <span class="quoted"><span class="quoted">"last_lbl <span class="skolem">l'</span> <span class="main">∈</span> SKr <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span><span class="var">?len</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span><span class="var">?len</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> run notroot skr l' skr'
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="var">?len</span> <span class="skolem">l'</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">l'</span> <span class="main">=</span> vals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="var">?len</span> <span class="skolem">l</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lynch_6_16_a<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> flk l' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Suc f <span class="main">-</span> <span class="var">?len</span> <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> children_length<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this l' skr' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"newvals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc f<span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">l'</span> <span class="main">=</span> <span class="var">?v</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> notroot l' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> children_length<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> run commR notlf <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> newvals_skr_uniform<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Following Lynch~\cite{lynch:distributed}, we introduce some more useful
  concepts for reasoning about the data structure.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A label is \emph{common} if all processes agree on the final value it is
  decorated with.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">common</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">common</span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> 
   <span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> newvals <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">(</span>Suc f<span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> newvals <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">(</span>Suc f<span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The subtrees of a given label are all its possible extensions.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subtrees</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subtrees</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">l</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> Rep_Label <span class="bound">l</span> <span class="main">=</span> <span class="main">(</span>Rep_Label <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="bound">t</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="EigbyzProof-children_in_subtree"><span class="command">lemma</span></span> children_in_subtree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> children <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> subtrees <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> label_children<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subtrees_def<span class="main">)</span>

<span class="keyword1" id="EigbyzProof-subtrees_refl"><span class="command">lemma</span></span> subtrees_refl <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> subtrees <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subtrees_def<span class="main">)</span>

<span class="keyword1" id="EigbyzProof-subtrees_root"><span class="command">lemma</span></span> subtrees_root <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> subtrees root_node"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subtrees_def<span class="main">)</span>

<span class="keyword1" id="EigbyzProof-subtrees_trans"><span class="command">lemma</span></span> subtrees_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l''</span> <span class="main">∈</span> subtrees <span class="free">l'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> subtrees <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l''</span> <span class="main">∈</span> subtrees <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subtrees_def<span class="main">)</span>

<span class="keyword1" id="EigbyzProof-subtrees_antisym"><span class="command">lemma</span></span> subtrees_antisym<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> subtrees <span class="free">l'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> subtrees <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subtrees_def Rep_Label_inject<span class="main">)</span>

<span class="keyword1" id="EigbyzProof-subtrees_tree"><span class="command">lemma</span></span> subtrees_tree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> l'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> subtrees <span class="free">l'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> subtrees <span class="free">l''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> subtrees <span class="free">l''</span> <span class="main">∨</span> <span class="free">l''</span> <span class="main">∈</span> subtrees <span class="free">l'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subtrees_def append_eq_append_conv2<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Rep_Label <span class="free">l''</span> <span class="main">@</span> <span class="skolem">xs</span> <span class="main">=</span> Rep_Label <span class="free">l'</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Rep_Label <span class="free">l'</span> <span class="main">=</span> Rep_Label <span class="free">l''</span> <span class="main">@</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> Rep_Label <span class="free">l'</span> <span class="main">=</span> Rep_Label <span class="free">l''</span> <span class="main">@</span> <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EigbyzProof-subtrees_cases"><span class="command">lemma</span></span> subtrees_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> l'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> subtrees <span class="free">l</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> self<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">=</span> <span class="free">l</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> child<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">c</span> <span class="main">∈</span> children <span class="free">l</span><span class="main">;</span> <span class="free">l'</span> <span class="main">∈</span> subtrees <span class="bound">c</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> l' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_Label <span class="free">l'</span> <span class="main">=</span> <span class="main">(</span>Rep_Label <span class="free">l</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subtrees_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span> <span class="main">∈</span> children <span class="free">l</span><span class="main">.</span> <span class="free">l'</span> <span class="main">∈</span> subtrees <span class="bound">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> t <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rep_Label_inject<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">t'</span>
    <span class="keyword3"><span class="command">assume</span></span> cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Rep_Label<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l'</span></span><span class="main">]</span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>Rep_Label <span class="free">l</span> <span class="main">@</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">≤</span> Suc f"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Label_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> cons <span class="keyword1"><span class="command">have</span></span> notleaf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>is_leaf <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_leaf_def length_lbl_def<span class="main">)</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Abs_Label <span class="main">(</span>Rep_Label <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> t cons Rep_Label<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> set_lbl <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Label_def set_lbl_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> notleaf <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">∈</span> children <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> children_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> notleaf p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep_Label <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">p</span><span class="main">]</span> <span class="main">∈</span> Label"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rep_Label_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Rep_Label <span class="var">?c</span> <span class="main">=</span> <span class="main">(</span>Rep_Label <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_Label_inverse<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> cons t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> subtrees <span class="var">?c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subtrees_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> self child<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EigbyzProof-subtrees_leaf"><span class="command">lemma</span></span> subtrees_leaf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leaf <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> subtrees <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> l' <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subtrees_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> children <span class="free">l</span>"</span></span>  <span class="comment1">― ‹impossible›</span>
  <span class="keyword1"><span class="command">with</span></span> l <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> children_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EigbyzProof-children_subtrees_equal"><span class="command">lemma</span></span> children_subtrees_equal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> children <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">∈</span> children <span class="free">l</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">∈</span> subtrees <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep_Label <span class="free">c'</span> <span class="main">=</span> Rep_Label <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subtrees_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> label_children<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rep_Label_inject<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C›</span></span></span></span> of labels is a \emph{subcovering} w.r.t. label <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span>
  if for all leaf subtrees <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span> of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span> there
  exists some label <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>h ∈ C›</span></span></span></span> such that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span> is a subtree of
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>h›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>h›</span></span></span></span> is a subtree of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subcovering</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">subcovering</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> 
  <span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> subtrees <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> is_leaf <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">h</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> <span class="bound">h</span> <span class="main">∈</span> subtrees <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">∈</span> subtrees <span class="bound">h</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A \emph{covering} is a subcovering w.r.t. the root node.
›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">covering</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">covering</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≡</span> subcovering <span class="free"><span class="bound"><span class="entity">C</span></span></span> root_node"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The set of labels whose last element is well heard by all processes
  throughout the execution forms a covering, and all these labels are common.
›</span></span>

<span class="keyword1" id="EigbyzProof-lynch_6_18_a"><span class="command">lemma</span></span> lynch_6_18_a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SHORun EIG_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> EIG_commPerRd <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> children <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"last_lbl <span class="free">l</span> <span class="main">∈</span> SKr <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>length_lbl <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">(</span>length_lbl <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"common <span class="free">rho</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> common_def lynch_6_16_d lynch_6_15
           <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"fixupval"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="EigbyzProof-lynch_6_18_b"><span class="command">lemma</span></span> lynch_6_18_b<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun EIG_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"EIG_commGlobal <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> EIG_commPerRd <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"covering <span class="main">{</span><span class="bound">l</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> children <span class="bound">t</span> <span class="main">∧</span> last_lbl <span class="bound">l</span> <span class="main">∈</span> <span class="main">(</span>SK <span class="free">HOs</span> <span class="free">SHOs</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subcovering_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_leaf <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> card_set_lbl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set_lbl <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> Suc f"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_leaf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> commG <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"N <span class="main">&lt;</span> card <span class="main">(</span>SK <span class="free">HOs</span> <span class="free">SHOs</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span>set_lbl <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EIG_commGlobal_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> set_lbl <span class="skolem">l</span> <span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> SK <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> majorities_intersect<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">l2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    l<span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_Label <span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">l2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> SK <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_lbl_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> split_list_propE<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Abs_Label <span class="main">(</span><span class="skolem">l1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Rep_Label<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> l <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q</span><span class="main">]</span> <span class="main">∈</span> Label"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Label_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> reph<span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_Label <span class="var">?h</span> <span class="main">=</span> <span class="skolem">l1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Abs_Label_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length_lbl <span class="var">?h</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_lbl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="main">≠</span> root_node"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="main">∈</span> children <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> root_iff_no_child<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> reph q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last_lbl <span class="var">?h</span> <span class="main">∈</span> SK <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_lbl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> reph l <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> subtrees <span class="var">?h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subtrees_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">h</span> <span class="main">∈</span> children <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> last_lbl <span class="bound">h</span> <span class="main">∈</span> SK <span class="free">HOs</span> <span class="free">SHOs</span> <span class="main">∧</span> <span class="skolem">l</span> <span class="main">∈</span> subtrees <span class="bound">h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C›</span></span></span></span> covers the subtree rooted at label <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span> and if
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l ∉ C›</span></span></span></span> then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C›</span></span></span></span> also covers subtrees rooted at
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span>'s children.
›</span></span>

<span class="keyword1" id="EigbyzProof-lynch_6_19_a"><span class="command">lemma</span></span> lynch_6_19_a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cov<span class="main">:</span> <span class="quoted"><span class="quoted">"subcovering <span class="free">C</span> <span class="free">l</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> <span class="free">C</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> children <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subcovering <span class="free">C</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subcovering_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> subtrees <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> leaf<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leaf <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> s children_in_subtree<span class="main">[</span><span class="operator">OF</span> e<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> subtrees <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtrees_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> leaf cov <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> subtrees <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> subtrees <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subcovering_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> l <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> e'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">∈</span> children <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> subtrees <span class="skolem">e'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> subtrees_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> subtrees <span class="skolem">h</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span> <span class="main">∈</span> subtrees <span class="skolem">e'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> subtrees <span class="skolem">e'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtrees_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> subtrees <span class="skolem">e'</span> <span class="main">∨</span> <span class="skolem">e'</span> <span class="main">∈</span> subtrees <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtrees_tree<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> e e' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> children_subtrees_equal<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> e' h <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="bound">h</span> <span class="main">∈</span> subtrees <span class="free">e</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">∈</span> subtrees <span class="bound">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If there is a subcovering <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C›</span></span></span></span> for a label <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span> such that all labels
  in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C›</span></span></span></span> are common, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span> itself is common as well.
›</span></span>

<span class="keyword1" id="EigbyzProof-lynch_6_19_b"><span class="command">lemma</span></span> lynch_6_19_b<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun EIG_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cov<span class="main">:</span> <span class="quoted"><span class="quoted">"subcovering <span class="free">C</span> <span class="free">l</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> com<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l'</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> common <span class="free">rho</span> <span class="bound">l'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"common <span class="free">rho</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> cov <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"Suc f <span class="main">-</span> length_lbl <span class="free">l</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
  <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> Suc f <span class="main">-</span> length_lbl <span class="skolem">l</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"subcovering <span class="free">C</span> <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> 0 length_lbl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_leaf <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_leaf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> C <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> subtrees <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> subtrees <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subcovering_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subtrees_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> com <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"common <span class="free">rho</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">l</span>
  <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">=</span> Suc f <span class="main">-</span> length_lbl <span class="skolem">l</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"subcovering <span class="free">C</span> <span class="skolem">l</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l'</span><span class="main">.</span> <span class="main">⟦</span><span class="skolem">k</span> <span class="main">=</span> Suc f <span class="main">-</span> length_lbl <span class="bound">l'</span><span class="main">;</span> subcovering <span class="free">C</span> <span class="bound">l'</span><span class="main">⟧</span> <span class="main">⟹</span> common <span class="free">rho</span> <span class="bound">l'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"common <span class="free">rho</span> <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="free">C</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True 
    <span class="keyword1"><span class="command">with</span></span> com <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> children <span class="skolem">l</span><span class="main">.</span> subcovering <span class="free">C</span> <span class="bound">e</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lynch_6_19_a<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> children <span class="skolem">l</span><span class="main">.</span> <span class="skolem">k</span> <span class="main">=</span> Suc f <span class="main">-</span> length_lbl <span class="bound">e</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> children_length<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> com_ch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> children <span class="skolem">l</span><span class="main">.</span> common <span class="free">rho</span> <span class="bound">e</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ih<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> common_def<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
      <span class="keyword1"><span class="command">from</span></span> k <span class="keyword1"><span class="command">have</span></span> notleaf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>is_leaf <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_leaf_def<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Suc f"</span></span>
      <span class="keyword1"><span class="command">from</span></span> com_ch
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> children <span class="skolem">l</span><span class="main">.</span> newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">p</span><span class="main">)</span> <span class="bound">e</span> <span class="main">=</span> newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">q</span><span class="main">)</span> <span class="bound">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> common_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">e</span></span> <span class="main">∈</span> children <span class="skolem">l</span><span class="main">.</span> newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">p</span><span class="main">)</span> <span class="bound">e</span> <span class="main">=</span> <span class="bound">w</span><span class="main">}</span>
               <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">e</span></span> <span class="main">∈</span> children <span class="skolem">l</span><span class="main">.</span> newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">q</span><span class="main">)</span> <span class="bound">e</span> <span class="main">=</span> <span class="bound">w</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> run
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"check_newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"check_newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EIG_SHOMachine_def SHORun_eq SHOnextConfig_eq nextState_def
                       EIG_nextState_def next_end_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> notleaf <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> has_majority <span class="bound">w</span> <span class="main">(</span>newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>children <span class="skolem">l</span><span class="main">)</span>
              <span class="main">∧</span> newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">=</span> <span class="bound">w</span><span class="main">)</span>
       <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> has_majority <span class="bound">w</span> <span class="main">(</span>newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>children <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>
              <span class="main">∧</span> newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">=</span> undefined"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> has_majority <span class="bound">w</span> <span class="main">(</span>newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>children <span class="skolem">l</span><span class="main">)</span>
              <span class="main">∧</span> newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">=</span> <span class="bound">w</span><span class="main">)</span>
       <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> has_majority <span class="bound">w</span> <span class="main">(</span>newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>children <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>
              <span class="main">∧</span> newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">=</span> undefined"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_newvals_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">=</span> newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_majority_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> abs_majoritiesE'<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The root of the tree is a common node.›</span></span>

<span class="keyword1" id="EigbyzProof-lynch_6_20"><span class="command">lemma</span></span> lynch_6_20<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun EIG_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"EIG_commGlobal <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> EIG_commPerRd <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"common <span class="free">rho</span> root_node"</span></span>
<span class="keyword1"><span class="command">using</span></span> run lynch_6_18_b<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> lynch_6_19_b<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> children <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"last_lbl <span class="skolem">l</span> <span class="main">∈</span> SK <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"common <span class="free">rho</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SK_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> lynch_6_18_a<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run commR<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A decision is taken only at state <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f+1›</span></span></span></span> and then stays stable.
›</span></span>
<span class="keyword1" id="EigbyzProof-decide"><span class="command">lemma</span></span> decide<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun EIG_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> 
         <span class="main">(</span><span class="keyword1">if</span> <span class="free">r</span> <span class="main">&lt;</span> Suc f <span class="keyword1">then</span> None
          <span class="keyword1">else</span> Some <span class="main">(</span>newvals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc f<span class="main">)</span> <span class="free">p</span><span class="main">)</span> root_node<span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EIG_SHOMachine_def SHORun_eq HOinitConfig_eq
                   initState_def EIG_initState_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">r</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> run <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μp</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"EIG_nextState <span class="skolem">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">μp</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EIG_SHOMachine_def SHORun_eq SHOnextConfig_eq 
                   nextState_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EIG_nextState_def next_main_def next_end_def<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">r</span> <span class="main">&lt;</span> f<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> f"</span></span>
    <span class="keyword1"><span class="command">with</span></span> ih
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>newvals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc f<span class="main">)</span> <span class="free">p</span><span class="main">)</span> root_node<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of Agreement, Validity, and Termination›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The Agreement property is an immediate consequence of lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lynch_6_20›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Agreement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun EIG_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"EIG_commGlobal <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> EIG_commPerRd <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">m</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">n</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p q lynch_6_20<span class="main">[</span><span class="operator">OF</span> run commG commR<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> decide<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">]</span></span> common_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now show the Validity property: if all processes initially
  propose the same value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>, then no other value may be decided.

  By lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sho_correct_vals›</span></span></span></span>, value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> must propagate to
  all children of the root that are well heard at round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>0›</span></span></span></span>, and
  lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lynch_6_16_d›</span></span></span></span> implies that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> is the value assigned
  to all these children by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>newvals›</span></span></span></span>. Finally, lemma
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>newvals_skr_uniform›</span></span></span></span> lets us conclude.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Validity<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun EIG_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> EIG_commPerRd <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> initv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> the <span class="main">(</span>vals <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">q</span><span class="main">)</span> root_node<span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dp<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">rho</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

  <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> vals <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">q</span><span class="main">)</span> root_node <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">from</span></span> run <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vals <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="skolem">q</span><span class="main">)</span> root_node <span class="main">≠</span> None"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EIG_SHOMachine_def SHORun_eq HOinitConfig_eq
                     initState_def EIG_initState_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"vals <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="skolem">q</span><span class="main">)</span> root_node <span class="main">=</span> Some <span class="skolem">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> initv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>vals <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="skolem">q</span><span class="main">)</span> root_node<span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">with</span></span> w <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vals <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="skolem">q</span><span class="main">)</span> root_node <span class="main">=</span> Some <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?len</span></span></span> <span class="main">=</span> <span class="quoted">length_lbl</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Suc f"</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l'</span>
    <span class="keyword3"><span class="command">assume</span></span> l'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> children root_node"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> skr<span class="main">:</span> <span class="quoted"><span class="quoted">"last_lbl <span class="skolem">l'</span> <span class="main">∈</span> SKr <span class="main">(</span><span class="free">HOs</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> run v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="var">?len</span> <span class="skolem">l'</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">l'</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sho_correct_vals <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SKr_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> run commR l' skr
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">l'</span> <span class="main">=</span> fixupval <span class="main">(</span>vals <span class="main">(</span><span class="free">rho</span> <span class="main">(</span><span class="var">?len</span> <span class="skolem">l'</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">l'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lynch_6_16_d<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">l'</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> run commR root_node_not_leaf
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"newvals <span class="main">(</span><span class="free">rho</span> <span class="var">?r</span> <span class="free">p</span><span class="main">)</span> root_node <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> newvals_skr_uniform<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> dp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> decide<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Termination is trivial for \eigbyz{}.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Termination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SHORun EIG_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span> <span class="bound">v</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> decide<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹\eigbyz{} Solves Weak Consensus›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Summing up, all (coarse-grained) runs of \eigbyz{} for
  HO and SHO collections that satisfy the communication predicate 
  satisfy the Weak Consensus property.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> eig_weak_consensus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"SHORun EIG_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> EIG_commPerRd <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"EIG_commGlobal <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weak_consensus <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> the <span class="main">(</span>vals <span class="main">(</span><span class="free">rho</span> <span class="main">0</span> <span class="bound">p</span><span class="main">)</span> root_node<span class="main">)</span><span class="main">)</span> decide <span class="free">rho</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> weak_consensus_def
  <span class="keyword1"><span class="command">using</span></span> Validity<span class="main">[</span><span class="operator">OF</span> run commR<span class="main">]</span>
        Agreement<span class="main">[</span><span class="operator">OF</span> run commG commR<span class="main">]</span>
        Termination<span class="main">[</span><span class="operator">OF</span> run<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  By the reduction theorem, the correctness of the algorithm carries over
  to the fine-grained model of runs.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> eig_weak_consensus_fg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"fg_run EIG_M <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">q</span><span class="main">.</span> undefined<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> EIG_commPerRd <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"EIG_commGlobal <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weak_consensus <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> the <span class="main">(</span>vals <span class="main">(</span>state <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> root_node<span class="main">)</span><span class="main">)</span>
                        decide <span class="main">(</span>state <span class="main">∘</span> <span class="free">rho</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"weak_consensus <span class="var">?inits</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> local_property_reduction<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run weak_consensus_is_local<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">crun</span>
  <span class="keyword3"><span class="command">assume</span></span> crun<span class="main">:</span> <span class="quoted"><span class="quoted">"CSHORun EIG_M <span class="skolem">crun</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">q</span><span class="main">.</span> undefined<span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">crun</span> <span class="main">0</span> <span class="main">=</span> state <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> crun <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SHORun EIG_M <span class="skolem">crun</span> <span class="free">HOs</span> <span class="free">SHOs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> SHORun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this commR commG 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"weak_consensus <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> the <span class="main">(</span>vals <span class="main">(</span><span class="skolem">crun</span> <span class="main">0</span> <span class="bound">p</span><span class="main">)</span> root_node<span class="main">)</span><span class="main">)</span> decide <span class="skolem">crun</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eig_weak_consensus<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> init <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"weak_consensus <span class="var">?inits</span> decide <span class="skolem">crun</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>