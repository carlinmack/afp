<div id="Mapping_Str">
<div class="head">
<h1>Theory Mapping_Str</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Mapping_Str.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Mapping›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Mapping_Str
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Auto2_HOL/Auto2_Main.html">Auto2_HOL.Auto2_Main</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Basic definitions of a mapping. Here, we enclose the mapping inside
  a structure, to make evaluation a first-order concept.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> map <span class="main">=</span> Map <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">meval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> map <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>"</span> <span class="main">[</span>90<span class="main">]</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Map <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> meval.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Mapping_Str-meval_ext"><span class="command">lemma</span></span> meval_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">M</span><span class="main">⟨</span><span class="bound">x</span><span class="main">⟩</span> <span class="main">=</span> <span class="free">N</span><span class="main">⟨</span><span class="bound">x</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">=</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">N</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_backward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> meval_ext<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_filt</span> <span class="main">(</span><span class="entity">order_filter</span> <span class="inner_quoted">"M"</span> <span class="inner_quoted">"N"</span><span class="main">)</span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">empty_map</span> <span class="main">=</span> Map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> empty_map_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> map <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> map"</span></span> <span class="main">(</span><span class="quoted">" _ <span class="keyword1">{</span> _ <span class="keyword1">→</span> _ <span class="keyword1">}</span>"</span> <span class="main">[</span>89<span class="main">,</span>90<span class="main">,</span>90<span class="main">]</span> 90<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main"><span class="free">}</span></span> <span class="main">=</span> Map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">⟨</span><span class="bound">x</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> update_map_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">delete_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> map <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delete_map</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> Map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> None <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">⟨</span><span class="bound">x</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> delete_map_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Map from an AList›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_of_alist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_of_alist</span> <span class="main">[]</span> <span class="main">=</span> empty_map"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_of_alist</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">map_of_alist</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">{</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">→</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> map_of_alist.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_key_alist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_key_alist</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Mapping_Str-map_of_alist_nil"><span class="command">lemma</span></span> map_of_alist_nil <span class="main">[</span><span class="operator">rewrite_back</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"has_key_alist <span class="free">ys</span> <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span>map_of_alist <span class="free">ys</span><span class="main">)</span><span class="main">⟨</span><span class="free">x</span><span class="main">⟩</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> map_of_alist_nil<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"(map_of_alist ?ys)⟨?x⟩"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Mapping_Str-map_of_alist_some"><span class="command">lemma</span></span> map_of_alist_some <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>map_of_alist <span class="free">xs</span><span class="main">)</span><span class="main">⟨</span><span class="free">k</span><span class="main">⟩</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Mapping_Str-map_of_alist_nil'"><span class="command">lemma</span></span> map_of_alist_nil'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>map_of_alist <span class="free">ys</span><span class="main">)</span><span class="main">⟨</span><span class="free">x</span><span class="main">⟩</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> map_of_alist_nil'<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"(map_of_alist ?ys)⟨?x⟩"</span><span class="main">]</span>›</span>
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Mapping defined by a set of key-value pairs›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unique_keys_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">unique_keys_set</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Mapping_Str-unique_keys_setD"><span class="command">lemma</span></span> unique_keys_setD <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unique_keys_set <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm_eqforward</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> unique_keys_set_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_of_aset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_of_aset</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> Map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> map_of_aset_def<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_prfstep_check_req</span> <span class="main">(</span><span class="inner_quoted">"map_of_aset S"</span><span class="main">,</span> <span class="inner_quoted">"unique_keys_set S"</span><span class="main">)</span>›</span>

<span class="keyword1" id="Mapping_Str-map_of_asetI1"><span class="command">lemma</span></span> map_of_asetI1 <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unique_keys_set <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span>map_of_aset <span class="free">S</span><span class="main">)</span><span class="main">⟨</span><span class="free">a</span><span class="main">⟩</span> <span class="main">=</span> Some <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Mapping_Str-map_of_asetI2"><span class="command">lemma</span></span> map_of_asetI2 <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span>map_of_aset <span class="free">S</span><span class="main">)</span><span class="main">⟨</span><span class="free">a</span><span class="main">⟩</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Mapping_Str-map_of_asetD1"><span class="command">lemma</span></span> map_of_asetD1 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_of_aset <span class="free">S</span><span class="main">)</span><span class="main">⟨</span><span class="free">a</span><span class="main">⟩</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Mapping_Str-map_of_asetD2"><span class="command">lemma</span></span> map_of_asetD2 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unique_keys_set <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span>map_of_aset <span class="free">S</span><span class="main">)</span><span class="main">⟨</span><span class="free">a</span><span class="main">⟩</span> <span class="main">=</span> Some <span class="free">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> map_of_aset_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Mapping_Str-map_of_aset_insert"><span class="command">lemma</span></span> map_of_aset_insert <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unique_keys_set <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> map_of_aset <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map_of_aset <span class="free">S</span><span class="main">)</span> <span class="main">{</span><span class="free">k</span> <span class="main">→</span> <span class="free">v</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> map_of_aset <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> map_of_aset <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="main">(</span><span class="main">@rule</span><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">N</span><span class="main">⟨</span><span class="bound">x</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">(</span><span class="free">M</span> <span class="main">{</span><span class="free">k</span> <span class="main">→</span> <span class="free">v</span><span class="main">}</span><span class="main">)</span> <span class="main">⟨</span><span class="bound">x</span><span class="main">⟩</span>"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">⟨</span><span class="free">x</span><span class="main">⟩</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Mapping_Str-map_of_alist_to_aset"><span class="command">lemma</span></span> map_of_alist_to_aset <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unique_keys_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> map_of_aset <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map_of_alist <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Mapping_Str-map_of_aset_delete"><span class="command">lemma</span></span> map_of_aset_delete <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unique_keys_set <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> map_of_aset <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> delete_map <span class="free">k</span> <span class="main">(</span>map_of_aset <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> map_of_aset <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> map_of_aset <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="main">(</span><span class="main">@rule</span><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">N</span><span class="main">⟨</span><span class="bound">x</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">(</span>delete_map <span class="free">k</span> <span class="free">M</span><span class="main">)</span> <span class="main">⟨</span><span class="bound">x</span><span class="main">⟩</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">⟨</span><span class="free">x</span><span class="main">⟩</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">⟨</span><span class="free">x</span><span class="main">⟩</span> <span class="main">=</span> Some <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Mapping_Str-map_of_aset_update"><span class="command">lemma</span></span> map_of_aset_update <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unique_keys_set <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span>
   map_of_aset <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map_of_aset <span class="free">S</span><span class="main">)</span> <span class="main">{</span><span class="free">k</span> <span class="main">→</span> <span class="free">v'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Mapping_Str-map_of_alist_delete"><span class="command">lemma</span></span> map_of_alist_delete <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">xs'</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⟹</span> unique_keys_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span>
   map_of_alist <span class="free">xs'</span> <span class="main">=</span> delete_map <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">(</span>map_of_alist <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"map_of_alist <span class="free">xs'</span> <span class="main">=</span> map_of_aset <span class="main">(</span>set <span class="free">xs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Mapping_Str-map_of_alist_insert"><span class="command">lemma</span></span> map_of_alist_insert <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">xs'</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⟹</span> unique_keys_set <span class="main">(</span>set <span class="free">xs'</span><span class="main">)</span> <span class="main">⟹</span>
   map_of_alist <span class="free">xs'</span> <span class="main">=</span> <span class="main">(</span>map_of_alist <span class="free">xs</span><span class="main">)</span> <span class="main">{</span>fst <span class="free">x</span> <span class="main">→</span> snd <span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"map_of_alist <span class="free">xs'</span> <span class="main">=</span> map_of_aset <span class="main">(</span>set <span class="free">xs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Mapping_Str-map_of_alist_update"><span class="command">lemma</span></span> map_of_alist_update <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">xs'</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="main">}</span> <span class="main">⟹</span> unique_keys_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span>
   map_of_alist <span class="free">xs'</span> <span class="main">=</span> <span class="main">(</span>map_of_alist <span class="free">xs</span><span class="main">)</span> <span class="main">{</span><span class="free">k</span> <span class="main">→</span> <span class="free">v'</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"map_of_alist <span class="free">xs'</span> <span class="main">=</span> map_of_aset <span class="main">(</span>set <span class="free">xs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Set of keys of a mapping›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">keys_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> map <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">keys_of</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">⟨</span><span class="bound">x</span><span class="main">⟩</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>

<span class="keyword1" id="Mapping_Str-keys_of_iff"><span class="command">lemma</span></span> keys_of_iff <span class="main">[</span><span class="operator">rewrite_bidir</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> keys_of <span class="free">M</span> <span class="main">⟷</span> <span class="free">M</span><span class="main">⟨</span><span class="free">x</span><span class="main">⟩</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> keys_of_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Mapping_Str-keys_of_empty"><span class="command">lemma</span></span> keys_of_empty <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"keys_of empty_map <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Mapping_Str-keys_of_delete"><span class="command">lemma</span></span> keys_of_delete <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"keys_of <span class="main">(</span>delete_map <span class="free">x</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> keys_of <span class="free">M</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Minimum of a mapping, relevant for heaps (priority queues)›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_heap_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> map <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_heap_min</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> keys_of <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span>keys_of <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">≤</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">⟨</span><span class="bound">k</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹General construction and update of maps›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_constr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_constr</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span> <span class="main">=</span> empty_map"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_constr</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">M</span> <span class="main">=</span> <span class="free">map_constr</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="bound">M</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">}</span> <span class="keyword1">else</span> <span class="bound">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> map_constr.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Mapping_Str-map_constr_eval"><span class="command">lemma</span></span> map_constr_eval <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_constr <span class="free">S</span> <span class="free">f</span> <span class="free">n</span> <span class="main">=</span> Map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free">S</span> <span class="bound">i</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> None <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Mapping_Str-keys_of_map_constr"><span class="command">lemma</span></span> keys_of_map_constr <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> keys_of <span class="main">(</span>map_constr <span class="free">S</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">S</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_update_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> map <span class="main">⇒</span> <span class="main">(</span>nat<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> map"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">map_update_all</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> Map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">∈</span> keys_of <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">⟨</span><span class="bound">i</span><span class="main">⟩</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_update_all_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> map <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_update_all_impl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_update_all_impl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">M'</span> <span class="main">=</span> <span class="free">map_update_all_impl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∈</span> keys_of <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">then</span> <span class="bound">M'</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">}</span> <span class="keyword1">else</span> <span class="bound">M'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> map_update_all_impl.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Mapping_Str-map_update_all_impl_ind"><span class="command">lemma</span></span> map_update_all_impl_ind <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_update_all_impl <span class="free">f</span> <span class="free">M</span> <span class="free">n</span> <span class="main">=</span> Map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">∈</span> keys_of <span class="free">M</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> None <span class="keyword1">else</span> <span class="free">M</span><span class="main">⟨</span><span class="bound">i</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Mapping_Str-map_update_all_impl_correct"><span class="command">lemma</span></span> map_update_all_impl_correct <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>keys_of <span class="free">M</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> map_update_all_impl <span class="free">f</span> <span class="free">M</span> <span class="free">n</span> <span class="main">=</span> map_update_all <span class="free">f</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Mapping_Str-keys_of_map_update_all"><span class="command">lemma</span></span> keys_of_map_update_all <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"keys_of <span class="main">(</span>map_update_all <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> keys_of <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lists_Ex">
<div class="head">
<h1>Theory Lists_Ex</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Lists_Ex.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lists›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lists_Ex
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Mapping_Str.html">Mapping_Str</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Examples on lists. The itrev example comes from
  \cite[Section 2.4]{prog-prove}.

  The development here of insertion and deletion on lists is
  essential for verifying functional binary search trees and
  red-black trees. The idea, following Nipkow~\cite{nipkow16},
  is that showing sorted-ness and preservation of multisets for trees
  should be done on the in-order traversal of the tree.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Linear time version of rev›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">itrev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">itrev</span> <span class="main">[]</span>       <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">itrev</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free">itrev</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> itrev.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Lists_Ex-itrev_eq_rev"><span class="command">lemma</span></span> itrev_eq_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"itrev <span class="free">x</span> <span class="main">[]</span> <span class="main">=</span> rev <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> itrev <span class="free">x</span> <span class="bound">y</span> <span class="main">=</span> rev <span class="free">x</span> <span class="main">@</span> <span class="bound">y</span>"</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">y</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Strict sorted›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">strict_sorted</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strict_sorted</span> <span class="main">[]</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">strict_sorted</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="free">strict_sorted</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> strict_sorted.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Lists_Ex-strict_sorted_appendI"><span class="command">lemma</span></span> strict_sorted_appendI <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strict_sorted <span class="free">xs</span> <span class="main">∧</span> strict_sorted <span class="free">ys</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> strict_sorted <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Lists_Ex-strict_sorted_appendE1"><span class="command">lemma</span></span> strict_sorted_appendE1 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strict_sorted <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> strict_sorted <span class="free">xs</span> <span class="main">∧</span> strict_sorted <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Lists_Ex-strict_sorted_appendE2"><span class="command">lemma</span></span> strict_sorted_appendE2 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strict_sorted <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="free">ys</span><span class="main">.</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Lists_Ex-strict_sorted_distinct"><span class="command">lemma</span></span> strict_sorted_distinct <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strict_sorted <span class="free">l</span> <span class="main">⟹</span> distinct <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">l</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Ordered insert›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ordered_insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ord <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ordered_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ordered_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">ordered_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ordered_insert.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Lists_Ex-ordered_insert_set"><span class="command">lemma</span></span> ordered_insert_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>ordered_insert <span class="free">x</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Lists_Ex-ordered_insert_sorted"><span class="command">lemma</span></span> ordered_insert_sorted <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strict_sorted <span class="free">ys</span> <span class="main">⟹</span> strict_sorted <span class="main">(</span>ordered_insert <span class="free">x</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Lists_Ex-ordered_insert_binary"><span class="command">lemma</span></span> ordered_insert_binary <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strict_sorted <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> ordered_insert <span class="free">x</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="keyword1">then</span> ordered_insert <span class="free">x</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">ys</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="free">a</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> ordered_insert <span class="free">x</span> <span class="free">ys</span>
     <span class="keyword1">else</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Deleting an element›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remove_elt_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_elt_list</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">remove_elt_list</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free">remove_elt_list</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">remove_elt_list</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> remove_elt_list.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Lists_Ex-remove_elt_list_set"><span class="command">lemma</span></span> remove_elt_list_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>remove_elt_list <span class="free">x</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">ys</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Lists_Ex-remove_elt_list_sorted"><span class="command">lemma</span></span> remove_elt_list_sorted <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strict_sorted <span class="free">ys</span> <span class="main">⟹</span> strict_sorted <span class="main">(</span>remove_elt_list <span class="free">x</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Lists_Ex-remove_elt_idem"><span class="command">lemma</span></span> remove_elt_idem <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">ys</span> <span class="main">⟹</span> remove_elt_list <span class="free">x</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Lists_Ex-remove_elt_list_binary"><span class="command">lemma</span></span> remove_elt_list_binary <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strict_sorted <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> remove_elt_list <span class="free">x</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="keyword1">then</span> remove_elt_list <span class="free">x</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">ys</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="free">a</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> remove_elt_list <span class="free">x</span> <span class="free">ys</span> <span class="keyword1">else</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Ordered insertion into list of pairs›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ordered_insert_pairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ord <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ordered_insert_pairs</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ordered_insert_pairs</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> fst <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">ordered_insert_pairs</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ordered_insert_pairs.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Lists_Ex-ordered_insert_pairs_map"><span class="command">lemma</span></span> ordered_insert_pairs_map <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_of_alist <span class="main">(</span>ordered_insert_pairs <span class="free">x</span> <span class="free">v</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> update_map <span class="main">(</span>map_of_alist <span class="free">ys</span><span class="main">)</span> <span class="free">x</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Lists_Ex-ordered_insert_pairs_set"><span class="command">lemma</span></span> ordered_insert_pairs_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="main">(</span>ordered_insert_pairs <span class="free">x</span> <span class="free">v</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Lists_Ex-ordered_insert_pairs_sorted"><span class="command">lemma</span></span> ordered_insert_pairs_sorted <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strict_sorted <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> strict_sorted <span class="main">(</span>map fst <span class="main">(</span>ordered_insert_pairs <span class="free">x</span> <span class="free">v</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Lists_Ex-ordered_insert_pairs_binary"><span class="command">lemma</span></span> ordered_insert_pairs_binary <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strict_sorted <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> ordered_insert_pairs <span class="free">x</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> fst <span class="free">a</span> <span class="keyword1">then</span> ordered_insert_pairs <span class="free">x</span> <span class="free">v</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">ys</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">x</span> <span class="main">&gt;</span> fst <span class="free">a</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> ordered_insert_pairs <span class="free">x</span> <span class="free">v</span> <span class="free">ys</span>
     <span class="keyword1">else</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Deleting from a list of pairs›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remove_elt_pairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_elt_pairs</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">remove_elt_pairs</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">remove_elt_pairs</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> remove_elt_pairs.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Lists_Ex-remove_elt_pairs_map"><span class="command">lemma</span></span> remove_elt_pairs_map <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strict_sorted <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> map_of_alist <span class="main">(</span>remove_elt_pairs <span class="free">x</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> delete_map <span class="free">x</span> <span class="main">(</span>map_of_alist <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys'</span>"</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">ys'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Lists_Ex-remove_elt_pairs_on_set"><span class="command">lemma</span></span> remove_elt_pairs_on_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strict_sorted <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> set <span class="main">(</span>map fst <span class="main">(</span>remove_elt_pairs <span class="free">x</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Lists_Ex-remove_elt_pairs_sorted"><span class="command">lemma</span></span> remove_elt_pairs_sorted <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strict_sorted <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> strict_sorted <span class="main">(</span>map fst <span class="main">(</span>remove_elt_pairs <span class="free">x</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Lists_Ex-remove_elt_pairs_idem"><span class="command">lemma</span></span> remove_elt_pairs_idem <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> remove_elt_pairs <span class="free">x</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Lists_Ex-remove_elt_pairs_binary"><span class="command">lemma</span></span> remove_elt_pairs_binary <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strict_sorted <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> remove_elt_pairs <span class="free">x</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> fst <span class="free">a</span> <span class="keyword1">then</span> remove_elt_pairs <span class="free">x</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">ys</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">x</span> <span class="main">&gt;</span> fst <span class="free">a</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> remove_elt_pairs <span class="free">x</span> <span class="free">ys</span> <span class="keyword1">else</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> fst <span class="free">a</span>"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Search in a list of pairs›</span></span>

<span class="keyword1" id="Lists_Ex-map_of_alist_binary"><span class="command">lemma</span></span> map_of_alist_binary <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strict_sorted <span class="main">(</span>map fst <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>map_of_alist <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">⟨</span><span class="free">x</span><span class="main">⟩</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> fst <span class="free">a</span> <span class="keyword1">then</span> <span class="main">(</span>map_of_alist <span class="free">xs</span><span class="main">)</span><span class="main">⟨</span><span class="free">x</span><span class="main">⟩</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">x</span> <span class="main">&gt;</span> fst <span class="free">a</span> <span class="keyword1">then</span> <span class="main">(</span>map_of_alist <span class="free">ys</span><span class="main">)</span><span class="main">⟨</span><span class="free">x</span><span class="main">⟩</span> <span class="keyword1">else</span> Some <span class="main">(</span>snd <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BST">
<div class="head">
<h1>Theory BST</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: BST.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Binary search tree›</span></span>

<span class="keyword1"><span class="command">theory</span></span> BST
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lists_Ex.html">Lists_Ex</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Verification of functional programs on binary search trees. For
  basic technique, see comments in Lists\_Ex.thy.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition and setup for trees›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree <span class="main">=</span>
    Tip <span class="main">|</span> Node <span class="main">(</span><span class="free"><span class="entity">lsub</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">key</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">nval</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">rsub</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_resolve_prfstep</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> tree.distinct<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> tree.sel<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> tree.collapse<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_var_induct_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> tree.induct<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inorder traversal, and set of elements of a tree›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">in_traverse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">in_traverse</span> Tip <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">in_traverse</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">in_traverse</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">#</span> <span class="free">in_traverse</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> in_traverse.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tree_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_set</span> Tip <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tree_set</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">tree_set</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∪</span> <span class="free">tree_set</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> tree_set.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">in_traverse_pairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">in_traverse_pairs</span> Tip <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">in_traverse_pairs</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">in_traverse_pairs</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">in_traverse_pairs</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> in_traverse_pairs.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="BST-in_traverse_fst"><span class="command">lemma</span></span> in_traverse_fst <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map fst <span class="main">(</span>in_traverse_pairs <span class="free">t</span><span class="main">)</span> <span class="main">=</span> in_traverse <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tree_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_map</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> map_of_alist <span class="main">(</span>in_traverse_pairs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> tree_map_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sortedness on trees›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tree_sorted</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_sorted</span> Tip <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tree_sorted</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>tree_set <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>tree_set <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">)</span>
                              <span class="main">∧</span> <span class="free">tree_sorted</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">tree_sorted</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> tree_sorted.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="BST-tree_sorted_lr"><span class="command">lemma</span></span> tree_sorted_lr <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="main">(</span>Node <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> tree_sorted <span class="free">l</span> <span class="main">∧</span> tree_sorted <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="BST-inorder_preserve_set"><span class="command">lemma</span></span> inorder_preserve_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_set <span class="free">t</span> <span class="main">=</span> set <span class="main">(</span>in_traverse <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="BST-inorder_pairs_sorted"><span class="command">lemma</span></span> inorder_pairs_sorted <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="free">t</span> <span class="main">⟷</span> strict_sorted <span class="main">(</span>map fst <span class="main">(</span>in_traverse_pairs <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Use definition in terms of in\_traverse from now on.›</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">del_prfstep_thm</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> tree_set.simps<span class="antiquote">}</span></span></span> @ <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> tree_sorted.simps<span class="antiquote">}</span></span></span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rotation on trees›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rotateL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">rotateL</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Tip <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> rsub <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Tip <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">rt</span> <span class="main">=</span> rsub <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span>
     Node <span class="main">(</span>Node <span class="main">(</span>lsub <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>key <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>nval <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>lsub <span class="bound">rt</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">rt</span><span class="main">)</span> <span class="main">(</span>nval <span class="bound">rt</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">rt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rotateR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">rotateR</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Tip <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> lsub <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Tip <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">lt</span> <span class="main">=</span> lsub <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span>
     Node <span class="main">(</span>lsub <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>nval <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>Node <span class="main">(</span>rsub <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>key <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>nval <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>rsub <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="BST-rotateL_in_trav"><span class="command">lemma</span></span> rotateL_in_trav <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"in_traverse <span class="main">(</span>rotateL <span class="free">t</span><span class="main">)</span> <span class="main">=</span> in_traverse <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="BST-rotateR_in_trav"><span class="command">lemma</span></span> rotateR_in_trav <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"in_traverse <span class="main">(</span>rotateR <span class="free">t</span><span class="main">)</span> <span class="main">=</span> in_traverse <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="BST-rotateL_sorted"><span class="command">lemma</span></span> rotateL_sorted <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tree_sorted <span class="free">t</span> <span class="main">⟹</span> tree_sorted <span class="main">(</span>rotateL <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="BST-rotateR_sorted"><span class="command">lemma</span></span> rotateR_sorted <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tree_sorted <span class="free">t</span> <span class="main">⟹</span> tree_sorted <span class="main">(</span>rotateR <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Insertion on trees›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tree_insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ord <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> Tip <span class="main">=</span> Node Tip <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> Tip"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tree_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Node <span class="main">(</span><span class="free">tree_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
     <span class="keyword1">else</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">(</span><span class="free">tree_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> tree_insert.simps<span class="antiquote">}</span></span></span>›</span>
 
<span class="keyword1" id="BST-insert_in_traverse_pairs"><span class="command">lemma</span></span> insert_in_traverse_pairs <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="free">t</span> <span class="main">⟹</span> in_traverse_pairs <span class="main">(</span>tree_insert <span class="free">x</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> ordered_insert_pairs <span class="free">x</span> <span class="free">v</span> <span class="main">(</span>in_traverse_pairs <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness results for insertion.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> insert_sorted <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="free">t</span> <span class="main">⟹</span> tree_sorted <span class="main">(</span>tree_insert <span class="free">x</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> insert_on_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="free">t</span> <span class="main">⟹</span> tree_map <span class="main">(</span>tree_insert <span class="free">x</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>tree_map <span class="free">t</span><span class="main">)</span> <span class="main">{</span><span class="free">x</span> <span class="main">→</span> <span class="free">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Deletion on trees›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">del_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">del_min</span> Tip <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">del_min</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="main">=</span> Tip <span class="keyword1">then</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span> <span class="keyword1">else</span>
    <span class="main">(</span>fst <span class="main">(</span><span class="free">del_min</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span><span class="main">)</span><span class="main">,</span> Node <span class="main">(</span>snd <span class="main">(</span><span class="free">del_min</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> del_min.simps<span class="main">(</span>2<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="BST-delete_min_del_hd_pairs"><span class="command">lemma</span></span> delete_min_del_hd_pairs <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Tip <span class="main">⟹</span> fst <span class="main">(</span>del_min <span class="free">t</span><span class="main">)</span> <span class="main">#</span> in_traverse_pairs <span class="main">(</span>snd <span class="main">(</span>del_min <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> in_traverse_pairs <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delete_elt_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delete_elt_tree</span> Tip <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">delete_elt_tree</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="main">=</span> Tip <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span> <span class="main">=</span> Tip <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="keyword1">else</span>
     Node <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="main">(</span>del_min <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>fst <span class="main">(</span>del_min <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>del_min <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> delete_elt_tree.simps<span class="main">(</span>2<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="BST-delete_elt_in_traverse_pairs"><span class="command">lemma</span></span> delete_elt_in_traverse_pairs <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"in_traverse_pairs <span class="main">(</span>delete_elt_tree <span class="main">(</span>Node <span class="free">lt</span> <span class="free">x</span> <span class="free">v</span> <span class="free">rt</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> in_traverse_pairs <span class="free">lt</span> <span class="main">@</span> in_traverse_pairs <span class="free">rt</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tree_delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ord <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Tip <span class="main">=</span> Tip"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tree_delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> delete_elt_tree <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Node <span class="main">(</span><span class="free">tree_delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
     <span class="keyword1">else</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">(</span><span class="free">tree_delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> tree_delete.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="BST-tree_delete_in_traverse_pairs"><span class="command">lemma</span></span> tree_delete_in_traverse_pairs <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="free">t</span> <span class="main">⟹</span> in_traverse_pairs <span class="main">(</span>tree_delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> remove_elt_pairs <span class="free">x</span> <span class="main">(</span>in_traverse_pairs <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness results for deletion.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> tree_delete_sorted <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="free">t</span> <span class="main">⟹</span> tree_sorted <span class="main">(</span>tree_delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> tree_delete_map <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="free">t</span> <span class="main">⟹</span> tree_map <span class="main">(</span>tree_delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> delete_map <span class="free">x</span> <span class="main">(</span>tree_map <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Search on sorted trees›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tree_search</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>ord<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_search</span> Tip <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tree_search</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="free">tree_search</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>
   <span class="keyword1">else</span> <span class="free">tree_search</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> tree_search.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of search.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> tree_search_correct <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="free">t</span> <span class="main">⟹</span> tree_search <span class="free">t</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>tree_map <span class="free">t</span><span class="main">)</span><span class="main">⟨</span><span class="free">x</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Partial_Equiv_Rel">
<div class="head">
<h1>Theory Partial_Equiv_Rel</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Partial_Equiv_Rel.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Partial equivalence relation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Partial_Equiv_Rel
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Auto2_HOL/Auto2_Main.html">Auto2_HOL.Auto2_Main</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Partial equivalence relations, following theory
  Lib/Partial\_Equivalence\_Relation in \cite{Collections-AFP}.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">part_equiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">part_equiv</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟷</span> sym <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> trans <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>

<span class="keyword1" id="Partial_Equiv_Rel-part_equivI"><span class="command">lemma</span></span> part_equivI <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="free">R</span> <span class="main">⟹</span> trans <span class="free">R</span> <span class="main">⟹</span> part_equiv <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="Partial_Equiv_Rel-part_equivD1"><span class="command">lemma</span></span> part_equivD1 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"part_equiv <span class="free">R</span> <span class="main">⟹</span> sym <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="Partial_Equiv_Rel-part_equivD2"><span class="command">lemma</span></span> part_equivD2 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"part_equiv <span class="free">R</span> <span class="main">⟹</span> trans <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm_eqforward</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> part_equiv_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Combining two elements in a partial equivalence relation›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">per_union</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">per_union</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∪</span> <span class="main">{</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">}</span> <span class="main">∪</span> <span class="main">{</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Partial_Equiv_Rel-per_union_memI1"><span class="command">lemma</span></span> per_union_memI1 <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> per_union <span class="free">R</span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> per_union_def<span class="main">)</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> per_union_memI1<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"per_union ?R ?a ?b"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Partial_Equiv_Rel-per_union_memI2"><span class="command">lemma</span></span> per_union_memI2 <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> per_union <span class="free">R</span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> per_union_def<span class="main">)</span>

<span class="keyword1" id="Partial_Equiv_Rel-per_union_memI3"><span class="command">lemma</span></span> per_union_memI3 <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> per_union <span class="free">R</span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> per_union_def<span class="main">)</span>

<span class="keyword1" id="Partial_Equiv_Rel-per_union_memD"><span class="command">lemma</span></span> per_union_memD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> per_union <span class="free">R</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> per_union_def<span class="main">)</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> per_union_memD<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_cond</span> <span class="inner_quoted">"?x ≠ ?y"</span><span class="main">,</span> <span class="entity">with_filt</span> <span class="main">(</span><span class="entity">order_filter</span> <span class="inner_quoted">"x"</span> <span class="inner_quoted">"y"</span><span class="main">)</span><span class="main">]</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> per_union_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Partial_Equiv_Rel-per_union_is_trans"><span class="command">lemma</span></span> per_union_is_trans <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"trans <span class="free">R</span> <span class="main">⟹</span> trans <span class="main">(</span>per_union <span class="free">R</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Partial_Equiv_Rel-per_union_is_part_equiv"><span class="command">lemma</span></span> per_union_is_part_equiv <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"part_equiv <span class="free">R</span> <span class="main">⟹</span> part_equiv <span class="main">(</span>per_union <span class="free">R</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Union_Find">
<div class="head">
<h1>Theory Union_Find</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Union_Find.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Union find›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Union_Find
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Partial_Equiv_Rel.html">Partial_Equiv_Rel</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Development follows theory Union\_Find in \cite{Separation_Logic_Imperative_HOL-AFP}.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Representing a partial equivalence relation using rep\_of array›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>domintros<span class="main">)</span> <span class="entity">rep_of</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rep_of</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> <span class="free">rep_of</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"rep_of l i"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"i &lt; length l"</span><span class="main">]</span><span class="main">)</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_backward_prfstep</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> rep_of.domintros<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> rep_of.psimps<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_prop_induct_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> rep_of.pinduct<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ufa_invar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ufa_invar</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> rep_of_dom <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Union_Find-ufa_invarD"><span class="command">lemma</span></span> ufa_invarD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> rep_of_dom <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> ufa_invarD<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"?l ! ?i"</span><span class="main">]</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm_eqforward</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> ufa_invar_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Union_Find-rep_of_id"><span class="command">lemma</span></span> rep_of_id <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">i</span> <span class="main">⟹</span> rep_of <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Union_Find-rep_of_iff"><span class="command">lemma</span></span> rep_of_iff <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> rep_of <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">l</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span> <span class="free">i</span> <span class="keyword1">else</span> rep_of <span class="free">l</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> rep_of.psimps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Union_Find-rep_of_min"><span class="command">lemma</span></span> rep_of_min <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span>rep_of <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> rep_of <span class="free">l</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@prop_induct</span></span> <span class="quoted"><span class="quoted">"rep_of_dom <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Union_Find-rep_of_induct"><span class="command">lemma</span></span> rep_of_induct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">l</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="free">P</span> <span class="free">l</span> <span class="bound">i</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">l</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="free">P</span> <span class="free">l</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="free">l</span> <span class="bound">i</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">l</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@prop_induct</span></span> <span class="quoted"><span class="quoted">"rep_of_dom <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_prop_induct_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> rep_of_induct<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Union_Find-rep_of_bound"><span class="command">lemma</span></span> rep_of_bound <span class="main">[</span><span class="operator">forward_arg1</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> rep_of <span class="free">l</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@prop_induct</span></span> <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Union_Find-rep_of_idem"><span class="command">lemma</span></span> rep_of_idem <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> rep_of <span class="free">l</span> <span class="main">(</span>rep_of <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> rep_of <span class="free">l</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Union_Find-rep_of_idx"><span class="command">lemma</span></span> rep_of_idx <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> rep_of <span class="free">l</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> rep_of <span class="free">l</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ufa_α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ufa_α</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> rep_of <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">x</span> <span class="main">=</span> rep_of <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Union_Find-ufa_α_memI"><span class="command">lemma</span></span> ufa_α_memI <span class="main">[</span><span class="operator">backward</span><span class="main">,</span> <span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> rep_of <span class="free">l</span> <span class="free">x</span> <span class="main">=</span> rep_of <span class="free">l</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> ufa_α <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ufa_α_def<span class="main">)</span>
  
<span class="keyword1" id="Union_Find-ufa_α_memD"><span class="command">lemma</span></span> ufa_α_memD <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> ufa_α <span class="free">l</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> rep_of <span class="free">l</span> <span class="free">x</span> <span class="main">=</span> rep_of <span class="free">l</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ufa_α_def<span class="main">)</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> ufa_α_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Union_Find-ufa_α_equiv"><span class="command">lemma</span></span> ufa_α_equiv <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"part_equiv <span class="main">(</span>ufa_α <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Union_Find-ufa_α_refl"><span class="command">lemma</span></span> ufa_α_refl <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> ufa_α <span class="free">l</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operations on rep\_of array›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uf_init_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">uf_init_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> ufa_α <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1" id="Union_Find-ufa_init_invar"><span class="command">lemma</span></span> ufa_init_invar <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ufa_invar <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Union_Find-ufa_init_correct"><span class="command">lemma</span></span> ufa_init_correct <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> uf_init_rel <span class="free">n</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"ufa_invar <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ufa_union</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ufa_union</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">[</span>rep_of <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> rep_of <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1" id="Union_Find-ufa_union_invar"><span class="command">lemma</span></span> ufa_union_invar <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> <span class="free">l'</span> <span class="main">=</span> ufa_union <span class="free">l</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> ufa_invar <span class="free">l'</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">l'</span><span class="main">.</span> rep_of_dom <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="free">l'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">l'</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@prop_induct</span></span> <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Union_Find-ufa_union_aux"><span class="command">lemma</span></span> ufa_union_aux <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> <span class="free">l'</span> <span class="main">=</span> ufa_union <span class="free">l</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span>
   <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l'</span> <span class="main">⟹</span> rep_of <span class="free">l'</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> rep_of <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> rep_of <span class="free">l</span> <span class="free">x</span> <span class="keyword1">then</span> rep_of <span class="free">l</span> <span class="free">y</span> <span class="keyword1">else</span> rep_of <span class="free">l</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@prop_induct</span></span> <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of union operation.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> ufa_union_correct <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> <span class="free">l'</span> <span class="main">=</span> ufa_union <span class="free">l</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span>
   ufa_α <span class="free">l'</span> <span class="main">=</span> per_union <span class="main">(</span>ufa_α <span class="free">l</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> ufa_α <span class="free">l'</span> <span class="main">⟷</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> per_union <span class="main">(</span>ufa_α <span class="free">l</span><span class="main">)</span> <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> ufa_α <span class="free">l'</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"rep_of <span class="free">l</span> <span class="free">a</span> <span class="main">=</span> rep_of <span class="free">l</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"rep_of <span class="free">l</span> <span class="free">a</span> <span class="main">=</span> rep_of <span class="free">l</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ufa_compress</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ufa_compress</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> rep_of <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1" id="Union_Find-ufa_compress_invar"><span class="command">lemma</span></span> ufa_compress_invar <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> <span class="free">l'</span> <span class="main">=</span> ufa_compress <span class="free">l</span> <span class="free">x</span> <span class="main">⟹</span> ufa_invar <span class="free">l'</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">l'</span><span class="main">.</span> rep_of_dom <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="free">l'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">l'</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@prop_induct</span></span> <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Union_Find-ufa_compress_aux"><span class="command">lemma</span></span> ufa_compress_aux <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> <span class="free">l'</span> <span class="main">=</span> ufa_compress <span class="free">l</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l'</span> <span class="main">⟹</span>
   rep_of <span class="free">l'</span> <span class="free">i</span> <span class="main">=</span> rep_of <span class="free">l</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@prop_induct</span></span> <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of compress operation.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> ufa_compress_correct <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> ufa_α <span class="main">(</span>ufa_compress <span class="free">l</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> ufa_α <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> rep_of_iff<span class="antiquote">}</span></span></span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Connectivity">
<div class="head">
<h1>Theory Connectivity</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Connectivity.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Connectedness for a set of undirected edges.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Connectivity
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Union_Find.html">Union_Find</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A simple application of union-find for graph connectivity.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_path</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> nat list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_path</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">[]</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_path</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> hd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∨</span> <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free">is_path</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> is_path.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_path</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_path</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> is_path <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">p</span> <span class="main">∧</span> hd <span class="bound">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> last <span class="bound">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Connectivity-is_path_nonempty"><span class="command">lemma</span></span> is_path_nonempty <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_path <span class="free">n</span> <span class="free">S</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="Connectivity-nonempty_is_not_path"><span class="command">lemma</span></span> nonempty_is_not_path <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_path <span class="free">n</span> <span class="free">S</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Connectivity-is_path_extend"><span class="command">lemma</span></span> is_path_extend <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_path <span class="free">n</span> <span class="free">S</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span> <span class="main">⟹</span> is_path <span class="free">n</span> <span class="free">T</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">p</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Connectivity-has_path_extend"><span class="command">lemma</span></span> has_path_extend <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"has_path <span class="free">n</span> <span class="free">S</span> <span class="free">i</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span> <span class="main">⟹</span> has_path <span class="free">n</span> <span class="free">T</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">joinable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">joinable</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟷</span> <span class="main">(</span>last <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">path_join</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat list <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">path_join</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">@</span> tl <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"path_join p q"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"joinable p q"</span><span class="main">]</span><span class="main">)</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_prfstep_check_req</span> <span class="main">(</span><span class="inner_quoted">"path_join p q"</span><span class="main">,</span> <span class="inner_quoted">"joinable p q"</span><span class="main">)</span>›</span>

<span class="keyword1" id="Connectivity-path_join_hd"><span class="command">lemma</span></span> path_join_hd <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> hd <span class="main">(</span>path_join <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> hd <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Connectivity-path_join_last"><span class="command">lemma</span></span> path_join_last <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"joinable <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> last <span class="main">(</span>path_join <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> last <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> hd <span class="free">q</span> <span class="main">#</span> tl <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">q</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Connectivity-path_join_is_path"><span class="command">lemma</span></span> path_join_is_path <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"joinable <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span> is_path <span class="free">n</span> <span class="free">S</span> <span class="free">p</span> <span class="main">⟹</span> is_path <span class="free">n</span> <span class="free">S</span> <span class="free">q</span> <span class="main">⟹</span> is_path <span class="free">n</span> <span class="free">S</span> <span class="main">(</span>path_join <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">p</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Connectivity-has_path_trans"><span class="command">lemma</span></span> has_path_trans <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"has_path <span class="free">n</span> <span class="free">S</span> <span class="free">i</span> <span class="free">j</span> <span class="main">⟹</span> has_path <span class="free">n</span> <span class="free">S</span> <span class="free">j</span> <span class="free">k</span> <span class="main">⟹</span> has_path <span class="free">n</span> <span class="free">S</span> <span class="free">i</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"is_path <span class="free">n</span> <span class="free">S</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">p</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="free">p</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"is_path <span class="free">n</span> <span class="free">S</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">q</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="free">q</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_path <span class="free">n</span> <span class="free">S</span> <span class="main">(</span>path_join <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_valid_graph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_valid_graph</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> snd <span class="bound">p</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Connectivity-has_path_single1"><span class="command">lemma</span></span> has_path_single1 <span class="main">[</span><span class="operator">backward1</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_valid_graph <span class="free">n</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> has_path <span class="free">n</span> <span class="free">S</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_path <span class="free">n</span> <span class="free">S</span> <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Connectivity-has_path_single2"><span class="command">lemma</span></span> has_path_single2 <span class="main">[</span><span class="operator">backward1</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_valid_graph <span class="free">n</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> has_path <span class="free">n</span> <span class="free">S</span> <span class="free">b</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_path <span class="free">n</span> <span class="free">S</span> <span class="main">[</span><span class="free">b</span><span class="main">,</span> <span class="free">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Connectivity-has_path_refl"><span class="command">lemma</span></span> has_path_refl <span class="main">[</span><span class="operator">backward2</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_valid_graph <span class="free">n</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> has_path <span class="free">n</span> <span class="free">S</span> <span class="free">a</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_path <span class="free">n</span> <span class="free">S</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">connected_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">connected_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> has_path <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Connectivity-connected_rel_iff"><span class="command">lemma</span></span> connected_rel_iff <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> connected_rel <span class="free">n</span> <span class="free">S</span> <span class="main">⟷</span> has_path <span class="free">n</span> <span class="free">S</span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> connected_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Connectivity-connected_rel_trans"><span class="command">lemma</span></span> connected_rel_trans <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"trans <span class="main">(</span>connected_rel <span class="free">n</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Connectivity-connected_rel_refl"><span class="command">lemma</span></span> connected_rel_refl <span class="main">[</span><span class="operator">backward2</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_valid_graph <span class="free">n</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> connected_rel <span class="free">n</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Connectivity-is_path_per_union"><span class="command">lemma</span></span> is_path_per_union <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_valid_graph <span class="free">n</span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span>
   has_path <span class="free">n</span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> per_union <span class="main">(</span>connected_rel <span class="free">n</span> <span class="free">S</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> connected_rel <span class="free">n</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> <span class="free">S</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> per_union <span class="free">R</span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"has_path <span class="free">n</span> <span class="free">S'</span> <span class="free">i</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"has_path <span class="free">n</span> <span class="free">S'</span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"has_path <span class="free">n</span> <span class="free">S'</span> <span class="free">b</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">@end</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"has_path <span class="free">n</span> <span class="free">S'</span> <span class="free">i</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"has_path <span class="free">n</span> <span class="free">S'</span> <span class="free">b</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"has_path <span class="free">n</span> <span class="free">S'</span> <span class="free">a</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"has_path <span class="free">n</span> <span class="free">S'</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="main">(</span><span class="main">@rule</span><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> is_path <span class="free">n</span> <span class="free">S'</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="main">(</span>hd <span class="bound">p</span><span class="main">,</span> last <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> per_union <span class="free">R</span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">p</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> hd <span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> per_union <span class="free">R</span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="main">@with</span>
          <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_valid_graph <span class="free">n</span> <span class="free">S</span>"</span></span>
          <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> hd <span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S'</span>"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> hd <span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
          <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>hd <span class="free">xs</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S'</span>"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>hd <span class="free">xs</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
        <span class="keyword1"><span class="command">@end</span></span>
      <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
    <span class="keyword1"><span class="command">@end</span></span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"is_path <span class="free">n</span> <span class="free">S'</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">p</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="free">p</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Connectivity-connected_rel_union"><span class="command">lemma</span></span> connected_rel_union <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_valid_graph <span class="free">n</span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span>
   connected_rel <span class="free">n</span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> per_union <span class="main">(</span>connected_rel <span class="free">n</span> <span class="free">S</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Connectivity-connected_rel_init"><span class="command">lemma</span></span> connected_rel_init <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"connected_rel <span class="free">n</span> <span class="main">{}</span> <span class="main">=</span> uf_init_rel <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_valid_graph <span class="free">n</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> has_path <span class="free">n</span> <span class="main">{}</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">⟷</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> uf_init_rel <span class="free">n</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"has_path <span class="free">n</span> <span class="main">{}</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"is_path <span class="free">n</span> <span class="main">{}</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">p</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="free">p</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> hd <span class="free">p</span> <span class="main">#</span> tl <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">connected_rel_ind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">connected_rel_ind</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">0</span> <span class="main">=</span> uf_init_rel <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">connected_rel_ind</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">R</span> <span class="main">=</span> <span class="free">connected_rel_ind</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span> <span class="bound">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">in</span>
      per_union <span class="bound">R</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> connected_rel_ind.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Connectivity-connected_rel_ind_rule"><span class="command">lemma</span></span> connected_rel_ind_rule <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_valid_graph <span class="free">n</span> <span class="main">(</span>set <span class="free">es</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≤</span> length <span class="free">es</span> <span class="main">⟹</span>
   connected_rel_ind <span class="free">n</span> <span class="free">es</span> <span class="free">k</span> <span class="main">=</span> connected_rel <span class="free">n</span> <span class="main">(</span>set <span class="main">(</span>take <span class="free">k</span> <span class="free">es</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">k</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> Suc <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_valid_graph <span class="free">n</span> <span class="main">(</span>set <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="free">es</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of the functional algorithm.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> connected_rel_ind_compute <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_valid_graph <span class="free">n</span> <span class="main">(</span>set <span class="free">es</span><span class="main">)</span> <span class="main">⟹</span>
   connected_rel_ind <span class="free">n</span> <span class="free">es</span> <span class="main">(</span>length <span class="free">es</span><span class="main">)</span> <span class="main">=</span> connected_rel <span class="free">n</span> <span class="main">(</span>set <span class="free">es</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Arrays_Ex">
<div class="head">
<h1>Theory Arrays_Ex</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Arrays_Ex.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Arrays›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Arrays_Ex
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Auto2_HOL/Auto2_Main.html">Auto2_HOL.Auto2_Main</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic examples for arrays.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹List swap›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_swap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">list_swap</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"list_swap xs i j"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"i &lt; length xs"</span><span class="main">,</span> <span class="inner_quoted">"j &lt; length xs"</span><span class="main">]</span><span class="main">)</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_prfstep_check_req</span> <span class="main">(</span><span class="inner_quoted">"list_swap xs i j"</span><span class="main">,</span> <span class="inner_quoted">"i &lt; length xs ∧ j &lt; length xs"</span><span class="main">)</span>›</span>

<span class="keyword1" id="Arrays_Ex-list_swap_eval"><span class="command">lemma</span></span> list_swap_eval<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span>
   <span class="main">(</span>list_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">j</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="keyword1">else</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> list_swap_eval<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_cond</span> <span class="inner_quoted">"?k ≠ ?i"</span><span class="main">,</span> <span class="entity">with_cond</span> <span class="inner_quoted">"?k ≠ ?j"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Arrays_Ex-list_swap_eval_triv"><span class="command">lemma</span></span> list_swap_eval_triv <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span>list_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span>list_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Arrays_Ex-length_list_swap"><span class="command">lemma</span></span> length_list_swap <span class="main">[</span><span class="operator">rewrite_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>list_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Arrays_Ex-mset_list_swap"><span class="command">lemma</span></span> mset_list_swap <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> mset <span class="main">(</span>list_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Arrays_Ex-set_list_swap"><span class="command">lemma</span></span> set_list_swap <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> set <span class="main">(</span>list_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> list_swap_def<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule_back</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> list_swap_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reverse›</span></span>

<span class="keyword1" id="Arrays_Ex-rev_nth"><span class="command">lemma</span></span> rev_nth <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> rev <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rev_swap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rev_swap</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> <span class="free">rev_swap</span> <span class="main">(</span>list_swap <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"rev_swap xs i j"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"j &lt; length xs"</span><span class="main">]</span><span class="main">)</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_prfstep_check_req</span> <span class="main">(</span><span class="inner_quoted">"rev_swap xs i j"</span><span class="main">,</span> <span class="inner_quoted">"j &lt; length xs"</span><span class="main">)</span>›</span>

<span class="keyword1" id="Arrays_Ex-rev_swap_length"><span class="command">lemma</span></span> rev_swap_length <span class="main">[</span><span class="operator">rewrite_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> length <span class="main">(</span>rev_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"rev_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"rev_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Arrays_Ex-rev_swap_eval"><span class="command">lemma</span></span> rev_swap_eval <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span>rev_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">k</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">k</span> <span class="main">&gt;</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">k</span> <span class="keyword1">else</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"rev_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"rev_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> <span class="free">k</span> <span class="main">+</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Arrays_Ex-rev_swap_is_rev"><span class="command">lemma</span></span> rev_swap_is_rev <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟹</span> rev_swap <span class="free">xs</span> <span class="main">0</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> rev <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Copy one array to the beginning of another›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">array_copy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">array_copy</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">array_copy</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> list_update <span class="main">(</span><span class="free">array_copy</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> array_copy.simps<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"array_copy xs xs' n"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"n ≤ length xs"</span><span class="main">,</span> <span class="inner_quoted">"n ≤ length xs'"</span><span class="main">]</span><span class="main">)</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_prfstep_check_req</span> <span class="main">(</span><span class="inner_quoted">"array_copy xs xs' n"</span><span class="main">,</span> <span class="inner_quoted">"n ≤ length xs ∧ n ≤ length xs'"</span><span class="main">)</span>›</span>

<span class="keyword1" id="Arrays_Ex-array_copy_length"><span class="command">lemma</span></span> array_copy_length <span class="main">[</span><span class="operator">rewrite_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≤</span> length <span class="free">xs'</span> <span class="main">⟹</span> length <span class="main">(</span>array_copy <span class="free">xs</span> <span class="free">xs'</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs'</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Arrays_Ex-array_copy_ind"><span class="command">lemma</span></span> array_copy_ind <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≤</span> length <span class="free">xs'</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span>array_copy <span class="free">xs</span> <span class="free">xs'</span> <span class="free">n</span><span class="main">)</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Arrays_Ex-array_copy_correct"><span class="command">lemma</span></span> array_copy_correct <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≤</span> length <span class="free">xs'</span> <span class="main">⟹</span> take <span class="free">n</span> <span class="main">(</span>array_copy <span class="free">xs</span> <span class="free">xs'</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sublist›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sublist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">sublist</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> drop <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"sublist l r xs"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"l ≤ r"</span><span class="main">,</span> <span class="inner_quoted">"r ≤ length xs"</span><span class="main">]</span><span class="main">)</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_prfstep_check_req</span> <span class="main">(</span><span class="inner_quoted">"sublist l r xs"</span><span class="main">,</span> <span class="inner_quoted">"l ≤ r ∧ r ≤ length xs"</span><span class="main">)</span>›</span>

<span class="keyword1" id="Arrays_Ex-length_sublist"><span class="command">lemma</span></span> length_sublist <span class="main">[</span><span class="operator">rewrite_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> length <span class="main">(</span>sublist <span class="free">l</span> <span class="free">r</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="main">-</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Arrays_Ex-nth_sublist"><span class="command">lemma</span></span> nth_sublist <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs'</span> <span class="main">=</span> sublist <span class="free">l</span> <span class="free">r</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs'</span> <span class="main">⟹</span> <span class="free">xs'</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Arrays_Ex-sublist_nil"><span class="command">lemma</span></span> sublist_nil <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">⟹</span> sublist <span class="free">l</span> <span class="free">r</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Arrays_Ex-sublist_0"><span class="command">lemma</span></span> sublist_0 <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sublist <span class="main">0</span> <span class="free">l</span> <span class="free">xs</span> <span class="main">=</span> take <span class="free">l</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Arrays_Ex-sublist_drop"><span class="command">lemma</span></span> sublist_drop <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sublist <span class="free">l</span> <span class="free">r</span> <span class="main">(</span>drop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> sublist <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> sublist_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Arrays_Ex-sublist_single"><span class="command">lemma</span></span> sublist_single <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> sublist <span class="free">l</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="free">xs</span> <span class="main">!</span> <span class="free">l</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span><span class="free">xs</span> <span class="main">!</span> <span class="free">l</span><span class="main">]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Arrays_Ex-sublist_append"><span class="command">lemma</span></span> sublist_append <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> sublist <span class="free">l</span> <span class="free">m</span> <span class="free">xs</span> <span class="main">@</span> sublist <span class="free">m</span> <span class="free">r</span> <span class="free">xs</span> <span class="main">=</span> sublist <span class="free">l</span> <span class="free">r</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs1</span> <span class="main">=</span> sublist <span class="free">l</span> <span class="free">r</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs2</span> <span class="main">=</span> sublist <span class="free">l</span> <span class="free">m</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs3</span> <span class="main">=</span> sublist <span class="free">m</span> <span class="free">r</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">xs2</span> <span class="main">@</span> <span class="free">xs3</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">xs1</span><span class="main">.</span> <span class="free">xs1</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs2</span> <span class="main">@</span> <span class="free">xs3</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs2</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> length <span class="free">xs2</span> <span class="main">&lt;</span> length <span class="free">xs3</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Arrays_Ex-sublist_Cons"><span class="command">lemma</span></span> sublist_Cons <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">&lt;</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">l</span> <span class="main">#</span> sublist <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">r</span> <span class="free">xs</span> <span class="main">=</span> sublist <span class="free">l</span> <span class="free">r</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"sublist <span class="free">l</span> <span class="free">r</span> <span class="free">xs</span> <span class="main">=</span> sublist <span class="free">l</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span> <span class="main">@</span> sublist <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">r</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Arrays_Ex-sublist_equalityI"><span class="command">lemma</span></span> sublist_equalityI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟶</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟶</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">⟹</span> sublist <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span> <span class="main">=</span> sublist <span class="free">i</span> <span class="free">j</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_backward2_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> sublist_equalityI<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_filt</span> <span class="main">(</span><span class="entity">order_filter</span> <span class="inner_quoted">"xs"</span> <span class="inner_quoted">"ys"</span><span class="main">)</span><span class="main">]</span>›</span>

<span class="keyword1" id="Arrays_Ex-set_sublist"><span class="command">lemma</span></span> set_sublist <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>sublist <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="free">i</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">=</span> sublist <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> length <span class="free">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">!</span> <span class="free">l</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Arrays_Ex-list_take_sublist_drop_eq"><span class="command">lemma</span></span> list_take_sublist_drop_eq <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> take <span class="free">l</span> <span class="free">xs</span> <span class="main">@</span> sublist <span class="free">l</span> <span class="free">r</span> <span class="free">xs</span> <span class="main">@</span> drop <span class="free">r</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"take <span class="free">l</span> <span class="free">xs</span> <span class="main">=</span> sublist <span class="main">0</span> <span class="free">l</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">r</span> <span class="free">xs</span> <span class="main">=</span> sublist <span class="free">r</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Updating a set of elements in an array›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_update_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">list_update_set</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> list <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">i</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Arrays_Ex-list_update_set_length"><span class="command">lemma</span></span> list_update_set_length <span class="main">[</span><span class="operator">rewrite_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>list_update_set <span class="free">S</span> <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Arrays_Ex-list_update_set_nth"><span class="command">lemma</span></span> list_update_set_nth <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">=</span> list_update_set <span class="free">S</span> <span class="free">f</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs'</span> <span class="main">⟹</span> <span class="free">xs'</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">S</span> <span class="free">i</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="free">i</span> <span class="keyword1">else</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> list_update_set_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list_update_set_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_update_set_impl</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list_update_set_impl</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">xs'</span> <span class="main">=</span> <span class="free">list_update_set_impl</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="bound">xs'</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">]</span> <span class="keyword1">else</span> <span class="bound">xs'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> list_update_set_impl.simps<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"list_update_set_impl S f xs n"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"n ≤ length xs"</span><span class="main">]</span><span class="main">)</span>›</span>

<span class="keyword1" id="Arrays_Ex-list_update_set_impl_ind"><span class="command">lemma</span></span> list_update_set_impl_ind <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> list_update_set_impl <span class="free">S</span> <span class="free">f</span> <span class="free">xs</span> <span class="free">n</span> <span class="main">=</span>
   list <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free">S</span> <span class="bound">i</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Arrays_Ex-list_update_set_impl_correct"><span class="command">lemma</span></span> list_update_set_impl_correct <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_update_set_impl <span class="free">S</span> <span class="free">f</span> <span class="free">xs</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> list_update_set <span class="free">S</span> <span class="free">f</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Dijkstra">
<div class="head">
<h1>Theory Dijkstra</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Dijkstra.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Dijkstra's algorithm for shortest paths›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Dijkstra
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Mapping_Str.html">Mapping_Str</a> <a href="Arrays_Ex.html">Arrays_Ex</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Verification of Dijkstra's algorithm: function part.

  The algorithm is also verified by Nordhoff and Lammich in
  \cite{Dijkstra_Shortest_Path-AFP}.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Graphs›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> graph <span class="main">=</span> Graph <span class="quoted"><span class="quoted">"nat list list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">size</span> <span class="main">(</span>Graph <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">G</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">weight</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">weight</span> <span class="main">(</span>Graph <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">valid_graph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_graph</span> <span class="main">(</span>Graph <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">.</span> length <span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> valid_graph.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Paths on graphs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of vertices less than n.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">verts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">verts</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> size <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Dijkstra-verts_mem"><span class="command">lemma</span></span> verts_mem <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">&lt;</span> size <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> verts_def<span class="main">)</span>
<span class="keyword1" id="Dijkstra-card_verts"><span class="command">lemma</span></span> card_verts <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>verts <span class="free">G</span><span class="main">)</span> <span class="main">=</span> size <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> verts_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Dijkstra-finite_verts"><span class="command">lemma</span></span> finite_verts <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>verts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> verts_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_path</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_path</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> set <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⊆</span> verts <span class="free"><span class="bound"><span class="entity">G</span></span></span>"</span></span>

<span class="keyword1" id="Dijkstra-is_path_to_in_verts"><span class="command">lemma</span></span> is_path_to_in_verts <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_path <span class="free">G</span> <span class="free">p</span> <span class="main">⟹</span> hd <span class="free">p</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">∧</span> last <span class="free">p</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"last <span class="free">p</span> <span class="main">∈</span> set <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">joinable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat list <span class="main">⇒</span> nat list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">joinable</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟷</span> <span class="main">(</span>is_path <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> is_path <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∧</span> last <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">path_join</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat list <span class="main">⇒</span> nat list <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">path_join</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">@</span> tl <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"path_join G p q"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"joinable G p q"</span><span class="main">]</span><span class="main">)</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_prfstep_check_req</span> <span class="main">(</span><span class="inner_quoted">"path_join G p q"</span><span class="main">,</span> <span class="inner_quoted">"joinable G p q"</span><span class="main">)</span>›</span>

<span class="keyword1" id="Dijkstra-path_join_is_path"><span class="command">lemma</span></span> path_join_is_path<span class="main">:</span>
  <span class="quoted"><span class="quoted">"joinable <span class="free">G</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span> is_path <span class="free">G</span> <span class="main">(</span>path_join <span class="free">G</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> hd <span class="free">q</span> <span class="main">#</span> tl <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> path_join_is_path<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"path_join ?G ?p ?q"</span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">path_weight</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">path_weight</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">path_weight</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> weight <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="free">path_weight</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> path_weight.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Dijkstra-path_weight_singleton"><span class="command">lemma</span></span> path_weight_singleton <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"path_weight <span class="free">G</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="Dijkstra-path_weight_doubleton"><span class="command">lemma</span></span> path_weight_doubleton <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"path_weight <span class="free">G</span> <span class="main">[</span><span class="free">m</span><span class="main">,</span> <span class="free">n</span><span class="main">]</span> <span class="main">=</span> weight <span class="free">G</span> <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Dijkstra-path_weight_sum"><span class="command">lemma</span></span> path_weight_sum <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"joinable <span class="free">G</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span> path_weight <span class="free">G</span> <span class="main">(</span>path_join <span class="free">G</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> path_weight <span class="free">G</span> <span class="free">p</span> <span class="main">+</span> path_weight <span class="free">G</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">p</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">path_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">path_set</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> is_path <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">p</span> <span class="main">∧</span> hd <span class="bound">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> last <span class="bound">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Dijkstra-path_set_mem"><span class="command">lemma</span></span> path_set_mem <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> path_set <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="main">⟷</span> is_path <span class="free">G</span> <span class="free">p</span> <span class="main">∧</span> hd <span class="free">p</span> <span class="main">=</span> <span class="free">m</span> <span class="main">∧</span> last <span class="free">p</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Dijkstra-path_join_set"><span class="command">lemma</span></span> path_join_set<span class="main">:</span> <span class="quoted"><span class="quoted">"joinable <span class="free">G</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span> path_join <span class="free">G</span> <span class="free">p</span> <span class="free">q</span> <span class="main">∈</span> path_set <span class="free">G</span> <span class="main">(</span>hd <span class="free">p</span><span class="main">)</span> <span class="main">(</span>last <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> hd <span class="free">q</span> <span class="main">#</span> tl <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">q</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> path_join_set<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"path_join ?G ?p ?q"</span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Shortest paths›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_shortest_path</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_shortest_path</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟷</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> path_set <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p'</span><span class="main">∈</span>path_set <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> path_weight <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">p'</span> <span class="main">≥</span> path_weight <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Dijkstra-is_shortest_pathD1"><span class="command">lemma</span></span> is_shortest_pathD1 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_shortest_path <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> path_set <span class="free">G</span> <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Dijkstra-is_shortest_pathD2"><span class="command">lemma</span></span> is_shortest_pathD2 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_shortest_path <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">p'</span> <span class="main">∈</span> path_set <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> path_weight <span class="free">G</span> <span class="free">p'</span> <span class="main">≥</span> path_weight <span class="free">G</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm_eqforward</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> is_shortest_path_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_dist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_dist</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> is_shortest_path <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Dijkstra-has_distI"><span class="command">lemma</span></span> has_distI <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_shortest_path <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">p</span> <span class="main">⟹</span> has_dist <span class="free">G</span> <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="Dijkstra-has_distD"><span class="command">lemma</span></span> has_distD <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"has_dist <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> is_shortest_path <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="Dijkstra-has_dist_to_in_verts"><span class="command">lemma</span></span> has_dist_to_in_verts <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"has_dist <span class="free">G</span> <span class="free">u</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> has_dist_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">dist</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> path_weight <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">p</span><span class="main">.</span> is_shortest_path <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"dist G m n"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"has_dist G m n"</span><span class="main">]</span><span class="main">)</span>›</span>

<span class="keyword1" id="Dijkstra-dist_eq"><span class="command">lemma</span></span> dist_eq <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_shortest_path <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">p</span> <span class="main">⟹</span> dist <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="main">=</span> path_weight <span class="free">G</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Dijkstra-distD"><span class="command">lemma</span></span> distD <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"has_dist <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> path_set <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> path_weight <span class="free">G</span> <span class="free">p</span> <span class="main">≥</span> dist <span class="free">G</span> <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> dist_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Dijkstra-shortest_init"><span class="command">lemma</span></span> shortest_init <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">⟹</span> is_shortest_path <span class="free">G</span> <span class="free">n</span> <span class="free">n</span> <span class="main">[</span><span class="free">n</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Interior points›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹List of interior points›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">int_pts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">int_pts</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> set <span class="main">(</span>butlast <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Dijkstra-int_pts_singleton"><span class="command">lemma</span></span> int_pts_singleton <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"int_pts <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="Dijkstra-int_pts_doubleton"><span class="command">lemma</span></span> int_pts_doubleton <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"int_pts <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">path_set_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat set <span class="main">⇒</span> nat list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">path_set_on</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> path_set <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> int_pts <span class="bound">p</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Dijkstra-path_set_on_mem"><span class="command">lemma</span></span> path_set_on_mem <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> path_set_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">V</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">∈</span> path_set <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="main">∧</span> int_pts <span class="free">p</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_set_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Version of shortest path on a set of points›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_shortest_path_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list <span class="main">⇒</span> nat set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_shortest_path_on</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟷</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> path_set_on <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p'</span><span class="main">∈</span>path_set_on <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">.</span> path_weight <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">p'</span> <span class="main">≥</span> path_weight <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Dijkstra-is_shortest_path_onD1"><span class="command">lemma</span></span> is_shortest_path_onD1 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_shortest_path_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">p</span> <span class="free">V</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> path_set_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Dijkstra-is_shortest_path_onD2"><span class="command">lemma</span></span> is_shortest_path_onD2 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_shortest_path_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">p</span> <span class="free">V</span> <span class="main">⟹</span> <span class="free">p'</span> <span class="main">∈</span> path_set_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">V</span> <span class="main">⟹</span> path_weight <span class="free">G</span> <span class="free">p'</span> <span class="main">≥</span> path_weight <span class="free">G</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm_eqforward</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> is_shortest_path_on_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_dist_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_dist_on</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> is_shortest_path_on <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Dijkstra-has_dist_onI"><span class="command">lemma</span></span> has_dist_onI <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_shortest_path_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">p</span> <span class="free">V</span> <span class="main">⟹</span> has_dist_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="Dijkstra-has_dist_onD"><span class="command">lemma</span></span> has_dist_onD <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"has_dist_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">V</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> is_shortest_path_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="bound">p</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> has_dist_on_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dist_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat set <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">dist_on</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">=</span> path_weight <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">p</span><span class="main">.</span> is_shortest_path_on <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"dist_on G m n V"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"has_dist_on G m n V"</span><span class="main">]</span><span class="main">)</span>›</span>

<span class="keyword1" id="Dijkstra-dist_on_eq"><span class="command">lemma</span></span> dist_on_eq <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_shortest_path_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">p</span> <span class="free">V</span> <span class="main">⟹</span> dist_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">V</span> <span class="main">=</span> path_weight <span class="free">G</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Dijkstra-dist_onD"><span class="command">lemma</span></span> dist_onD <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"has_dist_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">V</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> path_set_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">V</span> <span class="main">⟹</span> path_weight <span class="free">G</span> <span class="free">p</span> <span class="main">≥</span> dist_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> dist_on_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Two splitting lemmas›</span></span>

<span class="keyword1" id="Dijkstra-path_split1"><span class="command">lemma</span></span> path_split1 <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_path <span class="free">G</span> <span class="free">p</span> <span class="main">⟹</span> hd <span class="free">p</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">⟹</span> last <span class="free">p</span> <span class="main">∉</span> <span class="free">V</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">p1</span> <span class="bound">p2</span><span class="main">.</span> joinable <span class="free">G</span> <span class="bound">p1</span> <span class="bound">p2</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">=</span> path_join <span class="free">G</span> <span class="bound">p1</span> <span class="bound">p2</span> <span class="main">∧</span> int_pts <span class="bound">p1</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">∧</span> hd <span class="bound">p2</span> <span class="main">∉</span> <span class="free">V</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">p</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">a</span> <span class="main">#</span> <span class="free">p'</span>"</span></span>
    <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">a</span> <span class="main">#</span> <span class="free">p'</span>"</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">p'</span> <span class="main">∉</span> <span class="free">V</span>"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> path_join <span class="free">G</span> <span class="main">[</span><span class="free">a</span><span class="main">,</span> hd <span class="free">p'</span><span class="main">]</span> <span class="free">p'</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">p1</span></span> <span class="quoted"><span class="free">p2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"joinable <span class="free">G</span> <span class="free">p1</span> <span class="free">p2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> path_join <span class="free">G</span> <span class="free">p1</span> <span class="free">p2</span>"</span></span> <span class="quoted"><span class="quoted">"int_pts <span class="free">p1</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">p2</span> <span class="main">∉</span> <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> path_join <span class="free">G</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">p1</span><span class="main">)</span> <span class="free">p2</span>"</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Dijkstra-path_split2"><span class="command">lemma</span></span> path_split2 <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_path <span class="free">G</span> <span class="free">p</span> <span class="main">⟹</span> hd <span class="free">p</span> <span class="main">≠</span> last <span class="free">p</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> joinable <span class="free">G</span> <span class="bound">q</span> <span class="main">[</span><span class="bound">n</span><span class="main">,</span> last <span class="free">p</span><span class="main">]</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">=</span> path_join <span class="free">G</span> <span class="bound">q</span> <span class="main">[</span><span class="bound">n</span><span class="main">,</span> last <span class="free">p</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> butlast <span class="free">p</span> <span class="main">@</span> <span class="main">[</span>last <span class="free">p</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"butlast <span class="free">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> last <span class="main">(</span>butlast <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> path_join <span class="free">G</span> <span class="main">(</span>butlast <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="free">n</span><span class="main">,</span> last <span class="free">p</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Deriving has\_dist and has\_dist\_on›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">known_dists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">known_dists</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⊆</span> verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∧</span> <span class="main">0</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">.</span> has_dist_on <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">0</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">.</span> has_dist <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">0</span> <span class="bound">i</span> <span class="main">∧</span> dist <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">0</span> <span class="bound">i</span> <span class="main">=</span> dist_on <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">0</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Dijkstra-derive_dist"><span class="command">lemma</span></span> derive_dist <span class="main">[</span><span class="operator">backward2</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"known_dists <span class="free">G</span> <span class="free">V</span> <span class="main">⟹</span>
   <span class="free">m</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">-</span> <span class="free">V</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>verts <span class="free">G</span> <span class="main">-</span> <span class="free">V</span><span class="main">.</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span> <span class="free">V</span> <span class="main">≥</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">V</span> <span class="main">⟹</span>
   has_dist <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="main">∧</span> dist <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="main">=</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">V</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"is_shortest_path_on <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">p</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_shortest_path <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">p</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> path_set <span class="free">G</span> <span class="main">0</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p'</span><span class="main">∈</span>path_set <span class="free">G</span> <span class="main">0</span> <span class="free">m</span><span class="main">.</span> path_weight <span class="free">G</span> <span class="bound">p'</span> <span class="main">≥</span> path_weight <span class="free">G</span> <span class="free">p</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">p1</span></span> <span class="quoted"><span class="free">p2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"joinable <span class="free">G</span> <span class="free">p1</span> <span class="free">p2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> path_join <span class="free">G</span> <span class="free">p1</span> <span class="free">p2</span>"</span></span>
                          <span class="quoted"><span class="quoted">"int_pts <span class="free">p1</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">p2</span> <span class="main">∉</span> <span class="free">V</span>"</span></span>
      <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> last <span class="free">p1</span>"</span></span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">x</span> <span class="free">V</span> <span class="main">≥</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">V</span>"</span></span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">∈</span> path_set_on <span class="free">G</span> <span class="main">0</span> <span class="free">x</span> <span class="free">V</span>"</span></span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"path_weight <span class="free">G</span> <span class="free">p1</span> <span class="main">≥</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">x</span> <span class="free">V</span>"</span></span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"path_weight <span class="free">G</span> <span class="free">p'</span> <span class="main">≥</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">V</span> <span class="main">+</span> path_weight <span class="free">G</span> <span class="free">p2</span>"</span></span>
    <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Dijkstra-join_def'"><span class="command">lemma</span></span> join_def' <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"joinable <span class="free">G</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span> path_join <span class="free">G</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> butlast <span class="free">p</span> <span class="main">@</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> butlast <span class="free">p</span> <span class="main">@</span> <span class="main">[</span>last <span class="free">p</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"path_join <span class="free">G</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> butlast <span class="free">p</span> <span class="main">@</span> <span class="main">[</span>last <span class="free">p</span><span class="main">]</span> <span class="main">@</span> tl <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Dijkstra-int_pts_join"><span class="command">lemma</span></span> int_pts_join <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"joinable <span class="free">G</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span> int_pts <span class="main">(</span>path_join <span class="free">G</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> int_pts <span class="free">p</span> <span class="main">∪</span> int_pts <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"path_join <span class="free">G</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> butlast <span class="free">p</span> <span class="main">@</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Dijkstra-dist_on_triangle_ineq"><span class="command">lemma</span></span> dist_on_triangle_ineq <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"has_dist_on <span class="free">G</span> <span class="free">k</span> <span class="free">m</span> <span class="free">V</span> <span class="main">⟹</span> has_dist_on <span class="free">G</span> <span class="free">k</span> <span class="free">n</span> <span class="free">V</span> <span class="main">⟹</span> <span class="free">V</span> <span class="main">⊆</span> verts <span class="free">G</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">⟹</span>
   dist_on <span class="free">G</span> <span class="free">k</span> <span class="free">m</span> <span class="free">V</span> <span class="main">+</span> weight <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="main">≥</span> dist_on <span class="free">G</span> <span class="free">k</span> <span class="free">n</span> <span class="free">V</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"is_shortest_path_on <span class="free">G</span> <span class="free">k</span> <span class="free">m</span> <span class="free">p</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">pq</span> <span class="main">=</span> path_join <span class="free">G</span> <span class="free">p</span> <span class="main">[</span><span class="free">m</span><span class="main">,</span> <span class="free">n</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span> <span class="main">=</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">pq</span> <span class="main">∈</span> path_set_on <span class="free">G</span> <span class="free">k</span> <span class="free">n</span> <span class="free">V</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Dijkstra-derive_dist_on"><span class="command">lemma</span></span> derive_dist_on <span class="main">[</span><span class="operator">backward2</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"known_dists <span class="free">G</span> <span class="free">V</span> <span class="main">⟹</span>
   <span class="free">m</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">-</span> <span class="free">V</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>verts <span class="free">G</span> <span class="main">-</span> <span class="free">V</span><span class="main">.</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span> <span class="free">V</span> <span class="main">≥</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">V</span> <span class="main">⟹</span>
   <span class="free">V'</span> <span class="main">=</span> <span class="free">V</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span> <span class="main">⟹</span>
   <span class="free">n</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">-</span> <span class="free">V'</span> <span class="main">⟹</span>
   has_dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">n</span> <span class="free">V'</span> <span class="main">∧</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">n</span> <span class="free">V'</span> <span class="main">=</span> min <span class="main">(</span>dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">n</span> <span class="free">V</span><span class="main">)</span> <span class="main">(</span>dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">V</span> <span class="main">+</span> weight <span class="free">G</span> <span class="free">m</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"has_dist <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="main">∧</span> dist <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="main">=</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> min <span class="main">(</span>dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">n</span> <span class="free">V</span><span class="main">)</span> <span class="main">(</span>dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">V</span> <span class="main">+</span> weight <span class="free">G</span> <span class="free">m</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>path_set_on <span class="free">G</span> <span class="main">0</span> <span class="free">n</span> <span class="free">V'</span><span class="main">.</span> path_weight <span class="free">G</span> <span class="bound">p</span> <span class="main">≥</span> <span class="free">M</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"joinable <span class="free">G</span> <span class="free">q</span> <span class="main">[</span><span class="free">n'</span><span class="main">,</span> <span class="free">n</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> path_join <span class="free">G</span> <span class="free">q</span> <span class="main">[</span><span class="free">n'</span><span class="main">,</span> <span class="free">n</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> path_set <span class="free">G</span> <span class="main">0</span> <span class="free">n'</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n'</span> <span class="main">∈</span> <span class="free">V'</span>"</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">n'</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">n'</span> <span class="free">V</span> <span class="main">=</span> dist <span class="free">G</span> <span class="main">0</span> <span class="free">n'</span>"</span></span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"path_weight <span class="free">G</span> <span class="free">q</span> <span class="main">≥</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">n'</span> <span class="free">V</span>"</span></span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"path_weight <span class="free">G</span> <span class="free">p</span> <span class="main">≥</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">n'</span> <span class="free">V</span> <span class="main">+</span> weight <span class="free">G</span> <span class="free">n'</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">n'</span> <span class="free">V</span> <span class="main">+</span> weight <span class="free">G</span> <span class="free">n'</span> <span class="free">n</span> <span class="main">≥</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">n</span> <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">@end</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n'</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"path_weight <span class="free">G</span> <span class="free">q</span> <span class="main">≥</span> dist <span class="free">G</span> <span class="main">0</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"path_weight <span class="free">G</span> <span class="free">p</span> <span class="main">≥</span> dist <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="main">+</span> weight <span class="free">G</span> <span class="free">m</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">V</span> <span class="main">+</span> weight <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="main">≥</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">n</span> <span class="free">V</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"is_shortest_path_on <span class="free">G</span> <span class="main">0</span> <span class="free">n</span> <span class="free">p</span> <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_shortest_path_on <span class="free">G</span> <span class="main">0</span> <span class="free">n</span> <span class="free">p</span> <span class="free">V'</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> path_set_on <span class="free">G</span> <span class="main">0</span> <span class="free">n</span> <span class="free">V'</span>"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="free">V'</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
    <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">V</span> <span class="main">+</span> weight <span class="free">G</span> <span class="free">m</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">pm</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"is_shortest_path_on <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">pm</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"path_weight <span class="free">G</span> <span class="free">pm</span> <span class="main">=</span> dist <span class="free">G</span> <span class="main">0</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> path_join <span class="free">G</span> <span class="free">pm</span> <span class="main">[</span><span class="free">m</span><span class="main">,</span> <span class="free">n</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"joinable <span class="free">G</span> <span class="free">pm</span> <span class="main">[</span><span class="free">m</span><span class="main">,</span> <span class="free">n</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"path_weight <span class="free">G</span> <span class="free">p</span> <span class="main">=</span> path_weight <span class="free">G</span> <span class="free">pm</span> <span class="main">+</span> weight <span class="free">G</span> <span class="free">m</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_shortest_path_on <span class="free">G</span> <span class="main">0</span> <span class="free">n</span> <span class="free">p</span> <span class="free">V'</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant for the Dijkstra's algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The state consists of an array maintaining the best estimates,
  and a heap containing estimates for the unknown vertices.›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> state <span class="main">=</span> State <span class="main">(</span><span class="free"><span class="entity">est</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"nat list"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">heap</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat<span class="main">,</span> nat<span class="main">)</span> map"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_simple_datatype</span> <span class="inner_quoted">"state"</span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unknown_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">unknown_set</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> keys_of <span class="main">(</span>heap <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">known_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">known_set</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">{..&lt;</span>length <span class="main">(</span>est <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> unknown_set <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariant: for every vertex, the estimate is at least the shortest distance.
  Furthermore, for the known vertices the estimate is exact.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">V</span> <span class="main">=</span> known_set <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">;</span> <span class="bound">W</span> <span class="main">=</span> unknown_set <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">;</span> <span class="bound">M</span> <span class="main">=</span> heap <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">in</span>
      <span class="main">(</span>length <span class="main">(</span>est <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">=</span> size <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∧</span> known_dists <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">V</span> <span class="main">∧</span>
      keys_of <span class="bound">M</span> <span class="main">⊆</span> verts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="bound">W</span><span class="main">.</span> <span class="bound">M</span><span class="main">⟨</span><span class="bound">i</span><span class="main">⟩</span> <span class="main">=</span> Some <span class="main">(</span>est <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="bound">V</span><span class="main">.</span> est <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> dist <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">0</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>verts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">.</span> est <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> dist_on <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">0</span> <span class="bound">i</span> <span class="bound">V</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Dijkstra-invE1"><span class="command">lemma</span></span> invE1 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="free">G</span> <span class="free">S</span> <span class="main">⟹</span> length <span class="main">(</span>est <span class="free">S</span><span class="main">)</span> <span class="main">=</span> size <span class="free">G</span> <span class="main">∧</span> known_dists <span class="free">G</span> <span class="main">(</span>known_set <span class="free">S</span><span class="main">)</span> <span class="main">∧</span> unknown_set <span class="free">S</span> <span class="main">⊆</span> verts <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="Dijkstra-invE2"><span class="command">lemma</span></span> invE2 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="free">G</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> known_set <span class="free">S</span> <span class="main">⟹</span> est <span class="free">S</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> dist <span class="free">G</span> <span class="main">0</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="Dijkstra-invE3"><span class="command">lemma</span></span> invE3 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="free">G</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> verts <span class="free">G</span> <span class="main">⟹</span> est <span class="free">S</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">i</span> <span class="main">(</span>known_set <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="Dijkstra-invE4"><span class="command">lemma</span></span> invE4 <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="free">G</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> unknown_set <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span>heap <span class="free">S</span><span class="main">)</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span> <span class="main">=</span> Some <span class="main">(</span>est <span class="free">S</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm_str</span> <span class="inner_quoted">"@eqforward"</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> inv_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Dijkstra-inv_unknown_set"><span class="command">lemma</span></span> inv_unknown_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inv <span class="free">G</span> <span class="free">S</span> <span class="main">⟹</span> unknown_set <span class="free">S</span> <span class="main">=</span> verts <span class="free">G</span> <span class="main">-</span> known_set <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Dijkstra-dijkstra_end_inv"><span class="command">lemma</span></span> dijkstra_end_inv <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inv <span class="free">G</span> <span class="free">S</span> <span class="main">⟹</span> unknown_set <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>verts <span class="free">G</span><span class="main">.</span> has_dist <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span> <span class="main">∧</span> est <span class="free">S</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> dist <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Starting state›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dijkstra_start_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">dijkstra_start_state</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span>
     State <span class="main">(</span>list <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> weight <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">0</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span>map_constr <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> weight <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">0</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"dijkstra_start_state G"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"size G &gt; 0"</span><span class="main">]</span><span class="main">)</span>›</span>

<span class="keyword1" id="Dijkstra-dijkstra_start_known_set"><span class="command">lemma</span></span> dijkstra_start_known_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size <span class="free">G</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> known_set <span class="main">(</span>dijkstra_start_state <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
    
<span class="keyword1" id="Dijkstra-dijkstra_start_unknown_set"><span class="command">lemma</span></span> dijkstra_start_unknown_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size <span class="free">G</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> unknown_set <span class="main">(</span>dijkstra_start_state <span class="free">G</span><span class="main">)</span> <span class="main">=</span> verts <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Dijkstra-card_start_state"><span class="command">lemma</span></span> card_start_state <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size <span class="free">G</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> card <span class="main">(</span>unknown_set <span class="main">(</span>dijkstra_start_state <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> size <span class="free">G</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> verts <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Starting start of Dijkstra's algorithm satisfies the invariant.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> dijkstra_start_inv <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size <span class="free">G</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> inv <span class="free">G</span> <span class="main">(</span>dijkstra_start_state <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">::</span>nat<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"has_dist <span class="free">G</span> <span class="main">0</span> <span class="main">0</span> <span class="main">∧</span> dist <span class="free">G</span> <span class="main">0</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_shortest_path <span class="free">G</span> <span class="main">0</span> <span class="main">0</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"has_dist_on <span class="free">G</span> <span class="main">0</span> <span class="main">0</span> <span class="free">V</span> <span class="main">∧</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="main">0</span> <span class="free">V</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_shortest_path_on <span class="free">G</span> <span class="main">0</span> <span class="main">0</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> verts <span class="free">G</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="main">(</span><span class="main">@rule</span><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>verts <span class="free">G</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> has_dist_on <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span> <span class="free">V</span> <span class="main">∧</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span> <span class="free">V</span> <span class="main">=</span> weight <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="free">i</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_shortest_path_on <span class="free">G</span> <span class="main">0</span> <span class="free">i</span> <span class="free">p</span> <span class="free">V</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> path_set_on <span class="free">G</span> <span class="main">0</span> <span class="free">i</span> <span class="free">V</span>"</span></span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p'</span><span class="main">∈</span>path_set_on <span class="free">G</span> <span class="main">0</span> <span class="free">i</span> <span class="free">V</span><span class="main">.</span> path_weight <span class="free">G</span> <span class="bound">p'</span> <span class="main">≥</span> weight <span class="free">G</span> <span class="main">0</span> <span class="free">i</span>"</span></span> <span class="main">@with</span>
        <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"joinable <span class="free">G</span> <span class="free">q</span> <span class="main">[</span><span class="free">n</span><span class="main">,</span> last <span class="free">p'</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> path_join <span class="free">G</span> <span class="free">q</span> <span class="main">[</span><span class="free">n</span><span class="main">,</span> last <span class="free">p'</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"path_weight <span class="free">G</span> <span class="free">p'</span> <span class="main">=</span> path_weight <span class="free">G</span> <span class="free">q</span> <span class="main">+</span> weight <span class="free">G</span> <span class="main">0</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">@end</span></span>
    <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Step of Dijkstra's algorithm›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dijkstra_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dijkstra_step</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">M'</span> <span class="main">=</span> delete_map <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
         <span class="bound">e'</span> <span class="main">=</span> list_update_set <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> keys_of <span class="bound">M'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> min <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> weight <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">;</span>
         <span class="bound">M''</span> <span class="main">=</span> map_update_all <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">e'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">M'</span>
     <span class="keyword1">in</span> State <span class="bound">e'</span> <span class="bound">M''</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> dijkstra_step.simps<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"dijkstra_step G m S"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"inv G S"</span><span class="main">,</span> <span class="inner_quoted">"m ∈ unknown_set S"</span><span class="main">]</span><span class="main">)</span>›</span>

<span class="keyword1" id="Dijkstra-has_dist_on_larger"><span class="command">lemma</span></span> has_dist_on_larger <span class="main">[</span><span class="operator">backward1</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"has_dist <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> has_dist_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">V</span> <span class="main">⟹</span> dist_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">V</span> <span class="main">=</span> dist <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span>
   has_dist_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> dist_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> dist <span class="free">G</span> <span class="free">m</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"is_shortest_path_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">p</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">V'</span> <span class="main">=</span> <span class="free">V</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> path_set_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">V'</span>"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="free">V'</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_shortest_path_on <span class="free">G</span> <span class="free">m</span> <span class="free">n</span> <span class="free">p</span> <span class="free">V'</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Dijkstra-dijkstra_step_unknown_set"><span class="command">lemma</span></span> dijkstra_step_unknown_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inv <span class="free">G</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> unknown_set <span class="free">S</span> <span class="main">⟹</span> unknown_set <span class="main">(</span>dijkstra_step <span class="free">G</span> <span class="free">m</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> unknown_set <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Dijkstra-dijkstra_step_known_set"><span class="command">lemma</span></span> dijkstra_step_known_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inv <span class="free">G</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> unknown_set <span class="free">S</span> <span class="main">⟹</span> known_set <span class="main">(</span>dijkstra_step <span class="free">G</span> <span class="free">m</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> known_set <span class="free">S</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹One step of Dijkstra's algorithm preserves the invariant.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> dijkstra_step_preserves_inv <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inv <span class="free">G</span> <span class="free">S</span> <span class="main">⟹</span> is_heap_min <span class="free">m</span> <span class="main">(</span>heap <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> inv <span class="free">G</span> <span class="main">(</span>dijkstra_step <span class="free">G</span> <span class="free">m</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> known_set <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V'</span> <span class="main">=</span> <span class="free">V</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="main">(</span><span class="main">@rule</span><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">V</span><span class="main">.</span> has_dist <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span> <span class="main">∧</span> has_dist_on <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span> <span class="free">V'</span> <span class="main">∧</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span> <span class="free">V'</span> <span class="main">=</span> dist <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"has_dist <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="main">∧</span> dist <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="main">=</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"has_dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">V'</span> <span class="main">∧</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">V'</span> <span class="main">=</span> dist <span class="free">G</span> <span class="main">0</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="main">(</span><span class="main">@rule</span><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>verts <span class="free">G</span> <span class="main">-</span> <span class="free">V'</span><span class="main">.</span> has_dist_on <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span> <span class="free">V'</span> <span class="main">∧</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span> <span class="free">V'</span> <span class="main">=</span> min <span class="main">(</span>dist_on <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span> <span class="free">V</span><span class="main">)</span> <span class="main">(</span>dist_on <span class="free">G</span> <span class="main">0</span> <span class="free">m</span> <span class="free">V</span> <span class="main">+</span> weight <span class="free">G</span> <span class="free">m</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">=</span> dijkstra_step <span class="free">G</span> <span class="free">m</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"known_dists <span class="free">G</span> <span class="free">V'</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">V'</span><span class="main">.</span> est <span class="free">S'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> dist <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>verts <span class="free">G</span><span class="main">.</span> est <span class="free">S'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> dist_on <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span> <span class="free">V'</span>"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">V'</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_dijkstra_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> state <span class="main">⇒</span> state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_dijkstra_step</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> is_heap_min <span class="bound">m</span> <span class="main">(</span>heap <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span> <span class="main">=</span> dijkstra_step <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Dijkstra-is_dijkstra_stepI"><span class="command">lemma</span></span> is_dijkstra_stepI <span class="main">[</span><span class="operator">backward2</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_heap_min <span class="free">m</span> <span class="main">(</span>heap <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> dijkstra_step <span class="free">G</span> <span class="free">m</span> <span class="free">S</span> <span class="main">=</span> <span class="free">S'</span> <span class="main">⟹</span> is_dijkstra_step <span class="free">G</span> <span class="free">S</span> <span class="free">S'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Dijkstra-is_dijkstra_stepD1"><span class="command">lemma</span></span> is_dijkstra_stepD1 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inv <span class="free">G</span> <span class="free">S</span> <span class="main">⟹</span> is_dijkstra_step <span class="free">G</span> <span class="free">S</span> <span class="free">S'</span> <span class="main">⟹</span> inv <span class="free">G</span> <span class="free">S'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Dijkstra-is_dijkstra_stepD2"><span class="command">lemma</span></span> is_dijkstra_stepD2 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inv <span class="free">G</span> <span class="free">S</span> <span class="main">⟹</span> is_dijkstra_step <span class="free">G</span> <span class="free">S</span> <span class="free">S'</span> <span class="main">⟹</span> card <span class="main">(</span>unknown_set <span class="free">S'</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>unknown_set <span class="free">S</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> is_dijkstra_step_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Interval">
<div class="head">
<h1>Theory Interval</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Interval.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Intervals›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Interval
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Auto2_HOL/Auto2_Main.html">Auto2_HOL.Auto2_Main</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic definition of intervals.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of interval›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> interval <span class="main">=</span> Interval <span class="main">(</span><span class="free"><span class="entity">low</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">high</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_simple_datatype</span> <span class="inner_quoted">"interval"</span>›</span>

<span class="keyword1"><span class="command">instantiation</span></span> interval <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">linorder</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> int_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>low <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> low <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">|</span> <span class="main">(</span>low <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> low <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> high <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> high <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> int_less_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>low <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> low <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">|</span> <span class="main">(</span>low <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> low <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> high <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> high <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interval"</span></span>
  <span class="keyword3"><span class="command">show</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> int_less int_less_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int_less_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> int_less_eq dual_order.trans less_trans<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> int_less_eq a interval.expand int_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> int_less_eq leI not_less_iff_gr_or_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_interval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> interval <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_interval</span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="main">⟷</span> <span class="main">(</span>low <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="main">≤</span> high <span class="free"><span class="bound"><span class="entity">it</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of interval with an index›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> idx_interval <span class="main">=</span> IdxInterval <span class="main">(</span><span class="free"><span class="entity">int</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interval"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">idx</span></span><span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_simple_datatype</span> <span class="inner_quoted">"idx_interval"</span>›</span>

<span class="keyword1"><span class="command">instantiation</span></span> idx_interval <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">linorder</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> iint_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> int <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">|</span> <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> int <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> idx <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> idx <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> iint_less_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> int <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">|</span> <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> int <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> idx <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> idx <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> idx_interval"</span></span>
  <span class="keyword3"><span class="command">show</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> iint_less iint_less_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iint_less_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> iint_less_eq dual_order.trans less_trans<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a idx_interval.expand iint_less iint_less_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> iint_less_eq leI not_less_iff_gr_or_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Interval-interval_less_to_le_low"><span class="command">lemma</span></span> interval_less_to_le_low <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder idx_interval<span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟹</span> low <span class="main">(</span>int <span class="free">a</span><span class="main">)</span> <span class="main">≤</span> low <span class="main">(</span>int <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_iff iint_less int_less less_imp_le<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Overlapping intervals›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_overlap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> interval <span class="main">⇒</span> <span class="tfree">'a</span> interval <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_overlap</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span> <span class="main">(</span>high <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≥</span> low <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> high <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≥</span> low <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_overlap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> idx_interval set <span class="main">⇒</span> <span class="tfree">'a</span> interval <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_overlap</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> is_overlap <span class="main">(</span>int <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Interval_Tree">
<div class="head">
<h1>Theory Interval_Tree</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Interval_Tree.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Interval tree›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Interval_Tree
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lists_Ex.html">Lists_Ex</a> <a href="Interval.html">Interval</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Functional version of interval tree. This is an augmented data
  structure on top of regular binary search trees (see BST.thy).
  See \cite[Section 14.3]{cormen2009introduction} for a reference.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of an interval tree›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> interval_tree <span class="main">=</span>
   Tip
 <span class="main">|</span> Node <span class="main">(</span><span class="free"><span class="free"><span class="entity">lsub</span></span></span><span class="main">:</span> <span class="quoted">interval_tree</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">val</span></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"nat idx_interval"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">tmax</span></span></span><span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">rsub</span></span></span><span class="main">:</span> <span class="quoted">interval_tree</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tmax</span> Tip <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_resolve_prfstep</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> interval_tree.distinct<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> interval_tree.sel<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> interval_tree.collapse<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_var_induct_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> interval_tree.induct<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inorder traversal, and set of elements of a tree›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">in_traverse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"interval_tree <span class="main">⇒</span> nat idx_interval list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">in_traverse</span> Tip <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">in_traverse</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">in_traverse</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="main">#</span> <span class="free">in_traverse</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> in_traverse.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tree_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"interval_tree <span class="main">⇒</span> nat idx_interval set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_set</span> Tip <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tree_set</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">it</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">tree_set</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∪</span> <span class="free">tree_set</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> tree_set.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tree_sorted</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"interval_tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_sorted</span> Tip <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tree_sorted</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>tree_set <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">it</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>tree_set <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">)</span>
                                   <span class="main">∧</span> <span class="free">tree_sorted</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">tree_sorted</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> tree_sorted.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Interval_Tree-tree_sorted_lr"><span class="command">lemma</span></span> tree_sorted_lr <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="main">(</span>Node <span class="free">l</span> <span class="free">it</span> <span class="free">m</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> tree_sorted <span class="free">l</span> <span class="main">∧</span> tree_sorted <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Interval_Tree-tree_sortedD1"><span class="command">lemma</span></span> tree_sortedD1 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="main">(</span>Node <span class="free">l</span> <span class="free">it</span> <span class="free">m</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> tree_set <span class="free">l</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">it</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Interval_Tree-tree_sortedD2"><span class="command">lemma</span></span> tree_sortedD2 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="main">(</span>Node <span class="free">l</span> <span class="free">it</span> <span class="free">m</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> tree_set <span class="free">r</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="free">it</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Interval_Tree-inorder_preserve_set"><span class="command">lemma</span></span> inorder_preserve_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_set <span class="free">t</span> <span class="main">=</span> set <span class="main">(</span>in_traverse <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Interval_Tree-inorder_sorted"><span class="command">lemma</span></span> inorder_sorted <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="free">t</span> <span class="main">⟷</span> strict_sorted <span class="main">(</span>in_traverse <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Use definition in terms of in\_traverse from now on.›</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">del_prfstep_thm</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> tree_set.simps<span class="antiquote">}</span></span></span> @ <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> tree_sorted.simps<span class="antiquote">}</span></span></span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant on the maximum›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat idx_interval <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">max3</span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> max <span class="main">(</span>high <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">it</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>max <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tree_max_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"interval_tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_max_inv</span> Tip <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tree_max_inv</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">tree_max_inv</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">tree_max_inv</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> max3 <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="main">(</span>tmax <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>tmax <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> tree_max_inv.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Interval_Tree-tree_max_is_max"><span class="command">lemma</span></span> tree_max_is_max <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_max_inv <span class="free">t</span> <span class="main">⟹</span> <span class="free">it</span> <span class="main">∈</span> tree_set <span class="free">t</span> <span class="main">⟹</span> high <span class="main">(</span>int <span class="free">it</span><span class="main">)</span> <span class="main">≤</span> tmax <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Interval_Tree-tmax_exists"><span class="command">lemma</span></span> tmax_exists <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_max_inv <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Tip <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span><span class="main">∈</span>tree_set <span class="free">t</span><span class="main">.</span> high <span class="main">(</span>int <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> tmax <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">it</span> <span class="free">m</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> Tip"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> Tip"</span></span> <span class="keyword1"><span class="command">@end</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> Tip"</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For insertion›</span></span>
<span class="keyword1" id="Interval_Tree-max3_insert"><span class="command">lemma</span></span> max3_insert <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"max3 <span class="free">it</span> <span class="main">0</span> <span class="main">0</span> <span class="main">=</span> high <span class="main">(</span>int <span class="free">it</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> max3_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Condition on the values›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tree_interval_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"interval_tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_interval_inv</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>tree_set <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">.</span> is_interval <span class="main">(</span>int <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_interval_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"interval_tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_interval_tree</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">(</span>tree_sorted <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> tree_max_inv <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> tree_interval_inv <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Interval_Tree-is_interval_tree_lr"><span class="command">lemma</span></span> is_interval_tree_lr <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_interval_tree <span class="main">(</span>Node <span class="free">l</span> <span class="free">x</span> <span class="free">m</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> is_interval_tree <span class="free">l</span> <span class="main">∧</span> is_interval_tree <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Insertion on trees›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat idx_interval <span class="main">⇒</span> interval_tree <span class="main">⇒</span> interval_tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Tip <span class="main">=</span> Node Tip <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>high <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> Tip"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span>
       <span class="keyword1">let</span> <span class="bound">l'</span> <span class="main">=</span> <span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span>
           Node <span class="bound">l'</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span>max3 <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span>tmax <span class="bound">l'</span><span class="main">)</span> <span class="main">(</span>tmax <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
     <span class="keyword1">else</span>
       <span class="keyword1">let</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">in</span>
           Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span>max3 <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span>tmax <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>tmax <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> insert.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Interval_Tree-tree_insert_in_traverse"><span class="command">lemma</span></span> tree_insert_in_traverse <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="free">t</span> <span class="main">⟹</span> in_traverse <span class="main">(</span>insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> ordered_insert <span class="free">x</span> <span class="main">(</span>in_traverse <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Interval_Tree-tree_insert_max_inv"><span class="command">lemma</span></span> tree_insert_max_inv <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_max_inv <span class="free">t</span> <span class="main">⟹</span> tree_max_inv <span class="main">(</span>insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of insertion.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> tree_insert_all_inv <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_interval_tree <span class="free">t</span> <span class="main">⟹</span> is_interval <span class="main">(</span>int <span class="free">it</span><span class="main">)</span> <span class="main">⟹</span> is_interval_tree <span class="main">(</span>insert <span class="free">it</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> tree_insert_on_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="free">t</span> <span class="main">⟹</span> tree_set <span class="main">(</span>insert <span class="free">it</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">it</span><span class="main">}</span> <span class="main">∪</span> tree_set <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Deletion on trees›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">del_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"interval_tree <span class="main">⇒</span> nat idx_interval <span class="main">×</span> interval_tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">del_min</span> Tip <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">del_min</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="main">=</span> Tip <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span> <span class="keyword1">else</span>
    <span class="keyword1">let</span> <span class="bound">lt'</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">del_min</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span>fst <span class="main">(</span><span class="free">del_min</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span><span class="main">)</span><span class="main">,</span> Node <span class="bound">lt'</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>max3 <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>tmax <span class="bound">lt'</span><span class="main">)</span> <span class="main">(</span>tmax <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> del_min.simps<span class="main">(</span>2<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"del_min t"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"t ≠ Tip"</span><span class="main">]</span><span class="main">)</span>›</span>

<span class="keyword1" id="Interval_Tree-delete_min_del_hd"><span class="command">lemma</span></span> delete_min_del_hd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Tip <span class="main">⟹</span> fst <span class="main">(</span>del_min <span class="free">t</span><span class="main">)</span> <span class="main">#</span> in_traverse <span class="main">(</span>snd <span class="main">(</span>del_min <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> in_traverse <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> delete_min_del_hd<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"in_traverse (snd (del_min ?t))"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Interval_Tree-delete_min_max_inv"><span class="command">lemma</span></span> delete_min_max_inv <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_max_inv <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Tip <span class="main">⟹</span> tree_max_inv <span class="main">(</span>snd <span class="main">(</span>del_min <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Interval_Tree-delete_min_on_set"><span class="command">lemma</span></span> delete_min_on_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Tip <span class="main">⟹</span> <span class="main">{</span>fst <span class="main">(</span>del_min <span class="free">t</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> tree_set <span class="main">(</span>snd <span class="main">(</span>del_min <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> tree_set <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> delete_min_on_set<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"tree_set (snd (del_min ?t))"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Interval_Tree-delete_min_interval_inv"><span class="command">lemma</span></span> delete_min_interval_inv <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_interval_inv <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Tip <span class="main">⟹</span> tree_interval_inv <span class="main">(</span>snd <span class="main">(</span>del_min <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Interval_Tree-delete_min_all_inv"><span class="command">lemma</span></span> delete_min_all_inv <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_interval_tree <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Tip <span class="main">⟹</span> is_interval_tree <span class="main">(</span>snd <span class="main">(</span>del_min <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delete_elt_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"interval_tree <span class="main">⇒</span> interval_tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delete_elt_tree</span> Tip <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">delete_elt_tree</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="main">=</span> Tip <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span> <span class="main">=</span> Tip <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="keyword1">else</span>
     <span class="keyword1">let</span> <span class="bound">x'</span> <span class="main">=</span> fst <span class="main">(</span>del_min <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span><span class="main">;</span>
         <span class="bound">rt'</span> <span class="main">=</span> snd <span class="main">(</span>del_min <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span><span class="main">;</span>
         <span class="bound">m'</span> <span class="main">=</span> max3 <span class="bound">x'</span> <span class="main">(</span>tmax <span class="free"><span class="bound"><span class="entity">lt</span></span></span><span class="main">)</span> <span class="main">(</span>tmax <span class="bound">rt'</span><span class="main">)</span> <span class="keyword1">in</span>
       Node <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="main">(</span>fst <span class="main">(</span>del_min <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">m'</span> <span class="bound">rt'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> delete_elt_tree.simps<span class="main">(</span>2<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Interval_Tree-delete_elt_in_traverse"><span class="command">lemma</span></span> delete_elt_in_traverse <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"in_traverse <span class="main">(</span>delete_elt_tree <span class="main">(</span>Node <span class="free">lt</span> <span class="free">x</span> <span class="free">m</span> <span class="free">rt</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> in_traverse <span class="free">lt</span> <span class="main">@</span> in_traverse <span class="free">rt</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Interval_Tree-delete_elt_max_inv"><span class="command">lemma</span></span> delete_elt_max_inv <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_max_inv <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Tip <span class="main">⟹</span> tree_max_inv <span class="main">(</span>delete_elt_tree <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Interval_Tree-delete_elt_on_set"><span class="command">lemma</span></span> delete_elt_on_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Tip <span class="main">⟹</span> tree_set <span class="main">(</span>delete_elt_tree <span class="main">(</span>Node <span class="free">lt</span> <span class="free">x</span> <span class="free">m</span> <span class="free">rt</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> tree_set <span class="free">lt</span> <span class="main">∪</span> tree_set <span class="free">rt</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Interval_Tree-delete_elt_interval_inv"><span class="command">lemma</span></span> delete_elt_interval_inv <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_interval_inv <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Tip <span class="main">⟹</span> tree_interval_inv <span class="main">(</span>delete_elt_tree <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Interval_Tree-delete_elt_all_inv"><span class="command">lemma</span></span> delete_elt_all_inv <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_interval_tree <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Tip <span class="main">⟹</span> is_interval_tree <span class="main">(</span>delete_elt_tree <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat idx_interval <span class="main">⇒</span> interval_tree <span class="main">⇒</span> interval_tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Tip <span class="main">=</span> Tip"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> delete_elt_tree <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span>
       <span class="keyword1">let</span> <span class="bound">l'</span> <span class="main">=</span> <span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span>
           <span class="bound">m'</span> <span class="main">=</span> max3 <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span>tmax <span class="bound">l'</span><span class="main">)</span> <span class="main">(</span>tmax <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">in</span> Node <span class="bound">l'</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="bound">m'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
     <span class="keyword1">else</span>
       <span class="keyword1">let</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
           <span class="bound">m'</span> <span class="main">=</span> max3 <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span>tmax <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>tmax <span class="bound">r'</span><span class="main">)</span> <span class="keyword1">in</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="bound">m'</span> <span class="bound">r'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> delete.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Interval_Tree-tree_delete_in_traverse"><span class="command">lemma</span></span> tree_delete_in_traverse <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="free">t</span> <span class="main">⟹</span> in_traverse <span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> remove_elt_list <span class="free">x</span> <span class="main">(</span>in_traverse <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Interval_Tree-tree_delete_max_inv"><span class="command">lemma</span></span> tree_delete_max_inv <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_max_inv <span class="free">t</span> <span class="main">⟹</span> tree_max_inv <span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of deletion.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> tree_delete_all_inv <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_interval_tree <span class="free">t</span> <span class="main">⟹</span> is_interval_tree <span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"tree_set <span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> tree_set <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> tree_delete_on_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tree_sorted <span class="free">t</span> <span class="main">⟹</span> tree_set <span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> tree_set <span class="free">t</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Search on interval trees›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">search</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"interval_tree <span class="main">⇒</span> nat interval <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">search</span> Tip <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">search</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> is_overlap <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> True
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≠</span> Tip <span class="main">∧</span> tmax <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≥</span> low <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free">search</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>
    <span class="keyword1">else</span> <span class="free">search</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> search.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of search›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> search_correct <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_interval_tree <span class="free">t</span> <span class="main">⟹</span> is_interval <span class="free">x</span> <span class="main">⟹</span> search <span class="free">t</span> <span class="free">x</span> <span class="main">⟷</span> has_overlap <span class="main">(</span>tree_set <span class="free">t</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">y</span> <span class="free">m</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">y</span> <span class="free">m</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"is_overlap <span class="main">(</span>int <span class="free">y</span><span class="main">)</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> Tip <span class="main">∧</span> tmax <span class="free">l</span> <span class="main">≥</span> low <span class="free">x</span>"</span></span> <span class="main">@with</span>
        <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">∈</span>tree_set <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"high <span class="main">(</span>int <span class="free">p</span><span class="main">)</span> <span class="main">=</span> tmax <span class="free">l</span>"</span></span>
        <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"is_overlap <span class="main">(</span>int <span class="free">p</span><span class="main">)</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">@end</span></span>
      <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> Tip"</span></span>
    <span class="keyword1"><span class="command">@endgoal</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Quicksort">
<div class="head">
<h1>Theory Quicksort</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Quicksort.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Quicksort›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Quicksort
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Arrays_Ex.html">Arrays_Ex</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Functional version of quicksort.

  Implementation of quicksort is largely based on theory
  Imperative\_Quicksort in HOL/Imperative\_HOL/ex in the Isabelle
  library.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Outer remains›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">outer_remains</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">outer_remains</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟷</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Quicksort-outer_remains_length"><span class="command">lemma</span></span> outer_remains_length <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"outer_remains <span class="free">xs</span> <span class="free">xs'</span> <span class="free">l</span> <span class="free">r</span> <span class="main">⟹</span> length <span class="free">xs</span> <span class="main">=</span> length <span class="free">xs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Quicksort-outer_remains_eq"><span class="command">lemma</span></span> outer_remains_eq <span class="main">[</span><span class="operator">rewrite_back</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"outer_remains <span class="free">xs</span> <span class="free">xs'</span> <span class="free">l</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs'</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="quoted"><span class="quoted">"outer_remains <span class="free">xs</span> <span class="free">xs'</span> <span class="free">l</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs'</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Quicksort-outer_remains_sublist"><span class="command">lemma</span></span> outer_remains_sublist <span class="main">[</span><span class="operator">backward2</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"outer_remains <span class="free">xs</span> <span class="free">xs'</span> <span class="free">l</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">⟹</span> take <span class="free">i</span> <span class="free">xs</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">xs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"outer_remains <span class="free">xs</span> <span class="free">xs'</span> <span class="free">l</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> drop <span class="free">i</span> <span class="free">xs</span> <span class="main">=</span> drop <span class="free">i</span> <span class="free">xs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> outer_remains <span class="free">xs</span> <span class="free">xs'</span> <span class="free">l</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">⟹</span> sublist <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span> <span class="main">=</span> sublist <span class="free">i</span> <span class="free">j</span> <span class="free">xs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> outer_remains <span class="free">xs</span> <span class="free">xs'</span> <span class="free">l</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&gt;</span> <span class="free">r</span> <span class="main">⟹</span> sublist <span class="free">i</span> <span class="free">j</span> <span class="free">xs</span> <span class="main">=</span> sublist <span class="free">i</span> <span class="free">j</span> <span class="free">xs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm_eqforward</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> outer_remains_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹part1 function›</span></span>  

<span class="keyword1"><span class="command">function</span></span> <span class="entity">part1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">part1</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> <span class="free">part1</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>
     <span class="keyword1">else</span> <span class="free">part1</span> <span class="main">(</span>list_swap <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">r</span> <span class="main">-</span> <span class="bound">l</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"part1 xs l r a"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"r &lt; length xs"</span><span class="main">]</span><span class="main">)</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_prfstep_check_req</span> <span class="main">(</span><span class="inner_quoted">"part1 xs l r a"</span><span class="main">,</span> <span class="inner_quoted">"r &lt; length xs"</span><span class="main">)</span>›</span>

<span class="keyword1" id="Quicksort-part1_basic"><span class="command">lemma</span></span> part1_basic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">r</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">rs</span><span class="main">,</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">=</span> part1 <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="free">a</span> <span class="main">⟹</span>
   outer_remains <span class="free">xs</span> <span class="free">xs'</span> <span class="free">l</span> <span class="free">r</span> <span class="main">∧</span> mset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">rs</span> <span class="main">∧</span> <span class="free">rs</span> <span class="main">≤</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"part1 <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"part1 <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> part1_basic<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"part1 ?xs ?l ?r ?a"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Quicksort-part1_partitions1"><span class="command">lemma</span></span> part1_partitions1 <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">rs</span><span class="main">,</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">=</span> part1 <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="free">xs'</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"part1 <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"part1 <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Quicksort-part1_partitions2"><span class="command">lemma</span></span> part1_partitions2 <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">rs</span><span class="main">,</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">=</span> part1 <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">rs</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">xs'</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≥</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"part1 <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"part1 <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Paritition function›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder list<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">partition</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">xs'</span><span class="main">)</span> <span class="main">=</span> part1 <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">p</span><span class="main">;</span>
      <span class="bound">m'</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">xs'</span> <span class="main">!</span> <span class="bound">m</span> <span class="main">≤</span> <span class="bound">p</span> <span class="keyword1">then</span> <span class="bound">m</span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="bound">m</span>
    <span class="keyword1">in</span>
      <span class="main">(</span><span class="bound">m'</span><span class="main">,</span> list_swap <span class="bound">xs'</span> <span class="bound">m'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"partition xs l r"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"l &lt; r"</span><span class="main">,</span> <span class="inner_quoted">"r &lt; length xs"</span><span class="main">]</span><span class="main">)</span>›</span>

<span class="keyword1" id="Quicksort-partition_basic"><span class="command">lemma</span></span> partition_basic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">rs</span><span class="main">,</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">=</span> partition <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="main">⟹</span>
   outer_remains <span class="free">xs</span> <span class="free">xs'</span> <span class="free">l</span> <span class="free">r</span> <span class="main">∧</span> mset <span class="free">xs'</span> <span class="main">=</span> mset <span class="free">xs</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">rs</span> <span class="main">∧</span> <span class="free">rs</span> <span class="main">≤</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> partition_basic<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"partition ?xs ?l ?r"</span><span class="main">]</span>›</span>
  
<span class="keyword1" id="Quicksort-partition_partitions1"><span class="command">lemma</span></span> partition_partitions1 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">rs</span><span class="main">,</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">=</span> partition <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>sublist <span class="free">l</span> <span class="free">rs</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">xs'</span> <span class="main">!</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≥</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">xs'</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Quicksort-partition_partitions2"><span class="command">lemma</span></span> partition_partitions2 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">rs</span><span class="main">,</span> <span class="free">xs''</span><span class="main">)</span> <span class="main">=</span> partition <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>sublist <span class="main">(</span><span class="free">rs</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs''</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≥</span> <span class="free">xs''</span> <span class="main">!</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≥</span> <span class="free">rs</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">xs''</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> fst <span class="main">(</span>part1 <span class="free">xs</span> <span class="free">l</span> <span class="main">(</span><span class="free">r</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">=</span> snd <span class="main">(</span>part1 <span class="free">xs</span> <span class="free">l</span> <span class="main">(</span><span class="free">r</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">!</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> partition_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Quicksort-quicksort_term1"><span class="command">lemma</span></span> quicksort_term1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">r</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">⟹</span> <span class="main">¬</span> length <span class="free">xs</span> <span class="main">≤</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> partition <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">xs1</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">-</span> Suc <span class="free">l</span> <span class="main">&lt;</span> <span class="free">r</span> <span class="main">-</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>partition <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">-</span> <span class="free">l</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">r</span> <span class="main">-</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Quicksort-quicksort_term2"><span class="command">lemma</span></span> quicksort_term2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">r</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">⟹</span> <span class="main">¬</span> length <span class="free">xs</span> <span class="main">≤</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> partition <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">xs2</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">-</span> Suc <span class="free">p</span> <span class="main">&lt;</span> <span class="free">r</span> <span class="main">-</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">-</span> fst <span class="main">(</span>partition <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">r</span> <span class="main">-</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Quicksort function›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">quicksort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">quicksort</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≥</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">let</span>
      <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">xs1</span><span class="main">)</span> <span class="main">=</span> partition <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
      <span class="bound">xs2</span> <span class="main">=</span> <span class="free">quicksort</span> <span class="bound">xs1</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
    <span class="keyword1">in</span>
      <span class="free">quicksort</span> <span class="bound">xs2</span> <span class="main">(</span><span class="bound">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">-</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quicksort_term1 quicksort_term2<span class="main">)</span>

<span class="keyword1" id="Quicksort-quicksort_basic"><span class="command">lemma</span></span> quicksort_basic <span class="main">[</span><span class="operator">rewrite_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>quicksort <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span> <span class="main">∧</span> outer_remains <span class="free">xs</span> <span class="main">(</span>quicksort <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="free">l</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"quicksort <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"quicksort <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Quicksort-quicksort_trivial1"><span class="command">lemma</span></span> quicksort_trivial1 <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≥</span> <span class="free">r</span> <span class="main">⟹</span> quicksort <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"quicksort <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Quicksort-quicksort_trivial2"><span class="command">lemma</span></span> quicksort_trivial2 <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> length <span class="free">xs</span> <span class="main">⟹</span> quicksort <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"quicksort <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Quicksort-quicksort_permutes"><span class="command">lemma</span></span> quicksort_permutes <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">=</span> quicksort <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="main">⟹</span> set <span class="main">(</span>sublist <span class="free">l</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>sublist <span class="free">l</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≥</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> take <span class="free">l</span> <span class="free">xs</span> <span class="main">@</span> sublist <span class="free">l</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">=</span> take <span class="free">l</span> <span class="free">xs'</span> <span class="main">@</span> sublist <span class="free">l</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs'</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs'</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"take <span class="free">l</span> <span class="free">xs</span> <span class="main">=</span> take <span class="free">l</span> <span class="free">xs'</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs'</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Quicksort-quicksort_sorts"><span class="command">lemma</span></span> quicksort_sorts <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> sorted <span class="main">(</span>sublist <span class="free">l</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>quicksort <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"quicksort <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≥</span> <span class="free">r</span>"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> fst <span class="main">(</span>partition <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs1</span> <span class="main">=</span> snd <span class="main">(</span>partition <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs2</span> <span class="main">=</span> quicksort <span class="free">xs1</span> <span class="free">l</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs3</span> <span class="main">=</span> quicksort <span class="free">xs2</span> <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>sublist <span class="free">l</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs3</span><span class="main">)</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> length <span class="free">xs3</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"sublist <span class="free">l</span> <span class="free">p</span> <span class="free">xs2</span> <span class="main">=</span> sublist <span class="free">l</span> <span class="free">p</span> <span class="free">xs3</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>sublist <span class="free">l</span> <span class="free">p</span> <span class="free">xs1</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>sublist <span class="free">l</span> <span class="free">p</span> <span class="free">xs2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"sublist <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs1</span> <span class="main">=</span> sublist <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs2</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>sublist <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs2</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>sublist <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs3</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>sublist <span class="free">l</span> <span class="free">p</span> <span class="free">xs3</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">xs3</span> <span class="main">!</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>sublist <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs3</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">xs3</span> <span class="main">!</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>sublist <span class="free">l</span> <span class="free">p</span> <span class="free">xs3</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>sublist <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs3</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"sublist <span class="free">l</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs3</span> <span class="main">=</span> sublist <span class="free">l</span> <span class="free">p</span> <span class="free">xs3</span> <span class="main">@</span> <span class="main">(</span><span class="free">xs3</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="main">#</span> sublist <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs3</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"quicksort <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Main result: correctness of functional quicksort.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> quicksort_sorts_all <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> quicksort <span class="free">xs</span> <span class="main">0</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> sort <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">=</span> quicksort <span class="free">xs</span> <span class="main">0</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"sublist <span class="main">0</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs'</span> <span class="main">=</span> <span class="free">xs'</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Indexed_PQueue">
<div class="head">
<h1>Theory Indexed_PQueue</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Indexed_PQueue.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Indexed priority queues›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Indexed_PQueue
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Arrays_Ex.html">Arrays_Ex</a> <a href="Mapping_Str.html">Mapping_Str</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Verification of indexed priority queue: functional part. The data
  structure is also verified by Lammich in
  \cite{Refine_Imperative_HOL-AFP}.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Successor functions, eq-pred predicate›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">s1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">s2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue-s_inj"><span class="command">lemma</span></span> s_inj <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"s1 <span class="free">m</span> <span class="main">=</span> s1 <span class="free">m'</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> <span class="free">m'</span>"</span></span> <span class="quoted"><span class="quoted">"s2 <span class="free">m</span> <span class="main">=</span> s2 <span class="free">m'</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> <span class="free">m'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Indexed_PQueue-s_neq"><span class="command">lemma</span></span> s_neq <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"s1 <span class="free">m</span> <span class="main">≠</span> s2 <span class="free">m'</span>"</span></span> <span class="quoted"><span class="quoted">"s1 <span class="free">m</span> <span class="main">&gt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"s2 <span class="free">m</span> <span class="main">&gt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"s2 <span class="free">m</span> <span class="main">&gt;</span> s1 <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s1.simps s2.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> s_neq<span class="main">(</span>2<span class="main">)</span><span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"s1 ?m"</span><span class="main">]</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> s_neq<span class="main">(</span>3<span class="main">)</span><span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"s2 ?m"</span><span class="main">]</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> s_neq<span class="main">(</span>4<span class="main">)</span><span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"s2 ?m"</span><span class="main">,</span> <span class="entity">with_term</span> <span class="inner_quoted">"s1 ?m"</span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">eq_pred</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_pred</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_pred</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⟹</span> <span class="free">eq_pred</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>s1 <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_pred</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⟹</span> <span class="free">eq_pred</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>s2 <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_case_induct_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eq_pred.cases<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_prop_induct_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eq_pred.induct<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_resolve_prfstep</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eq_pred.intros<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_backward_prfstep</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> eq_pred.intros<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Indexed_PQueue-eq_pred_parent1"><span class="command">lemma</span></span> eq_pred_parent1 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_pred <span class="free">i</span> <span class="main">(</span>s1 <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≠</span> s1 <span class="free">k</span> <span class="main">⟹</span> eq_pred <span class="free">i</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> s1 <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">@prop_induct</span></span> <span class="quoted"><span class="quoted">"eq_pred <span class="free">i</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Indexed_PQueue-eq_pred_parent2"><span class="command">lemma</span></span> eq_pred_parent2 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_pred <span class="free">i</span> <span class="main">(</span>s2 <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≠</span> s2 <span class="free">k</span> <span class="main">⟹</span> eq_pred <span class="free">i</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> s2 <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">@prop_induct</span></span> <span class="quoted"><span class="quoted">"eq_pred <span class="free">i</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Indexed_PQueue-eq_pred_cases"><span class="command">lemma</span></span> eq_pred_cases<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_pred <span class="free">i</span> <span class="free">j</span> <span class="main">⟹</span> eq_pred <span class="main">(</span>s1 <span class="free">i</span><span class="main">)</span> <span class="free">j</span> <span class="main">∨</span> eq_pred <span class="main">(</span>s2 <span class="free">i</span><span class="main">)</span> <span class="free">j</span> <span class="main">∨</span> <span class="free">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∨</span> <span class="free">j</span> <span class="main">=</span> s1 <span class="free">i</span> <span class="main">∨</span> <span class="free">j</span> <span class="main">=</span> s2 <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@prop_induct</span></span> <span class="quoted"><span class="quoted">"eq_pred <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eq_pred_cases<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_cond</span> <span class="inner_quoted">"?i ≠ s1 ?k"</span><span class="main">,</span> <span class="entity">with_cond</span> <span class="inner_quoted">"?i ≠ s2 ?k"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Indexed_PQueue-eq_pred_le"><span class="command">lemma</span></span> eq_pred_le <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eq_pred <span class="free">i</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@prop_induct</span></span> <span class="quoted"><span class="quoted">"eq_pred <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Heap property›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The corresponding tree is a heap›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_heap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_heap</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> eq_pred <span class="bound">i</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟶</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue-is_heapD"><span class="command">lemma</span></span> is_heapD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_heap <span class="free">xs</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> eq_pred <span class="free">i</span> <span class="free">j</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> is_heapD<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"?xs ! ?j"</span><span class="main">]</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm_eqforward</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> is_heap_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bubble-down›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The corresponding tree is a heap, except k is not necessarily smaller than its descendents.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_heap_partial1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_heap_partial1</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> eq_pred <span class="bound">i</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟶</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Two cases of switching with s1 k.›</span></span>
<span class="keyword1" id="Indexed_PQueue-bubble_down1"><span class="command">lemma</span></span> bubble_down1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"s1 <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> is_heap_partial1 <span class="free">xs</span> <span class="free">k</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">&gt;</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> s1 <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span>
   snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> s1 <span class="free">k</span><span class="main">)</span> <span class="main">≤</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> s2 <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span> is_heap_partial1 <span class="main">(</span>list_swap <span class="free">xs</span> <span class="free">k</span> <span class="main">(</span>s1 <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>s1 <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> bubble_down1<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"list_swap ?xs ?k (s1 ?k)"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Indexed_PQueue-bubble_down2"><span class="command">lemma</span></span> bubble_down2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"s1 <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> is_heap_partial1 <span class="free">xs</span> <span class="free">k</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">&gt;</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> s1 <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span>
   s2 <span class="free">k</span> <span class="main">≥</span> length <span class="free">xs</span> <span class="main">⟹</span> is_heap_partial1 <span class="main">(</span>list_swap <span class="free">xs</span> <span class="free">k</span> <span class="main">(</span>s1 <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>s1 <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> bubble_down2<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"list_swap ?xs ?k (s1 ?k)"</span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹One case of switching with s2 k.›</span></span>
<span class="keyword1" id="Indexed_PQueue-bubble_down3"><span class="command">lemma</span></span> bubble_down3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"s2 <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> is_heap_partial1 <span class="free">xs</span> <span class="free">k</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> s1 <span class="free">k</span><span class="main">)</span> <span class="main">&gt;</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> s2 <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span>
   snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">&gt;</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> s2 <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">xs'</span> <span class="main">=</span> list_swap <span class="free">xs</span> <span class="free">k</span> <span class="main">(</span>s2 <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span> is_heap_partial1 <span class="free">xs'</span> <span class="main">(</span>s2 <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> bubble_down3<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"?xs'"</span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bubble-up›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">par</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">par</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"par m"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"m ≠ 0"</span><span class="main">]</span><span class="main">)</span>›</span>

<span class="keyword1" id="Indexed_PQueue-ps_inverse"><span class="command">lemma</span></span> ps_inverse <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"par <span class="main">(</span>s1 <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"par <span class="main">(</span>s2 <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Indexed_PQueue-p_basic"><span class="command">lemma</span></span> p_basic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> par <span class="free">m</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> p_basic<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"par ?m"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Indexed_PQueue-p_cases"><span class="command">lemma</span></span> p_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> s1 <span class="main">(</span>par <span class="free">m</span><span class="main">)</span> <span class="main">∨</span> <span class="free">m</span> <span class="main">=</span> s2 <span class="main">(</span>par <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> p_cases<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"par ?m"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Indexed_PQueue-eq_pred_p_next"><span class="command">lemma</span></span> eq_pred_p_next<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> eq_pred <span class="free">i</span> <span class="free">j</span> <span class="main">⟹</span> eq_pred <span class="main">(</span>par <span class="free">i</span><span class="main">)</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@prop_induct</span></span> <span class="quoted"><span class="quoted">"eq_pred <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eq_pred_p_next<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"par ?i"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Indexed_PQueue-heap_implies_hd_min"><span class="command">lemma</span></span> heap_implies_hd_min <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_heap <span class="free">xs</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> snd <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@strong_induct</span></span> <span class="quoted"><span class="free">i</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">@apply_induct_hyp</span></span> <span class="quoted"><span class="quoted">"par <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"eq_pred <span class="main">(</span>par <span class="free">i</span><span class="main">)</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The corresponding tree is a heap, except k is not necessarily greater than its ancestors.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_heap_partial2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_heap_partial2</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> eq_pred <span class="bound">i</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">⟶</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue-bubble_up1"><span class="command">lemma</span></span> bubble_up1 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> is_heap_partial2 <span class="free">xs</span> <span class="free">k</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">&lt;</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> par <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
   is_heap_partial2 <span class="main">(</span>list_swap <span class="free">xs</span> <span class="free">k</span> <span class="main">(</span>par <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>par <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Indexed_PQueue-bubble_up2"><span class="command">lemma</span></span> bubble_up2 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> is_heap_partial2 <span class="free">xs</span> <span class="free">k</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">≥</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> par <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
   is_heap <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> p_cases<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Indexed priority queue›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> idx_pqueue <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">×</span> nat option list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">index_of_pqueue</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> idx_pqueue <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">index_of_pqueue</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">!</span> <span class="main">(</span>fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> Some <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> index_of_pqueue.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Indexed_PQueue-index_of_pqueueD1"><span class="command">lemma</span></span> index_of_pqueueD1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   fst <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">m</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">!</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> index_of_pqueueD1<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"?xs ! ?i"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Indexed_PQueue-index_of_pqueueD2"><span class="command">lemma</span></span> index_of_pqueueD2 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">m</span> <span class="main">⟹</span> index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">m</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> fst <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Indexed_PQueue-index_of_pqueueD3"><span class="command">lemma</span></span> index_of_pqueueD3 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> fst <span class="free">p</span> <span class="main">&lt;</span> length <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm_eqforward</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> index_of_pqueue.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Indexed_PQueue-has_index_unique_key"><span class="command">lemma</span></span> has_index_unique_key <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> unique_keys_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Indexed_PQueue-has_index_keys_of"><span class="command">lemma</span></span> has_index_keys_of <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> has_key_alist <span class="free">xs</span> <span class="free">k</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">k</span> <span class="main">&lt;</span> length <span class="free">m</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">!</span> <span class="free">k</span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"has_key_alist <span class="free">xs</span> <span class="free">k</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Indexed_PQueue-has_index_distinct"><span class="command">lemma</span></span> has_index_distinct <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic operations on indexed\_queue›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">idx_pqueue_swap_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">×</span> nat option list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">×</span> nat option list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_pqueue_swap_fun</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span>
    list_swap <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">[</span>fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">:=</span> Some <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">[</span>fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">:=</span> Some <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue-index_of_pqueue_swap"><span class="command">lemma</span></span> index_of_pqueue_swap <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   index_of_pqueue <span class="main">(</span>idx_pqueue_swap_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"idx_pqueue_swap_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Indexed_PQueue-fst_idx_pqueue_swap"><span class="command">lemma</span></span> fst_idx_pqueue_swap <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fst <span class="main">(</span>idx_pqueue_swap_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> list_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"idx_pqueue_swap_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Indexed_PQueue-snd_idx_pqueue_swap"><span class="command">lemma</span></span> snd_idx_pqueue_swap <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="main">(</span>idx_pqueue_swap_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"idx_pqueue_swap_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">idx_pqueue_push_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> idx_pqueue <span class="main">⇒</span> <span class="tfree">'a</span> idx_pqueue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_pqueue_push_fun</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">,</span> list_update <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Some <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue-idx_pqueue_push_correct"><span class="command">lemma</span></span> idx_pqueue_push_correct <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">m</span> <span class="main">⟹</span> <span class="main">¬</span>has_key_alist <span class="free">xs</span> <span class="free">k</span> <span class="main">⟹</span>
   <span class="free">r</span> <span class="main">=</span> idx_pqueue_push_fun <span class="free">k</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   index_of_pqueue <span class="free">r</span> <span class="main">∧</span> fst <span class="free">r</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">]</span> <span class="main">∧</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> length <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"idx_pqueue_push_fun <span class="free">k</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">idx_pqueue_pop_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> idx_pqueue <span class="main">⇒</span> <span class="tfree">'a</span> idx_pqueue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_pqueue_pop_fun</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>butlast <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> list_update <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>fst <span class="main">(</span>last <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue-idx_pqueue_pop_correct"><span class="command">lemma</span></span> idx_pqueue_pop_correct <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">=</span> idx_pqueue_pop_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   index_of_pqueue <span class="free">r</span> <span class="main">∧</span> fst <span class="free">r</span> <span class="main">=</span> butlast <span class="free">xs</span> <span class="main">∧</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> length <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"idx_pqueue_pop_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> length <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">m</span>"</span></span>  <span class="comment1">(* TODO: remove? *)</span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bubble up and down›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">idx_bubble_down_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder idx_pqueue <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> idx_pqueue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_bubble_down_fun</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> s2 <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span>
      <span class="keyword1">if</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> s1 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">≤</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> s2 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
        <span class="keyword1">if</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">&gt;</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> s1 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
          <span class="free">idx_bubble_down_fun</span> <span class="main">(</span>idx_pqueue_swap_fun <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>s1 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>s1 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="keyword1">if</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">&gt;</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> s2 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
          <span class="free">idx_bubble_down_fun</span> <span class="main">(</span>idx_pqueue_swap_fun <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>s2 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>s2 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> s1 <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span>
      <span class="keyword1">if</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">&gt;</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> s1 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
        <span class="free">idx_bubble_down_fun</span> <span class="main">(</span>idx_pqueue_swap_fun <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>s1 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>s1 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>length <span class="bound">xs</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto2</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Indexed_PQueue-idx_bubble_down_fun_correct"><span class="command">lemma</span></span> idx_bubble_down_fun_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> idx_bubble_down_fun <span class="free">x</span> <span class="free">k</span> <span class="main">⟹</span> is_heap_partial1 <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="free">k</span> <span class="main">⟹</span>
   is_heap <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> mset <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">∧</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"idx_bubble_down_fun <span class="free">x</span> <span class="free">k</span>"</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span><span class="main">,</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"idx_bubble_down_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"s2 <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> s1 <span class="free">k</span><span class="main">)</span> <span class="main">≤</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> s2 <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"s1 <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> idx_bubble_down_fun_correct<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"?r"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Indexed_PQueue-idx_bubble_down_fun_correct2"><span class="command">lemma</span></span> idx_bubble_down_fun_correct2 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"index_of_pqueue <span class="free">x</span> <span class="main">⟹</span> index_of_pqueue <span class="main">(</span>idx_bubble_down_fun <span class="free">x</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"idx_bubble_down_fun <span class="free">x</span> <span class="free">k</span>"</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span><span class="main">,</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"idx_bubble_down_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"s2 <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> s1 <span class="free">k</span><span class="main">)</span> <span class="main">≤</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> s2 <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"s1 <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">idx_bubble_up_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder idx_pqueue <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> idx_pqueue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_bubble_up_fun</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span>
      <span class="keyword1">if</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">&lt;</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> par <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
        <span class="free">idx_bubble_up_fun</span> <span class="main">(</span>idx_pqueue_swap_fun <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>par <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>par <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue-idx_bubble_up_fun_correct"><span class="command">lemma</span></span> idx_bubble_up_fun_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> idx_bubble_up_fun <span class="free">x</span> <span class="free">k</span> <span class="main">⟹</span> is_heap_partial2 <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="free">k</span> <span class="main">⟹</span>
   is_heap <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> mset <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">∧</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"idx_bubble_up_fun <span class="free">x</span> <span class="free">k</span>"</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span><span class="main">,</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"idx_bubble_up_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> idx_bubble_up_fun_correct<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"?r"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Indexed_PQueue-idx_bubble_up_fun_correct2"><span class="command">lemma</span></span> idx_bubble_up_fun_correct2 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"index_of_pqueue <span class="free">x</span> <span class="main">⟹</span> index_of_pqueue <span class="main">(</span>idx_bubble_up_fun <span class="free">x</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"idx_bubble_up_fun <span class="free">x</span> <span class="free">k</span>"</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span><span class="main">,</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"idx_bubble_up_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Main operations›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delete_min_idx_pqueue_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder idx_pqueue <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">×</span> <span class="tfree">'a</span> idx_pqueue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delete_min_idx_pqueue_fun</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">=</span> idx_pqueue_swap_fun <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">a''</span> <span class="main">=</span> idx_pqueue_pop_fun <span class="main">(</span><span class="bound">xs'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span>
     <span class="keyword1">in</span> <span class="main">(</span>last <span class="bound">xs'</span><span class="main">,</span> idx_bubble_down_fun <span class="bound">a''</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue-delete_min_idx_pqueue_correct"><span class="command">lemma</span></span> delete_min_idx_pqueue_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">res</span> <span class="main">=</span> delete_min_idx_pqueue_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   index_of_pqueue <span class="main">(</span>snd <span class="free">res</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"delete_min_idx_pqueue_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> delete_min_idx_pqueue_correct<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"?res"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Indexed_PQueue-hd_last_swap_eval_last"><span class="command">lemma</span></span> hd_last_swap_eval_last <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> last <span class="main">(</span>list_swap <span class="free">xs</span> <span class="main">0</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> hd <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">=</span> list_swap <span class="free">xs</span> <span class="main">0</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"last <span class="free">xs'</span> <span class="main">=</span> <span class="free">xs'</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of delete-min.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> delete_min_idx_pqueue_correct2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_heap <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">res</span> <span class="main">=</span> delete_min_idx_pqueue_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   is_heap <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">res</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> fst <span class="free">res</span> <span class="main">=</span> hd <span class="free">xs</span> <span class="main">∧</span> length <span class="main">(</span>snd <span class="main">(</span>snd <span class="free">res</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">m</span> <span class="main">∧</span>
   map_of_alist <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">res</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> delete_map <span class="main">(</span>fst <span class="main">(</span>fst <span class="free">res</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_of_alist <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"delete_min_idx_pqueue_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">=</span> list_swap <span class="free">xs</span> <span class="main">0</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_heap_partial1 <span class="main">(</span>butlast <span class="free">xs'</span><span class="main">)</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> delete_min_idx_pqueue_correct2<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"?res"</span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert_idx_pqueue_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> idx_pqueue <span class="main">⇒</span> <span class="tfree">'a</span> idx_pqueue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_idx_pqueue_fun</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">x'</span> <span class="main">=</span> idx_pqueue_push_fun <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">in</span>
      idx_bubble_up_fun <span class="bound">x'</span> <span class="main">(</span>length <span class="main">(</span>fst <span class="bound">x'</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue-insert_idx_pqueue_correct"><span class="command">lemma</span></span> insert_idx_pqueue_correct <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">m</span> <span class="main">⟹</span> <span class="main">¬</span>has_key_alist <span class="free">xs</span> <span class="free">k</span> <span class="main">⟹</span>
   index_of_pqueue <span class="main">(</span>insert_idx_pqueue_fun <span class="free">k</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"insert_idx_pqueue_fun <span class="free">k</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of insertion.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> insert_idx_pqueue_correct2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> is_heap <span class="free">xs</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">m</span> <span class="main">⟹</span> <span class="main">¬</span>has_key_alist <span class="free">xs</span> <span class="free">k</span> <span class="main">⟹</span>
   <span class="free">r</span> <span class="main">=</span> insert_idx_pqueue_fun <span class="free">k</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   is_heap <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> length <span class="free">m</span> <span class="main">∧</span>
   map_of_alist <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span> <span class="main">=</span> map_of_alist <span class="free">xs</span> <span class="main">{</span> <span class="free">k</span> <span class="main">→</span> <span class="free">v</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"insert_idx_pqueue_fun <span class="free">k</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_heap_partial2 <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> insert_idx_pqueue_correct2<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"?r"</span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">update_idx_pqueue_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> idx_pqueue <span class="main">⇒</span> <span class="tfree">'a</span> idx_pqueue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_idx_pqueue_fun</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> None <span class="keyword1">then</span>
      insert_idx_pqueue_fun <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">let</span>
      <span class="bound">i</span> <span class="main">=</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">xs'</span> <span class="main">=</span> list_update <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="bound">i</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span>
      <span class="keyword1">if</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">then</span> idx_bubble_down_fun <span class="main">(</span><span class="bound">xs'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="bound">i</span>
      <span class="keyword1">else</span> idx_bubble_up_fun <span class="main">(</span><span class="bound">xs'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue-update_idx_pqueue_correct"><span class="command">lemma</span></span> update_idx_pqueue_correct <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">m</span> <span class="main">⟹</span>
   index_of_pqueue <span class="main">(</span>update_idx_pqueue_fun <span class="free">k</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"update_idx_pqueue_fun <span class="free">k</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> the <span class="main">(</span><span class="free">m</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">=</span> list_update <span class="free">xs</span> <span class="free">i</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"index_of_pqueue <span class="main">(</span><span class="free">xs'</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of update.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> update_idx_pqueue_correct2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> is_heap <span class="free">xs</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">m</span> <span class="main">⟹</span>
   <span class="free">r</span> <span class="main">=</span> update_idx_pqueue_fun <span class="free">k</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   is_heap <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> length <span class="free">m</span> <span class="main">∧</span>
   map_of_alist <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span> <span class="main">=</span> map_of_alist <span class="free">xs</span> <span class="main">{</span> <span class="free">k</span> <span class="main">→</span> <span class="free">v</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"update_idx_pqueue_fun <span class="free">k</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> the <span class="main">(</span><span class="free">m</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">=</span> list_update <span class="free">xs</span> <span class="free">i</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">xs'</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="comment1">(* TODO: remove *)</span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> the <span class="main">(</span><span class="free">m</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">v</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_heap_partial1 <span class="free">xs'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_heap_partial2 <span class="free">xs'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> update_idx_pqueue_correct2<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"?r"</span><span class="main">]</span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="RBTree">
<div class="head">
<h1>Theory RBTree</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: RBTree.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Red-black trees›</span></span>

<span class="keyword1"><span class="command">theory</span></span> RBTree
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lists_Ex.html">Lists_Ex</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Verification of functional red-black trees. For general technique,
  see Lists\_Ex.thy.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of RBT›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> color <span class="main">=</span> R <span class="main">|</span> B
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">=</span>
    Leaf
  <span class="main">|</span> Node <span class="main">(</span><span class="free"><span class="free"><span class="entity">lsub</span></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">cl</span></span></span><span class="main">:</span> <span class="quoted">color</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">key</span></span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">val</span></span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">rsub</span></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt"</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cl</span> Leaf <span class="main">=</span> B"</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_resolve_prfstep</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> color.distinct<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_resolve_prfstep</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> rbt.distinct<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rbt.sel<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> rbt.collapse<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_var_induct_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> rbt.induct<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="RBTree-not_R"><span class="command">lemma</span></span> not_R <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> R <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> B"</span></span> <span class="keyword1"><span class="command">using</span></span> color.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1" id="RBTree-not_B"><span class="command">lemma</span></span> not_B <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> B <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> R"</span></span> <span class="keyword1"><span class="command">using</span></span> color.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1" id="RBTree-red_not_leaf"><span class="command">lemma</span></span> red_not_leaf <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cl <span class="free">t</span> <span class="main">=</span> R <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Leaf"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹RBT invariants›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">black_depth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">black_depth</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">black_depth</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> R <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">black_depth</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">black_depth</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> B <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">black_depth</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> black_depth.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cl_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cl_inv</span> Leaf <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cl_inv</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> R <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">cl_inv</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">cl_inv</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> cl <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> B <span class="main">∧</span> cl <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> B<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cl_inv</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> B <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">cl_inv</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">cl_inv</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> cl_inv.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bd_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bd_inv</span> Leaf <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bd_inv</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">bd_inv</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">bd_inv</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> black_depth <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> black_depth <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> bd_inv.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_rbt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_rbt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>cl_inv <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> bd_inv <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="RBTree-cl_invI"><span class="command">lemma</span></span> cl_invI<span class="main">:</span> <span class="quoted"><span class="quoted">"cl_inv <span class="free">l</span> <span class="main">⟹</span> cl_inv <span class="free">r</span> <span class="main">⟹</span> cl_inv <span class="main">(</span>Node <span class="free">l</span> B <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> cl_invI<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"Node ?l B ?k ?v ?r"</span><span class="main">]</span>›</span>

<span class="keyword1" id="RBTree-bd_invI"><span class="command">lemma</span></span> bd_invI<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_inv <span class="free">l</span> <span class="main">⟹</span> bd_inv <span class="free">r</span> <span class="main">⟹</span> black_depth <span class="free">l</span> <span class="main">=</span> black_depth <span class="free">r</span> <span class="main">⟹</span> bd_inv <span class="main">(</span>Node <span class="free">l</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> bd_invI<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"Node ?l ?c ?k ?v ?r"</span><span class="main">]</span>›</span>

<span class="keyword1" id="RBTree-is_rbt_rec"><span class="command">lemma</span></span> is_rbt_rec <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="main">(</span>Node <span class="free">l</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> is_rbt <span class="free">l</span> <span class="main">∧</span> is_rbt <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> R"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Balancedness of RBT›</span></span>

<span class="comment1">(* TODO: remove after having general normalization procedure for nats. *)</span>
<span class="keyword1" id="RBTree-two_distrib"><span class="command">lemma</span></span> two_distrib <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">a</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">min_depth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">min_depth</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">min_depth</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> min <span class="main">(</span><span class="free">min_depth</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">min_depth</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> min_depth.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">max_depth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_depth</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">max_depth</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free">max_depth</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">max_depth</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> max_depth.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Balancedness of red-black trees.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> rbt_balanced<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span> <span class="main">⟹</span> max_depth <span class="free">t</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> min_depth <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span> <span class="main">⟶</span> black_depth <span class="free">t</span> <span class="main">≤</span> min_depth <span class="free">t</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> R"</span></span> <span class="keyword1"><span class="command">@endgoal</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span> <span class="main">⟶</span> <span class="main">(</span><span class="keyword1">if</span> cl <span class="free">t</span> <span class="main">=</span> R <span class="keyword1">then</span> max_depth <span class="free">t</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> black_depth <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>
                               <span class="keyword1">else</span> max_depth <span class="free">t</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> black_depth <span class="free">t</span><span class="main">)</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> R"</span></span> <span class="keyword1"><span class="command">@endgoal</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"max_depth <span class="free">t</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> black_depth <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition and basic properties of cl\_inv'›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cl_inv'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cl_inv'</span> Leaf <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cl_inv'</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>cl_inv <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> cl_inv <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> cl_inv'.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="RBTree-cl_inv'B"><span class="command">lemma</span></span> cl_inv'B <span class="main">[</span><span class="operator">forward</span><span class="main">,</span> <span class="operator">backward1</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cl_inv' <span class="free">t</span> <span class="main">⟹</span> cl <span class="free">t</span> <span class="main">=</span> B <span class="main">⟹</span> cl_inv <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="RBTree-cl_inv'R"><span class="command">lemma</span></span> cl_inv'R <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cl_inv' <span class="main">(</span>Node <span class="free">l</span> R <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> cl <span class="free">l</span> <span class="main">=</span> B <span class="main">⟹</span> cl <span class="free">r</span> <span class="main">=</span> B <span class="main">⟹</span> cl_inv <span class="main">(</span>Node <span class="free">l</span> R <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-cl_inv_to_cl_inv'"><span class="command">lemma</span></span> cl_inv_to_cl_inv' <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cl_inv <span class="free">t</span> <span class="main">⟹</span> cl_inv' <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"cl <span class="free">t</span> <span class="main">=</span> R"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="RBTree-cl_inv'I"><span class="command">lemma</span></span> cl_inv'I <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cl_inv <span class="free">l</span> <span class="main">⟹</span> cl_inv <span class="free">r</span> <span class="main">⟹</span> cl_inv' <span class="main">(</span>Node <span class="free">l</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Set of keys, sortedness›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rbt_in_traverse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_in_traverse</span> Leaf <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rbt_in_traverse</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">rbt_in_traverse</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">#</span> <span class="free">rbt_in_traverse</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rbt_in_traverse.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rbt_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_set</span> Leaf <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rbt_set</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">rbt_set</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∪</span> <span class="free">rbt_set</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rbt_set.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rbt_in_traverse_pairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_in_traverse_pairs</span> Leaf <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rbt_in_traverse_pairs</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">rbt_in_traverse_pairs</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">rbt_in_traverse_pairs</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rbt_in_traverse_pairs.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="RBTree-rbt_in_traverse_fst"><span class="command">lemma</span></span> rbt_in_traverse_fst <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span>rbt_in_traverse_pairs <span class="free">t</span><span class="main">)</span> <span class="main">=</span> rbt_in_traverse <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rbt_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_map</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> map_of_alist <span class="main">(</span>rbt_in_traverse_pairs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> rbt_map_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rbt_sorted</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_sorted</span> Leaf <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rbt_sorted</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>rbt_set <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>rbt_set <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">rbt_sorted</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">rbt_sorted</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rbt_sorted.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="RBTree-rbt_sorted_lr"><span class="command">lemma</span></span> rbt_sorted_lr <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_sorted <span class="main">(</span>Node <span class="free">l</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> rbt_sorted <span class="free">l</span> <span class="main">∧</span> rbt_sorted <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-rbt_inorder_preserve_set"><span class="command">lemma</span></span> rbt_inorder_preserve_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_set <span class="free">t</span> <span class="main">=</span> set <span class="main">(</span>rbt_in_traverse <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="RBTree-rbt_inorder_sorted"><span class="command">lemma</span></span> rbt_inorder_sorted <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t</span> <span class="main">⟷</span> strict_sorted <span class="main">(</span>map fst <span class="main">(</span>rbt_in_traverse_pairs <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">del_prfstep_thm</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rbt_set.simps<span class="antiquote">}</span></span></span> @ <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rbt_sorted.simps<span class="antiquote">}</span></span></span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Balance function›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">balanceR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">balanceR</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> cl <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> R <span class="keyword1">then</span>
      <span class="keyword1">let</span> <span class="bound">lr</span> <span class="main">=</span> lsub <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span> <span class="bound">rr</span> <span class="main">=</span> rsub <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> cl <span class="bound">lr</span> <span class="main">=</span> R <span class="keyword1">then</span> Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> B <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>lsub <span class="bound">lr</span><span class="main">)</span><span class="main">)</span> R <span class="main">(</span>key <span class="bound">lr</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">lr</span><span class="main">)</span> <span class="main">(</span>Node <span class="main">(</span>rsub <span class="bound">lr</span><span class="main">)</span> B <span class="main">(</span>key <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="bound">rr</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> cl <span class="bound">rr</span> <span class="main">=</span> R <span class="keyword1">then</span> Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> B <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">lr</span><span class="main">)</span> R <span class="main">(</span>key <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Node <span class="main">(</span>lsub <span class="bound">rr</span><span class="main">)</span> B <span class="main">(</span>key <span class="bound">rr</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">rr</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">rr</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> B <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
    <span class="keyword1">else</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> B <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">balance</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">balance</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> cl <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> R <span class="keyword1">then</span>
      <span class="keyword1">let</span> <span class="bound">ll</span> <span class="main">=</span> lsub <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span> <span class="bound">rl</span> <span class="main">=</span> rsub <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> cl <span class="bound">ll</span> <span class="main">=</span> R <span class="keyword1">then</span> Node <span class="main">(</span>Node <span class="main">(</span>lsub <span class="bound">ll</span><span class="main">)</span> B <span class="main">(</span>key <span class="bound">ll</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">ll</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">ll</span><span class="main">)</span><span class="main">)</span> R <span class="main">(</span>key <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>Node <span class="main">(</span>rsub <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> B <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> cl <span class="bound">rl</span> <span class="main">=</span> R <span class="keyword1">then</span> Node <span class="main">(</span>Node <span class="main">(</span>lsub <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> B <span class="main">(</span>key <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>lsub <span class="bound">rl</span><span class="main">)</span><span class="main">)</span> R <span class="main">(</span>key <span class="bound">rl</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">rl</span><span class="main">)</span> <span class="main">(</span>Node <span class="main">(</span>rsub <span class="bound">rl</span><span class="main">)</span> B <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> balanceR <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
    <span class="keyword1">else</span> balanceR <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"balance l k v r"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"black_depth l = black_depth r"</span><span class="main">]</span><span class="main">)</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_prfstep_check_req</span> <span class="main">(</span><span class="inner_quoted">"balance l k v r"</span><span class="main">,</span> <span class="inner_quoted">"black_depth l = black_depth r"</span><span class="main">)</span>›</span>

<span class="keyword1" id="RBTree-balance_non_Leaf"><span class="command">lemma</span></span> balance_non_Leaf <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"balance <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span> <span class="main">≠</span> Leaf"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-balance_bdinv"><span class="command">lemma</span></span> balance_bdinv <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bd_inv <span class="free">l</span> <span class="main">⟹</span> bd_inv <span class="free">r</span> <span class="main">⟹</span> black_depth <span class="free">l</span> <span class="main">=</span> black_depth <span class="free">r</span> <span class="main">⟹</span> bd_inv <span class="main">(</span>balance <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"bd_inv <span class="main">(</span>balanceR <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="RBTree-balance_bd"><span class="command">lemma</span></span> balance_bd <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bd_inv <span class="free">l</span> <span class="main">⟹</span> bd_inv <span class="free">r</span> <span class="main">⟹</span> black_depth <span class="free">l</span> <span class="main">=</span> black_depth <span class="free">r</span> <span class="main">⟹</span>
   black_depth <span class="main">(</span>balance <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> black_depth <span class="free">l</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"black_depth <span class="main">(</span>balanceR <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> black_depth <span class="free">l</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="RBTree-balance_cl1"><span class="command">lemma</span></span> balance_cl1 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cl_inv' <span class="free">l</span> <span class="main">⟹</span> cl_inv <span class="free">r</span> <span class="main">⟹</span> cl_inv <span class="main">(</span>balance <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-balance_cl2"><span class="command">lemma</span></span> balance_cl2 <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cl_inv <span class="free">l</span> <span class="main">⟹</span> cl_inv' <span class="free">r</span> <span class="main">⟹</span> cl_inv <span class="main">(</span>balance <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-balanceR_inorder_pairs"><span class="command">lemma</span></span> balanceR_inorder_pairs <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_in_traverse_pairs <span class="main">(</span>balanceR <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> rbt_in_traverse_pairs <span class="free">l</span> <span class="main">@</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> rbt_in_traverse_pairs <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-balance_inorder_pairs"><span class="command">lemma</span></span> balance_inorder_pairs <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_in_traverse_pairs <span class="main">(</span>balance <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> rbt_in_traverse_pairs <span class="free">l</span> <span class="main">@</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> rbt_in_traverse_pairs <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">del_prfstep_thm</span> <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> balanceR_def<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> balance_def<span class="antiquote">}</span></span></span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ins function›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ins</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> Leaf <span class="main">=</span> Node Leaf R <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> Leaf"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> B <span class="keyword1">then</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> B <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> balance <span class="main">(</span><span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
      <span class="keyword1">else</span> balance <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">(</span><span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> R <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Node <span class="main">(</span><span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> R <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
      <span class="keyword1">else</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> R <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">(</span><span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ins.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="RBTree-ins_non_Leaf"><span class="command">lemma</span></span> ins_non_Leaf <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="free">x</span> <span class="free">v</span> <span class="free">t</span> <span class="main">≠</span> Leaf"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="RBTree-cl_inv_ins"><span class="command">lemma</span></span> cl_inv_ins <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cl_inv <span class="free">t</span> <span class="main">⟹</span> cl_inv' <span class="main">(</span>ins <span class="free">x</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="quoted"><span class="quoted">"cl_inv <span class="free">t</span> <span class="main">⟶</span> <span class="main">(</span><span class="keyword1">if</span> cl <span class="free">t</span> <span class="main">=</span> B <span class="keyword1">then</span> cl_inv <span class="main">(</span>ins <span class="free">x</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">else</span> cl_inv' <span class="main">(</span>ins <span class="free">x</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="RBTree-bd_inv_ins"><span class="command">lemma</span></span> bd_inv_ins<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bd_inv <span class="free">t</span> <span class="main">⟹</span> bd_inv <span class="main">(</span>ins <span class="free">x</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> black_depth <span class="free">t</span> <span class="main">=</span> black_depth <span class="main">(</span>ins <span class="free">x</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="main">(</span><span class="entity">conj_left_th</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> bd_inv_ins<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"ins ?x ?v ?t"</span><span class="main">]</span>›</span>

<span class="keyword1" id="RBTree-ins_inorder_pairs"><span class="command">lemma</span></span> ins_inorder_pairs <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t</span> <span class="main">⟹</span> rbt_in_traverse_pairs <span class="main">(</span>ins <span class="free">x</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> ordered_insert_pairs <span class="free">x</span> <span class="free">v</span> <span class="main">(</span>rbt_in_traverse_pairs <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Paint function›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">paint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"color <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">paint</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> Leaf <span class="main">=</span> Leaf"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">paint</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> paint.simps<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"paint c t"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"t ≠ Leaf"</span><span class="main">]</span><span class="main">)</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_prfstep_check_req</span> <span class="main">(</span><span class="inner_quoted">"paint c t"</span><span class="main">,</span> <span class="inner_quoted">"t ≠ Leaf"</span><span class="main">)</span>›</span>

<span class="keyword1" id="RBTree-paint_cl_inv'"><span class="command">lemma</span></span> paint_cl_inv' <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cl_inv' <span class="free">t</span> <span class="main">⟹</span> cl_inv' <span class="main">(</span>paint <span class="free">c</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-paint_bd_inv"><span class="command">lemma</span></span> paint_bd_inv <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bd_inv <span class="free">t</span> <span class="main">⟹</span> bd_inv <span class="main">(</span>paint <span class="free">c</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-paint_bd"><span class="command">lemma</span></span> paint_bd <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bd_inv <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> cl <span class="free">t</span> <span class="main">=</span> B <span class="main">⟹</span> black_depth <span class="main">(</span>paint R <span class="free">t</span><span class="main">)</span> <span class="main">=</span> black_depth <span class="free">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-paint_in_traverse_pairs"><span class="command">lemma</span></span> paint_in_traverse_pairs <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_in_traverse_pairs <span class="main">(</span>paint <span class="free">c</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> rbt_in_traverse_pairs <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Insert function›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rbt_insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> paint B <span class="main">(</span>ins <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness results for insertion.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> insert_is_rbt <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span> <span class="main">⟹</span> is_rbt <span class="main">(</span>rbt_insert <span class="free">x</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> insert_sorted <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t</span> <span class="main">⟹</span> rbt_sorted <span class="main">(</span>rbt_insert <span class="free">x</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> insert_rbt_map <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t</span> <span class="main">⟹</span> rbt_map <span class="main">(</span>rbt_insert <span class="free">x</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rbt_map <span class="free">t</span><span class="main">)</span> <span class="main">{</span><span class="free">x</span> <span class="main">→</span> <span class="free">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Search on sorted trees and its correctness›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rbt_search</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>ord<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_search</span> Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rbt_search</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">w</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free">rbt_search</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>
   <span class="keyword1">else</span> <span class="free">rbt_search</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rbt_search.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of search›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> rbt_search_correct <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t</span> <span class="main">⟹</span> rbt_search <span class="free">t</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>rbt_map <span class="free">t</span><span class="main">)</span><span class="main">⟨</span><span class="free">x</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword1"><span class="command">@qed</span></span>
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹balL and balR›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">balL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">balL</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">lr</span> <span class="main">=</span> lsub <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">in</span>
   <span class="keyword1">if</span> cl <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> R <span class="keyword1">then</span> Node <span class="main">(</span>Node <span class="main">(</span>lsub <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> B <span class="main">(</span>key <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>rsub <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> R <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> R <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> cl <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> B <span class="keyword1">then</span> balance <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Node <span class="main">(</span>lsub <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> R <span class="main">(</span>key <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>rsub <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">lr</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> R <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> cl <span class="bound">lr</span> <span class="main">=</span> B <span class="keyword1">then</span>
     Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> B <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>lsub <span class="bound">lr</span><span class="main">)</span><span class="main">)</span> R <span class="main">(</span>key <span class="bound">lr</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">lr</span><span class="main">)</span> <span class="main">(</span>balance <span class="main">(</span>rsub <span class="bound">lr</span><span class="main">)</span> <span class="main">(</span>key <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>paint R <span class="main">(</span>rsub <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="keyword1">else</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> R <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"balL l k v r"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"black_depth l + 1 = black_depth r"</span><span class="main">]</span><span class="main">)</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_prfstep_check_req</span> <span class="main">(</span><span class="inner_quoted">"balL l k v r"</span><span class="main">,</span> <span class="inner_quoted">"black_depth l + 1 = black_depth r"</span><span class="main">)</span>›</span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">balR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">balR</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">rl</span> <span class="main">=</span> rsub <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span>
   <span class="keyword1">if</span> cl <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> R <span class="keyword1">then</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> R <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Node <span class="main">(</span>lsub <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> B <span class="main">(</span>key <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>rsub <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> R <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> cl <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> B <span class="keyword1">then</span> balance <span class="main">(</span>Node <span class="main">(</span>lsub <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> R <span class="main">(</span>key <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>rsub <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">rl</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> R <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> cl <span class="bound">rl</span> <span class="main">=</span> B <span class="keyword1">then</span>
     Node <span class="main">(</span>balance <span class="main">(</span>paint R <span class="main">(</span>lsub <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>key <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>lsub <span class="bound">rl</span><span class="main">)</span><span class="main">)</span> R <span class="main">(</span>key <span class="bound">rl</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">rl</span><span class="main">)</span> <span class="main">(</span>Node <span class="main">(</span>rsub <span class="bound">rl</span><span class="main">)</span> B <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
   <span class="keyword1">else</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> R <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"balR l k v r"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"black_depth l = black_depth r + 1"</span><span class="main">]</span><span class="main">)</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_prfstep_check_req</span> <span class="main">(</span><span class="inner_quoted">"balR l k v r"</span><span class="main">,</span> <span class="inner_quoted">"black_depth l = black_depth r + 1"</span><span class="main">)</span>›</span>

<span class="keyword1" id="RBTree-balL_bd"><span class="command">lemma</span></span> balL_bd <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bd_inv <span class="free">l</span> <span class="main">⟹</span> bd_inv <span class="free">r</span> <span class="main">⟹</span> cl <span class="free">r</span> <span class="main">=</span> B <span class="main">⟹</span> black_depth <span class="free">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> black_depth <span class="free">r</span> <span class="main">⟹</span>
   bd_inv <span class="main">(</span>balL <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> black_depth <span class="main">(</span>balL <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> black_depth <span class="free">l</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-balL_bd'"><span class="command">lemma</span></span> balL_bd' <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bd_inv <span class="free">l</span> <span class="main">⟹</span> bd_inv <span class="free">r</span> <span class="main">⟹</span> cl_inv <span class="free">r</span> <span class="main">⟹</span> black_depth <span class="free">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> black_depth <span class="free">r</span> <span class="main">⟹</span>
   bd_inv <span class="main">(</span>balL <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> black_depth <span class="main">(</span>balL <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> black_depth <span class="free">l</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-balL_cl"><span class="command">lemma</span></span> balL_cl <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cl_inv' <span class="free">l</span> <span class="main">⟹</span> cl_inv <span class="free">r</span> <span class="main">⟹</span> cl <span class="free">r</span> <span class="main">=</span> B <span class="main">⟹</span> cl_inv <span class="main">(</span>balL <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-balL_cl'"><span class="command">lemma</span></span> balL_cl' <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cl_inv' <span class="free">l</span> <span class="main">⟹</span> cl_inv <span class="free">r</span> <span class="main">⟹</span> cl_inv' <span class="main">(</span>balL <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-balR_bd"><span class="command">lemma</span></span> balR_bd <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bd_inv <span class="free">l</span> <span class="main">⟹</span> bd_inv <span class="free">r</span> <span class="main">⟹</span> cl_inv <span class="free">l</span> <span class="main">⟹</span> black_depth <span class="free">l</span> <span class="main">=</span> black_depth <span class="free">r</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span>
   bd_inv <span class="main">(</span>balR <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> black_depth <span class="main">(</span>balR <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> black_depth <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-balR_cl"><span class="command">lemma</span></span> balR_cl <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cl_inv <span class="free">l</span> <span class="main">⟹</span> cl_inv' <span class="free">r</span> <span class="main">⟹</span> cl <span class="free">l</span> <span class="main">=</span> B <span class="main">⟹</span> cl_inv <span class="main">(</span>balR <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-balR_cl'"><span class="command">lemma</span></span> balR_cl' <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cl_inv <span class="free">l</span> <span class="main">⟹</span> cl_inv' <span class="free">r</span> <span class="main">⟹</span> cl_inv' <span class="main">(</span>balR <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-balL_in_traverse_pairs"><span class="command">lemma</span></span> balL_in_traverse_pairs <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_in_traverse_pairs <span class="main">(</span>balL <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> rbt_in_traverse_pairs <span class="free">l</span> <span class="main">@</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> rbt_in_traverse_pairs <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree-balR_in_traverse_pairs"><span class="command">lemma</span></span> balR_in_traverse_pairs <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_in_traverse_pairs <span class="main">(</span>balR <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> rbt_in_traverse_pairs <span class="free">l</span> <span class="main">@</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> rbt_in_traverse_pairs <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">del_prfstep_thm</span> <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> balL_def<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> balR_def<span class="antiquote">}</span></span></span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Combine›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combine</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">combine</span> Leaf <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> Leaf <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">k1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">k2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> R <span class="keyword1">then</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">=</span> R <span class="keyword1">then</span>
       <span class="keyword1">let</span> <span class="bound">tm</span> <span class="main">=</span> <span class="free">combine</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="keyword1">in</span>
         <span class="keyword1">if</span> cl <span class="bound">tm</span> <span class="main">=</span> R <span class="keyword1">then</span>
           Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l1</span></span></span> R <span class="free"><span class="bound"><span class="entity">k1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">(</span>lsub <span class="bound">tm</span><span class="main">)</span><span class="main">)</span> R <span class="main">(</span>key <span class="bound">tm</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">tm</span><span class="main">)</span> <span class="main">(</span>Node <span class="main">(</span>rsub <span class="bound">tm</span><span class="main">)</span> R <span class="free"><span class="bound"><span class="entity">k2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>
         <span class="keyword1">else</span>
           Node <span class="free"><span class="bound"><span class="entity">l1</span></span></span> R <span class="free"><span class="bound"><span class="entity">k1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">(</span>Node <span class="bound">tm</span> R <span class="free"><span class="bound"><span class="entity">k2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span>
       Node <span class="free"><span class="bound"><span class="entity">l1</span></span></span> R <span class="free"><span class="bound"><span class="entity">k1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">(</span><span class="free">combine</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">k2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span><span class="main">)</span>
   <span class="keyword1">else</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">=</span> B <span class="keyword1">then</span>
       <span class="keyword1">let</span> <span class="bound">tm</span> <span class="main">=</span> <span class="free">combine</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="keyword1">in</span>
         <span class="keyword1">if</span> cl <span class="bound">tm</span> <span class="main">=</span> R <span class="keyword1">then</span>
           Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l1</span></span></span> B <span class="free"><span class="bound"><span class="entity">k1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">(</span>lsub <span class="bound">tm</span><span class="main">)</span><span class="main">)</span> R <span class="main">(</span>key <span class="bound">tm</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">tm</span><span class="main">)</span> <span class="main">(</span>Node <span class="main">(</span>rsub <span class="bound">tm</span><span class="main">)</span> B <span class="free"><span class="bound"><span class="entity">k2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>
         <span class="keyword1">else</span>
           balL <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">k1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">(</span>Node <span class="bound">tm</span> B <span class="free"><span class="bound"><span class="entity">k2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span>
       Node <span class="main">(</span><span class="free">combine</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">k1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> R <span class="free"><span class="bound"><span class="entity">k2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> combine.simps<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="RBTree-combine_bd"><span class="command">lemma</span></span> combine_bd <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bd_inv <span class="free">lt</span> <span class="main">⟹</span> bd_inv <span class="free">rt</span> <span class="main">⟹</span> black_depth <span class="free">lt</span> <span class="main">=</span> black_depth <span class="free">rt</span> <span class="main">⟹</span>
   bd_inv <span class="main">(</span>combine <span class="free">lt</span> <span class="free">rt</span><span class="main">)</span> <span class="main">∧</span> black_depth <span class="main">(</span>combine <span class="free">lt</span> <span class="free">rt</span><span class="main">)</span> <span class="main">=</span> black_depth <span class="free">lt</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"combine <span class="free">lt</span> <span class="free">rt</span>"</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">lt</span> <span class="main">=</span> Node <span class="free">l1</span> <span class="free">c1</span> <span class="free">k1</span> <span class="free">v1</span> <span class="free">r1</span><span class="main">,</span> <span class="free">rt</span> <span class="main">=</span> Node <span class="free">l2</span> <span class="free">c2</span> <span class="free">k2</span> <span class="free">v2</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"combine <span class="main">(</span>Node <span class="free">l1</span> <span class="free">c1</span> <span class="free">k1</span> <span class="free">v1</span> <span class="free">r1</span><span class="main">)</span> <span class="main">(</span>Node <span class="free">l2</span> <span class="free">c2</span> <span class="free">k2</span> <span class="free">v2</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">=</span> B"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">=</span> B"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"cl <span class="main">(</span>combine <span class="free">r1</span> <span class="free">l2</span><span class="main">)</span> <span class="main">=</span> B"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"cl <span class="main">(</span>Node <span class="main">(</span>combine <span class="free">r1</span> <span class="free">l2</span><span class="main">)</span> B <span class="free">k2</span> <span class="free">v2</span> <span class="free">r2</span><span class="main">)</span> <span class="main">=</span> B"</span></span> <span class="keyword1"><span class="command">@end</span></span> <span class="keyword1"><span class="command">@end</span></span> <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="RBTree-combine_cl"><span class="command">lemma</span></span> combine_cl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cl_inv <span class="free">lt</span> <span class="main">⟹</span> cl_inv <span class="free">rt</span> <span class="main">⟹</span>
   <span class="main">(</span>cl <span class="free">lt</span> <span class="main">=</span> B <span class="main">⟶</span> cl <span class="free">rt</span> <span class="main">=</span> B <span class="main">⟶</span> cl_inv <span class="main">(</span>combine <span class="free">lt</span> <span class="free">rt</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> cl_inv' <span class="main">(</span>combine <span class="free">lt</span> <span class="free">rt</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"combine <span class="free">lt</span> <span class="free">rt</span>"</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">lt</span> <span class="main">=</span> Node <span class="free">l1</span> <span class="free">c1</span> <span class="free">k1</span> <span class="free">v1</span> <span class="free">r1</span><span class="main">,</span> <span class="free">rt</span> <span class="main">=</span> Node <span class="free">l2</span> <span class="free">c2</span> <span class="free">k2</span> <span class="free">v2</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"combine <span class="main">(</span>Node <span class="free">l1</span> <span class="free">c1</span> <span class="free">k1</span> <span class="free">v1</span> <span class="free">r1</span><span class="main">)</span> <span class="main">(</span>Node <span class="free">l2</span> <span class="free">c2</span> <span class="free">k2</span> <span class="free">v2</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">=</span> B"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">=</span> B"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"cl <span class="main">(</span>combine <span class="free">r1</span> <span class="free">l2</span><span class="main">)</span> <span class="main">=</span> B"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"cl <span class="main">(</span>Node <span class="main">(</span>combine <span class="free">r1</span> <span class="free">l2</span><span class="main">)</span> B <span class="free">k2</span> <span class="free">v2</span> <span class="free">r2</span><span class="main">)</span> <span class="main">=</span> B"</span></span> <span class="keyword1"><span class="command">@end</span></span> <span class="keyword1"><span class="command">@end</span></span> <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> combine_cl<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"combine ?lt ?rt"</span><span class="main">]</span>›</span>

<span class="keyword1" id="RBTree-combine_in_traverse_pairs"><span class="command">lemma</span></span> combine_in_traverse_pairs <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_in_traverse_pairs <span class="main">(</span>combine <span class="free">lt</span> <span class="free">rt</span><span class="main">)</span> <span class="main">=</span> rbt_in_traverse_pairs <span class="free">lt</span> <span class="main">@</span> rbt_in_traverse_pairs <span class="free">rt</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"combine <span class="free">lt</span> <span class="free">rt</span>"</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">lt</span> <span class="main">=</span> Node <span class="free">l1</span> <span class="free">c1</span> <span class="free">k1</span> <span class="free">v1</span> <span class="free">r1</span><span class="main">,</span> <span class="free">rt</span> <span class="main">=</span> Node <span class="free">l2</span> <span class="free">c2</span> <span class="free">k2</span> <span class="free">v2</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"combine <span class="main">(</span>Node <span class="free">l1</span> <span class="free">c1</span> <span class="free">k1</span> <span class="free">v1</span> <span class="free">r1</span><span class="main">)</span> <span class="main">(</span>Node <span class="free">l2</span> <span class="free">c2</span> <span class="free">k2</span> <span class="free">v2</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">=</span> R"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">=</span> R"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"cl <span class="main">(</span>combine <span class="free">r1</span> <span class="free">l2</span><span class="main">)</span> <span class="main">=</span> R"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"rbt_in_traverse_pairs <span class="main">(</span>combine <span class="main">(</span>Node <span class="free">l1</span> <span class="free">c1</span> <span class="free">k1</span> <span class="free">v1</span> <span class="free">r1</span><span class="main">)</span> <span class="main">(</span>Node <span class="free">l2</span> <span class="free">c2</span> <span class="free">k2</span> <span class="free">v2</span> <span class="free">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             rbt_in_traverse_pairs <span class="free">l1</span> <span class="main">@</span> <span class="main">(</span><span class="free">k1</span><span class="main">,</span> <span class="free">v1</span><span class="main">)</span> <span class="main">#</span> rbt_in_traverse_pairs <span class="main">(</span>combine <span class="free">r1</span> <span class="free">l2</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">k2</span><span class="main">,</span> <span class="free">v2</span><span class="main">)</span> <span class="main">#</span> rbt_in_traverse_pairs <span class="free">r2</span>"</span></span>
    <span class="keyword1"><span class="command">@end</span></span> <span class="keyword1"><span class="command">@end</span></span> <span class="keyword1"><span class="command">@end</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">=</span> B"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">=</span> B"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"cl <span class="main">(</span>combine <span class="free">r1</span> <span class="free">l2</span><span class="main">)</span> <span class="main">=</span> R"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"rbt_in_traverse_pairs <span class="main">(</span>combine <span class="main">(</span>Node <span class="free">l1</span> <span class="free">c1</span> <span class="free">k1</span> <span class="free">v1</span> <span class="free">r1</span><span class="main">)</span> <span class="main">(</span>Node <span class="free">l2</span> <span class="free">c2</span> <span class="free">k2</span> <span class="free">v2</span> <span class="free">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             rbt_in_traverse_pairs <span class="free">l1</span> <span class="main">@</span> <span class="main">(</span><span class="free">k1</span><span class="main">,</span> <span class="free">v1</span><span class="main">)</span> <span class="main">#</span> rbt_in_traverse_pairs <span class="main">(</span>combine <span class="free">r1</span> <span class="free">l2</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">k2</span><span class="main">,</span> <span class="free">v2</span><span class="main">)</span> <span class="main">#</span> rbt_in_traverse_pairs <span class="free">r2</span>"</span></span>
    <span class="keyword1"><span class="command">@end</span></span> <span class="keyword1"><span class="command">@end</span></span> <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Deletion›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">del</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf <span class="main">=</span> Leaf"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> combine <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span>
       <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Node Leaf R <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> cl <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> B <span class="keyword1">then</span> balL <span class="main">(</span><span class="free">del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
       <span class="keyword1">else</span> Node <span class="main">(</span><span class="free">del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> R <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
     <span class="keyword1">else</span>
       <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> R <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> Leaf
       <span class="keyword1">else</span> <span class="keyword1">if</span> cl <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> B <span class="keyword1">then</span> balR <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free">del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
       <span class="keyword1">else</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> R <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free">del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> del.simps<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="RBTree-del_bd"><span class="command">lemma</span></span> del_bd <span class="main">[</span><span class="operator">forward_arg</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bd_inv <span class="free">t</span> <span class="main">⟹</span> cl_inv <span class="free">t</span> <span class="main">⟹</span> bd_inv <span class="main">(</span>del <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
    <span class="keyword1">if</span> cl <span class="free">t</span> <span class="main">=</span> R <span class="keyword1">then</span> black_depth <span class="main">(</span>del <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> black_depth <span class="free">t</span>
    <span class="keyword1">else</span> black_depth <span class="main">(</span>del <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> black_depth <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"del <span class="free">x</span> <span class="main">(</span>Node <span class="free">l</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"cl <span class="free">l</span> <span class="main">=</span> B"</span></span> <span class="keyword1"><span class="command">@end</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="free">k</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"cl <span class="free">r</span> <span class="main">=</span> B"</span></span> <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="RBTree-del_cl"><span class="command">lemma</span></span> del_cl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cl_inv <span class="free">t</span> <span class="main">⟹</span> <span class="keyword1">if</span> cl <span class="free">t</span> <span class="main">=</span> R <span class="keyword1">then</span> cl_inv <span class="main">(</span>del <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">else</span> cl_inv' <span class="main">(</span>del <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"del <span class="free">x</span> <span class="main">(</span>Node <span class="free">l</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> del_cl<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"del ?x ?t"</span><span class="main">]</span>›</span>

<span class="keyword1" id="RBTree-del_in_traverse_pairs"><span class="command">lemma</span></span> del_in_traverse_pairs <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t</span> <span class="main">⟹</span> rbt_in_traverse_pairs <span class="main">(</span>del <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> remove_elt_pairs <span class="free">x</span> <span class="main">(</span>rbt_in_traverse_pairs <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"del <span class="free">x</span> <span class="main">(</span>Node <span class="free">l</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> paint B <span class="main">(</span>del <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness results for deletion.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> delete_is_rbt <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span> <span class="main">⟹</span> is_rbt <span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> delete_sorted <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t</span> <span class="main">⟹</span> rbt_sorted <span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> delete_rbt_map <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t</span> <span class="main">⟹</span> rbt_map <span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> delete_map <span class="free">x</span> <span class="main">(</span>rbt_map <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep</span> <span class="inner_quoted">"RBTree.balance_case"</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep</span> <span class="inner_quoted">"RBTree.balL_case"</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep</span> <span class="inner_quoted">"RBTree.balR_case"</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep</span> <span class="inner_quoted">"RBTree.paint_case"</span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Rect_Intersect">
<div class="head">
<h1>Theory Rect_Intersect</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Rect_Intersect.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Rectangle intersection›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Rect_Intersect
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Interval_Tree.html">Interval_Tree</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Functional version of algorithm for detecting rectangle intersection.
  See \cite[Exercise 14.3-7]{cormen2009introduction} for a reference.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of rectangles›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> rectangle <span class="main">=</span> Rectangle <span class="main">(</span><span class="free"><span class="entity">xint</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interval"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">yint</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interval"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_simple_datatype</span> <span class="inner_quoted">"rectangle"</span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_rect</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> rectangle <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_rect</span> <span class="free"><span class="bound"><span class="entity">rect</span></span></span> <span class="main">⟷</span> is_interval <span class="main">(</span>xint <span class="free"><span class="bound"><span class="entity">rect</span></span></span><span class="main">)</span> <span class="main">∧</span> is_interval <span class="main">(</span>yint <span class="free"><span class="bound"><span class="entity">rect</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_rect_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> rectangle list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_rect_list</span> <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">rects</span></span></span><span class="main">.</span> is_rect <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Rect_Intersect-is_rect_listD"><span class="command">lemma</span></span> is_rect_listD<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rect_list <span class="free">rects</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">rects</span> <span class="main">⟹</span> is_rect <span class="main">(</span><span class="free">rects</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> is_rect_listD<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"?rects ! ?i"</span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm_eqforward</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> is_rect_list_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_rect_overlap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> rectangle <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> rectangle <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_rect_overlap</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟷</span> <span class="main">(</span>is_overlap <span class="main">(</span>xint <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>xint <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">∧</span> is_overlap <span class="main">(</span>yint <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>yint <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_rect_overlap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> rectangle list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_rect_overlap</span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">As</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">As</span></span></span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">∧</span> is_rect_overlap <span class="main">(</span><span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹INS / DEL operations›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> operation <span class="main">=</span>
  INS <span class="main">(</span><span class="free"><span class="entity">pos</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">op_idx</span></span><span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">op_int</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interval"</span></span><span class="main">)</span>
<span class="main">|</span> DEL <span class="main">(</span>pos<span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="main">(</span>op_idx<span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span> <span class="main">(</span>op_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> interval"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule_back</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> operation.collapse<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> operation.sel<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> operation.case<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_resolve_prfstep</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> operation.distinct<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> operation.disc<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"INS ?x11.0 ?x12.0 ?x13.0"</span><span class="main">]</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> operation.disc<span class="main">(</span>2<span class="main">)</span><span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"DEL ?x21.0 ?x22.0 ?x23.0"</span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">instantiation</span></span> operation <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">linorder</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> pos <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≠</span> pos <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> pos <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> pos <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">else</span>
                             <span class="keyword1">if</span> is_INS <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≠</span> is_INS <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> is_INS <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∧</span> <span class="main">¬</span>is_INS <span class="free"><span class="bound"><span class="entity">b</span></span></span>
                             <span class="keyword1">else</span> <span class="keyword1">if</span> op_idx <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≠</span> op_idx <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> op_idx <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> op_idx <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">else</span> op_int <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> op_int <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> less_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> pos <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≠</span> pos <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> pos <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> pos <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">else</span>
                              <span class="keyword1">if</span> is_INS <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≠</span> is_INS <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> is_INS <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∧</span> <span class="main">¬</span>is_INS <span class="free"><span class="bound"><span class="entity">b</span></span></span>
                              <span class="keyword1">else</span> <span class="keyword1">if</span> op_idx <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≠</span> op_idx <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> op_idx <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> op_idx <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">else</span> op_int <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> op_int <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> operation"</span></span>
  <span class="keyword3"><span class="command">show</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Rect_Intersect.less Rect_Intersect.less_eq leD le_cases3 not_less_iff_gr_or_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.less_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Rect_Intersect.less Rect_Intersect.less_eq a dual_order.trans less_trans<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Rect_Intersect.less Rect_Intersect.less_eq a le_imp_less_or_eq operation.expand<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local.less_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> less_eq<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> less<span class="antiquote">}</span></span></span><span class="main">]</span>›</span>

<span class="keyword1" id="Rect_Intersect-operation_leD"><span class="command">lemma</span></span> operation_leD <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder operation<span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> pos <span class="free">a</span> <span class="main">≤</span> pos <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Rect_Intersect-operation_lessI"><span class="command">lemma</span></span> operation_lessI <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="free">p2</span> <span class="main">⟹</span> INS <span class="free">p1</span> <span class="free">n1</span> <span class="free">i1</span> <span class="main">&lt;</span> DEL <span class="free">p2</span> <span class="free">n2</span> <span class="free">i2</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_INS <span class="main">(</span>INS <span class="free">p1</span> <span class="free">n1</span> <span class="free">i1</span><span class="main">)</span> <span class="main">=</span> True"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_INS <span class="main">(</span>DEL <span class="free">p2</span> <span class="free">n2</span> <span class="free">i2</span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">del_prfstep_thm</span> <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> less_eq<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> less<span class="antiquote">}</span></span></span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Set of operations corresponding to a list of rectangles›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ins_op</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rectangle list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> operation"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ins_op</span> <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> INS <span class="main">(</span>low <span class="main">(</span>yint <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>xint <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> ins_op.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">del_op</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rectangle list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> operation"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">del_op</span> <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> DEL <span class="main">(</span>high <span class="main">(</span>yint <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>xint <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> del_op.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ins_ops</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rectangle list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> operation list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ins_ops</span> <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">=</span> list <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ins_op <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">rects</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">del_ops</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rectangle list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> operation list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">del_ops</span> <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">=</span> list <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> del_op <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">rects</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Rect_Intersect-ins_ops_distinct"><span class="command">lemma</span></span> ins_ops_distinct <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>ins_ops <span class="free">rects</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> ins_ops <span class="free">rects</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Rect_Intersect-del_ops_distinct"><span class="command">lemma</span></span> del_ops_distinct <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>del_ops <span class="free">rects</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> del_ops <span class="free">rects</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Rect_Intersect-set_ins_ops"><span class="command">lemma</span></span> set_ins_ops <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">oper</span> <span class="main">∈</span> set <span class="main">(</span>ins_ops <span class="free">rects</span><span class="main">)</span> <span class="main">⟷</span> op_idx <span class="free">oper</span> <span class="main">&lt;</span> length <span class="free">rects</span> <span class="main">∧</span> <span class="free">oper</span> <span class="main">=</span> ins_op <span class="free">rects</span> <span class="main">(</span>op_idx <span class="free">oper</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">oper</span> <span class="main">∈</span> set <span class="main">(</span>ins_ops <span class="free">rects</span><span class="main">)</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">rects</span>"</span></span> <span class="quoted"><span class="quoted">"ins_ops <span class="free">rects</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">oper</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"op_idx <span class="free">oper</span> <span class="main">&lt;</span> length <span class="free">rects</span> <span class="main">∧</span> <span class="free">oper</span> <span class="main">=</span> ins_op <span class="free">rects</span> <span class="main">(</span>op_idx <span class="free">oper</span><span class="main">)</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">oper</span> <span class="main">=</span> <span class="main">(</span>ins_ops <span class="free">rects</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>op_idx <span class="free">oper</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Rect_Intersect-set_del_ops"><span class="command">lemma</span></span> set_del_ops <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">oper</span> <span class="main">∈</span> set <span class="main">(</span>del_ops <span class="free">rects</span><span class="main">)</span> <span class="main">⟷</span> op_idx <span class="free">oper</span> <span class="main">&lt;</span> length <span class="free">rects</span> <span class="main">∧</span> <span class="free">oper</span> <span class="main">=</span> del_op <span class="free">rects</span> <span class="main">(</span>op_idx <span class="free">oper</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">oper</span> <span class="main">∈</span> set <span class="main">(</span>del_ops <span class="free">rects</span><span class="main">)</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">rects</span>"</span></span> <span class="quoted"><span class="quoted">"del_ops <span class="free">rects</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">oper</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"op_idx <span class="free">oper</span> <span class="main">&lt;</span> length <span class="free">rects</span> <span class="main">∧</span> <span class="free">oper</span> <span class="main">=</span> del_op <span class="free">rects</span> <span class="main">(</span>op_idx <span class="free">oper</span><span class="main">)</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">oper</span> <span class="main">=</span> <span class="main">(</span>del_ops <span class="free">rects</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>op_idx <span class="free">oper</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_ops</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rectangle list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> operation list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">all_ops</span> <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">=</span> sort <span class="main">(</span>ins_ops <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">@</span> del_ops <span class="free"><span class="bound"><span class="entity">rects</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Rect_Intersect-all_ops_distinct"><span class="command">lemma</span></span> all_ops_distinct <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>ins_ops <span class="free">rects</span> <span class="main">@</span> del_ops <span class="free">rects</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Rect_Intersect-set_all_ops_idx"><span class="command">lemma</span></span> set_all_ops_idx <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">oper</span> <span class="main">∈</span> set <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span> <span class="main">⟹</span> op_idx <span class="free">oper</span> <span class="main">&lt;</span> length <span class="free">rects</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Rect_Intersect-set_all_ops_ins"><span class="command">lemma</span></span> set_all_ops_ins <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"INS <span class="free">p</span> <span class="free">n</span> <span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span> <span class="main">⟹</span> INS <span class="free">p</span> <span class="free">n</span> <span class="free">i</span> <span class="main">=</span> ins_op <span class="free">rects</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Rect_Intersect-set_all_ops_del"><span class="command">lemma</span></span> set_all_ops_del <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DEL <span class="free">p</span> <span class="free">n</span> <span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span> <span class="main">⟹</span> DEL <span class="free">p</span> <span class="free">n</span> <span class="free">i</span> <span class="main">=</span> del_op <span class="free">rects</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Rect_Intersect-ins_in_set_all_ops"><span class="command">lemma</span></span> ins_in_set_all_ops<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">rects</span> <span class="main">⟹</span> ins_op <span class="free">rects</span> <span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> ins_in_set_all_ops<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"ins_op ?rects ?i"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Rect_Intersect-del_in_set_all_ops"><span class="command">lemma</span></span> del_in_set_all_ops<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">rects</span> <span class="main">⟹</span> del_op <span class="free">rects</span> <span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> del_in_set_all_ops<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"del_op ?rects ?i"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Rect_Intersect-all_ops_sorted"><span class="command">lemma</span></span> all_ops_sorted <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Rect_Intersect-all_ops_nonempty"><span class="command">lemma</span></span> all_ops_nonempty <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rects</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> all_ops <span class="free">rects</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> all_ops_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Applying a set of operations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">apply_ops_k</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> rectangle list <span class="main">⇒</span> nat <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">apply_ops_k</span> <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">ops</span> <span class="main">=</span> all_ops <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="keyword1">in</span>
     <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> ins_op <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">ops</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> del_op <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">ops</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"apply_ops_k rects k"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"k &lt; length (all_ops rects)"</span><span class="main">]</span><span class="main">)</span>›</span>

<span class="keyword1" id="Rect_Intersect-apply_ops_set_mem"><span class="command">lemma</span></span> apply_ops_set_mem <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">=</span> all_ops <span class="free">rects</span> <span class="main">⟹</span>
   <span class="free">i</span> <span class="main">∈</span> apply_ops_k <span class="free">rects</span> <span class="free">k</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> length <span class="free">rects</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> ins_op <span class="free">rects</span> <span class="free">i</span> <span class="main">=</span> <span class="free">ops</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> del_op <span class="free">rects</span> <span class="free">i</span> <span class="main">=</span> <span class="free">ops</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> apply_ops_k_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">xints_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rectangle list <span class="main">⇒</span> nat set <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> idx_interval<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xints_of</span> <span class="free"><span class="bound"><span class="entity">rect</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> IdxInterval <span class="main">(</span>xint <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rect</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span>"</span></span>

<span class="keyword1" id="Rect_Intersect-xints_of_mem"><span class="command">lemma</span></span> xints_of_mem <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"IdxInterval <span class="free">it</span> <span class="free">i</span> <span class="main">∈</span> xints_of <span class="free">rect</span> <span class="free">is</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span> <span class="main">∈</span> <span class="free">is</span> <span class="main">∧</span> xint <span class="main">(</span><span class="free">rect</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">it</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xints_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Rect_Intersect-xints_diff"><span class="command">lemma</span></span> xints_diff <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"xints_of <span class="free">rects</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> xints_of <span class="free">rects</span> <span class="free">A</span> <span class="main">-</span> xints_of <span class="free">rects</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> IdxInterval <span class="main">(</span>xint <span class="main">(</span><span class="free">rects</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_overlap_at_k</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> rectangle list <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_overlap_at_k</span> <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">⟷</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">S</span> <span class="main">=</span> apply_ops_k <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span> <span class="bound">ops</span> <span class="main">=</span> all_ops <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="keyword1">in</span>
      is_INS <span class="main">(</span><span class="bound">ops</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">∧</span> has_overlap <span class="main">(</span>xints_of <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>op_int <span class="main">(</span><span class="bound">ops</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"has_overlap_at_k rects k"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"k &lt; length (all_ops rects)"</span><span class="main">]</span><span class="main">)</span>›</span>

<span class="keyword1" id="Rect_Intersect-has_overlap_at_k_equiv"><span class="command">lemma</span></span> has_overlap_at_k_equiv <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_rect_list <span class="free">rects</span> <span class="main">⟹</span> <span class="free">ops</span> <span class="main">=</span> all_ops <span class="free">rects</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">ops</span> <span class="main">⟹</span>
   has_overlap_at_k <span class="free">rects</span> <span class="free">k</span> <span class="main">⟹</span> has_rect_overlap <span class="free">rects</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> apply_ops_k <span class="free">rects</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"has_overlap <span class="main">(</span>xints_of <span class="free">rects</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>op_int <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">∈</span> xints_of <span class="free">rects</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"is_overlap <span class="main">(</span>int <span class="free">xs'</span><span class="main">)</span> <span class="main">(</span>op_int <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> int <span class="free">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> idx <span class="free">xs'</span>"</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> op_idx <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> ins_op <span class="free">rects</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@contradiction</span></span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">!</span> <span class="free">k'</span> <span class="main">=</span> ins_op <span class="free">rects</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="free">ops</span> <span class="main">!</span> <span class="free">k'</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"low <span class="main">(</span>yint <span class="main">(</span><span class="free">rects</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> pos <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">!</span> <span class="free">k'</span> <span class="main">=</span> ins_op <span class="free">rects</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">!</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">ops</span> <span class="main">!</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"high <span class="main">(</span>yint <span class="main">(</span><span class="free">rects</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> pos <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">&lt;</span> length <span class="free">ops</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">!</span> <span class="free">k'</span> <span class="main">=</span> del_op <span class="free">rects</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">!</span> <span class="free">k'</span> <span class="main">≥</span> <span class="free">ops</span> <span class="main">!</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_rect_overlap <span class="main">(</span><span class="free">rects</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">rects</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Rect_Intersect-has_overlap_at_k_equiv2"><span class="command">lemma</span></span> has_overlap_at_k_equiv2 <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_rect_list <span class="free">rects</span> <span class="main">⟹</span> <span class="free">ops</span> <span class="main">=</span> all_ops <span class="free">rects</span> <span class="main">⟹</span> has_rect_overlap <span class="free">rects</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>length <span class="free">ops</span><span class="main">.</span> has_overlap_at_k <span class="free">rects</span> <span class="bound">k</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">rects</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">rects</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
                    <span class="quoted"><span class="quoted">"is_rect_overlap <span class="main">(</span><span class="free">rects</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">rects</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_rect_overlap <span class="main">(</span><span class="free">rects</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">rects</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">i1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">&lt;</span> length <span class="free">ops</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">!</span> <span class="free">i1</span> <span class="main">=</span> ins_op <span class="free">rects</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">j1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">j1</span> <span class="main">&lt;</span> length <span class="free">ops</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">!</span> <span class="free">j1</span> <span class="main">=</span> ins_op <span class="free">rects</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">i2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">&lt;</span> length <span class="free">ops</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">!</span> <span class="free">i2</span> <span class="main">=</span> del_op <span class="free">rects</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">j2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">j2</span> <span class="main">&lt;</span> length <span class="free">ops</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">!</span> <span class="free">j2</span> <span class="main">=</span> del_op <span class="free">rects</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"ins_op <span class="free">rects</span> <span class="free">i</span> <span class="main">&lt;</span> ins_op <span class="free">rects</span> <span class="free">j</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">&lt;</span> <span class="free">j1</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j1</span> <span class="main">&lt;</span> <span class="free">i2</span>"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">!</span> <span class="free">j1</span> <span class="main">&lt;</span> <span class="free">ops</span> <span class="main">!</span> <span class="free">i2</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_overlap <span class="main">(</span>int <span class="main">(</span>IdxInterval <span class="main">(</span>xint <span class="main">(</span><span class="free">rects</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>xint <span class="main">(</span><span class="free">rects</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"has_overlap_at_k <span class="free">rects</span> <span class="free">j1</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"ins_op <span class="free">rects</span> <span class="free">j</span> <span class="main">&lt;</span> ins_op <span class="free">rects</span> <span class="free">i</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j1</span> <span class="main">&lt;</span> <span class="free">i1</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">&lt;</span> <span class="free">j2</span>"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">!</span> <span class="free">i1</span> <span class="main">&lt;</span> <span class="free">ops</span> <span class="main">!</span> <span class="free">j2</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"is_overlap <span class="main">(</span>int <span class="main">(</span>IdxInterval <span class="main">(</span>xint <span class="main">(</span><span class="free">rects</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>xint <span class="main">(</span><span class="free">rects</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"has_overlap_at_k <span class="free">rects</span> <span class="free">i1</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_overlap_lst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> rectangle list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_overlap_lst</span> <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">ops</span> <span class="main">=</span> all_ops <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>length <span class="bound">ops</span><span class="main">.</span> has_overlap_at_k <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Rect_Intersect-has_overlap_equiv"><span class="command">lemma</span></span> has_overlap_equiv <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_rect_list <span class="free">rects</span> <span class="main">⟹</span> has_overlap_lst <span class="free">rects</span> <span class="main">⟷</span> has_rect_overlap <span class="free">rects</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Implementation of apply\_ops\_k›</span></span>

<span class="keyword1" id="Rect_Intersect-apply_ops_k_next1"><span class="command">lemma</span></span> apply_ops_k_next1 <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_rect_list <span class="free">rects</span> <span class="main">⟹</span> <span class="free">ops</span> <span class="main">=</span> all_ops <span class="free">rects</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">ops</span> <span class="main">⟹</span> is_INS <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span>
   apply_ops_k <span class="free">rects</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> apply_ops_k <span class="free">rects</span> <span class="free">n</span> <span class="main">∪</span> <span class="main">{</span>op_idx <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span>apply_ops_k <span class="free">rects</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟷</span> <span class="bound">i</span><span class="main">∈</span>apply_ops_k <span class="free">rects</span> <span class="free">n</span> <span class="main">∪</span> <span class="main">{</span>op_idx <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> apply_ops_k <span class="free">rects</span> <span class="free">n</span> <span class="main">∪</span> <span class="main">{</span>op_idx <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> op_idx <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="main">@with</span>
        <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"ins_op <span class="free">rects</span> <span class="free">i</span> <span class="main">&lt;</span> del_op <span class="free">rects</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">@end</span></span>
    <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Rect_Intersect-apply_ops_k_next2"><span class="command">lemma</span></span> apply_ops_k_next2 <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_rect_list <span class="free">rects</span> <span class="main">⟹</span> <span class="free">ops</span> <span class="main">=</span> all_ops <span class="free">rects</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">ops</span> <span class="main">⟹</span> <span class="main">¬</span>is_INS <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span>
   apply_ops_k <span class="free">rects</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> apply_ops_k <span class="free">rects</span> <span class="free">n</span> <span class="main">-</span> <span class="main">{</span>op_idx <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">apply_ops_k_next</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> rectangle list <span class="main">⇒</span> <span class="tfree">'a</span> idx_interval set <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> idx_interval set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">apply_ops_k_next</span> <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">ops</span> <span class="main">=</span> all_ops <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="keyword1">in</span>
   <span class="main">(</span><span class="keyword1">case</span> <span class="bound">ops</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">of</span>
      INS <span class="bound">p</span> <span class="bound">n</span> <span class="bound">i</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∪</span> <span class="main">{</span>IdxInterval <span class="bound">i</span> <span class="bound">n</span><span class="main">}</span>
    <span class="main">|</span> DEL <span class="bound">p</span> <span class="bound">n</span> <span class="bound">i</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">-</span> <span class="main">{</span>IdxInterval <span class="bound">i</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> apply_ops_k_next_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Rect_Intersect-apply_ops_k_next_is_correct"><span class="command">lemma</span></span> apply_ops_k_next_is_correct <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_rect_list <span class="free">rects</span> <span class="main">⟹</span> <span class="free">ops</span> <span class="main">=</span> all_ops <span class="free">rects</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">ops</span> <span class="main">⟹</span>
   <span class="free">S</span> <span class="main">=</span> xints_of <span class="free">rects</span> <span class="main">(</span>apply_ops_k <span class="free">rects</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span>
   xints_of <span class="free">rects</span> <span class="main">(</span>apply_ops_k <span class="free">rects</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> apply_ops_k_next <span class="free">rects</span> <span class="free">S</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"is_INS <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">rect_inter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat rectangle list <span class="main">⇒</span> nat idx_interval set <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rect_inter</span> <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">ops</span> <span class="main">=</span> all_ops <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≥</span> length <span class="bound">ops</span> <span class="keyword1">then</span> False
    <span class="keyword1">else</span> <span class="keyword1">if</span> is_INS <span class="main">(</span><span class="bound">ops</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
      <span class="keyword1">if</span> has_overlap <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>op_int <span class="main">(</span><span class="bound">ops</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> True
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> length <span class="bound">ops</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> False
      <span class="keyword1">else</span> <span class="free">rect_inter</span> <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">(</span>apply_ops_k_next <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> length <span class="bound">ops</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> False
      <span class="keyword1">else</span> <span class="free">rect_inter</span> <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">(</span>apply_ops_k_next <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">rects</span><span class="main">,</span><span class="bound">S</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span>all_ops <span class="bound">rects</span><span class="main">)</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Rect_Intersect-rect_inter_correct_ind"><span class="command">lemma</span></span> rect_inter_correct_ind <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_rect_list <span class="free">rects</span> <span class="main">⟹</span> <span class="free">ops</span> <span class="main">=</span> all_ops <span class="free">rects</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">ops</span> <span class="main">⟹</span>
   rect_inter <span class="free">rects</span> <span class="main">(</span>xints_of <span class="free">rects</span> <span class="main">(</span>apply_ops_k <span class="free">rects</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span> <span class="main">⟷</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>length <span class="free">ops</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="free">n</span> <span class="main">∧</span> has_overlap_at_k <span class="free">rects</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">ints</span> <span class="main">=</span> xints_of <span class="free">rects</span> <span class="main">(</span>apply_ops_k <span class="free">rects</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"rect_inter <span class="free">rects</span> <span class="free">ints</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"rect_inter <span class="free">rects</span> <span class="free">ints</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> length <span class="free">ops</span>"</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"is_INS <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="main">∧</span> has_overlap <span class="free">ints</span> <span class="main">(</span>op_int <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="free">ops</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of functional algorithm.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> rect_inter_correct <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_rect_list <span class="free">rects</span> <span class="main">⟹</span> rect_inter <span class="free">rects</span> <span class="main">{}</span> <span class="main">0</span> <span class="main">⟷</span> has_rect_overlap <span class="free">rects</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">=</span> xints_of <span class="free">rects</span> <span class="main">(</span>apply_ops_k <span class="free">rects</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"rect_inter <span class="free">rects</span> <span class="main">{}</span> <span class="main">0</span> <span class="main">=</span> has_overlap_lst <span class="free">rects</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"rect_inter <span class="free">rects</span> <span class="main">{}</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SepLogic_Base">
<div class="head">
<h1>Theory SepLogic_Base</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: SepLogic_Base.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">theory</span></span> SepLogic_Base
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Auto2_HOL/Auto2_Main.html">Auto2_HOL.Auto2_Main</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  General auto2 setup for separation logic. The automation defined
  here can be instantiated for different variants of separation logic.
›</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">"sep_util_base.ML"</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">"assn_matcher.ML"</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">"sep_steps.ML"</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/sep_util_base.ML">
<div class="head">
<h1>File ‹sep_util_base.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: sep_util_base.ML
  Author: Bohua Zhan

  Declares the interface for setting up auto2 for separation logic.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SEP_UTIL</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> assnT<span class="main">:</span> typ
  <span class="keyword1"><span class="keyword">val</span></span> emp<span class="main">:</span> term
  <span class="keyword1"><span class="keyword">val</span></span> assn_true<span class="main">:</span> term
  <span class="keyword1"><span class="keyword">val</span></span> assn_ac_info<span class="main">:</span> <span class="entity">ac_info</span>
  <span class="keyword1"><span class="keyword">val</span></span> is_true_assn<span class="main">:</span> term <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> entail_t<span class="main">:</span> term
  <span class="keyword1"><span class="keyword">val</span></span> is_entail<span class="main">:</span> term <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> dest_entail<span class="main">:</span> term <span class="main">-&gt;</span> term * term
  <span class="keyword1"><span class="keyword">val</span></span> cdest_entail<span class="main">:</span> cterm <span class="main">-&gt;</span> cterm * cterm
  <span class="keyword1"><span class="keyword">val</span></span> is_ex_assn<span class="main">:</span> term <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> is_pure_assn<span class="main">:</span> term <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> has_pure_assn<span class="main">:</span> term <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> strip_pure_assn<span class="main">:</span> term <span class="main">-&gt;</span> term

  <span class="keyword1"><span class="keyword">val</span></span> hoare_triple_pat<span class="main">:</span> term
  <span class="keyword1"><span class="keyword">val</span></span> heap_eq_pat<span class="main">:</span> term
  <span class="keyword1"><span class="keyword">val</span></span> is_hoare_triple<span class="main">:</span> term <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> dest_hoare_triple<span class="main">:</span> term <span class="main">-&gt;</span> term * term * term

  <span class="keyword1"><span class="keyword">val</span></span> is_bind_cmd<span class="main">:</span> term <span class="main">-&gt;</span> bool

  <span class="keyword1"><span class="keyword">val</span></span> mult_emp_left<span class="main">:</span> conv
  <span class="keyword1"><span class="keyword">val</span></span> mult_emp_right<span class="main">:</span> conv
  <span class="keyword1"><span class="keyword">val</span></span> reduce_emp_right<span class="main">:</span> conv
  <span class="keyword1"><span class="keyword">val</span></span> entail_triv_th<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> entail_true_th<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> apply_to_entail_r<span class="main">:</span> conv <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm

  <span class="comment1">(* Basic theorems *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> pre_pure_rule_th<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> pre_pure_rule_th'<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> pre_ex_rule_th<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> entails_pure_th<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> entails_pure_th'<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> entails_ex_th<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> entails_frame_th'<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> entails_frame_th''<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> pure_conj_th<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> entails_ex_post_th<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> entails_pure_post_th<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> pre_rule_th'<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> pre_rule_th''<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> bind_rule_th'<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> post_rule_th'<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> entails_equiv_forward_th<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> entails_equiv_backward_th<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> norm_pre_pure_iff_th<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> norm_pre_pure_iff2_th<span class="main">:</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> entails_trans2_th<span class="main">:</span> thm

  <span class="comment1">(* Extra functions *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> pure_ord<span class="main">:</span> term * term <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> normalize_times_cv<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv
  <span class="keyword1"><span class="keyword">val</span></span> normalize_assn_cv<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv
  <span class="keyword1"><span class="keyword">val</span></span> assn_rewr_terms<span class="main">:</span> term <span class="main">-&gt;</span> term list
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
</pre>
</div><div id="files/assn_matcher.ML">
<div class="head">
<h1>File ‹assn_matcher.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: assn_matcher.ML
  Author: Bohua Zhan

  Matching of assertions.
*)</span>

<span class="comment1">(* Given arguments ctxt (pat, t) (id, inst), match pat with t. Assume
   pat is not a product. Produce t ==&gt; pat(s) or t ==&gt; pat(s) * t' for
   those in AssnMatchData. Produce pat(s) or pat(s) * t' ==&gt; t for
   those in AssnInvMatchData.
 *)</span>
<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">assn_matcher</span> <span class="main">=</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term * cterm <span class="main">-&gt;</span> <span class="entity">id_inst</span> <span class="main">-&gt;</span> <span class="entity">id_inst_th</span> list

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">ASSN_MATCHER</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> add_assn_matcher<span class="main">:</span> <span class="entity">assn_matcher</span> <span class="main">-&gt;</span> theory <span class="main">-&gt;</span> theory
  <span class="keyword1"><span class="keyword">val</span></span> assn_match_term<span class="main">:</span>
      <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term * cterm <span class="main">-&gt;</span> <span class="entity">id_inst</span> <span class="main">-&gt;</span> <span class="entity">id_inst_th</span> list
  <span class="keyword1"><span class="keyword">val</span></span> assn_match_all<span class="main">:</span>
      <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term * cterm <span class="main">-&gt;</span> <span class="entity">id_inst</span> <span class="main">-&gt;</span> <span class="entity">id_inst_th</span> list
  <span class="keyword1"><span class="keyword">val</span></span> assn_match_strict<span class="main">:</span>
      <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term * cterm <span class="main">-&gt;</span> <span class="entity">id_inst</span> <span class="main">-&gt;</span> <span class="entity">id_inst_th</span> list
  <span class="keyword1"><span class="keyword">val</span></span> triv_assn_matcher<span class="main">:</span> <span class="entity">assn_matcher</span>
  <span class="keyword1"><span class="keyword">val</span></span> emp_assn_matcher<span class="main">:</span> <span class="entity">assn_matcher</span>
  <span class="keyword1"><span class="keyword">val</span></span> true_assn_matcher<span class="main">:</span> <span class="entity">assn_matcher</span>
  <span class="keyword1"><span class="keyword">val</span></span> add_entail_matcher<span class="main">:</span> thm <span class="main">-&gt;</span> theory <span class="main">-&gt;</span> theory

  <span class="keyword1"><span class="keyword">val</span></span> assn_match_single<span class="main">:</span>
      <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term * cterm <span class="main">-&gt;</span> <span class="entity">id_inst</span> <span class="main">-&gt;</span> <span class="entity">id_inst_th</span> list

  <span class="keyword1"><span class="keyword">val</span></span> add_assn_matcher_proofsteps<span class="main">:</span> theory <span class="main">-&gt;</span> theory
<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Due to strange interaction between functors and Theory_Data, this
   must be put outside.
 *)</span>
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">MatchData</span> <span class="main">=</span> Theory_Data <span class="main">(</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">assn_matcher</span> list
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> merge <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> pointer_eq<span class="main">)</span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">functor</span></span> <span class="entity">AssnMatcher</span><span class="main">(</span>SepUtil<span class="main">:</span> <span class="entity">SEP_UTIL</span><span class="main">)</span><span class="main">:</span> <span class="entity">ASSN_MATCHER</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> <span class="entity">SepUtil</span>

<span class="comment1">(* Matching in the forward direction *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_assn_matcher</span> <span class="entity">matcher</span> <span class="main">=</span> MatchData.map <span class="main">(</span>cons <span class="entity">matcher</span><span class="main">)</span>

<span class="comment1">(* Assume pat is not in the form A * B. Match pat with one or more
   terms of t. Return theorem of form t ==&gt; pat(s) * t'.
 *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">assn_match_term</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">ct</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">assert</span> <span class="main">(</span>not <span class="main">(</span>Term.is_Var <span class="entity">pat</span><span class="main">)</span><span class="main">)</span>
                     <span class="inner_quoted">"assn_match_term: pat should not be Var."</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> Proof_Context.theory_of <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_matcher</span> <span class="entity">matcher</span> <span class="main">=</span> <span class="entity">matcher</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">ct</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span>

      <span class="comment1">(* th must be an entailment, and the right side must be
             pat(s), pat(s) * t', or t' * pat(s).
       *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_res</span> <span class="main">(</span><span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst'</span><span class="main">)</span><span class="main">,</span> <span class="entity">th</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">assert</span> <span class="main">(</span><span class="entity">is_entail</span> <span class="main">(</span><span class="entity">prop_of'</span> <span class="entity">th</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"assn_match_term"</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">rhs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">th</span> |&gt; <span class="entity">prop_of'</span> |&gt; <span class="entity">dest_entail</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">exp_rhs</span> <span class="main">=</span> <span class="entity">Util.subst_term_norm</span> <span class="entity">inst'</span> <span class="entity">pat</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">rhs</span> aconv <span class="entity">exp_rhs</span> <span class="keyword2"><span class="keyword">then</span></span>
              <span class="main">(</span><span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst'</span><span class="main">)</span><span class="main">,</span> <span class="entity">th</span> |&gt; <span class="entity">apply_to_entail_r</span> <span class="entity">mult_emp_right</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">UtilArith.is_times</span> <span class="entity">rhs</span> <span class="keyword1"><span class="keyword">andalso</span></span>
                    <span class="entity">dest_arg1</span> <span class="entity">rhs</span> aconv <span class="entity">exp_rhs</span> <span class="keyword2"><span class="keyword">then</span></span>
              <span class="main">(</span><span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst'</span><span class="main">)</span><span class="main">,</span> <span class="entity">th</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">UtilArith.is_times</span> <span class="entity">rhs</span> <span class="keyword1"><span class="keyword">andalso</span></span>
                    <span class="entity">dest_arg</span> <span class="entity">rhs</span> aconv <span class="entity">exp_rhs</span> <span class="keyword2"><span class="keyword">then</span></span>
              <span class="main">(</span><span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst'</span><span class="main">)</span><span class="main">,</span>
               <span class="entity">th</span> |&gt; <span class="entity">apply_to_entail_r</span> <span class="main">(</span><span class="entity">ACUtil.comm_cv</span> <span class="entity">assn_ac_info</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">else</span></span>
              <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"assn_match_term"</span>
          <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">(</span>maps <span class="entity">apply_matcher</span> <span class="main">(</span>MatchData.get <span class="entity">thy</span><span class="main">)</span><span class="main">)</span>
          |&gt; map <span class="entity">process_res</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Match each term of pat with some term in t. Returns t ==&gt; pat(s) * t'. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">assn_match_all</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">ct</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">UtilArith.is_times</span> <span class="entity">pat</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">A</span><span class="main">,</span> <span class="entity">B</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Util.dest_binop_args</span> <span class="entity">pat</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts</span> <span class="main">=</span> <span class="entity">assn_match_all</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">A</span><span class="main">,</span> <span class="entity">ct</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span>

        <span class="comment1">(* th is t ==&gt; A(s) * t'. Match B(s) with t', with result t'
           ==&gt; B(s) * t''. Produce t ==&gt; (A(s) * B(s)) * t''
         *)</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_inst</span> <span class="main">(</span><span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">inst'</span><span class="main">)</span><span class="main">,</span> <span class="entity">th</span><span class="main">)</span> <span class="main">=</span>
            <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ct'</span> <span class="main">=</span> <span class="entity">th</span> |&gt; <span class="entity">cprop_of'</span> |&gt; <span class="entity">cdest_entail</span> |&gt; snd |&gt; Thm.dest_arg
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">B'</span> <span class="main">=</span> <span class="entity">Util.subst_term_norm</span> <span class="entity">inst'</span> <span class="entity">B</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts'</span> <span class="main">=</span> <span class="entity">assn_match_all</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">B'</span><span class="main">,</span> <span class="entity">ct'</span><span class="main">)</span> <span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">inst'</span><span class="main">)</span>

              <span class="comment1">(* th' is t' ==&gt; B(s) * t''. *)</span>
              <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_inst'</span> <span class="main">(</span><span class="main">(</span><span class="entity">id''</span><span class="main">,</span> <span class="entity">inst''</span><span class="main">)</span><span class="main">,</span> <span class="entity">th'</span><span class="main">)</span> <span class="main">=</span>
                  <span class="keyword2"><span class="keyword">let</span></span>
                    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="entity">th</span><span class="main">,</span> <span class="entity">th'</span><span class="main">]</span> MRS <span class="entity">entails_trans2_th</span><span class="main">)</span>
                                  |&gt; <span class="entity">apply_to_entail_r</span> <span class="main">(</span>
                                <span class="entity">ACUtil.assoc_sym_cv</span> <span class="entity">assn_ac_info</span><span class="main">)</span>
                  <span class="keyword2"><span class="keyword">in</span></span>
                    <span class="main">(</span><span class="main">(</span><span class="entity">id''</span><span class="main">,</span> <span class="entity">inst''</span><span class="main">)</span><span class="main">,</span> <span class="entity">res</span><span class="main">)</span>
                  <span class="keyword2"><span class="keyword">end</span></span>
            <span class="keyword2"><span class="keyword">in</span></span>
              map <span class="entity">process_inst'</span> <span class="entity">insts'</span>
            <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">in</span></span>
        maps <span class="entity">process_inst</span> <span class="entity">insts</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="entity">assn_match_term</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">ct</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span>

<span class="comment1">(* Guarantees that every term in t is matched. Returns t ==&gt; pat(s). *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">assn_match_strict</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">ct</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst</span> <span class="main">=</span> <span class="entity">assn_match_all</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">ct</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_inst</span> <span class="main">(</span><span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">inst'</span><span class="main">)</span><span class="main">,</span> <span class="entity">th</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rhs</span> <span class="main">=</span> <span class="entity">th</span> |&gt; <span class="entity">prop_of'</span> |&gt; <span class="entity">dest_entail</span> |&gt; snd
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">assert</span> <span class="main">(</span><span class="entity">UtilArith.is_times</span> <span class="entity">rhs</span> <span class="keyword1"><span class="keyword">andalso</span></span>
                            <span class="entity">dest_arg1</span> <span class="entity">rhs</span> aconv <span class="entity">Util.subst_term_norm</span> <span class="entity">inst'</span> <span class="entity">pat</span><span class="main">)</span>
                           <span class="inner_quoted">"assn_match_strict"</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">dest_arg</span> <span class="entity">rhs</span> aconv <span class="entity">emp</span> <span class="keyword2"><span class="keyword">then</span></span>
              <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">inst'</span><span class="main">)</span><span class="main">,</span> <span class="entity">th</span> |&gt; <span class="entity">apply_to_entail_r</span> <span class="entity">reduce_emp_right</span><span class="main">)</span><span class="main">]</span>
            <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      maps <span class="entity">process_inst</span> <span class="entity">inst</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Specific assertion matchers *)</span>

<span class="comment1">(* Matcher using the theorem A ==&gt; A. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">triv_assn_matcher</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">ct</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">pat</span> aconv <span class="entity">emp</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span>  <span class="comment1">(* leave to emp_assn_matcher *)</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cts</span> <span class="main">=</span> <span class="entity">ACUtil.cdest_ac</span> <span class="entity">assn_ac_info</span> <span class="entity">ct</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">match_i</span> <span class="entity">i</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ct'</span> <span class="main">=</span> nth <span class="entity">cts</span> <span class="entity">i</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts</span> <span class="main">=</span> <span class="entity">Matcher.rewrite_match</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">ct'</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span>

            <span class="comment1">(* eq_th is of form pat(inst') == t'. *)</span>
            <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_inst</span> <span class="main">(</span><span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">inst'</span><span class="main">)</span><span class="main">,</span> <span class="entity">eq_th</span><span class="main">)</span> <span class="main">=</span>
                <span class="keyword2"><span class="keyword">let</span></span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">entail_triv_th</span> <span class="entity">ctxt</span> <span class="main">(</span>Thm.term_of <span class="entity">ct</span><span class="main">)</span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cv</span> <span class="main">=</span> Conv.every_conv <span class="main">[</span>
                        <span class="entity">ACUtil.move_outmost</span> <span class="entity">assn_ac_info</span> <span class="main">(</span>Thm.term_of <span class="entity">ct'</span><span class="main">)</span><span class="main">,</span>
                        <span class="entity">ACUtil.ac_last_conv</span>
                            <span class="entity">assn_ac_info</span> <span class="main">(</span>Conv.rewr_conv <span class="main">(</span><span class="entity">meta_sym</span> <span class="entity">eq_th</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
                <span class="keyword2"><span class="keyword">in</span></span>
                  <span class="main">(</span><span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">inst'</span><span class="main">)</span><span class="main">,</span> <span class="entity">th</span> |&gt; <span class="entity">apply_to_entail_r</span> <span class="entity">cv</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">end</span></span>
          <span class="keyword2"><span class="keyword">in</span></span>
            map <span class="entity">process_inst</span> <span class="entity">insts</span>
          <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      maps <span class="entity">match_i</span> <span class="main">(</span><span class="inner_numeral">0</span> upto <span class="main">(</span>length <span class="entity">cts</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Consider the case where pat = emp. Return t ==&gt; emp * t. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">emp_assn_matcher</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">ct</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">pat</span> aconv <span class="entity">emp</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span><span class="main">,</span> <span class="entity">ct</span> |&gt; Thm.term_of |&gt; <span class="entity">entail_triv_th</span> <span class="entity">ctxt</span>
                          |&gt; <span class="entity">apply_to_entail_r</span> <span class="entity">mult_emp_left</span><span class="main">)</span><span class="main">]</span>

<span class="comment1">(* If pat = true, match all of t. Return t ==&gt; emp * true. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">true_assn_matcher</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">ct</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">pat</span> aconv <span class="entity">assn_true</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span><span class="main">,</span> <span class="entity">ct</span> |&gt; Thm.term_of |&gt; <span class="entity">entail_true_th</span> <span class="entity">ctxt</span>
                          |&gt; <span class="entity">apply_to_entail_r</span> <span class="entity">mult_emp_left</span><span class="main">)</span><span class="main">]</span>

<span class="comment1">(* We now consider the case of generating a matcher from an entailment
   theorem of a particular form.

   Given an entailment A ==&gt; B, where B is of the form f ?xs pat_r,
   where f is a constant, and pat_r may contain additional schematic
   variables. Attempt to find a term of form f xs r within t, for the
   input term r, by matching the pattern A. For each match, return the
   implication t ==&gt; f xs r or t ==&gt; t' * f xs r. This function serves
   as the first step of entail_matcher.
 *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">entail_matcher'</span> <span class="entity">entail_th</span> <span class="entity">ctxt</span> <span class="entity">r</span> <span class="entity">ct</span> <span class="entity">id</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="comment1">(* Match pat_r with r. *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pat_r</span> <span class="main">=</span> <span class="entity">entail_th</span> |&gt; <span class="entity">prop_of'</span> |&gt; <span class="entity">dest_entail</span> |&gt; snd |&gt; <span class="entity">dest_arg</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst_r</span> <span class="main">=</span> <span class="entity">Matcher.rewrite_match</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat_r</span><span class="main">,</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">r</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">fo_init</span><span class="main">)</span>

      <span class="comment1">(* For each match, recursively match the instantiated version of
         A (named pat here) with t.
       *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_inst_r</span> <span class="main">(</span><span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">inst'</span><span class="main">)</span><span class="main">,</span> <span class="entity">eq_th</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">entail_th'</span> <span class="main">=</span> <span class="entity">Util.subst_thm</span> <span class="entity">ctxt</span> <span class="entity">inst'</span> <span class="entity">entail_th</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pat</span> <span class="main">=</span> <span class="entity">entail_th'</span> |&gt; <span class="entity">prop_of'</span> |&gt; <span class="entity">dest_arg1</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">matches</span> <span class="main">=</span> <span class="entity">assn_match_all</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">ct</span><span class="main">)</span> <span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">fo_init</span><span class="main">)</span>

            <span class="comment1">(* th is of form t ==&gt; pat(s) * t'. Convert to t ==&gt; t' *
               pat(s). Then use entailment theorem to convert to t ==&gt;
               t' * B. Finally, convert the argument in B to the given
               r.
             *)</span>
            <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_match</span> <span class="main">(</span><span class="main">(</span><span class="entity">id''</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">th</span><span class="main">)</span> <span class="main">=</span>
                <span class="keyword2"><span class="keyword">let</span></span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cv</span> <span class="main">=</span> <span class="entity">eq_th</span> |&gt; Conv.rewr_conv |&gt; <span class="entity">Util.argn_conv</span> <span class="inner_numeral">1</span>
                                 |&gt; <span class="entity">ACUtil.ac_last_conv</span> <span class="entity">assn_ac_info</span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th'</span> <span class="main">=</span> <span class="entity">th</span> |&gt; <span class="entity">apply_to_entail_r</span> <span class="main">(</span><span class="entity">ACUtil.comm_cv</span> <span class="entity">assn_ac_info</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">in</span></span>
                  <span class="main">(</span><span class="entity">id''</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="entity">th'</span><span class="main">,</span> <span class="entity">entail_th'</span><span class="main">]</span> MRS <span class="entity">entails_trans2_th</span><span class="main">)</span>
                             |&gt; <span class="entity">apply_to_entail_r</span> <span class="entity">cv</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">end</span></span>
          <span class="keyword2"><span class="keyword">in</span></span>
            map <span class="entity">process_match</span> <span class="entity">matches</span>
          <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      maps <span class="entity">process_inst_r</span> <span class="entity">inst_r</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Given entailment theorem A ==&gt; B, with same condition as in
   entail_matcher', attempt to match pat with t, and return t ==&gt; t' *
   pat(s). For any matching to be performed, pat must be in the form f
   pat_xs r, where pat_xs may contain schematic variables, but r
   cannot. First, find f xs r using entail_matcher', then match pat_xs
   with xs.
 *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">entail_matcher</span> <span class="entity">entail_th</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">ct</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span> <span class="main">=</span> Term.strip_comb <span class="entity">pat</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pat_f</span> <span class="main">=</span> <span class="entity">entail_th</span> |&gt; <span class="entity">prop_of'</span> |&gt; <span class="entity">dest_entail</span> |&gt; snd |&gt; Term.head_of
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span>Term.aconv_untyped <span class="main">(</span><span class="entity">f</span><span class="main">,</span> <span class="entity">pat_f</span><span class="main">)</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span>
         <span class="entity">Util.has_vars</span> <span class="main">(</span>nth <span class="entity">args</span> <span class="inner_numeral">1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">pat_xs</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">the_pair</span> <span class="entity">args</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">matches</span> <span class="main">=</span> <span class="entity">entail_matcher'</span> <span class="entity">entail_th</span> <span class="entity">ctxt</span> <span class="entity">r</span> <span class="entity">ct</span> <span class="entity">id</span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_res</span> <span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">th</span><span class="main">)</span> <span class="main">=</span>
            <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">xs</span> <span class="main">=</span> <span class="entity">th</span> |&gt; <span class="entity">cprop_of'</span> |&gt; Thm.dest_arg
                          |&gt; <span class="entity">ACUtil.cdest_ac</span> <span class="entity">assn_ac_info</span>
                          |&gt; List.last |&gt; Drule.strip_comb |&gt; snd |&gt; hd
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts</span> <span class="main">=</span> <span class="entity">Matcher.rewrite_match</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat_xs</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span> <span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span>

              <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_inst</span> <span class="main">(</span><span class="main">(</span><span class="entity">id''</span><span class="main">,</span> <span class="entity">inst'</span><span class="main">)</span><span class="main">,</span> <span class="entity">eq_th</span><span class="main">)</span> <span class="main">=</span>
                  <span class="keyword2"><span class="keyword">let</span></span>
                    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cv</span> <span class="main">=</span> <span class="entity">eq_th</span> |&gt; <span class="entity">meta_sym</span> |&gt; Conv.rewr_conv
                                   |&gt; Conv.arg1_conv
                                   |&gt; <span class="entity">ACUtil.ac_last_conv</span> <span class="entity">assn_ac_info</span>
                  <span class="keyword2"><span class="keyword">in</span></span>
                    <span class="main">(</span><span class="main">(</span><span class="entity">id''</span><span class="main">,</span> <span class="entity">inst'</span><span class="main">)</span><span class="main">,</span> <span class="entity">th</span> |&gt; <span class="entity">apply_to_entail_r</span> <span class="entity">cv</span><span class="main">)</span>
                  <span class="keyword2"><span class="keyword">end</span></span>
            <span class="keyword2"><span class="keyword">in</span></span>
              map <span class="entity">process_inst</span> <span class="entity">insts</span>
            <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">in</span></span>
        maps <span class="entity">process_res</span> <span class="entity">matches</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_entail_matcher</span> <span class="entity">th</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">pat_f</span><span class="main">,</span> <span class="entity">pat_args</span><span class="main">)</span> <span class="main">=</span> <span class="entity">th</span> |&gt; <span class="entity">prop_of'</span> |&gt; <span class="entity">dest_entail</span> |&gt; snd
                                 |&gt; Term.strip_comb

      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">assert</span> <span class="main">(</span>length <span class="entity">pat_args</span> <span class="main">=</span> <span class="inner_numeral">2</span> <span class="keyword1"><span class="keyword">andalso</span></span> Term.is_Const <span class="entity">pat_f</span><span class="main">)</span>
                     <span class="inner_quoted">"add_entail_matcher: th must be in form A ==&gt; f ?xs pat_r."</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">add_assn_matcher</span> <span class="main">(</span><span class="entity">entail_matcher</span> <span class="entity">th</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Matching in the backward direction *)</span>

<span class="comment1">(* Given a pattern pat, write t in the form pat(inst) * t'. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">assn_match_single</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">ct</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cts</span> <span class="main">=</span> <span class="entity">ACUtil.cdest_ac</span> <span class="entity">assn_ac_info</span> <span class="entity">ct</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">match_i</span> <span class="entity">i</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ct'</span> <span class="main">=</span> nth <span class="entity">cts</span> <span class="entity">i</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t'</span> <span class="main">=</span> Thm.term_of <span class="entity">ct'</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts</span> <span class="main">=</span> <span class="entity">Matcher.rewrite_match</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">ct'</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span>

            <span class="comment1">(* eq_th is of form pat(inst) == t'. *)</span>
            <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_inst</span> <span class="main">(</span><span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">inst'</span><span class="main">)</span><span class="main">,</span> <span class="entity">eq_th</span><span class="main">)</span> <span class="main">=</span>
                <span class="keyword2"><span class="keyword">let</span></span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eq_th'</span> <span class="main">=</span>
                      <span class="keyword2"><span class="keyword">if</span></span> length <span class="entity">cts</span> <span class="main">=</span> <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">then</span></span>
                        <span class="entity">eq_th</span> |&gt; <span class="entity">meta_sym</span>
                              |&gt; <span class="entity">apply_to_rhs</span> <span class="entity">mult_emp_right</span>
                      <span class="keyword2"><span class="keyword">else</span></span>
                        Conv.every_conv <span class="main">[</span>
                          <span class="entity">ACUtil.move_outmost</span> <span class="entity">assn_ac_info</span> <span class="entity">t'</span><span class="main">,</span>
                          Conv.arg_conv <span class="main">(</span>Conv.rewr_conv <span class="main">(</span><span class="entity">meta_sym</span> <span class="entity">eq_th</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                          <span class="entity">ACUtil.comm_cv</span> <span class="entity">assn_ac_info</span><span class="main">]</span> <span class="entity">ct</span>
                <span class="keyword2"><span class="keyword">in</span></span>
                  <span class="main">(</span><span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">inst'</span><span class="main">)</span><span class="main">,</span> <span class="entity">eq_th'</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">end</span></span>
          <span class="keyword2"><span class="keyword">in</span></span>
            map <span class="entity">process_inst</span> <span class="entity">insts</span>
          <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      maps <span class="entity">match_i</span> <span class="main">(</span><span class="inner_numeral">0</span> upto <span class="main">(</span>length <span class="entity">cts</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_assn_matcher_proofsteps</span> <span class="main">=</span>
    fold <span class="entity">add_assn_matcher</span> <span class="main">[</span>
      <span class="entity">triv_assn_matcher</span><span class="main">,</span> <span class="entity">emp_assn_matcher</span><span class="main">,</span> <span class="entity">true_assn_matcher</span>
    <span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>  <span class="comment1">(* structure AssnMatcher. *)</span>
</pre>
</div><div id="files/sep_steps.ML">
<div class="head">
<h1>File ‹sep_steps.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: sep_steps.ML
  Author: Bohua Zhan

  Proof steps for separation logic.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SEP_LOGIC</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> normalize_hoare_goal_cv<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv
  <span class="keyword1"><span class="keyword">val</span></span> normalize_entail_goal_cv<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv

  <span class="keyword1"><span class="keyword">val</span></span> get_proc_def<span class="main">:</span> theory <span class="main">-&gt;</span> term <span class="main">-&gt;</span> thm list
  <span class="keyword1"><span class="keyword">val</span></span> update_hoare_triple<span class="main">:</span> thm <span class="main">-&gt;</span> theory <span class="main">-&gt;</span> theory
  <span class="keyword1"><span class="keyword">val</span></span> get_hoare_triples<span class="main">:</span> theory <span class="main">-&gt;</span> string <span class="main">-&gt;</span> thm list

  <span class="keyword1"><span class="keyword">val</span></span> is_bind_cmd<span class="main">:</span> term <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> get_first_cmd<span class="main">:</span> term <span class="main">-&gt;</span> term

  <span class="keyword1"><span class="keyword">val</span></span> TY_CODE_POS<span class="main">:</span> string
  <span class="keyword1"><span class="keyword">val</span></span> TY_ENTAIL<span class="main">:</span> string

  <span class="keyword1"><span class="keyword">val</span></span> is_neg_hoare_triple<span class="main">:</span> term <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> is_neg_entail<span class="main">:</span> term <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> norm_precond<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv
  <span class="keyword1"><span class="keyword">val</span></span> norm_entail_conds<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv
  <span class="keyword1"><span class="keyword">val</span></span> is_implies_item<span class="main">:</span> <span class="entity">box_item</span> <span class="main">-&gt;</span> bool

  <span class="keyword1"><span class="keyword">val</span></span> hoare_goal_update<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">box_id</span> * thm <span class="main">-&gt;</span> <span class="entity">raw_update</span>
  <span class="keyword1"><span class="keyword">val</span></span> entail_goal_update<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">box_id</span> * thm <span class="main">-&gt;</span> <span class="entity">raw_update</span>

  <span class="keyword1"><span class="keyword">val</span></span> init_entail<span class="main">:</span> <span class="entity">proofstep</span>
  <span class="keyword1"><span class="keyword">val</span></span> entails_resolve<span class="main">:</span> <span class="entity">proofstep</span>
  <span class="keyword1"><span class="keyword">val</span></span> init_pos<span class="main">:</span> <span class="entity">proofstep</span>

  <span class="keyword1"><span class="keyword">val</span></span> add_forward_ent_prfstep<span class="main">:</span> thm <span class="main">-&gt;</span> theory <span class="main">-&gt;</span> theory
  <span class="keyword1"><span class="keyword">val</span></span> add_backward_ent_prfstep<span class="main">:</span> thm <span class="main">-&gt;</span> theory <span class="main">-&gt;</span> theory
  <span class="keyword1"><span class="keyword">val</span></span> add_rewrite_ent_rule<span class="main">:</span> thm <span class="main">-&gt;</span> theory <span class="main">-&gt;</span> theory

  <span class="keyword1"><span class="keyword">val</span></span> rewrite_pos<span class="main">:</span> <span class="entity">proofstep</span>
  <span class="keyword1"><span class="keyword">val</span></span> extract_pure_hoare_cv<span class="main">:</span> conv
  <span class="keyword1"><span class="keyword">val</span></span> match_hoare_th<span class="main">:</span> <span class="entity">box_id</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> <span class="entity">box_item</span> <span class="main">-&gt;</span>
                      <span class="entity">raw_update</span> list
  <span class="keyword1"><span class="keyword">val</span></span> match_hoare_prop<span class="main">:</span> <span class="entity">proofstep</span>
  <span class="keyword1"><span class="keyword">val</span></span> match_hoare_disj<span class="main">:</span> <span class="entity">proofstep</span>
  <span class="keyword1"><span class="keyword">val</span></span> match_assn_pure<span class="main">:</span> <span class="entity">proofstep</span>
  <span class="keyword1"><span class="keyword">val</span></span> hoare_create_case<span class="main">:</span> <span class="entity">proofstep</span>
  <span class="keyword1"><span class="keyword">val</span></span> entail_pure<span class="main">:</span> <span class="entity">proofstep</span>
  <span class="keyword1"><span class="keyword">val</span></span> entail_create_case<span class="main">:</span> <span class="entity">proofstep</span>
  <span class="keyword1"><span class="keyword">val</span></span> hoare_triple<span class="main">:</span> <span class="entity">proofstep</span>

  <span class="keyword1"><span class="keyword">val</span></span> contract_hoare_cv<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv
  <span class="keyword1"><span class="keyword">val</span></span> add_hoare_triple_prfstep<span class="main">:</span> thm <span class="main">-&gt;</span> theory <span class="main">-&gt;</span> theory
  <span class="keyword1"><span class="keyword">val</span></span> add_sep_logic_proofsteps<span class="main">:</span> theory <span class="main">-&gt;</span> theory
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">functor</span></span> <span class="entity">SepLogic</span><span class="main">(</span>SepUtil<span class="main">:</span> <span class="entity">SEP_UTIL</span><span class="main">)</span> <span class="main">:</span> <span class="entity">SEP_LOGIC</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> <span class="entity">SepUtil</span>
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">AssnMatcher</span> <span class="main">=</span> <span class="entity">AssnMatcher</span><span class="main">(</span><span class="entity">SepUtil</span><span class="main">)</span>

<span class="comment1">(* Normalize a Hoare triple goal. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">normalize_hoare_goal_cv'</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Thm.term_of <span class="entity">ct</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">P</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">t</span> |&gt; <span class="entity">dest_not</span> |&gt; <span class="entity">dest_hoare_triple</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_pure_assn</span> <span class="entity">P</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">rewr_obj_eq</span> <span class="entity">pre_pure_rule_th'</span> <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">UtilArith.is_times</span> <span class="entity">P</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">is_pure_assn</span> <span class="main">(</span><span class="entity">dest_arg</span> <span class="entity">P</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
        Conv.every_conv <span class="main">[</span><span class="entity">rewr_obj_eq</span> <span class="entity">pre_pure_rule_th</span><span class="main">,</span>
                         Conv.arg1_conv <span class="main">(</span><span class="entity">normalize_hoare_goal_cv'</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">]</span> <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_ex_assn</span> <span class="entity">P</span> <span class="keyword2"><span class="keyword">then</span></span>
        Conv.every_conv <span class="main">[</span>
          <span class="entity">rewr_obj_eq</span> <span class="entity">pre_ex_rule_th</span><span class="main">,</span>
          Conv.binder_conv <span class="main">(</span><span class="entity">normalize_hoare_goal_cv'</span> o snd<span class="main">)</span> <span class="entity">ctxt</span><span class="main">]</span> <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        Conv.all_conv <span class="entity">ct</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">normalize_hoare_goal_cv</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_ex</span> <span class="main">(</span>Thm.term_of <span class="entity">ct</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
      Conv.binder_conv <span class="main">(</span><span class="entity">normalize_hoare_goal_cv</span> o snd<span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">ct</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      Conv.every_conv <span class="main">[</span>
        Conv.arg_conv <span class="main">(</span><span class="entity">Util.argn_conv</span> <span class="inner_numeral">0</span> <span class="main">(</span><span class="entity">SepUtil.normalize_assn_cv</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
        <span class="entity">normalize_hoare_goal_cv'</span> <span class="entity">ctxt</span><span class="main">]</span> <span class="entity">ct</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">normalize_entail_goal_cv'</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Thm.term_of <span class="entity">ct</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">P</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">t</span> |&gt; <span class="entity">dest_not</span> |&gt; <span class="entity">dest_entail</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_pure_assn</span> <span class="entity">P</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">rewr_obj_eq</span> <span class="entity">entails_pure_th'</span> <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">UtilArith.is_times</span> <span class="entity">P</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">is_pure_assn</span> <span class="main">(</span><span class="entity">dest_arg</span> <span class="entity">P</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
        Conv.every_conv <span class="main">[</span><span class="entity">rewr_obj_eq</span> <span class="entity">entails_pure_th</span><span class="main">,</span>
                         Conv.arg1_conv <span class="main">(</span><span class="entity">normalize_entail_goal_cv'</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">]</span> <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_ex_assn</span> <span class="entity">P</span> <span class="keyword2"><span class="keyword">then</span></span>
        Conv.every_conv <span class="main">[</span>
          <span class="entity">rewr_obj_eq</span> <span class="entity">entails_ex_th</span><span class="main">,</span>
          Conv.binder_conv <span class="main">(</span><span class="entity">normalize_entail_goal_cv'</span> o snd<span class="main">)</span> <span class="entity">ctxt</span><span class="main">]</span> <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        Conv.all_conv <span class="entity">ct</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">normalize_entail_goal_cv</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_ex</span> <span class="main">(</span>Thm.term_of <span class="entity">ct</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
      Conv.binder_conv <span class="main">(</span><span class="entity">normalize_entail_goal_cv</span> o snd<span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">ct</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      Conv.every_conv <span class="main">[</span>
        Conv.arg_conv <span class="main">(</span>Conv.binop_conv <span class="main">(</span><span class="entity">SepUtil.normalize_assn_cv</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
        <span class="entity">normalize_entail_goal_cv'</span> <span class="entity">ctxt</span><span class="main">]</span> <span class="entity">ct</span>

<span class="comment1">(* Data maintained for each imperative command. *)</span>
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Data</span> <span class="main">=</span> Theory_Data <span class="main">(</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> thm Symtab.table<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> Symtab.empty<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> Symtab.merge <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> Thm.eq_thm_prop<span class="main">)</span>
<span class="main">)</span>

<span class="comment1">(* Add the given theorem as a Hoare triple. Replace previous Hoare
   triples for this theorem if any exist.
 *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">update_hoare_triple</span> <span class="entity">hoare_th</span> <span class="entity">thy</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">c</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_hoare_triple</span> <span class="main">(</span><span class="entity">prop_of'</span> <span class="entity">hoare_th</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">nm</span> <span class="main">=</span> <span class="entity">Util.get_head_name</span> <span class="entity">c</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">thy</span> |&gt; Data.map <span class="main">(</span>Symtab.update <span class="main">(</span><span class="entity">nm</span><span class="main">,</span> <span class="entity">hoare_th</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Obtain list of Hoare triples for the given command *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_hoare_triples</span> <span class="entity">thy</span> <span class="entity">nm</span> <span class="main">=</span>
    the_list <span class="main">(</span>Symtab.lookup <span class="main">(</span>Data.get <span class="entity">thy</span><span class="main">)</span> <span class="entity">nm</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_proc_def</span> <span class="entity">thy</span> <span class="entity">t</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_bind_cmd</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">nm</span> <span class="main">=</span> <span class="entity">Util.get_head_name</span> <span class="entity">t</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> null <span class="main">(</span><span class="entity">get_hoare_triples</span> <span class="entity">thy</span> <span class="entity">nm</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">Unfolding.get_unfold_thms_by_name</span> <span class="entity">thy</span> <span class="entity">nm</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_first_cmd</span> <span class="entity">c</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_bind_cmd</span> <span class="entity">c</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">dest_arg1</span> <span class="entity">c</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">c</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">extract_return_var</span> <span class="entity">t</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_bind_cmd</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">dest_arg</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
          Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">x</span> <span class="main">=</span> <span class="inner_quoted">"uu_"</span> <span class="keyword2"><span class="keyword">then</span></span> Free <span class="main">(</span><span class="inner_quoted">"u"</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span>  <span class="comment1">(* no assigned name *)</span>
          <span class="keyword2"><span class="keyword">else</span></span> Free <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span>  <span class="comment1">(* regular assigned name *)</span>
        <span class="main">|</span> <span class="entity">c</span> <span class="main">=&gt;</span>
          Free <span class="main">(</span><span class="inner_quoted">"r"</span><span class="main">,</span> Term.domain_type <span class="main">(</span>fastype_of <span class="entity">c</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"extract_return_var"</span>

<span class="comment1">(* CODE_POS item stores a Hoare triple goal, indicating the current
   position in the program.
 *)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">TY_CODE_POS</span> <span class="main">=</span> <span class="inner_quoted">"CODE_POS"</span>

<span class="comment1">(* ENTAIL item stores an entailment goal, usually indicating the end
   of the program.
 *)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">TY_ENTAIL</span> <span class="main">=</span> <span class="inner_quoted">"ENTAIL"</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_neg_hoare_triple</span> <span class="entity">t</span> <span class="main">=</span>
    <span class="entity">is_neg</span> <span class="entity">t</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">is_hoare_triple</span> <span class="main">(</span><span class="entity">dest_not</span> <span class="entity">t</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_neg_entail</span> <span class="entity">t</span> <span class="main">=</span>
    <span class="entity">is_neg</span> <span class="entity">t</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">is_entail</span> <span class="main">(</span><span class="entity">dest_not</span> <span class="entity">t</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">norm_precond</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span>
    <span class="entity">Util.argn_conv</span> <span class="inner_numeral">0</span> <span class="main">(</span><span class="entity">SepUtil.normalize_assn_cv</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ct</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">norm_entail_conds</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span>
    Conv.binop_conv <span class="main">(</span><span class="entity">SepUtil.normalize_assn_cv</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ct</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_implies_item</span> <span class="entity">item</span> <span class="main">=</span>
    <span class="entity">Util.is_implies</span> <span class="main">(</span>Thm.prop_of <span class="main">(</span><span class="main">#</span>prop <span class="entity">item</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">normalize_let</span> <span class="entity">ctxt</span> <span class="entity">th</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rewr_one</span> <span class="main">=</span> Conv.first_conv <span class="main">[</span>Conv.rewr_conv <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Let_def<span class="antiquote">}</span></span></span><span class="main">,</span>
                                      <span class="entity">rewr_obj_eq</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> case_prod_beta'<span class="antiquote">}</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cv</span> <span class="main">=</span> Conv.every_conv <span class="main">[</span>
            Conv.top_conv <span class="main">(</span>K <span class="main">(</span>Conv.try_conv <span class="entity">rewr_one</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">,</span>
            Thm.beta_conversion true<span class="main">]</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">apply_to_thm'</span> <span class="entity">cv</span> <span class="entity">th</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">hoare_goal_update</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">th</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">Util.is_implies</span> <span class="main">(</span>Thm.prop_of <span class="entity">th</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">AddItems</span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id</span><span class="main">,</span> sc <span class="main">=</span> SOME <span class="inner_numeral">1</span><span class="main">,</span>
                raw_items <span class="main">=</span> <span class="main">[</span><span class="entity">Fact</span> <span class="main">(</span><span class="entity">TY_CODE_POS</span><span class="main">,</span> <span class="main">[</span>Thm.prop_of <span class="entity">th</span><span class="main">]</span><span class="main">,</span> <span class="entity">th</span><span class="main">)</span><span class="main">]</span><span class="main">}</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">ex_ritems</span><span class="main">,</span> <span class="entity">res_th</span><span class="main">)</span> <span class="main">=</span>
          <span class="entity">th</span> |&gt; <span class="entity">apply_to_thm'</span> <span class="main">(</span><span class="entity">normalize_hoare_goal_cv</span> <span class="entity">ctxt</span><span class="main">)</span>
             |&gt; <span class="entity">Update.apply_exists_ritems</span> <span class="entity">ctxt</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">res_th'</span><span class="main">,</span> <span class="entity">rest</span><span class="main">)</span> <span class="main">=</span>
          <span class="entity">res_th</span> |&gt; <span class="entity">UtilLogic.split_conj_gen_th</span>
                 |&gt; <span class="entity">filter_split</span> <span class="main">(</span><span class="entity">is_neg_hoare_triple</span> o <span class="entity">prop_of'</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">assert</span> <span class="main">(</span>length <span class="entity">res_th'</span> <span class="main">=</span> <span class="inner_numeral">1</span><span class="main">)</span> <span class="inner_quoted">"hoare_goal_update"</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res_th'</span> <span class="main">=</span> <span class="entity">res_th'</span> |&gt; the_single
                            |&gt; <span class="entity">apply_to_thm'</span> <span class="main">(</span>Conv.arg_conv <span class="main">(</span><span class="entity">norm_precond</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
                            |&gt; <span class="entity">normalize_let</span> <span class="entity">ctxt</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ritems</span> <span class="main">=</span> <span class="entity">ex_ritems</span> @ map <span class="entity">Update.thm_to_ritem</span> <span class="entity">rest</span> @
                   <span class="main">[</span><span class="entity">Fact</span> <span class="main">(</span><span class="entity">TY_CODE_POS</span><span class="main">,</span> <span class="main">[</span><span class="entity">prop_of'</span> <span class="entity">res_th'</span><span class="main">]</span><span class="main">,</span> <span class="entity">res_th'</span><span class="main">)</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">AddItems</span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id</span><span class="main">,</span> sc <span class="main">=</span> SOME <span class="inner_numeral">1</span><span class="main">,</span> raw_items <span class="main">=</span> <span class="entity">ritems</span><span class="main">}</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">entail_goal_update</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">th</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">Util.is_implies</span> <span class="main">(</span>Thm.prop_of <span class="entity">th</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">AddItems</span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id</span><span class="main">,</span> sc <span class="main">=</span> SOME <span class="inner_numeral">1</span><span class="main">,</span>
                raw_items <span class="main">=</span> <span class="main">[</span><span class="entity">Fact</span> <span class="main">(</span><span class="entity">TY_ENTAIL</span><span class="main">,</span> <span class="main">[</span>Thm.prop_of <span class="entity">th</span><span class="main">]</span><span class="main">,</span> <span class="entity">th</span><span class="main">)</span><span class="main">]</span><span class="main">}</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">ex_ritems</span><span class="main">,</span> <span class="entity">res_th</span><span class="main">)</span> <span class="main">=</span>
          <span class="entity">th</span> |&gt; <span class="entity">apply_to_thm'</span> <span class="main">(</span><span class="entity">normalize_entail_goal_cv</span> <span class="entity">ctxt</span><span class="main">)</span>
             |&gt; <span class="entity">Update.apply_exists_ritems</span> <span class="entity">ctxt</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">res_th'</span><span class="main">,</span> <span class="entity">rest</span><span class="main">)</span> <span class="main">=</span>
          <span class="entity">res_th</span> |&gt; <span class="entity">UtilLogic.split_conj_gen_th</span>
                 |&gt; <span class="entity">filter_split</span> <span class="main">(</span><span class="entity">is_neg_entail</span> o <span class="entity">prop_of'</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">assert</span> <span class="main">(</span>length <span class="entity">res_th'</span> <span class="main">=</span> <span class="inner_numeral">1</span><span class="main">)</span> <span class="inner_quoted">"entail_goal_update"</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res_th'</span> <span class="main">=</span>
          <span class="entity">res_th'</span> |&gt; the_single
                  |&gt; <span class="entity">apply_to_thm'</span> <span class="main">(</span>Conv.arg_conv <span class="main">(</span><span class="entity">norm_entail_conds</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
                  |&gt; <span class="entity">normalize_let</span> <span class="entity">ctxt</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ritems</span> <span class="main">=</span> <span class="entity">ex_ritems</span> @ map <span class="entity">Update.thm_to_ritem</span> <span class="entity">rest</span> @
                   <span class="main">[</span><span class="entity">Fact</span> <span class="main">(</span><span class="entity">TY_ENTAIL</span><span class="main">,</span> <span class="main">[</span><span class="entity">prop_of'</span> <span class="entity">res_th'</span><span class="main">]</span><span class="main">,</span> <span class="entity">res_th'</span><span class="main">)</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">AddItems</span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id</span><span class="main">,</span> sc <span class="main">=</span> SOME <span class="inner_numeral">1</span><span class="main">,</span> raw_items <span class="main">=</span> <span class="entity">ritems</span><span class="main">}</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">init_entail_fn</span> <span class="entity">ctxt</span> <span class="entity">item</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">BoxID.has_incr_id</span> <span class="main">(</span><span class="main">#</span>id <span class="entity">item</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">id</span><span class="main">,</span> <span class="entity">prop</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">item</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">[</span><span class="entity">entail_goal_update</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">prop</span><span class="main">)</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">init_entail</span> <span class="main">=</span>
    <span class="main">{</span>name <span class="main">=</span> <span class="inner_quoted">"sep.init_entail"</span><span class="main">,</span>
     args <span class="main">=</span> <span class="main">[</span><span class="entity">TypedMatch</span> <span class="main">(</span><span class="entity">TY_PROP</span><span class="main">,</span> <span class="entity">get_neg</span> <span class="main">(</span><span class="entity">entail_t</span> $ Var <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> <span class="entity">assnT</span><span class="main">)</span>
                                                    $ Var <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"B"</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> <span class="entity">assnT</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
     func <span class="main">=</span> <span class="entity">OneStep</span> <span class="entity">init_entail_fn</span><span class="main">}</span>

<span class="comment1">(* Apply entailment to the pre-condition P of P ==&gt;_A Q. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">forward_ent_prfstep_fn</span> <span class="entity">ent_th</span> <span class="entity">ctxt</span> <span class="entity">item</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_implies_item</span> <span class="entity">item</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">A</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_entail</span> <span class="main">(</span><span class="entity">prop_of'</span> <span class="entity">ent_th</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">id</span><span class="main">,</span> <span class="entity">prop</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">item</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">P</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">prop</span> |&gt; <span class="entity">prop_of'</span> |&gt; <span class="entity">dest_not</span> |&gt; <span class="entity">dest_entail</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cP</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">P</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts</span> <span class="main">=</span> <span class="main">(</span><span class="entity">AssnMatcher.assn_match_single</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">A</span><span class="main">,</span> <span class="entity">cP</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">fo_init</span><span class="main">)</span><span class="main">)</span>
                      |&gt; filter <span class="main">(</span><span class="entity">BoxID.has_incr_id</span> o fst o fst<span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_inst</span> <span class="main">(</span><span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">eq_th</span><span class="main">)</span> <span class="main">=</span>
          <span class="comment1">(* eq_th is P == pat(inst) * P' *)</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop'</span> <span class="main">=</span> <span class="entity">prop</span> |&gt; <span class="entity">apply_to_thm'</span> <span class="main">(</span>
                  Conv.arg_conv <span class="main">(</span>Conv.arg1_conv <span class="main">(</span>Conv.rewr_conv <span class="entity">eq_th</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop''</span> <span class="main">=</span> <span class="main">[</span><span class="entity">prop'</span><span class="main">,</span> <span class="entity">ent_th</span><span class="main">]</span> MRS <span class="entity">entails_frame_th'</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="main">[</span><span class="entity">entail_goal_update</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">prop''</span><span class="main">)</span><span class="main">,</span>
             <span class="entity">ShadowItem</span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id'</span><span class="main">,</span> item <span class="main">=</span> <span class="entity">item</span><span class="main">}</span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">insts</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">process_inst</span> <span class="main">(</span>hd <span class="entity">insts</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">forward_ent_prfstep</span> <span class="entity">ent_th</span> <span class="main">=</span>
    <span class="main">{</span>name <span class="main">=</span> <span class="entity">Util.name_of_thm</span> <span class="entity">ent_th</span> ^ <span class="inner_quoted">"@ent"</span><span class="main">,</span>
     args <span class="main">=</span> <span class="main">[</span><span class="entity">TypedUniv</span> <span class="entity">TY_ENTAIL</span><span class="main">]</span><span class="main">,</span>
     func <span class="main">=</span> <span class="entity">OneStep</span> <span class="main">(</span><span class="entity">forward_ent_prfstep_fn</span> <span class="entity">ent_th</span><span class="main">)</span><span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">backward_ent_prfstep_fn</span> <span class="entity">ent_th</span> <span class="entity">ctxt</span> <span class="entity">item</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_implies_item</span> <span class="entity">item</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">B</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_entail</span> <span class="main">(</span><span class="entity">prop_of'</span> <span class="entity">ent_th</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">id</span><span class="main">,</span> <span class="entity">prop</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">item</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">Q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">prop</span> |&gt; <span class="entity">prop_of'</span> |&gt; <span class="entity">dest_not</span> |&gt; <span class="entity">dest_entail</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cQ</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">Q</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts</span> <span class="main">=</span> <span class="main">(</span><span class="entity">AssnMatcher.assn_match_single</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">B</span><span class="main">,</span> <span class="entity">cQ</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">fo_init</span><span class="main">)</span><span class="main">)</span>
                      |&gt; filter <span class="main">(</span><span class="entity">BoxID.has_incr_id</span> o fst o fst<span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_inst</span> <span class="main">(</span><span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">eq_th</span><span class="main">)</span> <span class="main">=</span>
          <span class="comment1">(* eq_th is P == pat(inst) * P' *)</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop'</span> <span class="main">=</span> <span class="entity">prop</span> |&gt; <span class="entity">apply_to_thm'</span> <span class="main">(</span>
                  Conv.arg_conv <span class="main">(</span>Conv.arg_conv <span class="main">(</span>Conv.rewr_conv <span class="entity">eq_th</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop''</span> <span class="main">=</span> <span class="main">[</span><span class="entity">prop'</span><span class="main">,</span> <span class="entity">ent_th</span><span class="main">]</span> MRS <span class="entity">entails_frame_th''</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="main">[</span><span class="entity">entail_goal_update</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">prop''</span><span class="main">)</span><span class="main">,</span>
             <span class="entity">ShadowItem</span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id'</span><span class="main">,</span> item <span class="main">=</span> <span class="entity">item</span><span class="main">}</span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">insts</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">process_inst</span> <span class="main">(</span>hd <span class="entity">insts</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">backward_ent_prfstep</span> <span class="entity">ent_th</span> <span class="main">=</span>
    <span class="main">{</span>name <span class="main">=</span> <span class="entity">Util.name_of_thm</span> <span class="entity">ent_th</span> ^ <span class="inner_quoted">"@entback"</span><span class="main">,</span>
     args <span class="main">=</span> <span class="main">[</span><span class="entity">TypedUniv</span> <span class="entity">TY_ENTAIL</span><span class="main">]</span><span class="main">,</span>
     func <span class="main">=</span> <span class="entity">OneStep</span> <span class="main">(</span><span class="entity">backward_ent_prfstep_fn</span> <span class="entity">ent_th</span><span class="main">)</span><span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">group_pure_assn</span> <span class="entity">ct</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Thm.term_of <span class="entity">ct</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_pure_assn</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">mult_emp_left</span> <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">UtilArith.is_times</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">has_pure_assn</span> <span class="main">(</span><span class="entity">dest_arg1</span> <span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
          Conv.every_conv <span class="main">[</span>
            Conv.arg1_conv <span class="entity">group_pure_assn</span><span class="main">,</span>
            <span class="entity">ACUtil.assoc_cv</span> <span class="entity">assn_ac_info</span><span class="main">,</span>
            Conv.arg_conv <span class="main">(</span><span class="entity">rewr_obj_eq</span> <span class="main">(</span><span class="entity">obj_sym</span> <span class="entity">pure_conj_th</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="entity">ct</span>
        <span class="keyword2"><span class="keyword">else</span></span>
          Conv.all_conv <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        Conv.all_conv <span class="entity">ct</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">make_sch_th</span> <span class="entity">ctxt</span> <span class="entity">th</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> Thm.prop_of <span class="entity">th</span> <span class="keyword2"><span class="keyword">of</span></span>
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Pure.all<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ Abs <span class="main">(</span><span class="entity">nm</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">var</span> <span class="main">=</span> Var <span class="main">(</span><span class="main">(</span><span class="entity">nm</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          Thm.forall_elim <span class="main">(</span>Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">var</span><span class="main">)</span> <span class="entity">th</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"make_sch_th"</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">entails_norm_ex</span> <span class="entity">ctxt</span> <span class="entity">th</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">prop_of'</span> <span class="entity">th</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">Q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">t</span> |&gt; <span class="entity">dest_not</span> |&gt; <span class="entity">dest_entail</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_ex_assn</span> <span class="entity">Q</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="main">(</span><span class="entity">th</span> RS <span class="entity">entails_ex_post_th</span><span class="main">)</span>
            |&gt; <span class="entity">apply_to_thm</span> <span class="main">(</span><span class="entity">UtilLogic.to_meta_conv</span> <span class="entity">ctxt</span><span class="main">)</span>
            |&gt; <span class="entity">make_sch_th</span> <span class="entity">ctxt</span>
            |&gt; <span class="entity">entails_norm_ex</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">th</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Solve an entailment. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">entails_resolve_fn</span> <span class="entity">ctxt</span> <span class="entity">item</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_implies_item</span> <span class="entity">item</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">id</span><span class="main">,</span> <span class="entity">prop</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">item</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop</span> <span class="main">=</span> <span class="entity">entails_norm_ex</span> <span class="entity">ctxt</span> <span class="entity">prop</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">P</span><span class="main">,</span> <span class="entity">Q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_entail</span> <span class="main">(</span><span class="entity">get_neg</span> <span class="main">(</span><span class="entity">prop_of'</span> <span class="entity">prop</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cP</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">P</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Q'</span> <span class="main">=</span> <span class="entity">strip_pure_assn</span> <span class="entity">Q</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts</span> <span class="main">=</span> <span class="main">(</span><span class="entity">AssnMatcher.assn_match_strict</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">Q'</span><span class="main">,</span> <span class="entity">cP</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">fo_init</span><span class="main">)</span><span class="main">)</span>
                      |&gt; filter <span class="main">(</span><span class="entity">BoxID.has_incr_id</span> o fst o fst<span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_inst</span> <span class="main">(</span><span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">mod_th</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">has_pure_assn</span> <span class="entity">Q</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop'</span> <span class="main">=</span> <span class="entity">prop</span> |&gt; <span class="entity">apply_to_thm'</span> <span class="main">(</span>
                    Conv.arg_conv <span class="main">(</span>Conv.arg_conv <span class="entity">group_pure_assn</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="main">[</span><span class="entity">prop'</span><span class="main">,</span> <span class="entity">mod_th</span><span class="main">]</span> MRS <span class="entity">entails_pure_post_th</span>
            <span class="keyword2"><span class="keyword">in</span></span>
              <span class="entity">Update.thm_update</span> <span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">res</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">end</span></span>
          <span class="keyword2"><span class="keyword">else</span></span>
            <span class="entity">Update.thm_update</span> <span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="main">[</span><span class="entity">prop</span><span class="main">,</span> <span class="entity">mod_th</span><span class="main">]</span> MRS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> contra_triv<span class="antiquote">}</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      map <span class="entity">process_inst</span> <span class="entity">insts</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">entails_resolve</span> <span class="main">=</span>
    <span class="main">{</span>name <span class="main">=</span> <span class="inner_quoted">"sep.entails_resolve"</span><span class="main">,</span>
     args <span class="main">=</span> <span class="main">[</span><span class="entity">TypedUniv</span> <span class="entity">TY_ENTAIL</span><span class="main">]</span><span class="main">,</span>
     func <span class="main">=</span> <span class="entity">OneStep</span> <span class="entity">entails_resolve_fn</span><span class="main">}</span>

<span class="comment1">(* Initialize CODE_POS item from a Hoare triple goal. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">init_pos_fn</span> <span class="entity">ctxt</span> <span class="entity">item</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">id</span><span class="main">,</span> <span class="entity">prop</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">item</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> Proof_Context.theory_of <span class="entity">ctxt</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">c</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_hoare_triple</span> <span class="main">(</span><span class="entity">get_neg</span> <span class="main">(</span><span class="entity">prop_of'</span> <span class="entity">prop</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">proc_defs</span> <span class="main">=</span> <span class="entity">get_proc_def</span> <span class="entity">thy</span> <span class="entity">c</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_proc_def</span> <span class="entity">proc_def</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">proc_def</span> |&gt; <span class="entity">prop_of'</span> |&gt; <span class="entity">dest_eq</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cc</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">c</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts</span> <span class="main">=</span> <span class="main">(</span><span class="entity">Matcher.rewrite_match</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span> <span class="entity">cc</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">fo_init</span><span class="main">)</span><span class="main">)</span>
                            |&gt; filter <span class="main">(</span><span class="entity">BoxID.has_incr_id</span> o fst o fst<span class="main">)</span>

            <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_inst</span> <span class="main">(</span><span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">eq_th</span><span class="main">)</span> <span class="main">=</span>
                <span class="keyword2"><span class="keyword">let</span></span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cv</span> <span class="main">=</span> Conv.every_conv <span class="main">[</span>
                        Conv.rewr_conv <span class="main">(</span><span class="entity">meta_sym</span> <span class="entity">eq_th</span><span class="main">)</span><span class="main">,</span> <span class="entity">rewr_obj_eq</span> <span class="entity">proc_def</span><span class="main">]</span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">apply_to_thm'</span> <span class="main">(</span>Conv.arg_conv <span class="main">(</span>Conv.arg1_conv <span class="entity">cv</span><span class="main">)</span><span class="main">)</span> <span class="entity">prop</span>
                <span class="keyword2"><span class="keyword">in</span></span>
                  <span class="entity">hoare_goal_update</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">th</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">end</span></span>
          <span class="keyword2"><span class="keyword">in</span></span>
            map <span class="entity">process_inst</span> <span class="entity">insts</span>
          <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">proc_defs</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">BoxID.has_incr_id</span> <span class="entity">id</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="entity">hoare_goal_update</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">prop</span><span class="main">)</span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        maps <span class="entity">process_proc_def</span> <span class="entity">proc_defs</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">init_pos</span> <span class="main">=</span>
    <span class="main">{</span>name <span class="main">=</span> <span class="inner_quoted">"sep.init_pos"</span><span class="main">,</span>
     args <span class="main">=</span> <span class="main">[</span><span class="entity">TypedMatch</span> <span class="main">(</span><span class="entity">TY_PROP</span><span class="main">,</span> <span class="entity">get_neg</span> <span class="entity">hoare_triple_pat</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
     func <span class="main">=</span> <span class="entity">OneStep</span> <span class="entity">init_pos_fn</span><span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">forward_hoare_prfstep_fn</span> <span class="entity">ent_th</span> <span class="entity">ctxt</span> <span class="entity">item</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_implies_item</span> <span class="entity">item</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">A</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_entail</span> <span class="main">(</span><span class="entity">prop_of'</span> <span class="entity">ent_th</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">id</span><span class="main">,</span> <span class="entity">prop</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">item</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">P</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">prop</span> |&gt; <span class="entity">prop_of'</span> |&gt; <span class="entity">dest_not</span> |&gt; <span class="entity">dest_hoare_triple</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cP</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">P</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts</span> <span class="main">=</span> <span class="main">(</span><span class="entity">AssnMatcher.assn_match_single</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">A</span><span class="main">,</span> <span class="entity">cP</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">fo_init</span><span class="main">)</span><span class="main">)</span>
                      |&gt; filter <span class="main">(</span><span class="entity">BoxID.has_incr_id</span> o fst o fst<span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_inst</span> <span class="main">(</span><span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">eq_th</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop'</span> <span class="main">=</span> <span class="entity">prop</span> |&gt; <span class="entity">apply_to_thm'</span> <span class="main">(</span>
                  Conv.arg_conv <span class="main">(</span><span class="entity">Util.argn_conv</span> <span class="inner_numeral">0</span> <span class="main">(</span>Conv.rewr_conv <span class="entity">eq_th</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop''</span> <span class="main">=</span> <span class="main">[</span><span class="entity">prop'</span><span class="main">,</span> <span class="entity">ent_th</span><span class="main">]</span> MRS <span class="entity">pre_rule_th'</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="main">[</span><span class="entity">hoare_goal_update</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">prop''</span><span class="main">)</span><span class="main">,</span>
             <span class="entity">ShadowItem</span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id'</span><span class="main">,</span> item <span class="main">=</span> <span class="entity">item</span><span class="main">}</span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">insts</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">process_inst</span> <span class="main">(</span>hd <span class="entity">insts</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">forward_hoare_prfstep</span> <span class="entity">ent_th</span> <span class="main">=</span>
    <span class="main">{</span>name <span class="main">=</span> <span class="entity">Util.name_of_thm</span> <span class="entity">ent_th</span> ^ <span class="inner_quoted">"@hoare_ent"</span><span class="main">,</span>
     args <span class="main">=</span> <span class="main">[</span><span class="entity">TypedUniv</span> <span class="entity">TY_CODE_POS</span><span class="main">]</span><span class="main">,</span>
     func <span class="main">=</span> <span class="entity">OneStep</span> <span class="main">(</span><span class="entity">forward_hoare_prfstep_fn</span> <span class="entity">ent_th</span><span class="main">)</span><span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_forward_ent_prfstep</span> <span class="entity">ent_th</span> <span class="entity">thy</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="entity">Util.name_of_thm</span> <span class="entity">ent_th</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Proof_Context.init_global <span class="entity">thy</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> writeln <span class="main">(</span><span class="inner_quoted">"Add forward entailment "</span> ^ <span class="entity">name</span> ^ <span class="inner_quoted">"\n"</span> ^
                       Syntax.string_of_term <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">prop_of'</span> <span class="entity">ent_th</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">thy</span> |&gt; <span class="entity">add_prfstep</span> <span class="main">(</span><span class="entity">forward_ent_prfstep</span> <span class="entity">ent_th</span><span class="main">)</span>
          |&gt; <span class="entity">add_prfstep</span> <span class="main">(</span><span class="entity">forward_hoare_prfstep</span> <span class="entity">ent_th</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_backward_ent_prfstep</span> <span class="entity">ent_th</span> <span class="entity">thy</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="entity">Util.name_of_thm</span> <span class="entity">ent_th</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Proof_Context.init_global <span class="entity">thy</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> writeln <span class="main">(</span><span class="inner_quoted">"Add backward entailment "</span> ^ <span class="entity">name</span> ^ <span class="inner_quoted">"\n"</span> ^
                       Syntax.string_of_term <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">prop_of'</span> <span class="entity">ent_th</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">add_prfstep</span> <span class="main">(</span><span class="entity">backward_ent_prfstep</span> <span class="entity">ent_th</span><span class="main">)</span> <span class="entity">thy</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_rewrite_ent_rule</span> <span class="entity">th</span> <span class="entity">thy</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">forward_th</span> <span class="main">=</span> <span class="main">(</span><span class="entity">th</span> RS <span class="entity">entails_equiv_forward_th</span><span class="main">)</span>
                           |&gt; Drule.zero_var_indexes
                           |&gt; <span class="entity">Util.update_name_of_thm</span> <span class="entity">th</span> <span class="inner_quoted">"@forward"</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">backward_th</span> <span class="main">=</span> <span class="main">(</span><span class="entity">th</span> RS <span class="entity">entails_equiv_backward_th</span><span class="main">)</span>
                            |&gt; Drule.zero_var_indexes
                            |&gt; <span class="entity">Util.update_name_of_thm</span> <span class="entity">th</span> <span class="inner_quoted">"@backward"</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">thy</span> |&gt; <span class="entity">add_forward_ent_prfstep</span> <span class="entity">forward_th</span>
          |&gt; <span class="entity">add_backward_ent_prfstep</span> <span class="entity">backward_th</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Rewrite the first command of a Hoare triple. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rewr_first_cmd</span> <span class="entity">eq_th</span> <span class="entity">ct</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">c</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ct</span> |&gt; Thm.term_of |&gt; <span class="entity">dest_hoare_triple</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_bind_cmd</span> <span class="entity">c</span> <span class="keyword2"><span class="keyword">then</span></span>
        Conv.arg1_conv <span class="main">(</span>Conv.arg1_conv <span class="main">(</span><span class="entity">rewr_obj_eq</span> <span class="entity">eq_th</span><span class="main">)</span><span class="main">)</span> <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        Conv.arg1_conv <span class="main">(</span><span class="entity">rewr_obj_eq</span> <span class="entity">eq_th</span><span class="main">)</span> <span class="entity">ct</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Apply rewrite to the first command in CODE_POS. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rewrite_pos_fn</span> <span class="entity">ctxt</span> <span class="entity">item1</span> <span class="entity">item2</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_implies_item</span> <span class="entity">item1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id1</span><span class="main">,</span> prop <span class="main">=</span> <span class="entity">th</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">item1</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id2</span><span class="main">,</span> prop <span class="main">=</span> <span class="entity">eq_th</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">item2</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">c</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">th</span> |&gt; <span class="entity">prop_of'</span> |&gt; <span class="entity">dest_not</span> |&gt; <span class="entity">dest_hoare_triple</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">c'</span> <span class="main">=</span> <span class="entity">get_first_cmd</span> <span class="entity">c</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">c1</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">eq_th</span> |&gt; <span class="entity">prop_of'</span> |&gt; <span class="entity">dest_eq</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id</span> <span class="main">=</span> <span class="entity">BoxID.merge_boxes</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">id1</span><span class="main">,</span> <span class="entity">id2</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">BoxID.has_incr_id</span> <span class="entity">id</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">c1</span> aconv <span class="entity">c'</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th'</span> <span class="main">=</span> <span class="entity">th</span> |&gt; <span class="entity">apply_to_thm'</span> <span class="main">(</span>Conv.arg_conv <span class="main">(</span><span class="entity">rewr_first_cmd</span> <span class="entity">eq_th</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="main">[</span><span class="entity">hoare_goal_update</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">th'</span><span class="main">)</span><span class="main">,</span>
           <span class="entity">ShadowItem</span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id</span><span class="main">,</span> item <span class="main">=</span> <span class="entity">item1</span><span class="main">}</span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rewrite_pos</span> <span class="main">=</span>
    <span class="main">{</span>name <span class="main">=</span> <span class="inner_quoted">"sep.rewrite_pos"</span><span class="main">,</span>
     args <span class="main">=</span> <span class="main">[</span><span class="entity">TypedUniv</span> <span class="entity">TY_CODE_POS</span><span class="main">,</span>
             <span class="entity">TypedMatch</span> <span class="main">(</span><span class="entity">TY_EQ</span><span class="main">,</span> <span class="entity">heap_eq_pat</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
     func <span class="main">=</span> <span class="entity">TwoStep</span> <span class="entity">rewrite_pos_fn</span><span class="main">}</span>

<span class="comment1">(* Extract the pure pre-conditions from a Hoare triple fact. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">extract_pure_hoare_cv</span> <span class="entity">ct</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">P</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ct</span> |&gt; Thm.term_of |&gt; <span class="entity">dest_hoare_triple</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_pure_assn</span> <span class="entity">P</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">rewr_obj_eq</span> <span class="entity">norm_pre_pure_iff2_th</span> <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">UtilArith.is_times</span> <span class="entity">P</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">is_pure_assn</span> <span class="main">(</span><span class="entity">dest_arg</span> <span class="entity">P</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
        Conv.every_conv <span class="main">[</span><span class="entity">rewr_obj_eq</span> <span class="entity">norm_pre_pure_iff_th</span><span class="main">,</span>
                         Conv.arg_conv <span class="entity">extract_pure_hoare_cv</span><span class="main">]</span> <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        Conv.all_conv <span class="entity">ct</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Use a Hoare triple to advance a step in CODE_POS. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">match_hoare_th</span> <span class="entity">id</span> <span class="entity">ctxt</span> <span class="entity">hoare_th</span> <span class="entity">goal</span> <span class="entity">item</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">P</span><span class="main">,</span> <span class="entity">c</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">goal</span> |&gt; <span class="entity">prop_of'</span> |&gt; <span class="entity">dest_not</span> |&gt; <span class="entity">dest_hoare_triple</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">c'</span> <span class="main">=</span> <span class="entity">get_first_cmd</span> <span class="entity">c</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">P'</span><span class="main">,</span> <span class="entity">pat</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_hoare_triple</span> <span class="main">(</span><span class="entity">prop_of'</span> <span class="entity">hoare_th</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cc</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">c'</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts</span> <span class="main">=</span> <span class="entity">Matcher.rewrite_match</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">cc</span><span class="main">)</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">fo_init</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_inst</span> <span class="main">(</span><span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span><span class="main">,</span> <span class="entity">eq_th</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">P''</span> <span class="main">=</span> <span class="entity">P'</span> |&gt; <span class="entity">strip_pure_assn</span>
                         |&gt; <span class="entity">Util.subst_term_norm</span> <span class="entity">inst</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cP</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">P</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts'</span> <span class="main">=</span>
                <span class="main">(</span><span class="entity">AssnMatcher.assn_match_all</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">P''</span><span class="main">,</span> <span class="entity">cP</span><span class="main">)</span> <span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">inst</span><span class="main">)</span><span class="main">)</span>
                    |&gt; filter <span class="main">(</span><span class="entity">BoxID.has_incr_id</span> o fst o fst<span class="main">)</span>

            <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_inst'</span> <span class="main">(</span><span class="main">(</span><span class="entity">id''</span><span class="main">,</span> <span class="entity">inst'</span><span class="main">)</span><span class="main">,</span> <span class="entity">ent_th</span><span class="main">)</span> <span class="main">=</span>
                <span class="keyword2"><span class="keyword">let</span></span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">hoare_th</span> <span class="main">=</span>
                      <span class="main">(</span><span class="entity">Util.subst_thm</span> <span class="entity">ctxt</span> <span class="entity">inst'</span> <span class="entity">hoare_th</span><span class="main">)</span>
                          |&gt; <span class="entity">apply_to_thm'</span> <span class="main">(</span>Conv.arg1_conv <span class="main">(</span>Conv.rewr_conv <span class="entity">eq_th</span><span class="main">)</span><span class="main">)</span>
                          |&gt; <span class="entity">apply_to_thm'</span> <span class="entity">extract_pure_hoare_cv</span>
                          |&gt; <span class="entity">apply_to_thm</span> <span class="main">(</span><span class="entity">UtilLogic.to_meta_conv</span> <span class="entity">ctxt</span><span class="main">)</span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">hoare_th'</span> <span class="main">=</span>
                      <span class="main">[</span><span class="entity">hoare_th</span><span class="main">,</span> <span class="entity">ent_th</span><span class="main">]</span> MRS <span class="entity">pre_rule_th''</span>
                <span class="keyword2"><span class="keyword">in</span></span>
                  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_bind_cmd</span> <span class="entity">c</span> <span class="keyword2"><span class="keyword">then</span></span>
                    <span class="keyword2"><span class="keyword">let</span></span>
                      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">return_var</span> <span class="main">=</span> <span class="entity">extract_return_var</span> <span class="entity">c</span>
                      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th'</span> <span class="main">=</span> <span class="main">[</span><span class="entity">hoare_th'</span><span class="main">,</span> <span class="entity">goal</span><span class="main">]</span> MRS <span class="entity">bind_rule_th'</span>
                      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">(</span><span class="entity">assms</span><span class="main">,</span> <span class="entity">concl</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">th'</span> |&gt; Thm.prop_of
                                                    |&gt; <span class="entity">Util.strip_meta_horn</span>
                      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl'</span> <span class="main">=</span> <span class="entity">concl</span> |&gt; <span class="entity">dest_Trueprop</span>
                                         |&gt; <span class="entity">Util.rename_abs_term</span> <span class="main">[</span><span class="entity">return_var</span><span class="main">]</span>
                                         |&gt; <span class="entity">mk_Trueprop</span>
                      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t'</span> <span class="main">=</span> <span class="entity">Util.list_meta_horn</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="entity">assms</span><span class="main">,</span> <span class="entity">concl'</span><span class="main">)</span><span class="main">)</span>
                      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th'</span> <span class="main">=</span> Thm.renamed_prop <span class="entity">t'</span> <span class="entity">th'</span>
                    <span class="keyword2"><span class="keyword">in</span></span>
                      <span class="main">[</span><span class="entity">hoare_goal_update</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">id''</span><span class="main">,</span> <span class="entity">th'</span><span class="main">)</span><span class="main">,</span>
                       <span class="entity">ShadowItem</span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id''</span><span class="main">,</span> item <span class="main">=</span> <span class="entity">item</span><span class="main">}</span><span class="main">]</span>
                    <span class="keyword2"><span class="keyword">end</span></span>
                  <span class="keyword2"><span class="keyword">else</span></span>
                    <span class="main">[</span><span class="entity">entail_goal_update</span>
                         <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">id''</span><span class="main">,</span> <span class="main">[</span><span class="entity">hoare_th'</span><span class="main">,</span> <span class="entity">goal</span><span class="main">]</span> MRS <span class="entity">post_rule_th'</span><span class="main">)</span><span class="main">,</span>
                     <span class="entity">ShadowItem</span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id''</span><span class="main">,</span> item <span class="main">=</span> <span class="entity">item</span><span class="main">}</span><span class="main">]</span>
                <span class="keyword2"><span class="keyword">end</span></span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">insts'</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">process_inst'</span> <span class="main">(</span>hd <span class="entity">insts'</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">insts</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">process_inst</span> <span class="main">(</span>hd <span class="entity">insts</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Match with PROP or DISJ items that are Hoare triples. In this
   function, we assume item1 is a Hoare triple (and item2 is the
   CODE_POS item).
 *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">match_hoare_prop_fn</span> <span class="entity">ctxt</span> <span class="entity">item1</span> <span class="entity">item2</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_implies_item</span> <span class="entity">item2</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id1</span><span class="main">,</span> prop <span class="main">=</span> <span class="entity">hoare_th</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">item1</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id2</span><span class="main">,</span> prop <span class="main">=</span> <span class="entity">goal</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">item2</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id</span> <span class="main">=</span> <span class="entity">BoxID.merge_boxes</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">id1</span><span class="main">,</span> <span class="entity">id2</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">match_hoare_th</span> <span class="entity">id</span> <span class="entity">ctxt</span> <span class="entity">hoare_th</span> <span class="entity">goal</span> <span class="entity">item2</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">match_hoare_prop</span> <span class="main">=</span>
    <span class="main">{</span>name <span class="main">=</span> <span class="inner_quoted">"sep.match_hoare_prop"</span><span class="main">,</span>
     args <span class="main">=</span> <span class="main">[</span><span class="entity">TypedMatch</span> <span class="main">(</span><span class="entity">TY_PROP</span><span class="main">,</span> <span class="entity">hoare_triple_pat</span><span class="main">)</span><span class="main">,</span>
             <span class="entity">TypedUniv</span> <span class="entity">TY_CODE_POS</span><span class="main">]</span><span class="main">,</span>
     func <span class="main">=</span> <span class="entity">TwoStep</span> <span class="entity">match_hoare_prop_fn</span><span class="main">}</span>

<span class="comment1">(* For DISJ items, check that it is a Hoare triple. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">match_hoare_disj_fn</span> <span class="entity">ctxt</span> <span class="entity">item1</span> <span class="entity">item2</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_implies_item</span> <span class="entity">item2</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">tname</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">item1</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">csubs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Logic_ProofSteps.dest_tname_of_disj</span> <span class="entity">tname</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">subs</span> <span class="main">=</span> map Thm.term_of <span class="entity">csubs</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> length <span class="entity">subs</span> &gt; <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">is_hoare_triple</span> <span class="main">(</span>the_single <span class="entity">subs</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">match_hoare_prop_fn</span> <span class="entity">ctxt</span> <span class="entity">item1</span> <span class="entity">item2</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">match_hoare_disj</span> <span class="main">=</span>
    <span class="main">{</span>name <span class="main">=</span> <span class="inner_quoted">"sep.match_hoare_disj"</span><span class="main">,</span>
     args <span class="main">=</span> <span class="main">[</span><span class="entity">TypedUniv</span> <span class="entity">TY_DISJ</span><span class="main">,</span> <span class="entity">TypedUniv</span> <span class="entity">TY_CODE_POS</span><span class="main">]</span><span class="main">,</span>
     func <span class="main">=</span> <span class="entity">TwoStep</span> <span class="entity">match_hoare_disj_fn</span><span class="main">}</span>

<span class="comment1">(* Match a MATCH_POS item with hoare triple &lt;P * ↑(b)&gt; c &lt;Q&gt; with
   proposition b, resulting in a new MATCH_POS item (shadowing the
   original one) with hoare triple &lt;P&gt; c &lt;Q&gt;. Only work in the case
   where there are no schematic variables in b.
 *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">match_assn_pure_fn</span> <span class="entity">ctxt</span> <span class="entity">item1</span> <span class="entity">item2</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">id</span><span class="main">,</span> <span class="entity">prop</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">item1</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">Util.is_implies</span> <span class="main">(</span>Thm.prop_of <span class="entity">prop</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">A</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> Logic.dest_implies <span class="main">(</span>Thm.prop_of <span class="entity">prop</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pat</span> <span class="main">=</span> <span class="entity">PropMatch</span> <span class="main">(</span><span class="entity">dest_Trueprop</span> <span class="entity">A</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts</span> <span class="main">=</span> <span class="main">(</span><span class="entity">ItemIO.match_arg</span> <span class="entity">ctxt</span> <span class="entity">pat</span> <span class="entity">item2</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">fo_init</span><span class="main">)</span><span class="main">)</span>
                          |&gt; filter <span class="main">(</span><span class="entity">BoxID.has_incr_id</span> o fst o fst<span class="main">)</span>

          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_inst</span> <span class="main">(</span><span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">th</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">[</span><span class="entity">hoare_goal_update</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">th</span> RS <span class="entity">prop</span><span class="main">)</span><span class="main">,</span>
               <span class="entity">ShadowItem</span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id'</span><span class="main">,</span> item <span class="main">=</span> <span class="entity">item1</span><span class="main">}</span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          maps <span class="entity">process_inst</span> <span class="entity">insts</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">match_assn_pure</span> <span class="main">=</span>
    <span class="main">{</span>name <span class="main">=</span> <span class="inner_quoted">"sep.match_assn_pure"</span><span class="main">,</span>
     args <span class="main">=</span> <span class="main">[</span><span class="entity">TypedUniv</span> <span class="entity">TY_CODE_POS</span><span class="main">,</span>
             <span class="entity">PropMatch</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term_pat</span> <span class="quoted">"<span class="var">?b</span><span class="main">::</span>bool"</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
     func <span class="main">=</span> <span class="entity">TwoStep</span> <span class="entity">match_assn_pure_fn</span><span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">hoare_create_case_fn</span> <span class="main">_</span> <span class="entity">item</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">id</span><span class="main">,</span> <span class="entity">prop</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">item</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">BoxID.has_incr_id</span> <span class="entity">id</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">Util.is_implies</span> <span class="main">(</span>Thm.prop_of <span class="entity">prop</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">A</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> Logic.dest_implies <span class="main">(</span>Thm.prop_of <span class="entity">prop</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="main">[</span><span class="entity">AddBoxes</span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id</span><span class="main">,</span> sc <span class="main">=</span> SOME <span class="inner_numeral">1</span><span class="main">,</span> init_assum <span class="main">=</span> <span class="entity">get_neg'</span> <span class="entity">A</span><span class="main">}</span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">hoare_create_case</span> <span class="main">=</span>
    <span class="main">{</span>name <span class="main">=</span> <span class="inner_quoted">"sep.hoare_create_case"</span><span class="main">,</span>
     args <span class="main">=</span> <span class="main">[</span><span class="entity">TypedUniv</span> <span class="entity">TY_CODE_POS</span><span class="main">]</span><span class="main">,</span>
     func <span class="main">=</span> <span class="entity">OneStep</span> <span class="entity">hoare_create_case_fn</span><span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">entail_pure_fn</span> <span class="entity">ctxt</span> <span class="entity">item1</span> <span class="entity">item2</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">id</span><span class="main">,</span> <span class="entity">prop</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">item1</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">Util.is_implies</span> <span class="main">(</span>Thm.prop_of <span class="entity">prop</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">A</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> Logic.dest_implies <span class="main">(</span>Thm.prop_of <span class="entity">prop</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pat</span> <span class="main">=</span> <span class="entity">PropMatch</span> <span class="main">(</span><span class="entity">dest_Trueprop</span> <span class="entity">A</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insts</span> <span class="main">=</span> <span class="main">(</span><span class="entity">ItemIO.match_arg</span> <span class="entity">ctxt</span> <span class="entity">pat</span> <span class="entity">item2</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">fo_init</span><span class="main">)</span><span class="main">)</span>
                          |&gt; filter <span class="main">(</span><span class="entity">BoxID.has_incr_id</span> o fst o fst<span class="main">)</span>

          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_inst</span> <span class="main">(</span><span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">th</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">[</span><span class="entity">entail_goal_update</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">id'</span><span class="main">,</span> <span class="entity">th</span> RS <span class="entity">prop</span><span class="main">)</span><span class="main">,</span>
               <span class="entity">ShadowItem</span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id'</span><span class="main">,</span> item <span class="main">=</span> <span class="entity">item1</span><span class="main">}</span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          maps <span class="entity">process_inst</span> <span class="entity">insts</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">entail_pure</span> <span class="main">=</span>
    <span class="main">{</span>name <span class="main">=</span> <span class="inner_quoted">"sep.entail_pure"</span><span class="main">,</span>
     args <span class="main">=</span> <span class="main">[</span><span class="entity">TypedUniv</span> <span class="entity">TY_ENTAIL</span><span class="main">,</span>
             <span class="entity">PropMatch</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term_pat</span> <span class="quoted">"<span class="var">?b</span><span class="main">::</span>bool"</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
     func <span class="main">=</span> <span class="entity">TwoStep</span> <span class="entity">entail_pure_fn</span><span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">entail_create_case_fn</span> <span class="main">_</span> <span class="entity">item</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">id</span><span class="main">,</span> <span class="entity">prop</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">item</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">BoxID.has_incr_id</span> <span class="entity">id</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">Util.is_implies</span> <span class="main">(</span>Thm.prop_of <span class="entity">prop</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">A</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> Logic.dest_implies <span class="main">(</span>Thm.prop_of <span class="entity">prop</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="main">[</span><span class="entity">AddBoxes</span> <span class="main">{</span>id <span class="main">=</span> <span class="entity">id</span><span class="main">,</span> sc <span class="main">=</span> SOME <span class="inner_numeral">1</span><span class="main">,</span> init_assum <span class="main">=</span> <span class="entity">get_neg'</span> <span class="entity">A</span><span class="main">}</span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">entail_create_case</span> <span class="main">=</span>
    <span class="main">{</span>name <span class="main">=</span> <span class="inner_quoted">"sep.entail_create_case"</span><span class="main">,</span>
     args <span class="main">=</span> <span class="main">[</span><span class="entity">TypedUniv</span> <span class="entity">TY_ENTAIL</span><span class="main">]</span><span class="main">,</span>
     func <span class="main">=</span> <span class="entity">OneStep</span> <span class="entity">entail_create_case_fn</span><span class="main">}</span>

<span class="comment1">(* Matching CODE_POS with an existing Hoare triple. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">hoare_triple_fn</span> <span class="entity">ctxt</span> <span class="entity">item</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_implies_item</span> <span class="entity">item</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> Proof_Context.theory_of <span class="entity">ctxt</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">id</span><span class="main">,</span> prop <span class="main">=</span> <span class="entity">goal</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">item</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">c</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">goal</span> |&gt; <span class="entity">prop_of'</span> |&gt; <span class="entity">dest_not</span> |&gt; <span class="entity">dest_hoare_triple</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">hoare_ths</span> <span class="main">=</span> <span class="entity">c</span> |&gt; <span class="entity">get_first_cmd</span> |&gt; <span class="entity">Util.get_head_name</span>
                        |&gt; <span class="entity">get_hoare_triples</span> <span class="entity">thy</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      maps <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">hoare_th</span> <span class="main">=&gt;</span> <span class="entity">match_hoare_th</span> <span class="entity">id</span> <span class="entity">ctxt</span> <span class="entity">hoare_th</span> <span class="entity">goal</span> <span class="entity">item</span><span class="main">)</span> <span class="entity">hoare_ths</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">hoare_triple</span> <span class="main">=</span>
    <span class="main">{</span>name <span class="main">=</span> <span class="inner_quoted">"sep.hoare_triple"</span><span class="main">,</span>
     args <span class="main">=</span> <span class="main">[</span><span class="entity">TypedUniv</span> <span class="entity">TY_CODE_POS</span><span class="main">]</span><span class="main">,</span>
     func <span class="main">=</span> <span class="entity">OneStep</span> <span class="entity">hoare_triple_fn</span><span class="main">}</span>

<span class="comment1">(* Contract a Hoare triple to &lt;P&gt; c &lt;Q&gt; form. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">contract_hoare_cv'</span> <span class="entity">ct</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_imp</span> <span class="main">(</span>Thm.term_of <span class="entity">ct</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
      Conv.every_conv <span class="main">[</span>Conv.arg_conv <span class="entity">contract_hoare_cv'</span><span class="main">,</span>
                       <span class="entity">rewr_obj_eq</span> <span class="main">(</span><span class="entity">obj_sym</span> <span class="entity">norm_pre_pure_iff_th</span><span class="main">)</span><span class="main">]</span> <span class="entity">ct</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      Conv.all_conv <span class="entity">ct</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">contract_hoare_cv</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span>
    Conv.every_conv <span class="main">[</span><span class="entity">contract_hoare_cv'</span><span class="main">,</span> <span class="entity">norm_precond</span> <span class="entity">ctxt</span><span class="main">]</span> <span class="entity">ct</span>

<span class="comment1">(* Given hoare_th of the form &lt;?P&gt; ?c &lt;?Q&gt;, produce proofstep matching
   item1 with CODE_POS (?h, ?c) and item2 with proposition ?h |= ?P *
   ?Ru.
 *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_hoare_triple_prfstep</span> <span class="entity">hoare_th</span> <span class="entity">thy</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="entity">Util.name_of_thm</span> <span class="entity">hoare_th</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Proof_Context.init_global <span class="entity">thy</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">hoare_th'</span> <span class="main">=</span>
          <span class="entity">hoare_th</span> |&gt; <span class="entity">apply_to_thm</span> <span class="main">(</span><span class="entity">UtilLogic.to_obj_conv</span> <span class="entity">ctxt</span><span class="main">)</span>
                   |&gt; <span class="entity">apply_to_thm'</span> <span class="main">(</span><span class="entity">contract_hoare_cv</span> <span class="entity">ctxt</span><span class="main">)</span>
                   |&gt; <span class="entity">Util.update_name_of_thm</span> <span class="entity">hoare_th</span> <span class="inner_quoted">""</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> writeln <span class="main">(</span><span class="inner_quoted">"Add Hoare triple "</span> ^ <span class="entity">name</span> ^ <span class="inner_quoted">"\n"</span> ^
                       Syntax.string_of_term <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">prop_of'</span> <span class="entity">hoare_th'</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">thy</span> |&gt; <span class="entity">update_hoare_triple</span> <span class="entity">hoare_th'</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">code_pos_terms</span> <span class="entity">ts</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> the_single <span class="entity">ts</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> fastype_of <span class="entity">t</span> <span class="main">=</span> <span class="entity">propT</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">P</span><span class="main">,</span> <span class="entity">c</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">t</span> |&gt; <span class="entity">dest_not</span> |&gt; <span class="entity">dest_hoare_triple</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">SepUtil.assn_rewr_terms</span> <span class="entity">P</span> @ <span class="main">[</span><span class="entity">get_first_cmd</span> <span class="entity">c</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">entail_terms</span> <span class="entity">ts</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> the_single <span class="entity">ts</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> fastype_of <span class="entity">t</span> <span class="main">=</span> <span class="entity">propT</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">P</span><span class="main">,</span> <span class="entity">Q</span><span class="main">)</span> <span class="main">=</span> <span class="entity">t</span> |&gt; <span class="entity">dest_not</span> |&gt; <span class="entity">dest_entail</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        maps <span class="entity">SepUtil.assn_rewr_terms</span> <span class="main">[</span><span class="entity">P</span><span class="main">,</span> <span class="entity">Q</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_sep_logic_proofsteps</span> <span class="main">=</span>
    fold <span class="entity">ItemIO.add_item_type</span> <span class="main">[</span>
      <span class="main">(</span><span class="entity">TY_CODE_POS</span><span class="main">,</span> SOME <span class="entity">code_pos_terms</span><span class="main">,</span> NONE<span class="main">,</span> NONE<span class="main">)</span><span class="main">,</span>
      <span class="main">(</span><span class="entity">TY_ENTAIL</span><span class="main">,</span> SOME <span class="entity">entail_terms</span><span class="main">,</span> NONE<span class="main">,</span> NONE<span class="main">)</span>

    <span class="main">]</span> #&gt; fold <span class="entity">add_prfstep</span> <span class="main">[</span>
      <span class="entity">init_entail</span><span class="main">,</span> <span class="entity">entails_resolve</span><span class="main">,</span>
      <span class="entity">init_pos</span><span class="main">,</span> <span class="entity">rewrite_pos</span><span class="main">,</span> <span class="entity">match_assn_pure</span><span class="main">,</span> <span class="entity">hoare_triple</span><span class="main">,</span>
      <span class="entity">match_hoare_disj</span><span class="main">,</span> <span class="entity">match_hoare_prop</span><span class="main">,</span> <span class="entity">hoare_create_case</span><span class="main">,</span>
      <span class="entity">entail_pure</span><span class="main">,</span> <span class="entity">entail_create_case</span>
    <span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>  <span class="comment1">(* structure SepLogic *)</span>
</pre>
</div><div id="SepAuto">
<div class="head">
<h1>Theory SepAuto</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: SepAuto.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Separation logic›</span></span>

<span class="keyword1"><span class="command">theory</span></span> SepAuto
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="SepLogic_Base.html">SepLogic_Base</a> <span class="quoted">"<a href="../../HOL/HOL-Imperative_HOL/Imperative_HOL.html">HOL-Imperative_HOL.Imperative_HOL</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Separation logic for Imperative\_HOL, and setup of auto2. The development of
  separation logic here follows \cite{Separation_Logic_Imperative_HOL-AFP} by Lammich and Meis.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Partial Heaps›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> pheap <span class="main">=</span> pHeap <span class="main">(</span><span class="free"><span class="entity">heapOf</span></span><span class="main">:</span> <span class="quoted">heap</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">addrOf</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"addr set"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_simple_datatype</span> <span class="inner_quoted">"pheap"</span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">in_range</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>heap <span class="main">×</span> addr set<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">in_range</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> lim <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> in_range.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Two heaps agree on a set of addresses.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">relH</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"addr set <span class="main">⇒</span> heap <span class="main">⇒</span> heap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">relH</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">h'</span></span></span> <span class="main">=</span> <span class="main">(</span>in_range <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">∧</span> in_range <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">.</span> refs <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">t</span> <span class="bound">a</span> <span class="main">=</span> refs <span class="free"><span class="bound"><span class="entity">h'</span></span></span> <span class="bound">t</span> <span class="bound">a</span> <span class="main">∧</span> arrays <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">t</span> <span class="bound">a</span> <span class="main">=</span> arrays <span class="free"><span class="bound"><span class="entity">h'</span></span></span> <span class="bound">t</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SepAuto-relH_D"><span class="command">lemma</span></span> relH_D <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"relH <span class="free">as</span> <span class="free">h</span> <span class="free">h'</span> <span class="main">⟹</span> in_range <span class="main">(</span><span class="free">h</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">∧</span> in_range <span class="main">(</span><span class="free">h'</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="SepAuto-relH_D2"><span class="command">lemma</span></span> relH_D2 <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"relH <span class="free">as</span> <span class="free">h</span> <span class="free">h'</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">⟹</span> refs <span class="free">h</span> <span class="free">t</span> <span class="free">a</span> <span class="main">=</span> refs <span class="free">h'</span> <span class="free">t</span> <span class="free">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"relH <span class="free">as</span> <span class="free">h</span> <span class="free">h'</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">⟹</span> arrays <span class="free">h</span> <span class="free">t</span> <span class="free">a</span> <span class="main">=</span> arrays <span class="free">h'</span> <span class="free">t</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm_eqforward</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> relH_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="SepAuto-relH_dist_union"><span class="command">lemma</span></span> relH_dist_union <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"relH <span class="main">(</span><span class="free">as</span> <span class="main">∪</span> <span class="free">as'</span><span class="main">)</span> <span class="free">h</span> <span class="free">h'</span> <span class="main">⟹</span> relH <span class="free">as</span> <span class="free">h</span> <span class="free">h'</span> <span class="main">∧</span> relH <span class="free">as'</span> <span class="free">h</span> <span class="free">h'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="SepAuto-relH_ref"><span class="command">lemma</span></span> relH_ref <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"relH <span class="free">as</span> <span class="free">h</span> <span class="free">h'</span> <span class="main">⟹</span> addr_of_ref <span class="free">r</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">⟹</span> Ref.get <span class="free">h</span> <span class="free">r</span> <span class="main">=</span> Ref.get <span class="free">h'</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ref.get_def relH_def<span class="main">)</span>

<span class="keyword1" id="SepAuto-relH_array"><span class="command">lemma</span></span> relH_array <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"relH <span class="free">as</span> <span class="free">h</span> <span class="free">h'</span> <span class="main">⟹</span> addr_of_array <span class="free">r</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">⟹</span> Array.get <span class="free">h</span> <span class="free">r</span> <span class="main">=</span> Array.get <span class="free">h'</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Array.get_def relH_def<span class="main">)</span>

<span class="keyword1" id="SepAuto-relH_set_ref"><span class="command">lemma</span></span> relH_set_ref <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"relH <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> lim <span class="free">h</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∉</span> <span class="main">{</span>addr_of_ref <span class="free">r</span><span class="main">}</span><span class="main">}</span> <span class="free">h</span> <span class="main">(</span>Ref.set <span class="free">r</span> <span class="free">x</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ref.set_def relH_def<span class="main">)</span>

<span class="keyword1" id="SepAuto-relH_set_array"><span class="command">lemma</span></span> relH_set_array <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"relH <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> lim <span class="free">h</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∉</span> <span class="main">{</span>addr_of_array <span class="free">r</span><span class="main">}</span><span class="main">}</span> <span class="free">h</span> <span class="main">(</span>Array.set <span class="free">r</span> <span class="free">x</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Array.set_def relH_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Assertions›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> assn_raw <span class="main">=</span> Assn <span class="main">(</span><span class="free"><span class="entity">assn_fn</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"pheap <span class="main">⇒</span> bool"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">aseval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"assn_raw <span class="main">⇒</span> pheap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">aseval</span> <span class="main">(</span>Assn <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> aseval.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">proper</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"assn_raw <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">proper</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">h</span> <span class="bound">as</span><span class="main">.</span> aseval <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>pHeap <span class="bound">h</span> <span class="bound">as</span><span class="main">)</span> <span class="main">⟶</span> in_range <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">as</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">h</span> <span class="bound">h'</span> <span class="bound">as</span><span class="main">.</span> aseval <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>pHeap <span class="bound">h</span> <span class="bound">as</span><span class="main">)</span> <span class="main">⟶</span> relH <span class="bound">as</span> <span class="bound">h</span> <span class="bound">h'</span> <span class="main">⟶</span> in_range <span class="main">(</span><span class="bound">h'</span><span class="main">,</span><span class="bound">as</span><span class="main">)</span> <span class="main">⟶</span> aseval <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>pHeap <span class="bound">h'</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">in_range_assn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pheap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">in_range_assn</span> <span class="main">(</span>pHeap <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> lim <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> in_range_assn.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">typedef</span></span> assn <span class="main">=</span> <span class="quoted"><span class="quoted">"Collect proper"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"Assn in_range_assn <span class="main">∈</span> Collect proper"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Rep_assn_inject<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">register_wellform_data</span> <span class="main">(</span><span class="inner_quoted">"Abs_assn P"</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">"proper P"</span><span class="main">]</span><span class="main">)</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_prfstep_check_req</span> <span class="main">(</span><span class="inner_quoted">"Abs_assn P"</span><span class="main">,</span> <span class="inner_quoted">"proper P"</span><span class="main">)</span>›</span>

<span class="keyword1" id="SepAuto-Abs_assn_inverse'"><span class="command">lemma</span></span> Abs_assn_inverse' <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="free">y</span> <span class="main">⟹</span> Rep_assn <span class="main">(</span>Abs_assn <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_assn_inverse<span class="main">)</span>

<span class="keyword1" id="SepAuto-proper_Rep_assn"><span class="command">lemma</span></span> proper_Rep_assn <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"proper <span class="main">(</span>Rep_assn <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Rep_assn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">models</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pheap <span class="main">⇒</span> assn <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite_bidir</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟷</span> aseval <span class="main">(</span>Rep_assn <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>

<span class="keyword1" id="SepAuto-models_in_range"><span class="command">lemma</span></span> models_in_range <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">⟹</span> in_range <span class="main">(</span><span class="free">h</span><span class="main">,</span><span class="free">as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="SepAuto-mod_relH"><span class="command">lemma</span></span> mod_relH <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"relH <span class="free">as</span> <span class="free">h</span> <span class="free">h'</span> <span class="main">⟹</span> pHeap <span class="free">h</span> <span class="free">as</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">⟹</span> pHeap <span class="free">h'</span> <span class="free">as</span> <span class="main">⊨</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">instantiation</span></span> assn <span class="main">::</span> <span class="quoted">one</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">one_assn</span></span> <span class="main">::</span> <span class="quoted">assn</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≡</span> Abs_assn <span class="main">(</span>Assn <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> addrOf <span class="bound">h</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">one_assn</span> <span class="main">::</span> <span class="quoted">assn</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">emp</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">one_assn</span> <span class="main">≡</span> <span class="main">1</span>"</span></span>

<span class="keyword1" id="SepAuto-one_assn_rule"><span class="command">lemma</span></span> one_assn_rule <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊨</span> <span class="keyword1">emp</span> <span class="main">⟷</span> addrOf <span class="free">h</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> one_assn_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">instantiation</span></span> assn <span class="main">::</span> <span class="quoted">times</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">times_assn</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> Abs_assn <span class="main">(</span>Assn <span class="main">(</span>
    <span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">as1</span> <span class="bound">as2</span><span class="main">.</span> addrOf <span class="bound">h</span> <span class="main">=</span> <span class="bound">as1</span> <span class="main">∪</span> <span class="bound">as2</span> <span class="main">∧</span> <span class="bound">as1</span> <span class="main">∩</span> <span class="bound">as2</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span>
                   aseval <span class="main">(</span>Rep_assn <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">(</span>pHeap <span class="main">(</span>heapOf <span class="bound">h</span><span class="main">)</span> <span class="bound">as1</span><span class="main">)</span> <span class="main">∧</span> aseval <span class="main">(</span>Rep_assn <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">(</span>pHeap <span class="main">(</span>heapOf <span class="bound">h</span><span class="main">)</span> <span class="bound">as2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="SepAuto-mod_star_conv"><span class="command">lemma</span></span> mod_star_conv <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as</span> <span class="main">⊨</span> <span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">as1</span> <span class="bound">as2</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">as1</span> <span class="main">∪</span> <span class="bound">as2</span> <span class="main">∧</span> <span class="bound">as1</span> <span class="main">∩</span> <span class="bound">as2</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> pHeap <span class="free">h</span> <span class="bound">as1</span> <span class="main">⊨</span> <span class="free">A</span> <span class="main">∧</span> pHeap <span class="free">h</span> <span class="bound">as2</span> <span class="main">⊨</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> times_assn_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="SepAuto-aseval_ext"><span class="command">lemma</span></span> aseval_ext <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span><span class="main">.</span> aseval <span class="free">P</span> <span class="bound">h</span> <span class="main">=</span> aseval <span class="free">P'</span> <span class="bound">h</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">=</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">P'</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SepAuto-assn_ext"><span class="command">lemma</span></span> assn_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span> <span class="bound">as</span><span class="main">.</span> pHeap <span class="bound">h</span> <span class="bound">as</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">⟷</span> pHeap <span class="bound">h</span> <span class="bound">as</span> <span class="main">⊨</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">=</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"Rep_assn <span class="free">P</span> <span class="main">=</span> Rep_assn <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_backward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> assn_ext<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_filt</span> <span class="main">(</span><span class="entity">order_filter</span> <span class="inner_quoted">"P"</span> <span class="inner_quoted">"Q"</span><span class="main">)</span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> aseval_ext<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="SepAuto-assn_one_left"><span class="command">lemma</span></span> assn_one_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span><span class="main">::</span>assn<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span> <span class="bound">as</span><span class="main">.</span> pHeap <span class="bound">h</span> <span class="bound">as</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">⟷</span> pHeap <span class="bound">h</span> <span class="bound">as</span> <span class="main">⊨</span> <span class="main">1</span> <span class="main">*</span> <span class="free">P</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∪</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="SepAuto-assn_times_comm"><span class="command">lemma</span></span> assn_times_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">*</span> <span class="free">Q</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span><span class="main">::</span>assn<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span> <span class="bound">as</span><span class="main">.</span> pHeap <span class="bound">h</span> <span class="bound">as</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">*</span> <span class="free">Q</span> <span class="main">⟷</span> pHeap <span class="bound">h</span> <span class="bound">as</span> <span class="main">⊨</span> <span class="free">Q</span> <span class="main">*</span> <span class="free">P</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">*</span> <span class="free">Q</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">as1</span></span> <span class="quoted"><span class="free">as2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="free">as1</span> <span class="main">∪</span> <span class="free">as2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as1</span> <span class="main">∩</span> <span class="free">as2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as1</span> <span class="main">⊨</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as2</span> <span class="main">⊨</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="free">as2</span> <span class="main">∪</span> <span class="free">as1</span>"</span></span>
    <span class="keyword1"><span class="command">@end</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as</span> <span class="main">⊨</span> <span class="free">Q</span> <span class="main">*</span> <span class="free">P</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">as1</span></span> <span class="quoted"><span class="free">as2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="free">as1</span> <span class="main">∪</span> <span class="free">as2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as1</span> <span class="main">∩</span> <span class="free">as2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as1</span> <span class="main">⊨</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as2</span> <span class="main">⊨</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="free">as2</span> <span class="main">∪</span> <span class="free">as1</span>"</span></span>
    <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="SepAuto-assn_times_assoc"><span class="command">lemma</span></span> assn_times_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span> <span class="main">=</span> <span class="free">P</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">*</span> <span class="main">(</span><span class="free">R</span><span class="main">::</span>assn<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span> <span class="bound">as</span><span class="main">.</span> pHeap <span class="bound">h</span> <span class="bound">as</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span> <span class="main">⟷</span> pHeap <span class="bound">h</span> <span class="bound">as</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">)</span> <span class="main">*</span> <span class="free">R</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">as1</span></span> <span class="quoted"><span class="free">as2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="free">as1</span> <span class="main">∪</span> <span class="free">as2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as1</span> <span class="main">∩</span> <span class="free">as2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as1</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">*</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as2</span> <span class="main">⊨</span> <span class="free">R</span>"</span></span>
      <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">as11</span></span> <span class="quoted"><span class="free">as12</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">as1</span> <span class="main">=</span> <span class="free">as11</span> <span class="main">∪</span> <span class="free">as12</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as11</span> <span class="main">∩</span> <span class="free">as12</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as11</span> <span class="main">⊨</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as12</span> <span class="main">⊨</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="free">as11</span> <span class="main">∪</span> <span class="main">(</span><span class="free">as12</span> <span class="main">∪</span> <span class="free">as2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@end</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">*</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">as1</span></span> <span class="quoted"><span class="free">as2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="free">as1</span> <span class="main">∪</span> <span class="free">as2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as1</span> <span class="main">∩</span> <span class="free">as2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as1</span> <span class="main">⊨</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as2</span> <span class="main">⊨</span> <span class="free">Q</span> <span class="main">*</span> <span class="free">R</span>"</span></span>
      <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">as21</span></span> <span class="quoted"><span class="free">as22</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">as2</span> <span class="main">=</span> <span class="free">as21</span> <span class="main">∪</span> <span class="free">as22</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as21</span> <span class="main">∩</span> <span class="free">as22</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as21</span> <span class="main">⊨</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as22</span> <span class="main">⊨</span> <span class="free">R</span>"</span></span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="main">(</span><span class="free">as1</span> <span class="main">∪</span> <span class="free">as21</span><span class="main">)</span> <span class="main">∪</span> <span class="free">as22</span>"</span></span>
    <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> assn <span class="main">::</span> <span class="quoted">comm_monoid_mult</span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assn_times_assoc<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assn_times_comm<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assn_one_left<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Existential Quantification›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ex_assn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> assn<span class="main">)</span> <span class="main">⇒</span> assn"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span>"</span> 11<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="free">∃<span class="hidden">⇩</span><sub>A</sub></span></span><span class="bound">x</span><span class="main"><span class="free">.</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> Abs_assn <span class="main">(</span>Assn <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">h</span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SepAuto-mod_ex_dist"><span class="command">lemma</span></span> mod_ex_dist <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">h</span> <span class="main">⊨</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">h</span> <span class="main">⊨</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> ex_assn_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="SepAuto-ex_distrib_star"><span class="command">lemma</span></span> ex_distrib_star<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span> <span class="bound">as</span><span class="main">.</span> pHeap <span class="bound">h</span> <span class="bound">as</span> <span class="main">⊨</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">Q</span> <span class="main">⟷</span> pHeap <span class="bound">h</span> <span class="bound">as</span> <span class="main">⊨</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as</span> <span class="main">⊨</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">Q</span>"</span></span> <span class="main">@with</span>
      <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">as1</span></span> <span class="quoted"><span class="free">as2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="free">as1</span> <span class="main">∪</span> <span class="free">as2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as1</span> <span class="main">∩</span> <span class="free">as2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as1</span> <span class="main">⊨</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as2</span> <span class="main">⊨</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as1</span> <span class="main">⊨</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as</span> <span class="main">⊨</span> <span class="free">P</span> <span class="free">x</span> <span class="main">*</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pointers›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sngr_assn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap ref <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> assn"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span>"</span> 82<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>r</sub></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Abs_assn <span class="main">(</span>Assn <span class="main">(</span>
    <span class="main">λ</span><span class="bound">h</span><span class="main">.</span> Ref.get <span class="main">(</span>heapOf <span class="bound">h</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> addrOf <span class="bound">h</span> <span class="main">=</span> <span class="main">{</span>addr_of_ref <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span> <span class="main">∧</span> addr_of_ref <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&lt;</span> lim <span class="main">(</span>heapOf <span class="bound">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SepAuto-sngr_assn_rule"><span class="command">lemma</span></span> sngr_assn_rule <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as</span> <span class="main">⊨</span> <span class="free">r</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span>Ref.get <span class="free">h</span> <span class="free">r</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">as</span> <span class="main">=</span> <span class="main">{</span>addr_of_ref <span class="free">r</span><span class="main">}</span> <span class="main">∧</span> addr_of_ref <span class="free">r</span> <span class="main">&lt;</span> lim <span class="free">h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> sngr_assn_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">snga_assn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap array <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> assn"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span>"</span> 82<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>a</sub></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Abs_assn <span class="main">(</span>Assn <span class="main">(</span>
    <span class="main">λ</span><span class="bound">h</span><span class="main">.</span> Array.get <span class="main">(</span>heapOf <span class="bound">h</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> addrOf <span class="bound">h</span> <span class="main">=</span> <span class="main">{</span>addr_of_array <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span> <span class="main">∧</span> addr_of_array <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&lt;</span> lim <span class="main">(</span>heapOf <span class="bound">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SepAuto-snga_assn_rule"><span class="command">lemma</span></span> snga_assn_rule <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as</span> <span class="main">⊨</span> <span class="free">r</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span>Array.get <span class="free">h</span> <span class="free">r</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">as</span> <span class="main">=</span> <span class="main">{</span>addr_of_array <span class="free">r</span><span class="main">}</span> <span class="main">∧</span> addr_of_array <span class="free">r</span> <span class="main">&lt;</span> lim <span class="free">h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> snga_assn_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pure Assertions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pure_assn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> assn"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">↑</span></span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> Abs_assn <span class="main">(</span>Assn <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> addrOf <span class="bound">h</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SepAuto-pure_assn_rule"><span class="command">lemma</span></span> pure_assn_rule <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊨</span> <span class="main">↑</span><span class="free">b</span> <span class="main">⟷</span> <span class="main">(</span>addrOf <span class="free">h</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> pure_assn_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">top_assn</span> <span class="main">::</span> <span class="quoted">assn</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">true</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">top_assn</span> <span class="main">=</span> Abs_assn <span class="main">(</span>Assn in_range_assn<span class="main">)</span>"</span></span>

<span class="keyword1" id="SepAuto-top_assn_rule"><span class="command">lemma</span></span> top_assn_rule <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as</span> <span class="main">⊨</span> <span class="keyword1">true</span> <span class="main">⟷</span> in_range <span class="main">(</span><span class="free">h</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> top_assn_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> models_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of assertions›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">bot_assn</span> <span class="main">::</span> <span class="quoted">assn</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">false</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bot_assn</span> <span class="main">≡</span> <span class="main">↑</span>False"</span></span>

<span class="keyword1" id="SepAuto-top_assn_reduce"><span class="command">lemma</span></span> top_assn_reduce<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">true</span> <span class="main">*</span> <span class="keyword1">true</span> <span class="main">=</span> <span class="keyword1">true</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">⊨</span> <span class="keyword1">true</span> <span class="main">⟷</span> <span class="bound">h</span> <span class="main">⊨</span> <span class="keyword1">true</span> <span class="main">*</span> <span class="keyword1">true</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"addrOf <span class="free">h</span> <span class="main">=</span> addrOf <span class="free">h</span> <span class="main">∪</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="SepAuto-mod_pure_star_dist"><span class="command">lemma</span></span> mod_pure_star_dist <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">*</span> <span class="main">↑</span><span class="free">b</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">h</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">∧</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">∧</span> <span class="free">b</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"addrOf <span class="free">h</span> <span class="main">=</span> addrOf <span class="free">h</span> <span class="main">∪</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="SepAuto-pure_conj"><span class="command">lemma</span></span> pure_conj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">↑</span><span class="main">(</span><span class="free">P</span> <span class="main">∧</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">↑</span><span class="free">P</span> <span class="main">*</span> <span class="main">↑</span><span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Entailment and its properties›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">entails</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"assn <span class="main">⇒</span> assn <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span>"</span> 10<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">⟹<span class="hidden">⇩</span><sub>A</sub></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟶</span> <span class="bound">h</span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SepAuto-entails_triv"><span class="command">lemma</span></span> entails_triv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="SepAuto-entails_true"><span class="command">lemma</span></span> entails_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="keyword1">true</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="SepAuto-entails_frame"><span class="command">lemma</span></span> entails_frame <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">*</span> <span class="free">R</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span> <span class="main">*</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="SepAuto-entails_frame'"><span class="command">lemma</span></span> entails_frame'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">F</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="free">B</span> <span class="main">*</span> <span class="free">F</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="SepAuto-entails_frame''"><span class="command">lemma</span></span> entails_frame''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">B</span> <span class="main">*</span> <span class="free">F</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">A</span> <span class="main">*</span> <span class="free">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="SepAuto-entails_equiv_forward"><span class="command">lemma</span></span> entails_equiv_forward<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="SepAuto-entails_equiv_backward"><span class="command">lemma</span></span> entails_equiv_backward<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="SepAuto-entailsD"><span class="command">lemma</span></span> entailsD <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">⊨</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="SepAuto-entails_trans2"><span class="command">lemma</span></span> entails_trans2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">D</span> <span class="main">*</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">B</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">D</span> <span class="main">*</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="SepAuto-entails_pure'"><span class="command">lemma</span></span> entails_pure'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">↑</span><span class="free">b</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">¬</span><span class="main">(</span><span class="keyword1">emp</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span><span class="main">)</span> <span class="main">∧</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="SepAuto-entails_pure"><span class="command">lemma</span></span> entails_pure<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="main">↑</span><span class="free">b</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">¬</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span><span class="main">)</span> <span class="main">∧</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="SepAuto-entails_ex"><span class="command">lemma</span></span> entails_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="free">P</span> <span class="bound">x</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="SepAuto-entails_ex_post"><span class="command">lemma</span></span> entails_ex_post<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="SepAuto-entails_pure_post"><span class="command">lemma</span></span> entails_pure_post<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span> <span class="main">*</span> <span class="main">↑</span><span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">Q</span> <span class="main">⟹</span> <span class="main">¬</span><span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> entails_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of the run predicate›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">run</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Heap <span class="main">⇒</span> heap option <span class="main">⇒</span> heap option <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> None None <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"execute <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> None <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"execute <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_case_induct_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> run.cases<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_resolve_prfstep</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> run.intros<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> run.intros<span class="main">(</span>3<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="SepAuto-run_complete"><span class="command">lemma</span></span> run_complete <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ'</span> <span class="bound">r</span><span class="main">.</span> run <span class="free">c</span> <span class="free">σ</span> <span class="bound">σ'</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">::</span><span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> None"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"run <span class="free">c</span> None None <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"execute <span class="free">c</span> <span class="main">(</span>the <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="main">@with</span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"run <span class="free">c</span> <span class="free">σ</span> None <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="SepAuto-run_to_execute"><span class="command">lemma</span></span> run_to_execute <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"run <span class="free">c</span> <span class="main">(</span>Some <span class="free">h</span><span class="main">)</span> <span class="free">σ'</span> <span class="free">r</span> <span class="main">⟹</span> <span class="keyword1">if</span> <span class="free">σ'</span> <span class="main">=</span> None <span class="keyword1">then</span> execute <span class="free">c</span> <span class="free">h</span> <span class="main">=</span> None <span class="keyword1">else</span> execute <span class="free">c</span> <span class="free">h</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">r</span><span class="main">,</span> the <span class="free">σ'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@case_induct</span></span> <span class="quoted"><span class="quoted">"run <span class="free">c</span> <span class="main">(</span>Some <span class="free">h</span><span class="main">)</span> <span class="free">σ'</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> execute_bind<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>
<span class="keyword1" id="SepAuto-runE"><span class="command">lemma</span></span> runE <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"run <span class="free">f</span> <span class="main">(</span>Some <span class="free">h</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">h'</span><span class="main">)</span> <span class="free">r'</span> <span class="main">⟹</span> run <span class="main">(</span><span class="free">f</span> <span class="main">⤜</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">h</span><span class="main">)</span> <span class="free">σ</span> <span class="free">r</span> <span class="main">⟹</span> run <span class="main">(</span><span class="free">g</span> <span class="free">r'</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">h'</span><span class="main">)</span> <span class="free">σ</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Array.get_alloc<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Ref.get_alloc<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule_bidir</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Array.length_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of hoare triple, and the frame rule.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">new_addrs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> addr set <span class="main">⇒</span> heap <span class="main">⇒</span> addr set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">new_addrs</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">h'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> lim <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> lim <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hoare_triple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"assn <span class="main">⇒</span> <span class="tfree">'a</span> Heap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> assn<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">&lt;</span>_<span class="keyword1">&gt;</span><span class="keyword3">/ </span>_<span class="keyword3">/ </span><span class="keyword1">&lt;</span>_<span class="keyword1">&gt;</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">h</span> <span class="bound">as</span> <span class="bound">σ</span> <span class="bound">r</span><span class="main">.</span> pHeap <span class="bound">h</span> <span class="bound">as</span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟶</span> run <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Some <span class="bound">h</span><span class="main">)</span> <span class="bound">σ</span> <span class="bound">r</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">σ</span> <span class="main">≠</span> None <span class="main">∧</span> pHeap <span class="main">(</span>the <span class="bound">σ</span><span class="main">)</span> <span class="main">(</span>new_addrs <span class="bound">h</span> <span class="bound">as</span> <span class="main">(</span>the <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">r</span> <span class="main">∧</span> relH <span class="main">{</span><span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> lim <span class="bound">h</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∉</span> <span class="bound">as</span><span class="main">}</span> <span class="bound">h</span> <span class="main">(</span>the <span class="bound">σ</span><span class="main">)</span> <span class="main">∧</span>
     lim <span class="bound">h</span> <span class="main">≤</span> lim <span class="main">(</span>the <span class="bound">σ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SepAuto-hoare_tripleD"><span class="command">lemma</span></span> hoare_tripleD <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">P</span><span class="main">&gt;</span> <span class="free">c</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span> <span class="main">⟹</span> run <span class="free">c</span> <span class="main">(</span>Some <span class="free">h</span><span class="main">)</span> <span class="free">σ</span> <span class="free">r</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">as</span><span class="main">.</span> pHeap <span class="free">h</span> <span class="bound">as</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">⟶</span>
     <span class="main">(</span><span class="free">σ</span> <span class="main">≠</span> None <span class="main">∧</span> pHeap <span class="main">(</span>the <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>new_addrs <span class="free">h</span> <span class="bound">as</span> <span class="main">(</span>the <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">Q</span> <span class="free">r</span> <span class="main">∧</span> relH <span class="main">{</span><span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> lim <span class="free">h</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∉</span> <span class="bound">as</span><span class="main">}</span> <span class="free">h</span> <span class="main">(</span>the <span class="free">σ</span><span class="main">)</span> <span class="main">∧</span>
     lim <span class="free">h</span> <span class="main">≤</span> lim <span class="main">(</span>the <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm_eqforward</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> hoare_triple_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">hoare_triple'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"assn <span class="main">⇒</span> <span class="tfree">'r</span> Heap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span> <span class="main">⇒</span> assn<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">&lt;</span>_<span class="keyword1">&gt;</span> _ <span class="keyword1">&lt;</span>_<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="main">≡</span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">r</span> <span class="main">*</span> <span class="keyword1">true</span><span class="main">&gt;</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> frame_rule <span class="main">[</span><span class="operator">backward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">P</span><span class="main">&gt;</span> <span class="free">c</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span> <span class="main">⟹</span> <span class="main">&lt;</span><span class="free">P</span> <span class="main">*</span> <span class="free">R</span><span class="main">&gt;</span> <span class="free">c</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">R</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span> <span class="bound">as</span> <span class="bound">σ</span> <span class="bound">r</span><span class="main">.</span> pHeap <span class="bound">h</span> <span class="bound">as</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">*</span> <span class="free">R</span> <span class="main">⟶</span> run <span class="free">c</span> <span class="main">(</span>Some <span class="bound">h</span><span class="main">)</span> <span class="bound">σ</span> <span class="bound">r</span> <span class="main">⟶</span>
                    <span class="main">(</span><span class="bound">σ</span> <span class="main">≠</span> None <span class="main">∧</span> pHeap <span class="main">(</span>the <span class="bound">σ</span><span class="main">)</span> <span class="main">(</span>new_addrs <span class="bound">h</span> <span class="bound">as</span> <span class="main">(</span>the <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">Q</span> <span class="bound">r</span> <span class="main">*</span> <span class="free">R</span> <span class="main">∧</span>
                     relH <span class="main">{</span><span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> lim <span class="bound">h</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∉</span> <span class="bound">as</span><span class="main">}</span> <span class="bound">h</span> <span class="main">(</span>the <span class="bound">σ</span><span class="main">)</span> <span class="main">∧</span> lim <span class="bound">h</span> <span class="main">≤</span> lim <span class="main">(</span>the <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">as1</span></span> <span class="quoted"><span class="free">as2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="free">as1</span> <span class="main">∪</span> <span class="free">as2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as1</span> <span class="main">∩</span> <span class="free">as2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h</span> <span class="free">as1</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">∧</span> pHeap <span class="free">h</span> <span class="free">as2</span> <span class="main">⊨</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"relH <span class="free">as2</span> <span class="free">h</span> <span class="main">(</span>the <span class="free">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"new_addrs <span class="free">h</span> <span class="free">as</span> <span class="main">(</span>the <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> new_addrs <span class="free">h</span> <span class="free">as1</span> <span class="main">(</span>the <span class="free">σ</span><span class="main">)</span> <span class="main">∪</span> <span class="free">as2</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is the last use of the definition of separating conjunction.›</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> mod_star_conv<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">theorem</span></span> bind_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">P</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">&lt;</span><span class="free">Q</span> <span class="bound">x</span><span class="main">&gt;</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">&lt;</span><span class="free">R</span><span class="main">&gt;</span> <span class="main">⟹</span> <span class="main">&lt;</span><span class="free">P</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">⤜</span> <span class="free">g</span> <span class="main">&lt;</span><span class="free">R</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span> <span class="bound">as</span> <span class="bound">σ</span> <span class="bound">r</span><span class="main">.</span> pHeap <span class="bound">h</span> <span class="bound">as</span> <span class="main">⊨</span> <span class="free">P</span> <span class="main">⟶</span> run <span class="main">(</span><span class="free">f</span> <span class="main">⤜</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">h</span><span class="main">)</span> <span class="bound">σ</span> <span class="bound">r</span> <span class="main">⟶</span>
                    <span class="main">(</span><span class="bound">σ</span> <span class="main">≠</span> None <span class="main">∧</span> pHeap <span class="main">(</span>the <span class="bound">σ</span><span class="main">)</span> <span class="main">(</span>new_addrs <span class="bound">h</span> <span class="bound">as</span> <span class="main">(</span>the <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">R</span> <span class="bound">r</span> <span class="main">∧</span>
                     relH <span class="main">{</span><span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> lim <span class="bound">h</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∉</span> <span class="bound">as</span><span class="main">}</span> <span class="bound">h</span> <span class="main">(</span>the <span class="bound">σ</span><span class="main">)</span> <span class="main">∧</span> lim <span class="bound">h</span> <span class="main">≤</span> lim <span class="main">(</span>the <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">@with</span>
    <span class="comment1">― ‹First step from h to h'›</span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">σ'</span></span> <span class="quoted"><span class="free">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"run <span class="free">f</span> <span class="main">(</span>Some <span class="free">h</span><span class="main">)</span> <span class="free">σ'</span> <span class="free">r'</span>"</span></span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">h'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">=</span> Some <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">as'</span> <span class="main">=</span> new_addrs <span class="free">h</span> <span class="free">as</span> <span class="free">h'</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h'</span> <span class="free">as'</span> <span class="main">⊨</span> <span class="free">Q</span> <span class="free">r'</span>"</span></span>

    <span class="comment1">― ‹Second step from h' to h''›</span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="free">g</span> <span class="free">r'</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">h'</span><span class="main">)</span> <span class="free">σ</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">h''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> Some <span class="free">h''</span>"</span></span>
    <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">as''</span> <span class="main">=</span> new_addrs <span class="free">h'</span> <span class="free">as'</span> <span class="free">h''</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"pHeap <span class="free">h''</span> <span class="free">as''</span> <span class="main">⊨</span> <span class="free">R</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">as''</span> <span class="main">=</span> new_addrs <span class="free">h</span> <span class="free">as</span> <span class="free">h''</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Actual statement used:›</span></span>
<span class="keyword1" id="SepAuto-bind_rule'"><span class="command">lemma</span></span> bind_rule'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">P</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">&lt;</span><span class="free">P</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">⤜</span> <span class="free">g</span> <span class="main">&lt;</span><span class="free">R</span><span class="main">&gt;</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="main">&lt;</span><span class="free">Q</span> <span class="bound">x</span><span class="main">&gt;</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">&lt;</span><span class="free">R</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bind_rule <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="SepAuto-pre_rule'"><span class="command">lemma</span></span> pre_rule'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">&lt;</span><span class="free">P</span> <span class="main">*</span> <span class="free">R</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span> <span class="main">⟹</span> <span class="free">P</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">P'</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">&lt;</span><span class="free">P'</span> <span class="main">*</span> <span class="free">R</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">*</span> <span class="free">R</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">P'</span> <span class="main">*</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="SepAuto-pre_rule''"><span class="command">lemma</span></span> pre_rule''<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">P</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">P</span> <span class="main">*</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">&lt;</span><span class="free">P'</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">R</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">P</span> <span class="main">*</span> <span class="free">R</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">R</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="SepAuto-pre_ex_rule"><span class="command">lemma</span></span> pre_ex_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">&lt;</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="main">&lt;</span><span class="free">P</span> <span class="bound">x</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="SepAuto-pre_pure_rule"><span class="command">lemma</span></span> pre_pure_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">&lt;</span><span class="free">P</span> <span class="main">*</span> <span class="main">↑</span><span class="free">b</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="main">&lt;</span><span class="free">P</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span> <span class="main">∧</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="SepAuto-pre_pure_rule'"><span class="command">lemma</span></span> pre_pure_rule'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">&lt;</span><span class="main">↑</span><span class="free">b</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span> <span class="main">∧</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="SepAuto-post_rule"><span class="command">lemma</span></span> post_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">P</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">R</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">&lt;</span><span class="free">P</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="free">R</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">del_prfstep_thm</span> <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> entailsD<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> entails_frame<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> frame_rule<span class="antiquote">}</span></span></span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Actual statement used:›</span></span>
<span class="keyword1" id="SepAuto-post_rule'"><span class="command">lemma</span></span> post_rule'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">P</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">&lt;</span><span class="free">P</span><span class="main">&gt;</span> <span class="free">f</span> <span class="main">&lt;</span><span class="free">R</span><span class="main">&gt;</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">x</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">R</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> post_rule <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="SepAuto-norm_pre_pure_iff"><span class="command">lemma</span></span> norm_pre_pure_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">P</span> <span class="main">*</span> <span class="main">↑</span><span class="free">b</span><span class="main">&gt;</span> <span class="free">c</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">b</span> <span class="main">⟶</span> <span class="main">&lt;</span><span class="free">P</span><span class="main">&gt;</span> <span class="free">c</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1" id="SepAuto-norm_pre_pure_iff2"><span class="command">lemma</span></span> norm_pre_pure_iff2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="main">↑</span><span class="free">b</span><span class="main">&gt;</span> <span class="free">c</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">b</span> <span class="main">⟶</span> <span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> <span class="free">c</span> <span class="main">&lt;</span><span class="free">Q</span><span class="main">&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Hoare triples for atomic commands›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First, those that do not modify the heap.›</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> execute_assert<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>
<span class="keyword1" id="SepAuto-assert_rule"><span class="command">lemma</span></span> assert_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="main">↑</span><span class="main">(</span><span class="free">R</span> <span class="free">x</span><span class="main">)</span><span class="main">&gt;</span> assert <span class="free">R</span> <span class="free">x</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="SepAuto-execute_return'"><span class="command">lemma</span></span> execute_return' <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"execute <span class="main">(</span>return <span class="free">x</span><span class="main">)</span> <span class="free">h</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_eq_dest_lhs execute_return<span class="main">)</span>
<span class="keyword1" id="SepAuto-return_rule"><span class="command">lemma</span></span> return_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> return <span class="free">x</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> execute_nth<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>
<span class="keyword1" id="SepAuto-nth_rule"><span class="command">lemma</span></span> nth_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">)</span><span class="main">&gt;</span> Array.nth <span class="free">a</span> <span class="free">i</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> execute_len<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1" id="SepAuto-length_rule"><span class="command">lemma</span></span> length_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span><span class="main">&gt;</span> Array.len <span class="free">a</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> length <span class="free">xs</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> execute_lookup<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1" id="SepAuto-lookup_rule"><span class="command">lemma</span></span> lookup_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span><span class="main">&gt;</span> <span class="main">!</span><span class="free">p</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> execute_freeze<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1" id="SepAuto-freeze_rule"><span class="command">lemma</span></span> freeze_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span><span class="main">&gt;</span> Array.freeze <span class="free">a</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">xs</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next, the update rules.›</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Ref.lim_set<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1" id="SepAuto-Array_lim_set"><span class="command">lemma</span></span> Array_lim_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lim <span class="main">(</span>Array.set <span class="free">p</span> <span class="free">xs</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> lim <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Array.set_def<span class="main">)</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Ref.get_set_eq<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Array.get_set_eq<span class="antiquote">}</span></span></span><span class="main">]</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Array.update_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> execute_upd<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span>›</span>
<span class="keyword1" id="SepAuto-upd_rule"><span class="command">lemma</span></span> upd_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">)</span><span class="main">&gt;</span> Array.upd <span class="free">i</span> <span class="free">x</span> <span class="free">a</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> list_update <span class="free">xs</span> <span class="free">i</span> <span class="free">x</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> execute_update<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1" id="SepAuto-update_rule"><span class="command">lemma</span></span> update_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">y</span><span class="main">&gt;</span> <span class="free">p</span> <span class="main">:=</span> <span class="free">x</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, the allocation rules.›</span></span>
<span class="keyword1" id="SepAuto-lim_set_gen"><span class="command">lemma</span></span> lim_set_gen <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lim <span class="main">(</span><span class="free">h</span><span class="main">⦇</span>lim <span class="main">:=</span> <span class="free">l</span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SepAuto-Array_alloc_def'"><span class="command">lemma</span></span> Array_alloc_def' <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Array.alloc <span class="free">xs</span> <span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> lim <span class="free">h</span><span class="main">;</span> <span class="bound">r</span> <span class="main">=</span> Array <span class="bound">l</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="main">(</span>Array.set <span class="bound">r</span> <span class="free">xs</span> <span class="main">(</span><span class="free">h</span><span class="main">⦇</span>lim <span class="main">:=</span> <span class="bound">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Array.alloc_def<span class="main">)</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="main">[</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> addr_of_array.simps<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> addr_of_ref.simps<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> Ref.alloc_def<span class="antiquote">}</span></span></span><span class="main">]</span>›</span>

<span class="keyword1" id="SepAuto-refs_on_Array_set"><span class="command">lemma</span></span> refs_on_Array_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"refs <span class="main">(</span>Array.set <span class="free">p</span> <span class="free">xs</span> <span class="free">h</span><span class="main">)</span> <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> refs <span class="free">h</span> <span class="free">t</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Array.set_def<span class="main">)</span>

<span class="keyword1" id="SepAuto-arrays_on_Ref_set"><span class="command">lemma</span></span> arrays_on_Ref_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"arrays <span class="main">(</span>Ref.set <span class="free">p</span> <span class="free">x</span> <span class="free">h</span><span class="main">)</span> <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> arrays <span class="free">h</span> <span class="free">t</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ref.set_def<span class="main">)</span>

<span class="keyword1" id="SepAuto-refs_on_Array_alloc"><span class="command">lemma</span></span> refs_on_Array_alloc <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"refs <span class="main">(</span>snd <span class="main">(</span>Array.alloc <span class="free">xs</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> refs <span class="free">h</span> <span class="free">t</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Array.alloc_def refs_on_Array_set select_convs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snd_conv surjective update_convs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="SepAuto-arrays_on_Ref_alloc"><span class="command">lemma</span></span> arrays_on_Ref_alloc <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"arrays <span class="main">(</span>snd <span class="main">(</span>Ref.alloc <span class="free">x</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> arrays <span class="free">h</span> <span class="free">t</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Ref.alloc_def arrays_on_Ref_set select_convs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sndI surjective update_convs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="SepAuto-arrays_on_Array_alloc"><span class="command">lemma</span></span> arrays_on_Array_alloc <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> lim <span class="free">h</span> <span class="main">⟹</span> arrays <span class="main">(</span>snd <span class="main">(</span>Array.alloc <span class="free">xs</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> arrays <span class="free">h</span> <span class="free">t</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Array.alloc_def Array.set_def addr_of_array.simps fun_upd_apply less_or_eq_imp_le
          linorder_not_less simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snd_conv surjective update_convs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> update_convs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="SepAuto-refs_on_Ref_alloc"><span class="command">lemma</span></span> refs_on_Ref_alloc <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> lim <span class="free">h</span> <span class="main">⟹</span> refs <span class="main">(</span>snd <span class="main">(</span>Ref.alloc <span class="free">x</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> refs <span class="free">h</span> <span class="free">t</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Ref.alloc_def Ref.set_def addr_of_ref.simps fun_upd_apply less_or_eq_imp_le
          linorder_not_less select_convs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> snd_conv surjective update_convs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> execute_new<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1" id="SepAuto-new_rule"><span class="command">lemma</span></span> new_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> Array.new <span class="free">n</span> <span class="free">x</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> replicate <span class="free">n</span> <span class="free">x</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> execute_of_list<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1" id="SepAuto-of_list_rule"><span class="command">lemma</span></span> of_list_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> Array.of_list <span class="free">xs</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> execute_ref<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1" id="SepAuto-ref_rule"><span class="command">lemma</span></span> ref_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> ref <span class="free">x</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">del_prfstep_thm</span> <span class="main">[</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> sngr_assn_rule<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> snga_assn_rule<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> pure_assn_rule<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> top_assn_rule<span class="antiquote">}</span></span></span><span class="main">,</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> mod_pure_star_dist<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> one_assn_rule<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> hoare_triple_def<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> mod_ex_dist<span class="antiquote">}</span></span></span><span class="main">]</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_simple_datatype</span> <span class="inner_quoted">"pheap"</span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of procedures›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ASCII abbreviations for ML files.›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">ex_assn_ascii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> assn<span class="main">)</span> <span class="main">⇒</span> assn"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">EXA</span>"</span> 11<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ex_assn_ascii</span> <span class="main">≡</span> ex_assn"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">models_ascii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pheap <span class="main">⇒</span> assn <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">|=</span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main"><span class="free">|=</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">"sep_util.ML"</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">AssnMatcher</span> <span class="main">=</span> <span class="entity">AssnMatcher</span><span class="main">(</span>SepUtil<span class="main">)</span>
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SepLogic</span> <span class="main">=</span> <span class="entity">SepLogic</span><span class="main">(</span>SepUtil<span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_assn_matcher</span> <span class="main">=</span> <span class="entity">AssnMatcher.add_assn_matcher</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_entail_matcher</span> <span class="main">=</span> <span class="entity">AssnMatcher.add_entail_matcher</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_forward_ent_prfstep</span> <span class="main">=</span> <span class="entity">SepLogic.add_forward_ent_prfstep</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_rewrite_ent_rule</span> <span class="main">=</span> <span class="entity">SepLogic.add_rewrite_ent_rule</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_hoare_triple_prfstep</span> <span class="main">=</span> <span class="entity">SepLogic.add_hoare_triple_prfstep</span>
›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">AssnMatcher.add_assn_matcher_proofsteps</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">SepLogic.add_sep_logic_proofsteps</span>›</span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">"sep_steps_test.ML"</span>

<span class="keyword1"><span class="command">attribute_setup</span></span> forward_ent <span class="main">=</span> <span class="quoted">‹<span class="entity">setup_attrib</span> <span class="entity">add_forward_ent_prfstep</span>›</span>
<span class="keyword1"><span class="command">attribute_setup</span></span> rewrite_ent <span class="main">=</span> <span class="quoted">‹<span class="entity">setup_attrib</span> <span class="entity">add_rewrite_ent_rule</span>›</span>
<span class="keyword1"><span class="command">attribute_setup</span></span> hoare_triple <span class="main">=</span> <span class="quoted">‹<span class="entity">setup_attrib</span> <span class="entity">add_hoare_triple_prfstep</span>›</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_hoare_triple_prfstep</span> <span class="main">[</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> assert_rule<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> update_rule<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> nth_rule<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> upd_rule<span class="antiquote">}</span></span></span><span class="main">,</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> return_rule<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> ref_rule<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> lookup_rule<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> new_rule<span class="antiquote">}</span></span></span><span class="main">,</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> of_list_rule<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> length_rule<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> freeze_rule<span class="antiquote">}</span></span></span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some simple tests›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> ref <span class="free">x</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span><span class="main">&gt;</span> ref <span class="free">x</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span> <span class="main">*</span> <span class="bound">r</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span><span class="main">&gt;</span> <span class="main">(</span><span class="main">!</span><span class="free">a</span><span class="main">)</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span> <span class="main">*</span> <span class="free">b</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">y</span><span class="main">&gt;</span> <span class="main">(</span><span class="main">!</span><span class="free">a</span><span class="main">)</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span> <span class="main">*</span> <span class="free">b</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">y</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span> <span class="main">*</span> <span class="free">b</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">y</span><span class="main">&gt;</span> <span class="main">(</span><span class="main">!</span><span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span> <span class="main">*</span> <span class="free">b</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">y</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span><span class="main">&gt;</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="free">a</span> <span class="main">:=</span> <span class="free">y</span><span class="main">;</span> <span class="main">!</span><span class="free">a</span> <span class="main">}</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">y</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span><span class="main">&gt;</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="free">a</span> <span class="main">:=</span> <span class="free">y</span><span class="main">;</span> <span class="free">a</span> <span class="main">:=</span> <span class="free">z</span><span class="main">;</span> <span class="main">!</span><span class="free">a</span> <span class="main">}</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">z</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">z</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span><span class="main">&gt;</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">y</span> <span class="main">←</span> <span class="main">!</span><span class="free">a</span><span class="main">;</span> ref <span class="bound">y</span><span class="main">}</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span> <span class="main">*</span> <span class="bound">r</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">x</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> return <span class="free">x</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/sep_util.ML">
<div class="head">
<h1>File ‹sep_util.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: sep_util.ML
  Author: Bohua Zhan

  Utility functions for separation logic. Implements the interface
  defined in sep_util_base.ML.
*)</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SepUtil</span> <span class="main">:</span> <span class="entity">SEP_UTIL</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">assnT</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">assn</span><span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">emp</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="keyword1">emp</span></span><span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">assn_true</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="keyword1">true</span></span><span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">assn_ac_info</span> <span class="main">=</span> <span class="entity">Nat_Util.times_ac_on_typ</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">theory</span><span class="antiquote">}</span></span></span> <span class="entity">assnT</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_true_assn</span> <span class="entity">t</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> top_assn<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> true
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">entail_t</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">entails</span><span class="antiquote">}</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_entail</span> <span class="entity">t</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> entails<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span> <span class="main">=&gt;</span> true
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false

<span class="comment1">(* Deconstruct A ==&gt;_A B into (A, B). *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_entail</span> <span class="entity">t</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> entails<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">A</span> $ <span class="entity">B</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">A</span><span class="main">,</span> <span class="entity">B</span><span class="main">)</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"dest_entail: unexpected t."</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cdest_entail</span> <span class="entity">ct</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> Thm.term_of <span class="entity">ct</span> <span class="keyword2"><span class="keyword">of</span></span>
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> entails<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span> <span class="main">=&gt;</span>
        <span class="main">(</span>Thm.dest_arg1 <span class="entity">ct</span><span class="main">,</span> Thm.dest_arg <span class="entity">ct</span><span class="main">)</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"dest_entail: unexpected t."</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_ex_assn</span> <span class="entity">t</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> ex_assn<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> <span class="main">=&gt;</span> true
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false

<span class="comment1">(* Whether t is of the form ↑(b). *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_pure_assn</span> <span class="entity">t</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> pure_assn<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> <span class="main">=&gt;</span> true
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false

<span class="comment1">(* Given t of form t1 * ... * tn, check whether any of them is of the
   form ↑(b).
 *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">has_pure_assn</span> <span class="entity">t</span> <span class="main">=</span>
    exists <span class="entity">is_pure_assn</span> <span class="main">(</span><span class="entity">ACUtil.dest_ac</span> <span class="entity">assn_ac_info</span> <span class="entity">t</span><span class="main">)</span>

<span class="comment1">(* Given t of form t1 * ... * tn, remove those ti that are pure
   assertions and return the product of the remaining terms.
 *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strip_pure_assn</span> <span class="entity">t</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">UtilArith.is_times</span> <span class="entity">t</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">is_pure_assn</span> <span class="main">(</span><span class="entity">dest_arg</span> <span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">strip_pure_assn</span> <span class="main">(</span><span class="entity">dest_arg1</span> <span class="entity">t</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_pure_assn</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">emp</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">t</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">hoare_triple_pat</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term_pat</span> <span class="quoted">"<span class="main">&lt;</span><span class="var">?P</span><span class="main">&gt;</span> <span class="var">?c</span> <span class="main">&lt;</span><span class="var">?Q</span><span class="main">&gt;</span>"</span><span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">heap_eq_pat</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term_pat</span> <span class="quoted">"<span class="main">(</span><span class="var">?c1</span><span class="main">::</span><span class="tvar">?'a</span> Heap<span class="main">)</span> <span class="main">=</span> <span class="var">?c2</span>"</span><span class="antiquote">}</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_hoare_triple</span> <span class="entity">t</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> hoare_triple<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span> $ <span class="main">_</span> <span class="main">=&gt;</span> true
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_hoare_triple</span> <span class="entity">t</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> hoare_triple<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">P</span> $ <span class="entity">c</span> $ <span class="entity">Q</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">P</span><span class="main">,</span> <span class="entity">c</span><span class="main">,</span> <span class="entity">Q</span><span class="main">)</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"dest_hoare_triple"</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_bind_cmd</span> <span class="entity">c</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">c</span> <span class="keyword2"><span class="keyword">of</span></span>
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> bind<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span> <span class="main">=&gt;</span> true
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false

<span class="comment1">(* Convert A to emp * A *)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mult_emp_left</span> <span class="main">=</span> <span class="entity">rewr_obj_eq</span> <span class="main">(</span><span class="entity">obj_sym</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> mult_1<span class="antiquote">}</span></span></span><span class="main">)</span>

<span class="comment1">(* Convert A to A * emp *)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mult_emp_right</span> <span class="main">=</span> <span class="entity">rewr_obj_eq</span> <span class="main">(</span><span class="entity">obj_sym</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> mult_1_right<span class="antiquote">}</span></span></span><span class="main">)</span>

<span class="comment1">(* Convert A * emp to A *)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">reduce_emp_right</span> <span class="main">=</span> <span class="entity">rewr_obj_eq</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> mult_1_right<span class="antiquote">}</span></span></span>

<span class="comment1">(* Given A of type assnT, return the theorem A ==&gt; A. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">entail_triv_th</span> <span class="entity">ctxt</span> <span class="entity">A</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> Proof_Context.theory_of <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst</span> <span class="main">=</span> Pattern.first_order_match <span class="entity">thy</span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> <span class="entity">assnT</span><span class="main">)</span><span class="main">,</span> <span class="entity">A</span><span class="main">)</span> <span class="entity">fo_init</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">Util.subst_thm</span> <span class="entity">ctxt</span> <span class="entity">inst</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> entails_triv<span class="antiquote">}</span></span></span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Given A of type assnT, return the theorem A ==&gt; true. *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">entail_true_th</span> <span class="entity">ctxt</span> <span class="entity">A</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> Proof_Context.theory_of <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst</span> <span class="main">=</span> Pattern.first_order_match <span class="entity">thy</span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> <span class="entity">assnT</span><span class="main">)</span><span class="main">,</span> <span class="entity">A</span><span class="main">)</span> <span class="entity">fo_init</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">Util.subst_thm</span> <span class="entity">ctxt</span> <span class="entity">inst</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> entails_true<span class="antiquote">}</span></span></span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Given theorem A ==&gt; B and a conversion cv, apply cv to B *)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">apply_to_entail_r</span> <span class="main">=</span> <span class="entity">apply_to_thm'</span> o Conv.arg_conv

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pre_pure_rule_th</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> pre_pure_rule<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pre_pure_rule_th'</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> pre_pure_rule'<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pre_ex_rule_th</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> pre_ex_rule<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">entails_pure_th</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> entails_pure<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">entails_pure_th'</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> entails_pure'<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">entails_ex_th</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> entails_ex<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">entails_frame_th'</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> entails_frame'<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">entails_frame_th''</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> entails_frame''<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pure_conj_th</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> pure_conj<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">entails_ex_post_th</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> entails_ex_post<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">entails_pure_post_th</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> entails_pure_post<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pre_rule_th'</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> pre_rule'<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pre_rule_th''</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> pre_rule''<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bind_rule_th'</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> bind_rule'<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">post_rule_th'</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> post_rule'<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">entails_equiv_forward_th</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> entails_equiv_forward<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">entails_equiv_backward_th</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> entails_equiv_backward<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">norm_pre_pure_iff_th</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> norm_pre_pure_iff<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">norm_pre_pure_iff2_th</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> norm_pre_pure_iff2<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">entails_trans2_th</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> entails_trans2<span class="antiquote">}</span></span></span>

<span class="comment1">(* Extra functions *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_case_prod</span> <span class="entity">t</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> case_prod<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span> <span class="main">=&gt;</span> true
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sort_by</span> <span class="entity">t</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> pure_assn<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> <span class="main">=&gt;</span> <span class="inner_numeral">2</span>
      <span class="main">|</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> top_assn<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_numeral">1</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="inner_numeral">0</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pure_ord</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="entity">s</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">sort_by</span> <span class="entity">t</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">sort_by</span> <span class="entity">s</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
      Term_Ord.term_ord <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> LESS
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="entity">sort_by</span> <span class="entity">t</span> &lt; <span class="entity">sort_by</span> <span class="entity">s</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">normalize_times_cv</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">A</span><span class="main">,</span> <span class="entity">B</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Util.dest_binop_args</span> <span class="main">(</span>Thm.term_of <span class="entity">ct</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_ex_assn</span> <span class="entity">A</span> <span class="keyword2"><span class="keyword">then</span></span>
        Conv.every_conv <span class="main">[</span><span class="entity">rewr_obj_eq</span> <span class="main">(</span><span class="entity">obj_sym</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> ex_distrib_star<span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">,</span>
                         Conv.binder_conv <span class="main">(</span><span class="entity">normalize_times_cv</span> o snd<span class="main">)</span> <span class="entity">ctxt</span><span class="main">]</span> <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_ex_assn</span> <span class="entity">B</span> <span class="keyword2"><span class="keyword">then</span></span>
        Conv.every_conv <span class="main">[</span><span class="entity">ACUtil.comm_cv</span> <span class="entity">assn_ac_info</span><span class="main">,</span>
                         <span class="entity">normalize_times_cv</span> <span class="entity">ctxt</span><span class="main">]</span> <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        Conv.every_conv <span class="main">[</span>
          <span class="entity">ACUtil.normalize_au</span> <span class="entity">assn_ac_info</span><span class="main">,</span>
          <span class="entity">ACUtil.normalize_comm_gen</span> <span class="entity">assn_ac_info</span> <span class="entity">pure_ord</span><span class="main">,</span>
          <span class="entity">ACUtil.norm_combine</span> <span class="entity">assn_ac_info</span> <span class="entity">is_true_assn</span>
                              <span class="main">(</span><span class="entity">rewr_obj_eq</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> top_assn_reduce<span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">]</span> <span class="entity">ct</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Normalization function for assertions. This function pulls all EX_A
   to the front, then apply AC-rules to the inside, putting all pure
   assertions on the right.
 *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">normalize_assn_cv</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Thm.term_of <span class="entity">ct</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_ex_assn</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span>
        Conv.binder_conv <span class="main">(</span><span class="entity">normalize_assn_cv</span> o snd<span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">UtilArith.is_times</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span>
        Conv.every_conv <span class="main">[</span>Conv.binop_conv <span class="main">(</span><span class="entity">normalize_assn_cv</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">,</span>
                         <span class="entity">normalize_times_cv</span> <span class="entity">ctxt</span><span class="main">]</span> <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_pure_assn</span> <span class="entity">t</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">is_conj</span> <span class="main">(</span><span class="entity">dest_arg</span> <span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
        Conv.every_conv <span class="main">[</span><span class="entity">rewr_obj_eq</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> pure_conj<span class="antiquote">}</span></span></span><span class="main">,</span>
                         <span class="entity">normalize_assn_cv</span> <span class="entity">ctxt</span><span class="main">]</span> <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_case_prod</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span>
        Conv.every_conv <span class="main">[</span><span class="entity">rewr_obj_eq</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> case_prod_beta<span class="antiquote">}</span></span></span><span class="main">,</span>
                         <span class="entity">normalize_assn_cv</span> <span class="entity">ctxt</span><span class="main">]</span> <span class="entity">ct</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        Conv.all_conv <span class="entity">ct</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Rewrite terms for an assertion *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">assn_rewr_terms</span> <span class="entity">P</span> <span class="main">=</span>
    <span class="entity">P</span> |&gt; <span class="entity">ACUtil.dest_ac</span> <span class="entity">assn_ac_info</span>
      |&gt; filter_out <span class="entity">is_pure_assn</span>
      |&gt; maps <span class="main">(</span>snd o Term.strip_comb<span class="main">)</span>
      |&gt; distinct <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> aconv<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>  <span class="comment1">(* structure SepUtil *)</span>
</pre>
</div><div id="files/sep_steps_test.ML">
<div class="head">
<h1>File ‹sep_steps_test.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: sep_steps_test.ML
  Author: Bohua Zhan

  Unit test for sep_steps.ML.
*)</span>

<span class="keyword2"><span class="keyword">local</span></span>
  <span class="keyword3"><span class="keyword">open</span></span> SepUtil
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt'</span> <span class="main">=</span> <span class="entity">ctxt</span> |&gt; fold Proof_Context.augment <span class="main">[</span>
        Free <span class="main">(</span><span class="inner_quoted">"P"</span><span class="main">,</span> <span class="entity">assnT</span><span class="main">)</span><span class="main">,</span> Free <span class="main">(</span><span class="inner_quoted">"Q"</span><span class="main">,</span> <span class="entity">assnT</span><span class="main">)</span><span class="main">,</span> Free <span class="main">(</span><span class="inner_quoted">"R"</span><span class="main">,</span> <span class="entity">assnT</span><span class="main">)</span><span class="main">,</span>
        Free <span class="main">(</span><span class="inner_quoted">"S"</span><span class="main">,</span> <span class="entity">natT</span> --&gt; <span class="entity">assnT</span><span class="main">)</span><span class="main">,</span> Free <span class="main">(</span><span class="inner_quoted">"T"</span><span class="main">,</span> <span class="entity">natT</span> --&gt; <span class="entity">assnT</span><span class="main">)</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test_normalize_assn</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test_data</span> <span class="main">=</span> <span class="main">[</span>
        <span class="main">(</span><span class="inner_quoted">"P * (Q * R)"</span><span class="main">,</span> <span class="inner_quoted">"P * Q * R"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"P * ↑(b)"</span><span class="main">,</span> <span class="inner_quoted">"P * ↑(b)"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"↑(b) * P"</span><span class="main">,</span> <span class="inner_quoted">"P * ↑(b)"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"P * ↑(b) * Q"</span><span class="main">,</span> <span class="inner_quoted">"P * Q * ↑(b)"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"↑(b) * (P * ↑(c)) * Q"</span><span class="main">,</span> <span class="inner_quoted">"P * Q * ↑(b) * ↑(c)"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"EXA x. S x"</span><span class="main">,</span> <span class="inner_quoted">"EXA x. S x"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"(EXA x. S x) * P"</span><span class="main">,</span> <span class="inner_quoted">"EXA x. P * S x"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"P * (EXA x. S x)"</span><span class="main">,</span> <span class="inner_quoted">"EXA x. P * S x"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"(EXA x. S x) * (EXA y. T y)"</span><span class="main">,</span> <span class="inner_quoted">"EXA x y. S x * T y"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"EXA x. S x * ↑(B x) * T x"</span><span class="main">,</span> <span class="inner_quoted">"EXA x. S x * T x * ↑(B x)"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"P * true * true"</span><span class="main">,</span> <span class="inner_quoted">"P * true"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"true * P * true"</span><span class="main">,</span> <span class="inner_quoted">"P * true"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"true * P * true * ↑(b)"</span><span class="main">,</span> <span class="inner_quoted">"P * true * ↑(b)"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"(EXA x. S x) * P * Q"</span><span class="main">,</span> <span class="inner_quoted">"EXA x. P * Q * S x"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"↑(b1 &amp; b2)"</span><span class="main">,</span> <span class="inner_quoted">"↑b1 * ↑b2"</span><span class="main">)</span>
      <span class="main">]</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      map <span class="main">(</span><span class="entity">Util.test_conv</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">SepUtil.normalize_assn_cv</span> <span class="entity">ctxt'</span><span class="main">)</span>
                          <span class="inner_quoted">"normalize_assn"</span><span class="main">)</span>
          <span class="entity">test_data</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test_contract_hoare</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test_data</span> <span class="main">=</span> <span class="main">[</span>
        <span class="main">(</span><span class="inner_quoted">"&lt;P * ↑(b)&gt; c &lt;S&gt;"</span><span class="main">,</span> <span class="inner_quoted">"&lt;P * ↑(b)&gt; c &lt;S&gt;"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"b --&gt; &lt;P&gt; c &lt;S&gt;"</span><span class="main">,</span> <span class="inner_quoted">"&lt;P * ↑(b)&gt; c &lt;S&gt;"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"b1 --&gt; b2 --&gt; &lt;P&gt; c &lt;S&gt;"</span><span class="main">,</span> <span class="inner_quoted">"&lt;P * ↑(b2) * ↑(b1)&gt; c &lt;S&gt;"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"b1 --&gt; &lt;P * ↑(b2)&gt; c &lt;S&gt;"</span><span class="main">,</span> <span class="inner_quoted">"&lt;P * ↑(b2) * ↑(b1)&gt; c &lt;S&gt;"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"&lt;Q * P&gt; c &lt;S&gt;"</span><span class="main">,</span> <span class="inner_quoted">"&lt;P * Q&gt; c &lt;S&gt;"</span><span class="main">)</span>
      <span class="main">]</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      map <span class="main">(</span><span class="entity">Util.test_conv</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">SepLogic.contract_hoare_cv</span> <span class="entity">ctxt'</span><span class="main">)</span>
                          <span class="inner_quoted">"contract_hoare"</span><span class="main">)</span>
          <span class="entity">test_data</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test_normalize_hoare_goal</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test_data</span> <span class="main">=</span> <span class="main">[</span>
        <span class="main">(</span><span class="inner_quoted">"~&lt;P&gt; c &lt;S&gt;"</span><span class="main">,</span> <span class="inner_quoted">"~&lt;P&gt; c &lt;S&gt;"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"~&lt;↑(b)&gt; c &lt;S&gt;"</span><span class="main">,</span> <span class="inner_quoted">"~&lt;emp&gt; c &lt;S&gt; &amp; b"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"~&lt;P * ↑(b)&gt; c &lt;S&gt;"</span><span class="main">,</span> <span class="inner_quoted">"~&lt;P&gt; c &lt;S&gt; &amp; b"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"~&lt;↑(b1) * ↑(b2)&gt; c &lt;S&gt;"</span><span class="main">,</span> <span class="inner_quoted">"(~&lt;emp&gt; c &lt;S&gt; &amp; b1) &amp; b2"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"~&lt;P * Q&gt; c &lt;S&gt;"</span><span class="main">,</span> <span class="inner_quoted">"~&lt;P * Q&gt; c &lt;S&gt;"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"EX x. ~&lt;T x&gt; c &lt;S&gt;"</span><span class="main">,</span> <span class="inner_quoted">"EX x. ~&lt;T x&gt; c &lt;S&gt;"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"EX x. ~&lt;↑(b x)&gt; c &lt;S&gt;"</span><span class="main">,</span> <span class="inner_quoted">"EX x. ~&lt;emp&gt; c &lt;S&gt; &amp; b x"</span><span class="main">)</span>
      <span class="main">]</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      map <span class="main">(</span><span class="entity">Util.test_conv</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">SepLogic.normalize_hoare_goal_cv</span> <span class="entity">ctxt'</span><span class="main">)</span>
                          <span class="inner_quoted">"normalize_hoare_goal"</span><span class="main">)</span>
          <span class="entity">test_data</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test_normalize_entail_goal</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test_data</span> <span class="main">=</span> <span class="main">[</span>
        <span class="main">(</span><span class="inner_quoted">"~(entails P Q)"</span><span class="main">,</span> <span class="inner_quoted">"~(entails P Q)"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"~(entails (↑b) Q)"</span><span class="main">,</span> <span class="inner_quoted">"~(entails emp Q) &amp; b"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"~(entails (↑b * P) Q)"</span><span class="main">,</span> <span class="inner_quoted">"~(entails P Q) &amp; b"</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"~(entails (EXA x. S x) Q)"</span><span class="main">,</span> <span class="inner_quoted">"EX x. ~(entails (S x) Q)"</span><span class="main">)</span>
      <span class="main">]</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      map <span class="main">(</span><span class="entity">Util.test_conv</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">SepLogic.normalize_entail_goal_cv</span> <span class="entity">ctxt'</span><span class="main">)</span>
                          <span class="inner_quoted">"normalize_entail_goal"</span><span class="main">)</span>
          <span class="entity">test_data</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="GCD_Impl">
<div class="head">
<h1>Theory GCD_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: GCD_Impl.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">theory</span></span> GCD_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="SepAuto.html">SepAuto</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A tutorial example for computation of GCD.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Turn on auto2's trace›</span></span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">print_trace</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Property of gcd that justifies the recursive computation. Add as a
  right-to-left rewrite rule.›</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule_back</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> gcd_red_nat<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Functional version of gcd.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gcd_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gcd_fun</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">else</span> <span class="free">gcd_fun</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The fun package automatically generates induction rule upon showing
  termination. This adds the induction rule for the @fun\_induct command.›</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_fun_induct_rule</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">gcd_fun</span><span class="antiquote">}</span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> gcd_fun.induct<span class="antiquote">}</span></span></span><span class="main">)</span>›</span>

<span class="keyword1" id="GCD_Impl-gcd_fun_correct"><span class="command">lemma</span></span> gcd_fun_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gcd_fun <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> gcd <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"gcd_fun <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"gcd_fun <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Imperative version of gcd.›</span></span>
<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">gcd_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gcd_impl</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> return <span class="free"><span class="bound"><span class="entity">a</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">c</span> <span class="main">←</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">r</span> <span class="main">←</span> <span class="free">gcd_impl</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">c</span><span class="main">;</span>
      return <span class="bound">r</span>
    <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The program is sufficiently simple that we can prove the Hoare triple
  directly (without going through the functional program).›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> gcd_impl_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> gcd_impl <span class="free">a</span> <span class="free">b</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> gcd <span class="free">a</span> <span class="free">b</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"gcd_fun <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Turn off trace.›</span></span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">print_trace</span> <span class="main"><span class="main">=</span></span> <span class="quasi_keyword">false</span><span class="main">]</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LinkedList">
<div class="head">
<h1>Theory LinkedList</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: LinkedList.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation of linked list›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LinkedList
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="SepAuto.html">SepAuto</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Examples in linked lists. Definitions and some of the examples are
  based on List\_Seg and Open\_List theories in \cite{Separation_Logic_Imperative_HOL-AFP}
  by Lammich and Meis.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹List Assertion›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> node <span class="main">=</span> Node <span class="main">(</span><span class="free"><span class="entity">val</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">nxt</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> node ref option"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> node.sel<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">node_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap node <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">node_encode</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> to_nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> node <span class="main">::</span> <span class="main">(</span><span class="quoted">heap</span><span class="main">)</span> <span class="quoted">heap</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> heap_class.intro<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> countable_classI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"node_encode"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">os_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap list <span class="main">⇒</span> <span class="tfree">'a</span> node ref option <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">os_list</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">↑</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">os_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> Node <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">q</span> <span class="main">*</span> <span class="free">os_list</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">q</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">os_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> None <span class="main">=</span> <span class="keyword1">false</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_ent_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> os_list.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="LinkedList-os_list_empty"><span class="command">lemma</span></span> os_list_empty <span class="main">[</span><span class="operator">forward_ent</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"os_list <span class="main">[]</span> <span class="free">p</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">↑</span><span class="main">(</span><span class="free">p</span> <span class="main">=</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="LinkedList-os_list_Cons"><span class="command">lemma</span></span> os_list_Cons <span class="main">[</span><span class="operator">forward_ent</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"os_list <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="free">p</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">q</span><span class="main">.</span> the <span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> Node <span class="free">x</span> <span class="bound">q</span> <span class="main">*</span> os_list <span class="free">l</span> <span class="bound">q</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">p</span> <span class="main">≠</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="LinkedList-os_list_none"><span class="command">lemma</span></span> os_list_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">emp</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> os_list <span class="main">[]</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="LinkedList-os_list_constr_ent"><span class="command">lemma</span></span> os_list_constr_ent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> Node <span class="free">x</span> <span class="free">q</span> <span class="main">*</span> os_list <span class="free">l</span> <span class="free">q</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> os_list <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_entail_matcher</span> <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> os_list_none<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> os_list_constr_ent<span class="antiquote">}</span></span></span><span class="main">]</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> os_list.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">"list_matcher_test.ML"</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> os_list <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> node ref option"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic operations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">os_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap os_list Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">os_empty</span> <span class="main">=</span> return None"</span></span>

<span class="keyword1" id="LinkedList-os_empty_rule"><span class="command">lemma</span></span> os_empty_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> os_empty <span class="main">&lt;</span>os_list <span class="main">[]</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">os_is_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap os_list <span class="main">⇒</span> bool Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">os_is_empty</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="LinkedList-os_is_empty_rule"><span class="command">lemma</span></span> os_is_empty_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>os_list <span class="free">xs</span> <span class="free">b</span><span class="main">&gt;</span> os_is_empty <span class="free">b</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> os_list <span class="free">xs</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> hd <span class="free">xs</span> <span class="main">#</span> tl <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">os_prepend</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>heap os_list <span class="main">⇒</span> <span class="tfree">'a</span> os_list Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">os_prepend</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">p</span> <span class="main">←</span> ref <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">;</span> return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="LinkedList-os_prepend_rule"><span class="command">lemma</span></span> os_prepend_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>os_list <span class="free">xs</span> <span class="free">n</span><span class="main">&gt;</span> os_prepend <span class="free">x</span> <span class="free">n</span> <span class="main">&lt;</span>os_list <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">os_pop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap os_list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> os_list<span class="main">)</span> Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">os_pop</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> raise <span class="keyword1">STR</span> <span class="inner_quoted">''Empty Os_list''</span> <span class="main">|</span>
    Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">m</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span> return <span class="main">(</span>val <span class="bound">m</span><span class="main">,</span> nxt <span class="bound">m</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LinkedList-os_pop_rule"><span class="command">lemma</span></span> os_pop_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>os_list <span class="free">xs</span> <span class="main">(</span>Some <span class="free">p</span><span class="main">)</span><span class="main">&gt;</span>
   os_pop <span class="main">(</span>Some <span class="free">p</span><span class="main">)</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span><span class="main">.</span> os_list <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span> <span class="bound">r'</span> <span class="main">*</span> <span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span>Node <span class="bound">x</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">x</span> <span class="main">=</span> hd <span class="free">xs</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> hd <span class="free">xs</span> <span class="main">#</span> tl <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reverse›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">os_reverse_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap os_list <span class="main">⇒</span> <span class="tfree">'a</span> os_list <span class="main">⇒</span> <span class="tfree">'a</span> os_list Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">os_reverse_aux</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> return <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">|</span>
    Some <span class="bound">r</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">v</span> <span class="main">←</span> <span class="main">!</span><span class="bound">r</span><span class="main">;</span>
      <span class="bound">r</span> <span class="main">:=</span> Node <span class="main">(</span>val <span class="bound">v</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">;</span>
      <span class="free">os_reverse_aux</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>nxt <span class="bound">v</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LinkedList-os_reverse_aux_rule"><span class="command">lemma</span></span> os_reverse_aux_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>os_list <span class="free">xs</span> <span class="free">p</span> <span class="main">*</span> os_list <span class="free">ys</span> <span class="free">q</span><span class="main">&gt;</span> 
    os_reverse_aux <span class="free">q</span> <span class="free">p</span> 
   <span class="main">&lt;</span>os_list <span class="main">(</span><span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">os_reverse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap os_list <span class="main">⇒</span> <span class="tfree">'a</span> os_list Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">os_reverse</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> os_reverse_aux None <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1" id="LinkedList-os_reverse_rule"><span class="command">lemma</span></span> os_reverse_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>os_list <span class="free">xs</span> <span class="free">p</span><span class="main">&gt;</span> os_reverse <span class="free">p</span> <span class="main">&lt;</span>os_list <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Remove›</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> removeAll.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">os_rem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap <span class="main">⇒</span> <span class="tfree">'a</span> node ref option <span class="main">⇒</span> <span class="tfree">'a</span> node ref option Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">os_rem</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span> 
     None <span class="main">⇒</span> return None <span class="main">|</span>
     Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span> 
       <span class="bound">n</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
       <span class="bound">q</span> <span class="main">←</span> <span class="free">os_rem</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>nxt <span class="bound">n</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>val <span class="bound">n</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> 
         <span class="keyword1">then</span> return <span class="bound">q</span>
         <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">p</span> <span class="main">:=</span> Node <span class="main">(</span>val <span class="bound">n</span><span class="main">)</span> <span class="bound">q</span><span class="main">;</span> 
           return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LinkedList-os_rem_rule"><span class="command">lemma</span></span> os_rem_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>os_list <span class="free">xs</span> <span class="free">b</span><span class="main">&gt;</span> os_rem <span class="free">x</span> <span class="free">b</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> os_list <span class="main">(</span>removeAll <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="bound">r</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Extract list›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">extract_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap os_list <span class="main">⇒</span> <span class="tfree">'a</span> list Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">extract_list</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> return <span class="main">[]</span>
  <span class="main">|</span> Some <span class="bound">pp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">v</span> <span class="main">←</span> <span class="main">!</span><span class="bound">pp</span><span class="main">;</span>
      <span class="bound">ls</span> <span class="main">←</span> <span class="free">extract_list</span> <span class="main">(</span>nxt <span class="bound">v</span><span class="main">)</span><span class="main">;</span>
      return <span class="main">(</span>val <span class="bound">v</span> <span class="main">#</span> <span class="bound">ls</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LinkedList-extract_list_rule"><span class="command">lemma</span></span> extract_list_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>os_list <span class="free">l</span> <span class="free">p</span><span class="main">&gt;</span> extract_list <span class="free">p</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> os_list <span class="free">l</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">l</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">l</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">p</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Ordered insert›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list_insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ord <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">list_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> list_insert.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="LinkedList-list_insert_length"><span class="command">lemma</span></span> list_insert_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>list_insert <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> list_insert_length<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"list_insert ?x ?xs"</span><span class="main">]</span>›</span>

<span class="keyword1" id="LinkedList-list_insert_mset"><span class="command">lemma</span></span> list_insert_mset <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>list_insert <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">+</span> mset <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="LinkedList-list_insert_set"><span class="command">lemma</span></span> list_insert_set <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>list_insert <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="LinkedList-list_insert_sorted"><span class="command">lemma</span></span> list_insert_sorted <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span> <span class="main">⟹</span> sorted <span class="main">(</span>list_insert <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">os_insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>ord<span class="main">,</span>heap<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'a</span> os_list <span class="main">⇒</span> <span class="tfree">'a</span> os_list Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">os_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> os_prepend <span class="free"><span class="bound"><span class="entity">x</span></span></span> None
    <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">v</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> val <span class="bound">v</span> <span class="keyword1">then</span> os_prepend <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>
         <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">q</span> <span class="main">←</span> <span class="free">os_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>nxt <span class="bound">v</span><span class="main">)</span><span class="main">;</span>
           <span class="bound">p</span> <span class="main">:=</span> Node <span class="main">(</span>val <span class="bound">v</span><span class="main">)</span> <span class="bound">q</span><span class="main">;</span>
           return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LinkedList-os_insert_to_fun"><span class="command">lemma</span></span> os_insert_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>os_list <span class="free">xs</span> <span class="free">b</span><span class="main">&gt;</span> os_insert <span class="free">x</span> <span class="free">b</span> <span class="main">&lt;</span>os_list <span class="main">(</span>list_insert <span class="free">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Insertion sort›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert_sort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ord list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_sort</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insert_sort</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> list_insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">insert_sort</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> insert_sort.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="LinkedList-insert_sort_mset"><span class="command">lemma</span></span> insert_sort_mset <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>insert_sort <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="LinkedList-insert_sort_sorted"><span class="command">lemma</span></span> insert_sort_sorted <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>insert_sort <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="LinkedList-insert_sort_is_sort"><span class="command">lemma</span></span> insert_sort_is_sort <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"insert_sort <span class="free">xs</span> <span class="main">=</span> sort <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">os_insert_sort_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>ord<span class="main">,</span>heap<span class="main">}</span> list <span class="main">⇒</span> <span class="tfree">'a</span> os_list Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">os_insert_sort_aux</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span>return None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">os_insert_sort_aux</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">b</span> <span class="main">←</span> <span class="free">os_insert_sort_aux</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
     <span class="bound">b'</span> <span class="main">←</span> os_insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">b</span><span class="main">;</span>
     return <span class="bound">b'</span>
   <span class="main">}</span>"</span></span>

<span class="keyword1" id="LinkedList-os_insert_sort_aux_correct"><span class="command">lemma</span></span> os_insert_sort_aux_correct <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> os_insert_sort_aux <span class="free">xs</span> <span class="main">&lt;</span>os_list <span class="main">(</span>insert_sort <span class="free">xs</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">os_insert_sort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>ord<span class="main">,</span>heap<span class="main">}</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">os_insert_sort</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">p</span> <span class="main">←</span> os_insert_sort_aux <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
    <span class="bound">l</span> <span class="main">←</span> extract_list <span class="bound">p</span><span class="main">;</span>
    return <span class="bound">l</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="LinkedList-insertion_sort_rule"><span class="command">lemma</span></span> insertion_sort_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> os_insert_sort <span class="free">xs</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> <span class="main">↑</span><span class="main">(</span><span class="bound">ys</span> <span class="main">=</span> sort <span class="free">xs</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Merging two lists›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>ord<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_list</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_list</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="main">(</span><span class="free">merge_list</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="main">(</span><span class="free">merge_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> merge_list.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="LinkedList-merge_list_correct"><span class="command">lemma</span></span> merge_list_correct <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>merge_list <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"merge_list <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="LinkedList-merge_list_sorted"><span class="command">lemma</span></span> merge_list_sorted <span class="main">[</span><span class="operator">forward</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span> <span class="main">⟹</span> sorted <span class="free">ys</span> <span class="main">⟹</span> sorted <span class="main">(</span>merge_list <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"merge_list <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">merge_os_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span> ord<span class="main">}</span><span class="main">)</span> os_list <span class="main">⇒</span> <span class="tfree">'a</span> os_list <span class="main">⇒</span> <span class="tfree">'a</span> os_list Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_os_list</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> None <span class="keyword1">then</span> return <span class="free"><span class="bound"><span class="entity">q</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> None <span class="keyword1">then</span> return <span class="free"><span class="bound"><span class="entity">p</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">np</span> <span class="main">←</span> <span class="main">!</span><span class="main">(</span>the <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span> <span class="bound">nq</span> <span class="main">←</span> <span class="main">!</span><span class="main">(</span>the <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">if</span> val <span class="bound">np</span> <span class="main">≤</span> val <span class="bound">nq</span> <span class="keyword1">then</span>
        <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">npq</span> <span class="main">←</span> <span class="free">merge_os_list</span> <span class="main">(</span>nxt <span class="bound">np</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">;</span>
             <span class="main">(</span>the <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">:=</span> Node <span class="main">(</span>val <span class="bound">np</span><span class="main">)</span> <span class="bound">npq</span><span class="main">;</span>
             return <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">}</span>
      <span class="keyword1">else</span>
        <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">pnq</span> <span class="main">←</span> <span class="free">merge_os_list</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>nxt <span class="bound">nq</span><span class="main">)</span><span class="main">;</span>
             <span class="main">(</span>the <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">:=</span> Node <span class="main">(</span>val <span class="bound">nq</span><span class="main">)</span> <span class="bound">pnq</span><span class="main">;</span>
             return <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">}</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LinkedList-merge_os_list_to_fun"><span class="command">lemma</span></span> merge_os_list_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>os_list <span class="free">xs</span> <span class="free">p</span> <span class="main">*</span> os_list <span class="free">ys</span> <span class="free">q</span><span class="main">&gt;</span>
  merge_os_list <span class="free">p</span> <span class="free">q</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> os_list <span class="main">(</span>merge_list <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="bound">r</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"merge_list <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹List copy›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">copy_os_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap os_list <span class="main">⇒</span> <span class="tfree">'a</span> os_list Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">copy_os_list</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> return None
    <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">v</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
        <span class="bound">q</span> <span class="main">←</span> <span class="free">copy_os_list</span> <span class="main">(</span>nxt <span class="bound">v</span><span class="main">)</span><span class="main">;</span>
        os_prepend <span class="main">(</span>val <span class="bound">v</span><span class="main">)</span> <span class="bound">q</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LinkedList-copy_os_list_rule"><span class="command">lemma</span></span> copy_os_list_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>os_list <span class="free">xs</span> <span class="free">b</span><span class="main">&gt;</span> copy_os_list <span class="free">b</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> os_list <span class="free">xs</span> <span class="free">b</span> <span class="main">*</span> os_list <span class="free">xs</span> <span class="bound">r</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Higher-order functions›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">map_os_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> os_list <span class="main">⇒</span> <span class="tfree">'a</span> os_list Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_os_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> return None
    <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">v</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
        <span class="bound">q</span> <span class="main">←</span> <span class="free">map_os_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>nxt <span class="bound">v</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">p</span> <span class="main">:=</span> Node <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>val <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span><span class="main">;</span>
        return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LinkedList-map_os_list_rule"><span class="command">lemma</span></span> map_os_list_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>os_list <span class="free">xs</span> <span class="free">b</span><span class="main">&gt;</span> map_os_list <span class="free">f</span> <span class="free">b</span> <span class="main">&lt;</span>os_list <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">filter_os_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> os_list <span class="main">⇒</span> <span class="tfree">'a</span> os_list Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filter_os_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> return None
    <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">v</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
        <span class="bound">q</span> <span class="main">←</span> <span class="free">filter_os_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>nxt <span class="bound">v</span><span class="main">)</span><span class="main">;</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>val <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">p</span> <span class="main">:=</span> Node <span class="main">(</span>val <span class="bound">v</span><span class="main">)</span> <span class="bound">q</span><span class="main">;</span>
           return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span>
         <span class="keyword1">else</span> return <span class="bound">q</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LinkedList-filter_os_list_rule"><span class="command">lemma</span></span> filter_os_list_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>os_list <span class="free">xs</span> <span class="free">b</span><span class="main">&gt;</span> filter_os_list <span class="free">f</span> <span class="free">b</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> os_list <span class="main">(</span>filter <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="bound">r</span> <span class="main">*</span> <span class="keyword1">true</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">filter_os_list2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> os_list <span class="main">⇒</span> <span class="tfree">'a</span> os_list Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filter_os_list2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> return None
    <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">v</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
        <span class="bound">q</span> <span class="main">←</span> <span class="free">filter_os_list2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>nxt <span class="bound">v</span><span class="main">)</span><span class="main">;</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>val <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> os_prepend <span class="main">(</span>val <span class="bound">v</span><span class="main">)</span> <span class="bound">q</span>
         <span class="keyword1">else</span> return <span class="bound">q</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LinkedList-filter_os_list2_rule"><span class="command">lemma</span></span> filter_os_list2_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>os_list <span class="free">xs</span> <span class="free">b</span><span class="main">&gt;</span> filter_os_list2 <span class="free">f</span> <span class="free">b</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> os_list <span class="free">xs</span> <span class="free">b</span> <span class="main">*</span> os_list <span class="main">(</span>filter <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="bound">r</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> List.fold_simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">fold_os_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> os_list <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fold_os_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> return <span class="free"><span class="bound"><span class="entity">x</span></span></span>
    <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">v</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
       <span class="bound">r</span> <span class="main">←</span> <span class="free">fold_os_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>nxt <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>val <span class="bound">v</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
       return <span class="bound">r</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LinkedList-fold_os_list_rule"><span class="command">lemma</span></span> fold_os_list_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>os_list <span class="free">xs</span> <span class="free">b</span><span class="main">&gt;</span> fold_os_list <span class="free">f</span> <span class="free">b</span> <span class="free">x</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> os_list <span class="free">xs</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> fold <span class="free">f</span> <span class="free">xs</span> <span class="free">x</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">x</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/list_matcher_test.ML">
<div class="head">
<h1>File ‹list_matcher_test.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: list_matcher_test.ML
  Author: Bohua Zhan

  Unit test for matching of assertions on linked lists.
*)</span>

<span class="keyword2"><span class="keyword">local</span></span>

  <span class="keyword3"><span class="keyword">open</span></span> SepUtil

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eq_info_list</span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span> <span class="entity">l2</span><span class="main">)</span> <span class="main">=</span>
      length <span class="entity">l1</span> <span class="main">=</span> length <span class="entity">l2</span> <span class="keyword1"><span class="keyword">andalso</span></span>
      eq_set <span class="main">(</span>eq_pair <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> aconv<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">l1</span><span class="main">,</span> <span class="entity">l2</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_term_info</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=</span>
      <span class="inner_quoted">"("</span> ^ <span class="main">(</span><span class="entity">BoxID.string_of_box_id</span> <span class="entity">id</span><span class="main">)</span> ^ <span class="inner_quoted">", "</span> ^ <span class="main">(</span>Syntax.string_of_term <span class="entity">ctxt</span> <span class="entity">t</span><span class="main">)</span> ^ <span class="inner_quoted">")"</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_term_infos</span> <span class="entity">ctxt</span> <span class="entity">lst</span> <span class="main">=</span>
      commas <span class="main">(</span>map <span class="main">(</span><span class="entity">print_term_info</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">lst</span><span class="main">)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_rewrite</span> <span class="entity">id</span> <span class="main">(</span><span class="entity">str1</span><span class="main">,</span> <span class="entity">str2</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span> <span class="entity">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Syntax.read_term <span class="entity">ctxt</span> <span class="entity">str1</span><span class="main">,</span> Syntax.read_term <span class="entity">ctxt</span> <span class="entity">str2</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> Proof_Context.theory_of <span class="entity">ctxt</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">assume_eq</span> <span class="entity">thy</span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span> <span class="entity">t2</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">ctxt</span> |&gt; <span class="entity">RewriteTable.add_rewrite</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">th</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ts</span> <span class="main">=</span> <span class="main">[</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">[</span><span class="free">p</span><span class="main">::</span>nat node ref option<span class="main">,</span> <span class="free">n1</span><span class="main">,</span> <span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">]</span>"</span><span class="antiquote">}</span></span><span class="main">,</span>
            <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">[</span><span class="free">pp</span><span class="main">::</span>nat node ref<span class="main">,</span> <span class="free">pp'</span><span class="main">]</span>"</span><span class="antiquote">}</span></span><span class="main">,</span>
            <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">::</span>nat<span class="main">]</span>"</span><span class="antiquote">}</span></span><span class="main">,</span>
            <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">[</span><span class="free">xs</span><span class="main">::</span>nat list<span class="main">,</span> <span class="free">ys</span><span class="main">,</span> <span class="free">zs</span><span class="main">]</span>"</span><span class="antiquote">}</span></span><span class="main">]</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt'</span> <span class="main">=</span> <span class="entity">ctxt</span> |&gt; fold Proof_Context.augment <span class="entity">ts</span>
                   |&gt; <span class="entity">RewriteTable.add_term</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="main">(</span>Free <span class="main">(</span><span class="inner_quoted">"P"</span><span class="main">,</span> <span class="entity">assnT</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> |&gt; snd
                   |&gt; <span class="entity">add_rewrite</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span><span class="inner_quoted">"n1"</span><span class="main">,</span> <span class="inner_quoted">"None::nat node ref option"</span><span class="main">)</span> |&gt; snd
                   |&gt; <span class="entity">add_rewrite</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span><span class="inner_quoted">"s1"</span><span class="main">,</span> <span class="inner_quoted">"Some pp"</span><span class="main">)</span> |&gt; snd
                   |&gt; <span class="entity">add_rewrite</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span><span class="inner_quoted">"s2"</span><span class="main">,</span> <span class="inner_quoted">"Some pp'"</span><span class="main">)</span> |&gt; snd
                   |&gt; <span class="entity">add_rewrite</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span><span class="inner_quoted">"zs"</span><span class="main">,</span> <span class="inner_quoted">"x # xs"</span><span class="main">)</span> |&gt; snd
<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">test</span> <span class="entity">test_fun</span> <span class="entity">str</span> <span class="main">(</span><span class="entity">pat_str</span><span class="main">,</span> <span class="entity">t_str</span><span class="main">,</span> <span class="entity">info_str</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pat</span> <span class="main">=</span> Proof_Context.read_term_pattern <span class="entity">ctxt'</span> <span class="entity">pat_str</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Syntax.read_term <span class="entity">ctxt'</span> <span class="entity">t_str</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ct</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">t</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">info</span> <span class="main">=</span> map <span class="main">(</span>apsnd <span class="main">(</span>Syntax.read_term <span class="entity">ctxt'</span><span class="main">)</span><span class="main">)</span> <span class="entity">info_str</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">info'</span> <span class="main">=</span> <span class="main">(</span><span class="entity">test_fun</span> <span class="entity">ctxt'</span> <span class="main">(</span><span class="entity">pat</span><span class="main">,</span> <span class="entity">ct</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">fo_init</span><span class="main">)</span><span class="main">)</span> |&gt; map <span class="main">(</span>apsnd <span class="entity">prop_of'</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">infol</span> <span class="main">=</span> <span class="entity">info'</span> |&gt; map snd |&gt; map <span class="entity">dest_arg1</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">infor</span> <span class="main">=</span> <span class="entity">info'</span> |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">id</span><span class="main">,</span> <span class="entity">dest_arg</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> forall <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t'</span> <span class="main">=&gt;</span> <span class="entity">t'</span> aconv <span class="entity">t</span><span class="main">)</span> <span class="entity">infol</span> <span class="keyword1"><span class="keyword">andalso</span></span>
         <span class="entity">eq_info_list</span> <span class="main">(</span><span class="entity">info</span><span class="main">,</span> <span class="entity">infor</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> tracing <span class="main">(</span><span class="inner_quoted">"Expected: "</span> ^ <span class="entity">print_term_infos</span> <span class="entity">ctxt'</span> <span class="entity">info</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> tracing <span class="main">(</span><span class="inner_quoted">"Actual: "</span> ^ <span class="entity">print_term_infos</span> <span class="entity">ctxt'</span> <span class="entity">infor</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="entity">str</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test_assn_term_matcher</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test_data</span> <span class="main">=</span> <span class="main">[</span>
        <span class="main">(</span><span class="inner_quoted">"os_list ?xs n1"</span><span class="main">,</span> <span class="inner_quoted">"emp"</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="inner_quoted">"os_list [] n1 * emp"</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"os_list ?xs n1"</span><span class="main">,</span> <span class="inner_quoted">"sngr_assn a 1"</span><span class="main">,</span>
         <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="inner_quoted">"os_list [] n1 * sngr_assn a 1"</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"os_list ?xs s1"</span><span class="main">,</span> <span class="inner_quoted">"sngr_assn pp (Node x r) * os_list xs r"</span><span class="main">,</span>
         <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="inner_quoted">"os_list (x # xs) s1 * emp"</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"os_list (?x # ?xs) s1"</span><span class="main">,</span> <span class="inner_quoted">"sngr_assn pp (Node x r) * os_list xs r"</span><span class="main">,</span>
         <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="inner_quoted">"os_list (x # xs) s1 * emp"</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"os_list ys s1"</span><span class="main">,</span> <span class="inner_quoted">"sngr_assn pp (Node x r) * os_list xs r"</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"os_list zs s1"</span><span class="main">,</span> <span class="inner_quoted">"sngr_assn pp (Node x r) * os_list xs r"</span><span class="main">,</span>
         <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="inner_quoted">"os_list zs s1 * emp"</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"os_list zs s1"</span><span class="main">,</span>
         <span class="inner_quoted">"sngr_assn pp (Node x r) * os_list xs r * os_list ys p"</span><span class="main">,</span>
         <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="inner_quoted">"os_list zs s1 * os_list ys p"</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
      <span class="main">]</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      map <span class="main">(</span><span class="entity">test</span> <span class="entity">AssnMatcher.assn_match_term</span> <span class="inner_quoted">"test_assn_term_matcher"</span><span class="main">)</span> <span class="entity">test_data</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test_list_prop_matcher</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test_data</span> <span class="main">=</span> <span class="main">[</span>
        <span class="main">(</span><span class="inner_quoted">"os_list ?xs s1"</span><span class="main">,</span> <span class="inner_quoted">"sngr_assn pp (Node x r) * os_list xs r"</span><span class="main">,</span>
         <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="inner_quoted">"os_list (x # xs) s1"</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"os_list zs s1"</span><span class="main">,</span> <span class="inner_quoted">"sngr_assn pp (Node x r) * os_list xs r"</span><span class="main">,</span>
         <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="inner_quoted">"os_list zs s1"</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"os_list ?xs p * os_list ?ys q"</span><span class="main">,</span> <span class="inner_quoted">"os_list ys q * os_list xs p"</span><span class="main">,</span>
         <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="inner_quoted">"os_list xs p * os_list ys q"</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"os_list ?xs p"</span><span class="main">,</span> <span class="inner_quoted">"os_list xs p * os_list ys q"</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"sngr_assn a 1"</span><span class="main">,</span> <span class="inner_quoted">"sngr_assn a 1"</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="inner_quoted">"sngr_assn a 1"</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="inner_quoted">"sngr_assn ?a 1 * os_list ?ys q * os_list ?zs r"</span><span class="main">,</span>
         <span class="inner_quoted">"os_list ys q * os_list zs r * sngr_assn a 1"</span><span class="main">,</span>
         <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="inner_quoted">"sngr_assn a 1 * os_list ys q * os_list zs r"</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
      <span class="main">]</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      map <span class="main">(</span><span class="entity">test</span> <span class="entity">AssnMatcher.assn_match_strict</span> <span class="inner_quoted">"test_list_prop_matcher"</span><span class="main">)</span> <span class="entity">test_data</span>
    <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BST_Impl">
<div class="head">
<h1>Theory BST_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: BST_Impl.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation of binary search tree›</span></span>

<span class="keyword1"><span class="command">theory</span></span> BST_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="SepAuto.html">SepAuto</a> <span class="quoted">"<a href="BST.html">../Functional/BST</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Imperative version of binary search trees.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Tree nodes›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> node <span class="main">=</span>
  Node <span class="main">(</span><span class="free"><span class="entity">lsub</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> node ref option"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">key</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">val</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">rsub</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> node ref option"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> node.sel<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">node_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> node <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">node_encode</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> to_nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> node <span class="main">::</span> <span class="main">(</span><span class="quoted">heap</span><span class="main">,</span> <span class="quoted">heap</span><span class="main">)</span> <span class="quoted">heap</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> heap_class.intro<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> countable_classI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"node_encode"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">btree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> node ref option <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree</span> Tip <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">↑</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">btree</span> <span class="main">(</span>tree.Node <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">lp</span> <span class="bound">rp</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> Node <span class="bound">lp</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">rp</span> <span class="main">*</span> <span class="free">btree</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="bound">lp</span> <span class="main">*</span> <span class="free">btree</span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span> <span class="bound">rp</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">btree</span> <span class="main">(</span>tree.Node <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span> None <span class="main">=</span> <span class="keyword1">false</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_ent_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> btree.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="BST_Impl-btree_Tip"><span class="command">lemma</span></span> btree_Tip <span class="main">[</span><span class="operator">forward_ent</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"btree Tip <span class="free">p</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">↑</span><span class="main">(</span><span class="free">p</span> <span class="main">=</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="BST_Impl-btree_Node"><span class="command">lemma</span></span> btree_Node <span class="main">[</span><span class="operator">forward_ent</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"btree <span class="main">(</span>tree.Node <span class="free">lt</span> <span class="free">k</span> <span class="free">v</span> <span class="free">rt</span><span class="main">)</span> <span class="free">p</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">lp</span> <span class="bound">rp</span><span class="main">.</span> the <span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> Node <span class="bound">lp</span> <span class="free">k</span> <span class="free">v</span> <span class="bound">rp</span> <span class="main">*</span> btree <span class="free">lt</span> <span class="bound">lp</span> <span class="main">*</span> btree <span class="free">rt</span> <span class="bound">rp</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">p</span> <span class="main">≠</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="BST_Impl-btree_none"><span class="command">lemma</span></span> btree_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">emp</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> btree tree.Tip None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="BST_Impl-btree_constr_ent"><span class="command">lemma</span></span> btree_constr_ent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> Node <span class="free">lp</span> <span class="free">k</span> <span class="free">v</span> <span class="free">rp</span> <span class="main">*</span> btree <span class="free">lt</span> <span class="free">lp</span> <span class="main">*</span> btree <span class="free">rt</span> <span class="free">rp</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> btree <span class="main">(</span>tree.Node <span class="free">lt</span> <span class="free">k</span> <span class="free">v</span> <span class="free">rt</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_entail_matcher</span> <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> btree_none<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> btree_constr_ent<span class="antiquote">}</span></span></span><span class="main">]</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> btree.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> node ref option"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operations›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Basic operations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tree_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_empty</span> <span class="main">=</span> return None"</span></span>

<span class="keyword1" id="BST_Impl-tree_empty_rule"><span class="command">lemma</span></span> tree_empty_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> tree_empty <span class="main">&lt;</span>btree Tip<span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tree_is_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree <span class="main">⇒</span> bool Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_is_empty</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="BST_Impl-tree_is_empty_rule"><span class="command">lemma</span></span> tree_is_empty_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="free">t</span> <span class="free">b</span><span class="main">&gt;</span> tree_is_empty <span class="free">b</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> btree <span class="free">t</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> <span class="free">t</span> <span class="main">=</span> Tip<span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">btree_constr</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_constr</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">rp</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">p</span> <span class="main">←</span> ref <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">rp</span></span></span><span class="main">)</span><span class="main">;</span> return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="BST_Impl-btree_constr_rule"><span class="command">lemma</span></span> btree_constr_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="free">lt</span> <span class="free">lp</span> <span class="main">*</span> btree <span class="free">rt</span> <span class="free">rp</span><span class="main">&gt;</span> btree_constr <span class="free">lp</span> <span class="free">k</span> <span class="free">v</span> <span class="free">rp</span> <span class="main">&lt;</span>btree <span class="main">(</span>tree.Node <span class="free">lt</span> <span class="free">k</span> <span class="free">v</span> <span class="free">rt</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Insertion›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">btree_insert</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>heap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_insert</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> btree_constr None <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> None
   <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> key <span class="bound">t</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">p</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> key <span class="bound">t</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">q</span> <span class="main">←</span> <span class="free">btree_insert</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">p</span> <span class="main">:=</span> Node <span class="bound">q</span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span>
       <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">q</span> <span class="main">←</span> <span class="free">btree_insert</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">p</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="bound">q</span><span class="main">;</span>
         return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="BST_Impl-btree_insert_to_fun"><span class="command">lemma</span></span> btree_insert_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="free">t</span> <span class="free">b</span><span class="main">&gt;</span>
   btree_insert <span class="free">k</span> <span class="free">v</span> <span class="free">b</span>
   <span class="main">&lt;</span>btree <span class="main">(</span>tree_insert <span class="free">k</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Deletion›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">btree_del_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree<span class="main">)</span> Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_del_min</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> raise <span class="keyword1">STR</span> <span class="inner_quoted">''del_min: empty tree''</span>
   <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">if</span> lsub <span class="bound">t</span> <span class="main">=</span> None <span class="keyword1">then</span>
         return <span class="main">(</span><span class="main">(</span>key <span class="bound">t</span><span class="main">,</span> val <span class="bound">t</span><span class="main">)</span><span class="main">,</span> rsub <span class="bound">t</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">r</span> <span class="main">←</span> <span class="free">btree_del_min</span> <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">p</span> <span class="main">:=</span> Node <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         return <span class="main">(</span>fst <span class="bound">r</span><span class="main">,</span> Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="BST_Impl-btree_del_min_to_fun"><span class="command">lemma</span></span> btree_del_min_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="free">t</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">b</span> <span class="main">≠</span> None<span class="main">)</span><span class="main">&gt;</span>
   btree_del_min <span class="free">b</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">.</span> btree <span class="main">(</span>snd <span class="main">(</span>del_min <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> fst <span class="main">(</span>del_min <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">btree_del_elt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_del_elt</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> raise <span class="keyword1">STR</span> <span class="inner_quoted">''del_elt: empty tree''</span>
   <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">if</span> lsub <span class="bound">t</span> <span class="main">=</span> None <span class="keyword1">then</span> return <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> rsub <span class="bound">t</span> <span class="main">=</span> None <span class="keyword1">then</span> return <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">r</span> <span class="main">←</span> btree_del_min <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">p</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>fst <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span><span class="main">;</span>
          return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="BST_Impl-btree_del_elt_to_fun"><span class="command">lemma</span></span> btree_del_elt_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="main">(</span>tree.Node <span class="free">lt</span> <span class="free">x</span> <span class="free">v</span> <span class="free">rt</span><span class="main">)</span> <span class="free">b</span><span class="main">&gt;</span>
   btree_del_elt <span class="free">b</span>
   <span class="main">&lt;</span>btree <span class="main">(</span>delete_elt_tree <span class="main">(</span>tree.Node <span class="free">lt</span> <span class="free">x</span> <span class="free">v</span> <span class="free">rt</span><span class="main">)</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">btree_delete</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> return None
   <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> key <span class="bound">t</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">r</span> <span class="main">←</span> btree_del_elt <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span>
         return <span class="bound">r</span> <span class="main">}</span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> key <span class="bound">t</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">q</span> <span class="main">←</span> <span class="free">btree_delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">p</span> <span class="main">:=</span> Node <span class="bound">q</span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span>
       <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">q</span> <span class="main">←</span> <span class="free">btree_delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">p</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="bound">q</span><span class="main">;</span>
         return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="BST_Impl-btree_delete_to_fun"><span class="command">lemma</span></span> btree_delete_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="free">t</span> <span class="free">b</span><span class="main">&gt;</span>
   btree_delete <span class="free">x</span> <span class="free">b</span>
   <span class="main">&lt;</span>btree <span class="main">(</span>tree_delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Search›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">btree_search</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> <span class="tfree">'b</span> option Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_search</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> return None
   <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> key <span class="bound">t</span> <span class="keyword1">then</span> return <span class="main">(</span>Some <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> key <span class="bound">t</span> <span class="keyword1">then</span> <span class="free">btree_search</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="free">btree_search</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="BST_Impl-btree_search_correct"><span class="command">lemma</span></span> btree_search_correct <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="free">t</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>tree_sorted <span class="free">t</span><span class="main">)</span><span class="main">&gt;</span>
   btree_search <span class="free">x</span> <span class="free">b</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> btree <span class="free">t</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> tree_search <span class="free">t</span> <span class="free">x</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Outer interface›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Express Hoare triples for operations on binary search tree in terms of
  the mapping represented by the tree.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">btree_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> map <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> node ref option <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_map</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">t</span><span class="main">.</span> btree <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>tree_sorted <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> tree_map <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_ent_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> btree_map_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">theorem</span></span> btree_empty_rule_map <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> tree_empty <span class="main">&lt;</span>btree_map empty_map<span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> btree_insert_rule_map <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree_map <span class="free">M</span> <span class="free">b</span><span class="main">&gt;</span> btree_insert <span class="free">k</span> <span class="free">v</span> <span class="free">b</span> <span class="main">&lt;</span>btree_map <span class="main">(</span><span class="free">M</span> <span class="main">{</span><span class="free">k</span> <span class="main">→</span> <span class="free">v</span><span class="main">}</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> btree_delete_rule_map <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree_map <span class="free">M</span> <span class="free">b</span><span class="main">&gt;</span> btree_delete <span class="free">x</span> <span class="free">b</span> <span class="main">&lt;</span>btree_map <span class="main">(</span>delete_map <span class="free">x</span> <span class="free">M</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> btree_search_rule_map <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree_map <span class="free">M</span> <span class="free">b</span><span class="main">&gt;</span> btree_search <span class="free">x</span> <span class="free">b</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> btree_map <span class="free">M</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">M</span><span class="main">⟨</span><span class="free">x</span><span class="main">⟩</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="RBTree_Impl">
<div class="head">
<h1>Theory RBTree_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: RBTree_Impl.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation of red-black tree›</span></span>

<span class="keyword1"><span class="command">theory</span></span> RBTree_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="SepAuto.html">SepAuto</a> <span class="quoted">"<a href="RBTree.html">../Functional/RBTree</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Verification of imperative red-black trees.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Tree nodes›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt_node <span class="main">=</span>
  Node <span class="main">(</span><span class="free"><span class="entity">lsub</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt_node ref option"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">cl</span></span><span class="main">:</span> <span class="quoted">color</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">key</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">val</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">rsub</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt_node ref option"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rbt_node.sel<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">color_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"color <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">color_encode</span> B <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">color_encode</span> R <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> color <span class="main">::</span> <span class="quoted">heap</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> heap_class.intro<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> countable_classI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"color_encode"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> color_encode.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> color_encode.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> not_B zero_neq_one<span class="main">)</span>
  <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rbt_node_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> rbt_node <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_node_encode</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> to_nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> rbt_node <span class="main">::</span> <span class="main">(</span><span class="quoted">heap</span><span class="main">,</span> <span class="quoted">heap</span><span class="main">)</span> <span class="quoted">heap</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> heap_class.intro<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> countable_classI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"rbt_node_encode"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">btree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt_node ref option <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree</span> Leaf <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">↑</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">btree</span> <span class="main">(</span>rbt.Node <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">lp</span> <span class="bound">rp</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> Node <span class="bound">lp</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">rp</span> <span class="main">*</span> <span class="free">btree</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="bound">lp</span> <span class="main">*</span> <span class="free">btree</span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span> <span class="bound">rp</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">btree</span> <span class="main">(</span>rbt.Node <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span> None <span class="main">=</span> <span class="keyword1">false</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_ent_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> btree.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="RBTree_Impl-btree_Leaf"><span class="command">lemma</span></span> btree_Leaf <span class="main">[</span><span class="operator">forward_ent</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"btree Leaf <span class="free">p</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">↑</span><span class="main">(</span><span class="free">p</span> <span class="main">=</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree_Impl-btree_Node"><span class="command">lemma</span></span> btree_Node <span class="main">[</span><span class="operator">forward_ent</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"btree <span class="main">(</span>rbt.Node <span class="free">lt</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">rt</span><span class="main">)</span> <span class="free">p</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">lp</span> <span class="bound">rp</span><span class="main">.</span> the <span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> Node <span class="bound">lp</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="bound">rp</span> <span class="main">*</span> btree <span class="free">lt</span> <span class="bound">lp</span> <span class="main">*</span> btree <span class="free">rt</span> <span class="bound">rp</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">p</span> <span class="main">≠</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="RBTree_Impl-btree_none"><span class="command">lemma</span></span> btree_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">emp</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> btree Leaf None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="RBTree_Impl-btree_constr_ent"><span class="command">lemma</span></span> btree_constr_ent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> Node <span class="free">lp</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">rp</span> <span class="main">*</span> btree <span class="free">lt</span> <span class="free">lp</span> <span class="main">*</span> btree <span class="free">rt</span> <span class="free">rp</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> btree <span class="main">(</span>rbt.Node <span class="free">lt</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">rt</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_entail_matcher</span> <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> btree_none<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> btree_constr_ent<span class="antiquote">}</span></span></span><span class="main">]</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> btree.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt_node ref option"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operations›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Basic operations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tree_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_empty</span> <span class="main">=</span> return None"</span></span>

<span class="keyword1" id="RBTree_Impl-tree_empty_rule"><span class="command">lemma</span></span> tree_empty_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> tree_empty <span class="main">&lt;</span>btree Leaf<span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tree_is_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree <span class="main">⇒</span> bool Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_is_empty</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="RBTree_Impl-tree_is_empty_rule"><span class="command">lemma</span></span> tree_is_empty_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="free">t</span> <span class="free">b</span><span class="main">&gt;</span> tree_is_empty <span class="free">b</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> btree <span class="free">t</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> <span class="free">t</span> <span class="main">=</span> Leaf<span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">btree_constr</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> color <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_constr</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">rp</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">p</span> <span class="main">←</span> ref <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">rp</span></span></span><span class="main">)</span><span class="main">;</span> return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="RBTree_Impl-btree_constr_rule"><span class="command">lemma</span></span> btree_constr_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="free">lt</span> <span class="free">lp</span> <span class="main">*</span> btree <span class="free">rt</span> <span class="free">rp</span><span class="main">&gt;</span>
   btree_constr <span class="free">lp</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">rp</span>
   <span class="main">&lt;</span>btree <span class="main">(</span>rbt.Node <span class="free">lt</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">rt</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">set_color</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"color <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_color</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> raise <span class="keyword1">STR</span> <span class="inner_quoted">''set_color''</span>
  <span class="main">|</span> Some <span class="bound">pp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">pp</span><span class="main">;</span>
      <span class="bound">pp</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="RBTree_Impl-set_color_rule"><span class="command">lemma</span></span> set_color_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="main">(</span>rbt.Node <span class="free">a</span> <span class="free">c</span> <span class="free">x</span> <span class="free">v</span> <span class="free">b</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   set_color <span class="free">c'</span> <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> btree <span class="main">(</span>rbt.Node <span class="free">a</span> <span class="free">c'</span> <span class="free">x</span> <span class="free">v</span> <span class="free">b</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_color</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> color Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_color</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> return B
   <span class="main">|</span> Some <span class="bound">pp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">pp</span><span class="main">;</span>
       return <span class="main">(</span>cl <span class="bound">t</span><span class="main">)</span>
     <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="RBTree_Impl-get_color_rule"><span class="command">lemma</span></span> get_color_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="free">t</span> <span class="free">p</span><span class="main">&gt;</span> get_color <span class="free">p</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> btree <span class="free">t</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> rbt.cl <span class="free">t</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">paint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"color <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">paint</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> return <span class="main">()</span>
  <span class="main">|</span> Some <span class="bound">pp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">pp</span><span class="main">;</span>
     <span class="bound">pp</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span>
   <span class="main">}</span><span class="main">)</span>"</span></span>
  
<span class="keyword1" id="RBTree_Impl-paint_rule"><span class="command">lemma</span></span> paint_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="free">t</span> <span class="free">p</span><span class="main">&gt;</span>
   paint <span class="free">c</span> <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> btree <span class="main">(</span>RBTree.paint <span class="free">c</span> <span class="free">t</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Rotation›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">btree_rotate_l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_rotate_l</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> raise <span class="keyword1">STR</span> <span class="inner_quoted">''Empty btree''</span>
  <span class="main">|</span> Some <span class="bound">pp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">pp</span><span class="main">;</span>
     <span class="main">(</span><span class="keyword1">case</span> rsub <span class="bound">t</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> raise <span class="keyword1">STR</span> <span class="inner_quoted">''Empty rsub''</span>
      <span class="main">|</span> Some <span class="bound">rp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">rt</span> <span class="main">←</span> <span class="main">!</span><span class="bound">rp</span><span class="main">;</span>
          <span class="bound">pp</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>cl <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>lsub <span class="bound">rt</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">rp</span> <span class="main">:=</span> Node <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>cl <span class="bound">rt</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">rt</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">rt</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">rt</span><span class="main">)</span><span class="main">;</span>
          return <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="RBTree_Impl-btree_rotate_l_rule"><span class="command">lemma</span></span> btree_rotate_l_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="main">(</span>rbt.Node <span class="free">a</span> <span class="free">c1</span> <span class="free">x</span> <span class="free">v</span> <span class="main">(</span>rbt.Node <span class="free">b</span> <span class="free">c2</span> <span class="free">y</span> <span class="free">w</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   btree_rotate_l <span class="free">p</span>
   <span class="main">&lt;</span>btree <span class="main">(</span>rbt.Node <span class="main">(</span>rbt.Node <span class="free">a</span> <span class="free">c1</span> <span class="free">x</span> <span class="free">v</span> <span class="free">b</span><span class="main">)</span> <span class="free">c2</span> <span class="free">y</span> <span class="free">w</span> <span class="free">c</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">btree_rotate_r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_rotate_r</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> raise <span class="keyword1">STR</span> <span class="inner_quoted">''Empty btree''</span>
  <span class="main">|</span> Some <span class="bound">pp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">pp</span><span class="main">;</span>
     <span class="main">(</span><span class="keyword1">case</span> lsub <span class="bound">t</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> raise <span class="keyword1">STR</span> <span class="inner_quoted">''Empty lsub''</span>
      <span class="main">|</span> Some <span class="bound">lp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">lt</span> <span class="main">←</span> <span class="main">!</span><span class="bound">lp</span><span class="main">;</span>
          <span class="bound">pp</span> <span class="main">:=</span> Node <span class="main">(</span>rsub <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>cl <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">lp</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>cl <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">lt</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
          return <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="RBTree_Impl-btree_rotate_r_rule"><span class="command">lemma</span></span> btree_rotate_r_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="main">(</span>rbt.Node <span class="main">(</span>rbt.Node <span class="free">a</span> <span class="free">c1</span> <span class="free">x</span> <span class="free">v</span> <span class="free">b</span><span class="main">)</span> <span class="free">c2</span> <span class="free">y</span> <span class="free">w</span> <span class="free">c</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   btree_rotate_r <span class="free">p</span>
   <span class="main">&lt;</span>btree <span class="main">(</span>rbt.Node <span class="free">a</span> <span class="free">c1</span> <span class="free">x</span> <span class="free">v</span> <span class="main">(</span>rbt.Node <span class="free">b</span> <span class="free">c2</span> <span class="free">y</span> <span class="free">w</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Balance›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">btree_balanceR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_balanceR</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> return None <span class="main">|</span> Some <span class="bound">pp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">pp</span><span class="main">;</span>
     <span class="bound">cl_r</span> <span class="main">←</span> get_color <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
     <span class="keyword1">if</span> <span class="bound">cl_r</span> <span class="main">=</span> R <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">rt</span> <span class="main">←</span> <span class="main">!</span><span class="main">(</span>the <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">cl_lr</span> <span class="main">←</span> get_color <span class="main">(</span>lsub <span class="bound">rt</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">cl_rr</span> <span class="main">←</span> get_color <span class="main">(</span>rsub <span class="bound">rt</span><span class="main">)</span><span class="main">;</span>
       <span class="keyword1">if</span> <span class="bound">cl_lr</span> <span class="main">=</span> R <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">rp'</span> <span class="main">←</span> btree_rotate_r <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">pp</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>cl <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="bound">rp'</span><span class="main">;</span>
         <span class="bound">p'</span> <span class="main">←</span> btree_rotate_l <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
         <span class="bound">t'</span> <span class="main">←</span> <span class="main">!</span><span class="main">(</span>the <span class="bound">p'</span><span class="main">)</span><span class="main">;</span>
         set_color B <span class="main">(</span>rsub <span class="bound">t'</span><span class="main">)</span><span class="main">;</span>
         return <span class="bound">p'</span>
       <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">cl_rr</span> <span class="main">=</span> R <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">p'</span> <span class="main">←</span> btree_rotate_l <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
         <span class="bound">t'</span> <span class="main">←</span> <span class="main">!</span><span class="main">(</span>the <span class="bound">p'</span><span class="main">)</span><span class="main">;</span>
         set_color B <span class="main">(</span>rsub <span class="bound">t'</span><span class="main">)</span><span class="main">;</span>
         return <span class="bound">p'</span>
        <span class="main">}</span> <span class="keyword1">else</span> return <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">}</span>
     <span class="keyword1">else</span> return <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="RBTree_Impl-balanceR_to_fun"><span class="command">lemma</span></span> balanceR_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="main">(</span>rbt.Node <span class="free">l</span> B <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   btree_balanceR <span class="free">p</span>
   <span class="main">&lt;</span>btree <span class="main">(</span>balanceR <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"balanceR <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">btree_balance</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_balance</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> return None <span class="main">|</span> Some <span class="bound">pp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">pp</span><span class="main">;</span>
     <span class="bound">cl_l</span> <span class="main">←</span> get_color <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
     <span class="keyword1">if</span> <span class="bound">cl_l</span> <span class="main">=</span> R <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">lt</span> <span class="main">←</span> <span class="main">!</span><span class="main">(</span>the <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">cl_rl</span> <span class="main">←</span> get_color <span class="main">(</span>rsub <span class="bound">lt</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">cl_ll</span> <span class="main">←</span> get_color <span class="main">(</span>lsub <span class="bound">lt</span><span class="main">)</span><span class="main">;</span>
       <span class="keyword1">if</span> <span class="bound">cl_ll</span> <span class="main">=</span> R <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">p'</span> <span class="main">←</span> btree_rotate_r <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
         <span class="bound">t'</span> <span class="main">←</span> <span class="main">!</span><span class="main">(</span>the <span class="bound">p'</span><span class="main">)</span><span class="main">;</span>
         set_color B <span class="main">(</span>lsub <span class="bound">t'</span><span class="main">)</span><span class="main">;</span>
         return <span class="bound">p'</span> <span class="main">}</span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">cl_rl</span> <span class="main">=</span> R <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">lp'</span> <span class="main">←</span> btree_rotate_l <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">pp</span> <span class="main">:=</span> Node <span class="bound">lp'</span> <span class="main">(</span>cl <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">p'</span> <span class="main">←</span> btree_rotate_r <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
         <span class="bound">t'</span> <span class="main">←</span> <span class="main">!</span><span class="main">(</span>the <span class="bound">p'</span><span class="main">)</span><span class="main">;</span>
         set_color B <span class="main">(</span>lsub <span class="bound">t'</span><span class="main">)</span><span class="main">;</span>
         return <span class="bound">p'</span>
       <span class="main">}</span> <span class="keyword1">else</span> btree_balanceR <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">}</span>
     <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">p'</span> <span class="main">←</span> btree_balanceR <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
       return <span class="bound">p'</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="RBTree_Impl-balance_to_fun"><span class="command">lemma</span></span> balance_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="main">(</span>rbt.Node <span class="free">l</span> B <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   btree_balance <span class="free">p</span>
   <span class="main">&lt;</span>btree <span class="main">(</span>balance <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"balance <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Insertion›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">rbt_ins</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>ord<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>heap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_ins</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> btree_constr None R <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> None
   <span class="main">|</span> Some <span class="bound">pp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">pp</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">if</span> cl <span class="bound">t</span> <span class="main">=</span> B <span class="keyword1">then</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> key <span class="bound">t</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">pp</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>cl <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
           return <span class="main">(</span>Some <span class="bound">pp</span><span class="main">)</span> <span class="main">}</span>
         <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> key <span class="bound">t</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">q</span> <span class="main">←</span> <span class="free">rbt_ins</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
           <span class="bound">pp</span> <span class="main">:=</span> Node <span class="bound">q</span> <span class="main">(</span>cl <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
           btree_balance <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">}</span>
         <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">q</span> <span class="main">←</span> <span class="free">rbt_ins</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
           <span class="bound">pp</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>cl <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="bound">q</span><span class="main">;</span>
           btree_balance <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">}</span><span class="main">)</span>
       <span class="keyword1">else</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> key <span class="bound">t</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">pp</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>cl <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
           return <span class="main">(</span>Some <span class="bound">pp</span><span class="main">)</span> <span class="main">}</span>
         <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> key <span class="bound">t</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">q</span> <span class="main">←</span> <span class="free">rbt_ins</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
           <span class="bound">pp</span> <span class="main">:=</span> Node <span class="bound">q</span> <span class="main">(</span>cl <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
           return <span class="main">(</span>Some <span class="bound">pp</span><span class="main">)</span> <span class="main">}</span>
         <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">q</span> <span class="main">←</span> <span class="free">rbt_ins</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
           <span class="bound">pp</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>cl <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="bound">q</span><span class="main">;</span>
           return <span class="main">(</span>Some <span class="bound">pp</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="RBTree_Impl-rbt_ins_to_fun"><span class="command">lemma</span></span> rbt_ins_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="free">t</span> <span class="free">p</span><span class="main">&gt;</span>
   rbt_ins <span class="free">k</span> <span class="free">v</span> <span class="free">p</span>
   <span class="main">&lt;</span>btree <span class="main">(</span>ins <span class="free">k</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">p</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rbt_insert</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>ord<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>heap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_insert</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">p'</span> <span class="main">←</span> rbt_ins <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
    paint B <span class="bound">p'</span><span class="main">;</span>
    return <span class="bound">p'</span> <span class="main">}</span>"</span></span>
  
<span class="keyword1" id="RBTree_Impl-rbt_insert_to_fun"><span class="command">lemma</span></span> rbt_insert_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="free">t</span> <span class="free">p</span><span class="main">&gt;</span>
   rbt_insert <span class="free">k</span> <span class="free">v</span> <span class="free">p</span>
   <span class="main">&lt;</span>btree <span class="main">(</span>RBTree.rbt_insert <span class="free">k</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Search›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">rbt_search</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> <span class="tfree">'b</span> option Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_search</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> return None
   <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> key <span class="bound">t</span> <span class="keyword1">then</span> return <span class="main">(</span>Some <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> key <span class="bound">t</span> <span class="keyword1">then</span> <span class="free">rbt_search</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="free">rbt_search</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="RBTree_Impl-btree_search_correct"><span class="command">lemma</span></span> btree_search_correct <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="free">t</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>rbt_sorted <span class="free">t</span><span class="main">)</span><span class="main">&gt;</span>
   rbt_search <span class="free">x</span> <span class="free">b</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> btree <span class="free">t</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> RBTree.rbt_search <span class="free">t</span> <span class="free">x</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">@qed</span></span>
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Delete›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">btree_balL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_balL</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> return None
   <span class="main">|</span> Some <span class="bound">pp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">pp</span><span class="main">;</span>
      <span class="bound">cl_l</span> <span class="main">←</span> get_color <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="bound">cl_l</span> <span class="main">=</span> R <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
        set_color B <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>  <span class="comment1">― ‹Case 1›</span>
        return <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>
      <span class="keyword1">else</span> <span class="keyword1">case</span> rsub <span class="bound">t</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> return <span class="free"><span class="bound"><span class="entity">p</span></span></span>  <span class="comment1">― ‹Case 2›</span>
      <span class="main">|</span> Some <span class="bound">rp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>  
         <span class="bound">rt</span> <span class="main">←</span> <span class="main">!</span><span class="bound">rp</span><span class="main">;</span>
         <span class="keyword1">if</span> cl <span class="bound">rt</span> <span class="main">=</span> B <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
           set_color R <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>  <span class="comment1">― ‹Case 3›</span>
           set_color B <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
           btree_balance <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>
         <span class="keyword1">else</span> <span class="keyword1">case</span> lsub <span class="bound">rt</span> <span class="keyword1">of</span>
           None <span class="main">⇒</span> return <span class="free"><span class="bound"><span class="entity">p</span></span></span>  <span class="comment1">― ‹Case 4›</span>
         <span class="main">|</span> Some <span class="bound">lrp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
            <span class="bound">lrt</span> <span class="main">←</span> <span class="main">!</span><span class="bound">lrp</span><span class="main">;</span>
            <span class="keyword1">if</span> cl <span class="bound">lrt</span> <span class="main">=</span> B <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
              set_color R <span class="main">(</span>lsub <span class="bound">rt</span><span class="main">)</span><span class="main">;</span>  <span class="comment1">― ‹Case 5›</span>
              paint R <span class="main">(</span>rsub <span class="bound">rt</span><span class="main">)</span><span class="main">;</span>
              set_color B <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span> 
              <span class="bound">rp'</span> <span class="main">←</span> btree_rotate_r <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
              <span class="bound">pp</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>cl <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="bound">rp'</span><span class="main">;</span>
              <span class="bound">p'</span> <span class="main">←</span> btree_rotate_l <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
              <span class="bound">t'</span> <span class="main">←</span> <span class="main">!</span><span class="main">(</span>the <span class="bound">p'</span><span class="main">)</span><span class="main">;</span>
              set_color B <span class="main">(</span>lsub <span class="bound">t'</span><span class="main">)</span><span class="main">;</span>
              <span class="bound">rp''</span> <span class="main">←</span> btree_balance <span class="main">(</span>rsub <span class="bound">t'</span><span class="main">)</span><span class="main">;</span>
              the <span class="bound">p'</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t'</span><span class="main">)</span> <span class="main">(</span>cl <span class="bound">t'</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">t'</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t'</span><span class="main">)</span> <span class="bound">rp''</span><span class="main">;</span>
              return <span class="bound">p'</span><span class="main">}</span>
            <span class="keyword1">else</span> return <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="RBTree_Impl-balL_to_fun"><span class="command">lemma</span></span> balL_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="main">(</span>rbt.Node <span class="free">l</span> R <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   btree_balL <span class="free">p</span>
   <span class="main">&lt;</span>btree <span class="main">(</span>balL <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"balL <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">btree_balR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_balR</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> return None
   <span class="main">|</span> Some <span class="bound">pp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">pp</span><span class="main">;</span>
      <span class="bound">cl_r</span> <span class="main">←</span> get_color <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="bound">cl_r</span> <span class="main">=</span> R <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
        set_color B <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>  <span class="comment1">― ‹Case 1›</span>
        return <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>
      <span class="keyword1">else</span> <span class="keyword1">case</span> lsub <span class="bound">t</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> return <span class="free"><span class="bound"><span class="entity">p</span></span></span>  <span class="comment1">― ‹Case 2›</span>
      <span class="main">|</span> Some <span class="bound">lp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>  
         <span class="bound">lt</span> <span class="main">←</span> <span class="main">!</span><span class="bound">lp</span><span class="main">;</span>
         <span class="keyword1">if</span> cl <span class="bound">lt</span> <span class="main">=</span> B <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
           set_color R <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>  <span class="comment1">― ‹Case 3›</span>
           set_color B <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
           btree_balance <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>
         <span class="keyword1">else</span> <span class="keyword1">case</span> rsub <span class="bound">lt</span> <span class="keyword1">of</span>
           None <span class="main">⇒</span> return <span class="free"><span class="bound"><span class="entity">p</span></span></span>  <span class="comment1">― ‹Case 4›</span>
         <span class="main">|</span> Some <span class="bound">rlp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
            <span class="bound">rlt</span> <span class="main">←</span> <span class="main">!</span><span class="bound">rlp</span><span class="main">;</span>
            <span class="keyword1">if</span> cl <span class="bound">rlt</span> <span class="main">=</span> B <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
              set_color R <span class="main">(</span>rsub <span class="bound">lt</span><span class="main">)</span><span class="main">;</span>  <span class="comment1">― ‹Case 5›</span>
              paint R <span class="main">(</span>lsub <span class="bound">lt</span><span class="main">)</span><span class="main">;</span>
              set_color B <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span> 
              <span class="bound">lp'</span> <span class="main">←</span> btree_rotate_l <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
              <span class="bound">pp</span> <span class="main">:=</span> Node <span class="bound">lp'</span> <span class="main">(</span>cl <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
              <span class="bound">p'</span> <span class="main">←</span> btree_rotate_r <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
              <span class="bound">t'</span> <span class="main">←</span> <span class="main">!</span><span class="main">(</span>the <span class="bound">p'</span><span class="main">)</span><span class="main">;</span>
              set_color B <span class="main">(</span>rsub <span class="bound">t'</span><span class="main">)</span><span class="main">;</span>
              <span class="bound">lp''</span> <span class="main">←</span> btree_balance <span class="main">(</span>lsub <span class="bound">t'</span><span class="main">)</span><span class="main">;</span>
              the <span class="bound">p'</span> <span class="main">:=</span> Node <span class="bound">lp''</span> <span class="main">(</span>cl <span class="bound">t'</span><span class="main">)</span> <span class="main">(</span>key <span class="bound">t'</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t'</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">t'</span><span class="main">)</span><span class="main">;</span>
              return <span class="bound">p'</span><span class="main">}</span>
            <span class="keyword1">else</span> return <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="RBTree_Impl-balR_to_fun"><span class="command">lemma</span></span> balR_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="main">(</span>rbt.Node <span class="free">l</span> R <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   btree_balR <span class="free">p</span>
   <span class="main">&lt;</span>btree <span class="main">(</span>balR <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"balR <span class="free">l</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">btree_combine</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">btree_combine</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="free"><span class="bound"><span class="entity">rp</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="main">=</span> None <span class="keyword1">then</span> return <span class="free"><span class="bound"><span class="entity">rp</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">rp</span></span></span> <span class="main">=</span> None <span class="keyword1">then</span> return <span class="free"><span class="bound"><span class="entity">lp</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">lt</span> <span class="main">←</span> <span class="main">!</span><span class="main">(</span>the <span class="free"><span class="bound"><span class="entity">lp</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">rt</span> <span class="main">←</span> <span class="main">!</span><span class="main">(</span>the <span class="free"><span class="bound"><span class="entity">rp</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">if</span> cl <span class="bound">lt</span> <span class="main">=</span> R <span class="keyword1">then</span>
        <span class="keyword1">if</span> cl <span class="bound">rt</span> <span class="main">=</span> R <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">tmp</span> <span class="main">←</span> <span class="free">btree_combine</span> <span class="main">(</span>rsub <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>lsub <span class="bound">rt</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">cl_tm</span> <span class="main">←</span> get_color <span class="bound">tmp</span><span class="main">;</span>
          <span class="keyword1">if</span> <span class="bound">cl_tm</span> <span class="main">=</span> R <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
            <span class="bound">tmt</span> <span class="main">←</span> <span class="main">!</span><span class="main">(</span>the <span class="bound">tmp</span><span class="main">)</span><span class="main">;</span>
            the <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">lt</span><span class="main">)</span> R <span class="main">(</span>key <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>lsub <span class="bound">tmt</span><span class="main">)</span><span class="main">;</span>
            the <span class="free"><span class="bound"><span class="entity">rp</span></span></span> <span class="main">:=</span> Node <span class="main">(</span>rsub <span class="bound">tmt</span><span class="main">)</span> R <span class="main">(</span>key <span class="bound">rt</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">rt</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">rt</span><span class="main">)</span><span class="main">;</span>
            the <span class="bound">tmp</span> <span class="main">:=</span> Node <span class="free"><span class="bound"><span class="entity">lp</span></span></span> R <span class="main">(</span>key <span class="bound">tmt</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">tmt</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rp</span></span></span><span class="main">;</span>
            return <span class="bound">tmp</span><span class="main">}</span>
          <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
            the <span class="free"><span class="bound"><span class="entity">rp</span></span></span> <span class="main">:=</span> Node <span class="bound">tmp</span> R <span class="main">(</span>key <span class="bound">rt</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">rt</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">rt</span><span class="main">)</span><span class="main">;</span>
            the <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">lt</span><span class="main">)</span> R <span class="main">(</span>key <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">lt</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rp</span></span></span><span class="main">;</span>
            return <span class="free"><span class="bound"><span class="entity">lp</span></span></span><span class="main">}</span><span class="main">}</span>
        <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">tmp</span> <span class="main">←</span> <span class="free">btree_combine</span> <span class="main">(</span>rsub <span class="bound">lt</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rp</span></span></span><span class="main">;</span>
          the <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">lt</span><span class="main">)</span> R <span class="main">(</span>key <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">lt</span><span class="main">)</span> <span class="bound">tmp</span><span class="main">;</span>
          return <span class="free"><span class="bound"><span class="entity">lp</span></span></span><span class="main">}</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> cl <span class="bound">rt</span> <span class="main">=</span> B <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">tmp</span> <span class="main">←</span> <span class="free">btree_combine</span> <span class="main">(</span>rsub <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>lsub <span class="bound">rt</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">cl_tm</span> <span class="main">←</span> get_color <span class="bound">tmp</span><span class="main">;</span>
        <span class="keyword1">if</span> <span class="bound">cl_tm</span> <span class="main">=</span> R <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">tmt</span> <span class="main">←</span> <span class="main">!</span><span class="main">(</span>the <span class="bound">tmp</span><span class="main">)</span><span class="main">;</span>
          the <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">lt</span><span class="main">)</span> B <span class="main">(</span>key <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>lsub <span class="bound">tmt</span><span class="main">)</span><span class="main">;</span>
          the <span class="free"><span class="bound"><span class="entity">rp</span></span></span> <span class="main">:=</span> Node <span class="main">(</span>rsub <span class="bound">tmt</span><span class="main">)</span> B <span class="main">(</span>key <span class="bound">rt</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">rt</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">rt</span><span class="main">)</span><span class="main">;</span>
          the <span class="bound">tmp</span> <span class="main">:=</span> Node <span class="free"><span class="bound"><span class="entity">lp</span></span></span> R <span class="main">(</span>key <span class="bound">tmt</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">tmt</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rp</span></span></span><span class="main">;</span>
          return <span class="bound">tmp</span><span class="main">}</span>
        <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
          the <span class="free"><span class="bound"><span class="entity">rp</span></span></span> <span class="main">:=</span> Node <span class="bound">tmp</span> B <span class="main">(</span>key <span class="bound">rt</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">rt</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">rt</span><span class="main">)</span><span class="main">;</span>
          the <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">lt</span><span class="main">)</span> R <span class="main">(</span>key <span class="bound">lt</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">lt</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rp</span></span></span><span class="main">;</span>
          btree_balL <span class="free"><span class="bound"><span class="entity">lp</span></span></span><span class="main">}</span><span class="main">}</span>
      <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">tmp</span> <span class="main">←</span> <span class="free">btree_combine</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="main">(</span>lsub <span class="bound">rt</span><span class="main">)</span><span class="main">;</span>
        the <span class="free"><span class="bound"><span class="entity">rp</span></span></span> <span class="main">:=</span> Node <span class="bound">tmp</span> R <span class="main">(</span>key <span class="bound">rt</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">rt</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">rt</span><span class="main">)</span><span class="main">;</span>
        return <span class="free"><span class="bound"><span class="entity">rp</span></span></span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="RBTree_Impl-combine_to_fun"><span class="command">lemma</span></span> combine_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="free">lt</span> <span class="free">lp</span> <span class="main">*</span> btree <span class="free">rt</span> <span class="free">rp</span><span class="main">&gt;</span>
   btree_combine <span class="free">lp</span> <span class="free">rp</span>
   <span class="main">&lt;</span>btree <span class="main">(</span>combine <span class="free">lt</span> <span class="free">rt</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"combine <span class="free">lt</span> <span class="free">rt</span>"</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">lp</span></span> <span class="quoted"><span class="free">rp</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">lt</span> <span class="main">=</span> rbt.Node <span class="free">l1</span> <span class="free">c1</span> <span class="free">k1</span> <span class="free">v1</span> <span class="free">r1</span><span class="main">,</span> <span class="free">rt</span> <span class="main">=</span> rbt.Node <span class="free">l2</span> <span class="free">c2</span> <span class="free">k2</span> <span class="free">v2</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"combine <span class="main">(</span>rbt.Node <span class="free">l1</span> <span class="free">c1</span> <span class="free">k1</span> <span class="free">v1</span> <span class="free">r1</span><span class="main">)</span> <span class="main">(</span>rbt.Node <span class="free">l2</span> <span class="free">c2</span> <span class="free">k2</span> <span class="free">v2</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">rbt_del</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> return None
   <span class="main">|</span> Some <span class="bound">pp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">pp</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> key <span class="bound">t</span> <span class="keyword1">then</span> btree_combine <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> key <span class="bound">t</span> <span class="keyword1">then</span> <span class="keyword1">case</span> lsub <span class="bound">t</span> <span class="keyword1">of</span>
         None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
           set_color R <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
           return <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>
       <span class="main">|</span> Some <span class="bound">lp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">lt</span> <span class="main">←</span> <span class="main">!</span><span class="bound">lp</span><span class="main">;</span>
           <span class="keyword1">if</span> cl <span class="bound">lt</span> <span class="main">=</span> B <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
             <span class="bound">q</span> <span class="main">←</span> <span class="free">rbt_del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
             <span class="bound">pp</span> <span class="main">:=</span> Node <span class="bound">q</span> R <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
             btree_balL <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">}</span>
           <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
             <span class="bound">q</span> <span class="main">←</span> <span class="free">rbt_del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
             <span class="bound">pp</span> <span class="main">:=</span> Node <span class="bound">q</span> R <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
             return <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">}</span><span class="main">}</span>
       <span class="keyword1">else</span> <span class="keyword1">case</span> rsub <span class="bound">t</span> <span class="keyword1">of</span>
         None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
           set_color R <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
           return <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>
       <span class="main">|</span> Some <span class="bound">rp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">rt</span> <span class="main">←</span> <span class="main">!</span><span class="bound">rp</span><span class="main">;</span>
           <span class="keyword1">if</span> cl <span class="bound">rt</span> <span class="main">=</span> B <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
             <span class="bound">q</span> <span class="main">←</span> <span class="free">rbt_del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
             <span class="bound">pp</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> R <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="bound">q</span><span class="main">;</span>
             btree_balR <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">}</span>
           <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
             <span class="bound">q</span> <span class="main">←</span> <span class="free">rbt_del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
             <span class="bound">pp</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> R <span class="main">(</span>key <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="bound">q</span><span class="main">;</span>
             return <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="RBTree_Impl-rbt_del_to_fun"><span class="command">lemma</span></span> rbt_del_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="free">t</span> <span class="free">p</span><span class="main">&gt;</span>
   rbt_del <span class="free">x</span> <span class="free">p</span>
   <span class="main">&lt;</span>btree <span class="main">(</span>del <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">p</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> rbt.Node <span class="free">l</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"del <span class="free">x</span> <span class="main">(</span>rbt.Node <span class="free">l</span> <span class="free">c</span> <span class="free">k</span> <span class="free">v</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rbt_delete</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> btree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> btree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_delete</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">p'</span> <span class="main">←</span> rbt_del <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
    paint B <span class="bound">p'</span><span class="main">;</span>
    return <span class="bound">p'</span><span class="main">}</span>"</span></span>
  
<span class="keyword1" id="RBTree_Impl-rbt_delete_to_fun"><span class="command">lemma</span></span> rbt_delete_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>btree <span class="free">t</span> <span class="free">p</span><span class="main">&gt;</span>
   rbt_delete <span class="free">k</span> <span class="free">p</span>
   <span class="main">&lt;</span>btree <span class="main">(</span>RBTree.delete <span class="free">k</span> <span class="free">t</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Outer interface›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Express Hoare triples for operations on red-black tree in terms of
  the mapping represented by the tree.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rbt_map_assn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> map <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>heap<span class="main">)</span> rbt_node ref option <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_map_assn</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">t</span><span class="main">.</span> btree <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>is_rbt <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>rbt_sorted <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> rbt_map <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_ent_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> rbt_map_assn_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">theorem</span></span> rbt_empty_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> tree_empty <span class="main">&lt;</span>rbt_map_assn empty_map<span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> rbt_insert_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>rbt_map_assn <span class="free">M</span> <span class="free">b</span><span class="main">&gt;</span> rbt_insert <span class="free">k</span> <span class="free">v</span> <span class="free">b</span> <span class="main">&lt;</span>rbt_map_assn <span class="main">(</span><span class="free">M</span> <span class="main">{</span><span class="free">k</span> <span class="main">→</span> <span class="free">v</span><span class="main">}</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> rbt_search <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>rbt_map_assn <span class="free">M</span> <span class="free">b</span><span class="main">&gt;</span> rbt_search <span class="free">x</span> <span class="free">b</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> rbt_map_assn <span class="free">M</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">M</span><span class="main">⟨</span><span class="free">x</span><span class="main">⟩</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> rbt_delete_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>rbt_map_assn <span class="free">M</span> <span class="free">b</span><span class="main">&gt;</span> rbt_delete <span class="free">k</span> <span class="free">b</span> <span class="main">&lt;</span>rbt_map_assn <span class="main">(</span>delete_map <span class="free">k</span> <span class="free">M</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Arrays_Impl">
<div class="head">
<h1>Theory Arrays_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Arrays_Impl.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation of arrays›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Arrays_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="SepAuto.html">SepAuto</a> <span class="quoted">"<a href="Arrays_Ex.html">../Functional/Arrays_Ex</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Imperative implementations of common array operations.

  Imperative reverse on arrays is also verified in theory Imperative\_Reverse
  in Imperative\_HOL/ex in the Isabelle library.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Array copy›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">array_copy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap array <span class="main">⇒</span> <span class="tfree">'a</span> array <span class="main">⇒</span> nat <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">array_copy</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span>return <span class="main">()</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">array_copy</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="free">array_copy</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span>
      <span class="bound">x</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span>
      Array.upd <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span>
      return <span class="main">()</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Arrays_Impl-array_copy_rule"><span class="command">lemma</span></span> array_copy_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">as</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≤</span> length <span class="free">bs</span> <span class="main">⟹</span>
   <span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">as</span> <span class="main">*</span> <span class="free">b</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">bs</span><span class="main">&gt;</span>
    array_copy <span class="free">a</span> <span class="free">b</span> <span class="free">n</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">as</span> <span class="main">*</span> <span class="free">b</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> Arrays_Ex.array_copy <span class="free">as</span> <span class="free">bs</span> <span class="free">n</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Swap›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">swap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap array <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">swap</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">x</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
     <span class="bound">y</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">;</span>
     Array.upd <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
     Array.upd <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
     return <span class="main">()</span>
   <span class="main">}</span>"</span></span>

<span class="keyword1" id="Arrays_Impl-swap_rule"><span class="command">lemma</span></span> swap_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span>
   <span class="main">&lt;</span><span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span><span class="main">&gt;</span>
   swap <span class="free">p</span> <span class="free">i</span> <span class="free">j</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> list_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reverse›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap array <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rev</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
     swap <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">;</span>
     <span class="free">rev</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
   <span class="main">}</span>
   <span class="keyword1">else</span> return <span class="main">()</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Arrays_Impl-rev_to_fun"><span class="command">lemma</span></span> rev_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span>
   <span class="main">&lt;</span><span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span><span class="main">&gt;</span>
   rev <span class="free">p</span> <span class="free">i</span> <span class="free">j</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> rev_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"rev_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"rev_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of imperative reverse.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> rev_is_rev <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
   <span class="main">&lt;</span><span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span><span class="main">&gt;</span>
   rev <span class="free">p</span> <span class="main">0</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> List.rev <span class="free">xs</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Quicksort_Impl">
<div class="head">
<h1>Theory Quicksort_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Quicksort_Impl.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation of quicksort›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Quicksort_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Arrays_Impl.html">Arrays_Impl</a> <span class="quoted">"<a href="Quicksort.html">../Functional/Quicksort</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Imperative implementation of quicksort. Also verified in
  theory Imperative\_Quicksort in HOL/Imperative\_HOL/ex
  in the Isabelle library.
›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">part1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> array <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">part1</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> return <span class="free"><span class="bound"><span class="entity">r</span></span></span>
     <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">v</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span>
       <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span>
         <span class="free">part1</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
       <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
         swap <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
         <span class="free">part1</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Quicksort_Impl-part1_to_fun"><span class="command">lemma</span></span> part1_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">&lt;</span><span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span><span class="main">&gt;</span>
   part1 <span class="free">p</span> <span class="free">l</span> <span class="free">r</span> <span class="free">a</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">rs</span><span class="main">.</span> <span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> snd <span class="main">(</span>Quicksort.part1 <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="free">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">rs</span> <span class="main">=</span> fst <span class="main">(</span>Quicksort.part1 <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"Quicksort.part1 <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"Quicksort.part1 <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Partition function›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> array <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">partition</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">p</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
     <span class="bound">m</span> <span class="main">←</span> part1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">p</span><span class="main">;</span>
     <span class="bound">v</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">m</span><span class="main">;</span>
     <span class="bound">m'</span> <span class="main">←</span> return <span class="main">(</span><span class="keyword1">if</span> <span class="bound">v</span> <span class="main">≤</span> <span class="bound">p</span> <span class="keyword1">then</span> <span class="bound">m</span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="bound">m</span><span class="main">)</span><span class="main">;</span>
     swap <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">m'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
     return <span class="bound">m'</span>
   <span class="main">}</span>"</span></span>

<span class="keyword1" id="Quicksort_Impl-partition_to_fun"><span class="command">lemma</span></span> partition_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span><span class="main">&gt;</span>
   partition <span class="free">a</span> <span class="free">l</span> <span class="free">r</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">rs</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> snd <span class="main">(</span>Quicksort.partition <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">rs</span> <span class="main">=</span> fst <span class="main">(</span>Quicksort.partition <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"Quicksort.partition <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Quicksort function›</span></span>
<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">quicksort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> array <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">quicksort</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">len</span> <span class="main">←</span> Array.len <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> return <span class="main">()</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&lt;</span> <span class="bound">len</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">p</span> <span class="main">←</span> partition <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
       <span class="free">quicksort</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
       <span class="free">quicksort</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="bound">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
     <span class="main">}</span>
     <span class="keyword1">else</span> return <span class="main">()</span>
   <span class="main">}</span>"</span></span>

<span class="keyword1" id="Quicksort_Impl-quicksort_to_fun"><span class="command">lemma</span></span> quicksort_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span><span class="main">&gt;</span>
   quicksort <span class="free">a</span> <span class="free">l</span> <span class="free">r</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> Quicksort.quicksort <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"Quicksort.quicksort <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"Quicksort.quicksort <span class="free">xs</span> <span class="free">l</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">quicksort_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> array <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">quicksort_all</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">n</span> <span class="main">←</span> Array.len <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
     <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> return <span class="main">()</span>
     <span class="keyword1">else</span> quicksort <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">0</span> <span class="main">(</span><span class="bound">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
   <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of quicksort.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> quicksort_sorts_basic <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span><span class="main">&gt;</span>
   quicksort_all <span class="free">a</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> sort <span class="free">xs</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Union_Find_Impl">
<div class="head">
<h1>Theory Union_Find_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Union_Find_Impl.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation of union find›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Union_Find_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="SepAuto.html">SepAuto</a> <span class="quoted">"<a href="Union_Find.html">../Functional/Union_Find</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Development follows theory Union\_Find in
  \cite{Separation_Logic_Imperative_HOL-AFP} by Lammich and Meis.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> uf <span class="main">=</span> <span class="quoted"><span class="quoted">"nat array <span class="main">×</span> nat array"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_uf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat<span class="main">×</span>nat<span class="main">)</span> set <span class="main">⇒</span> uf <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite_ent</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_uf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">l</span> <span class="bound">szl</span><span class="main">.</span> snd <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="bound">l</span> <span class="main">*</span> fst <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="bound">szl</span> <span class="main">*</span>
        <span class="main">↑</span><span class="main">(</span>ufa_invar <span class="bound">l</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>ufa_α <span class="bound">l</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>length <span class="bound">l</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>length <span class="bound">szl</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uf_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> uf Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">uf_init</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">l</span> <span class="main">←</span> Array.of_list <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">;</span>
     <span class="bound">szl</span> <span class="main">←</span> Array.new <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">;</span>
     return <span class="main">(</span><span class="bound">szl</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span>
   <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of uf\_init.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> uf_init_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> uf_init <span class="free">n</span> <span class="main">&lt;</span>is_uf <span class="free">n</span> <span class="main">(</span>uf_init_rel <span class="free">n</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
  
<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">uf_rep_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat array <span class="main">⇒</span> nat <span class="main">⇒</span> nat Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">uf_rep_of</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">n</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
     <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> return <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> <span class="free">uf_rep_of</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">n</span>
   <span class="main">}</span>"</span></span>
  
<span class="keyword1" id="Union_Find_Impl-uf_rep_of_rule"><span class="command">lemma</span></span> uf_rep_of_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span>
   <span class="main">&lt;</span><span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">l</span><span class="main">&gt;</span>
   uf_rep_of <span class="free">p</span> <span class="free">i</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">l</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> rep_of <span class="free">l</span> <span class="free">i</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@prop_induct</span></span> <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">uf_compress</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat array <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">uf_compress</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ci</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ci</span></span></span> <span class="keyword1">then</span> return <span class="main">()</span>
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">ni</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
      <span class="free">uf_compress</span> <span class="bound">ni</span> <span class="free"><span class="bound"><span class="entity">ci</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
      Array.upd <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ci</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
      return <span class="main">()</span>
    <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Union_Find_Impl-uf_compress_rule"><span class="command">lemma</span></span> uf_compress_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span>
   <span class="main">&lt;</span><span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">l</span><span class="main">&gt;</span>
    uf_compress <span class="free">i</span> <span class="main">(</span>rep_of <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">l'</span><span class="main">.</span> <span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="bound">l'</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>ufa_invar <span class="bound">l'</span> <span class="main">∧</span> length <span class="bound">l'</span> <span class="main">=</span> length <span class="free">l</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">l</span><span class="main">.</span> rep_of <span class="bound">l'</span> <span class="bound">i</span> <span class="main">=</span> rep_of <span class="free">l</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@prop_induct</span></span> <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uf_rep_of_c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat array <span class="main">⇒</span> nat <span class="main">⇒</span> nat Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">uf_rep_of_c</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">ci</span> <span class="main">←</span> uf_rep_of <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
    uf_compress <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">ci</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
    return <span class="bound">ci</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Union_Find_Impl-uf_rep_of_c_rule"><span class="command">lemma</span></span> uf_rep_of_c_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ufa_invar <span class="free">l</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span>
   <span class="main">&lt;</span><span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">l</span><span class="main">&gt;</span>
   uf_rep_of_c <span class="free">p</span> <span class="free">i</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">l'</span><span class="main">.</span> <span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="bound">l'</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> rep_of <span class="free">l</span> <span class="free">i</span> <span class="main">∧</span> ufa_invar <span class="bound">l'</span> <span class="main">∧</span> length <span class="bound">l'</span> <span class="main">=</span> length <span class="free">l</span> <span class="main">∧</span>
                          <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">l</span><span class="main">.</span> rep_of <span class="bound">l'</span> <span class="bound">i</span> <span class="main">=</span> rep_of <span class="free">l</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uf_cmp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"uf <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">uf_cmp</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">n</span> <span class="main">←</span> Array.len <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">≥</span><span class="bound">n</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">≥</span><span class="bound">n</span><span class="main">)</span> <span class="keyword1">then</span> return False
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">ci</span> <span class="main">←</span> uf_rep_of_c <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
      <span class="bound">cj</span> <span class="main">←</span> uf_rep_of_c <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">;</span>
      return <span class="main">(</span><span class="bound">ci</span> <span class="main">=</span> <span class="bound">cj</span><span class="main">)</span>
    <span class="main">}</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of compare.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> uf_cmp_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>is_uf <span class="free">n</span> <span class="free">R</span> <span class="free">u</span><span class="main">&gt;</span>
   uf_cmp <span class="free">u</span> <span class="free">i</span> <span class="free">j</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> is_uf <span class="free">n</span> <span class="free">R</span> <span class="free">u</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uf_union</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"uf <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> uf Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">uf_union</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">ci</span> <span class="main">←</span> uf_rep_of <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
    <span class="bound">cj</span> <span class="main">←</span> uf_rep_of <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="main">(</span><span class="bound">ci</span> <span class="main">=</span> <span class="bound">cj</span><span class="main">)</span> <span class="keyword1">then</span> return <span class="free"><span class="bound"><span class="entity">u</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">si</span> <span class="main">←</span> Array.nth <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="bound">ci</span><span class="main">;</span>
      <span class="bound">sj</span> <span class="main">←</span> Array.nth <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="bound">cj</span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="bound">si</span> <span class="main">&lt;</span> <span class="bound">sj</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
        Array.upd <span class="bound">ci</span> <span class="bound">cj</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">;</span>
        Array.upd <span class="bound">cj</span> <span class="main">(</span><span class="bound">si</span><span class="main">+</span><span class="bound">sj</span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">;</span>
        return <span class="free"><span class="bound"><span class="entity">u</span></span></span>
      <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span> 
        Array.upd <span class="bound">cj</span> <span class="bound">ci</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">;</span>
        Array.upd <span class="bound">ci</span> <span class="main">(</span><span class="bound">si</span><span class="main">+</span><span class="bound">sj</span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">;</span>
        return <span class="free"><span class="bound"><span class="entity">u</span></span></span>
      <span class="main">}</span>
    <span class="main">}</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of union.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> uf_union_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>is_uf <span class="free">n</span> <span class="free">R</span> <span class="free">u</span><span class="main">&gt;</span>
   uf_union <span class="free">u</span> <span class="free">i</span> <span class="free">j</span>
   <span class="main">&lt;</span>is_uf <span class="free">n</span> <span class="main">(</span>per_union <span class="free">R</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> is_uf_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Connectivity_Impl">
<div class="head">
<h1>Theory Connectivity_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Connectivity_Impl.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation of connectivity on graphs›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Connectivity_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Union_Find_Impl.html">Union_Find_Impl</a> <span class="quoted">"<a href="Connectivity.html">../Functional/Connectivity</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Imperative version of graph-connectivity example.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Constructing the connected relation›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">connected_rel_imp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> uf Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">connected_rel_imp</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">p</span> <span class="main">←</span> uf_init <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span> return <span class="bound">p</span> <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">connected_rel_imp</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">p</span> <span class="main">←</span> <span class="free">connected_rel_imp</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span>
    <span class="bound">p'</span> <span class="main">←</span> uf_union <span class="bound">p</span> <span class="main">(</span>fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    return <span class="bound">p'</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Connectivity_Impl-connected_rel_imp_to_fun"><span class="command">lemma</span></span> connected_rel_imp_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_valid_graph <span class="free">n</span> <span class="main">(</span>set <span class="free">es</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≤</span> length <span class="free">es</span> <span class="main">⟹</span>
   <span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span>
   connected_rel_imp <span class="free">n</span> <span class="free">es</span> <span class="free">k</span>
   <span class="main">&lt;</span>is_uf <span class="free">n</span> <span class="main">(</span>connected_rel_ind <span class="free">n</span> <span class="free">es</span> <span class="free">k</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">k</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Connectivity_Impl-connected_rel_imp_correct"><span class="command">lemma</span></span> connected_rel_imp_correct <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_valid_graph <span class="free">n</span> <span class="main">(</span>set <span class="free">es</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span>
   connected_rel_imp <span class="free">n</span> <span class="free">es</span> <span class="main">(</span>length <span class="free">es</span><span class="main">)</span>
   <span class="main">&lt;</span>is_uf <span class="free">n</span> <span class="main">(</span>connected_rel <span class="free">n</span> <span class="main">(</span>set <span class="free">es</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Connectedness tests›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of the algorithm for detecting connectivity.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> uf_cmp_correct <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>is_uf <span class="free">n</span> <span class="main">(</span>connected_rel <span class="free">n</span> <span class="free">S</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   uf_cmp <span class="free">p</span> <span class="free">i</span> <span class="free">j</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> is_uf <span class="free">n</span> <span class="main">(</span>connected_rel <span class="free">n</span> <span class="free">S</span><span class="main">)</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> has_path <span class="free">n</span> <span class="free">S</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DynamicArray">
<div class="head">
<h1>Theory DynamicArray</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: DynamicArray.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation of dynamic arrays›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DynamicArray
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Arrays_Impl.html">Arrays_Impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Dynamically allocated arrays.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> dynamic_array <span class="main">=</span> Dyn_Array <span class="main">(</span><span class="free"><span class="entity">alen</span></span><span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">aref</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> array"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_simple_datatype</span> <span class="inner_quoted">"dynamic_array"</span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Raw assertion›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dyn_array_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap list <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> dynamic_array <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dyn_array_raw</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Dyn_Array <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_ent_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> dyn_array_raw.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dyn_array_new</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap dynamic_array Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dyn_array_new</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">p</span> <span class="main">←</span> Array.new <span class="numeral">5</span> undefined<span class="main">;</span>
     return <span class="main">(</span>Dyn_Array <span class="main">0</span> <span class="bound">p</span><span class="main">)</span>
   <span class="main">}</span>"</span></span>

<span class="keyword1" id="DynamicArray-dyn_array_new_rule'"><span class="command">lemma</span></span> dyn_array_new_rule' <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span>
   dyn_array_new
   <span class="main">&lt;</span>dyn_array_raw <span class="main">(</span>replicate <span class="numeral">5</span> undefined<span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">double_length</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap dynamic_array <span class="main">⇒</span> <span class="tfree">'a</span> dynamic_array Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">double_length</span> <span class="main">(</span>Dyn_Array <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">am</span> <span class="main">←</span> Array.len <span class="free"><span class="bound"><span class="entity">ar</span></span></span><span class="main">;</span>
      <span class="bound">p</span> <span class="main">←</span> Array.new <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">am</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> undefined<span class="main">;</span>
      array_copy <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="bound">p</span> <span class="bound">am</span><span class="main">;</span>
      return <span class="main">(</span>Dyn_Array <span class="bound">am</span> <span class="bound">p</span><span class="main">)</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">double_length_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap list <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">double_length_fun</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>Arrays_Ex.array_copy <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span>replicate <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> undefined<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> double_length_fun.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="DynamicArray-double_length_rule'"><span class="command">lemma</span></span> double_length_rule' <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>dyn_array_raw <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   double_length <span class="free">p</span>
   <span class="main">&lt;</span>dyn_array_raw <span class="main">(</span>double_length_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">push_array_basic</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>heap dynamic_array <span class="main">⇒</span> <span class="tfree">'a</span> dynamic_array Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">push_array_basic</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Dyn_Array <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    Array.upd <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span><span class="main">;</span>
    return <span class="main">(</span>Dyn_Array <span class="main">(</span><span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span><span class="main">)</span>
   <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">push_array_basic_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>heap list <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">push_array_basic_fun</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>list_update <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> push_array_basic_fun.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="DynamicArray-push_array_basic_rule'"><span class="command">lemma</span></span> push_array_basic_rule' <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>dyn_array_raw <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   push_array_basic <span class="free">x</span> <span class="free">p</span>
   <span class="main">&lt;</span>dyn_array_raw <span class="main">(</span>push_array_basic_fun <span class="free">x</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">array_length</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dynamic_array <span class="main">⇒</span> nat Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">array_length</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> return <span class="main">(</span>alen <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DynamicArray-array_length_rule'"><span class="command">lemma</span></span> array_length_rule' <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>dyn_array_raw <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   array_length <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> dyn_array_raw <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">array_max</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap dynamic_array <span class="main">⇒</span> nat Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">array_max</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> Array.len <span class="main">(</span>aref <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DynamicArray-array_max_rule'"><span class="command">lemma</span></span> array_max_rule' <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>dyn_array_raw <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   array_max <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> dyn_array_raw <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> length <span class="free">xs</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">array_nth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap dynamic_array <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">array_nth</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Array.nth <span class="main">(</span>aref <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1" id="DynamicArray-array_nth_rule'"><span class="command">lemma</span></span> array_nth_rule' <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>dyn_array_raw <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   array_nth <span class="free">p</span> <span class="free">i</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> dyn_array_raw <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">array_upd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>heap dynamic_array <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">array_upd</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> Array.upd <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>aref <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">;</span> return <span class="main">()</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="DynamicArray-array_upd_rule'"><span class="command">lemma</span></span> array_upd_rule' <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>dyn_array_raw <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   array_upd <span class="free">i</span> <span class="free">x</span> <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> dyn_array_raw <span class="main">(</span>list_update <span class="free">xs</span> <span class="free">i</span> <span class="free">x</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">push_array</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>heap dynamic_array <span class="main">⇒</span> <span class="tfree">'a</span> dynamic_array Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">push_array</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">m</span> <span class="main">←</span> array_max <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
    <span class="bound">l</span> <span class="main">←</span> array_length <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="keyword1">then</span> push_array_basic <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">u</span> <span class="main">←</span> double_length <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
      push_array_basic <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">u</span>
    <span class="main">}</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pop_array</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap dynamic_array <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> dynamic_array<span class="main">)</span> Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pop_array</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">x</span> <span class="main">←</span> Array.nth <span class="main">(</span>aref <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">(</span>alen <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
    return <span class="main">(</span><span class="bound">x</span><span class="main">,</span> Dyn_Array <span class="main">(</span>alen <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>aref <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">)</span>
   <span class="main">}</span>"</span></span>

<span class="keyword1" id="DynamicArray-pop_array_rule'"><span class="command">lemma</span></span> pop_array_rule' <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>dyn_array_raw <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   pop_array <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> dyn_array_raw <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> dyn_array_raw.simps<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_simple_datatype</span> <span class="inner_quoted">"dynamic_array"</span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">push_array_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>heap list <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">push_array_fun</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span> push_array_basic_fun <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> push_array_basic_fun <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>double_length_fun <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> push_array_fun.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="DynamicArray-push_array_rule'"><span class="command">lemma</span></span> push_array_rule' <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>dyn_array_raw <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   push_array <span class="free">x</span> <span class="free">p</span>
   <span class="main">&lt;</span>dyn_array_raw <span class="main">(</span>push_array_fun <span class="free">x</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Abstract assertion›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">abs_array</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap list <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">abs_array</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> take <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> abs_array.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="DynamicArray-double_length_abs"><span class="command">lemma</span></span> double_length_abs <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> abs_array <span class="main">(</span>double_length_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> abs_array <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="DynamicArray-push_array_basic_abs"><span class="command">lemma</span></span> push_array_basic_abs <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> abs_array <span class="main">(</span>push_array_basic_fun <span class="free">x</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> abs_array <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="DynamicArray-push_array_fun_abs"><span class="command">lemma</span></span> push_array_fun_abs <span class="main">[</span><span class="operator">rewrite</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> abs_array <span class="main">(</span>push_array_fun <span class="free">x</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> abs_array <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dyn_array</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap list <span class="main">⇒</span> <span class="tfree">'a</span> dynamic_array <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">rewrite_ent</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">dyn_array</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">p</span><span class="main">.</span> dyn_array_raw <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> abs_array <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>snd <span class="bound">p</span> <span class="main">≤</span> length <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DynamicArray-dyn_array_new_rule"><span class="command">lemma</span></span> dyn_array_new_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> dyn_array_new <span class="main">&lt;</span>dyn_array <span class="main">[]</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="DynamicArray-array_length_rule"><span class="command">lemma</span></span> array_length_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>dyn_array <span class="free">xs</span> <span class="free">p</span><span class="main">&gt;</span>
   array_length <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> dyn_array <span class="free">xs</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> length <span class="free">xs</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="DynamicArray-array_nth_rule"><span class="command">lemma</span></span> array_nth_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>dyn_array <span class="free">xs</span> <span class="free">p</span><span class="main">&gt;</span>
    array_nth <span class="free">p</span> <span class="free">i</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> dyn_array <span class="free">xs</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="DynamicArray-array_upd_rule"><span class="command">lemma</span></span> array_upd_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>dyn_array <span class="free">xs</span> <span class="free">p</span><span class="main">&gt;</span>
    array_upd <span class="free">i</span> <span class="free">x</span> <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> dyn_array <span class="main">(</span>list_update <span class="free">xs</span> <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="DynamicArray-push_array_rule"><span class="command">lemma</span></span> push_array_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>dyn_array <span class="free">xs</span> <span class="free">p</span><span class="main">&gt;</span>
    push_array <span class="free">x</span> <span class="free">p</span>
   <span class="main">&lt;</span>dyn_array <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="DynamicArray-pop_array_rule"><span class="command">lemma</span></span> pop_array_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>dyn_array <span class="free">xs</span> <span class="free">p</span><span class="main">&gt;</span>
   pop_array <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> dyn_array <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">x</span> <span class="main">=</span> last <span class="free">xs</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"last <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> dyn_array_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived operations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">array_swap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap dynamic_array <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">array_swap</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">x</span> <span class="main">←</span> array_nth <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
    <span class="bound">y</span> <span class="main">←</span> array_nth <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">;</span>
    array_upd <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">;</span>
    array_upd <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">;</span>
    return <span class="main">()</span>
   <span class="main">}</span>"</span></span>

<span class="keyword1" id="DynamicArray-array_swap_rule"><span class="command">lemma</span></span> array_swap_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>dyn_array <span class="free">xs</span> <span class="free">p</span><span class="main">&gt;</span>
   array_swap <span class="free">p</span> <span class="free">i</span> <span class="free">j</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> dyn_array <span class="main">(</span>list_swap <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Indexed_PQueue_Impl">
<div class="head">
<h1>Theory Indexed_PQueue_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Indexed_PQueue_Impl.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation of the indexed priority queue›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Indexed_PQueue_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="DynamicArray.html">DynamicArray</a> <span class="quoted">"<a href="Indexed_PQueue.html">../Functional/Indexed_PQueue</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Imperative implementation of indexed priority queue. The data structure
  is also verified in \cite{Refine_Imperative_HOL-AFP} by Peter Lammich.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> indexed_pqueue <span class="main">=</span>
  Indexed_PQueue <span class="main">(</span><span class="free"><span class="entity">pqueue</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> dynamic_array"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">index</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"nat option array"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_simple_datatype</span> <span class="inner_quoted">"indexed_pqueue"</span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">idx_pqueue</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap idx_pqueue <span class="main">⇒</span> <span class="tfree">'a</span> indexed_pqueue <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_pqueue</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>Indexed_PQueue <span class="free"><span class="bound"><span class="entity">pq</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dyn_array <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_ent_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> idx_pqueue.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic operations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">idx_pqueue_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>heap indexed_pqueue Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_pqueue_empty</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">pq</span> <span class="main">←</span> dyn_array_new<span class="main">;</span>
    <span class="bound">idx</span> <span class="main">←</span> Array.new <span class="free"><span class="bound"><span class="entity">k</span></span></span> None<span class="main">;</span>
    return <span class="main">(</span>Indexed_PQueue <span class="bound">pq</span> <span class="bound">idx</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue_Impl-idx_pqueue_empty_rule"><span class="command">lemma</span></span> idx_pqueue_empty_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span>
   idx_pqueue_empty <span class="free">n</span>
   <span class="main">&lt;</span>idx_pqueue <span class="main">(</span><span class="main">[]</span><span class="main">,</span> replicate <span class="free">n</span> None<span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">idx_pqueue_nth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap indexed_pqueue <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_pqueue_nth</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> array_nth <span class="main">(</span>pqueue <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1" id="Indexed_PQueue_Impl-idx_pqueue_nth_rule"><span class="command">lemma</span></span> idx_pqueue_nth_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>idx_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">)</span><span class="main">&gt;</span>
   idx_pqueue_nth <span class="free">p</span> <span class="free">i</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> idx_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">idx_nth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap indexed_pqueue <span class="main">⇒</span> nat <span class="main">⇒</span> nat option Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_nth</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Array.nth <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1" id="Indexed_PQueue_Impl-idx_nth_rule"><span class="command">lemma</span></span> idx_nth_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>idx_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> length <span class="free">m</span><span class="main">)</span><span class="main">&gt;</span>
   idx_nth <span class="free">p</span> <span class="free">i</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> idx_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">m</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">idx_pqueue_length</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> indexed_pqueue <span class="main">⇒</span> nat Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_pqueue_length</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> array_length <span class="main">(</span>pqueue <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue_Impl-idx_pqueue_length_rule"><span class="command">lemma</span></span> idx_pqueue_length_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>idx_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   idx_pqueue_length <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> idx_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> length <span class="free">xs</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">idx_pqueue_swap</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> indexed_pqueue <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_pqueue_swap</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">pr_i</span> <span class="main">←</span> array_nth <span class="main">(</span>pqueue <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
     <span class="bound">pr_j</span> <span class="main">←</span> array_nth <span class="main">(</span>pqueue <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">;</span>
     Array.upd <span class="main">(</span>fst <span class="bound">pr_i</span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span>
     Array.upd <span class="main">(</span>fst <span class="bound">pr_j</span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span>
     array_swap <span class="main">(</span>pqueue <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>
   <span class="main">}</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue_Impl-idx_pqueue_swap_rule"><span class="command">lemma</span></span> idx_pqueue_swap_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>idx_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   idx_pqueue_swap <span class="free">p</span> <span class="free">i</span> <span class="free">j</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> idx_pqueue <span class="main">(</span>idx_pqueue_swap_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"idx_pqueue_swap_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">idx_pqueue_push</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>heap <span class="main">⇒</span> <span class="tfree">'a</span> indexed_pqueue <span class="main">⇒</span> <span class="tfree">'a</span> indexed_pqueue Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_pqueue_push</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">len</span> <span class="main">←</span> array_length <span class="main">(</span>pqueue <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span>
     <span class="bound">d'</span> <span class="main">←</span> push_array <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>pqueue <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span>
     Array.upd <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Some <span class="bound">len</span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span>
     return <span class="main">(</span>Indexed_PQueue <span class="bound">d'</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>
   <span class="main">}</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue_Impl-idx_pqueue_push_rule"><span class="command">lemma</span></span> idx_pqueue_push_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">m</span> <span class="main">⟹</span> <span class="main">¬</span>has_key_alist <span class="free">xs</span> <span class="free">k</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>idx_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   idx_pqueue_push <span class="free">k</span> <span class="free">v</span> <span class="free">p</span>
   <span class="main">&lt;</span>idx_pqueue <span class="main">(</span>idx_pqueue_push_fun <span class="free">k</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"idx_pqueue_push_fun <span class="free">k</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">idx_pqueue_pop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap indexed_pqueue <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">×</span> <span class="tfree">'a</span> indexed_pqueue<span class="main">)</span> Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_pqueue_pop</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">d'</span><span class="main">)</span> <span class="main">←</span> pop_array <span class="main">(</span>pqueue <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span>
     Array.upd <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> None <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span>
     return <span class="main">(</span><span class="bound">x</span><span class="main">,</span> Indexed_PQueue <span class="bound">d'</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>
   <span class="main">}</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue_Impl-idx_pqueue_pop_rule"><span class="command">lemma</span></span> idx_pqueue_pop_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>idx_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   idx_pqueue_pop <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> idx_pqueue <span class="main">(</span>idx_pqueue_pop_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">x</span> <span class="main">=</span> last <span class="free">xs</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"idx_pqueue_pop_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">idx_pqueue_array_upd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>heap dynamic_array <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_pqueue_array_upd</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> array_upd <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span>

<span class="keyword1" id="Indexed_PQueue_Impl-array_upd_idx_pqueue_rule"><span class="command">lemma</span></span> array_upd_idx_pqueue_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>idx_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   idx_pqueue_array_upd <span class="free">i</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>pqueue <span class="free">p</span><span class="main">)</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> idx_pqueue <span class="main">(</span>list_update <span class="free">xs</span> <span class="free">i</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_key_idx_pqueue</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> indexed_pqueue <span class="main">⇒</span> bool Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">has_key_idx_pqueue</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">i_opt</span> <span class="main">←</span> Array.nth <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span>
    return <span class="main">(</span><span class="bound">i_opt</span> <span class="main">≠</span> None<span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue_Impl-has_key_idx_pqueue_rule"><span class="command">lemma</span></span> has_key_idx_pqueue_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">m</span> <span class="main">⟹</span> index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>idx_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   has_key_idx_pqueue <span class="free">k</span> <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> idx_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> has_key_alist <span class="free">xs</span> <span class="free">k</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> idx_pqueue.simps<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_simple_datatype</span> <span class="inner_quoted">"indexed_pqueue"</span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bubble up and down›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">idx_bubble_down</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> indexed_pqueue <span class="main">⇒</span> nat <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_bubble_down</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">len</span> <span class="main">←</span> idx_pqueue_length <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">if</span> s2 <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="bound">len</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">vk</span> <span class="main">←</span> idx_pqueue_nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span>
      <span class="bound">vs1k</span> <span class="main">←</span> idx_pqueue_nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>s1 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">vs2k</span> <span class="main">←</span> idx_pqueue_nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>s2 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">if</span> snd <span class="bound">vs1k</span> <span class="main">≤</span> snd <span class="bound">vs2k</span> <span class="keyword1">then</span>
         <span class="keyword1">if</span> snd <span class="bound">vk</span> <span class="main">&gt;</span> snd <span class="bound">vs1k</span> <span class="keyword1">then</span>
           <span class="keyword1">do</span> <span class="main">{</span> idx_pqueue_swap <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>s1 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free">idx_bubble_down</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>s1 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">}</span>
         <span class="keyword1">else</span> return <span class="main">()</span>
       <span class="keyword1">else</span>
         <span class="keyword1">if</span> snd <span class="bound">vk</span> <span class="main">&gt;</span> snd <span class="bound">vs2k</span> <span class="keyword1">then</span>
           <span class="keyword1">do</span> <span class="main">{</span> idx_pqueue_swap <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>s2 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free">idx_bubble_down</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>s2 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">}</span>
         <span class="keyword1">else</span> return <span class="main">()</span><span class="main">)</span> <span class="main">}</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> s1 <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="bound">len</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">vk</span> <span class="main">←</span> idx_pqueue_nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span>
       <span class="bound">vs1k</span> <span class="main">←</span> idx_pqueue_nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>s1 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">if</span> snd <span class="bound">vk</span> <span class="main">&gt;</span> snd <span class="bound">vs1k</span> <span class="keyword1">then</span>
          <span class="keyword1">do</span> <span class="main">{</span> idx_pqueue_swap <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>s1 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free">idx_bubble_down</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>s1 <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">}</span>
        <span class="keyword1">else</span> return <span class="main">()</span><span class="main">)</span> <span class="main">}</span>
     <span class="keyword1">else</span> return <span class="main">()</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue_Impl-idx_bubble_down_rule"><span class="command">lemma</span></span> idx_bubble_down_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"index_of_pqueue <span class="free">x</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>idx_pqueue <span class="free">x</span> <span class="free">a</span><span class="main">&gt;</span>
   idx_bubble_down <span class="free">a</span> <span class="free">k</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> idx_pqueue <span class="main">(</span>idx_bubble_down_fun <span class="free">x</span> <span class="free">k</span><span class="main">)</span> <span class="free">a</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"idx_bubble_down_fun <span class="free">x</span> <span class="free">k</span>"</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span><span class="main">,</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"idx_bubble_down_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"s2 <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> s1 <span class="free">k</span><span class="main">)</span> <span class="main">≤</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> s2 <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"s1 <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">idx_bubble_up</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> indexed_pqueue <span class="main">⇒</span> nat <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_bubble_up</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> return <span class="main">()</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">len</span> <span class="main">←</span> idx_pqueue_length <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="bound">len</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">vk</span> <span class="main">←</span> idx_pqueue_nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span>
          <span class="bound">vpk</span> <span class="main">←</span> idx_pqueue_nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>par <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">;</span>
          <span class="main">(</span><span class="keyword1">if</span> snd <span class="bound">vk</span> <span class="main">&lt;</span> snd <span class="bound">vpk</span> <span class="keyword1">then</span>
             <span class="keyword1">do</span> <span class="main">{</span> idx_pqueue_swap <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>par <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free">idx_bubble_up</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>par <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">}</span>
           <span class="keyword1">else</span> return <span class="main">()</span><span class="main">)</span> <span class="main">}</span>
        <span class="keyword1">else</span> return <span class="main">()</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue_Impl-idx_bubble_up_rule"><span class="command">lemma</span></span> idx_bubble_up_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"index_of_pqueue <span class="free">x</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>idx_pqueue <span class="free">x</span> <span class="free">a</span><span class="main">&gt;</span>
   idx_bubble_up <span class="free">a</span> <span class="free">k</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> idx_pqueue <span class="main">(</span>idx_bubble_up_fun <span class="free">x</span> <span class="free">k</span><span class="main">)</span> <span class="free">a</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@fun_induct</span></span> <span class="quoted"><span class="quoted">"idx_bubble_up_fun <span class="free">x</span> <span class="free">k</span>"</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span><span class="main">,</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"idx_bubble_up_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Main operations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">delete_min_idx_pqueue</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> indexed_pqueue <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">×</span> <span class="tfree">'a</span> indexed_pqueue<span class="main">)</span> Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delete_min_idx_pqueue</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">len</span> <span class="main">←</span> idx_pqueue_length <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
     <span class="keyword1">if</span> <span class="bound">len</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> raise <span class="keyword1">STR</span> <span class="inner_quoted">''delete_min''</span>
     <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
       idx_pqueue_swap <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">0</span> <span class="main">(</span><span class="bound">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
       <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">←</span> idx_pqueue_pop <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
       idx_bubble_down <span class="bound">r</span> <span class="main">0</span><span class="main">;</span>
       return <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>
     <span class="main">}</span>
   <span class="main">}</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue_Impl-delete_min_idx_pqueue_rule"><span class="command">lemma</span></span> delete_min_idx_pqueue_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>idx_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   delete_min_idx_pqueue <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> idx_pqueue <span class="main">(</span>snd <span class="main">(</span>delete_min_idx_pqueue_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span> <span class="main">*</span>
       <span class="main">↑</span><span class="main">(</span><span class="bound">x</span> <span class="main">=</span> fst <span class="main">(</span>delete_min_idx_pqueue_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"delete_min_idx_pqueue_fun <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert_idx_pqueue</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'a</span> indexed_pqueue <span class="main">⇒</span> <span class="tfree">'a</span> indexed_pqueue Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_idx_pqueue</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">p'</span> <span class="main">←</span> idx_pqueue_push <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
     <span class="bound">len</span> <span class="main">←</span> idx_pqueue_length <span class="bound">p'</span><span class="main">;</span>
     idx_bubble_up <span class="bound">p'</span> <span class="main">(</span><span class="bound">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
     return <span class="bound">p'</span>
   <span class="main">}</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue_Impl-insert_idx_pqueue_rule"><span class="command">lemma</span></span> insert_idx_pqueue_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">m</span> <span class="main">⟹</span> <span class="main">¬</span>has_key_alist <span class="free">xs</span> <span class="free">k</span> <span class="main">⟹</span> index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>idx_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   insert_idx_pqueue <span class="free">k</span> <span class="free">v</span> <span class="free">p</span>
   <span class="main">&lt;</span>idx_pqueue <span class="main">(</span>insert_idx_pqueue_fun <span class="free">k</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"insert_idx_pqueue_fun <span class="free">k</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update_idx_pqueue</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'a</span> indexed_pqueue <span class="main">⇒</span> <span class="tfree">'a</span> indexed_pqueue Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_idx_pqueue</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">i_opt</span> <span class="main">←</span> idx_nth <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span>
    <span class="keyword1">case</span> <span class="bound">i_opt</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> insert_idx_pqueue <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
    <span class="main">|</span> Some <span class="bound">i</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">x</span> <span class="main">←</span> idx_pqueue_nth <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">i</span><span class="main">;</span>
      idx_pqueue_array_upd <span class="bound">i</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>pqueue <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">if</span> snd <span class="bound">x</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>idx_bubble_down <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">i</span><span class="main">;</span> return <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>
       <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>idx_bubble_up <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">i</span><span class="main">;</span> return <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">}</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Indexed_PQueue_Impl-update_idx_pqueue_rule"><span class="command">lemma</span></span> update_idx_pqueue_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">m</span> <span class="main">⟹</span> index_of_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>idx_pqueue <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="free">p</span><span class="main">&gt;</span>
   update_idx_pqueue <span class="free">k</span> <span class="free">v</span> <span class="free">p</span>
   <span class="main">&lt;</span>idx_pqueue <span class="main">(</span>update_idx_pqueue_fun <span class="free">k</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"update_idx_pqueue_fun <span class="free">k</span> <span class="free">v</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Outer interface›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Express Hoare triples for indexed priority queue operations in terms of
  the mapping represented by the queue.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">idx_pqueue_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat<span class="main">,</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heap<span class="main">,</span>linorder<span class="main">}</span><span class="main">)</span> map <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> indexed_pqueue <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_pqueue_map</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">xs</span> <span class="bound">m</span><span class="main">.</span> idx_pqueue <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">*</span>
      <span class="main">↑</span><span class="main">(</span>index_of_pqueue <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>is_heap <span class="bound">xs</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> map_of_alist <span class="bound">xs</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> length <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_ent_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> idx_pqueue_map_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="Indexed_PQueue_Impl-heap_implies_hd_min2"><span class="command">lemma</span></span> heap_implies_hd_min2 <span class="main">[</span><span class="operator">resolve</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_heap <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">(</span>map_of_alist <span class="free">xs</span><span class="main">)</span><span class="main">⟨</span><span class="free">k</span><span class="main">⟩</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> snd <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@obtain</span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> snd <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> idx_pqueue_empty_map <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span>
   idx_pqueue_empty <span class="free">n</span>
   <span class="main">&lt;</span>idx_pqueue_map empty_map <span class="free">n</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> delete_min_idx_pqueue_map <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>idx_pqueue_map <span class="free">M</span> <span class="free">n</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">M</span> <span class="main">≠</span> empty_map<span class="main">)</span><span class="main">&gt;</span>
   delete_min_idx_pqueue <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> idx_pqueue_map <span class="main">(</span>delete_map <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span> <span class="free">n</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>fst <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span>
                <span class="main">↑</span><span class="main">(</span>is_heap_min <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">M</span><span class="main">⟨</span>fst <span class="bound">x</span><span class="main">⟩</span> <span class="main">=</span> Some <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> insert_idx_pqueue_map <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">∉</span> keys_of <span class="free">M</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>idx_pqueue_map <span class="free">M</span> <span class="free">n</span> <span class="free">p</span><span class="main">&gt;</span>
   insert_idx_pqueue <span class="free">k</span> <span class="free">v</span> <span class="free">p</span>
   <span class="main">&lt;</span>idx_pqueue_map <span class="main">(</span><span class="free">M</span> <span class="main">{</span><span class="free">k</span> <span class="main">→</span> <span class="free">v</span><span class="main">}</span><span class="main">)</span> <span class="free">n</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> has_key_idx_pqueue_map <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>idx_pqueue_map <span class="free">M</span> <span class="free">n</span> <span class="free">p</span><span class="main">&gt;</span>
   has_key_idx_pqueue <span class="free">k</span> <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> idx_pqueue_map <span class="free">M</span> <span class="free">n</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> <span class="free">k</span> <span class="main">∈</span> keys_of <span class="free">M</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> update_idx_pqueue_map <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>idx_pqueue_map <span class="free">M</span> <span class="free">n</span> <span class="free">p</span><span class="main">&gt;</span>
   update_idx_pqueue <span class="free">k</span> <span class="free">v</span> <span class="free">p</span>
   <span class="main">&lt;</span>idx_pqueue_map <span class="main">(</span><span class="free">M</span> <span class="main">{</span><span class="free">k</span> <span class="main">→</span> <span class="free">v</span><span class="main">}</span><span class="main">)</span> <span class="free">n</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> idx_pqueue_map_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Dijkstra_Impl">
<div class="head">
<h1>Theory Dijkstra_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Dijkstra_Impl.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation of Dijkstra's algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Dijkstra_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Indexed_PQueue_Impl.html">Indexed_PQueue_Impl</a> <span class="quoted">"<a href="Dijkstra.html">../Functional/Dijkstra</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Imperative implementation of Dijkstra's shortest path algorithm. The
  algorithm is also verified by Nordhoff and Lammich in
  \cite{Dijkstra_Shortest_Path-AFP}.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> dijkstra_state <span class="main">=</span> Dijkstra_State <span class="main">(</span><span class="free"><span class="entity">est_a</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"nat array"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">heap_pq</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"nat indexed_pqueue"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_simple_datatype</span> <span class="inner_quoted">"dijkstra_state"</span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> dijkstra_state <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dstate</span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">(</span>Dijkstra_State <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">*</span> idx_pqueue_map <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_ent_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> dstate.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic operations›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dstate_pq_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat <span class="main">⇒</span> nat indexed_pqueue Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dstate_pq_init</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">0</span> <span class="main">=</span> idx_pqueue_empty <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dstate_pq_init</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">p</span> <span class="main">←</span> <span class="free">dstate_pq_init</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> update_idx_pqueue <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>weight <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="bound">p</span>
    <span class="keyword1">else</span> return <span class="bound">p</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Dijkstra_Impl-dstate_pq_init_to_fun"><span class="command">lemma</span></span> dstate_pq_init_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> size <span class="free">G</span> <span class="main">⟹</span>
   <span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span>
   dstate_pq_init <span class="free">G</span> <span class="free">k</span>
   <span class="main">&lt;</span>idx_pqueue_map <span class="main">(</span>map_constr <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> weight <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>size <span class="free">G</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">k</span></span> <span class="keyword1"><span class="command">@qed</span></span>
 
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dstate_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> dijkstra_state Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dstate_init</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">a</span> <span class="main">←</span> Array.of_list <span class="main">(</span>list <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> weight <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">0</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     <span class="bound">pq</span> <span class="main">←</span> dstate_pq_init <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">;</span>
     return <span class="main">(</span>Dijkstra_State <span class="bound">a</span> <span class="bound">pq</span><span class="main">)</span>
   <span class="main">}</span>"</span></span>

<span class="keyword1" id="Dijkstra_Impl-dstate_init_to_fun"><span class="command">lemma</span></span> dstate_init_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span>
   dstate_init <span class="free">G</span>
   <span class="main">&lt;</span>dstate <span class="main">(</span>dijkstra_start_state <span class="free">G</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dstate_update_est</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat indexed_pqueue <span class="main">⇒</span> nat array <span class="main">⇒</span> nat array Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dstate_update_est</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span>return <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dstate_update_est</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">b</span> <span class="main">←</span> has_key_idx_pqueue <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span><span class="main">;</span>
     <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">ek</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span>
       <span class="bound">em</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span>
       <span class="bound">a'</span> <span class="main">←</span> <span class="free">dstate_update_est</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
       <span class="bound">a''</span> <span class="main">←</span> Array.upd <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>min <span class="main">(</span><span class="bound">em</span> <span class="main">+</span> weight <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="bound">ek</span><span class="main">)</span> <span class="bound">a'</span><span class="main">;</span>
       return <span class="bound">a''</span> <span class="main">}</span>
     <span class="keyword1">else</span> <span class="free">dstate_update_est</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Dijkstra_Impl-dstate_update_est_ind"><span class="command">lemma</span></span> dstate_update_est_ind <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">e</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">&lt;</span> length <span class="free">e</span> <span class="main">⟹</span>
   <span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">e</span> <span class="main">*</span> idx_pqueue_map <span class="free">M</span> <span class="main">(</span>length <span class="free">e</span><span class="main">)</span> <span class="free">pq</span><span class="main">&gt;</span>
   dstate_update_est <span class="free">G</span> <span class="free">m</span> <span class="free">k</span> <span class="free">pq</span> <span class="free">a</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> dstate <span class="main">(</span>State <span class="main">(</span>list_update_set_impl <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> keys_of <span class="free">M</span><span class="main">)</span>
                      <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> min <span class="main">(</span><span class="free">e</span> <span class="main">!</span> <span class="free">m</span> <span class="main">+</span> weight <span class="free">G</span> <span class="free">m</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">e</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span> <span class="free">k</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>Dijkstra_State <span class="bound">r</span> <span class="free">pq</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">k</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Dijkstra_Impl-dstate_update_est_to_fun"><span class="command">lemma</span></span> dstate_update_est_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>dstate <span class="main">(</span>State <span class="free">e</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>Dijkstra_State <span class="free">a</span> <span class="free">pq</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">m</span> <span class="main">&lt;</span> length <span class="free">e</span><span class="main">)</span><span class="main">&gt;</span>
   dstate_update_est <span class="free">G</span> <span class="free">m</span> <span class="main">(</span>length <span class="free">e</span><span class="main">)</span> <span class="free">pq</span> <span class="free">a</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> dstate <span class="main">(</span>State <span class="main">(</span>list_update_set <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> keys_of <span class="free">M</span><span class="main">)</span>
               <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> min <span class="main">(</span><span class="free">e</span> <span class="main">!</span> <span class="free">m</span> <span class="main">+</span> weight <span class="free">G</span> <span class="free">m</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">e</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>Dijkstra_State <span class="bound">r</span> <span class="free">pq</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dstate_update_heap</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat array <span class="main">⇒</span> nat indexed_pqueue <span class="main">⇒</span> nat indexed_pqueue Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dstate_update_heap</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span> <span class="main">=</span> return <span class="free"><span class="bound"><span class="entity">pq</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dstate_update_heap</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">b</span> <span class="main">←</span> has_key_idx_pqueue <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span><span class="main">;</span>
     <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">ek</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span>
       <span class="bound">pq'</span> <span class="main">←</span> <span class="free">dstate_update_heap</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span><span class="main">;</span>
       update_idx_pqueue <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">ek</span> <span class="bound">pq'</span> <span class="main">}</span>
     <span class="keyword1">else</span> <span class="free">dstate_update_heap</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Dijkstra_Impl-dstate_update_heap_ind"><span class="command">lemma</span></span> dstate_update_heap_ind <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">e</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">&lt;</span> length <span class="free">e</span> <span class="main">⟹</span>
   <span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">e</span> <span class="main">*</span> idx_pqueue_map <span class="free">M</span> <span class="main">(</span>length <span class="free">e</span><span class="main">)</span> <span class="free">pq</span><span class="main">&gt;</span>
   dstate_update_heap <span class="free">G</span> <span class="free">m</span> <span class="free">k</span> <span class="free">a</span> <span class="free">pq</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> dstate <span class="main">(</span>State <span class="free">e</span> <span class="main">(</span>map_update_all_impl <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">e</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">M</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Dijkstra_State <span class="free">a</span> <span class="bound">r</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">k</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="Dijkstra_Impl-dstate_update_heap_to_fun"><span class="command">lemma</span></span> dstate_update_heap_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> length <span class="free">e</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>keys_of <span class="free">M</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">e</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>dstate <span class="main">(</span>State <span class="free">e</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>Dijkstra_State <span class="free">a</span> <span class="free">pq</span><span class="main">)</span><span class="main">&gt;</span>
   dstate_update_heap <span class="free">G</span> <span class="free">m</span> <span class="main">(</span>length <span class="free">e</span><span class="main">)</span> <span class="free">a</span> <span class="free">pq</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> dstate <span class="main">(</span>State <span class="free">e</span> <span class="main">(</span>map_update_all <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">e</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Dijkstra_State <span class="free">a</span> <span class="bound">r</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dijkstra_extract_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dijkstra_state <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> dijkstra_state<span class="main">)</span> Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dijkstra_extract_min</span> <span class="main">(</span>Dijkstra_State <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">pq'</span><span class="main">)</span> <span class="main">←</span> delete_min_idx_pqueue <span class="free"><span class="bound"><span class="entity">pq</span></span></span><span class="main">;</span>
     return <span class="main">(</span>fst <span class="bound">x</span><span class="main">,</span> Dijkstra_State <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">pq'</span><span class="main">)</span> <span class="main">}</span>"</span></span>
  
<span class="keyword1" id="Dijkstra_Impl-dijkstra_extract_min_rule"><span class="command">lemma</span></span> dijkstra_extract_min_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> empty_map <span class="main">⟹</span>
   <span class="main">&lt;</span>dstate <span class="main">(</span>State <span class="free">e</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>Dijkstra_State <span class="free">a</span> <span class="free">pq</span><span class="main">)</span><span class="main">&gt;</span>
   dijkstra_extract_min <span class="main">(</span>Dijkstra_State <span class="free">a</span> <span class="free">pq</span><span class="main">)</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> dstate <span class="main">(</span>State <span class="free">e</span> <span class="main">(</span>delete_map <span class="bound">m</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">m</span> <span class="main">&lt;</span> length <span class="free">e</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>is_heap_min <span class="bound">m</span> <span class="free">M</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> dstate.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Main operations›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dijkstra_step_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> dijkstra_state <span class="main">⇒</span> dijkstra_state Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dijkstra_step_impl</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>Dijkstra_State <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">S'</span><span class="main">)</span> <span class="main">←</span> dijkstra_extract_min <span class="main">(</span>Dijkstra_State <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">pq</span></span></span><span class="main">)</span><span class="main">;</span>
     <span class="bound">a'</span> <span class="main">←</span> dstate_update_est <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">x</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">(</span>heap_pq <span class="bound">S'</span><span class="main">)</span> <span class="main">(</span>est_a <span class="bound">S'</span><span class="main">)</span><span class="main">;</span>
     <span class="bound">pq''</span> <span class="main">←</span> dstate_update_heap <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">x</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="bound">a'</span> <span class="main">(</span>heap_pq <span class="bound">S'</span><span class="main">)</span><span class="main">;</span>
     return <span class="main">(</span>Dijkstra_State <span class="bound">a'</span> <span class="bound">pq''</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Dijkstra_Impl-dijkstra_step_impl_to_fun"><span class="command">lemma</span></span> dijkstra_step_impl_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"heap <span class="free">S</span> <span class="main">≠</span> empty_map <span class="main">⟹</span> inv <span class="free">G</span> <span class="free">S</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>dstate <span class="free">S</span> <span class="main">(</span>Dijkstra_State <span class="free">a</span> <span class="free">pq</span><span class="main">)</span><span class="main">&gt;</span>
   dijkstra_step_impl <span class="free">G</span> <span class="main">(</span>Dijkstra_State <span class="free">a</span> <span class="free">pq</span><span class="main">)</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">S'</span><span class="main">.</span> dstate <span class="bound">S'</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>is_dijkstra_step <span class="free">G</span> <span class="free">S</span> <span class="bound">S'</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="Dijkstra_Impl-dijkstra_step_impl_correct"><span class="command">lemma</span></span> dijkstra_step_impl_correct <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"heap <span class="free">S</span> <span class="main">≠</span> empty_map <span class="main">⟹</span> inv <span class="free">G</span> <span class="free">S</span> <span class="main">⟹</span>
   <span class="main">&lt;</span>dstate <span class="free">S</span> <span class="free">p</span><span class="main">&gt;</span>
   dijkstra_step_impl <span class="free">G</span> <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">S'</span><span class="main">.</span> dstate <span class="bound">S'</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>inv <span class="free">G</span> <span class="bound">S'</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>card <span class="main">(</span>unknown_set <span class="bound">S'</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>unknown_set <span class="free">S</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dijkstra_loop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> nat <span class="main">⇒</span> dijkstra_state <span class="main">⇒</span> dijkstra_state Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dijkstra_loop</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>return <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dijkstra_loop</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">p'</span> <span class="main">←</span> dijkstra_step_impl <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
    <span class="bound">p''</span> <span class="main">←</span> <span class="free">dijkstra_loop</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">p'</span><span class="main">;</span>
    return <span class="bound">p''</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Dijkstra_Impl-dijkstra_loop_correct"><span class="command">lemma</span></span> dijkstra_loop_correct <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>dstate <span class="free">S</span> <span class="free">p</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>inv <span class="free">G</span> <span class="free">S</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">n</span> <span class="main">≤</span> card <span class="main">(</span>unknown_set <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span>
   dijkstra_loop <span class="free">G</span> <span class="free">n</span> <span class="free">p</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">S'</span><span class="main">.</span> dstate <span class="bound">S'</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>inv <span class="free">G</span> <span class="bound">S'</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>card <span class="main">(</span>unknown_set <span class="bound">S'</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>unknown_set <span class="free">S</span><span class="main">)</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">p</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dijkstra</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"graph <span class="main">⇒</span> dijkstra_state Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dijkstra</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">p</span> <span class="main">←</span> dstate_init <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">;</span>
    dijkstra_loop <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">p</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of Dijkstra's algorithm.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> dijkstra_correct <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size <span class="free">G</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span>
   <span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span>
   dijkstra <span class="free">G</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">S</span><span class="main">.</span> dstate <span class="bound">S</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>inv <span class="free">G</span> <span class="bound">S</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>unknown_set <span class="bound">S</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">*</span>
        <span class="main">↑</span><span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>verts <span class="free">G</span><span class="main">.</span> has_dist <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span> <span class="main">∧</span> est <span class="bound">S</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> dist <span class="free">G</span> <span class="main">0</span> <span class="bound">i</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IntervalTree_Impl">
<div class="head">
<h1>Theory IntervalTree_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: IntervalTree_Impl.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation of interval tree›</span></span>

<span class="keyword1"><span class="command">theory</span></span> IntervalTree_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="SepAuto.html">SepAuto</a> <span class="quoted">"<a href="Interval_Tree.html">../Functional/Interval_Tree</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Imperative version of interval tree.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Interval and IdxInterval›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">interval_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">)</span> interval <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interval_encode</span> <span class="main">(</span>Interval <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> to_nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> interval <span class="main">::</span> <span class="main">(</span><span class="quoted">heap</span><span class="main">)</span> <span class="quoted">heap</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> heap_class.intro<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> countable_classI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"interval_encode"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">idx_interval_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">)</span> idx_interval <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">idx_interval_encode</span> <span class="main">(</span>IdxInterval <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> to_nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">it</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> idx_interval <span class="main">::</span> <span class="main">(</span><span class="quoted">heap</span><span class="main">)</span> <span class="quoted">heap</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> heap_class.intro<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> countable_classI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"idx_interval_encode"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Tree nodes›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> node <span class="main">=</span>
  Node <span class="main">(</span><span class="free"><span class="entity">lsub</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> node ref option"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">val</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> idx_interval"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">tmax</span></span><span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">rsub</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> node ref option"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> node.sel<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">node_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">)</span> node <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">node_encode</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> to_nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> node <span class="main">::</span> <span class="main">(</span><span class="quoted">heap</span><span class="main">)</span> <span class="quoted">heap</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> heap_class.intro<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> countable_classI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"node_encode"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">int_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"interval_tree <span class="main">⇒</span> nat node ref option <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">int_tree</span> Tip <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">↑</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">int_tree</span> <span class="main">(</span>interval_tree.Node <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">lp</span> <span class="bound">rp</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> Node <span class="bound">lp</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">rp</span> <span class="main">*</span> <span class="free">int_tree</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="bound">lp</span> <span class="main">*</span> <span class="free">int_tree</span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span> <span class="bound">rp</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">int_tree</span> <span class="main">(</span>interval_tree.Node <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">rt</span></span></span><span class="main">)</span> None <span class="main">=</span> <span class="keyword1">false</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_rewrite_ent_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> int_tree.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1" id="IntervalTree_Impl-int_tree_Tip"><span class="command">lemma</span></span> int_tree_Tip <span class="main">[</span><span class="operator">forward_ent</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"int_tree Tip <span class="free">p</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">↑</span><span class="main">(</span><span class="free">p</span> <span class="main">=</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="IntervalTree_Impl-int_tree_Node"><span class="command">lemma</span></span> int_tree_Node <span class="main">[</span><span class="operator">forward_ent</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"int_tree <span class="main">(</span>interval_tree.Node <span class="free">lt</span> <span class="free">v</span> <span class="free">m</span> <span class="free">rt</span><span class="main">)</span> <span class="free">p</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">lp</span> <span class="bound">rp</span><span class="main">.</span> the <span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> Node <span class="bound">lp</span> <span class="free">v</span> <span class="free">m</span> <span class="bound">rp</span> <span class="main">*</span> int_tree <span class="free">lt</span> <span class="bound">lp</span> <span class="main">*</span> int_tree <span class="free">rt</span> <span class="bound">rp</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">p</span> <span class="main">≠</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1" id="IntervalTree_Impl-int_tree_none"><span class="command">lemma</span></span> int_tree_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">emp</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> int_tree interval_tree.Tip None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1" id="IntervalTree_Impl-int_tree_constr_ent"><span class="command">lemma</span></span> int_tree_constr_ent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>r</sub></span> Node <span class="free">lp</span> <span class="free">v</span> <span class="free">m</span> <span class="free">rp</span> <span class="main">*</span> int_tree <span class="free">lt</span> <span class="free">lp</span> <span class="main">*</span> int_tree <span class="free">rt</span> <span class="free">rp</span> <span class="keyword1">⟹<span class="hidden">⇩</span><sub>A</sub></span> int_tree <span class="main">(</span>interval_tree.Node <span class="free">lt</span> <span class="free">v</span> <span class="free">m</span> <span class="free">rt</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">add_entail_matcher</span> <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> int_tree_none<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> int_tree_constr_ent<span class="antiquote">}</span></span></span><span class="main">]</span>›</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹fold <span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> int_tree.simps<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> int_tree <span class="main">=</span> <span class="quoted"><span class="quoted">"nat node ref option"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operations›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Basic operation›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">int_tree_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int_tree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">int_tree_empty</span> <span class="main">=</span> return None"</span></span>

<span class="keyword1" id="IntervalTree_Impl-int_tree_empty_to_fun"><span class="command">lemma</span></span> int_tree_empty_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> int_tree_empty <span class="main">&lt;</span>int_tree Tip<span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">int_tree_is_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int_tree <span class="main">⇒</span> bool Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">int_tree_is_empty</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="IntervalTree_Impl-int_tree_is_empty_rule"><span class="command">lemma</span></span> int_tree_is_empty_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>int_tree <span class="free">t</span> <span class="free">b</span><span class="main">&gt;</span>
   int_tree_is_empty <span class="free">b</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> int_tree <span class="free">t</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> <span class="free">t</span> <span class="main">=</span> Tip<span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_tmax</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int_tree <span class="main">⇒</span> nat Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_tmax</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> return <span class="main">0</span>
   <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
      return <span class="main">(</span>tmax <span class="bound">t</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="IntervalTree_Impl-get_tmax_rule"><span class="command">lemma</span></span> get_tmax_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>int_tree <span class="free">t</span> <span class="free">b</span><span class="main">&gt;</span> get_tmax <span class="free">b</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> int_tree <span class="free">t</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> interval_tree.tmax <span class="free">t</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Tip"</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compute_tmax</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat idx_interval <span class="main">⇒</span> int_tree <span class="main">⇒</span> int_tree <span class="main">⇒</span> nat Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compute_tmax</span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">lm</span> <span class="main">←</span> get_tmax <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span>
    <span class="bound">rm</span> <span class="main">←</span> get_tmax <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
    return <span class="main">(</span>max3 <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="bound">lm</span> <span class="bound">rm</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="IntervalTree_Impl-compute_tmax_rule"><span class="command">lemma</span></span> compute_tmax_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>int_tree <span class="free">t1</span> <span class="free">b1</span> <span class="main">*</span> int_tree <span class="free">t2</span> <span class="free">b2</span><span class="main">&gt;</span>
   compute_tmax <span class="free">it</span> <span class="free">b1</span> <span class="free">b2</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> int_tree <span class="free">t1</span> <span class="free">b1</span> <span class="main">*</span> int_tree <span class="free">t2</span> <span class="free">b2</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> max3 <span class="free">it</span> <span class="main">(</span>interval_tree.tmax <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>interval_tree.tmax <span class="free">t2</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">int_tree_constr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int_tree <span class="main">⇒</span> nat idx_interval <span class="main">⇒</span> int_tree <span class="main">⇒</span> int_tree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">int_tree_constr</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">rp</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">m</span> <span class="main">←</span> compute_tmax <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="free"><span class="bound"><span class="entity">rp</span></span></span><span class="main">;</span>
    <span class="bound">p</span> <span class="main">←</span> ref <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">rp</span></span></span><span class="main">)</span><span class="main">;</span>
    return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="IntervalTree_Impl-int_tree_constr_rule"><span class="command">lemma</span></span> int_tree_constr_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>int_tree <span class="free">lt</span> <span class="free">lp</span> <span class="main">*</span> int_tree <span class="free">rt</span> <span class="free">rp</span><span class="main">&gt;</span>
   int_tree_constr <span class="free">lp</span> <span class="free">v</span> <span class="free">rp</span>
   <span class="main">&lt;</span>int_tree <span class="main">(</span>interval_tree.Node <span class="free">lt</span> <span class="free">v</span> <span class="main">(</span>max3 <span class="free">v</span> <span class="main">(</span>interval_tree.tmax <span class="free">lt</span><span class="main">)</span> <span class="main">(</span>interval_tree.tmax <span class="free">rt</span><span class="main">)</span><span class="main">)</span> <span class="free">rt</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Insertion›</span></span>
  
<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">insert_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat idx_interval <span class="main">⇒</span> int_tree <span class="main">⇒</span> int_tree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_impl</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> int_tree_constr None <span class="free"><span class="bound"><span class="entity">v</span></span></span> None
  <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> val <span class="bound">t</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
       return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">&lt;</span> val <span class="bound">t</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">q</span> <span class="main">←</span> <span class="free">insert_impl</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">m</span> <span class="main">←</span> compute_tmax <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="bound">q</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">p</span> <span class="main">:=</span> Node <span class="bound">q</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="bound">m</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
       return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span>
     <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">q</span> <span class="main">←</span> <span class="free">insert_impl</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">m</span> <span class="main">←</span> compute_tmax <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="bound">q</span><span class="main">;</span>
       <span class="bound">p</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="bound">m</span> <span class="bound">q</span><span class="main">;</span>
       return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="IntervalTree_Impl-int_tree_insert_to_fun"><span class="command">lemma</span></span> int_tree_insert_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>int_tree <span class="free">t</span> <span class="free">b</span><span class="main">&gt;</span>
    insert_impl <span class="free">v</span> <span class="free">b</span>
   <span class="main">&lt;</span>int_tree <span class="main">(</span>insert <span class="free">v</span> <span class="free">t</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Deletion›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">int_tree_del_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int_tree <span class="main">⇒</span> <span class="main">(</span>nat idx_interval <span class="main">×</span> int_tree<span class="main">)</span> Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">int_tree_del_min</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> raise <span class="keyword1">STR</span> <span class="inner_quoted">''del_min: empty tree''</span>
   <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">if</span> lsub <span class="bound">t</span> <span class="main">=</span> None <span class="keyword1">then</span>
         return <span class="main">(</span>val <span class="bound">t</span><span class="main">,</span> rsub <span class="bound">t</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">r</span> <span class="main">←</span> <span class="free">int_tree_del_min</span> <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">m</span> <span class="main">←</span> compute_tmax <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">p</span> <span class="main">:=</span> Node <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="bound">m</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         return <span class="main">(</span>fst <span class="bound">r</span><span class="main">,</span> Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="IntervalTree_Impl-int_tree_del_min_to_fun"><span class="command">lemma</span></span> int_tree_del_min_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>int_tree <span class="free">t</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">b</span> <span class="main">≠</span> None<span class="main">)</span><span class="main">&gt;</span>
   int_tree_del_min <span class="free">b</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> int_tree <span class="main">(</span>snd <span class="main">(</span>del_min <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>fst<span class="main">(</span><span class="bound">r</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>del_min <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">int_tree_del_elt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int_tree <span class="main">⇒</span> int_tree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">int_tree_del_elt</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> raise <span class="keyword1">STR</span> <span class="inner_quoted">''del_elt: empty tree''</span>
   <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">if</span> lsub <span class="bound">t</span> <span class="main">=</span> None <span class="keyword1">then</span> return <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> rsub <span class="bound">t</span> <span class="main">=</span> None <span class="keyword1">then</span> return <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">r</span> <span class="main">←</span> int_tree_del_min <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">m</span> <span class="main">←</span> compute_tmax <span class="main">(</span>fst <span class="bound">r</span><span class="main">)</span> <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">p</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">r</span><span class="main">)</span> <span class="bound">m</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span><span class="main">;</span>
          return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="IntervalTree_Impl-int_tree_del_elt_to_fun"><span class="command">lemma</span></span> int_tree_del_elt_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>int_tree <span class="main">(</span>interval_tree.Node <span class="free">lt</span> <span class="free">v</span> <span class="free">m</span> <span class="free">rt</span><span class="main">)</span> <span class="free">b</span><span class="main">&gt;</span>
   int_tree_del_elt <span class="free">b</span>
   <span class="main">&lt;</span>int_tree <span class="main">(</span>delete_elt_tree <span class="main">(</span>interval_tree.Node <span class="free">lt</span> <span class="free">v</span> <span class="free">m</span> <span class="free">rt</span><span class="main">)</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">delete_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat idx_interval <span class="main">⇒</span> int_tree <span class="main">⇒</span> int_tree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delete_impl</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> return None
   <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> val <span class="bound">t</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">r</span> <span class="main">←</span> int_tree_del_elt <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span>
         return <span class="bound">r</span> <span class="main">}</span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> val <span class="bound">t</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">q</span> <span class="main">←</span> <span class="free">delete_impl</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">m</span> <span class="main">←</span> compute_tmax <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="bound">q</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">p</span> <span class="main">:=</span> Node <span class="bound">q</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="bound">m</span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span>
       <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">q</span> <span class="main">←</span> <span class="free">delete_impl</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">m</span> <span class="main">←</span> compute_tmax <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="bound">q</span><span class="main">;</span>
         <span class="bound">p</span> <span class="main">:=</span> Node <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span> <span class="bound">m</span> <span class="bound">q</span><span class="main">;</span>
         return <span class="main">(</span>Some <span class="bound">p</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="IntervalTree_Impl-int_tree_delete_to_fun"><span class="command">lemma</span></span> int_tree_delete_to_fun <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>int_tree <span class="free">t</span> <span class="free">b</span><span class="main">&gt;</span>
    delete_impl <span class="free">x</span> <span class="free">b</span>
   <span class="main">&lt;</span>int_tree <span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Search›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">search_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat interval <span class="main">⇒</span> int_tree <span class="main">⇒</span> bool Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">search_impl</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> return False
   <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">t</span> <span class="main">←</span> <span class="main">!</span><span class="bound">p</span><span class="main">;</span>
      <span class="main">(</span><span class="keyword1">if</span> is_overlap <span class="main">(</span>int <span class="main">(</span>val <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> return True
       <span class="keyword1">else</span> <span class="keyword1">case</span> lsub <span class="bound">t</span> <span class="keyword1">of</span>
           None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">b</span> <span class="main">←</span> <span class="free">search_impl</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span> return <span class="bound">b</span> <span class="main">}</span>
         <span class="main">|</span> Some <span class="bound">lp</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
            <span class="bound">lt</span> <span class="main">←</span> <span class="main">!</span><span class="bound">lp</span><span class="main">;</span>
            <span class="keyword1">if</span> tmax <span class="bound">lt</span> <span class="main">≥</span> low <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span>
              <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">b</span> <span class="main">←</span> <span class="free">search_impl</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>lsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span> return <span class="bound">b</span> <span class="main">}</span>
            <span class="keyword1">else</span>
              <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">b</span> <span class="main">←</span> <span class="free">search_impl</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>rsub <span class="bound">t</span><span class="main">)</span><span class="main">;</span> return <span class="bound">b</span> <span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="IntervalTree_Impl-search_impl_correct"><span class="command">lemma</span></span> search_impl_correct <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>int_tree <span class="free">t</span> <span class="free">b</span><span class="main">&gt;</span>
    search_impl <span class="free">x</span> <span class="free">b</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> int_tree <span class="free">t</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> search <span class="free">t</span> <span class="free">x</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@induct</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">b</span></span> <span class="main">@with</span>
  <span class="keyword1"><span class="command">@subgoal</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> interval_tree.Node <span class="free">l</span> <span class="free">v</span> <span class="free">m</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"is_overlap <span class="main">(</span>int <span class="free">v</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> Tip <span class="main">∧</span> interval_tree.tmax <span class="free">l</span> <span class="main">≥</span> low <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">@endgoal</span></span> <span class="keyword1"><span class="command">@end</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Outer interface›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Express Hoare triples for operations on interval tree in terms of
  the set of intervals represented by the tree.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">int_tree_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat idx_interval set <span class="main">⇒</span> int_tree <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">int_tree_set</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">t</span><span class="main">.</span> int_tree <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>is_interval_tree <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> tree_set <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_ent_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> int_tree_set_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">theorem</span></span> int_tree_empty_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> int_tree_empty <span class="main">&lt;</span>int_tree_set <span class="main">{}</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> int_tree_insert_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>int_tree_set <span class="free">S</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>is_interval <span class="main">(</span>int <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span>
   insert_impl <span class="free">x</span> <span class="free">b</span>
   <span class="main">&lt;</span>int_tree_set <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> int_tree_delete_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>int_tree_set <span class="free">S</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>is_interval <span class="main">(</span>int <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">&gt;</span>
   delete_impl <span class="free">x</span> <span class="free">b</span>
   <span class="main">&lt;</span>int_tree_set <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">theorem</span></span> int_tree_search_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span>int_tree_set <span class="free">S</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>is_interval <span class="free">x</span><span class="main">)</span><span class="main">&gt;</span>
   search_impl <span class="free">x</span> <span class="free">b</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> int_tree_set <span class="free">S</span> <span class="free">b</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> has_overlap <span class="free">S</span> <span class="free">x</span><span class="main">)</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> int_tree_set_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Rect_Intersect_Impl">
<div class="head">
<h1>Theory Rect_Intersect_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Rect_Intersect_Impl.thy
  Author: Bohua Zhan
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation of rectangle intersection›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Rect_Intersect_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Rect_Intersect.html">../Functional/Rect_Intersect</a>"</span> <a href="IntervalTree_Impl.html">IntervalTree_Impl</a> <a href="Quicksort_Impl.html">Quicksort_Impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Imperative version of rectangle-intersection algorithm.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operations›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">operation_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap<span class="main">)</span> operation <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">operation_encode</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="keyword1">of</span> INS <span class="bound">p</span> <span class="bound">i</span> <span class="bound">n</span> <span class="main">⇒</span> to_nat <span class="main">(</span>is_INS <span class="free"><span class="bound"><span class="entity">oper</span></span></span><span class="main">,</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span>
               <span class="main">|</span> DEL <span class="bound">p</span> <span class="bound">i</span> <span class="bound">n</span> <span class="main">⇒</span> to_nat <span class="main">(</span>is_INS <span class="free"><span class="bound"><span class="entity">oper</span></span></span><span class="main">,</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> operation <span class="main">::</span> <span class="main">(</span><span class="quoted">heap</span><span class="main">)</span> <span class="quoted">heap</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> heap_class.intro<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> countable_classI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"operation_encode"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> operation.case_eq_if<span class="main">)</span>
  <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Initial state›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rect_inter_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat rectangle list <span class="main">⇒</span> nat operation array Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rect_inter_init</span> <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">p</span> <span class="main">←</span> Array.of_list <span class="main">(</span>ins_ops <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">@</span> del_ops <span class="free"><span class="bound"><span class="entity">rects</span></span></span><span class="main">)</span><span class="main">;</span>
     quicksort_all <span class="bound">p</span><span class="main">;</span>
     return <span class="bound">p</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_rewrite_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> all_ops_def<span class="antiquote">}</span></span></span>›</span>
<span class="keyword1" id="Rect_Intersect_Impl-rect_inter_init_rule"><span class="command">lemma</span></span> rect_inter_init_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> rect_inter_init <span class="free">rects</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> all_ops <span class="free">rects</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">del_prfstep_thm</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> all_ops_def<span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rect_inter_next</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat operation array <span class="main">⇒</span> int_tree <span class="main">⇒</span> nat <span class="main">⇒</span> int_tree Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rect_inter_next</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">oper</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span>
    <span class="keyword1">if</span> is_INS <span class="bound">oper</span> <span class="keyword1">then</span>
      IntervalTree_Impl.insert_impl <span class="main">(</span>IdxInterval <span class="main">(</span>op_int <span class="bound">oper</span><span class="main">)</span> <span class="main">(</span>op_idx <span class="bound">oper</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>
    <span class="keyword1">else</span>
      IntervalTree_Impl.delete_impl <span class="main">(</span>IdxInterval <span class="main">(</span>op_int <span class="bound">oper</span><span class="main">)</span> <span class="main">(</span>op_idx <span class="bound">oper</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Rect_Intersect_Impl-op_int_is_interval"><span class="command">lemma</span></span> op_int_is_interval<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_rect_list <span class="free">rects</span> <span class="main">⟹</span> <span class="free">ops</span> <span class="main">=</span> all_ops <span class="free">rects</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">ops</span> <span class="main">⟹</span>
   is_interval <span class="main">(</span>op_int <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span> <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ops</span> <span class="main">!</span> <span class="free">k</span> <span class="main">∈</span> set <span class="free">ops</span>"</span></span> <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"is_INS <span class="main">(</span><span class="free">ops</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">@qed</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">add_forward_prfstep_cond</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> op_int_is_interval<span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">with_term</span> <span class="inner_quoted">"op_int (?ops ! ?k)"</span><span class="main">]</span>›</span>

<span class="keyword1" id="Rect_Intersect_Impl-rect_inter_next_rule"><span class="command">lemma</span></span> rect_inter_next_rule <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_rect_list <span class="free">rects</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> all_ops <span class="free">rects</span> <span class="main">*</span> int_tree_set <span class="free">S</span> <span class="free">b</span><span class="main">&gt;</span>
   rect_inter_next <span class="free">a</span> <span class="free">b</span> <span class="free">k</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> all_ops <span class="free">rects</span> <span class="main">*</span> int_tree_set <span class="main">(</span>apply_ops_k_next <span class="free">rects</span> <span class="free">S</span> <span class="free">k</span><span class="main">)</span> <span class="bound">r</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>heap<span class="main">)</span> <span class="entity">rect_inter_impl</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"nat operation array <span class="main">⇒</span> int_tree <span class="main">⇒</span> nat <span class="main">⇒</span> bool Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rect_inter_impl</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">n</span> <span class="main">←</span> Array.len <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≥</span> <span class="bound">n</span> <span class="keyword1">then</span> return False
     <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">oper</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span>
       <span class="main">(</span><span class="keyword1">if</span> is_INS <span class="bound">oper</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">overlap</span> <span class="main">←</span> IntervalTree_Impl.search_impl <span class="main">(</span>op_int <span class="bound">oper</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span>
          <span class="keyword1">if</span> <span class="bound">overlap</span> <span class="keyword1">then</span> return True
          <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="bound">n</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> return False
          <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
            <span class="bound">b'</span> <span class="main">←</span> rect_inter_next <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span>
            <span class="free">rect_inter_impl</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">b'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">}</span>
        <span class="keyword1">else</span>
          <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="bound">n</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> return False
          <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
            <span class="bound">b'</span> <span class="main">←</span> rect_inter_next <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span>
            <span class="free">rect_inter_impl</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">b'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Rect_Intersect_Impl-rect_inter_to_fun_ind"><span class="command">lemma</span></span> rect_inter_to_fun_ind <span class="main">[</span><span class="operator">hoare_triple</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_rect_list <span class="free">rects</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">&lt;</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> all_ops <span class="free">rects</span> <span class="main">*</span> int_tree_set <span class="free">S</span> <span class="free">b</span><span class="main">&gt;</span>
   rect_inter_impl <span class="free">a</span> <span class="free">b</span> <span class="free">k</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> all_ops <span class="free">rects</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> rect_inter <span class="free">rects</span> <span class="free">S</span> <span class="free">k</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">@proof</span></span>
  <span class="keyword1"><span class="command">@let</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> length <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span> <span class="main">-</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">@strong_induct</span></span> <span class="quoted"><span class="free">d</span></span> <span class="keyword2"><span class="keyword">arbitrary</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">b</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> length <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">@unfold</span></span> <span class="quoted"><span class="quoted">"rect_inter <span class="free">rects</span> <span class="free">S</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"is_INS <span class="main">(</span>all_ops <span class="free">rects</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="main">@with</span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"has_overlap <span class="free">S</span> <span class="main">(</span>op_int <span class="main">(</span>all_ops <span class="free">rects</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> length <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">@apply_induct_hyp</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">@end</span></span>
  <span class="keyword1"><span class="command">@case</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> length <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">@apply_induct_hyp</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">@have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>all_ops <span class="free">rects</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">@qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rect_inter_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat rectangle list <span class="main">⇒</span> bool Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rect_inter_all</span> <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">rects</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> return False
     <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">a</span> <span class="main">←</span> rect_inter_init <span class="free"><span class="bound"><span class="entity">rects</span></span></span><span class="main">;</span>
       <span class="bound">b</span> <span class="main">←</span> int_tree_empty<span class="main">;</span>
       rect_inter_impl <span class="bound">a</span> <span class="bound">b</span> <span class="main">0</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of rectangle intersection algorithm.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> rect_inter_all_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_rect_list <span class="free">rects</span> <span class="main">⟹</span>
   <span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span>
   rect_inter_all <span class="free">rects</span>
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> has_rect_overlap <span class="free">rects</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto2</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sep_Examples">
<div class="head">
<h1>Theory Sep_Examples</h1>
</div>
<pre class="source"><span class="comment1">(*
  File: Sep_Examples.thy
  Author: Bohua Zhan

  Overall directory of examples in Imperative.
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Sep_Examples

<span class="keyword2"><span class="keyword">imports</span></span>

  <a href="GCD_Impl.html">GCD_Impl</a> <span class="comment1">― ‹Tutorial›</span>

  <span class="comment1">― ‹Inductive data structures›</span>

  <a href="LinkedList.html">LinkedList</a> <span class="comment1">― ‹Linked lists›</span>
  
  <a href="BST_Impl.html">BST_Impl</a> <span class="comment1">― ‹Binary search tree›</span>

  <a href="RBTree_Impl.html">RBTree_Impl</a> <span class="comment1">― ‹Red-black tree›</span>

  <span class="comment1">― ‹Array algorithms›</span>

  <a href="Arrays_Impl.html">Arrays_Impl</a> <span class="comment1">― ‹Standard procedure on arrays›</span>

  <a href="DynamicArray.html">DynamicArray</a> <span class="comment1">― ‹Dynamic array›</span>
  
  <a href="Quicksort_Impl.html">Quicksort_Impl</a> <span class="comment1">― ‹Quicksort›</span>
  
  <a href="Indexed_PQueue_Impl.html">Indexed_PQueue_Impl</a> <span class="comment1">― ‹Indexed priority queue›</span>
  
  <a href="Union_Find_Impl.html">Union_Find_Impl</a> <span class="comment1">― ‹Union-find›</span>

  <span class="comment1">― ‹Applications›</span>

  <a href="Connectivity_Impl.html">Connectivity_Impl</a> <span class="comment1">― ‹Connectivity on graphs›</span>
  
  <a href="Dijkstra_Impl.html">Dijkstra_Impl</a> <span class="comment1">― ‹Dijkstra's algorithm›</span>
  
  <a href="Rect_Intersect_Impl.html">Rect_Intersect_Impl</a> <span class="comment1">― ‹Rectangular intersection›</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>