<div id="Isotone_Transformers">
<div class="head">
<h1>Theory Isotone_Transformers</h1>
</div>
<pre class="source"><span class="comment1">(* 
  Title: Isotone Transformers Between Complete Lattices
  Author: Georg Struth 
  Maintainer: Georg Struth &lt;g.struth@sheffield.ac.uk&gt; 
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Isotone Transformers Between Complete Lattices›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Isotone_Transformers    
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Order_Lattice_Props/Fixpoint_Fusion.html">Order_Lattice_Props.Fixpoint_Fusion</a>"</span> 
          <span class="quoted">"<a href="../Quantales/Quantale_Star.html">Quantales.Quantale_Star</a>"</span>


<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A transformer is a function between lattices; an isotone transformer preserves the order (or is monotone). In this component, 
statements are developed in a type-driven way. Statements are developed in more general contexts or even the most general one.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Properties›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First I show that some basic transformers are isotone...›</span></span>

<span class="keyword1" id="Isotone_Transformers-iso_id"><span class="command">lemma</span></span> iso_id<span class="main">:</span> <span class="quoted"><span class="quoted">"mono id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoI<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-iso_botf"><span class="command">lemma</span></span> iso_botf<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoI<span class="main">)</span> 

<span class="keyword1" id="Isotone_Transformers-iso_topf"><span class="command">lemma</span></span> iso_topf<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">⊤</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoI<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹... and that compositions, Infs and Sups preserve isotonicity.›</span></span>

<span class="keyword1" id="Isotone_Transformers-iso_fcomp"><span class="command">lemma</span></span> iso_fcomp<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">g</span> <span class="main">⟹</span> mono <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-iso_fSup"><span class="command">lemma</span></span> iso_fSup<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>order <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> mono <span class="bound">f</span><span class="main">)</span> <span class="main">⟹</span> mono <span class="main">(</span><span class="main">⨆</span><span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def SUP_subset_mono<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-iso_fsup"><span class="command">lemma</span></span> iso_fsup<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">g</span> <span class="main">⟹</span> mono <span class="main">(</span><span class="free">f</span> <span class="main">⊔</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mono_def <span class="keyword1"><span class="command">using</span></span> sup_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Isotone_Transformers-iso_fInf"><span class="command">lemma</span></span> iso_fInf<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>order <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> mono <span class="bound">f</span> <span class="main">⟹</span> mono <span class="main">(</span><span class="main">⨅</span><span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Inf_greatest<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> INF_lower2<span class="main">)</span>
 
<span class="keyword1" id="Isotone_Transformers-iso_finf"><span class="command">lemma</span></span> iso_finf<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">g</span> <span class="main">⟹</span> mono <span class="main">(</span><span class="free">f</span> <span class="main">⊓</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mono_def <span class="keyword1"><span class="command">using</span></span> inf_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    
<span class="keyword1" id="Isotone_Transformers-fun_isol"><span class="command">lemma</span></span> fun_isol<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">≤</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_fun_def monoD<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-fun_isor"><span class="command">lemma</span></span> fun_isor<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">≤</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">h</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_fun_def monoD<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pre-Quantale of Isotone Transformers›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It is well known, and has been formalised within Isabelle, that functions into complete lattices form complete lattices.
In the following proof, this needs to be replayed because isotone functions are considered and closure conditions
need to be respected.

Functions must now be restricted to a single type.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> iso <span class="main">::</span> <span class="main">(</span><span class="quoted">complete_lattice</span><span class="main">)</span> <span class="quoted">unital_pre_quantale</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">one_iso</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice iso"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">id</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iso_id<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">times_iso</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice iso <span class="main">⇒</span> <span class="tfree">'a</span> iso <span class="main">⇒</span> <span class="tfree">'a</span> iso"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(∘)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iso_fcomp<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_assoc fInf_distr_var fInf_subdistl_var<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹I have previously worked in (pre)quantales with many types or quantaloids. Formally, these are categories  
enriched over the category of Sup-lattices (complete lattices with Sup-preserving functions). An advantage 
of the single-typed approach is that the definition of the Kleene star for (pre)quantales is available in this setting.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Propositional Hoare Logic for Transformers without Star›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The rules of an abstract Propositional Hoare logic are derivable.›</span></span>

<span class="keyword1" id="Isotone_Transformers-H_iso_cond1"><span class="command">lemma</span></span> H_iso_cond1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Isotone_Transformers-H_iso_cond2"><span class="command">lemma</span></span> H_iso_cond2<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> mono_def order_subst1<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-H_iso_seq"><span class="command">lemma</span></span> H_iso_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">g</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H_iso_cond2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Isotone_Transformers-H_iso_seq_var"><span class="command">lemma</span></span> H_iso_seq_var<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">g</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_iso_cond2<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-H_iso_fInf"><span class="command">lemma</span></span> H_iso_fInf<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="free">x</span> <span class="main">≤</span> <span class="bound">f</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="main">⨅</span><span class="free">F</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_INF_iff<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-H_iso_fSup"><span class="command">lemma</span></span> H_iso_fSup<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="free">x</span> <span class="main">≤</span> <span class="bound">f</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="main">⨆</span><span class="free">F</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> SUP_upper2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These rules are suitable for weakest liberal preconditions. Order-dual ones, in which the order relation is swapped,
are consistent with other kinds of transformers. In the context of dynamic logic, the first set corresponds to box modalities 
whereas the second one would correspond to diamonds.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Kleene Star of Isotone Transformers›</span></span>
 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The Hoare rule for loops requires some preparation. On the way I verify some Kleene-algebra-style axioms for iteration.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First I show that functions form monoids.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> fun_mon<span class="main">:</span> monoid_mult <span class="quoted"><span class="quoted">"id<span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(∘)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fiter_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>semilattice_inf<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">fiter_fun</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(⊓)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∘</span> <span class="main">(∘)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fiter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">fiter</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> gfp <span class="main">(</span>fiter_fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fiter_id</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">fiter_id</span> <span class="main">=</span> fiter id"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fpower</span> <span class="main">≡</span> fun_mon.power"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fstar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fstar</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">i</span><span class="main">.</span> fpower <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The types in the following statements are often more general than those in the prequantale setting. I develop them generally, 
instead of inheriting (most of them) with more restrictive types from the quantale components.›</span></span>

<span class="keyword1" id="Isotone_Transformers-fiter_fun_exp"><span class="command">lemma</span></span> fiter_fun_exp<span class="main">:</span> <span class="quoted"><span class="quoted">"fiter_fun <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="main">=</span> <span class="free">f</span> <span class="main">⊓</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fiter_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The two lemmas that follow set up the relationship between the star for transformers and those in quantales.›</span></span>

<span class="keyword1" id="Isotone_Transformers-fiter_qiter1"><span class="command">lemma</span></span> fiter_qiter1<span class="main">:</span> <span class="quoted"><span class="quoted">"Abs_iso <span class="main">(</span>fiter_fun <span class="main">(</span>Rep_iso <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Rep_iso <span class="free">g</span><span class="main">)</span> <span class="main">(</span>Rep_iso <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> qiter_fun <span class="free">f</span> <span class="free">g</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fiter_fun_def qiter_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Rep_iso_inverse comp_def sup_iso.rep_eq times_iso.rep_eq<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-fiter_qiter4"><span class="command">lemma</span></span> fiter_qiter4<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">g</span> <span class="main">⟹</span> mono <span class="free">h</span> <span class="main">⟹</span> Rep_iso <span class="main">(</span>qiter_fun <span class="main">(</span>Abs_iso <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Abs_iso <span class="free">g</span><span class="main">)</span> <span class="main">(</span>Abs_iso <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fiter_fun <span class="free">f</span> <span class="free">g</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Abs_iso_inverse fiter_fun_exp fiter_qiter1 iso_fcomp iso_finf mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The type coercions are needed to deal with isotone (monotone) functions, which had to be redefined to one single type above,
in order to cooperate with the type classes for quantales. Having to deal with these coercions would be another drawback of using the 
quantale-based setting for the development.›</span></span>

<span class="keyword1" id="Isotone_Transformers-iso_fiter_fun"><span class="command">lemma</span></span> iso_fiter_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="main">(</span>fiter_fun <span class="free">f</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiter_fun_exp le_fun_def mono_def inf.coboundedI2<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-iso_fiter_fun2"><span class="command">lemma</span></span> iso_fiter_fun2<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">g</span> <span class="main">⟹</span> mono <span class="main">(</span>fiter_fun <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiter_fun_exp le_fun_def mono_def inf.coboundedI2<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-fiter_unfoldl"><span class="command">lemma</span></span> fiter_unfoldl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">g</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">⊓</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> fiter <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> fiter <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fiter_def fiter_fun_exp gfp_unfold iso_fiter_fun2<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-fiter_inductl"><span class="command">lemma</span></span> fiter_inductl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">g</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">⊓</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">h</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≤</span> fiter <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiter_def fiter_fun_def gfp_upperbound<span class="main">)</span>
 
<span class="keyword1" id="Isotone_Transformers-fiter_fusion"><span class="command">lemma</span></span> fiter_fusion<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">g</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fiter <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> fiter_id <span class="free">g</span> <span class="main">∘</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>fiter_fun id <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> iso_fiter_fun2 iso_id<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>fiter_fun <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> iso_fiter_fun2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf <span class="main">∘</span> image <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">∘</span> Inf"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff image_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span>fiter_fun id <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fiter_fun <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff fiter_fun_def<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> gfp_fusion_inf_pres
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fiter_def fiter_id_def h1 h2 h3<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Isotone_Transformers-fpower_supdistl"><span class="command">lemma</span></span> fpower_supdistl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∘</span> fstar <span class="free">g</span> <span class="main">≤</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">∘</span> fpower <span class="free">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Isotone_Transformers.fun_isol fstar_def mono_INF mono_def<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-fpower_distr"><span class="command">lemma</span></span> fpower_distr<span class="main">:</span> <span class="quoted"><span class="quoted">"fstar <span class="free">f</span> <span class="main">∘</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">i</span><span class="main">.</span> fpower <span class="free">f</span> <span class="bound">i</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fstar_def image_comp<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-fpower_Sup_subcomm"><span class="command">lemma</span></span> fpower_Sup_subcomm<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∘</span> fstar <span class="free">f</span> <span class="main">≤</span> fstar <span class="free">f</span> <span class="main">∘</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fun_mon.power_commutes le_INF_iff fpower_distr fpower_supdistl<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-fpower_inductl"><span class="command">lemma</span></span> fpower_inductl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">g</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">⊓</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">h</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≤</span> fpower <span class="free">f</span> <span class="free">i</span> <span class="main">∘</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> fun.map_comp fun_isol order_trans<span class="main">)</span> 

<span class="keyword1" id="Isotone_Transformers-fpower_inductr"><span class="command">lemma</span></span> fpower_inductr<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">g</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">⊓</span> <span class="main">(</span><span class="free">h</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">∘</span> fpower <span class="free">f</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_fun_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> comp_eq_elim fun_mon.power_commutes order_trans<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-fiter_fstar"><span class="command">lemma</span></span> fiter_fstar<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> fiter_id <span class="free">f</span> <span class="main">≤</span> fstar <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fiter_id_def fiter_unfoldl fpower_inductl fstar_def iso_id le_INF_iff o_id order_refl<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-iso_fiter_ext"><span class="command">lemma</span></span> iso_fiter_ext<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">y</span> <span class="main">⊓</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_infI2 mono_def<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-fstar_pred_char"><span class="command">lemma</span></span> fstar_pred_char<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> fiter_id <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> gfp <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊓</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">.</span> <span class="main">(</span>id <span class="main">⊓</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⊓</span> <span class="free">f</span> <span class="main">(</span><span class="bound">g</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">.</span> fiter_fun id <span class="free">f</span> <span class="bound">g</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊓</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="bound">g</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fiter_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fiter_id_def fiter_def gfp_fusion_var hyp iso_fiter_fun2 iso_id iso_fiter_ext<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Propositional Hoare Logic Completed›</span></span>
 
<span class="keyword1" id="Isotone_Transformers-H_weak_loop"><span class="command">lemma</span></span> H_weak_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> fiter_id <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fstar_pred_char gfp_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sup_upper<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-iso_fiter"><span class="command">lemma</span></span> iso_fiter<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="main">(</span>fiter_id <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mono_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fstar_pred_char<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gfp_mono inf_mono<span class="main">)</span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As already mentioned, a dual Hoare logic can be built for the dual lattice. In this case, weak iteration is defined with respect to Sup.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following standard construction lifts elements of (meet semi)lattices to transformers.
I allow a more general type.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fqtran</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>inf <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fqtran</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊓</span> <span class="bound">y</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following standard construction lifts elements of boolean algebras to transformers.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bqtran</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>boolean_algebra <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⌊</span>_<span class="keyword1">⌋</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⌊</span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">⌋</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">-</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊔</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The conditional and while rule of Hoare logic are now derivable.›</span></span>

<span class="keyword1" id="Isotone_Transformers-bqtran_iso"><span class="command">lemma</span></span> bqtran_iso<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bqtran_def monoI order_refl sup.mono<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-cond_iso"><span class="command">lemma</span></span> cond_iso<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">g</span> <span class="main">⟹</span> mono <span class="main">(</span><span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">⊓</span> <span class="main">⌊</span><span class="free">y</span><span class="main">⌋</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bqtran_iso iso_fcomp iso_finf<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-loop_iso"><span class="command">lemma</span></span> loop_iso<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="main">(</span>fiter_id <span class="main">(</span><span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">∘</span> <span class="main">⌊</span><span class="free">y</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bqtran_iso iso_fcomp iso_fiter<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-H_iso_cond"><span class="command">lemma</span></span> H_iso_cond<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">g</span> <span class="main">⟹</span>  <span class="free">p</span> <span class="main">⊓</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">⊓</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">g</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span>inf <span class="main">(</span><span class="main">⌊</span><span class="free">p</span><span class="main">⌋</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">⌊</span><span class="free">q</span><span class="main">⌋</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> bqtran_def comp_apply inf_apply inf_commute le_inf_iff shunt1<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-H_iso_loop"><span class="command">lemma</span></span> H_iso_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">⊓</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="main">(</span>fiter_id <span class="main">(</span><span class="main">⌊</span><span class="free">p</span><span class="main">⌋</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">⌊</span><span class="free">q</span><span class="main">⌋</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊓</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⊓</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="main">⌊</span><span class="free">p</span><span class="main">⌋</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H_iso_cond <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">(</span>fiter_id <span class="main">(</span><span class="main">⌊</span><span class="free">p</span><span class="main">⌋</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_weak_loop a bqtran_iso iso_fcomp<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span>fiter_id <span class="main">(</span><span class="main">⌊</span><span class="free">p</span><span class="main">⌋</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">q</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊓</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> a bqtran_iso dual_order.refl iso_fcomp iso_fiter monoD shunt1<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="main">(</span>fiter_id <span class="main">(</span><span class="main">⌊</span><span class="free">p</span><span class="main">⌋</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">⌊</span><span class="free">q</span><span class="main">⌋</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊓</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bqtran_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Isotone_Transformers-btran_spec"><span class="command">lemma</span></span> btran_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">⌊</span><span class="free">y</span><span class="main">⌋</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊓</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bqtran_def sup_inf_distrib1<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-btran_neg_spec"><span class="command">lemma</span></span> btran_neg_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">⌊</span><span class="main">-</span><span class="free">y</span><span class="main">⌋</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> btran_spec diff_eq<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A Propositional Refinement Calculus›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next I derive the laws of an abstract Propositional Refinement Calculus, Morgan-style. 
These are given without the co-called frames, which capture information about local and global variables in variants of this calculus.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ri</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="main">⨅</span><span class="main">{</span><span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> mono <span class="main">(</span><span class="bound">f</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>order <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice<span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Isotone_Transformers-Ri_least"><span class="command">lemma</span></span> Ri_least<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">y</span> <span class="main">⟹</span> Ri <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Ri_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Inf_lower mem_Collect_eq<span class="main">)</span>
 
<span class="keyword1" id="Isotone_Transformers-Ri_spec"><span class="command">lemma</span></span> Ri_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> Ri <span class="free">x</span> <span class="free">y</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Ri_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Inf_greatest<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-Ri_spec_var"><span class="command">lemma</span></span> Ri_spec_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">.</span> Ri <span class="free">x</span> <span class="free">y</span> <span class="bound">z</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">z</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Ri_spec dual_order.trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="Isotone_Transformers-Ri_prop"><span class="command">lemma</span></span> Ri_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">.</span> Ri <span class="free">x</span> <span class="free">y</span> <span class="bound">z</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Ri_least Ri_spec_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Isotone_Transformers-iso_Ri"><span class="command">lemma</span></span> iso_Ri<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>Ri <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mono_def Ri_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Inf_mono<span class="main">)</span> 

<span class="keyword1" id="Isotone_Transformers-Ri_weaken"><span class="command">lemma</span></span> Ri_weaken<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">x'</span> <span class="main">⟹</span>  <span class="free">y'</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> Ri <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">≤</span> Ri <span class="free">x'</span> <span class="free">y'</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> H_iso_cond2 Ri_least Ri_spec iso_Ri order.trans<span class="main">)</span>
 
<span class="keyword1" id="Isotone_Transformers-Ri_seq"><span class="command">lemma</span></span> Ri_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"Ri <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">≤</span> Ri <span class="free">x</span> <span class="free">w</span> <span class="main">(</span>Ri <span class="free">w</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> H_iso_cond2 Ri_prop Ri_spec iso_Ri iso_fcomp o_apply<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-Ri_seq_var"><span class="command">lemma</span></span> Ri_seq_var<span class="main">:</span> <span class="quoted"><span class="quoted">"Ri <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">≤</span> <span class="main">(</span><span class="main">(</span>Ri <span class="free">x</span> <span class="free">w</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span>Ri <span class="free">w</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ri_seq<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-Ri_Inf"><span class="command">lemma</span></span> Ri_Inf<span class="main">:</span> <span class="quoted"><span class="quoted">" Ri <span class="main">(</span><span class="main">⨅</span> <span class="free">X</span><span class="main">)</span> <span class="free">y</span> <span class="free">z</span> <span class="main">≤</span> <span class="main">⨅</span><span class="main">{</span>Ri <span class="bound">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Inf_greatest<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ri_weaken Inf_lower<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-Ri_weak_iter"><span class="command">lemma</span></span> Ri_weak_iter<span class="main">:</span> <span class="quoted"><span class="quoted">"Ri <span class="free">x</span> <span class="free">x</span> <span class="free">y</span>  <span class="main">≤</span> fiter_id <span class="main">(</span>Ri <span class="free">x</span> <span class="free">x</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_weak_loop Ri_least Ri_spec iso_Ri iso_fiter<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-Ri_cond"><span class="command">lemma</span></span> Ri_cond<span class="main">:</span> <span class="quoted"><span class="quoted">"Ri <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">≤</span> <span class="main">(</span>inf <span class="main">(</span><span class="main">⌊</span><span class="free">p</span><span class="main">⌋</span> <span class="main">∘</span> <span class="main">(</span>Ri <span class="main">(</span><span class="free">p</span> <span class="main">⊓</span> <span class="free">x</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">⌊</span><span class="free">q</span><span class="main">⌋</span> <span class="main">∘</span> <span class="main">(</span>Ri <span class="main">(</span><span class="free">q</span> <span class="main">⊓</span> <span class="free">x</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> H_iso_cond Ri_least Ri_spec bqtran_iso iso_Ri iso_fcomp iso_finf<span class="main">)</span>

<span class="keyword1" id="Isotone_Transformers-Ri_loop"><span class="command">lemma</span></span> Ri_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"Ri <span class="free">x</span> <span class="main">(</span><span class="free">q</span> <span class="main">⊓</span> <span class="free">x</span><span class="main">)</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">(</span><span class="main">(</span>fiter_id <span class="main">(</span><span class="main">⌊</span><span class="free">p</span><span class="main">⌋</span> <span class="main">∘</span> <span class="main">(</span>Ri <span class="main">(</span><span class="free">x</span> <span class="main">⊓</span> <span class="free">p</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">⌊</span><span class="free">q</span><span class="main">⌋</span><span class="main">)</span> <span class="main">(</span><span class="free">q</span> <span class="main">⊓</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">⊓</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> Ri <span class="main">(</span><span class="free">p</span> <span class="main">⊓</span> <span class="free">x</span><span class="main">)</span> <span class="free">x</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ri_spec<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="main">(</span>fiter_id <span class="main">(</span><span class="main">⌊</span><span class="free">p</span><span class="main">⌋</span> <span class="main">∘</span> <span class="main">(</span>Ri <span class="main">(</span><span class="free">x</span> <span class="main">⊓</span> <span class="free">p</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">⌊</span><span class="free">q</span><span class="main">⌋</span><span class="main">)</span> <span class="main">(</span><span class="free">q</span> <span class="main">⊓</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> H_iso_loop inf_commute iso_Ri<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Ri_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bqtran_iso inf_mono iso_Ri iso_fcomp iso_fiter mono_def order_refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sup_Inf_Preserving_Transformers">
<div class="head">
<h1>Theory Sup_Inf_Preserving_Transformers</h1>
</div>
<pre class="source"><span class="comment1">(* 
  Title: Sup- and Inf-Preserving Transformers Between Complete Lattices
  Author: Georg Struth 
  Maintainer: Georg Struth &lt;g.struth@sheffield.ac.uk&gt; 
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Sup- and Inf-Preserving Transformers between Complete Lattices›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sup_Inf_Preserving_Transformers       
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Isotone_Transformers.html">Isotone_Transformers</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Properties›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definitions and basic properties of Sup-preserving and Inf-preserving functions can be found in the Lattice components.
The main purose of the lemmas that follow is to bring properties of isotone transformers into scope.›</span></span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Sup_pres_iso"><span class="command">lemma</span></span> Sup_pres_iso<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_supdistl_iso<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Inf_pres_iso"><span class="command">lemma</span></span> Inf_pres_iso<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_subdistl_iso<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-sup_pres_iso"><span class="command">lemma</span></span> sup_pres_iso<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sup_pres <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_iff_sup mono_def<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-inf_pres_iso"><span class="command">lemma</span></span> inf_pres_iso<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inf_pres <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf.absorb_iff2 monoI<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Sup_sup_dual"><span class="command">lemma</span></span> Sup_sup_dual<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Sup_dual <span class="free">f</span> <span class="main">⟹</span> sup_dual <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> comp_eq_elim image_empty image_insert inf_Inf sup_Sup<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Inf_inf_dual"><span class="command">lemma</span></span> Inf_inf_dual<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inf_dual <span class="free">f</span> <span class="main">⟹</span> inf_dual <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> comp_eq_elim image_empty image_insert inf_Inf sup_Sup<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Sup_bot_dual"><span class="command">lemma</span></span> Sup_bot_dual<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"Sup_dual <span class="free">f</span> <span class="main">⟹</span> bot_dual <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> INF_empty Sup_empty comp_eq_elim<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Inf_top_dual"><span class="command">lemma</span></span> Inf_top_dual<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inf_dual <span class="free">f</span> <span class="main">⟹</span> top_dual <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Inf_empty SUP_empty comp_eq_elim<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next I show some basic preservation properties.›</span></span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Sup_dual2"><span class="command">lemma</span></span> Sup_dual2<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_dual <span class="free">f</span> <span class="main">⟹</span> Inf_dual <span class="free">g</span> <span class="main">⟹</span> Sup_pres <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff image_comp<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Inf_dual2"><span class="command">lemma</span></span> Inf_dual2<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_dual <span class="free">f</span> <span class="main">⟹</span> Inf_dual <span class="free">g</span> <span class="main">⟹</span> Inf_pres <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff image_comp<span class="main">)</span>
 
<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Sup_pres_id"><span class="command">lemma</span></span> Sup_pres_id<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Inf_pres_id"><span class="command">lemma</span></span> Inf_pres_id<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Sup_pres_comp"><span class="command">lemma</span></span> Sup_pres_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">f</span> <span class="main">⟹</span> Sup_pres <span class="free">g</span> <span class="main">⟹</span> Sup_pres <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff image_comp<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Inf_pres_comp"><span class="command">lemma</span></span> Inf_pres_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">f</span> <span class="main">⟹</span> Inf_pres <span class="free">g</span> <span class="main">⟹</span> Inf_pres<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff image_comp<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Sup_pres_Sup"><span class="command">lemma</span></span> Sup_pres_Sup<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> Sup_pres <span class="bound">f</span> <span class="main">⟹</span> Sup_pres <span class="main">(</span><span class="main">⨆</span><span class="free">F</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∘</span> Sup <span class="main">=</span> Sup <span class="main">∘</span> image <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∘</span> Sup <span class="main">≤</span> Sup <span class="main">∘</span> image <span class="main">(</span><span class="main">⨆</span><span class="free">F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SUP_subset_mono Sup_upper le_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span><span class="free">F</span><span class="main">)</span> <span class="main">∘</span> Sup <span class="main">≤</span> Sup <span class="main">∘</span> image <span class="main">(</span><span class="main">⨆</span><span class="free">F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SUP_le_iff le_fun_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_pres_iso h antisym iso_Sup_supdistl iso_fSup<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Inf_pres_Inf"><span class="command">lemma</span></span> Inf_pres_Inf<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> Inf_pres <span class="bound">f</span> <span class="main">⟹</span> Inf_pres <span class="main">(</span><span class="main">⨅</span><span class="free">F</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∘</span> Inf <span class="main">=</span> Inf <span class="main">∘</span> image <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> Inf <span class="main">∘</span> image <span class="main">(</span><span class="main">⨅</span><span class="free">F</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">f</span> <span class="main">∘</span> Inf"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_fun_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">meson</span> INF_lower INF_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">∘</span> image <span class="main">(</span><span class="main">⨅</span><span class="free">F</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">⨅</span><span class="free">F</span><span class="main">)</span> <span class="main">∘</span> Inf"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_INF_iff le_fun_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_pres_iso h antisym iso_Inf_subdistl iso_fInf<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Sup_pres_sup"><span class="command">lemma</span></span> Sup_pres_sup<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">f</span> <span class="main">⟹</span> Sup_pres <span class="free">g</span> <span class="main">⟹</span> Sup_pres <span class="main">(</span><span class="free">f</span> <span class="main">⊔</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sup_pres_Sup insert_iff singletonD sup_Sup<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Inf_pres_inf"><span class="command">lemma</span></span> Inf_pres_inf<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">f</span> <span class="main">⟹</span> Inf_pres <span class="free">g</span> <span class="main">⟹</span> Inf_pres <span class="main">(</span><span class="free">f</span> <span class="main">⊓</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Inf_pres_Inf inf_Inf insert_iff singletonD<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Sup_pres_botf"><span class="command">lemma</span></span> Sup_pres_botf<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⊥</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It is important to note that $\lambda x. \bot$ is not Inf-preserving and that $\lambda x. \top$ is not Sup-preserving.›</span></span>
 
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⊥</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice<span class="main">)</span>"</span></span> <span class="comment1">(*nitpick[show_all]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Sup_pres <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⊤</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice<span class="main">)</span>"</span></span> <span class="comment1">(*nitpick[show_all]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Inf_pres_topf"><span class="command">lemma</span></span> Inf_pres_topf<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⊤</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In complete boolean algebras, complementation yields an explicit variant of duality, which 
can be expressed within the language.›</span></span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-uminus_galois"><span class="command">lemma</span></span> uminus_galois<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_boolean_algebra <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_boolean_algebra_alt"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>uminus <span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>uminus <span class="free">g</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> double_compl <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-uminus_galois_var"><span class="command">lemma</span></span> uminus_galois_var<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_boolean_algebra_alt_with_dual <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_boolean_algebra_alt_with_dual"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∂</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∂</span> <span class="main">∘</span> <span class="free">g</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-uminus_galois_var2"><span class="command">lemma</span></span> uminus_galois_var2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_boolean_algebra_alt_with_dual <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_boolean_algebra_alt_with_dual"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="main">∂</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="main">∂</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-uminus_mono_iff"><span class="command">lemma</span></span> uminus_mono_iff<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_boolean_algebra_alt_with_dual <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_boolean_algebra_alt_with_dual"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∂</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="main">∂</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uminus_galois_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-uminus_epi_iff"><span class="command">lemma</span></span> uminus_epi_iff<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_boolean_algebra_alt_with_dual <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_boolean_algebra_alt_with_dual"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="main">∂</span> <span class="main">=</span> <span class="free">g</span> <span class="main">∘</span> <span class="main">∂</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uminus_galois_var2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Inf_pres_Sup_pres"><span class="command">lemma</span></span> Inf_pres_Sup_pres<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_boolean_algebra_alt_with_dual <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_boolean_algebra_alt_with_dual"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inf_pres <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Sup_pres <span class="main">(</span><span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_pres_map_dual_var<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-Sup_pres_Inf_pres"><span class="command">lemma</span></span> Sup_pres_Inf_pres<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_boolean_algebra_alt_with_dual <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_boolean_algebra_alt_with_dual"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Sup_pres <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Inf_pres <span class="main">(</span><span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_pres_map_dual_var<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of the Kleene Star›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹I develop the star for Inf-preserving functions only. This is suitable for weakest liberal preconditions. 
The case of sup-preserving functions is dual, and straightforward. The main difference to isotone transformers is that Kleene's fixpoint theorem
now applies, that is, the star can be represented by iteration.›</span></span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-H_Inf_pres_fpower"><span class="command">lemma</span></span>  H_Inf_pres_fpower<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">f</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> fpower <span class="free">f</span> <span class="free">i</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> H_iso_cond2 Inf_pres_iso <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-H_Inf_pres_fstar"><span class="command">lemma</span></span> H_Inf_pres_fstar<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">f</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> fstar <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_Inf_pres_fpower fstar_def le_INF_iff<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-fpower_Inf_pres"><span class="command">lemma</span></span> fpower_Inf_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">f</span> <span class="main">⟹</span> Inf_pres <span class="main">(</span>fpower <span class="free">f</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_pres_comp<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-fstar_Inf_pres"><span class="command">lemma</span></span> fstar_Inf_pres<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">f</span> <span class="main">⟹</span> Inf_pres <span class="main">(</span>fstar <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fstar_def Inf_pres_Inf fpower_Inf_pres<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-fstar_unfoldl_var"><span class="command">lemma</span></span> fstar_unfoldl_var <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">f</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊓</span> <span class="free">f</span> <span class="main">(</span>fstar <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> fstar <span class="free">f</span> <span class="free">x</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊓</span> <span class="free">f</span> <span class="main">(</span>fstar <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> fpower <span class="free">f</span> <span class="main">0</span> <span class="free">x</span> <span class="main">⊓</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">n</span><span class="main">.</span> fpower <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fstar_def image_comp<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> comp_apply hyp image_image<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">n</span><span class="main">.</span> fpower <span class="free">f</span> <span class="bound">n</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fInf_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fstar_def image_comp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-fstar_fiter_id"><span class="command">lemma</span></span> fstar_fiter_id<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">f</span> <span class="main">⟹</span> fstar <span class="free">f</span> <span class="main">=</span> fiter_id <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fstar <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⊓</span> <span class="free">f</span> <span class="main">(</span>fstar <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyp<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"fstar <span class="free">f</span> <span class="skolem">x</span> <span class="main">≤</span> gfp <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">⊓</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gfp_upperbound order_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">⊓</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">≤</span> fstar <span class="free">f</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> H_Inf_pres_fstar H_iso_cond2 Inf_pres_iso fstar_Inf_pres hyp le_infE<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fstar <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> gfp <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">⊓</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a antisym gfp_least<span class="main">)</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff Inf_pres_iso fstar_pred_char hyp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-fstar_unfoldl"><span class="command">lemma</span></span> fstar_unfoldl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">f</span> <span class="main">⟹</span> id <span class="main">⊓</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> fstar <span class="free">f</span><span class="main">)</span> <span class="main">=</span> fstar <span class="free">f</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-fpower_Inf_comm"><span class="command">lemma</span></span> fpower_Inf_comm<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">i</span><span class="main">.</span> fpower <span class="free">f</span> <span class="bound">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">i</span><span class="main">.</span> fpower <span class="free">f</span> <span class="bound">i</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">i</span><span class="main">.</span> fpower <span class="free">f</span> <span class="bound">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">i</span><span class="main">.</span> fpower <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff image_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">(</span><span class="main">⨅</span><span class="bound">i</span><span class="main">.</span> fpower <span class="free">f</span> <span class="bound">i</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_eq_dest_lhs fun_mon.power_Suc2<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-fstar_comm"><span class="command">lemma</span></span> fstar_comm<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∘</span> fstar <span class="free">f</span> <span class="main">=</span> fstar <span class="free">f</span> <span class="main">∘</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff fstar_def image_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> INF_cong comp_eq_dest fun_mon.power_commutes<span class="main">)</span>

<span class="keyword1" id="Sup_Inf_Preserving_Transformers-fstar_unfoldr"><span class="command">lemma</span></span> fstar_unfoldr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">f</span> <span class="main">⟹</span> id <span class="main">⊓</span> <span class="main">(</span>fstar <span class="free">f</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> fstar <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fstar_comm fstar_unfoldl <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Quantales of Inf- and Top-Preserving Transformers›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As for itotone transformers, types must now be restricted to a single one. It is well known that Inf-preserving transformers need not be
top-preserving, and that Sup-preserving transformers need not be bot-preserving. This has been shown elsewhere. This does not affect the following proof, 
but it has an impact on how elements are represented. I show only the result for Inf-preserving transformers; that for Sup-preserving ones is dual.›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="tfree">'a</span> Inf_pres <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">.</span> Inf_pres <span class="bound">f</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Inf_pres_topf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_Inf_pres

<span class="keyword1"><span class="command">instantiation</span></span> Inf_pres <span class="main">::</span> <span class="main">(</span><span class="quoted">complete_lattice</span><span class="main">)</span> <span class="quoted">unital_Sup_quantale</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">one_Inf_pres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice Inf_pres"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">id</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iso_id<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">times_Inf_pres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice Inf_pres <span class="main">⇒</span> <span class="tfree">'a</span> Inf_pres <span class="main">⇒</span> <span class="tfree">'a</span> Inf_pres"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(∘)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_pres_comp<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">Sup_Inf_pres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>complete_lattice Inf_pres set <span class="main">⇒</span> <span class="tfree">'a</span> Inf_pres"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">Inf</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_pres_Inf<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_eq_Inf_pres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Inf_pres <span class="main">⇒</span> <span class="tfree">'a</span> Inf_pres <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(≥)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span>  <span class="class_parameter">less_Inf_pres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Inf_pres <span class="main">⇒</span> <span class="tfree">'a</span> Inf_pres <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(&gt;)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_assoc Inf_lower Inf_greatest fInf_distr_var fInf_distl_var<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Three comments seem worth making. Firstly, the result bakes in duality by considering Infs in the function space as 
Sups in the quantale, hence as Infs in the dual quantale. Secondly, the use of Sup-quantales not only reduces the number of proof obligations.
It also copes with the fact that Sups and top are not represented faithfully by this construction. They are generally different from
those in the super-quantale of isotone transformers. But of course they can be defined from Infs as usual. Alternatively, I could have 
proved the results for Inf-quantales, which may have been more straightforward. But Sup-lattices are more conventional.
Thirdly, as in the case of isotone transformers, the proof depends on a restriction to one single type, whereas previous results have 
been obtained for poly-typed quantales or quantaloids.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Powerset_Monad">
<div class="head">
<h1>Theory Powerset_Monad</h1>
</div>
<pre class="source"><span class="comment1">(* 
  Title: The Powerset Monad, State Transformers and Predicate Transformers
  Author: Georg Struth 
  Maintainer: Georg Struth &lt;g.struth@sheffield.ac.uk&gt; 
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Powerset Monad, State Transformers and Predicate Transformers›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Powerset_Monad

<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Order_Lattice_Props/Order_Lattice_Props.html">Order_Lattice_Props.Order_Lattice_Props</a>"</span> 

<span class="keyword2"><span class="keyword">begin</span></span>          

<span class="keyword1"><span class="command">notation</span></span> relcomp <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">;</span>"</span> 75<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">and</span></span> image <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒫</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Powerset Monad›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First I recall functoriality of the powerset functor.›</span></span>

<span class="keyword1" id="Powerset_Monad-P_func1"><span class="command">lemma</span></span> P_func1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒫</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">𝒫</span> <span class="free">f</span> <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Powerset_Monad-P_func2"><span class="command">lemma</span></span> P_func2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒫</span> id <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Isabelle' type systems doesn't allow formalising arbitrary monads, but instances such as the powerset monad
can still be developed.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">eta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">η</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">η</span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">mu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">μ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">μ</span></span> <span class="main">≡</span> Union"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$\eta$ and $\mu$ are natural transformations.›</span></span>

<span class="keyword1" id="Powerset_Monad-eta_nt"><span class="command">lemma</span></span> eta_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒫</span> <span class="free">f</span> <span class="main">∘</span> <span class="keyword1">η</span> <span class="main">=</span> <span class="keyword1">η</span> <span class="main">∘</span> id <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  
<span class="keyword1" id="Powerset_Monad-mu_nt"><span class="command">lemma</span></span> mu_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">μ</span> <span class="main">∘</span> <span class="main">(</span><span class="keyword1">𝒫</span> <span class="main">∘</span> <span class="keyword1">𝒫</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">f</span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1">μ</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹They satisfy the following coherence conditions. Explicit typing clarifies that $\eta$ and $\mu$ have different type in these expressions.›</span></span>
 
<span class="keyword1" id="Powerset_Monad-pow_assoc"><span class="command">lemma</span></span> pow_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">μ</span><span class="main">::</span><span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="main">(</span><span class="keyword1">μ</span><span class="main">::</span><span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">μ</span> <span class="main">::</span><span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="keyword1">μ</span><span class="main">::</span><span class="tfree">'a</span> set set set <span class="main">⇒</span> <span class="tfree">'a</span> set set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fun_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Powerset_Monad-pow_un1"><span class="command">lemma</span></span> pow_un1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">μ</span><span class="main">::</span><span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="keyword1">𝒫</span> <span class="main">(</span><span class="keyword1">η</span><span class="main">::</span> <span class="tfree">'a</span>  <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>id<span class="main">::</span><span class="tfree">'a</span> set  <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fun_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  
<span class="keyword1" id="Powerset_Monad-pow_un2"><span class="command">lemma</span></span> pow_un2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">μ</span><span class="main">::</span><span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="keyword1">η</span><span class="main">::</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set set<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>id<span class="main">::</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fun_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Thus the powerset monad is indeed a monad.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Kleisli Category of the Powerset Monad›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next I define the Kleisli composition and Kleisli lifting (Kleisli extension) of Kleisli arrows. 
The Kleisli lifting turns Kleisli arrows into forward predicate transformers.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kcomp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span>  <span class="main">⇒</span> <span class="tfree">'c</span> set<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1"><span class="free">∘<span class="hidden">⇩</span><sub>K</sub></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="keyword1">μ</span> <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>     

<span class="keyword1" id="Powerset_Monad-kcomp_prop"><span class="command">lemma</span></span> kcomp_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="free">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kcomp_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">klift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="hidden">⇧</span><sup>†</sup></span>"</span> <span class="main">[</span>101<span class="main">]</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free"><span class="hidden">⇧</span><sup>†</sup></span></span> <span class="main">=</span> <span class="keyword1">μ</span> <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1" id="Powerset_Monad-klift_prop"><span class="command">lemma</span></span> klift_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> klift_def<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-kcomp_klift"><span class="command">lemma</span></span> kcomp_klift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span> <span class="main">=</span> <span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">∘</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kcomp_def klift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Powerset_Monad-klift_prop1"><span class="command">lemma</span></span> klift_prop1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="free">f</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">∘</span> <span class="free">g</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff klift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Powerset_Monad-klift_eta_inv1"><span class="command">lemma</span></span> klift_eta_inv1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">∘</span> <span class="keyword1">η</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff klift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Powerset_Monad-klift_eta_pres"><span class="command">lemma</span></span> klift_eta_pres <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">η</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="main">(</span>id<span class="main">::</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff klift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Powerset_Monad-klift_id_pres"><span class="command">lemma</span></span> klift_id_pres <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"id<span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="keyword1">μ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> klift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Powerset_Monad-kcomp_assoc"><span class="command">lemma</span></span> kcomp_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">h</span> <span class="main">=</span> <span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kcomp_klift klift_prop1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Powerset_Monad-kcomp_idl"><span class="command">lemma</span></span> kcomp_idl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">η</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kcomp_klift <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Powerset_Monad-kcomp_idr"><span class="command">lemma</span></span> kcomp_idr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="keyword1">η</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kcomp_klift <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following interpretation statement, types are restricted.
This is needed for defining iteration.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> kmon<span class="main">:</span> monoid_mult <span class="quoted"><span class="quoted">"<span class="keyword1">η</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(∘<span class="hidden">⇩</span><sub>K</sub>)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kcomp_assoc<span class="main">)</span>
 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next I show that $\eta$ is a (contravariant) functor from Set into the Kleisli category of the powerset monad.
It simply turns functions into Kleisli arrows.›</span></span>

<span class="keyword1" id="Powerset_Monad-eta_func1"><span class="command">lemma</span></span> eta_func1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">η</span> <span class="main">∘</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">η</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">(</span><span class="keyword1">η</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff kcomp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Eilenberg-Moore Algebra›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It is well known that the Eilenberg-Moore algebras of the powerset monad form complete join semilattices (hence Sup-lattices).›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First I verify that every complete lattice with structure map Sup satisfies the laws of Eilenberg-Moore algebras.›</span></span>

<span class="keyword1"><span class="command">notation</span></span> Sup <span class="main">(</span><span class="quoted">"<span class="keyword1">σ</span>"</span><span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-em_assoc"><span class="command">lemma</span></span> em_assoc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">σ</span> <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="main">(</span><span class="keyword1">σ</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice set <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ</span> <span class="main">∘</span> <span class="keyword1">μ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> antisym<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SUP_least Sup_subset_mono Sup_upper<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> SUP_upper2 Sup_least Sup_upper UnionE comp_def<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-em_id"><span class="command">lemma</span></span> em_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">σ</span> <span class="main">∘</span> <span class="keyword1">η</span> <span class="main">=</span> <span class="main">(</span>id<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Hence every Sup-lattice is an Eilenberg-Moore algebra for the powerset monad. 
The morphisms between Eilenberg-Moore algebras of the powerset monad are Sup-preserving maps. 
In particular, powersets with structure map $\mu$ form an Eilenberg-Moore algebra (in fact the free one):›</span></span>

<span class="keyword1" id="Powerset_Monad-em_mu_assoc"><span class="command">lemma</span></span> em_mu_assoc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">μ</span> <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="keyword1">μ</span> <span class="main">=</span> <span class="keyword1">μ</span> <span class="main">∘</span> <span class="keyword1">μ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 
<span class="keyword1" id="Powerset_Monad-em_mu_id"><span class="command">lemma</span></span> em_mu_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">μ</span> <span class="main">∘</span> <span class="keyword1">η</span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next I show that every Eilenberg-Moore algebras for the 
powerset functor is a Sup-lattice.›</span></span>

<span class="keyword1"><span class="command">class</span></span> eilenberg_moore_pow <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">smap</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> smap_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">smap</span> <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="free">smap</span> <span class="main">=</span> <span class="free">smap</span> <span class="main">∘</span> <span class="keyword1">μ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> smap_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">smap</span> <span class="main">∘</span> <span class="keyword1">η</span> <span class="main">=</span> id"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sleq</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> smap <span class="main">{</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">}</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sle</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> sleq <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≠</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Powerset_Monad-smap_un1"><span class="command">lemma</span></span> smap_un1<span class="main">:</span> <span class="quoted"><span class="quoted">"smap <span class="main">{</span><span class="free">x</span><span class="main">,</span> smap <span class="free">Y</span><span class="main">}</span> <span class="main">=</span> smap <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">{</span><span class="free">x</span><span class="main">,</span> smap <span class="free">Y</span><span class="main">}</span> <span class="main">=</span> smap <span class="main">{</span>smap <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">,</span> smap <span class="free">Y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_apply id_apply smap_id<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>smap <span class="main">∘</span> <span class="keyword1">𝒫</span> smap<span class="main">)</span> <span class="main">{</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">,</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> local.smap_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Powerset_Monad-smap_comm"><span class="command">lemma</span></span> smap_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"smap <span class="main">{</span><span class="free">x</span><span class="main">,</span> smap <span class="free">Y</span><span class="main">}</span> <span class="main">=</span> smap <span class="main">{</span>smap <span class="free">Y</span><span class="main">,</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-smap_un2"><span class="command">lemma</span></span> smap_un2<span class="main">:</span> <span class="quoted"><span class="quoted">"smap <span class="main">{</span>smap <span class="free">X</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> smap <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> smap_comm smap_un1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Powerset_Monad-sleq_refl"><span class="command">lemma</span></span> sleq_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"sleq <span class="free">x</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> id_apply insert_absorb2 local.smap_id o_apply sleq_def<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-sleq_trans"><span class="command">lemma</span></span> sleq_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"sleq <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> sleq <span class="free">y</span> <span class="free">z</span> <span class="main">⟹</span> sleq <span class="free">x</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> sleq_def smap_un1 smap_un2 sup_assoc<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-sleq_antisym"><span class="command">lemma</span></span> sleq_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"sleq <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> sleq <span class="free">y</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute sleq_def<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-smap_ub"><span class="command">lemma</span></span> smap_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> sleq <span class="free">x</span> <span class="main">(</span>smap <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> insert_absorb sleq_def smap_un1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Powerset_Monad-smap_lub"><span class="command">lemma</span></span> smap_lub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> sleq <span class="bound">x</span> <span class="free">z</span><span class="main">)</span> <span class="main">⟹</span> sleq <span class="main">(</span>smap <span class="free">A</span><span class="main">)</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> sleq <span class="bound">x</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">{</span>smap <span class="free">A</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span> <span class="main">=</span> smap <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="main">{</span><span class="free">z</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> smap_un2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> smap <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">,</span><span class="free">z</span><span class="main">}</span><span class="main">)</span>  <span class="main">∪</span> <span class="main">{</span><span class="free">z</span><span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> f<span class="main"><span class="main">=</span></span><span class="quoted">smap</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> arg_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> smap <span class="main">{</span><span class="main">(</span>smap <span class="main">∘</span> <span class="keyword1">μ</span><span class="main">)</span> <span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">,</span><span class="free">z</span><span class="main">}</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Setcompr_eq_image smap_un2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> smap <span class="main">{</span><span class="main">(</span>smap <span class="main">∘</span> <span class="keyword1">𝒫</span> smap<span class="main">)</span> <span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">,</span><span class="free">z</span><span class="main">}</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.smap_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> smap <span class="main">{</span>smap <span class="main">{</span>smap <span class="main">{</span><span class="bound">x</span><span class="main">,</span><span class="free">z</span><span class="main">}</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Setcompr_eq_image image_image<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> smap <span class="main">{</span>smap <span class="main">{</span><span class="free">z</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> h sleq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> smap <span class="main">(</span><span class="main">{</span><span class="free">z</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">z</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> smap_un2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> smap <span class="main">{</span><span class="free">z</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> f<span class="main"><span class="main">=</span></span><span class="quoted">smap</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> arg_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> sleq_def sleq_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> smap_Sup_lat<span class="main">:</span> Sup_lattice <span class="quoted">smap</span> <span class="quoted">sleq</span> <span class="quoted">sle</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sleq_refl sleq_antisym sleq_trans smap_ub smap_lub<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Hence every complete lattice is an Eilenberg-Moore algebra of $\mathcal{P}$.›</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> Sup <span class="main">(</span><span class="quoted">"<span class="keyword1">σ</span>"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Isomorphism between Kleisli Category and Rel›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is again well known---the isomorphism is essentially curry vs uncurry. Kleisli arrows are nondeterministic functions; 
they are also known as state transformers.  Binary relations are very well developed in Isabelle; Kleisli composition of Kleisli 
arrows isn't. Ideally one should therefore use the isomorphism to transport theorems from relations to Kleisli arrows automatically. 
I spell out the isomorphisms and prove that the full quantalic structure, that is, complete lattices plus compositions, 
is preserved by the isomorphisms.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">kzero</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ζ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ζ</span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First I define the morphisms. The second one is nothing but the graph of a function.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r2f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℱ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℱ</span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> Image <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∘</span> <span class="keyword1">η</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">f2r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℛ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℛ</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The functors form a bijective pair.›</span></span>

<span class="keyword1" id="Powerset_Monad-r2f2r_inv1"><span class="command">lemma</span></span> r2f2r_inv1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ</span> <span class="main">∘</span> <span class="keyword1">ℱ</span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> f2r_def r2f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Powerset_Monad-f2r2f_inv2"><span class="command">lemma</span></span> f2r2f_inv2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span> <span class="main">∘</span> <span class="keyword1">ℛ</span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> f2r_def r2f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Powerset_Monad-r2f_f2r_galois"><span class="command">lemma</span></span> r2f_f2r_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ℛ</span> <span class="free">f</span> <span class="main">=</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ℱ</span> <span class="free">R</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f2r_def r2f_def<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-r2f_f2r_galois_var"><span class="command">lemma</span></span> r2f_f2r_galois_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ℛ</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ℱ</span> <span class="main">∘</span> <span class="free">R</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f2r_def r2f_def<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-r2f_f2r_galois_var2"><span class="command">lemma</span></span> r2f_f2r_galois_var2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="keyword1">ℛ</span> <span class="main">=</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="main">∘</span> <span class="keyword1">ℱ</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> comp_id f2r2f_inv2 map_fun_def o_assoc r2f2r_inv1<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-r2f_inj"><span class="command">lemma</span></span> r2f_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="keyword1">ℱ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> inj_on_inverseI r2f_f2r_galois<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-f2r_inj"><span class="command">lemma</span></span> f2r_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inj_def <span class="keyword1"><span class="command">using</span></span> r2f_f2r_galois <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Powerset_Monad-r2f_mono"><span class="command">lemma</span></span> r2f_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="keyword1">ℱ</span> <span class="main">∘</span> <span class="bound">f</span> <span class="main">=</span> <span class="keyword1">ℱ</span> <span class="main">∘</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="main">=</span> <span class="bound">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff r2f_def<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-f2r_mono"><span class="command">lemma</span></span> f2r_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="keyword1">ℛ</span> <span class="main">∘</span> <span class="bound">f</span> <span class="main">=</span> <span class="keyword1">ℛ</span> <span class="main">∘</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="main">=</span> <span class="bound">g</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff f2r_def<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-r2f_mono_iff"><span class="command">lemma</span></span> r2f_mono_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ℱ</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">ℱ</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r2f_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Powerset_Monad-f2r_mono_iff"><span class="command">lemma</span></span> f2r_mono_iff <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ℛ</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">ℛ</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> f2r_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Powerset_Monad-r2f_inj_iff"><span class="command">lemma</span></span> r2f_inj_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ℛ</span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">ℛ</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f2r_inj inj_eq<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-f2r_inj_iff"><span class="command">lemma</span></span> f2r_inj_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ℱ</span> <span class="free">R</span> <span class="main">=</span> <span class="keyword1">ℱ</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="main">=</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r2f_inj inj_eq<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-r2f_surj"><span class="command">lemma</span></span> r2f_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"surj <span class="keyword1">ℱ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> r2f_f2r_galois surj_def<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-f2r_surj"><span class="command">lemma</span></span> f2r_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"surj <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r2f_f2r_galois <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Powerset_Monad-r2f_epi"><span class="command">lemma</span></span> r2f_epi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∘</span> <span class="keyword1">ℱ</span> <span class="main">=</span> <span class="bound">g</span> <span class="main">∘</span> <span class="keyword1">ℱ</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="main">=</span> <span class="bound">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> r2f_f2r_galois_var2<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-f2r_epi"><span class="command">lemma</span></span> f2r_epi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∘</span> <span class="keyword1">ℛ</span> <span class="main">=</span> <span class="bound">g</span> <span class="main">∘</span> <span class="keyword1">ℛ</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="main">=</span> <span class="bound">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> r2f_f2r_galois_var2<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-r2f_epi_iff"><span class="command">lemma</span></span> r2f_epi_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="keyword1">ℱ</span> <span class="main">=</span> <span class="free">g</span> <span class="main">∘</span> <span class="keyword1">ℱ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r2f_epi <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Powerset_Monad-f2r_epi_iff"><span class="command">lemma</span></span> f2r_epi_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="keyword1">ℛ</span> <span class="main">=</span> <span class="free">g</span> <span class="main">∘</span> <span class="keyword1">ℛ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> f2r_epi <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Powerset_Monad-r2f_bij"><span class="command">lemma</span></span> r2f_bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="keyword1">ℱ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bijI r2f_inj r2f_surj<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-f2r_bij"><span class="command">lemma</span></span> f2r_bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_def f2r_inj f2r_surj<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹r2f is essentially curry and f2r is uncurry, yet in Isabelle the type of sets and predicates 
(boolean-valued functions) are different. Collect transforms predicates into sets and the following function
sets into predicates:›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2p</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Powerset_Monad-r2f_curry"><span class="command">lemma</span></span> r2f_curry<span class="main">:</span> <span class="quoted"><span class="quoted">"r2f <span class="free">R</span> <span class="main">=</span> Collect <span class="main">∘</span> <span class="main">(</span>curry <span class="main">∘</span> s2p<span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r2f_def fun_eq_iff curry_def<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-f2r_uncurry"><span class="command">lemma</span></span> f2r_uncurry<span class="main">:</span> <span class="quoted"><span class="quoted">"f2r <span class="free">f</span> <span class="main">=</span> <span class="main">(</span>Collect <span class="main">∘</span> case_prod<span class="main">)</span> <span class="main">(</span>s2p <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff f2r_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Uncurry is case-prod in Isabelle.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹f2r and r2f preserve the quantalic structures of relations and Kleisli arrows. In particular they are functors.›</span></span>

<span class="keyword1" id="Powerset_Monad-r2f_comp_pres"><span class="command">lemma</span></span> r2f_comp_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span> <span class="main">(</span><span class="free">R</span> <span class="main">;</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℱ</span> <span class="free">R</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="keyword1">ℱ</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff r2f_def kcomp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Powerset_Monad-r2f_Id_pres"><span class="command">lemma</span></span> r2f_Id_pres <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span> Id <span class="main">=</span> <span class="keyword1">η</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff r2f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Powerset_Monad-r2f_Sup_pres"><span class="command">lemma</span></span> r2f_Sup_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="keyword1">ℱ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff r2f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Powerset_Monad-r2f_Sup_pres_var"><span class="command">lemma</span></span> r2f_Sup_pres_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span> <span class="main">(</span><span class="main">⋃</span><span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> <span class="keyword1">ℱ</span> <span class="bound">r</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> r2f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Powerset_Monad-r2f_sup_pres"><span class="command">lemma</span></span> r2f_sup_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_pres <span class="keyword1">ℱ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r2f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Powerset_Monad-r2f_Inf_pres"><span class="command">lemma</span></span> r2f_Inf_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="keyword1">ℱ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff r2f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Powerset_Monad-r2f_Inf_pres_var"><span class="command">lemma</span></span> r2f_Inf_pres_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span> <span class="main">(</span><span class="main">⨅</span><span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> <span class="keyword1">ℱ</span> <span class="bound">r</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> r2f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Powerset_Monad-r2f_inf_pres"><span class="command">lemma</span></span> r2f_inf_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_pres <span class="keyword1">ℱ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r2f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Powerset_Monad-r2f_bot_pres"><span class="command">lemma</span></span> r2f_bot_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"bot_pres <span class="keyword1">ℱ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> SUP_empty Sup_empty r2f_Sup_pres_var<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-r2f_top_pres"><span class="command">lemma</span></span> r2f_top_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"top_pres <span class="keyword1">ℱ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sup_UNIV r2f_Sup_pres_var r2f_surj<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-r2f_leq"><span class="command">lemma</span></span> r2f_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span> <span class="main">⊆</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ℱ</span> <span class="free">R</span> <span class="main">≤</span> <span class="keyword1">ℱ</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_iff_sup r2f_f2r_galois r2f_sup_pres<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Dual statements for f2r hold. Can one automate this?›</span></span>
 
<span class="keyword1" id="Powerset_Monad-f2r_kcomp_pres"><span class="command">lemma</span></span> f2r_kcomp_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℛ</span> <span class="free">f</span> <span class="main">;</span> <span class="keyword1">ℛ</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r2f_f2r_galois r2f_comp_pres pointfree_idE<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-f2r_eta_pres"><span class="command">lemma</span></span> f2r_eta_pres <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ</span> <span class="keyword1">η</span> <span class="main">=</span> Id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r2f_f2r_galois<span class="main">)</span> 

<span class="keyword1" id="Powerset_Monad-f2r_Sup_pres"><span class="command">lemma</span></span> f2r_Sup_pres<span class="main">:</span><span class="quoted"><span class="quoted">"Sup_pres <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r2f_f2r_galois_var comp_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> r2f_Sup_pres image_comp<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-f2r_Sup_pres_var"><span class="command">lemma</span></span> f2r_Sup_pres_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ</span> <span class="main">(</span><span class="main">⨆</span><span class="free">F</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="keyword1">ℛ</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r2f_f2r_galois r2f_Sup_pres_var image_comp<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-f2r_sup_pres"><span class="command">lemma</span></span> f2r_sup_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_pres <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r2f_f2r_galois r2f_sup_pres pointfree_idE<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-f2r_Inf_pres"><span class="command">lemma</span></span> f2r_Inf_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r2f_f2r_galois_var comp_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> r2f_Inf_pres image_comp<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-f2r_Inf_pres_var"><span class="command">lemma</span></span> f2r_Inf_pres_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ</span> <span class="main">(</span><span class="main">⨅</span><span class="free">F</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋂</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="keyword1">ℛ</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r2f_f2r_galois r2f_Inf_pres_var image_comp<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-f2r_inf_pres"><span class="command">lemma</span></span> f2r_inf_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_pres <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r2f_f2r_galois r2f_inf_pres pointfree_idE<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-f2r_bot_pres"><span class="command">lemma</span></span> f2r_bot_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"bot_pres <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r2f_bot_pres r2f_f2r_galois<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-f2r_top_pres"><span class="command">lemma</span></span> f2r_top_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"top_pres <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r2f_f2r_galois r2f_top_pres<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-f2r_leq"><span class="command">lemma</span></span> f2r_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">≤</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ℛ</span> <span class="free">f</span> <span class="main">⊆</span> <span class="keyword1">ℛ</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> r2f_f2r_galois r2f_leq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relational subidentities are isomorphic to particular Kleisli arrows.›</span></span>

<span class="keyword1" id="Powerset_Monad-r2f_Id_on1"><span class="command">lemma</span></span> r2f_Id_on1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span> <span class="main">(</span>Id_on <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff r2f_def Id_on_def<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-r2f_Id_on2"><span class="command">lemma</span></span> r2f_Id_on2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span> <span class="main">(</span>Id_on <span class="free">X</span><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff Id_on_def r2f_def kcomp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Powerset_Monad-r2f_Id_on3"><span class="command">lemma</span></span> r2f_Id_on3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="keyword1">ℱ</span> <span class="main">(</span>Id_on <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">X</span> <span class="main">∩</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kcomp_def r2f_def Id_on_def fun_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The opposite Kleisli Category›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Opposition is funtamental for categories; yet hard to realise in Isabelle in general. Due to the access to relations,
the Kleisli category of the powerset functor is an exception.›</span></span>

<span class="keyword1"><span class="command">notation</span></span> converse <span class="main">(</span><span class="quoted">"<span class="keyword1">⌣</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">op<span class="hidden">⇩</span><sub>K</sub></span></span> <span class="main">=</span> <span class="keyword1">ℱ</span> <span class="main">∘</span> <span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1">ℛ</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Kop is a contravariant functor.›</span></span>

<span class="keyword1" id="Powerset_Monad-kop_contrav"><span class="command">lemma</span></span> kop_contrav<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kop_def r2f_def f2r_def converse_def kcomp_def fun_eq_iff comp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Powerset_Monad-kop_func2"><span class="command">lemma</span></span> kop_func2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="keyword1">η</span> <span class="main">=</span> <span class="keyword1">η</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kop_def r2f_def f2r_def converse_def comp_def fun_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Powerset_Monad-converse_idem"><span class="command">lemma</span></span> converse_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Powerset_Monad-converse_galois"><span class="command">lemma</span></span> converse_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">∘</span> <span class="free">g</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Powerset_Monad-converse_galois2"><span class="command">lemma</span></span> converse_galois2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> converse_converse<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-converse_mono_iff"><span class="command">lemma</span></span> converse_mono_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> converse_galois <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Powerset_Monad-converse_epi_iff"><span class="command">lemma</span></span> converse_epi_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">∘</span> <span class="main">(</span><span class="main">⌣</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> converse_galois2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Powerset_Monad-kop_idem"><span class="command">lemma</span></span> kop_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">=</span> id"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> kop_def comp_def fun_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> converse_converse id_apply r2f_f2r_galois<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-kop_galois"><span class="command">lemma</span></span> kop_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kop_idem pointfree_idE<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-kop_galois_var"><span class="command">lemma</span></span> kop_galois_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="free">g</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> kop_def f2r_def r2f_def converse_def fun_eq_iff<span class="main">)</span>   

<span class="keyword1" id="Powerset_Monad-kop_galois_var2"><span class="command">lemma</span></span> kop_galois_var2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> comp_assoc comp_id kop_idem<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-kop_inj"><span class="command">lemma</span></span> kop_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inj_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f2r_inj_iff kop_def r2f_inj_iff<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-kop_inj_iff"><span class="command">lemma</span></span> kop_inj_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_eq kop_inj<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-kop_surj"><span class="command">lemma</span></span> kop_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"surj <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> surj_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kop_galois<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-kop_bij"><span class="command">lemma</span></span> kop_bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_def kop_inj kop_surj<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-kop_mono"><span class="command">lemma</span></span> kop_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun.inj_map inj_eq kop_inj<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-kop_mono_iff"><span class="command">lemma</span></span> kop_mono_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> kop_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Powerset_Monad-kop_epi"><span class="command">lemma</span></span> kop_epi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">=</span> <span class="free">g</span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kop_galois_var2<span class="main">)</span>

<span class="keyword1" id="Powerset_Monad-kop_epi_iff"><span class="command">lemma</span></span> kop_epi_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">=</span> <span class="free">g</span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> kop_epi <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Powerset_Monad-Sup_pres_kop"><span class="command">lemma</span></span> Sup_pres_kop<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kop_def fun_eq_iff comp_def r2f_def f2r_def converse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Powerset_Monad-Inf_pres_kop"><span class="command">lemma</span></span> Inf_pres_kop<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kop_def fun_eq_iff comp_def r2f_def f2r_def converse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Kleisli_Transformers">
<div class="head">
<h1>Theory Kleisli_Transformers</h1>
</div>
<pre class="source"><span class="comment1">(* 
  Title: State Transformers and Predicate Transformers Based on the Powerset Monad
  Author: Georg Struth 
  Maintainer: Georg Struth &lt;g.struth@sheffield.ac.uk&gt; 
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹State Transformers and Predicate Transformers Based on the Powerset Monad›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Kleisli_Transformers

<span class="keyword2"><span class="keyword">imports</span></span> <a href="Powerset_Monad.html">Powerset_Monad</a> 
        <a href="Sup_Inf_Preserving_Transformers.html">Sup_Inf_Preserving_Transformers</a>
<span class="keyword2"><span class="keyword">begin</span></span>          


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Backward Diamonds from Kleisli Arrows›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First I verify the embedding of the Kleisli category of the powerset functor into its Eilenberg-Moore category. 
This functor maps sets to their mus and functions to their Kleisli liftings. But this is just functoriality of dagger!. 
I model it as a backward diamond operator in the sense of dynamic logic. It corresponds to a strongest postcondition 
operator. In the parlance of program semantics, this is an embedding of state into prediate transformers.›</span></span>

<span class="keyword1"><span class="command">notation</span></span> klift <span class="main">(</span><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹bd stands for backward diamond, the index indicates the setting of Kleisli arrows or nondeterministic 
functions. ifbd is its inverse.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ifbd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∘</span> <span class="keyword1">η</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Kleisli_Transformers-fbd_set"><span class="command">lemma</span></span> fbd_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> klift_prop<span class="main">)</span> 
 
<span class="keyword1" id="Kleisli_Transformers-ifbd_set"><span class="command">lemma</span></span> ifbd_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">φ</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The two functors form a bijective pair.›</span></span>

<span class="keyword1" id="Kleisli_Transformers-fbd_ifbd_inv2"><span class="command">lemma</span></span> fbd_ifbd_inv2<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="main">=</span> <span class="free">φ</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="main">=</span> Sup <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="main">(</span><span class="free">φ</span> <span class="main">∘</span> <span class="keyword1">η</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> klift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Sup <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="free">φ</span> <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="keyword1">η</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_assoc P_func1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">φ</span> <span class="main">∘</span> Sup <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="keyword1">η</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">φ</span> <span class="main">∘</span> id"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kleisli_Transformers-fbd_ifbd_inv2_inv"><span class="command">lemma</span></span> fbd_ifbd_inv2_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="main">=</span> <span class="free">φ</span> <span class="main">⟹</span> Sup_pres <span class="free">φ</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff comp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Inf.INF_cong UN_extend_simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> klift_prop<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-fbd_ifbd_inv2_iff"><span class="command">lemma</span></span> fbd_ifbd_inv2_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="main">=</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Sup_pres <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fbd_ifbd_inv2 fbd_ifbd_inv2_inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Kleisli_Transformers-fbd_inj"><span class="command">lemma</span></span> fbd_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> inj_on_inverseI klift_eta_inv1<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-fbd_inj_iff"><span class="command">lemma</span></span> fbd_inj_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> injD fbd_inj<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-ifbd_inj"><span class="command">lemma</span></span> ifbd_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> Sup_pres <span class="free">ψ</span> <span class="main">⟹</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="main">=</span> <span class="free">ψ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">ψ</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> h1 h2 fbd_ifbd_inv2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kleisli_Transformers-ifbd_inj_iff"><span class="command">lemma</span></span> ifbd_inj_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> Sup_pres <span class="free">ψ</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">φ</span> <span class="main">=</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ifbd_inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Kleisli_Transformers-fbd_ifbd_galois"><span class="command">lemma</span></span> fbd_ifbd_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fbd_ifbd_inv2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Kleisli_Transformers-fbd_surj"><span class="command">lemma</span></span> fbd_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="bound">f</span> <span class="main">=</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fbd_ifbd_inv2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="Kleisli_Transformers-ifbd_surj"><span class="command">lemma</span></span> ifbd_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"surj <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> surj_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> klift_eta_inv1<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In addition they preserve the Sup-quantale structure of the powerset algebra. This means that
morphisms preserve compositions, units and Sups, but not Infs, hence also bottom but not top.›</span></span>

<span class="keyword1" id="Kleisli_Transformers-fbd_comp_pres"><span class="command">lemma</span></span> fbd_comp_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">g</span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kcomp_klift klift_prop1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kleisli_Transformers-fbd_Sup_pres"><span class="command">lemma</span></span> fbd_Sup_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff klift_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-fbd_sup_pres"><span class="command">lemma</span></span> fbd_sup_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_pres <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Sup_sup_pres fbd_Sup_pres <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Kleisli_Transformers-fbd_Disj"><span class="command">lemma</span></span> fbd_Disj<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbd_ifbd_inv2_inv<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-fbd_disj"><span class="command">lemma</span></span> fbd_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_pres <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> klift_prop<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-fbd_bot_pres"><span class="command">lemma</span></span> fbd_bot_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"bot_pres <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> klift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Kleisli_Transformers-fbd_zero_pres2"><span class="command">lemma</span></span> fbd_zero_pres2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> klift_prop<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-fbd_iso"><span class="command">lemma</span></span> fbd_iso<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="main">⟶</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">X</span> <span class="main">⊆</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fbd_disj le_iff_sup<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following counterexamples show that Infs are not preserved.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"top_pres <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span> <span class="comment1">(*nitpick*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"inf_pres <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span> <span class="comment1">(*nitpick*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Dual preservation statements hold for ifbd ... and even Inf-preservation.›</span></span>

<span class="keyword1" id="Kleisli_Transformers-ifbd_comp_pres"><span class="command">lemma</span></span> ifbd_comp_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="main">∘</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">ψ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fbd_ifbd_galois fun.map_comp kcomp_def klift_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-ifbd_Sup_pres"><span class="command">lemma</span></span> ifbd_Sup_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>   
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-ifbd_sup_pres"><span class="command">lemma</span></span> ifbd_sup_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_pres <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Kleisli_Transformers-ifbd_Inf_pres"><span class="command">lemma</span></span> ifbd_Inf_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-ifbd_inf_pres"><span class="command">lemma</span></span> ifbd_inf_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_pres <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Kleisli_Transformers-ifbd_bot_pres"><span class="command">lemma</span></span> ifbd_bot_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"bot_pres <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Kleisli_Transformers-ifbd_top_pres"><span class="command">lemma</span></span> ifbd_top_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"top_pres <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Preservation of units by the Kleisli lifting has been proved in klift-prop3.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These results estabilish the isomorphism between state and predicate transformers given by backward diamonds.
The isomorphism preserves the Sup-quantale structure, but not Infs.›</span></span>
 


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Backward Diamonds from Relations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Using the isomorphism between binary relations and Kleisli arrows (or state transformers), it is straightforward
to define backward diamonds from relations, by composing isomorphisms. It follows that Sup-quantales of binary relations 
(under relational composition, the identity relation and Sups) are isomorphic to the Sup-quantales of predicate transformers.
Once again, Infs are not preserved.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rbd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bd<span class="hidden">⇩</span><sub>ℛ</sub></span></span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">ℱ</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">irbd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span></span> <span class="main">=</span> <span class="keyword1">ℛ</span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>

<span class="keyword1" id="Kleisli_Transformers-rbd_Im"><span class="command">lemma</span></span> rbd_Im<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">=</span> <span class="main">(``)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rbd_def klift_def r2f_def fun_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Kleisli_Transformers-rbd_set"><span class="command">lemma</span></span> rbd_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbd_Im Image_def<span class="main">)</span>
  
<span class="keyword1" id="Kleisli_Transformers-irbd_set"><span class="command">lemma</span></span> irbd_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span><span class="free">φ</span> <span class="main">∘</span> <span class="keyword1">η</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irbd_def f2r_def o_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irbd_set_var"><span class="command">lemma</span></span> irbd_set_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">φ</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irbd_def f2r_def o_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rbd_irbd_inv1"><span class="command">lemma</span></span> rbd_irbd_inv1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> comp_eq_dest_lhs eq_id_iff fbd_Disj fbd_ifbd_galois irbd_def r2f_f2r_galois rbd_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irbd_rbd_inv2"><span class="command">lemma</span></span> irbd_rbd_inv2<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="main">=</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_apply fbd_ifbd_galois irbd_def r2f_f2r_galois rbd_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irbd_rbd_inv2_inv"><span class="command">lemma</span></span> irbd_rbd_inv2_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="main">=</span> <span class="free">φ</span> <span class="main">⟹</span> Sup_pres <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbd_def irbd_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> fbd_Disj<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irbd_rbd_inv2_iff"><span class="command">lemma</span></span> irbd_rbd_inv2_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="main">=</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Sup_pres <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> irbd_rbd_inv2 irbd_rbd_inv2_inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Kleisli_Transformers-rbd_inj"><span class="command">lemma</span></span> rbd_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbd_inj inj_compose r2f_inj rbd_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rbd_translate"><span class="command">lemma</span></span> rbd_translate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="main">=</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbd_inj inj_eq<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irbd_inj"><span class="command">lemma</span></span> irbd_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> Sup_pres <span class="free">ψ</span> <span class="main">⟹</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="main">=</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rbd_Im comp_eq_dest_lhs irbd_rbd_inv2<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irbd_inj_iff"><span class="command">lemma</span></span> irbd_inj_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> Sup_pres <span class="free">ψ</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">φ</span> <span class="main">=</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> irbd_inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Kleisli_Transformers-rbd_surj"><span class="command">lemma</span></span> rbd_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">R</span><span class="main">.</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="bound">R</span> <span class="main">=</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> irbd_rbd_inv2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Kleisli_Transformers-irbd_surj"><span class="command">lemma</span></span> irbd_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"surj <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I fun.set_map imageE rbd_irbd_inv1 surj_def surj_id<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rbd_irbd_galois"><span class="command">lemma</span></span> rbd_irbd_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">φ</span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> comp_apply fbd_ifbd_galois irbd_def r2f_f2r_galois rbd_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rbd_comp_pres"><span class="command">lemma</span></span> rbd_comp_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">(</span><span class="free">R</span> <span class="main">;</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">S</span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbd_def r2f_comp_pres fbd_comp_pres<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rbd_Id_pres"><span class="command">lemma</span></span> rbd_Id_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> Id <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rbd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kleisli_Transformers-rbd_Un_pres"><span class="command">lemma</span></span> rbd_Un_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbd_def Sup_pres_comp fbd_Sup_pres r2f_Sup_pres<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rbd_un_pres"><span class="command">lemma</span></span> rbd_un_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_pres <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbd_def fbd_sup_pres r2f_sup_pres<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"inf_pres <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span> <span class="comment1">(*nitpick*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1" id="Kleisli_Transformers-rbd_disj"><span class="command">lemma</span></span> rbd_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbd_def fbd_Disj<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rbd_disj2"><span class="command">lemma</span></span> rbd_disj2<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_pres <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Image_Un rbd_Im<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rbd_bot_pres"><span class="command">lemma</span></span> rbd_bot_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"bot_pres <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbd_bot_pres r2f_bot_pres rbd_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rbd_zero_pres2"><span class="command">lemma</span></span> rbd_zero_pres2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbd_Im<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rbd_univ"><span class="command">lemma</span></span> rbd_univ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> UNIV <span class="main">=</span> Range <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rbd_def fun_eq_iff klift_def r2f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Kleisli_Transformers-rbd_iso"><span class="command">lemma</span></span> rbd_iso<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">X</span> <span class="main">⊆</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_iff_sup rbd_disj2<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irbd_comp_pres"><span class="command">lemma</span></span> irbd_comp_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="main">∘</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">ψ</span> <span class="main">;</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifbd_comp_pres f2r_kcomp_pres irbd_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irbd_id_pres"><span class="command">lemma</span></span> irbd_id_pres <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> id <span class="main">=</span> Id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> irbd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kleisli_Transformers-irbd_Sup_pres"><span class="command">lemma</span></span> irbd_Sup_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irbd_def Sup_pres_comp ifbd_Sup_pres f2r_Sup_pres<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irbd_sup_pres"><span class="command">lemma</span></span> irbd_sup_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_pres <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irbd_def ifbd_sup_pres f2r_sup_pres<span class="main">)</span>  

<span class="keyword1" id="Kleisli_Transformers-irbd_Inf_pres"><span class="command">lemma</span></span> irbd_Inf_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff irbd_def f2r_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irbd_inf_pres"><span class="command">lemma</span></span> irbd_inf_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_pres <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff irbd_def f2r_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irbd_bot_pres"><span class="command">lemma</span></span> irbd_bot_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"bot_pres <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_def ifbd_bot_pres f2r_bot_pres irbd_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This shows that relations are isomorphic to disjunctive forward predicate transformers. In many cases Isabelle picks up
the composition of morphisms in proofs.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Forward Boxes on Kleisli Arrows›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Forward box operators correspond to weakest liberal preconditions in program semantics. Here, 
Kleisli arrows are mapped to the opposite of the Eilenberg-Moore category, that is, Inf-lattices. 
It follows that the Inf-quantale structure is preserved. Modelling opposition is based on the fact 
that Kleisli arrows can be swapped by going through relations.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ffb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">fb<span class="hidden">⇩</span><sub>ℱ</sub></span></span> <span class="main">=</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here, $\partial_F$ is map-dual, which amounts to De Morgan duality. Hence the forward box operator is
obtained from the backward diamond by taking the opposite Kleisli arrow, applying the backward diamond, and then De Morgan
duality.›</span></span>

<span class="keyword1" id="Kleisli_Transformers-ffb_prop"><span class="command">lemma</span></span> ffb_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="main">∂</span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span><span class="main">)</span> <span class="main">∘</span> <span class="main">∂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffb_def map_dual_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-ffb_prop_var"><span class="command">lemma</span></span> ffb_prop_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">=</span> uminus <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span><span class="main">)</span> <span class="main">∘</span> uminus"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dual_set_def ffb_prop<span class="main">)</span>
 
<span class="keyword1" id="Kleisli_Transformers-ffb_fbd_dual"><span class="command">lemma</span></span> ffb_fbd_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∂</span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span><span class="main">)</span> <span class="main">∘</span> <span class="main">∂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffb_prop o_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹I give a set-theoretic definition of iffb, because the algebraic one below depends on Inf-preservation.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iffb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⋂</span><span class="main">{</span><span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Kleisli_Transformers-ffb_set"><span class="command">lemma</span></span> ffb_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">Y</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊆</span> <span class="bound">Y</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff ffb_prop_var kop_def klift_def f2r_def r2f_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Forward boxes and backward diamonds are adjoints.›</span></span>

<span class="keyword1" id="Kleisli_Transformers-ffb_fbd_galois"><span class="command">lemma</span></span> ffb_fbd_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span><span class="main">)</span> <span class="main">⊣</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> adj_def ffb_set klift_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Kleisli_Transformers-iffb_inv1"><span class="command">lemma</span></span> iffb_inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff ffb_set iffb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Kleisli_Transformers-iffb_inv2_aux"><span class="command">lemma</span></span> iffb_inv2_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="main">⨅</span><span class="main">{</span><span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">φ</span> <span class="bound">X</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">φ</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span><span class="main">{</span><span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">φ</span> <span class="bound">X</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋂</span><span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_eq_dest<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span><span class="main">⨅</span><span class="main">{</span><span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">φ</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">φ</span> <span class="free">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> h1 INF_lower2 cInf_eq_minimum mem_Collect_eq order_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨅</span><span class="main">{</span><span class="free">φ</span> <span class="bound">X</span> <span class="main">|</span><span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">φ</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">φ</span> <span class="free">Y</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> h2 setcompr_eq_image<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kleisli_Transformers-iffb_inv2"><span class="command">lemma</span></span> iffb_inv2<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="main">=</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="skolem">Y</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">⨅</span><span class="main">{</span><span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">φ</span> <span class="bound">X</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">Y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffb_set iffb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="skolem">Y</span> <span class="main">⟷</span> <span class="main">⨅</span><span class="main">{</span><span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">φ</span> <span class="bound">X</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="skolem">Y</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">φ</span> <span class="skolem">Y</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h iffb_inv2_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="skolem">Y</span> <span class="main">=</span> <span class="free">φ</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff set_eq_iff<span class="main">)</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kleisli_Transformers-iffb_inv2_inv"><span class="command">lemma</span></span> iffb_inv2_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="main">=</span> <span class="free">φ</span> <span class="main">⟹</span> Inf_pres <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff ffb_set iffb_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-iffb_inv2_iff"><span class="command">lemma</span></span> iffb_inv2_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="main">=</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Inf_pres <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> iffb_inv2 iffb_inv2_inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Kleisli_Transformers-ffb_inj"><span class="command">lemma</span></span> ffb_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inj_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iffb_inv1 pointfree_idE<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-ffb_inj_iff"><span class="command">lemma</span></span> ffb_inj_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffb_inj inj_eq<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-ffb_iffb_galois"><span class="command">lemma</span></span> ffb_iffb_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ffb_inj_iff iffb_inv2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Kleisli_Transformers-iffb_inj"><span class="command">lemma</span></span> iffb_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> Inf_pres <span class="free">ψ</span> <span class="main">⟹</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">ψ</span>  <span class="main">⟹</span> <span class="free">φ</span> <span class="main">=</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ffb_iffb_galois<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-iffb_inj_iff"><span class="command">lemma</span></span> iffb_inj_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> Inf_pres <span class="free">ψ</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">φ</span> <span class="main">=</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> iffb_inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Kleisli_Transformers-ffb_surj"><span class="command">lemma</span></span> ffb_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span>  <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="bound">f</span> <span class="main">=</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> iffb_inv2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Kleisli_Transformers-iffb_surj"><span class="command">lemma</span></span> iffb_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"surj <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> surj_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_apply iffb_inv1 surj_id<span class="main">)</span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is now the explicit "definition" of iffb, for Inf-preserving transformers.›</span></span>

<span class="keyword1" id="Kleisli_Transformers-iffb_ifbd_dual"><span class="command">lemma</span></span> iffb_ifbd_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span><span class="main">)</span> <span class="skolem">f</span> <span class="main">=</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffb_def ffb_iffb_galois h<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> comp_apply map_dual_dual ffb_def ffb_surj h klift_eta_inv1 map_dual_dual<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> kop_galois <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kleisli_Transformers-fbd_ffb_dual"><span class="command">lemma</span></span> fbd_ffb_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">=</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def ffb_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kleisli_Transformers-ffbd_ffb_dual_var"><span class="command">lemma</span></span> ffbd_ffb_dual_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∂</span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span><span class="main">)</span> <span class="main">∘</span> <span class="main">∂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ffb_prop fun_dual1 kop_galois<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-ifbd_iffb_dual"><span class="command">lemma</span></span> ifbd_iffb_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="main">(</span><span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Sup_pres_Inf_pres <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iffb_ifbd_dual<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_def kop_galois map_dual_dual<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kleisli_Transformers-ffb_kcomp_pres"><span class="command">lemma</span></span> ffb_kcomp_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kop_contrav<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbd_comp_pres<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_dual_func1<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffb_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kleisli_Transformers-ffb_eta_pres"><span class="command">lemma</span></span> ffb_eta_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="keyword1">η</span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kleisli_Transformers-ffb_Sup_dual"><span class="command">lemma</span></span> ffb_Sup_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_dual <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_prop_var comp_def fun_eq_iff klift_prop kop_def f2r_def r2f_def converse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Kleisli_Transformers-ffb_Sup_dual_var"><span class="command">lemma</span></span> ffb_Sup_dual_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="main">⨆</span><span class="free">F</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_prop_var comp_def fun_eq_iff klift_prop kop_def f2r_def r2f_def converse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Kleisli_Transformers-ffb_sup_dual"><span class="command">lemma</span></span> ffb_sup_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_dual <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ffb_Sup_dual Sup_sup_dual <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Kleisli_Transformers-ffb_zero_dual"><span class="command">lemma</span></span> ffb_zero_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="keyword1">ζ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> UNIV<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_prop_var kop_def klift_prop fun_eq_iff f2r_def r2f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"inf_dual ffb"</span></span> <span class="comment1">(*nitpick*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Once again, only the Sup-quantale structure is preserved.›</span></span>

<span class="keyword1" id="Kleisli_Transformers-iffb_comp_pres"><span class="command">lemma</span></span> iffb_comp_pres<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="main">∘</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms Inf_pres_comp ffb_iffb_galois ffb_kcomp_pres<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-iffb_id_pres"><span class="command">lemma</span></span> iffb_id_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> id <span class="main">=</span> <span class="keyword1">η</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> iffb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Kleisli_Transformers-iffb_Inf_dual"><span class="command">lemma</span></span> iffb_Inf_dual<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> <span class="free">Φ</span><span class="main">.</span> Inf_pres <span class="bound">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> Inf<span class="main">)</span> <span class="free">Φ</span> <span class="main">=</span> <span class="main">(</span>Sup <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="free">Φ</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="main">(</span><span class="main">⨅</span><span class="free">Φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Inf_pres_Inf assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⨅</span><span class="free">Φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">⨅</span><span class="main">(</span><span class="keyword1">𝒫</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="free">Φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> INF_cong INF_identity_eq assms iffb_inv2<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⨅</span><span class="free">Φ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="main">⨆</span><span class="main">(</span><span class="keyword1">𝒫</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">Φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Setcompr_eq_image ffb_Sup_dual_var image_comp<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffb_inj_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="Kleisli_Transformers-iffb_Sup_dual"><span class="command">lemma</span></span> iffb_Sup_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_dual <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> iffb_def fun_eq_iff<span class="main">)</span>
 
<span class="keyword1" id="Kleisli_Transformers-iffb_inf_dual"><span class="command">lemma</span></span> iffb_inf_dual<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">ψ</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="main">⊓</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">⊔</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">ψ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">⊓</span> <span class="free">ψ</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊓</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms iffb_inv2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">⊓</span> <span class="free">ψ</span> <span class="main">∘</span> Inter <span class="main">=</span> Inter <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="main">(</span><span class="free">φ</span> <span class="main">⊓</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Inf_pres_inf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f1 ffb_iffb_galois ffb_sup_dual<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="Kleisli_Transformers-iffb_sup_dual"><span class="command">lemma</span></span>  iffb_sup_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="main">⊔</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">⊓</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> iffb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Kleisli_Transformers-iffb_top_pres"><span class="command">lemma</span></span> iffb_top_pres <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">⊤</span> <span class="main">=</span> <span class="keyword1">ζ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> iffb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This establishes the duality between state transformers and weakest liberal preconditions.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Forward Box Operators from Relations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Once again one can compose isomorphisms, linking weakest liberal preconditions with relational semantics.
The isomorphism obtained should by now be obvious.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rfb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">fb<span class="hidden">⇩</span><sub>ℛ</sub></span></span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">ℱ</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">irfb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span></span> <span class="main">=</span> <span class="keyword1">ℛ</span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>

<span class="keyword1" id="Kleisli_Transformers-rfb_rbd_dual"><span class="command">lemma</span></span> rfb_rbd_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">=</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rfb_def rbd_def kop_def ffb_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> r2f_f2r_galois<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rbd_rfb_dual"><span class="command">lemma</span></span> rbd_rfb_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">=</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rfb_def rbd_def kop_def ffb_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> converse_converse map_dual_dual r2f_f2r_galois<span class="main">)</span>
  
<span class="keyword1" id="Kleisli_Transformers-irfb_irbd_dual"><span class="command">lemma</span></span> irfb_irbd_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>  <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irfb_def irbd_def iffb_ifbd_dual kop_def r2f_f2r_galois<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irbd_irfb_dual"><span class="command">lemma</span></span> irbd_irfb_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irfb_def irbd_def ifbd_iffb_dual kop_def r2f_f2r_galois<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_set"><span class="command">lemma</span></span> rfb_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rfb_def ffb_prop_var comp_def klift_def f2r_def r2f_def kop_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_rbd_galois"><span class="command">lemma</span></span> rfb_rbd_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span><span class="main">)</span> <span class="main">⊣</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffb_fbd_galois rbd_def rfb_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irfb_set"><span class="command">lemma</span></span> irfb_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">φ</span> <span class="bound">Y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">Y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irfb_def iffb_def f2r_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irfb_inv1"><span class="command">lemma</span></span> irfb_inv1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff rfb_def irfb_def iffb_inv1 pointfree_idE<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irfb_inv2"><span class="command">lemma</span></span> irfb_inv2<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span><span class="main">)</span> <span class="free">φ</span> <span class="main">=</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rfb_def irfb_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> ffb_iffb_galois r2f_f2r_galois<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_inj"><span class="command">lemma</span></span> rfb_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rfb_def ffb_inj inj_compose r2f_inj<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_inj_iff"><span class="command">lemma</span></span> rfb_inj_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="main">=</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rfb_inj inj_eq<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irfb_inj"><span class="command">lemma</span></span> irfb_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> Inf_pres <span class="free">ψ</span> <span class="main">⟹</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="main">=</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> irfb_def <span class="keyword1"><span class="command">using</span></span> iffb_inj r2f_inj_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Kleisli_Transformers-irfb_inf_iff"><span class="command">lemma</span></span> irfb_inf_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> Inf_pres <span class="free">ψ</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">φ</span> <span class="main">=</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> irfb_inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_surj"><span class="command">lemma</span></span> rfb_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">R</span><span class="main">.</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="bound">R</span> <span class="main">=</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> irfb_inv2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Kleisli_Transformers-irfb_surj"><span class="command">lemma</span></span> irfb_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"surj <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irfb_def comp_surj f2r_surj iffb_surj <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> image_cong_simp<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_irfb_galois"><span class="command">lemma</span></span> rfb_irfb_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">=</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irfb_def rfb_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> ffb_iffb_galois r2f_f2r_galois<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_comp_pres"><span class="command">lemma</span></span> rfb_comp_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">(</span><span class="free">R</span> <span class="main">;</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffb_kcomp_pres r2f_comp_pres rfb_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_Id_pres"><span class="command">lemma</span></span> rfb_Id_pres <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> Id <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rfb_def ffb_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_Sup_dual"><span class="command">lemma</span></span> rfb_Sup_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_dual <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">μ</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">ℱ</span> <span class="main">∘</span> Sup"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rfb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> Sup <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="keyword1">ℱ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun.map_comp r2f_Sup_pres<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Inf <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="keyword1">ℱ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffb_Sup_dual<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Inf <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">ℱ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_func1 comp_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rfb_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kleisli_Transformers-rfb_Sup_dual_var"><span class="command">lemma</span></span> rfb_Sup_dual_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">(</span><span class="main">⨆</span><span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">⨅</span><span class="main">(</span><span class="keyword1">𝒫</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> comp_eq_dest rfb_Sup_dual<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_sup_dual"><span class="command">lemma</span></span> rfb_sup_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_dual <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rfb_def ffb_sup_dual r2f_sup_pres<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"inf_dual <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span> <span class="comment1">(*nitpick*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1" id="Kleisli_Transformers-rfb_Inf_pres"><span class="command">lemma</span></span> rfb_Inf_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rfb_def ffb_prop_var comp_def fun_eq_iff klift_def kop_def f2r_def r2f_def converse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_inf_pres"><span class="command">lemma</span></span> rfb_inf_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_pres <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rfb_def ffb_prop_var comp_def fun_eq_iff klift_def kop_def f2r_def r2f_def converse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_zero_pres"><span class="command">lemma</span></span> rfb_zero_pres <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">{}</span> <span class="free">X</span> <span class="main">=</span> UNIV"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> rfb_def ffb_prop_var comp_def fun_eq_iff klift_def kop_def f2r_def r2f_def converse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_zero_pres2"><span class="command">lemma</span></span> rfb_zero_pres2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">-</span> Domain <span class="free">R</span>"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> rfb_def ffb_prop_var comp_def fun_eq_iff klift_def kop_def f2r_def r2f_def converse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_univ"><span class="command">lemma</span></span> rfb_univ <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> UNIV <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rfb_def ffb_prop_var comp_def fun_eq_iff klift_def kop_def f2r_def r2f_def converse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_iso"><span class="command">lemma</span></span> rfb_iso<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">X</span> <span class="main">⊆</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rfb_def ffb_prop_var comp_def fun_eq_iff klift_def kop_def f2r_def r2f_def converse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Kleisli_Transformers-irfb_comp_pres"><span class="command">lemma</span></span> irfb_comp_pres<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="main">∘</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">;</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms rfb_Inf_pres rfb_comp_pres rfb_irfb_galois<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irfb_id_pres"><span class="command">lemma</span></span> irfb_id_pres <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> id <span class="main">=</span> Id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rfb_irfb_galois<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irfb_Sup_dual"><span class="command">lemma</span></span> irfb_Sup_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_dual <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff irfb_def iffb_def f2r_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irfb_Inf_dual"><span class="command">lemma</span></span> irfb_Inf_dual<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> <span class="free">Φ</span><span class="main">.</span> Inf_pres <span class="bound">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> Inf<span class="main">)</span> <span class="free">Φ</span> <span class="main">=</span> <span class="main">(</span>Sup <span class="main">∘</span> <span class="keyword1">𝒫</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span><span class="main">)</span> <span class="free">Φ</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="main">(</span><span class="main">⨅</span><span class="free">Φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Inf_pres_Inf assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⨅</span><span class="free">Φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">⨅</span><span class="main">(</span><span class="keyword1">𝒫</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span><span class="main">)</span> <span class="free">Φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> INF_identity_eq Sup.SUP_cong assms irfb_inv2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨅</span><span class="main">(</span><span class="keyword1">𝒫</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">(</span><span class="keyword1">𝒫</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">Φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">(</span><span class="main">⨆</span><span class="main">(</span><span class="keyword1">𝒫</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">Φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rfb_Sup_dual_var<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⨅</span><span class="free">Φ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">(</span><span class="main">⨆</span><span class="main">(</span><span class="keyword1">𝒫</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">Φ</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rfb_inj_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="Kleisli_Transformers-irfb_sup_dual"><span class="command">lemma</span></span> irfb_sup_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_dual <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff irfb_def iffb_def f2r_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irfb_inf_dual"><span class="command">lemma</span></span> irfb_inf_dual<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">(</span><span class="free">φ</span> <span class="main">⊓</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">⊔</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms rfb_Inf_pres rfb_irfb_galois rfb_sup_dual<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irfb_top_pres"><span class="command">lemma</span></span> irfb_top_pres <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">⊤</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> irbd_def f2r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, the adjunctions between the predicate transformers considered so far are revisited.›</span></span>

<span class="keyword1" id="Kleisli_Transformers-ffb_fbd_galois_var"><span class="command">lemma</span></span> ffb_fbd_galois_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">⊆</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> adj_def ffb_fbd_galois<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_rbd_galois_var"><span class="command">lemma</span></span> rfb_rbd_galois_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">⊆</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> adj_def rfb_rbd_galois<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-ffb_fbd"><span class="command">lemma</span></span> ffb_fbd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span><span class="bound">X</span><span class="main">.</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ffb_fbd_galois_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_rbd"><span class="command">lemma</span></span> rfb_rbd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span><span class="bound">X</span><span class="main">.</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rfb_rbd_galois_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="Kleisli_Transformers-fbd_ffb"><span class="command">lemma</span></span> fbd_ffb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> <span class="main">⋂</span><span class="main">{</span><span class="bound">Y</span><span class="main">.</span> <span class="free">X</span> <span class="main">⊆</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="bound">Y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ffb_fbd_galois_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="Kleisli_Transformers-rbd_rfb"><span class="command">lemma</span></span> rbd_rfb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">X</span> <span class="main">=</span> <span class="main">⋂</span><span class="main">{</span><span class="bound">Y</span><span class="main">.</span> <span class="free">X</span> <span class="main">⊆</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="bound">Y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rfb_rbd_galois_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Remaining Modalities›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally I set up the remaining dual transformers: forward diamonds and backward boxes. 
Most properties are not repeated, only some symmetries and dualities are spelled out.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First, forward diamond operators are introduced, from state transformers and relations; together
with their inverses.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ffd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">fd<span class="hidden">⇩</span><sub>ℱ</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">fd<span class="hidden">⇩</span><sub>ℱ</sub></span></span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iffd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">fd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">fd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span></span> <span class="main">=</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rfd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">fd<span class="hidden">⇩</span><sub>ℛ</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">fd<span class="hidden">⇩</span><sub>ℛ</sub></span></span> <span class="main">=</span> <span class="keyword1">fd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">ℱ</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">irfd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">fd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">fd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span></span> <span class="main">=</span> <span class="keyword1">ℛ</span> <span class="main">∘</span> <span class="keyword1">fd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Second, I introduce forward boxes and their inverses.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fbb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">bb<span class="hidden">⇩</span><sub>ℱ</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bb<span class="hidden">⇩</span><sub>ℱ</sub></span></span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ifbb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span>  set <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
 <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span></span> <span class="main">=</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rbb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">bb<span class="hidden">⇩</span><sub>ℛ</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bb<span class="hidden">⇩</span><sub>ℛ</sub></span></span> <span class="main">=</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">ℱ</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">irbb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span>  set <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span></span> <span class="main">=</span> <span class="keyword1">ℛ</span> <span class="main">∘</span> <span class="keyword1">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Forward and backward operators of the same type (box or diamond) are related by opposition.›</span></span>

<span class="keyword1" id="Kleisli_Transformers-rfd_rbd"><span class="command">lemma</span></span> rfd_rbd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="main">(</span><span class="main">⌣</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rfd_def rbd_def ffd_def kop_def comp_assoc<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irfd_irbd"><span class="command">lemma</span></span> irfd_irbd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irfd_def iffd_def kop_def irbd_def comp_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-fbd_ffd"><span class="command">lemma</span></span> fbd_ffd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">=</span> <span class="keyword1">fd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffd_def kop_def converse_def f2r_def r2f_def klift_def fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rbb_rfb"><span class="command">lemma</span></span> rbb_rfb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="main">(</span><span class="main">⌣</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rfb_def rbb_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> fbb_def kop_def r2f_f2r_galois_var2 rewriteR_comp_comp2<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irbb_irfb"><span class="command">lemma</span></span> irbb_irfb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">=</span> <span class="keyword1">ℛ</span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irbb_def ifbb_def o_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">ℛ</span> <span class="main">∘</span> <span class="keyword1">ℱ</span> <span class="main">∘</span> <span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1">ℛ</span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kop_def o_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_assoc irfb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Complementation is a natural isomorphism between forwards and backward operators of different type.›</span></span>

<span class="keyword1" id="Kleisli_Transformers-ffd_ffb_demorgan"><span class="command">lemma</span></span> ffd_ffb_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∂</span> <span class="main">∘</span> <span class="keyword1">fd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">∘</span> <span class="main">∂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_assoc ffb_prop ffd_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-iffd_iffb_demorgan"><span class="command">lemma</span></span> iffd_iffb_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">fd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Sup_pres_Inf_pres comp_apply iffb_ifbd_dual iffd_def map_dual_dual<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-ffb_ffd_demorgan"><span class="command">lemma</span></span> ffb_ffd_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∂</span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">fd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">∘</span> <span class="main">∂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffb_prop ffd_def rewriteL_comp_comp<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-iffb_iffd_demorgan"><span class="command">lemma</span></span> iffb_iffd_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">fd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iffb_ifbd_dual iffd_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rfd_rfb_demorgan"><span class="command">lemma</span></span> rfd_rfb_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∂</span> <span class="main">∘</span> <span class="keyword1">fd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">=</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">∘</span> <span class="main">∂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rfb_def rfd_def ffd_ffb_demorgan<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irfd_irfb_demorgan"><span class="command">lemma</span></span> irfd_irfb_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">fd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irfb_def irfd_def iffd_iffb_demorgan<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rfb_rfd_demorgan"><span class="command">lemma</span></span> rfb_rfd_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∂</span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">=</span> <span class="keyword1">fd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">∘</span> <span class="main">∂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffb_ffd_demorgan rfb_def rfd_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irfb_irfd_demorgan"><span class="command">lemma</span></span> irfb_irfd_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">fd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irfb_irbd_dual irfd_irbd<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-fbd_fbb_demorgan"><span class="command">lemma</span></span> fbd_fbb_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∂</span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">∘</span> <span class="main">∂</span>"</span></span>   
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbb_def fbd_ffd ffd_ffb_demorgan<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-ifbd_ifbb_demorgan"><span class="command">lemma</span></span> ifbd_ifbb_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifbd_iffb_dual ifbb_def<span class="main">)</span>  

<span class="keyword1" id="Kleisli_Transformers-fbb_fbd_demorgan"><span class="command">lemma</span></span> fbb_fbd_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∂</span> <span class="main">∘</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">R</span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">R</span> <span class="main">∘</span> <span class="main">∂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbb_def fbd_ffd ffb_ffd_demorgan<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-ifbb_ifbd_demorgan"><span class="command">lemma</span></span> ifbb_ifbd_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="keyword1">fb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifbb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span><span class="main">)</span> <span class="main">(</span><span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_apply h iffb_ifbd_dual<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kleisli_Transformers-rbd_rbb_demorgan"><span class="command">lemma</span></span> rbd_rbb_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∂</span> <span class="main">∘</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">=</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">∘</span> <span class="main">∂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbb_def rbd_def fbd_fbb_demorgan<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irbd_irbb_demorgan"><span class="command">lemma</span></span> irbd_irbb_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irbb_irfb irbd_irfb_dual<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rbb_rbd_demorgan"><span class="command">lemma</span></span> rbb_rbd_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∂</span> <span class="main">∘</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">=</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">∘</span> <span class="main">∂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbb_def rbd_def fbb_fbd_demorgan<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irbb_irbd_demorgan"><span class="command">lemma</span></span> irbb_irbd_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irbb_def irbd_def ifbb_ifbd_demorgan<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Further symmetries arise by combination.›</span></span>

<span class="keyword1" id="Kleisli_Transformers-ffd_fbb_dual"><span class="command">lemma</span></span> ffd_fbb_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∂</span> <span class="main">∘</span> <span class="keyword1">fd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span><span class="main">)</span> <span class="main">∘</span> <span class="main">∂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbd_fbb_demorgan ffd_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-iffd_ifbb_dual"><span class="command">lemma</span></span> iffd_ifbb_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">fd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="keyword1">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifbd_ifbb_demorgan iffd_def<span class="main">)</span>  

<span class="keyword1" id="Kleisli_Transformers-fbb_ffd_dual"><span class="command">lemma</span></span> fbb_ffd_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∂</span> <span class="main">∘</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">fd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span><span class="main">)</span> <span class="main">∘</span> <span class="main">∂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbd_ffd fbb_fbd_demorgan<span class="main">)</span> 

<span class="keyword1" id="Kleisli_Transformers-ifbb_iffd_dual"><span class="command">lemma</span></span> ifbb_iffd_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">op<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">∘</span> <span class="keyword1">fd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifbb_def iffb_iffd_demorgan<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rfd_rbb_dual"><span class="command">lemma</span></span> rfd_rbb_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∂</span> <span class="main">∘</span> <span class="keyword1">fd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">=</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span> <span class="main">∘</span> <span class="main">∂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_dual1 map_dual_def rbd_rbb_demorgan rfb_rbd_dual rfd_rfb_demorgan<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-ifd_ibb_dual"><span class="command">lemma</span></span> ifd_ibb_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">fd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irbb_irfb irbd_irfb_dual irfd_irbd<span class="main">)</span>
 
<span class="keyword1" id="Kleisli_Transformers-rbb_rfd_dual"><span class="command">lemma</span></span> rbb_rfd_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∂</span> <span class="main">∘</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="main">=</span> <span class="keyword1">fd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span> <span class="main">∘</span> <span class="main">∂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbb_rfb rfb_rfd_demorgan<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-irbb_irfd_dual"><span class="command">lemma</span></span> irbb_irfd_dual<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">⌣</span><span class="main">)</span> <span class="main">∘</span> <span class="keyword1">fd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">∘</span> <span class="keyword1">∂<span class="hidden">⇩</span><sub>F</sub></span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irbb_irfb irfb_irbd_dual irfd_irbd<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-ffd_iffd_galois"><span class="command">lemma</span></span> ffd_iffd_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">φ</span> <span class="main">=</span> <span class="keyword1">fd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="keyword1">fd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ffd_def iffd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_apply fbd_surj klift_eta_inv1 kop_galois<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rfd_irfd_galois"><span class="command">lemma</span></span> rfd_irfd_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">φ</span> <span class="main">=</span> <span class="keyword1">fd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="main">=</span> <span class="keyword1">fd<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> irfd_def rfd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_apply ffd_iffd_galois r2f_f2r_galois<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-fbb_ifbb_galois"><span class="command">lemma</span></span> fbb_ifbb_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">φ</span> <span class="main">=</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="keyword1">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fbb_def iffb_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> comp_apply ffb_iffb_galois ifbb_ifbd_demorgan iffb_ifbd_dual kop_galois<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rbb_irbb_galois"><span class="command">lemma</span></span> rbb_irbb_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"Inf_pres <span class="free">φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">φ</span> <span class="main">=</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="main">=</span> <span class="keyword1">bb<span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbb_def irbb_def<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> fbb_ifbb_galois r2f_f2r_galois <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next I spell out the missing adjunctions.›</span></span>

<span class="keyword1" id="Kleisli_Transformers-ffd_ffb_adj"><span class="command">lemma</span></span> ffd_ffb_adj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">⊣</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbb_def ffb_fbd_galois ffd_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-ffd_fbb_galois"><span class="command">lemma</span></span> ffd_fbb_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">⊆</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbb_def ffb_fbd_galois_var ffd_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rfd_rfb_adj"><span class="command">lemma</span></span> rfd_rfb_adj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">f</span> <span class="main">⊣</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffd_ffb_adj rbb_def rfd_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Transformers-rfd_rbb_galois"><span class="command">lemma</span></span> rfd_rbb_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">⊆</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffd_fbb_galois rbb_def rfd_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, forward and backward operators of the same type are linked by conjugation.›</span></span>

<span class="keyword1" id="Kleisli_Transformers-ffd_fbd_conjugation"><span class="command">lemma</span></span> ffd_fbd_conjugation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">fd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">fd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">X</span> <span class="main">⊆</span> <span class="main">-</span><span class="free">Y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_eq_subset_Compl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">⊆</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">(</span><span class="main">-</span><span class="free">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffd_fbb_galois<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="main">-</span> <span class="keyword1">bb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">(</span><span class="main">-</span><span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_eq_subset_Compl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="main">∂</span> <span class="main">(</span><span class="keyword1">bb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">(</span><span class="main">∂</span> <span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dual_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> comp_apply fbb_fbd_demorgan invol_dual_var<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kleisli_Transformers-rfd_rbd_conjugation"><span class="command">lemma</span></span> rfd_rbd_conjugation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">fd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">X</span><span class="main">)</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbd_def rfd_def ffd_fbd_conjugation<span class="main">)</span> 

<span class="keyword1" id="Kleisli_Transformers-ffb_fbb_conjugation"><span class="command">lemma</span></span> ffb_fbb_conjugation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="main">∪</span> <span class="free">Y</span> <span class="main">=</span> UNIV<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">bb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> UNIV<span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="main">∪</span> <span class="free">Y</span> <span class="main">=</span> UNIV<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="free">Y</span> <span class="main">⊆</span> <span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">bd<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="main">(</span><span class="main">∂</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffb_fbd_galois_var dual_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∂</span> <span class="main">(</span><span class="keyword1">bb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_def fbb_fbd_demorgan<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">bb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compl_le_swap2 dual_set_def join_shunt<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kleisli_Transformers-rfb_rbb_conjugation"><span class="command">lemma</span></span> rfb_rbb_conjugation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">X</span><span class="main">)</span> <span class="main">∪</span> <span class="free">Y</span> <span class="main">=</span> UNIV<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">bb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> UNIV<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rfb_def rbb_def ffb_fbb_conjugation<span class="main">)</span> 

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Kleisli_Quantaloid">
<div class="head">
<h1>Theory Kleisli_Quantaloid</h1>
</div>
<pre class="source"><span class="comment1">(* 
  Title: The Quantaloid of Kleisli Arrows
  Author: Georg Struth 
  Maintainer: Georg Struth &lt;g.struth@sheffield.ac.uk&gt; 
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Quantaloid of Kleisli Arrows›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Kleisli_Quantaloid

<span class="keyword2"><span class="keyword">imports</span></span> <a href="Kleisli_Transformers.html">Kleisli_Transformers</a> 
<span class="keyword2"><span class="keyword">begin</span></span>          

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This component formalises the quantalic structure of Kleisli arrows or state transformers, that is, 
the homset of the Kleisli category. Of course, by the previous isomorphisms, this is reflected at least 
partially in the Eilenberg-Moore algebras, via the comparison functor. The main result is that Kleisli arrows 
form a quantaloid, hence essentially a typed quantale. Some emphasis is on the star. This component thus complements 
that in which the quantaloid structure of Sup- and Inf-preserving transformers has been formalised.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The first set of lemmas shows that Kleisli arrows form a typed dioid, that is, a typed idempotent semiring.›</span></span>

<span class="keyword1" id="Kleisli_Quantaloid-ksup_assoc"><span class="command">lemma</span></span> ksup_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⊔</span> <span class="free">g</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">h</span> <span class="main">=</span> <span class="free">f</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">g</span> <span class="main">⊔</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sup.assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kleisli_Quantaloid-ksup_comm"><span class="command">lemma</span></span> ksup_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⊔</span> <span class="free">g</span> <span class="main">=</span> <span class="free">g</span> <span class="main">⊔</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup.commute<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-ksup_idem"><span class="command">lemma</span></span> ksup_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⊔</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kleisli_Quantaloid-kcomp_distl"><span class="command">lemma</span></span> kcomp_distl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">(</span><span class="free">g</span> <span class="main">⊔</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kcomp_klift fun_eq_iff comp_def sup_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UN_Un_distrib klift_prop<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-kcomp_distr"><span class="command">lemma</span></span> kcomp_distr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⊔</span> <span class="free">g</span><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">h</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kcomp_klift fun_eq_iff klift_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-ksup_zerol"><span class="command">lemma</span></span> ksup_zerol <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ζ</span> <span class="main">⊔</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Kleisli_Quantaloid-ksup_annil"><span class="command">lemma</span></span> ksup_annil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ζ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">ζ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> kcomp_klift klift_def<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-ksup_annir"><span class="command">lemma</span></span> ksup_annir <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="keyword1">ζ</span> <span class="main">=</span> <span class="keyword1">ζ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> kcomp_klift klift_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Associativity of Kleisli composition has already been proved.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next laws establish typed quantales --- or quantaloids.›</span></span>

<span class="keyword1" id="Kleisli_Quantaloid-kSup_distl"><span class="command">lemma</span></span> kSup_distl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">(</span><span class="main">⨆</span><span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span><span class="main">.</span> <span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="bound">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="main">(</span><span class="main">⨆</span><span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>klift <span class="main">∘</span> Sup<span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">∘</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kcomp_klift<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span><span class="main">.</span> <span class="main">(</span>klift <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbd_Sup_pres fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span><span class="main">.</span> <span class="main">(</span>klift <span class="bound">g</span><span class="main">)</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kcomp_klift<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kleisli_Quantaloid-kSup_distr"><span class="command">lemma</span></span> kSup_distr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span><span class="free">F</span><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kcomp_klift fun_eq_iff comp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> klift_prop<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-kcomp_isol"><span class="command">lemma</span></span> kcomp_isol<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">h</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span> <span class="main">≤</span> <span class="free">h</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> kcomp_klift le_fun_def klift_def<span class="main">)</span>
  
<span class="keyword1" id="Kleisli_Quantaloid-kcomp_isor"><span class="command">lemma</span></span> kcomp_isor<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">h</span> <span class="main">≤</span> <span class="free">g</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> kcomp_klift le_fun_def klift_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Kleene Star›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The Kleene star can be defined in any quantale or quantaloid by iteration. For Kleisli arrows,
laws for the star can be obtained via the isomorphism to binary relations, where the star is the reflexive-transitive
closure operation.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">kpower</span> <span class="main">≡</span> kmon.power"</span></span>

<span class="keyword1" id="Kleisli_Quantaloid-r2f_pow"><span class="command">lemma</span></span> r2f_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span> <span class="main">(</span><span class="free">R</span> <span class="main">^^</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> kpower <span class="main">(</span><span class="keyword1">ℱ</span> <span class="free">R</span><span class="main">)</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> power.power.power_Suc r2f_comp_pres relpow.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> relpow_commute<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-f2r_kpower"><span class="command">lemma</span></span> f2r_kpower<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ</span> <span class="main">(</span>kpower <span class="free">f</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ℛ</span> <span class="free">f</span><span class="main">)</span> <span class="main">^^</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> f2r2f_inv2 pointfree_idE r2f2r_inv1 r2f_pow<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">kstar</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> kpower <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span><span class="main">)</span>"</span></span>
                                              
<span class="keyword1" id="Kleisli_Quantaloid-r2f_rtrancl_hom"><span class="command">lemma</span></span> r2f_rtrancl_hom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span> <span class="main">(</span>rtrancl <span class="free">R</span><span class="main">)</span> <span class="main">=</span> kstar <span class="main">(</span><span class="keyword1">ℱ</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span> <span class="main">(</span>rtrancl <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℱ</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> full_SetCompr_eq rtrancl_is_UN_relpow<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> kpower <span class="main">(</span><span class="keyword1">ℱ</span> <span class="free">R</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r2f_Sup_pres_var r2f_pow<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kstar_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kleisli_Quantaloid-r2f_rtrancl_hom_var"><span class="command">lemma</span></span> r2f_rtrancl_hom_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span> <span class="main">∘</span> rtrancl <span class="main">=</span> kstar <span class="main">∘</span> <span class="keyword1">ℱ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r2f_rtrancl_hom<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-f2r_kstar_hom"><span class="command">lemma</span></span> f2r_kstar_hom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ</span> <span class="main">(</span>kstar <span class="free">f</span><span class="main">)</span> <span class="main">=</span> rtrancl <span class="main">(</span><span class="keyword1">ℛ</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> r2f_f2r_galois r2f_rtrancl_hom<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-f2r_kstar_hom_var"><span class="command">lemma</span></span> f2r_kstar_hom_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ</span> <span class="main">∘</span> kstar <span class="main">=</span> rtrancl <span class="main">∘</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f2r_kstar_hom<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-kstar_unfoldl_eq"><span class="command">lemma</span></span> kstar_unfoldl_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">η</span> <span class="main">⊔</span> <span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> kstar <span class="free">f</span> <span class="main">=</span> kstar <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ</span> <span class="main">(</span>kstar <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ℛ</span> <span class="keyword1">η</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">ℛ</span> <span class="free">f</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">;</span> <span class="keyword1">ℛ</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f2r_kstar_hom rtrancl_unfold
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f2r_eta_pres<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f2r_kcomp_pres f2r_kstar_hom f2r_sup_pres r2f_inj_iff r_comp_rtrancl_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kleisli_Quantaloid-kstar_unfoldl"><span class="command">lemma</span></span> kstar_unfoldl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">η</span> <span class="main">⊔</span> <span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span>  kstar <span class="free">f</span> <span class="main">≤</span> kstar <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kstar_unfoldl_eq<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-kstar_unfoldr_eq"><span class="command">lemma</span></span> kstar_unfoldr_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">η</span> <span class="main">⊔</span> <span class="main">(</span>kstar <span class="free">f</span><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span> <span class="main">=</span> kstar <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> f2r2f_inv2 f2r_kcomp_pres f2r_kstar_hom kstar_unfoldl_eq pointfree_idE r_comp_rtrancl_eq<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-kstar_unfoldr"><span class="command">lemma</span></span> kstar_unfoldr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">η</span> <span class="main">⊔</span> <span class="main">(</span>kstar <span class="free">f</span><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span> <span class="main">≤</span> kstar <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kstar_unfoldr_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relational induction laws seem to be missing in Isabelle Main. So I derive functional laws directly.›</span></span>

<span class="keyword1" id="Kleisli_Quantaloid-kpower_inductl"><span class="command">lemma</span></span> kpower_inductl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">⟹</span> kpower <span class="free">f</span> <span class="free">i</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span> <span class="main">≤</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kcomp_assoc kcomp_isol order_subst2<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-kpower_inductl_var"><span class="command">lemma</span></span> kpower_inductl_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊔</span> <span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">⟹</span> kpower <span class="free">f</span> <span class="free">i</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">h</span> <span class="main">≤</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊔</span> <span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span> <span class="main">≤</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span> <span class="main">≤</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> le_sup_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≤</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> h2 kcomp_isol kpower_inductl order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kleisli_Quantaloid-kstar_inductl"><span class="command">lemma</span></span> kstar_inductl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊔</span> <span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">⟹</span> kstar <span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">h</span> <span class="main">≤</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kstar_def kSup_distr<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> kpower_inductl_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>   

<span class="keyword1" id="Kleisli_Quantaloid-kpower_inductr"><span class="command">lemma</span></span> kpower_inductr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">g</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> kpower <span class="free">f</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> dual_order.trans kcomp_assoc kcomp_isor<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-kpower_inductr_var"><span class="command">lemma</span></span> kpower_inductr_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊔</span> <span class="free">g</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">h</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> kpower <span class="free">f</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> dual_order.trans kcomp_isor kpower_inductr le_sup_iff<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-kstar_inductr"><span class="command">lemma</span></span> kstar_inductr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊔</span> <span class="free">g</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">h</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> kstar <span class="free">f</span> <span class="main">≤</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kstar_def kSup_distl<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> kpower_inductr_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Kleisli_Quantaloid-kpower_prop"><span class="command">lemma</span></span> kpower_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≤</span> <span class="keyword1">η</span> <span class="main">⟹</span> kpower <span class="free">f</span> <span class="free">i</span> <span class="main">≤</span> <span class="keyword1">η</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> kcomp_idl kpower_inductr<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-kstar_prop"><span class="command">lemma</span></span> kstar_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≤</span> <span class="keyword1">η</span> <span class="main">⟹</span> kstar <span class="free">f</span> <span class="main">≤</span> <span class="keyword1">η</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SUP_le_iff kpower_prop kstar_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Antidomain›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next I define an antidomain operation and prove the axioms of antidomain semirings~\cite{GomesGHSW16,DesharnaisS11}.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">kad</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ad_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Kleisli_Quantaloid-f2r_ad_fun_hom"><span class="command">lemma</span></span> f2r_ad_fun_hom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ</span> <span class="main">(</span>kad <span class="free">f</span><span class="main">)</span> <span class="main">=</span> ad_rel <span class="main">(</span><span class="keyword1">ℛ</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kad_def ad_rel_def f2r_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span> <span class="main">(</span><span class="operator">meson</span> empty_iff singletonD<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-f2r_ad_fun_hom_var"><span class="command">lemma</span></span> f2r_ad_fun_hom_var<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">ℛ</span> <span class="main">∘</span> kad <span class="main">=</span> ad_rel <span class="main">∘</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f2r_ad_fun_hom<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-r2f_ad_rel_hom"><span class="command">lemma</span></span> r2f_ad_rel_hom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span> <span class="main">(</span>ad_rel <span class="free">R</span><span class="main">)</span> <span class="main">=</span> kad <span class="main">(</span><span class="keyword1">ℱ</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kad_def ad_rel_def r2f_def fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-r2f_ad_rel_hom_var"><span class="command">lemma</span></span> r2f_ad_rel_hom_var<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">ℱ</span> <span class="main">∘</span> ad_rel <span class="main">=</span> kad <span class="main">∘</span> <span class="keyword1">ℱ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r2f_ad_rel_hom<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-ad_fun_as1"><span class="command">lemma</span></span> ad_fun_as1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>kad <span class="free">f</span><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">ζ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kad_def kcomp_def fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-ad_fun_as2"><span class="command">lemma</span></span> ad_fun_as2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"kad <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span><span class="main">)</span> <span class="main">⊔</span> kad <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> kad <span class="main">(</span>kad <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> kad <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> kad <span class="main">(</span>kad <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> kad_def kcomp_def fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantaloid-ad_fun_as3"><span class="command">lemma</span></span> ad_fun_as3 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"kad <span class="main">(</span>kad <span class="free">f</span><span class="main">)</span> <span class="main">⊔</span> kad <span class="free">f</span> <span class="main">=</span> <span class="keyword1">η</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kad_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">set2fun</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">p2fun</span> <span class="main">=</span> set2fun <span class="main">∘</span> Collect"</span></span>

<span class="keyword1" id="Kleisli_Quantaloid-ffb_ad_fun"><span class="command">lemma</span></span> ffb_ad_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>kad <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> kad <span class="main">(</span>set2fun <span class="free">X</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> ffb_prop_var klift_def kop_def fun_eq_iff comp_def f2r_def r2f_def converse_def kad_def kcomp_def set2fun_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Kleisli_Quantaloid-ffb_ad_fun2"><span class="command">lemma</span></span> ffb_ad_fun2<span class="main">:</span> <span class="quoted"><span class="quoted">"set2fun <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℱ</sub></span> <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> kad <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> kad <span class="main">(</span>set2fun <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">subst</span> ffb_ad_fun<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> set2fun_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kad_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The final statements check that the relational forward diamond is consistent with the Kleene-algebraic definition.›</span></span>

<span class="keyword1" id="Kleisli_Quantaloid-fb_ad_rel"><span class="command">lemma</span></span> fb_ad_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">X</span> <span class="main">=</span> Domain <span class="main">(</span>ad_rel <span class="main">(</span><span class="free">R</span> <span class="main">;</span> ad_rel <span class="main">(</span>Id_on <span class="free">X</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rfb_def ffb_prop_var klift_def comp_def r2f_def kop_def f2r_def converse_def Domain_def Id_on_def ad_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Kleisli_Quantaloid-fb_ad_rel2"><span class="command">lemma</span></span> fb_ad_rel2<span class="main">:</span> <span class="quoted"><span class="quoted">"Id_on <span class="main">(</span><span class="keyword1">fb<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free">R</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> ad_rel <span class="main">(</span><span class="free">R</span> <span class="main">;</span> ad_rel <span class="main">(</span>Id_on <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rfb_def ffb_prop_var klift_def comp_def r2f_def kop_def f2r_def converse_def Domain_def Id_on_def ad_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Kleisli_Quantale">
<div class="head">
<h1>Theory Kleisli_Quantale</h1>
</div>
<pre class="source"><span class="comment1">(* 
  Title: The Quantale of Kleisli Arrows
  Author: Georg Struth 
  Maintainer: Georg Struth &lt;g.struth@sheffield.ac.uk&gt; 
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Quantale of Kleisli Arrows›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Kleisli_Quantale
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Kleisli_Quantaloid.html">Kleisli_Quantaloid</a> 
          <span class="quoted">"<a href="../Quantales/Quantale_Star.html">Quantales.Quantale_Star</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This component revisits the results of the quantaloid one in the single-typed setting, that is, in 
the context of quantales. An instance proof, showing that Kleisli arrows (or state transformers) form quantales, is
its main result. Facts proved for quantales are thus made available for state transformers.›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> nd_fun <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_nd_fun

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definitions are lifted to gain access to the Kleisli categories.›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> r2fnd <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Abs_nd_fun <span class="main">∘</span> <span class="keyword1">ℱ</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> f2rnd <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ</span> <span class="main">∘</span> Rep_nd_fun"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">declare</span></span> Rep_nd_fun_inverse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="Kleisli_Quantale-r2f2r_inv"><span class="command">lemma</span></span> r2f2r_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"r2fnd <span class="main">∘</span> f2rnd <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff pointfree_idE<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantale-f2r2f_inv"><span class="command">lemma</span></span> f2r2f_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"f2rnd <span class="main">∘</span> r2fnd <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff r2f_def f2r_def Abs_nd_fun_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> nd_fun <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">monoid_mult</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">one_nd_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Abs_nd_fun <span class="keyword1">η</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">times_nd_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>type nd_fun <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>type nd_fun <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>type nd_fun"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> Abs_nd_fun <span class="main">(</span>Rep_nd_fun <span class="bound">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> Rep_nd_fun <span class="bound">g</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span> 

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_nd_fun_inverse kcomp_assoc<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nd_fun <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">order_lean</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_eq_nd_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> Rep_nd_fun <span class="bound">f</span> <span class="main">≤</span> Rep_nd_fun <span class="bound">g</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_nd_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> Rep_nd_fun <span class="bound">f</span> <span class="main">≤</span> Rep_nd_fun <span class="bound">g</span> <span class="main">∧</span> <span class="bound">f</span> <span class="main">≠</span> <span class="bound">g</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command">using</span></span> order.trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rep_nd_fun_inject less_eq_nd_fun.abs_eq<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nd_fun <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">Sup_lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">Sup_nd_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun set <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Abs_nd_fun <span class="main">∘</span> Sup <span class="main">∘</span> <span class="keyword1">𝒫</span> Rep_nd_fun"</span></span><span class="keyword1"><span class="command">.</span></span> 

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_nd_fun_inverse Sup_upper sup_absorb2 Sup_le_iff<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Kleisli_Quantale-Abs_comp_hom"><span class="command">lemma</span></span> Abs_comp_hom<span class="main">:</span> <span class="quoted"><span class="quoted">"Abs_nd_fun <span class="main">(</span><span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> Abs_nd_fun <span class="free">f</span> <span class="main">⋅</span> Abs_nd_fun <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_nd_fun_inverse<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantale-Rep_comp_hom"><span class="command">lemma</span></span> Rep_comp_hom<span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_nd_fun <span class="main">(</span><span class="free">f</span> <span class="main">⋅</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> Rep_nd_fun <span class="free">f</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>K</sub></span> Rep_nd_fun <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_nd_fun_inverse times_nd_fun.abs_eq<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> nd_fun <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">unital_Sup_quantale</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main">(</span><span class="operator">smt</span> Abs_comp_hom Rep_comp_hom Rep_nd_fun_inverse SUP_cong image_image kSup_distr kSup_distl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Unfortunately, this is not it yet. To benefit from Isabelle's theorems for orderings, lattices, 
Kleene algebras and quantales, Isabelle's complete lattices need to be in scope. Somewhat annoyingly, this
requires more work...›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nd_fun <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">complete_lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">Inf_nd_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nd_fun set <span class="main">⇒</span> <span class="tfree">'a</span> nd_fun"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Abs_nd_fun <span class="main">∘</span> Inf <span class="main">∘</span> <span class="keyword1">𝒫</span> Rep_nd_fun"</span></span><span class="keyword1"><span class="command">.</span></span> 

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">bot_nd_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>type nd_fun"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Abs_nd_fun <span class="main">(</span>Sup <span class="main">{}</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">sup_nd_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>type nd_fun <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>type nd_fun <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>type nd_fun"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> Abs_nd_fun <span class="main">(</span>Rep_nd_fun <span class="bound">f</span> <span class="main">⊔</span> Rep_nd_fun <span class="bound">g</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">top_nd_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>type nd_fun"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Abs_nd_fun <span class="main">(</span>Inf <span class="main">{}</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">inf_nd_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>type nd_fun <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>type nd_fun <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>type nd_fun"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> Abs_nd_fun <span class="main">(</span>Rep_nd_fun <span class="bound">f</span> <span class="main">⊓</span> Rep_nd_fun <span class="bound">g</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command">using</span></span> Rep_nd_fun_inject dual_order.antisym <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_nd_fun_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_nd_fun_inverse Sup_le_iff SUP_upper2 le_INF_iff Inf_lower<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> nd_fun <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">unital_quantale</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
  <span class="keyword1"><span class="command">using</span></span> supq.Sup_distr <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supq.Sup_distl<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now, theorems for the Kleene star, which come from quantales, are finally in scope.›</span></span>

<span class="keyword1" id="Kleisli_Quantale-fun_star_unfoldl_eq"><span class="command">lemma</span></span> fun_star_unfoldl_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span> nd_fun<span class="main">)</span> <span class="main">⊔</span> <span class="free">f</span> <span class="main">⋅</span> qstar <span class="free">f</span> <span class="main">=</span> qstar <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qstar_comm<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantale-fun_star_unfoldl"><span class="command">lemma</span></span> fun_star_unfoldl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span> nd_fun<span class="main">)</span> <span class="main">⊔</span> <span class="free">f</span> <span class="main">⋅</span> qstar <span class="free">f</span> <span class="main">≤</span> qstar <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> qstar_unfoldl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 
<span class="keyword1" id="Kleisli_Quantale-fun_star_unfoldr_eq"><span class="command">lemma</span></span> fun_star_unfoldr_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span> nd_fun<span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span>qstar <span class="free">f</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">f</span> <span class="main">=</span> qstar <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Kleisli_Quantale-fun_star_unfoldr"><span class="command">lemma</span></span> fun_star_unfoldr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span> nd_fun<span class="main">)</span> <span class="main">⊔</span> qstar <span class="free">f</span> <span class="main">⋅</span> <span class="free">f</span> <span class="main">≤</span> qstar <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_star_unfoldr_eq<span class="main">)</span>

<span class="keyword1" id="Kleisli_Quantale-fun_star_inductl"><span class="command">lemma</span></span> fun_star_inductl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">h</span><span class="main">::</span><span class="tfree">'a</span> nd_fun<span class="main">)</span> <span class="main">⊔</span> <span class="free">f</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">⟹</span> qstar <span class="free">f</span> <span class="main">⋅</span>  <span class="free">h</span> <span class="main">≤</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> qstar_inductl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Kleisli_Quantale-fun_star_inductr"><span class="command">lemma</span></span> fun_star_inductr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">h</span><span class="main">::</span><span class="tfree">'a</span> nd_fun<span class="main">)</span> <span class="main">⊔</span> <span class="free">g</span> <span class="main">⋅</span> <span class="free">f</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">⋅</span> qstar <span class="free">f</span> <span class="main">≤</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qstar_inductr<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div>